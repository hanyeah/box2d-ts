var b2,__extends=this&&this.__extends||function(){var s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){t.assert=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(!t)throw new Error(e.join("\n"))},t.maybe=function(t,e){return void 0!==t?t:e},t.maxFloat=1e37,t.epsilon=1e-5,t.epsilonSq=t.epsilon*t.epsilon,t.pi=Math.PI,t.lengthUnitsPerMeter=1,t.maxPolygonVertices=8,t.maxManifoldPoints=2,t.aabbExtension=.1*t.lengthUnitsPerMeter,t.aabbMultiplier=4,t.linearSlop=.005*t.lengthUnitsPerMeter,t.angularSlop=2/180*t.pi,t.polygonRadius=2*t.linearSlop,t.maxSubSteps=8,t.maxTOIContacts=32,t.maxLinearCorrection=.2*t.lengthUnitsPerMeter,t.maxAngularCorrection=8/180*t.pi,t.maxTranslation=2*t.lengthUnitsPerMeter,t.maxTranslationSquared=t.maxTranslation*t.maxTranslation,t.maxRotation=.5*t.pi,t.maxRotationSquared=t.maxRotation*t.maxRotation,t.baumgarte=.2,t.toiBaumgarte=.75,t.invalidParticleIndex=-1,t.maxParticleIndex=2147483647,t.particleStride=.75,t.minParticleWeight=1,t.maxParticlePressure=.25,t.maxParticleForce=.5,t.maxTriadDistance=2*t.lengthUnitsPerMeter,t.maxTriadDistanceSquared=t.maxTriadDistance*t.maxTriadDistance,t.minParticleSystemBufferCapacity=256,t.barrierCollisionTime=2.5,t.timeToSleep=.5,t.linearSleepTolerance=.01*t.lengthUnitsPerMeter,t.angularSleepTolerance=2/180*t.pi;var e=(i.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},i);function i(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}t.Version=e,t.version=new e(2,4,1),t.branch="master",t.commit="9ebbbcd960ad424e03e5de6e66a40764c16f51bc",t.ParseInt=function(t){return parseInt(t,10)},t.ParseUInt=function(t){return Math.abs(parseInt(t,10))},t.MakeArray=function(t,e){for(var i=new Array(t),s=0;s<t;++s)i[s]=e(s);return i},t.MakeNullArray=function(t){for(var e=new Array(t),i=0;i<t;++i)e[i]=null;return e},t.MakeNumberArray=function(t,e){void 0===e&&(e=0);for(var i=new Array(t),s=0;s<t;++s)i[s]=e;return i}}(b2=b2||{}),function(o){function n(t,e,i){return t<e?e:i<t?i:t}o.pi_over_180=o.pi/180,o._180_over_pi=180/o.pi,o.two_pi=2*o.pi,o.clamp=n,o.swap=function(t,e){var i=t[0];t[0]=e[0],e[0]=i},o.isValid=isFinite,o.sqrt=function(t){return t*t},o.invSqrt=function(t){return 1/Math.sqrt(t)},o.degToRad=function(t){return t*o.pi_over_180},o.radToDeg=function(t){return t*o._180_over_pi},o.Pow=Math.pow,o.Sqrt=Math.sqrt,o.Abs=Math.abs,o.Cos=Math.cos,o.Sin=Math.sin,o.Acos=Math.acos,o.Asin=Math.asin,o.Atan2=Math.atan2,o.Random=Math.random,o.Min=Math.min,o.Max=Math.max,o.nextPowerOfTwo=function(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,(t|=t>>16&65535)+1},o.isPowerOfTwo=function(t){return 0<t&&0==(t&t-1)},o.randomRange=function(t,e){return(e-t)*Math.random()+t};var s=(e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.setZero=function(){return this.x=0,this.y=0,this},e.prototype.set=function(t,e){return this.x=t,this.y=e,this},e.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},e.prototype.selfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},e.prototype.selfAddXY=function(t,e){return this.x+=t,this.y+=e,this},e.prototype.selfSub=function(t){return this.x-=t.x,this.y-=t.y,this},e.prototype.selfSubXY=function(t,e){return this.x-=t,this.y-=e,this},e.prototype.selfMul=function(t){return this.x*=t,this.y*=t,this},e.prototype.selfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},e.prototype.selfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},e.prototype.dot=function(t){return this.x*t.x+this.y*t.y},e.prototype.cross=function(t){return this.x*t.y-this.y*t.x},e.prototype.length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},e.prototype.lengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},e.prototype.normalize=function(){var t,e=this.length();return e>=o.epsilon&&(t=1/e,this.x*=t,this.y*=t),e},e.prototype.selfNormalize=function(){return this.normalize(),this},e.prototype.selfRotate=function(t){var e=Math.cos(t),i=Math.sin(t),s=this.x;return this.x=e*s-i*this.y,this.y=i*s+e*this.y,this},e.prototype.selfRotateCosSin=function(t,e){var i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this},e.prototype.isValid=function(){return isFinite(this.x)&&isFinite(this.y)},e.prototype.selfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},e.prototype.selfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},e.prototype.selfMinV=function(t){return this.x=o.Min(this.x,t.x),this.y=o.Min(this.y,t.y),this},e.prototype.selfMaxV=function(t){return this.x=o.Max(this.x,t.x),this.y=o.Max(this.y,t.y),this},e.prototype.selfAbs=function(){return this.x=o.Abs(this.x),this.y=o.Abs(this.y),this},e.prototype.selfNeg=function(){return this.x=-this.x,this.y=-this.y,this},e.prototype.selfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},e.MakeArray=function(t){return o.MakeArray(t,function(t){return new e})},e.AbsV=function(t,e){return e.x=o.Abs(t.x),e.y=o.Abs(t.y),e},e.MinV=function(t,e,i){return i.x=o.Min(t.x,e.x),i.y=o.Min(t.y,e.y),i},e.MaxV=function(t,e,i){return i.x=o.Max(t.x,e.x),i.y=o.Max(t.y,e.y),i},e.ClampV=function(t,e,i,s){return s.x=n(t.x,e.x,i.x),s.y=n(t.y,e.y,i.y),s},e.RotateV=function(t,e,i){var s=t.x,o=t.y,n=Math.cos(e),r=Math.sin(e);return i.x=n*s-r*o,i.y=r*s+n*o,i},e.DotVV=function(t,e){return t.x*e.x+t.y*e.y},e.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},e.CrossVS=function(t,e,i){var s=t.x;return i.x=e*t.y,i.y=-e*s,i},e.CrossVOne=function(t,e){var i=t.x;return e.x=t.y,e.y=-i,e},e.CrossSV=function(t,e,i){var s=e.x;return i.x=-t*e.y,i.y=t*s,i},e.CrossOneV=function(t,e){var i=t.x;return e.x=-t.y,e.y=i,e},e.AddVV=function(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i},e.SubVV=function(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i},e.MulSV=function(t,e,i){return i.x=e.x*t,i.y=e.y*t,i},e.MulVS=function(t,e,i){return i.x=t.x*e,i.y=t.y*e,i},e.AddVMulSV=function(t,e,i,s){return s.x=t.x+e*i.x,s.y=t.y+e*i.y,s},e.SubVMulSV=function(t,e,i,s){return s.x=t.x-e*i.x,s.y=t.y-e*i.y,s},e.AddVCrossSV=function(t,e,i,s){var o=i.x;return s.x=t.x-e*i.y,s.y=t.y+e*o,s},e.MidVV=function(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i},e.ExtVV=function(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i},e.IsEqualToV=function(t,e){return t.x===e.x&&t.y===e.y},e.DistanceVV=function(t,e){var i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)},e.DistanceSquaredVV=function(t,e){var i=t.x-e.x,s=t.y-e.y;return i*i+s*s},e.NegV=function(t,e){return e.x=-t.x,e.y=-t.y,e},e.ZERO=new e(0,0),e.UNITX=new e(1,0),e.UNITY=new e(0,1),e.s_t0=new e,e.s_t1=new e,e.s_t2=new e,e.s_t3=new e,e);function e(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}o.Vec2=s,o.Vec2_zero=new s(0,0);var t=(Object.defineProperty(i.prototype,"x",{get:function(){return this.data[0]},set:function(t){this.data[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"y",{get:function(){return this.data[1]},set:function(t){this.data[1]=t},enumerable:!0,configurable:!0}),i.prototype.clone=function(){return new i(new Float32Array(this.data))},i.prototype.setZero=function(){return this.x=0,this.y=0,this},i.prototype.set=function(t,e){return this.x=t,this.y=e,this},i.prototype.copy=function(t){return t instanceof i?this.data.set(t.data):(this.x=t.x,this.y=t.y),this},i.prototype.selfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},i.prototype.selfAddXY=function(t,e){return this.x+=t,this.y+=e,this},i.prototype.selfSub=function(t){return this.x-=t.x,this.y-=t.y,this},i.prototype.selfSubXY=function(t,e){return this.x-=t,this.y-=e,this},i.prototype.selfMul=function(t){return this.x*=t,this.y*=t,this},i.prototype.selfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},i.prototype.selfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},i.prototype.dot=function(t){return this.x*t.x+this.y*t.y},i.prototype.cross=function(t){return this.x*t.y-this.y*t.x},i.prototype.length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},i.prototype.lengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},i.prototype.normalize=function(){var t,e=this.length();return e>=o.epsilon&&(t=1/e,this.x*=t,this.y*=t),e},i.prototype.selfNormalize=function(){var t,e=this.length();return e>=o.epsilon&&(t=1/e,this.x*=t,this.y*=t),this},i.prototype.selfRotate=function(t){var e=Math.cos(t),i=Math.sin(t),s=this.x;return this.x=e*s-i*this.y,this.y=i*s+e*this.y,this},i.prototype.selfRotateCosSin=function(t,e){var i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this},i.prototype.isValid=function(){return isFinite(this.x)&&isFinite(this.y)},i.prototype.selfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},i.prototype.selfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},i.prototype.selfMinV=function(t){return this.x=o.Min(this.x,t.x),this.y=o.Min(this.y,t.y),this},i.prototype.selfMaxV=function(t){return this.x=o.Max(this.x,t.x),this.y=o.Max(this.y,t.y),this},i.prototype.selfAbs=function(){return this.x=o.Abs(this.x),this.y=o.Abs(this.y),this},i.prototype.selfNeg=function(){return this.x=-this.x,this.y=-this.y,this},i.prototype.selfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},i);function i(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t[0]instanceof Float32Array){if(2!==t[0].length)throw new Error;this.data=t[0]}else{var i="number"==typeof t[0]?t[0]:0,s="number"==typeof t[1]?t[1]:0;this.data=new Float32Array([i,s])}}o.TypedVec2=t;var c=(Object.defineProperty(r.prototype,"x",{get:function(){return this.data[0]},set:function(t){this.data[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this.data[1]},set:function(t){this.data[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"z",{get:function(){return this.data[2]},set:function(t){this.data[2]=t},enumerable:!0,configurable:!0}),r.prototype.clone=function(){return new r(this.x,this.y,this.z)},r.prototype.setZero=function(){return this.x=0,this.y=0,this.z=0,this},r.prototype.setXYZ=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},r.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},r.prototype.selfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},r.prototype.selfAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},r.prototype.selfAddXYZ=function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},r.prototype.selfSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},r.prototype.selfSubXYZ=function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},r.prototype.selfMul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},r.dotV3V3=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},r.crossV3V3=function(t,e,i){var s=t.x,o=t.y,n=t.z,r=e.x,a=e.y,c=e.z;return i.x=o*c-n*a,i.y=n*r-s*c,i.z=s*a-o*r,i},r.ZERO=new r(0,0,0),r.s_t0=new r,r);function r(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t[0]instanceof Float32Array){if(3!==t[0].length)throw new Error;this.data=t[0]}else{var i="number"==typeof t[0]?t[0]:0,s="number"==typeof t[1]?t[1]:0,o="number"==typeof t[2]?t[2]:0;this.data=new Float32Array([i,s,o])}}o.Vec3=c;var a=(l.prototype.clone=function(){return(new l).copy(this)},l.fromVV=function(t,e){return(new l).setVV(t,e)},l.fromSSSS=function(t,e,i,s){return(new l).setSSSS(t,e,i,s)},l.fromAngle=function(t){return(new l).setAngle(t)},l.prototype.setSSSS=function(t,e,i,s){return this.ex.set(t,i),this.ey.set(e,s),this},l.prototype.setVV=function(t,e){return this.ex.copy(t),this.ey.copy(e),this},l.prototype.setAngle=function(t){var e=Math.cos(t),i=Math.sin(t);return this.ex.set(e,i),this.ey.set(-i,e),this},l.prototype.copy=function(t){return this.ex.copy(t.ex),this.ey.copy(t.ey),this},l.prototype.setIdentity=function(){return this.ex.set(1,0),this.ey.set(0,1),this},l.prototype.setZero=function(){return this.ex.setZero(),this.ey.setZero(),this},l.prototype.getAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},l.prototype.getInverse=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;return 0!==n&&(n=1/n),t.ex.x=n*o,t.ey.x=-n*i,t.ex.y=-n*s,t.ey.y=n*e,t},l.prototype.solve=function(t,e,i){var s=this.ex.x,o=this.ey.x,n=this.ex.y,r=this.ey.y,a=s*r-o*n;return 0!==a&&(a=1/a),i.x=a*(r*t-o*e),i.y=a*(s*e-n*t),i},l.prototype.selfAbs=function(){return this.ex.selfAbs(),this.ey.selfAbs(),this},l.prototype.selfInv=function(){return this.getInverse(this),this},l.prototype.selfAddM=function(t){return this.ex.selfAdd(t.ex),this.ey.selfAdd(t.ey),this},l.prototype.selfSubM=function(t){return this.ex.selfSub(t.ex),this.ey.selfSub(t.ey),this},l.absM=function(t,e){var i=t.ex,s=t.ey;return e.ex.x=o.Abs(i.x),e.ex.y=o.Abs(i.y),e.ey.x=o.Abs(s.x),e.ey.y=o.Abs(s.y),e},l.mulMV=function(t,e,i){var s=t.ex,o=t.ey,n=e.x,r=e.y;return i.x=s.x*n+o.x*r,i.y=s.y*n+o.y*r,i},l.mulTMV=function(t,e,i){var s=t.ex,o=t.ey,n=e.x,r=e.y;return i.x=s.x*n+s.y*r,i.y=o.x*n+o.y*r,i},l.addMM=function(t,e,i){var s=t.ex,o=t.ey,n=e.ex,r=e.ey;return i.ex.x=s.x+n.x,i.ex.y=s.y+n.y,i.ey.x=o.x+r.x,i.ey.y=o.y+r.y,i},l.mulMM=function(t,e,i){var s=t.ex.x,o=t.ex.y,n=t.ey.x,r=t.ey.y,a=e.ex.x,c=e.ex.y,l=e.ey.x,h=e.ey.y;return i.ex.x=s*a+n*c,i.ex.y=o*a+r*c,i.ey.x=s*l+n*h,i.ey.y=o*l+r*h,i},l.mulTMM=function(t,e,i){var s=t.ex.x,o=t.ex.y,n=t.ey.x,r=t.ey.y,a=e.ex.x,c=e.ex.y,l=e.ey.x,h=e.ey.y;return i.ex.x=s*a+o*c,i.ex.y=n*a+r*c,i.ey.x=s*l+o*h,i.ey.y=n*l+r*h,i},l.IDENTITY=new l,l);function l(){this.ex=new s(1,0),this.ey=new s(0,1)}o.Mat22=a;var h=(u.prototype.clone=function(){return(new u).copy(this)},u.prototype.setVVV=function(t,e,i){return this.ex.copy(t),this.ey.copy(e),this.ez.copy(i),this},u.prototype.copy=function(t){return this.ex.copy(t.ex),this.ey.copy(t.ey),this.ez.copy(t.ez),this},u.prototype.setIdentity=function(){return this.ex.setXYZ(1,0,0),this.ey.setXYZ(0,1,0),this.ez.setXYZ(0,0,1),this},u.prototype.setZero=function(){return this.ex.setZero(),this.ey.setZero(),this.ez.setZero(),this},u.prototype.selfAddM=function(t){return this.ex.selfAdd(t.ex),this.ey.selfAdd(t.ey),this.ez.selfAdd(t.ez),this},u.prototype.solve33=function(t,e,i,s){var o=this.ex.x,n=this.ex.y,r=this.ex.z,a=this.ey.x,c=this.ey.y,l=this.ey.z,h=this.ez.x,u=this.ez.y,p=this.ez.z,d=o*(c*p-l*u)+n*(l*h-a*p)+r*(a*u-c*h);return 0!==d&&(d=1/d),s.x=d*(t*(c*p-l*u)+e*(l*h-a*p)+i*(a*u-c*h)),s.y=d*(o*(e*p-i*u)+n*(i*h-t*p)+r*(t*u-e*h)),s.z=d*(o*(c*i-l*e)+n*(l*t-a*i)+r*(a*e-c*t)),s},u.prototype.solve22=function(t,e,i){var s=this.ex.x,o=this.ey.x,n=this.ex.y,r=this.ey.y,a=s*r-o*n;return 0!==a&&(a=1/a),i.x=a*(r*t-o*e),i.y=a*(s*e-n*t),i},u.prototype.getInverse22=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;0!==n&&(n=1/n),t.ex.x=n*o,t.ey.x=-n*i,t.ex.z=0,t.ex.y=-n*s,t.ey.y=n*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},u.prototype.getSymInverse33=function(t){var e=c.dotV3V3(this.ex,c.crossV3V3(this.ey,this.ez,c.s_t0));0!==e&&(e=1/e);var i=this.ex.x,s=this.ey.x,o=this.ez.x,n=this.ey.y,r=this.ez.y,a=this.ez.z;t.ex.x=e*(n*a-r*r),t.ex.y=e*(o*r-s*a),t.ex.z=e*(s*r-o*n),t.ey.x=t.ex.y,t.ey.y=e*(i*a-o*o),t.ey.z=e*(o*s-i*r),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*n-s*s)},u.mulM33V3=function(t,e,i){var s=e.x,o=e.y,n=e.z;return i.x=t.ex.x*s+t.ey.x*o+t.ez.x*n,i.y=t.ex.y*s+t.ey.y*o+t.ez.y*n,i.z=t.ex.z*s+t.ey.z*o+t.ez.z*n,i},u.mulM33XYZ=function(t,e,i,s,o){return o.x=t.ex.x*e+t.ey.x*i+t.ez.x*s,o.y=t.ex.y*e+t.ey.y*i+t.ez.y*s,o.z=t.ex.z*e+t.ey.z*i+t.ez.z*s,o},u.mulM33V2=function(t,e,i){var s=e.x,o=e.y;return i.x=t.ex.x*s+t.ey.x*o,i.y=t.ex.y*s+t.ey.y*o,i},u.mulM33XY=function(t,e,i,s){return s.x=t.ex.x*e+t.ey.x*i,s.y=t.ex.y*e+t.ey.y*i,s},u.IDENTITY=new u,u);function u(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new c(this.data.subarray(0,3)),this.ey=new c(this.data.subarray(3,6)),this.ez=new c(this.data.subarray(6,9))}o.Mat33=h;var p=(d.prototype.clone=function(){return(new d).copy(this)},d.prototype.copy=function(t){return this.s=t.s,this.c=t.c,this},d.prototype.setAngle=function(t){return this.s=Math.sin(t),this.c=Math.cos(t),this},d.prototype.setIdentity=function(){return this.s=0,this.c=1,this},d.prototype.getAngle=function(){return Math.atan2(this.s,this.c)},d.prototype.getXAxis=function(t){return t.x=this.c,t.y=this.s,t},d.prototype.getYAxis=function(t){return t.x=-this.s,t.y=this.c,t},d.mulRR=function(t,e,i){var s=t.c,o=t.s,n=e.c,r=e.s;return i.s=o*n+s*r,i.c=s*n-o*r,i},d.mulTRR=function(t,e,i){var s=t.c,o=t.s,n=e.c,r=e.s;return i.s=s*r-o*n,i.c=s*n+o*r,i},d.mulRV=function(t,e,i){var s=t.c,o=t.s,n=e.x,r=e.y;return i.x=s*n-o*r,i.y=o*n+s*r,i},d.mulTRV=function(t,e,i){var s=t.c,o=t.s,n=e.x,r=e.y;return i.x=s*n+o*r,i.y=-o*n+s*r,i},d.IDENTITY=new d,d);function d(t){void 0===t&&(t=0),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}o.Rot=p;var f=(y.prototype.clone=function(){return(new y).copy(this)},y.prototype.copy=function(t){return this.p.copy(t.p),this.q.copy(t.q),this},y.prototype.setIdentity=function(){return this.p.setZero(),this.q.setIdentity(),this},y.prototype.setPositionRotation=function(t,e){return this.p.copy(t),this.q.copy(e),this},y.prototype.setPositionAngle=function(t,e){return this.p.copy(t),this.q.setAngle(e),this},y.prototype.setPosition=function(t){return this.p.copy(t),this},y.prototype.setPositionXY=function(t,e){return this.p.set(t,e),this},y.prototype.setRotation=function(t){return this.q.copy(t),this},y.prototype.setRotationAngle=function(t){return this.q.setAngle(t),this},y.prototype.getPosition=function(){return this.p},y.prototype.getRotation=function(){return this.q},y.prototype.getRotationAngle=function(){return this.q.getAngle()},y.prototype.getAngle=function(){return this.q.getAngle()},y.mulXV=function(t,e,i){var s=t.q.c,o=t.q.s,n=e.x,r=e.y;return i.x=s*n-o*r+t.p.x,i.y=o*n+s*r+t.p.y,i},y.mulTXV=function(t,e,i){var s=t.q.c,o=t.q.s,n=e.x-t.p.x,r=e.y-t.p.y;return i.x=s*n+o*r,i.y=-o*n+s*r,i},y.mulXX=function(t,e,i){return p.mulRR(t.q,e.q,i.q),s.AddVV(p.mulRV(t.q,e.p,i.p),t.p,i.p),i},y.mulTXX=function(t,e,i){return p.mulTRR(t.q,e.q,i.q),p.mulTRV(t.q,s.SubVV(e.p,t.p,i.p),i.p),i},y.IDENTITY=new y,y);function y(){this.p=new s,this.q=new p}o.Transform=f;var V=(v.prototype.clone=function(){return(new v).copy(this)},v.prototype.copy=function(t){return this.localCenter.copy(t.localCenter),this.c0.copy(t.c0),this.c.copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this},v.prototype.getTransform=function(t,e){t.p.x=(1-e)*this.c0.x+e*this.c.x,t.p.y=(1-e)*this.c0.y+e*this.c.y;var i=(1-e)*this.a0+e*this.a;return t.q.setAngle(i),t.p.selfSub(p.mulRV(t.q,this.localCenter,s.s_t0)),t},v.prototype.advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t},v.prototype.normalize=function(){var t=o.two_pi*Math.floor(this.a0/o.two_pi);this.a0-=t,this.a-=t},v);function v(){this.localCenter=new s,this.c0=new s,this.c=new s,this.a0=0,this.a=0,this.alpha0=0}o.Sweep=V}(b2=b2||{}),function(b){var t=(e.prototype.copy=function(t){return t.vertices===t.buffer?(this.vertices=this.buffer,this.buffer[0].copy(t.buffer[0]),this.buffer[1].copy(t.buffer[1])):this.vertices=t.vertices,this.count=t.count,this.radius=t.radius,this},e.prototype.reset=function(){return this.vertices=this.buffer,this.count=0,this.radius=0,this},e.prototype.setShape=function(t,e){t.setupDistanceProxy(this,e)},e.prototype.setVerticesRadius=function(t,e,i){this.vertices=t,this.count=e,this.radius=i},e.prototype.getSupport=function(t){for(var e=0,i=b.Vec2.DotVV(this.vertices[0],t),s=1;s<this.count;++s){var o=b.Vec2.DotVV(this.vertices[s],t);i<o&&(e=s,i=o)}return e},e.prototype.getSupportVertex=function(t){for(var e=0,i=b.Vec2.DotVV(this.vertices[0],t),s=1;s<this.count;++s){var o=b.Vec2.DotVV(this.vertices[s],t);i<o&&(e=s,i=o)}return this.vertices[e]},e.prototype.getVertexCount=function(){return this.count},e.prototype.getVertex=function(t){return this.vertices[t]},e);function e(){this.buffer=b.Vec2.MakeArray(2),this.vertices=this.buffer,this.count=0,this.radius=0}b.DistanceProxy=t;var i=(s.prototype.reset=function(){return this.metric=0,this.count=0,this},s);function s(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}b.SimplexCache=i;var o=(n.prototype.reset=function(){return this.proxyA.reset(),this.proxyB.reset(),this.transformA.setIdentity(),this.transformB.setIdentity(),this.useRadii=!1,this},n);function n(){this.proxyA=new t,this.proxyB=new t,this.transformA=new b.Transform,this.transformB=new b.Transform,this.useRadii=!1}b.DistanceInput=o;var r=(a.prototype.reset=function(){return this.pointA.setZero(),this.pointB.setZero(),this.distance=0,this.iterations=0,this},a);function a(){this.pointA=new b.Vec2,this.pointB=new b.Vec2,this.distance=0,this.iterations=0}b.DistanceOutput=r;function c(){this.proxyA=new t,this.proxyB=new t,this.transformA=new b.Transform,this.transformB=new b.Transform,this.translationB=new b.Vec2}b.ShapeCastInput=c;function l(){this.point=new b.Vec2,this.normal=new b.Vec2,this.lambda=0,this.iterations=0}b.ShapeCastOutput=l,b.gjkCalls=0,b.gjkIters=0,b.gjkMaxIters=0,b.gjkReset=function(){b.gjkCalls=0,b.gjkIters=0,b.gjkMaxIters=0};var h=(u.prototype.copy=function(t){return this.wA.copy(t.wA),this.wB.copy(t.wB),this.w.copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this},u);function u(){this.wA=new b.Vec2,this.wB=new b.Vec2,this.w=new b.Vec2,this.a=0,this.indexA=0,this.indexB=0}b.SimplexVertex=h;var p=(w.prototype.readCache=function(t,e,i,s,o){this.count=t.count;for(var n,r,a,c=this.vertices,l=0;l<this.count;++l){(a=c[l]).indexA=t.indexA[l],a.indexB=t.indexB[l];var h=e.getVertex(a.indexA),u=s.getVertex(a.indexB);b.Transform.mulXV(i,h,a.wA),b.Transform.mulXV(o,u,a.wB),b.Vec2.SubVV(a.wB,a.wA,a.w),a.a=0}1<this.count&&(n=t.metric,((r=this.getMetric())<.5*n||2*n<r||r<b.epsilon)&&(this.count=0)),0===this.count&&((a=c[0]).indexA=0,a.indexB=0,h=e.getVertex(0),u=s.getVertex(0),b.Transform.mulXV(i,h,a.wA),b.Transform.mulXV(o,u,a.wB),b.Vec2.SubVV(a.wB,a.wA,a.w),a.a=1,this.count=1)},w.prototype.writeCache=function(t){t.metric=this.getMetric(),t.count=this.count;for(var e=this.vertices,i=0;i<this.count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB},w.prototype.getSearchDirection=function(t){switch(this.count){case 1:return b.Vec2.NegV(this.v1.w,t);case 2:var e=b.Vec2.SubVV(this.v2.w,this.v1.w,t);return 0<b.Vec2.CrossVV(e,b.Vec2.NegV(this.v1.w,b.Vec2.s_t0))?b.Vec2.CrossOneV(e,t):b.Vec2.CrossVOne(e,t);default:return t.setZero()}},w.prototype.getClosestPoint=function(t){switch(this.count){case 0:return t.setZero();case 1:return t.copy(this.v1.w);case 2:return t.set(this.v1.a*this.v1.w.x+this.v2.a*this.v2.w.x,this.v1.a*this.v1.w.y+this.v2.a*this.v2.w.y);case 3:default:return t.setZero()}},w.prototype.getWitnessPoints=function(t,e){switch(this.count){case 0:break;case 1:t.copy(this.v1.wA),e.copy(this.v1.wB);break;case 2:t.x=this.v1.a*this.v1.wA.x+this.v2.a*this.v2.wA.x,t.y=this.v1.a*this.v1.wA.y+this.v2.a*this.v2.wA.y,e.x=this.v1.a*this.v1.wB.x+this.v2.a*this.v2.wB.x,e.y=this.v1.a*this.v1.wB.y+this.v2.a*this.v2.wB.y;break;case 3:e.x=t.x=this.v1.a*this.v1.wA.x+this.v2.a*this.v2.wA.x+this.v3.a*this.v3.wA.x,e.y=t.y=this.v1.a*this.v1.wA.y+this.v2.a*this.v2.wA.y+this.v3.a*this.v3.wA.y}},w.prototype.getMetric=function(){switch(this.count){case 0:case 1:return 0;case 2:return b.Vec2.DistanceVV(this.v1.w,this.v2.w);case 3:return b.Vec2.CrossVV(b.Vec2.SubVV(this.v2.w,this.v1.w,b.Vec2.s_t0),b.Vec2.SubVV(this.v3.w,this.v1.w,b.Vec2.s_t1));default:return 0}},w.prototype.solve2=function(){var t=this.v1.w,e=this.v2.w,i=b.Vec2.SubVV(e,t,w.s_e12),s=-b.Vec2.DotVV(t,i);if(s<=0)return this.v1.a=1,void(this.count=1);var o=b.Vec2.DotVV(e,i);if(o<=0)return this.v2.a=1,this.count=1,void this.v1.copy(this.v2);var n=1/(o+s);this.v1.a=o*n,this.v2.a=s*n,this.count=2},w.prototype.solve3=function(){var t=this.v1.w,e=this.v2.w,i=this.v3.w,s=b.Vec2.SubVV(e,t,w.s_e12),o=b.Vec2.DotVV(t,s),n=b.Vec2.DotVV(e,s),r=-o,a=b.Vec2.SubVV(i,t,w.s_e13),c=b.Vec2.DotVV(t,a),l=b.Vec2.DotVV(i,a),h=-c,u=b.Vec2.SubVV(i,e,w.s_e23),p=b.Vec2.DotVV(e,u),d=b.Vec2.DotVV(i,u),f=-p,y=b.Vec2.CrossVV(s,a),V=y*b.Vec2.CrossVV(e,i),v=y*b.Vec2.CrossVV(i,t),x=y*b.Vec2.CrossVV(t,e);if(r<=0&&h<=0)return this.v1.a=1,void(this.count=1);if(0<n&&0<r&&x<=0){var g=1/(n+r);return this.v1.a=n*g,this.v2.a=r*g,void(this.count=2)}if(0<l&&0<h&&v<=0){var m=1/(l+h);return this.v1.a=l*m,this.v3.a=h*m,this.count=2,void this.v2.copy(this.v3)}if(n<=0&&f<=0)return this.v2.a=1,this.count=1,void this.v1.copy(this.v2);if(l<=0&&d<=0)return this.v3.a=1,this.count=1,void this.v1.copy(this.v3);if(0<d&&0<f&&V<=0){var B=1/(d+f);return this.v2.a=d*B,this.v3.a=f*B,this.count=2,void this.v1.copy(this.v3)}var A=1/(V+v+x);this.v1.a=V*A,this.v2.a=v*A,this.v3.a=x*A,this.count=3},w.s_e12=new b.Vec2,w.s_e13=new b.Vec2,w.s_e23=new b.Vec2,w);function w(){this.v1=new h,this.v2=new h,this.v3=new h,this.vertices=[],this.count=0,this.vertices[0]=this.v1,this.vertices[1]=this.v2,this.vertices[2]=this.v3}var B=new(b.Simplex=p),A=[0,0,0],C=[0,0,0],_=new b.Vec2,S=new b.Vec2,M=new b.Vec2,P=new b.Vec2,I=new b.Vec2;b.distance=function(t,e,i){++b.gjkCalls;var s=i.proxyA,o=i.proxyB,n=i.transformA,r=i.transformB,a=B;a.readCache(e,s,n,o,r);for(var c,l,h,u,p,d=a.vertices,f=A,y=C,V=0;V<20;){c=a.count;for(var v=0;v<c;++v)f[v]=d[v].indexA,y[v]=d[v].indexB;switch(a.count){case 1:break;case 2:a.solve2();break;case 3:a.solve3()}if(3===a.count)break;var x=a.getSearchDirection(S);if(x.lengthSquared()<b.epsilonSq)break;var g=d[a.count];g.indexA=s.getSupport(b.Rot.mulTRV(n.q,b.Vec2.NegV(x,b.Vec2.s_t0),P)),b.Transform.mulXV(n,s.getVertex(g.indexA),g.wA),g.indexB=o.getSupport(b.Rot.mulTRV(r.q,x,I)),b.Transform.mulXV(r,o.getVertex(g.indexB),g.wB),b.Vec2.SubVV(g.wB,g.wA,g.w),++V,++b.gjkIters;for(var m=!1,v=0;v<c;++v)if(g.indexA===f[v]&&g.indexB===y[v]){m=!0;break}if(m)break;++a.count}b.gjkMaxIters=b.Max(b.gjkMaxIters,V),a.getWitnessPoints(t.pointA,t.pointB),t.distance=b.Vec2.DistanceVV(t.pointA,t.pointB),t.iterations=V,a.writeCache(e),i.useRadii&&(l=s.radius,h=o.radius,t.distance>l+h&&t.distance>b.epsilon?(t.distance-=l+h,(u=b.Vec2.SubVV(t.pointB,t.pointA,M)).normalize(),t.pointA.selfMulAdd(l,u),t.pointB.selfMulSub(h,u)):(p=b.Vec2.MidVV(t.pointA,t.pointB,_),t.pointA.copy(p),t.pointB.copy(p),t.distance=0))};var T=new b.Vec2,F=new p,D=new b.Vec2,L=new b.Vec2,R=new b.Vec2,k=new b.Vec2,q=new b.Vec2,J=new b.Vec2;b.shapeCast=function(t,e){t.iterations=0,t.lambda=1,t.normal.setZero(),t.point.setZero();var i=e.proxyA,s=e.proxyB,o=b.Max(i.radius,b.polygonRadius)+b.Max(s.radius,b.polygonRadius),n=e.transformA,r=e.transformB,a=e.translationB,c=T.set(0,0),l=0,h=F;h.count=0;for(var u=h.vertices,p=i.getSupport(b.Rot.mulTRV(n.q,b.Vec2.NegV(a,b.Vec2.s_t1),b.Vec2.s_t0)),d=b.Transform.mulXV(n,i.getVertex(p),D),f=s.getSupport(b.Rot.mulTRV(r.q,a,b.Vec2.s_t0)),y=b.Transform.mulXV(r,s.getVertex(f),L),V=b.Vec2.SubVV(d,y,R),v=b.Max(b.polygonRadius,o-b.polygonRadius),x=.5*b.linearSlop,g=0;g<20&&V.length()-v>x;){t.iterations+=1,p=i.getSupport(b.Rot.mulTRV(n.q,b.Vec2.NegV(V,b.Vec2.s_t1),b.Vec2.s_t0)),d=b.Transform.mulXV(n,i.getVertex(p),D),f=s.getSupport(b.Rot.mulTRV(r.q,V,b.Vec2.s_t0)),y=b.Transform.mulXV(r,s.getVertex(f),L);var m=b.Vec2.SubVV(d,y,k);V.normalize();var B=b.Vec2.DotVV(V,m),A=b.Vec2.DotVV(V,a);if(l*A<B-v){if(A<=0)return!1;if(1<(l=(B-v)/A))return!1;c.copy(V).selfNeg(),h.count=0}var w=u[h.count];switch(w.indexA=f,w.wA.copy(y).selfMulAdd(l,a),w.indexB=p,w.wB.copy(d),w.w.copy(w.wB).selfSub(w.wA),w.a=1,h.count+=1,h.count){case 1:break;case 2:h.solve2();break;case 3:h.solve3()}if(3===h.count)return!1;h.getClosestPoint(V),++g}return 0!==g&&(h.getWitnessPoints(q,J),0<V.lengthSquared()&&(c.copy(V).selfNeg(),c.normalize()),t.normal.copy(c),t.lambda=l,t.iterations=g,!0)}}(b2=b2||{}),function(t){var e=(i.prototype.reset=function(){return this.start=Date.now(),this},i.prototype.getMilliseconds=function(){return Date.now()-this.start},i);function i(){this.start=Date.now()}t.Timer=e;var s=(o.prototype.increment=function(){this.count++,this.maxCount<this.count&&(this.maxCount=this.count)},o.prototype.decrement=function(){this.count--,this.minCount>this.count&&(this.minCount=this.count)},o);function o(){this.count=0,this.minCount=0,this.maxCount=0}t.Counter=s}(b2=b2||{}),function(V){var d,t;(t=d=V.ContactFeatureType||(V.ContactFeatureType={}))[t.Vertex=0]="Vertex",t[t.Face=1]="Face";var e=(Object.defineProperty(i.prototype,"key",{get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"indexA",{get:function(){return this._indexA},set:function(t){this._indexA=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"indexB",{get:function(){return this._indexB},set:function(t){this._indexB=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"typeA",{get:function(){return this._typeA},set:function(t){this._typeA=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"typeB",{get:function(){return this._typeB},set:function(t){this._typeB=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),i);function i(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}V.ContactFeature=e;var s=(o.prototype.copy=function(t){return this.key=t.key,this},o.prototype.clone=function(){return(new o).copy(this)},Object.defineProperty(o.prototype,"key",{get:function(){return this.cf.key},set:function(t){this.cf.key=t},enumerable:!0,configurable:!0}),o);function o(){this.cf=new e}V.ContactID=s;var f,n,r=(a.makeArray=function(t){return V.MakeArray(t,function(t){return new a})},a.prototype.reset=function(){this.localPoint.setZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},a.prototype.copy=function(t){return this.localPoint.copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.copy(t.id),this},a);function a(){this.localPoint=new V.Vec2,this.normalImpulse=0,this.tangentImpulse=0,this.id=new s}V.ManifoldPoint=r,(n=f=V.ManifoldType||(V.ManifoldType={}))[n.Unknown=-1]="Unknown",n[n.Circles=0]="Circles",n[n.FaceA=1]="FaceA",n[n.FaceB=2]="FaceB";var c=(l.prototype.reset=function(){for(var t=0;t<V.maxManifoldPoints;++t)this.points[t].reset();this.localNormal.setZero(),this.localPoint.setZero(),this.type=f.Unknown,this.pointCount=0},l.prototype.copy=function(t){this.pointCount=t.pointCount;for(var e=0;e<V.maxManifoldPoints;++e)this.points[e].copy(t.points[e]);return this.localNormal.copy(t.localNormal),this.localPoint.copy(t.localPoint),this.type=t.type,this},l.prototype.clone=function(){return(new l).copy(this)},l);function l(){this.points=r.makeArray(V.maxManifoldPoints),this.localNormal=new V.Vec2,this.localPoint=new V.Vec2,this.type=f.Unknown,this.pointCount=0}V.Manifold=c;var h,u,p=(y.prototype.initialize=function(t,e,i,s,o){if(0!==t.pointCount)switch(t.type){case f.Circles:this.normal.set(1,0);var n=V.Transform.mulXV(e,t.localPoint,y.Initialize_s_pointA),r=V.Transform.mulXV(s,t.points[0].localPoint,y.Initialize_s_pointB);V.Vec2.DistanceSquaredVV(n,r)>V.epsilonSq&&V.Vec2.SubVV(r,n,this.normal).selfNormalize();var a=V.Vec2.AddVMulSV(n,i,this.normal,y.Initialize_s_cA),c=V.Vec2.SubVMulSV(r,o,this.normal,y.Initialize_s_cB);V.Vec2.MidVV(a,c,this.points[0]),this.separations[0]=V.Vec2.DotVV(V.Vec2.SubVV(c,a,V.Vec2.s_t0),this.normal);break;case f.FaceA:V.Rot.mulRV(e.q,t.localNormal,this.normal);for(var l=V.Transform.mulXV(e,t.localPoint,y.Initialize_s_planePoint),h=0;h<t.pointCount;++h){var u=V.Transform.mulXV(s,t.points[h].localPoint,y.Initialize_s_clipPoint),p=i-V.Vec2.DotVV(V.Vec2.SubVV(u,l,V.Vec2.s_t0),this.normal),a=V.Vec2.AddVMulSV(u,p,this.normal,y.Initialize_s_cA),c=V.Vec2.SubVMulSV(u,o,this.normal,y.Initialize_s_cB);V.Vec2.MidVV(a,c,this.points[h]),this.separations[h]=V.Vec2.DotVV(V.Vec2.SubVV(c,a,V.Vec2.s_t0),this.normal)}break;case f.FaceB:V.Rot.mulRV(s.q,t.localNormal,this.normal);for(l=V.Transform.mulXV(s,t.localPoint,y.Initialize_s_planePoint),h=0;h<t.pointCount;++h){u=V.Transform.mulXV(e,t.points[h].localPoint,y.Initialize_s_clipPoint),p=o-V.Vec2.DotVV(V.Vec2.SubVV(u,l,V.Vec2.s_t0),this.normal),c=V.Vec2.AddVMulSV(u,p,this.normal,y.Initialize_s_cB),a=V.Vec2.SubVMulSV(u,i,this.normal,y.Initialize_s_cA);V.Vec2.MidVV(a,c,this.points[h]),this.separations[h]=V.Vec2.DotVV(V.Vec2.SubVV(a,c,V.Vec2.s_t0),this.normal)}this.normal.selfNeg()}},y.Initialize_s_pointA=new V.Vec2,y.Initialize_s_pointB=new V.Vec2,y.Initialize_s_cA=new V.Vec2,y.Initialize_s_cB=new V.Vec2,y.Initialize_s_planePoint=new V.Vec2,y.Initialize_s_clipPoint=new V.Vec2,y);function y(){this.normal=new V.Vec2,this.points=V.Vec2.MakeArray(V.maxManifoldPoints),this.separations=V.MakeNumberArray(V.maxManifoldPoints)}V.WorldManifold=p,(u=h=V.PointState||(V.PointState={}))[u.NullState=0]="NullState",u[u.AddState=1]="AddState",u[u.PersistState=2]="PersistState",u[u.RemoveState=3]="RemoveState",V.getPointStates=function(t,e,i,s){for(var o=0;o<i.pointCount;++o){var n=i.points[o].id.key;t[o]=h.RemoveState;for(var r=0,a=s.pointCount;r<a;++r)if(s.points[r].id.key===n){t[o]=h.PersistState;break}}for(;o<V.maxManifoldPoints;++o)t[o]=h.NullState;for(o=0;o<s.pointCount;++o){n=s.points[o].id.key;e[o]=h.AddState;for(r=0,a=i.pointCount;r<a;++r)if(i.points[r].id.key===n){e[o]=h.PersistState;break}}for(;o<V.maxManifoldPoints;++o)e[o]=h.NullState};var v=(x.makeArray=function(t){return V.MakeArray(t,function(t){return new x})},x.prototype.copy=function(t){return this.v.copy(t.v),this.id.copy(t.id),this},x);function x(){this.v=new V.Vec2,this.id=new s}V.ClipVertex=v;var g=(m.prototype.copy=function(t){return this.p1.copy(t.p1),this.p2.copy(t.p2),this.maxFraction=t.maxFraction,this},m);function m(){this.p1=new V.Vec2,this.p2=new V.Vec2,this.maxFraction=1}V.RayCastInput=g;var B=(A.prototype.copy=function(t){return this.normal.copy(t.normal),this.fraction=t.fraction,this},A);function A(){this.normal=new V.Vec2,this.fraction=0}V.RayCastOutput=B;var w=(b.prototype.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},b.prototype.isValid=function(){return!!this.lowerBound.isValid()&&(!!this.upperBound.isValid()&&(!(this.upperBound.x<this.lowerBound.x)&&!(this.upperBound.y<this.lowerBound.y)))},b.prototype.getCenter=function(){return V.Vec2.MidVV(this.lowerBound,this.upperBound,this.cache_center)},b.prototype.getExtents=function(){return V.Vec2.ExtVV(this.lowerBound,this.upperBound,this.cache_extent)},b.prototype.getPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},b.prototype.combine1=function(t){return this.lowerBound.x=V.Min(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=V.Min(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=V.Max(this.upperBound.x,t.upperBound.x),this.upperBound.y=V.Max(this.upperBound.y,t.upperBound.y),this},b.prototype.combine2=function(t,e){return this.lowerBound.x=V.Min(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=V.Min(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=V.Max(t.upperBound.x,e.upperBound.x),this.upperBound.y=V.Max(t.upperBound.y,e.upperBound.y),this},b.combine=function(t,e,i){return i.combine2(t,e),i},b.prototype.contains=function(t){return this.lowerBound.x<=t.lowerBound.x&&this.lowerBound.y<=t.lowerBound.y&&t.upperBound.x<=this.upperBound.x&&t.upperBound.y<=this.upperBound.y},b.prototype.rayCast=function(t,e){var i=-V.maxFloat,s=V.maxFloat,o=e.p1.x,n=e.p1.y,r=e.p2.x-e.p1.x,a=e.p2.y-e.p1.y,c=V.Abs(r),l=V.Abs(a),h=t.normal;if(c<V.epsilon){if(o<this.lowerBound.x||this.upperBound.x<o)return!1}else{var u=1/r,p=(this.lowerBound.x-o)*u,d=-1;if((f=(this.upperBound.x-o)*u)<p&&(y=p,p=f,f=y,d=1),i<p&&(h.x=d,h.y=0,i=p),(s=V.Min(s,f))<i)return!1}if(l<V.epsilon){if(n<this.lowerBound.y||this.upperBound.y<n)return!1}else{var f,y,u=1/a,p=(this.lowerBound.y-n)*u,d=-1;if((f=(this.upperBound.y-n)*u)<p&&(y=p,p=f,f=y,d=1),i<p&&(h.x=0,h.y=d,i=p),(s=V.Min(s,f))<i)return!1}return!(i<0||e.maxFraction<i)&&(t.fraction=i,!0)},b.prototype.testContain=function(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x)&&!(t.y<this.lowerBound.y||this.upperBound.y<t.y)},b.prototype.testOverlap=function(t){return!(this.upperBound.x<t.lowerBound.x)&&(!(this.upperBound.y<t.lowerBound.y)&&(!(t.upperBound.x<this.lowerBound.x)&&!(t.upperBound.y<this.lowerBound.y)))},b);function b(){this.lowerBound=new V.Vec2,this.upperBound=new V.Vec2,this.cache_center=new V.Vec2,this.cache_extent=new V.Vec2}V.AABB=w,V.testOverlapAABB=function(t,e){return!(t.upperBound.x<e.lowerBound.x)&&(!(t.upperBound.y<e.lowerBound.y)&&(!(e.upperBound.x<t.lowerBound.x)&&!(e.upperBound.y<t.lowerBound.y)))},V.clipSegmentToLine=function(t,e,i,s,o){var n,r,a,c=0,l=e[0],h=e[1],u=V.Vec2.DotVV(i,l.v)-s,p=V.Vec2.DotVV(i,h.v)-s;return u<=0&&t[c++].copy(l),p<=0&&t[c++].copy(h),u*p<0&&(n=u/(u-p),(r=t[c].v).x=l.v.x+n*(h.v.x-l.v.x),r.y=l.v.y+n*(h.v.y-l.v.y),(a=t[c].id).cf.indexA=o,a.cf.indexB=l.id.cf.indexB,a.cf.typeA=d.Vertex,a.cf.typeB=d.Face,++c),c};var C=new V.DistanceInput,_=new V.SimplexCache,S=new V.DistanceOutput;V.testOverlapShape=function(t,e,i,s,o,n){var r=C.reset();r.proxyA.setShape(t,e),r.proxyB.setShape(i,s),r.transformA.copy(o),r.transformB.copy(n),r.useRadii=!0;var a=_.reset();a.count=0;var c=S.reset();return V.distance(c,a,r),c.distance<10*V.epsilon}}(b2=b2||{}),function(t){function e(){this.mass=0,this.center=new t.Vec2(0,0),this.I=0}var i,s;t.MassData=e,(s=i=t.ShapeType||(t.ShapeType={}))[s.Unknown=-1]="Unknown",s[s.CircleShape=0]="CircleShape",s[s.EdgeShape=1]="EdgeShape",s[s.PolygonShape=2]="PolygonShape",s[s.ChainShape=3]="ChainShape",s[s.ShapeTypeCount=4]="ShapeTypeCount";var o=(n.prototype.copy=function(t){return this.radius=t.radius,this},n.prototype.getType=function(){return this.type},n);function n(t,e){this.type=i.Unknown,this.radius=0,this.type=t,this.radius=e}t.Shape=o}(b2=b2||{}),function(D){D.toiTime=0,D.toiMaxTime=0,D.toiCalls=0,D.toiIters=0,D.toiMaxIters=0,D.toiRootIters=0,D.toiMaxRootIters=0,D.toiReset=function(){D.toiTime=0,D.toiMaxTime=0,D.toiCalls=0,D.toiIters=0,D.toiMaxIters=0,D.toiRootIters=0,D.toiMaxRootIters=0};function t(){this.proxyA=new D.DistanceProxy,this.proxyB=new D.DistanceProxy,this.sweepA=new D.Sweep,this.sweepB=new D.Sweep,this.tMax=0}var L,e,R=new D.Transform,k=new D.Transform,g=new D.Vec2,m=new D.Vec2,B=new D.Vec2,p=new D.Vec2,d=new D.Vec2;D.TOIInput=t,(e=L=D.TOIOutputState||(D.TOIOutputState={}))[e.Unknown=0]="Unknown",e[e.Failed=1]="Failed",e[e.Overlapped=2]="Overlapped",e[e.Touching=3]="Touching",e[e.Separated=4]="Separated";function i(){this.state=L.Unknown,this.t=0}var A,s;D.TOIOutput=i,(s=A=D.SeparationFunctionType||(D.SeparationFunctionType={}))[s.Unknown=-1]="Unknown",s[s.Points=0]="Points",s[s.FaceA=1]="FaceA",s[s.FaceB=2]="FaceB";var o=(n.prototype.initialize=function(t,e,i,s,o,n){this.proxyA=e,this.proxyB=s;var r=t.count;this.sweepA.copy(i),this.sweepB.copy(o);var a=R,c=k;if(this.sweepA.getTransform(a,n),this.sweepB.getTransform(c,n),1===r){this.type=A.Points;var l=this.proxyA.getVertex(t.indexA[0]),h=this.proxyB.getVertex(t.indexB[0]),u=D.Transform.mulXV(a,l,g),p=D.Transform.mulXV(c,h,m);D.Vec2.SubVV(p,u,this.axis);var d=this.axis.normalize();return this.localPoint.setZero(),d}if(t.indexA[0]===t.indexA[1]){this.type=A.FaceB;var f=this.proxyB.getVertex(t.indexB[0]),y=this.proxyB.getVertex(t.indexB[1]);D.Vec2.CrossVOne(D.Vec2.SubVV(y,f,D.Vec2.s_t0),this.axis).selfNormalize();var V=D.Rot.mulRV(c.q,this.axis,B);D.Vec2.MidVV(f,y,this.localPoint);p=D.Transform.mulXV(c,this.localPoint,m),l=this.proxyA.getVertex(t.indexA[0]),u=D.Transform.mulXV(a,l,g);return(d=D.Vec2.DotVV(D.Vec2.SubVV(u,p,D.Vec2.s_t0),V))<0&&(this.axis.selfNeg(),d=-d),d}this.type=A.FaceA;var v=this.proxyA.getVertex(t.indexA[0]),x=this.proxyA.getVertex(t.indexA[1]);D.Vec2.CrossVOne(D.Vec2.SubVV(x,v,D.Vec2.s_t0),this.axis).selfNormalize();V=D.Rot.mulRV(a.q,this.axis,B);D.Vec2.MidVV(v,x,this.localPoint);u=D.Transform.mulXV(a,this.localPoint,g),h=this.proxyB.getVertex(t.indexB[0]),p=D.Transform.mulXV(c,h,m);return(d=D.Vec2.DotVV(D.Vec2.SubVV(p,u,D.Vec2.s_t0),V))<0&&(this.axis.selfNeg(),d=-d),d},n.prototype.findMinSeparation=function(t,e,i){var s=R,o=k;switch(this.sweepA.getTransform(s,i),this.sweepB.getTransform(o,i),this.type){case A.Points:var n=D.Rot.mulTRV(s.q,this.axis,p),r=D.Rot.mulTRV(o.q,D.Vec2.NegV(this.axis,D.Vec2.s_t0),d);t[0]=this.proxyA.getSupport(n),e[0]=this.proxyB.getSupport(r);var a=this.proxyA.getVertex(t[0]),c=this.proxyB.getVertex(e[0]),l=D.Transform.mulXV(s,a,g),h=D.Transform.mulXV(o,c,m);return D.Vec2.DotVV(D.Vec2.SubVV(h,l,D.Vec2.s_t0),this.axis);case A.FaceA:var u=D.Rot.mulRV(s.q,this.axis,B),l=D.Transform.mulXV(s,this.localPoint,g),r=D.Rot.mulTRV(o.q,D.Vec2.NegV(u,D.Vec2.s_t0),d);t[0]=-1,e[0]=this.proxyB.getSupport(r);c=this.proxyB.getVertex(e[0]),h=D.Transform.mulXV(o,c,m);return D.Vec2.DotVV(D.Vec2.SubVV(h,l,D.Vec2.s_t0),u);case A.FaceB:u=D.Rot.mulRV(o.q,this.axis,B),h=D.Transform.mulXV(o,this.localPoint,m),n=D.Rot.mulTRV(s.q,D.Vec2.NegV(u,D.Vec2.s_t0),p);e[0]=-1,t[0]=this.proxyA.getSupport(n);a=this.proxyA.getVertex(t[0]),l=D.Transform.mulXV(s,a,g);return D.Vec2.DotVV(D.Vec2.SubVV(l,h,D.Vec2.s_t0),u);default:return t[0]=-1,e[0]=-1,0}},n.prototype.evaluate=function(t,e,i){var s=R,o=k;switch(this.sweepA.getTransform(s,i),this.sweepB.getTransform(o,i),this.type){case A.Points:var n=this.proxyA.getVertex(t),r=this.proxyB.getVertex(e),a=D.Transform.mulXV(s,n,g),c=D.Transform.mulXV(o,r,m);return D.Vec2.DotVV(D.Vec2.SubVV(c,a,D.Vec2.s_t0),this.axis);case A.FaceA:var l=D.Rot.mulRV(s.q,this.axis,B),a=D.Transform.mulXV(s,this.localPoint,g),r=this.proxyB.getVertex(e),c=D.Transform.mulXV(o,r,m);return D.Vec2.DotVV(D.Vec2.SubVV(c,a,D.Vec2.s_t0),l);case A.FaceB:l=D.Rot.mulRV(o.q,this.axis,B),c=D.Transform.mulXV(o,this.localPoint,m),n=this.proxyA.getVertex(t),a=D.Transform.mulXV(s,n,g);return D.Vec2.DotVV(D.Vec2.SubVV(a,c,D.Vec2.s_t0),l);default:return 0}},n);function n(){this.sweepA=new D.Sweep,this.sweepB=new D.Sweep,this.type=A.Unknown,this.localPoint=new D.Vec2,this.axis=new D.Vec2}D.SeparationFunction=o;var q=new D.Timer,J=new D.SimplexCache,E=new D.DistanceInput,z=new D.DistanceOutput,j=new o,O=[0],G=[0],N=new D.Sweep,X=new D.Sweep;D.timeOfImpact=function(t,e){var i=q.reset();++D.toiCalls,t.state=L.Unknown,t.t=e.tMax;var s=e.proxyA,o=e.proxyB,n=D.Max(D.maxPolygonVertices,D.Max(s.count,o.count)),r=N.copy(e.sweepA),a=X.copy(e.sweepB);r.normalize(),a.normalize();var c=e.tMax,l=s.radius+o.radius,h=D.Max(D.linearSlop,l-3*D.linearSlop),u=.25*D.linearSlop,p=0,d=0,f=J;f.count=0;var y=E;for(y.proxyA.copy(e.proxyA),y.proxyB.copy(e.proxyB),y.useRadii=!1;;){var V=R,v=k;r.getTransform(V,p),a.getTransform(v,p),y.transformA.copy(V),y.transformB.copy(v);var x=z;if(D.distance(x,f,y),x.distance<=0){t.state=L.Overlapped,t.t=0;break}if(x.distance<h+u){t.state=L.Touching,t.t=p;break}var g=j;g.initialize(f,s,r,o,a,p);for(var m=!1,B=c,A=0;;){var w=O,b=G,C=g.findMinSeparation(w,b,B);if(h+u<C){t.state=L.Separated,t.t=c,m=!0;break}if(h-u<C){p=B;break}var _=g.evaluate(w[0],b[0],p);if(_<h-u){t.state=L.Failed,t.t=p,m=!0;break}if(_<=h+u){t.state=L.Touching,t.t=p,m=!0;break}for(var S=0,M=p,P=B;;){var I=0,I=1&S?M+(h-_)*(P-M)/(C-_):.5*(M+P);++S,++D.toiRootIters;var T=g.evaluate(w[0],b[0],I);if(D.Abs(T-h)<u){B=I;break}if(h<T?(M=I,_=T):(P=I,C=T),50===S)break}if(D.toiMaxRootIters=D.Max(D.toiMaxRootIters,S),++A===n)break}if(++d,++D.toiIters,m)break;if(20===d){t.state=L.Failed,t.t=p;break}}D.toiMaxIters=D.Max(D.toiMaxIters,d);var F=i.getMilliseconds();D.toiMaxTime=D.Max(D.toiMaxTime,F),D.toiTime+=F}}(b2=b2||{}),function(t){var i=(s.prototype.clone=function(){return(new s).copy(this)},s.prototype.copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},s.prototype.isEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},s.prototype.isZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},s.prototype.set=function(t,e,i,s){void 0===s&&(s=this.a),this.setRGBA(t,e,i,s)},s.prototype.setByteRGB=function(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this},s.prototype.setByteRGBA=function(t,e,i,s){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=s/255,this},s.prototype.setRGB=function(t,e,i){return this.r=t,this.g=e,this.b=i,this},s.prototype.setRGBA=function(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=s,this},s.prototype.selfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},s.prototype.add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},s.prototype.selfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},s.prototype.sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},s.prototype.selfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},s.prototype.mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},s.prototype.mix=function(t,e){s.mixColors(this,t,e)},s.mixColors=function(t,e,i){var s=i*(e.r-t.r),o=i*(e.g-t.g),n=i*(e.b-t.b),r=i*(e.a-t.a);t.r+=s,t.g+=o,t.b+=n,t.a+=r,e.r-=s,e.g-=o,e.b-=n,e.a-=r},s.prototype.makeStyleString=function(t){return void 0===t&&(t=this.a),s.makeStyleString(this.r,this.g,this.b,t)},s.makeStyleString=function(t,e,i,s){return void 0===s&&(s=1),t*=255,e*=255,i*=255,s<1?"rgba("+t+","+e+","+i+","+s+")":"rgb("+t+","+e+","+i+")"},s.ZERO=new s(0,0,0,0),s.RED=new s(1,0,0),s.GREEN=new s(0,1,0),s.BLUE=new s(0,0,1),s);function s(t,e,i,s){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===i&&(i=.5),void 0===s&&(s=1),this.r=t,this.g=e,this.b=i,this.a=s}t.Color=i;var e,o=(Object.defineProperty(n.prototype,"r",{get:function(){return this.data[0]},set:function(t){this.data[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"g",{get:function(){return this.data[1]},set:function(t){this.data[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"b",{get:function(){return this.data[2]},set:function(t){this.data[2]=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"a",{get:function(){return this.data[3]},set:function(t){this.data[3]=t},enumerable:!0,configurable:!0}),n.prototype.clone=function(){return new n(new Float32Array(this.data))},n.prototype.copy=function(t){return t instanceof n?this.data.set(t.data):(this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a),this},n.prototype.isEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},n.prototype.isZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},n.prototype.set=function(t,e,i,s){void 0===s&&(s=this.a),this.setRGBA(t,e,i,s)},n.prototype.setByteRGB=function(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this},n.prototype.setByteRGBA=function(t,e,i,s){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=s/255,this},n.prototype.setRGB=function(t,e,i){return this.r=t,this.g=e,this.b=i,this},n.prototype.setRGBA=function(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=s,this},n.prototype.selfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},n.prototype.add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},n.prototype.selfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},n.prototype.sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},n.prototype.selfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},n.prototype.mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},n.prototype.mix=function(t,e){i.mixColors(this,t,e)},n.prototype.makeStyleString=function(t){return void 0===t&&(t=this.a),i.makeStyleString(this.r,this.g,this.b,t)},n);function n(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t[0]instanceof Float32Array){if(4!==t[0].length)throw new Error;this.data=t[0]}else{var i="number"==typeof t[0]?t[0]:.5,s="number"==typeof t[1]?t[1]:.5,o="number"==typeof t[2]?t[2]:.5,n="number"==typeof t[3]?t[3]:1;this.data=new Float32Array([i,s,o,n])}}t.TypedColor=o,(e=t.DrawFlags||(t.DrawFlags={}))[e.None=0]="None",e[e.ShapeBit=1]="ShapeBit",e[e.JointBit=2]="JointBit",e[e.AABBBit=4]="AABBBit",e[e.PairBit=8]="PairBit",e[e.CenterOfMassBit=16]="CenterOfMassBit",e[e.ParticleBit=32]="ParticleBit",e[e.ControllerBit=64]="ControllerBit",e[e.All=63]="All";var r=(a.prototype.setFlags=function(t){this.drawFlags=t},a.prototype.getFlags=function(){return this.drawFlags},a.prototype.appendFlags=function(t){this.drawFlags|=t},a.prototype.clearFlags=function(t){this.drawFlags&=~t},a.prototype.pushTransform=function(t){},a.prototype.popTransform=function(t){},a.prototype.drawPolygon=function(t,e,i){},a.prototype.drawSolidPolygon=function(t,e,i){},a.prototype.drawCircle=function(t,e,i){},a.prototype.drawSolidCircle=function(t,e,i,s){},a.prototype.drawParticles=function(t,e,i,s){},a.prototype.drawSegment=function(t,e,i){},a.prototype.drawTransform=function(t){},a.prototype.drawPoint=function(t,e,i){},a);function a(){this.drawFlags=0}t.Draw=r}(b2=b2||{}),function(e){var t=(i.prototype.reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},i);function i(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}e.Profile=t;var s=(o.prototype.copy=function(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this},o);function o(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}e.TimeStep=s;var n=(r.makeArray=function(t){return e.MakeArray(t,function(t){return new r})},r);function r(){this.c=new e.Vec2,this.a=0}e.Position=n;var a=(c.makeArray=function(t){return e.MakeArray(t,function(t){return new c})},c);function c(){this.v=new e.Vec2,this.w=0}e.Velocity=a;function l(){this.step=new s}e.SolverData=l}(b2=b2||{}),function(x){var e,t=(e=x.Shape,__extends(g,e),g.prototype.setOneSided=function(t,e,i,s){return this.vertex0.copy(t),this.vertex1.copy(e),this.vertex2.copy(i),this.vertex3.copy(s),this.oneSided=!0,this},g.prototype.setTwoSided=function(t,e){return this.vertex1.copy(t),this.vertex2.copy(e),this.oneSided=!1,this},g.prototype.clone=function(){return(new g).copy(this)},g.prototype.copy=function(t){return e.prototype.copy.call(this,t),this.vertex1.copy(t.vertex1),this.vertex2.copy(t.vertex2),this.vertex0.copy(t.vertex0),this.vertex3.copy(t.vertex3),this.oneSided=t.oneSided,this},g.prototype.getChildCount=function(){return 1},g.prototype.testPoint=function(t,e){return!1},g.prototype.computeDistance=function(t,e,i,s){var o,n=x.Transform.mulXV(t,this.vertex1,g.ComputeDistance_s_v1),r=x.Transform.mulXV(t,this.vertex2,g.ComputeDistance_s_v2),a=x.Vec2.SubVV(e,n,g.ComputeDistance_s_d),c=x.Vec2.SubVV(r,n,g.ComputeDistance_s_s),l=x.Vec2.DotVV(a,c);return 0<l&&((o=x.Vec2.DotVV(c,c))<l?x.Vec2.SubVV(e,r,a):a.selfMulSub(l/o,c)),i.copy(a),i.normalize()},g.prototype.rayCast=function(t,e,i,s){var o=x.Transform.mulTXV(i,e.p1,g.rayCast_s_p1),n=x.Transform.mulTXV(i,e.p2,g.rayCast_s_p2),r=x.Vec2.SubVV(n,o,g.rayCast_s_d),a=this.vertex1,c=this.vertex2,l=x.Vec2.SubVV(c,a,g.rayCast_s_e),h=t.normal.set(l.y,-l.x).selfNormalize(),u=x.Vec2.DotVV(h,x.Vec2.SubVV(a,o,x.Vec2.s_t0));if(this.oneSided&&0<u)return!1;var p=x.Vec2.DotVV(h,r);if(0===p)return!1;var d=u/p;if(d<0||e.maxFraction<d)return!1;var f=x.Vec2.AddVMulSV(o,d,r,g.rayCast_s_q),y=x.Vec2.SubVV(c,a,g.rayCast_s_r),V=x.Vec2.DotVV(y,y);if(0===V)return!1;var v=x.Vec2.DotVV(x.Vec2.SubVV(f,a,x.Vec2.s_t0),y)/V;return!(v<0||1<v)&&(t.fraction=d,x.Rot.mulRV(i.q,t.normal,t.normal),0<u&&t.normal.selfNeg(),!0)},g.prototype.computeAABB=function(t,e,i){var s=x.Transform.mulXV(e,this.vertex1,g.computeAABB_s_v1),o=x.Transform.mulXV(e,this.vertex2,g.computeAABB_s_v2);x.Vec2.MinV(s,o,t.lowerBound),x.Vec2.MaxV(s,o,t.upperBound);var n=this.radius;t.lowerBound.selfSubXY(n,n),t.upperBound.selfAddXY(n,n)},g.prototype.computeMass=function(t,e){t.mass=0,x.Vec2.MidVV(this.vertex1,this.vertex2,t.center),t.I=0},g.prototype.setupDistanceProxy=function(t,e){t.vertices=t.buffer,t.vertices[0].copy(this.vertex1),t.vertices[1].copy(this.vertex2),t.count=2,t.radius=this.radius},g.prototype.computeSubmergedArea=function(t,e,i,s){return s.setZero(),0},g.prototype.dump=function(t){t("    const shape: EdgeShape = new EdgeShape();\n"),t("    shape.radius = %.15f;\n",this.radius),t("    shape.vertex0.Set(%.15f, %.15f);\n",this.vertex0.x,this.vertex0.y),t("    shape.vertex1.Set(%.15f, %.15f);\n",this.vertex1.x,this.vertex1.y),t("    shape.vertex2.Set(%.15f, %.15f);\n",this.vertex2.x,this.vertex2.y),t("    shape.vertex3.Set(%.15f, %.15f);\n",this.vertex3.x,this.vertex3.y),t("    shape.oneSided = %s;\n",this.oneSided)},g.ComputeDistance_s_v1=new x.Vec2,g.ComputeDistance_s_v2=new x.Vec2,g.ComputeDistance_s_d=new x.Vec2,g.ComputeDistance_s_s=new x.Vec2,g.rayCast_s_p1=new x.Vec2,g.rayCast_s_p2=new x.Vec2,g.rayCast_s_d=new x.Vec2,g.rayCast_s_e=new x.Vec2,g.rayCast_s_q=new x.Vec2,g.rayCast_s_r=new x.Vec2,g.computeAABB_s_v1=new x.Vec2,g.computeAABB_s_v2=new x.Vec2,g);function g(){var t=e.call(this,x.ShapeType.EdgeShape,x.polygonRadius)||this;return t.vertex0=new x.Vec2,t.vertex1=new x.Vec2,t.vertex2=new x.Vec2,t.vertex3=new x.Vec2,t.oneSided=!1,t}x.EdgeShape=t}(b2=b2||{}),function(t){var i=function(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e};t.ControllerEdge=i;var e=(s.prototype.draw=function(t){},s.prototype.addBody=function(t){var e=new i(this,t);e.nextBody=this.bodyList,e.prevBody=null,this.bodyList&&(this.bodyList.prevBody=e),this.bodyList=e,++this.bodyCount,e.nextController=t.controllerList,e.prevController=null,t.controllerList&&(t.controllerList.prevController=e),t.controllerList=e,++t.controllerCount},s.prototype.removeBody=function(t){if(this.bodyCount<=0)throw new Error;for(var e=this.bodyList;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.bodyList===e&&(this.bodyList=e.nextBody),--this.bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.controllerList===e&&(t.controllerList=e.nextController),--t.controllerCount},s.prototype.clear=function(){for(;this.bodyList;)this.removeBody(this.bodyList.body);this.bodyCount=0},s);function s(){this.bodyList=null,this.bodyCount=0,this.prev=null,this.next=null}t.Controller=e}(b2=b2||{}),function(x){function o(t,e){return x.Sqrt(t*e)}function n(t,e){return e<t?t:e}function r(t,e){return t<e?t:e}x.mixFriction=o,x.mixRestitution=n,x.mixRestitutionThreshold=r;var t=(Object.defineProperty(e.prototype,"other",{get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this._other=null,this.prev=null,this.next=null},e);function e(t){this._other=null,this.prev=null,this.next=null,this.contact=t}x.ContactEdge=t;var i=(a.prototype.getManifold=function(){return this.manifold},a.prototype.getWorldManifold=function(t){var e=this.fixtureA.getBody(),i=this.fixtureB.getBody(),s=this.getShapeA(),o=this.getShapeB();t.initialize(this.manifold,e.getTransform(),s.radius,i.getTransform(),o.radius)},a.prototype.isTouching=function(){return this.touchingFlag},a.prototype.setEnabled=function(t){this.enabledFlag=t},a.prototype.isEnabled=function(){return this.enabledFlag},a.prototype.getNext=function(){return this.next},a.prototype.getFixtureA=function(){return this.fixtureA},a.prototype.getChildIndexA=function(){return this.indexA},a.prototype.getShapeA=function(){return this.fixtureA.getShape()},a.prototype.getFixtureB=function(){return this.fixtureB},a.prototype.getChildIndexB=function(){return this.indexB},a.prototype.getShapeB=function(){return this.fixtureB.getShape()},a.prototype.glagForFiltering=function(){this.filterFlag=!0},a.prototype.setFriction=function(t){this.friction=t},a.prototype.getFriction=function(){return this.friction},a.prototype.resetFriction=function(){this.friction=o(this.fixtureA.friction,this.fixtureB.friction)},a.prototype.setRestitution=function(t){this.restitution=t},a.prototype.getRestitution=function(){return this.restitution},a.prototype.resetRestitution=function(){this.restitution=n(this.fixtureA.restitution,this.fixtureB.restitution)},a.prototype.setRestitutionThreshold=function(t){this.restitutionThreshold=t},a.prototype.getRestitutionThreshold=function(){return this.restitutionThreshold},a.prototype.resetRestitutionThreshold=function(){this.restitutionThreshold=r(this.fixtureA.restitutionThreshold,this.fixtureB.restitutionThreshold)},a.prototype.setTangentSpeed=function(t){this.tangentSpeed=t},a.prototype.getTangentSpeed=function(){return this.tangentSpeed},a.prototype.reset=function(t,e,i,s){this.islandFlag=!1,this.touchingFlag=!1,this.enabledFlag=!0,this.filterFlag=!1,this.bulletHitFlag=!1,this.toiFlag=!1,this.fixtureA=t,this.fixtureB=i,this.indexA=e,this.indexB=s,this.manifold.pointCount=0,this.prev=null,this.next=null,this.nodeA.reset(),this.nodeB.reset(),this.toiCount=0,this.friction=o(this.fixtureA.friction,this.fixtureB.friction),this.restitution=n(this.fixtureA.restitution,this.fixtureB.restitution),this.restitutionThreshold=r(this.fixtureA.restitutionThreshold,this.fixtureB.restitutionThreshold)},a.prototype.update=function(t){var e=this.oldManifold;this.oldManifold=this.manifold,this.manifold=e;var i=!(this.enabledFlag=!0),s=this.touchingFlag,o=this.fixtureA.isSensor,n=this.fixtureB.isSensor,r=o||n,a=this.fixtureA.getBody(),c=this.fixtureB.getBody(),l=a.getTransform(),h=c.getTransform();if(r){var u=this.getShapeA(),p=this.getShapeB(),i=x.testOverlapShape(u,this.indexA,p,this.indexB,l,h);this.manifold.pointCount=0}else{this.evaluate(this.manifold,l,h),i=0<this.manifold.pointCount;for(var d=0;d<this.manifold.pointCount;++d){var f=this.manifold.points[d];f.normalImpulse=0,f.tangentImpulse=0;for(var y=f.id,V=0;V<this.oldManifold.pointCount;++V){var v=this.oldManifold.points[V];if(v.id.key===y.key){f.normalImpulse=v.normalImpulse,f.tangentImpulse=v.tangentImpulse;break}}}i!==s&&(a.setAwake(!0),c.setAwake(!0))}this.touchingFlag=i,!s&&i&&t&&t.beginContact(this),s&&!i&&t&&t.endContact(this),!r&&i&&t&&t.preSolve(this,this.oldManifold)},a.prototype.computeTOI=function(t,e){var i=a.computeTOI_s_input;i.proxyA.setShape(this.getShapeA(),this.indexA),i.proxyB.setShape(this.getShapeB(),this.indexB),i.sweepA.copy(t),i.sweepB.copy(e),i.tMax=x.linearSlop;var s=a.computeTOI_s_output;return x.timeOfImpact(s,i),s.t},a.computeTOI_s_input=new x.TOIInput,a.computeTOI_s_output=new x.TOIOutput,a);function a(){this.islandFlag=!1,this.touchingFlag=!1,this.enabledFlag=!1,this.filterFlag=!1,this.bulletHitFlag=!1,this.toiFlag=!1,this.prev=null,this.next=null,this.nodeA=new t(this),this.nodeB=new t(this),this.indexA=0,this.indexB=0,this.manifold=new x.Manifold,this.toiCount=0,this.toi=0,this.friction=0,this.restitution=0,this.restitutionThreshold=0,this.tangentSpeed=0,this.oldManifold=new x.Manifold}x.Contact=i}(b2=b2||{}),function(X){X.gBlockSolve=!1;var t=(e.makeArray=function(t){return X.MakeArray(t,function(t){return new e})},e);function e(){this.rA=new X.Vec2,this.rB=new X.Vec2,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}X.VelocityConstraintPoint=t;var g=(i.makeArray=function(t){return X.MakeArray(t,function(t){return new i})},i);function i(){this.points=t.makeArray(X.maxManifoldPoints),this.normal=new X.Vec2,this.tangent=new X.Vec2,this.normalMass=new X.Mat22,this.K=new X.Mat22,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.threshold=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}X.ContactVelocityConstraint=g;var m=(s.makeArray=function(t){return X.MakeArray(t,function(t){return new s})},s);function s(){this.localPoints=X.Vec2.MakeArray(X.maxManifoldPoints),this.localNormal=new X.Vec2,this.localPoint=new X.Vec2,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new X.Vec2,this.localCenterB=new X.Vec2,this.invIA=0,this.invIB=0,this.type=X.ManifoldType.Unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}X.ContactPositionConstraint=m;function o(){this.step=new X.TimeStep,this.count=0}X.ContactSolverDef=o;var n=(c.prototype.initialize=function(t,e,i,s){var o=c.Initialize_s_pointA,n=c.Initialize_s_pointB,r=c.Initialize_s_planePoint,a=c.Initialize_s_clipPoint;switch(t.type){case X.ManifoldType.Circles:X.Transform.mulXV(e,t.localPoint,o),X.Transform.mulXV(i,t.localPoints[0],n),X.Vec2.SubVV(n,o,this.normal).selfNormalize(),X.Vec2.MidVV(o,n,this.point),this.separation=X.Vec2.DotVV(X.Vec2.SubVV(n,o,X.Vec2.s_t0),this.normal)-t.radiusA-t.radiusB;break;case X.ManifoldType.FaceA:X.Rot.mulRV(e.q,t.localNormal,this.normal),X.Transform.mulXV(e,t.localPoint,r),X.Transform.mulXV(i,t.localPoints[s],a),this.separation=X.Vec2.DotVV(X.Vec2.SubVV(a,r,X.Vec2.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.copy(a);break;case X.ManifoldType.FaceB:X.Rot.mulRV(i.q,t.localNormal,this.normal),X.Transform.mulXV(i,t.localPoint,r),X.Transform.mulXV(e,t.localPoints[s],a),this.separation=X.Vec2.DotVV(X.Vec2.SubVV(a,r,X.Vec2.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.copy(a),this.normal.selfNeg()}},c.Initialize_s_pointA=new X.Vec2,c.Initialize_s_pointB=new X.Vec2,c.Initialize_s_planePoint=new X.Vec2,c.Initialize_s_clipPoint=new X.Vec2,c);function c(){this.normal=new X.Vec2,this.point=new X.Vec2,this.separation=0}X.PositionSolverManifold=n;var r=(Z.prototype.initialize=function(t){if(this.step.copy(t.step),this.count=t.count,this.positionConstraints.length<this.count)for(var e=X.Max(2*this.positionConstraints.length,this.count);this.positionConstraints.length<e;)this.positionConstraints[this.positionConstraints.length]=new m;if(this.velocityConstraints.length<this.count)for(e=X.Max(2*this.velocityConstraints.length,this.count);this.velocityConstraints.length<e;)this.velocityConstraints[this.velocityConstraints.length]=new g;this.positions=t.positions,this.velocities=t.velocities,this.contacts=t.contacts;for(var i=0;i<this.count;++i){var s=this.contacts[i],o=s.fixtureA,n=s.fixtureB,r=o.getShape(),a=n.getShape(),c=r.radius,l=a.radius,h=o.getBody(),u=n.getBody(),p=s.getManifold(),d=p.pointCount,f=this.velocityConstraints[i];f.friction=s.friction,f.restitution=s.restitution,f.threshold=s.restitutionThreshold,f.tangentSpeed=s.tangentSpeed,f.indexA=h.islandIndex,f.indexB=u.islandIndex,f.invMassA=h.invMass,f.invMassB=u.invMass,f.invIA=h.invI,f.invIB=u.invI,f.contactIndex=i,f.pointCount=d,f.K.setZero(),f.normalMass.setZero();var y=this.positionConstraints[i];y.indexA=h.islandIndex,y.indexB=u.islandIndex,y.invMassA=h.invMass,y.invMassB=u.invMass,y.localCenterA.copy(h.sweep.localCenter),y.localCenterB.copy(u.sweep.localCenter),y.invIA=h.invI,y.invIB=u.invI,y.localNormal.copy(p.localNormal),y.localPoint.copy(p.localPoint),y.pointCount=d,y.radiusA=c,y.radiusB=l,y.type=p.type;for(var V=0;V<d;++V){var v=p.points[V],x=f.points[V];this.step.warmStarting?(x.normalImpulse=this.step.dtRatio*v.normalImpulse,x.tangentImpulse=this.step.dtRatio*v.tangentImpulse):(x.normalImpulse=0,x.tangentImpulse=0),x.rA.setZero(),x.rB.setZero(),x.normalMass=0,x.tangentMass=0,x.velocityBias=0,y.localPoints[V].copy(v.localPoint)}}return this},Z.prototype.initializeVelocityConstraints=function(){for(var t=Z.initializeVelocityConstraints_s_xfA,e=Z.initializeVelocityConstraints_s_xfB,i=Z.initializeVelocityConstraints_s_worldManifold,s=0;s<this.count;++s){var o=this.velocityConstraints[s],n=this.positionConstraints[s],r=n.radiusA,a=n.radiusB,c=this.contacts[o.contactIndex].getManifold(),l=o.indexA,h=o.indexB,u=o.invMassA,p=o.invMassB,d=o.invIA,f=o.invIB,y=n.localCenterA,V=n.localCenterB,v=this.positions[l].c,x=this.positions[l].a,g=this.velocities[l].v,m=this.velocities[l].w,B=this.positions[h].c,A=this.positions[h].a,w=this.velocities[h].v,b=this.velocities[h].w;t.q.setAngle(x),e.q.setAngle(A),X.Vec2.SubVV(v,X.Rot.mulRV(t.q,y,X.Vec2.s_t0),t.p),X.Vec2.SubVV(B,X.Rot.mulRV(e.q,V,X.Vec2.s_t0),e.p),i.initialize(c,t,r,e,a),o.normal.copy(i.normal),X.Vec2.CrossVOne(o.normal,o.tangent);for(var C,_,S,M,P,I,T,F,D,L=o.pointCount,R=0;R<L;++R){var k=o.points[R];X.Vec2.SubVV(i.points[R],v,k.rA),X.Vec2.SubVV(i.points[R],B,k.rB);var q=X.Vec2.CrossVV(k.rA,o.normal),J=X.Vec2.CrossVV(k.rB,o.normal),E=u+p+d*q*q+f*J*J;k.normalMass=0<E?1/E:0;var z=o.tangent,j=X.Vec2.CrossVV(k.rA,z),O=X.Vec2.CrossVV(k.rB,z),G=u+p+d*j*j+f*O*O;k.tangentMass=0<G?1/G:0,k.velocityBias=0;var N=X.Vec2.DotVV(o.normal,X.Vec2.SubVV(X.Vec2.AddVCrossSV(w,b,k.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(g,m,k.rA,X.Vec2.s_t1),X.Vec2.s_t0));N<-o.threshold&&(k.velocityBias+=-o.restitution*N)}2===o.pointCount&&X.gBlockSolve&&(C=o.points[0],_=o.points[1],(T=u+p+d*(S=X.Vec2.CrossVV(C.rA,o.normal))*S+f*(M=X.Vec2.CrossVV(C.rB,o.normal))*M)*T<1e3*(T*(F=u+p+d*(P=X.Vec2.CrossVV(_.rA,o.normal))*P+f*(I=X.Vec2.CrossVV(_.rB,o.normal))*I)-(D=u+p+d*S*P+f*M*I)*D)?(o.K.ex.set(T,D),o.K.ey.set(D,F),o.K.getInverse(o.normalMass)):o.pointCount=1)}},Z.prototype.warmStart=function(){for(var t=Z.warmStart_s_P,e=0;e<this.count;++e){for(var i=this.velocityConstraints[e],s=i.indexA,o=i.indexB,n=i.invMassA,r=i.invIA,a=i.invMassB,c=i.invIB,l=i.pointCount,h=this.velocities[s].v,u=this.velocities[s].w,p=this.velocities[o].v,d=this.velocities[o].w,f=i.normal,y=i.tangent,V=0;V<l;++V){var v=i.points[V];X.Vec2.AddVV(X.Vec2.MulSV(v.normalImpulse,f,X.Vec2.s_t0),X.Vec2.MulSV(v.tangentImpulse,y,X.Vec2.s_t1),t),u-=r*X.Vec2.CrossVV(v.rA,t),h.selfMulSub(n,t),d+=c*X.Vec2.CrossVV(v.rB,t),p.selfMulAdd(a,t)}this.velocities[s].w=u,this.velocities[o].w=d}},Z.prototype.solveVelocityConstraints=function(){for(var t=Z.solveVelocityConstraints_s_dv,e=Z.solveVelocityConstraints_s_dv1,i=Z.solveVelocityConstraints_s_dv2,s=Z.solveVelocityConstraints_s_P,o=Z.solveVelocityConstraints_s_a,n=Z.solveVelocityConstraints_s_b,r=Z.solveVelocityConstraints_s_x,a=Z.solveVelocityConstraints_s_d,c=Z.solveVelocityConstraints_s_P1,l=Z.solveVelocityConstraints_s_P2,h=Z.solveVelocityConstraints_s_P1P2,u=0;u<this.count;++u){for(var p=this.velocityConstraints[u],d=p.indexA,f=p.indexB,y=p.invMassA,V=p.invIA,v=p.invMassB,x=p.invIB,g=p.pointCount,m=this.velocities[d].v,B=this.velocities[d].w,A=this.velocities[f].v,w=this.velocities[f].w,b=p.normal,C=p.tangent,_=p.friction,S=0;S<g;++S){var M=p.points[S];X.Vec2.SubVV(X.Vec2.AddVCrossSV(A,w,M.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(m,B,M.rA,X.Vec2.s_t1),t);var P=X.Vec2.DotVV(t,C)-p.tangentSpeed,I=M.tangentMass*-P,T=_*M.normalImpulse;I=(F=X.clamp(M.tangentImpulse+I,-T,T))-M.tangentImpulse,M.tangentImpulse=F,X.Vec2.MulSV(I,C,s),m.selfMulSub(y,s),B-=V*X.Vec2.CrossVV(M.rA,s),A.selfMulAdd(v,s),w+=x*X.Vec2.CrossVV(M.rB,s)}if(1===p.pointCount||!1===X.gBlockSolve)for(S=0;S<g;++S){M=p.points[S];X.Vec2.SubVV(X.Vec2.AddVCrossSV(A,w,M.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(m,B,M.rA,X.Vec2.s_t1),t);var F,D=X.Vec2.DotVV(t,b),I=-M.normalMass*(D-M.velocityBias);I=(F=X.Max(M.normalImpulse+I,0))-M.normalImpulse,M.normalImpulse=F,X.Vec2.MulSV(I,b,s),m.selfMulSub(y,s),B-=V*X.Vec2.CrossVV(M.rA,s),A.selfMulAdd(v,s),w+=x*X.Vec2.CrossVV(M.rB,s)}else{var L=p.points[0],R=p.points[1];o.set(L.normalImpulse,R.normalImpulse),X.Vec2.SubVV(X.Vec2.AddVCrossSV(A,w,L.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(m,B,L.rA,X.Vec2.s_t1),e),X.Vec2.SubVV(X.Vec2.AddVCrossSV(A,w,R.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(m,B,R.rA,X.Vec2.s_t1),i);var k=X.Vec2.DotVV(e,b),q=X.Vec2.DotVV(i,b);for(n.x=k-L.velocityBias,n.y=q-R.velocityBias,n.selfSub(X.Mat22.mulMV(p.K,o,X.Vec2.s_t0));;){if(X.Mat22.mulMV(p.normalMass,n,r).selfNeg(),0<=r.x&&0<=r.y){X.Vec2.SubVV(r,o,a),X.Vec2.MulSV(a.x,b,c),X.Vec2.MulSV(a.y,b,l),X.Vec2.AddVV(c,l,h),m.selfMulSub(y,h),B-=V*(X.Vec2.CrossVV(L.rA,c)+X.Vec2.CrossVV(R.rA,l)),A.selfMulAdd(v,h),w+=x*(X.Vec2.CrossVV(L.rB,c)+X.Vec2.CrossVV(R.rB,l)),L.normalImpulse=r.x,R.normalImpulse=r.y;break}if(r.x=-L.normalMass*n.x,k=r.y=0,q=p.K.ex.y*r.x+n.y,0<=r.x&&0<=q){X.Vec2.SubVV(r,o,a),X.Vec2.MulSV(a.x,b,c),X.Vec2.MulSV(a.y,b,l),X.Vec2.AddVV(c,l,h),m.selfMulSub(y,h),B-=V*(X.Vec2.CrossVV(L.rA,c)+X.Vec2.CrossVV(R.rA,l)),A.selfMulAdd(v,h),w+=x*(X.Vec2.CrossVV(L.rB,c)+X.Vec2.CrossVV(R.rB,l)),L.normalImpulse=r.x,R.normalImpulse=r.y;break}if(r.x=0,r.y=-R.normalMass*n.y,k=p.K.ey.x*r.y+n.x,(q=0)<=r.y&&0<=k){X.Vec2.SubVV(r,o,a),X.Vec2.MulSV(a.x,b,c),X.Vec2.MulSV(a.y,b,l),X.Vec2.AddVV(c,l,h),m.selfMulSub(y,h),B-=V*(X.Vec2.CrossVV(L.rA,c)+X.Vec2.CrossVV(R.rA,l)),A.selfMulAdd(v,h),w+=x*(X.Vec2.CrossVV(L.rB,c)+X.Vec2.CrossVV(R.rB,l)),L.normalImpulse=r.x,R.normalImpulse=r.y;break}if(r.x=0,r.y=0,k=n.x,q=n.y,0<=k&&0<=q){X.Vec2.SubVV(r,o,a),X.Vec2.MulSV(a.x,b,c),X.Vec2.MulSV(a.y,b,l),X.Vec2.AddVV(c,l,h),m.selfMulSub(y,h),B-=V*(X.Vec2.CrossVV(L.rA,c)+X.Vec2.CrossVV(R.rA,l)),A.selfMulAdd(v,h),w+=x*(X.Vec2.CrossVV(L.rB,c)+X.Vec2.CrossVV(R.rB,l)),L.normalImpulse=r.x,R.normalImpulse=r.y;break}break}}this.velocities[d].w=B,this.velocities[f].w=w}},Z.prototype.storeImpulses=function(){for(var t=0;t<this.count;++t)for(var e=this.velocityConstraints[t],i=this.contacts[e.contactIndex].getManifold(),s=0;s<e.pointCount;++s)i.points[s].normalImpulse=e.points[s].normalImpulse,i.points[s].tangentImpulse=e.points[s].tangentImpulse},Z.prototype.solvePositionConstraints=function(){for(var t=Z.solvePositionConstraints_s_xfA,e=Z.solvePositionConstraints_s_xfB,i=Z.solvePositionConstraints_s_psm,s=Z.solvePositionConstraints_s_rA,o=Z.solvePositionConstraints_s_rB,n=Z.solvePositionConstraints_s_P,r=0,a=0;a<this.count;++a){for(var c=this.positionConstraints[a],l=c.indexA,h=c.indexB,u=c.localCenterA,p=c.invMassA,d=c.invIA,f=c.localCenterB,y=c.invMassB,V=c.invIB,v=c.pointCount,x=this.positions[l].c,g=this.positions[l].a,m=this.positions[h].c,B=this.positions[h].a,A=0;A<v;++A){t.q.setAngle(g),e.q.setAngle(B),X.Vec2.SubVV(x,X.Rot.mulRV(t.q,u,X.Vec2.s_t0),t.p),X.Vec2.SubVV(m,X.Rot.mulRV(e.q,f,X.Vec2.s_t0),e.p),i.initialize(c,t,e,A);var w=i.normal,b=i.point,C=i.separation;X.Vec2.SubVV(b,x,s),X.Vec2.SubVV(b,m,o),r=X.Min(r,C);var _=X.clamp(X.baumgarte*(C+X.linearSlop),-X.maxLinearCorrection,0),S=X.Vec2.CrossVV(s,w),M=X.Vec2.CrossVV(o,w),P=p+y+d*S*S+V*M*M,I=0<P?-_/P:0;X.Vec2.MulSV(I,w,n),x.selfMulSub(p,n),g-=d*X.Vec2.CrossVV(s,n),m.selfMulAdd(y,n),B+=V*X.Vec2.CrossVV(o,n)}this.positions[l].a=g,this.positions[h].a=B}return r>-3*X.linearSlop},Z.prototype.solveTOIPositionConstraints=function(t,e){for(var i=Z.solveTOIPositionConstraints_s_xfA,s=Z.solveTOIPositionConstraints_s_xfB,o=Z.solveTOIPositionConstraints_s_psm,n=Z.solveTOIPositionConstraints_s_rA,r=Z.solveTOIPositionConstraints_s_rB,a=Z.solveTOIPositionConstraints_s_P,c=0,l=0;l<this.count;++l){var h=this.positionConstraints[l],u=h.indexA,p=h.indexB,d=h.localCenterA,f=h.localCenterB,y=h.pointCount,V=0,v=0;u!==t&&u!==e||(V=h.invMassA,v=h.invIA);var x=0,g=0;p!==t&&p!==e||(x=h.invMassB,g=h.invIB);for(var m=this.positions[u].c,B=this.positions[u].a,A=this.positions[p].c,w=this.positions[p].a,b=0;b<y;++b){i.q.setAngle(B),s.q.setAngle(w),X.Vec2.SubVV(m,X.Rot.mulRV(i.q,d,X.Vec2.s_t0),i.p),X.Vec2.SubVV(A,X.Rot.mulRV(s.q,f,X.Vec2.s_t0),s.p),o.initialize(h,i,s,b);var C=o.normal,_=o.point,S=o.separation;X.Vec2.SubVV(_,m,n),X.Vec2.SubVV(_,A,r),c=X.Min(c,S);var M=X.clamp(X.toiBaumgarte*(S+X.linearSlop),-X.maxLinearCorrection,0),P=X.Vec2.CrossVV(n,C),I=X.Vec2.CrossVV(r,C),T=V+x+v*P*P+g*I*I,F=0<T?-M/T:0;X.Vec2.MulSV(F,C,a),m.selfMulSub(V,a),B-=v*X.Vec2.CrossVV(n,a),A.selfMulAdd(x,a),w+=g*X.Vec2.CrossVV(r,a)}this.positions[u].a=B,this.positions[p].a=w}return c>=-1.5*X.linearSlop},Z.initializeVelocityConstraints_s_xfA=new X.Transform,Z.initializeVelocityConstraints_s_xfB=new X.Transform,Z.initializeVelocityConstraints_s_worldManifold=new X.WorldManifold,Z.warmStart_s_P=new X.Vec2,Z.solveVelocityConstraints_s_dv=new X.Vec2,Z.solveVelocityConstraints_s_dv1=new X.Vec2,Z.solveVelocityConstraints_s_dv2=new X.Vec2,Z.solveVelocityConstraints_s_P=new X.Vec2,Z.solveVelocityConstraints_s_a=new X.Vec2,Z.solveVelocityConstraints_s_b=new X.Vec2,Z.solveVelocityConstraints_s_x=new X.Vec2,Z.solveVelocityConstraints_s_d=new X.Vec2,Z.solveVelocityConstraints_s_P1=new X.Vec2,Z.solveVelocityConstraints_s_P2=new X.Vec2,Z.solveVelocityConstraints_s_P1P2=new X.Vec2,Z.solvePositionConstraints_s_xfA=new X.Transform,Z.solvePositionConstraints_s_xfB=new X.Transform,Z.solvePositionConstraints_s_psm=new n,Z.solvePositionConstraints_s_rA=new X.Vec2,Z.solvePositionConstraints_s_rB=new X.Vec2,Z.solvePositionConstraints_s_P=new X.Vec2,Z.solveTOIPositionConstraints_s_xfA=new X.Transform,Z.solveTOIPositionConstraints_s_xfB=new X.Transform,Z.solveTOIPositionConstraints_s_psm=new n,Z.solveTOIPositionConstraints_s_rA=new X.Vec2,Z.solveTOIPositionConstraints_s_rB=new X.Vec2,Z.solveTOIPositionConstraints_s_P=new X.Vec2,Z);function Z(){this.step=new X.TimeStep,this.positionConstraints=m.makeArray(1024),this.velocityConstraints=g.makeArray(1024),this.count=0}X.ContactSolver=r}(b2=b2||{}),function(n){var i=(t.prototype.clone=function(){return(new t).copy(this)},t.prototype.copy=function(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this},t.DEFAULT=new t,t);function t(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}n.Filter=i;function e(){this.userData=null,this.friction=.2,this.restitution=0,this.restitutionThreshold=+n.lengthUnitsPerMeter,this.density=0,this.isSensor=!1,this.filter=new i}n.FixtureDef=e;var s=(r.prototype.reset=function(){this.fixture.body.world.contactManager.broadPhase.destroyProxy(this.treeNode)},r.prototype.touch=function(){this.fixture.body.world.contactManager.broadPhase.touchProxy(this.treeNode)},r.prototype.synchronize=function(t,e){var i,s,o;t===e?(this.fixture.shape.computeAABB(this.aabb,t,this.childIndex),this.fixture.body.world.contactManager.broadPhase.moveProxy(this.treeNode,this.aabb,n.Vec2.ZERO)):(i=r.synchronize_s_aabb1,s=r.synchronize_s_aab,this.fixture.shape.computeAABB(i,t,this.childIndex),this.fixture.shape.computeAABB(s,e,this.childIndex),this.aabb.combine2(i,s),(o=r.synchronize_s_displacement).copy(s.getCenter()).selfSub(i.getCenter()),this.fixture.body.world.contactManager.broadPhase.moveProxy(this.treeNode,this.aabb,o))},r.synchronize_s_aabb1=new n.AABB,r.synchronize_s_aab=new n.AABB,r.synchronize_s_displacement=new n.Vec2,r);function r(t,e){this.aabb=new n.AABB,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.shape.computeAABB(this.aabb,this.fixture.body.getTransform(),e),this.treeNode=this.fixture.body.world.contactManager.broadPhase.createProxy(this.aabb,this)}n.FixtureProxy=s;var o=(Object.defineProperty(a.prototype,"proxyCount",{get:function(){return this.proxies.length},enumerable:!0,configurable:!0}),a.prototype.reset=function(){},a.prototype.getType=function(){return this.shape.getType()},a.prototype.getShape=function(){return this.shape},a.prototype.setSensor=function(t){t!==this.isSensor&&(this.body.setAwake(!0),this.isSensor=t)},a.prototype.setFilterData=function(t){this.filter.copy(t),this.refilter()},a.prototype.getFilterData=function(){return this.filter},a.prototype.refilter=function(){for(var t=this.body.getContactList();t;){var e=t.contact,i=e.getFixtureA(),s=e.getFixtureB();i!==this&&s!==this||e.glagForFiltering(),t=t.next}this.touchProxies()},a.prototype.getBody=function(){return this.body},a.prototype.testPoint=function(t){return this.shape.testPoint(this.body.getTransform(),t)},a.prototype.computeDistance=function(t,e,i){return this.shape.computeDistance(this.body.getTransform(),t,e,i)},a.prototype.rayCast=function(t,e,i){return this.shape.rayCast(t,e,this.body.getTransform(),i)},a.prototype.getMassData=function(t){return void 0===t&&(t=new n.MassData),this.shape.computeMass(t,this.density),t},a.prototype.setDensity=function(t){this.density=t},a.prototype.getDensity=function(){return this.density},a.prototype.getFriction=function(){return this.friction},a.prototype.setFriction=function(t){this.friction=t},a.prototype.getRestitution=function(){return this.restitution},a.prototype.setRestitution=function(t){this.restitution=t},a.prototype.getRestitutionThreshold=function(){return this.restitutionThreshold},a.prototype.setRestitutionThreshold=function(t){this.restitutionThreshold=t},a.prototype.getAABB=function(t){return this.proxies[t].aabb},a.prototype.dump=function(t,e){t("    const fd: FixtureDef = new FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.friction),t("    fd.restitution = %.15f;\n",this.restitution),t("    fd.restitutionThreshold = %.15f;\n",this.restitutionThreshold),t("    fd.density = %.15f;\n",this.density),t("    fd.isSensor = %s;\n",this.isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.filter.groupIndex),this.shape.dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)},a.prototype.createProxies=function(){if(0!==this.proxies.length)throw new Error;for(var t=0;t<this.shape.getChildCount();++t)this.proxies[t]=new s(this,t)},a.prototype.destroyProxies=function(){for(var t=0,e=this.proxies;t<e.length;t++){e[t].reset()}this.proxies.length=0},a.prototype.touchProxies=function(){for(var t=0,e=this.proxies;t<e.length;t++){e[t].touch()}},a.prototype.synchronizeProxies=function(t,e){for(var i=0,s=this.proxies;i<s.length;i++){s[i].synchronize(t,e)}},a);function a(t,e){this.density=0,this.next=null,this.friction=0,this.restitution=0,this.restitutionThreshold=+n.lengthUnitsPerMeter,this.proxies=[],this.filter=new i,this.isSensor=!1,this.userData=null,this.body=t,this.shape=e.shape.clone(),this.userData=n.maybe(e.userData,null),this.friction=n.maybe(e.friction,.2),this.restitution=n.maybe(e.restitution,0),this.restitutionThreshold=n.maybe(e.restitutionThreshold,0),this.filter.copy(n.maybe(e.filter,i.DEFAULT)),this.isSensor=n.maybe(e.isSensor,!1),this.density=n.maybe(e.density,0)}n.Fixture=o}(b2=b2||{}),function(l){var u,t;(t=u=l.JointType||(l.JointType={}))[t.UnknownJoint=0]="UnknownJoint",t[t.RevoluteJoint=1]="RevoluteJoint",t[t.PrismaticJoint=2]="PrismaticJoint",t[t.DistanceJoint=3]="DistanceJoint",t[t.PulleyJoint=4]="PulleyJoint",t[t.MouseJoint=5]="MouseJoint",t[t.GearJoint=6]="GearJoint",t[t.WheelJoint=7]="WheelJoint",t[t.WeldJoint=8]="WeldJoint",t[t.FrictionJoint=9]="FrictionJoint",t[t.RopeJoint=10]="RopeJoint",t[t.MotorJoint=11]="MotorJoint",t[t.AreaJoint=12]="AreaJoint";var e=(i.prototype.setZero=function(){return this.linear.setZero(),this.angularA=0,this.angularB=0,this},i.prototype.set=function(t,e,i){return this.linear.copy(t),this.angularA=e,this.angularB=i,this},i);function i(){this.linear=new l.Vec2,this.angularA=0,this.angularB=0}l.Jacobian=e;var s=(Object.defineProperty(o.prototype,"other",{get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t},enumerable:!0,configurable:!0}),o.prototype.reset=function(){this._other=null,this.prev=null,this.next=null},o);function o(t){this._other=null,this.prev=null,this.next=null,this.joint=t}l.JointEdge=s;function n(t){this.type=u.UnknownJoint,this.userData=null,this.collideConnected=!1,this.type=t}l.JointDef=n,l.linearStiffness=function(t,e,i,s,o){var n=s.getMass(),r=o.getMass(),a=0<n&&0<r?n*r/(n+r):0<n?n:r,c=2*l.pi*e;t.stiffness=a*c*c,t.damping=2*a*i*c},l.angularStiffness=function(t,e,i,s,o){var n=s.getInertia(),r=o.getInertia(),a=0<n&&0<r?n*r/(n+r):0<n?n:r,c=2*l.pi*e;t.stiffness=a*c*c,t.damping=2*a*i*c};var r=(p.prototype.getType=function(){return this.type},p.prototype.getBodyA=function(){return this.bodyA},p.prototype.getBodyB=function(){return this.bodyB},p.prototype.isEnabled=function(){return this.bodyA.isEnabled()&&this.bodyB.isEnabled()},p.prototype.getCollideConnected=function(){return this.collideConnected},p.prototype.dump=function(t){t("// Dump is not supported for this joint type.\n")},p.prototype.shiftOrigin=function(t){},p.prototype.draw=function(t){var e=this.bodyA.getTransform(),i=this.bodyB.getTransform(),s=e.p,o=i.p,n=this.getAnchorA(p.draw_s_p1),r=this.getAnchorB(p.draw_s_p2),a=p.draw_s_color.setRGB(.5,.8,.8);switch(this.type){case u.DistanceJoint:t.drawSegment(n,r,a);break;case u.PulleyJoint:var c=this.getGroundAnchorA(),l=this.getGroundAnchorB();t.drawSegment(c,n,a),t.drawSegment(l,r,a),t.drawSegment(c,l,a);break;case u.MouseJoint:var h=p.draw_s_c;h.set(0,1,0),t.drawPoint(n,4,h),t.drawPoint(r,4,h),h.set(.8,.8,.8),t.drawSegment(n,r,h);break;default:t.drawSegment(s,n,a),t.drawSegment(n,r,a),t.drawSegment(o,r,a)}},p.draw_s_p1=new l.Vec2,p.draw_s_p2=new l.Vec2,p.draw_s_color=new l.Color(.5,.8,.8),p.draw_s_c=new l.Color,p);function p(t){this.type=u.UnknownJoint,this.prev=null,this.next=null,this.edgeA=new s(this),this.edgeB=new s(this),this.index=0,this.islandFlag=!1,this.collideConnected=!1,this.userData=null,this.type=t.type,this.edgeA.other=t.bodyB,this.edgeB.other=t.bodyA,this.bodyA=t.bodyA,this.bodyB=t.bodyB,this.collideConnected=l.maybe(t.collideConnected,!1),this.userData=l.maybe(t.userData,null)}l.Joint=r}(b2=b2||{}),function(r){var t=(e.prototype.sayGoodbyeJoint=function(t){},e.prototype.sayGoodbyeFixture=function(t){},e.prototype.sayGoodbyeParticleGroup=function(t){},e.prototype.sayGoodbyeParticle=function(t,e){},e);function e(){}r.DestructionListener=t;var i=(s.prototype.ShouldCollide=function(t,e){var i=t.getBody(),s=e.getBody();if(s.getType()===r.BodyType.StaticBody&&i.getType()===r.BodyType.StaticBody)return!1;if(!s.shouldCollideConnected(i))return!1;var o=t.getFilterData(),n=e.getFilterData();return o.groupIndex===n.groupIndex&&0!==o.groupIndex?0<o.groupIndex:0!=(o.maskBits&n.categoryBits)&&0!=(o.categoryBits&n.maskBits)},s.prototype.shouldCollideFixtureParticle=function(t,e,i){return!0},s.prototype.shouldCollideParticleParticle=function(t,e,i){return!0},s.defaultFilter=new s,s);function s(){}r.ContactFilter=i;function o(){this.normalImpulses=r.MakeNumberArray(r.maxManifoldPoints),this.tangentImpulses=r.MakeNumberArray(r.maxManifoldPoints),this.count=0}r.ContactImpulse=o;var n=(a.prototype.beginContact=function(t){},a.prototype.endContact=function(t){},a.prototype.beginContactFixtureParticle=function(t,e){},a.prototype.endContactFixtureParticle=function(t,e){},a.prototype.beginContactParticleParticle=function(t,e){},a.prototype.endContactParticleParticle=function(t,e){},a.prototype.preSolve=function(t,e){},a.prototype.postSolve=function(t,e){},a.defaultListener=new a,a);function a(){}r.ContactListener=n;var c=(l.prototype.reportFixture=function(t){return!0},l.prototype.reportParticle=function(t,e){return!1},l.prototype.shouldQueryParticleSystem=function(t){return!0},l);function l(){}r.QueryCallback=c;var h=(u.prototype.reportFixture=function(t,e,i,s){return s},u.prototype.reportParticle=function(t,e,i,s,o){return 0},u.prototype.shouldQueryParticleSystem=function(t){return!0},u);function u(){}r.RayCastCallback=h}(b2=b2||{}),function(o){var t;(t=o.ParticleFlag||(o.ParticleFlag={}))[t.WaterParticle=0]="WaterParticle",t[t.ZombieParticle=2]="ZombieParticle",t[t.WallParticle=4]="WallParticle",t[t.SpringParticle=8]="SpringParticle",t[t.ElasticParticle=16]="ElasticParticle",t[t.ViscousParticle=32]="ViscousParticle",t[t.PowderParticle=64]="PowderParticle",t[t.TensileParticle=128]="TensileParticle",t[t.ColorMixingParticle=256]="ColorMixingParticle",t[t.DestructionListenerParticle=512]="DestructionListenerParticle",t[t.BarrierParticle=1024]="BarrierParticle",t[t.StaticPressureParticle=2048]="StaticPressureParticle",t[t.ReactiveParticle=4096]="ReactiveParticle",t[t.RepulsiveParticle=8192]="RepulsiveParticle",t[t.FixtureContactListenerParticle=16384]="FixtureContactListenerParticle",t[t.ParticleContactListenerParticle=32768]="ParticleContactListenerParticle",t[t.FixtureContactFilterParticle=65536]="FixtureContactFilterParticle",t[t.ParticleContactFilterParticle=131072]="ParticleContactFilterParticle";function e(){this.flags=0,this.position=new o.Vec2,this.velocity=new o.Vec2,this.color=new o.Color(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null}o.ParticleDef=e,o.CalculateParticleIterations=function(t,e,i){var s=Math.ceil(Math.sqrt(t/(.01*e))*i);return o.clamp(s,1,8)};var i=(s.prototype.getIndex=function(){return this.index},s.prototype.setIndex=function(t){this.index=t},s);function s(){this.index=o.invalidParticleIndex}o.ParticleHandle=i}(b2=b2||{}),function(t){var r=function(t,e){this.proxyA=t,this.proxyB=e};t.Pair=r;var e=(i.prototype.createProxy=function(t,e){var i=this.tree.createProxy(t,e);return++this.proxyCount,this.bufferMove(i),i},i.prototype.destroyProxy=function(t){this.unBufferMove(t),--this.proxyCount,this.tree.destroyProxy(t)},i.prototype.moveProxy=function(t,e,i){this.tree.moveProxy(t,e,i)&&this.bufferMove(t)},i.prototype.touchProxy=function(t){this.bufferMove(t)},i.prototype.getProxyCount=function(){return this.proxyCount},i.prototype.updatePairs=function(t){var n=this;this.pairCount=0;for(var i=this,e=0;e<this.moveCount;++e)!function(t){var o=i.moveBuffer[t];if(null===o)return;var e=o.aabb;i.tree.query(e,function(t){return t.id===o.id||t.moved&&t.id>o.id||(i=t.id<o.id?(e=t,o):(e=o,t),n.pairCount===n.pairBuffer.length?n.pairBuffer[n.pairCount]=new r(e,i):((s=n.pairBuffer[n.pairCount]).proxyA=e,s.proxyB=i),++n.pairCount),!0;var e,i,s})}(e);for(e=0;e<this.pairCount;++e){var s=this.pairBuffer[e];t(s.proxyA.userData,s.proxyB.userData)}for(e=0;e<this.moveCount;++e){var o=this.moveBuffer[e];null!==o&&(o.moved=!1)}this.moveCount=0},i.prototype.query=function(t,e){this.tree.query(t,e)},i.prototype.queryPoint=function(t,e){this.tree.queryPoint(t,e)},i.prototype.rayCast=function(t,e){this.tree.rayCast(t,e)},i.prototype.getTreeHeight=function(){return this.tree.getHeight()},i.prototype.getTreeBalance=function(){return this.tree.getMaxBalance()},i.prototype.getTreeQuality=function(){return this.tree.getAreaRatio()},i.prototype.shiftOrigin=function(t){this.tree.shiftOrigin(t)},i.prototype.bufferMove=function(t){this.moveBuffer[this.moveCount]=t,++this.moveCount},i.prototype.unBufferMove=function(t){var e=this.moveBuffer.indexOf(t);this.moveBuffer[e]=null},i);function i(){this.tree=new t.DynamicTree,this.proxyCount=0,this.moveCount=0,this.moveBuffer=[],this.pairCount=0,this.pairBuffer=[]}t.BroadPhase=e}(b2=b2||{}),function(l){var i,t=(i=l.Shape,__extends(h,i),h.prototype.createLoop=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if("number"==typeof t[0][0]){var i=t[0];if(i.length%2!=0)throw new Error;return this._createLoop(function(t){return{x:i[2*t],y:i[2*t+1]}},i.length/2)}var s=t[0],o=t[1]||s.length;return this._createLoop(function(t){return s[t]},o)},h.prototype._createLoop=function(t,e){if(e<3)return this;this.count=e+1,this.vertices=l.Vec2.MakeArray(this.count);for(var i=0;i<e;++i)this.vertices[i].copy(t(i));return this.vertices[e].copy(this.vertices[0]),this.prevVertex.copy(this.vertices[this.count-2]),this.nextVertex.copy(this.vertices[1]),this},h.prototype.createChain=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if("number"==typeof t[0][0]){var i=t[0],s=t[1],o=t[2];if(i.length%2!=0)throw new Error;return this._createChain(function(t){return{x:i[2*t],y:i[2*t+1]}},i.length/2,s,o)}var n=t[0],r=t[1]||n.length,s=t[2],o=t[3];return this._createChain(function(t){return n[t]},r,s,o)},h.prototype._createChain=function(t,e,i,s){this.count=e,this.vertices=l.Vec2.MakeArray(e);for(var o=0;o<e;++o)this.vertices[o].copy(t(o));return this.prevVertex.copy(i),this.nextVertex.copy(s),this},h.prototype.clone=function(){return(new h).copy(this)},h.prototype.copy=function(e){return i.prototype.copy.call(this,e),this._createChain(function(t){return e.vertices[t]},e.count,e.prevVertex,e.nextVertex),this.prevVertex.copy(e.prevVertex),this.nextVertex.copy(e.nextVertex),this},h.prototype.getChildCount=function(){return this.count-1},h.prototype.getChildEdge=function(t,e){t.radius=this.radius,t.vertex1.copy(this.vertices[e]),t.vertex2.copy(this.vertices[e+1]),t.oneSided=!0,0<e?t.vertex0.copy(this.vertices[e-1]):t.vertex0.copy(this.prevVertex),e<this.count-2?t.vertex3.copy(this.vertices[e+2]):t.vertex3.copy(this.nextVertex)},h.prototype.testPoint=function(t,e){return!1},h.prototype.computeDistance=function(t,e,i,s){var o=h.ComputeDistance_s_edgeShape;return this.getChildEdge(o,s),o.computeDistance(t,e,i,0)},h.prototype.rayCast=function(t,e,i,s){var o=h.rayCast_s_edgeShape;return o.vertex1.copy(this.vertices[s]),o.vertex2.copy(this.vertices[(s+1)%this.count]),o.rayCast(t,e,i,0)},h.prototype.computeAABB=function(t,e,i){var s=this.vertices[i],o=this.vertices[(i+1)%this.count],n=l.Transform.mulXV(e,s,h.computeAABB_s_v1),r=l.Transform.mulXV(e,o,h.computeAABB_s_v2),a=l.Vec2.MinV(n,r,h.computeAABB_s_lower),c=l.Vec2.MaxV(n,r,h.computeAABB_s_upper);t.lowerBound.x=a.x-this.radius,t.lowerBound.y=a.y-this.radius,t.upperBound.x=c.x+this.radius,t.upperBound.y=c.y+this.radius},h.prototype.computeMass=function(t,e){t.mass=0,t.center.setZero(),t.I=0},h.prototype.setupDistanceProxy=function(t,e){t.vertices=t.buffer,t.vertices[0].copy(this.vertices[e]),e+1<this.count?t.vertices[1].copy(this.vertices[e+1]):t.vertices[1].copy(this.vertices[0]),t.count=2,t.radius=this.radius},h.prototype.computeSubmergedArea=function(t,e,i,s){return s.setZero(),0},h.prototype.dump=function(t){t("    const shape: ChainShape = new ChainShape();\n"),t("    const vs: Vec2[] = [];\n");for(var e=0;e<this.count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.vertices[e].x,this.vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.count),t("    shape.prevVertex.Set(%.15f, %.15f);\n",this.prevVertex.x,this.prevVertex.y),t("    shape.nextVertex.Set(%.15f, %.15f);\n",this.nextVertex.x,this.nextVertex.y)},h.ComputeDistance_s_edgeShape=new l.EdgeShape,h.rayCast_s_edgeShape=new l.EdgeShape,h.computeAABB_s_v1=new l.Vec2,h.computeAABB_s_v2=new l.Vec2,h.computeAABB_s_lower=new l.Vec2,h.computeAABB_s_upper=new l.Vec2,h);function h(){var t=i.call(this,l.ShapeType.ChainShape,l.polygonRadius)||this;return t.vertices=[],t.count=0,t.prevVertex=new l.Vec2,t.nextVertex=new l.Vec2,t}l.ChainShape=t}(b2=b2||{}),function(p){var i,t=(i=p.Shape,__extends(d,i),d.prototype.set=function(t,e){return void 0===e&&(e=this.radius),this.p.copy(t),this.radius=e,this},d.prototype.clone=function(){return(new d).copy(this)},d.prototype.copy=function(t){return i.prototype.copy.call(this,t),this.p.copy(t.p),this},d.prototype.getChildCount=function(){return 1},d.prototype.testPoint=function(t,e){var i=p.Transform.mulXV(t,this.p,d.TestPoint_s_center),s=p.Vec2.SubVV(e,i,d.TestPoint_s_d);return p.Vec2.DotVV(s,s)<=p.sqrt(this.radius)},d.prototype.computeDistance=function(t,e,i,s){var o=p.Transform.mulXV(t,this.p,d.ComputeDistance_s_center);return p.Vec2.SubVV(e,o,i),i.normalize()-this.radius},d.prototype.rayCast=function(t,e,i,s){var o=p.Transform.mulXV(i,this.p,d.rayCast_s_position),n=p.Vec2.SubVV(e.p1,o,d.rayCast_s_s),r=p.Vec2.DotVV(n,n)-p.sqrt(this.radius),a=p.Vec2.SubVV(e.p2,e.p1,d.rayCast_s_r),c=p.Vec2.DotVV(n,a),l=p.Vec2.DotVV(a,a),h=c*c-l*r;if(h<0||l<p.epsilon)return!1;var u=-(c+p.Sqrt(h));return 0<=u&&u<=e.maxFraction*l&&(u/=l,t.fraction=u,p.Vec2.AddVMulSV(n,u,a,t.normal).selfNormalize(),!0)},d.prototype.computeAABB=function(t,e,i){var s=p.Transform.mulXV(e,this.p,d.computeAABB_s_p);t.lowerBound.set(s.x-this.radius,s.y-this.radius),t.upperBound.set(s.x+this.radius,s.y+this.radius)},d.prototype.computeMass=function(t,e){var i=p.sqrt(this.radius);t.mass=e*p.pi*i,t.center.copy(this.p),t.I=t.mass*(.5*i+p.Vec2.DotVV(this.p,this.p))},d.prototype.setupDistanceProxy=function(t,e){t.vertices=t.buffer,t.vertices[0].copy(this.p),t.count=1,t.radius=this.radius},d.prototype.computeSubmergedArea=function(t,e,i,s){var o=p.Transform.mulXV(i,this.p,new p.Vec2),n=-(p.Vec2.DotVV(t,o)-e);if(n<-this.radius+p.epsilon)return 0;if(n>this.radius)return s.copy(o),p.pi*this.radius*this.radius;var r=this.radius*this.radius,a=n*n,c=r*(p.Asin(n/this.radius)+p.pi/2)+n*p.Sqrt(r-a),l=-2/3*p.Pow(r-a,1.5)/c;return s.x=o.x+t.x*l,s.y=o.y+t.y*l,c},d.prototype.dump=function(t){t("    const shape: CircleShape = new CircleShape();\n"),t("    shape.radius = %.15f;\n",this.radius),t("    shape.p.Set(%.15f, %.15f);\n",this.p.x,this.p.y)},d.TestPoint_s_center=new p.Vec2,d.TestPoint_s_d=new p.Vec2,d.ComputeDistance_s_center=new p.Vec2,d.rayCast_s_position=new p.Vec2,d.rayCast_s_s=new p.Vec2,d.rayCast_s_r=new p.Vec2,d.computeAABB_s_p=new p.Vec2,d);function d(t){void 0===t&&(t=0);var e=i.call(this,p.ShapeType.CircleShape,t)||this;return e.p=new p.Vec2,e}p.CircleShape=t}(b2=b2||{}),function(A){var l=new A.Vec2,h=new A.Vec2;A.collideCircles=function(t,e,i,s,o){t.pointCount=0;var n=A.Transform.mulXV(i,e.p,l),r=A.Transform.mulXV(o,s.p,h),a=A.Vec2.DistanceSquaredVV(n,r),c=e.radius+s.radius;c*c<a||(t.type=A.ManifoldType.Circles,t.localPoint.copy(e.p),t.localNormal.setZero(),t.pointCount=1,t.points[0].localPoint.copy(s.p),t.points[0].id.key=0)};var w=new A.Vec2,b=new A.Vec2,C=new A.Vec2;A.collidePolygonAndCircle=function(t,e,i,s,o){t.pointCount=0;for(var n=A.Transform.mulXV(o,s.p,w),r=A.Transform.mulTXV(i,n,b),a=0,c=-A.maxFloat,l=e.radius+s.radius,h=e.count,u=e.vertices,p=e.normals,d=0;d<h;++d){var f=A.Vec2.DotVV(p[d],A.Vec2.SubVV(r,u[d],A.Vec2.s_t0));if(l<f)return;c<f&&(c=f,a=d)}var y=a,V=(y+1)%h,v=u[y],x=u[V];if(c<A.epsilon)return t.pointCount=1,t.type=A.ManifoldType.FaceA,t.localNormal.copy(p[a]),A.Vec2.MidVV(v,x,t.localPoint),t.points[0].localPoint.copy(s.p),void(t.points[0].id.key=0);var g=A.Vec2.DotVV(A.Vec2.SubVV(r,v,A.Vec2.s_t0),A.Vec2.SubVV(x,v,A.Vec2.s_t1)),m=A.Vec2.DotVV(A.Vec2.SubVV(r,x,A.Vec2.s_t0),A.Vec2.SubVV(v,x,A.Vec2.s_t1));if(g<=0){if(A.Vec2.DistanceSquaredVV(r,v)>l*l)return;t.pointCount=1,t.type=A.ManifoldType.FaceA,A.Vec2.SubVV(r,v,t.localNormal).selfNormalize(),t.localPoint.copy(v),t.points[0].localPoint.copy(s.p),t.points[0].id.key=0}else if(m<=0){if(A.Vec2.DistanceSquaredVV(r,x)>l*l)return;t.pointCount=1,t.type=A.ManifoldType.FaceA,A.Vec2.SubVV(r,x,t.localNormal).selfNormalize(),t.localPoint.copy(x),t.points[0].localPoint.copy(s.p),t.points[0].id.key=0}else{var B=A.Vec2.MidVV(v,x,C);if(l<A.Vec2.DotVV(A.Vec2.SubVV(r,B,A.Vec2.s_t1),p[y]))return;t.pointCount=1,t.type=A.ManifoldType.FaceA,t.localNormal.copy(p[y]).selfNormalize(),t.localPoint.copy(B),t.points[0].localPoint.copy(s.p),t.points[0].id.key=0}}}(b2=b2||{}),function(q){var J,t,M=new q.Vec2,P=new q.Vec2,I=new q.Vec2,T=new q.Vec2,F=new q.Vec2,D=new q.Vec2,L=new q.Vec2,R=new q.ContactID;q.collideEdgeAndCircle=function(t,e,i,s,o){t.pointCount=0;var n=q.Transform.mulTXV(i,q.Transform.mulXV(o,s.p,q.Vec2.s_t0),M),r=e.vertex1,a=e.vertex2,c=q.Vec2.SubVV(a,r,P),l=L.set(c.y,-c.x),h=q.Vec2.DotVV(l,q.Vec2.SubVV(n,r,q.Vec2.s_t0));if(!(e.oneSided&&h<0)){var u=q.Vec2.DotVV(c,q.Vec2.SubVV(a,n,q.Vec2.s_t0)),p=q.Vec2.DotVV(c,q.Vec2.SubVV(n,r,q.Vec2.s_t0)),d=e.radius+s.radius,f=R;if(f.cf.indexB=0,f.cf.typeB=q.ContactFeatureType.Vertex,p<=0){var y=r,V=q.Vec2.SubVV(n,y,I);if(d*d<q.Vec2.DotVV(V,V))return;if(e.oneSided){var v=e.vertex0,x=r,g=q.Vec2.SubVV(x,v,T);if(0<q.Vec2.DotVV(g,q.Vec2.SubVV(x,n,q.Vec2.s_t0)))return}return f.cf.indexA=0,f.cf.typeA=q.ContactFeatureType.Vertex,t.pointCount=1,t.type=q.ManifoldType.Circles,t.localNormal.setZero(),t.localPoint.copy(y),t.points[0].id.copy(f),void t.points[0].localPoint.copy(s.p)}if(u<=0){var m=a,B=q.Vec2.SubVV(n,m,I);if(d*d<q.Vec2.DotVV(B,B))return;if(e.oneSided){var A=e.vertex3,w=a,b=q.Vec2.SubVV(A,w,F);if(0<q.Vec2.DotVV(b,q.Vec2.SubVV(n,w,q.Vec2.s_t0)))return}return f.cf.indexA=1,f.cf.typeA=q.ContactFeatureType.Vertex,t.pointCount=1,t.type=q.ManifoldType.Circles,t.localNormal.setZero(),t.localPoint.copy(m),t.points[0].id.copy(f),void t.points[0].localPoint.copy(s.p)}var C=q.Vec2.DotVV(c,c),_=D;_.x=1/C*(u*r.x+p*a.x),_.y=1/C*(u*r.y+p*a.y);var S=q.Vec2.SubVV(n,_,I);d*d<q.Vec2.DotVV(S,S)||(h<0&&l.set(-l.x,-l.y),l.normalize(),f.cf.indexA=0,f.cf.typeA=q.ContactFeatureType.Face,t.pointCount=1,t.type=q.ManifoldType.FaceA,t.localNormal.copy(l),t.localPoint.copy(r),t.points[0].id.copy(f),t.points[0].localPoint.copy(s.p))}},(t=J=J||{})[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB";var e=function(){this.normal=new q.Vec2,this.type=J.e_unknown,this.index=0,this.separation=0},i=function(){this.vertices=[],this.normals=[],this.count=0},s=function(){this.i1=0,this.i2=0,this.v1=new q.Vec2,this.v2=new q.Vec2,this.normal=new q.Vec2,this.sideNormal1=new q.Vec2,this.sideOffset1=0,this.sideNormal2=new q.Vec2,this.sideOffset2=0},E=new e,z=[new q.Vec2,new q.Vec2];var j=new e,O=new q.Vec2;var G=new q.Transform,N=new q.Vec2,X=new q.Vec2,Z=new q.Vec2,W=new q.Vec2,U=new q.Vec2,Y=new q.Vec2,K=new q.Vec2,H=new i,Q=new s,$=[new q.ClipVertex,new q.ClipVertex],tt=[new q.ClipVertex,new q.ClipVertex],et=[new q.ClipVertex,new q.ClipVertex];q.collideEdgeAndPolygon=function(t,e,i,s,o){t.pointCount=0;var n=q.Transform.mulTXX(i,o,G),r=q.Transform.mulXV(n,s.centroid,N),a=e.vertex1,c=e.vertex2,l=q.Vec2.SubVV(c,a,X);l.normalize();var h=Z.set(l.y,-l.x),u=q.Vec2.DotVV(h,q.Vec2.SubVV(r,a,q.Vec2.s_t0)),p=e.oneSided;if(!(p&&u<0)){var d=H;d.count=s.count;for(var f=0;f<s.count;++f)d.vertices.length<=f&&d.vertices.push(new q.Vec2),d.normals.length<=f&&d.normals.push(new q.Vec2),q.Transform.mulXV(n,s.vertices[f],d.vertices[f]),q.Rot.mulRV(n.q,s.normals[f],d.normals[f]);var y=s.radius+e.radius,V=function(t,e,i){var s=E;s.type=J.e_edgeA,s.index=-1,s.separation=-Number.MAX_VALUE,s.normal.setZero();var o=z;o[0].copy(i),o[1].copy(i).selfNeg();for(var n=0;n<2;++n){for(var r=Number.MAX_VALUE,a=0;a<t.count;++a){var c=q.Vec2.DotVV(o[n],q.Vec2.SubVV(t.vertices[a],e,q.Vec2.s_t0));c<r&&(r=c)}r>s.separation&&(s.index=n,s.separation=r,s.normal.copy(o[n]))}return s}(d,a,h);if(!(V.separation>y)){var v=function(t,e,i){var s=j;s.type=J.e_unknown,s.index=-1,s.separation=-Number.MAX_VALUE,s.normal.setZero();for(var o=0;o<t.count;++o){var n=q.Vec2.NegV(t.normals[o],O),r=q.Vec2.DotVV(n,q.Vec2.SubVV(t.vertices[o],e,q.Vec2.s_t0)),a=q.Vec2.DotVV(n,q.Vec2.SubVV(t.vertices[o],i,q.Vec2.s_t0)),c=q.Min(r,a);c>s.separation&&(s.type=J.e_edgeB,s.index=o,s.separation=c,s.normal.copy(n))}return s}(d,a,c);if(!(v.separation>y)){var x=v.separation-y>.98*(V.separation-y)+.001?v:V;if(p){var g=q.Vec2.SubVV(a,e.vertex0,W);g.normalize();var m=U.set(g.y,-g.x),B=0<=q.Vec2.CrossVV(g,l),A=q.Vec2.SubVV(e.vertex3,c,Y);A.normalize();var w=K.set(A.y,-A.x),b=0<=q.Vec2.CrossVV(l,A);if(q.Vec2.DotVV(x.normal,l)<=0)if(B){if(.1<q.Vec2.CrossVV(x.normal,m))return}else x=V;else if(b){if(.1<q.Vec2.CrossVV(w,x.normal))return}else x=V}var C=$,_=Q;if(x.type===J.e_edgeA){t.type=q.ManifoldType.FaceA;for(var S=0,M=q.Vec2.DotVV(x.normal,d.normals[0]),f=1;f<d.count;++f){var P=q.Vec2.DotVV(x.normal,d.normals[f]);P<M&&(M=P,S=f)}var I=S,T=I+1<d.count?I+1:0;C[0].v.copy(d.vertices[I]),C[0].id.cf.indexA=0,C[0].id.cf.indexB=I,C[0].id.cf.typeA=q.ContactFeatureType.Face,C[0].id.cf.typeB=q.ContactFeatureType.Vertex,C[1].v.copy(d.vertices[T]),C[1].id.cf.indexA=0,C[1].id.cf.indexB=T,C[1].id.cf.typeA=q.ContactFeatureType.Face,C[1].id.cf.typeB=q.ContactFeatureType.Vertex,_.i1=0,_.i2=1,_.v1.copy(a),_.v2.copy(c),_.normal.copy(x.normal),_.sideNormal1.copy(l).selfNeg(),_.sideNormal2.copy(l)}else t.type=q.ManifoldType.FaceB,C[0].v.copy(c),C[0].id.cf.indexA=1,C[0].id.cf.indexB=x.index,C[0].id.cf.typeA=q.ContactFeatureType.Vertex,C[0].id.cf.typeB=q.ContactFeatureType.Face,C[1].v.copy(a),C[1].id.cf.indexA=0,C[1].id.cf.indexB=x.index,C[1].id.cf.typeA=q.ContactFeatureType.Vertex,C[1].id.cf.typeB=q.ContactFeatureType.Face,_.i1=x.index,_.i2=_.i1+1<d.count?_.i1+1:0,_.v1.copy(d.vertices[_.i1]),_.v2.copy(d.vertices[_.i2]),_.normal.copy(d.normals[_.i1]),_.sideNormal1.set(_.normal.y,-_.normal.x),_.sideNormal2.copy(_.sideNormal1).selfNeg();_.sideOffset1=q.Vec2.DotVV(_.sideNormal1,_.v1),_.sideOffset2=q.Vec2.DotVV(_.sideNormal2,_.v2);var F=tt,D=et,L=q.clipSegmentToLine(F,C,_.sideNormal1,_.sideOffset1,_.i1);if(!(L<q.maxManifoldPoints||q.clipSegmentToLine(D,F,_.sideNormal2,_.sideOffset2,_.i2)<q.maxManifoldPoints)){x.type===J.e_edgeA?(t.localNormal.copy(_.normal),t.localPoint.copy(_.v1)):(t.localNormal.copy(s.normals[_.i1]),t.localPoint.copy(s.vertices[_.i1]));for(var R,k=0,f=0;f<q.maxManifoldPoints;++f){q.Vec2.DotVV(_.normal,q.Vec2.SubVV(D[f].v,_.v1,q.Vec2.s_t0))<=y&&(R=t.points[k],x.type===J.e_edgeA?(q.Transform.mulTXV(n,D[f].v,R.localPoint),R.id.copy(D[f].id)):(R.localPoint.copy(D[f].v),R.id.cf.typeA=D[f].id.cf.typeB,R.id.cf.typeB=D[f].id.cf.typeA,R.id.cf.indexA=D[f].id.cf.indexB,R.id.cf.indexB=D[f].id.cf.indexA),++k)}t.pointCount=k}}}}}}(b2=b2||{}),function(O){var g=new O.Transform,m=new O.Vec2,B=new O.Vec2;function G(t,e,i,s,o){for(var n=e.count,r=s.count,a=e.normals,c=e.vertices,l=s.vertices,h=O.Transform.mulTXX(o,i,g),u=0,p=-O.maxFloat,d=0;d<n;++d){for(var f=O.Rot.mulRV(h.q,a[d],m),y=O.Transform.mulXV(h,c[d],B),V=O.maxFloat,v=0;v<r;++v){var x=O.Vec2.DotVV(f,O.Vec2.SubVV(l[v],y,O.Vec2.s_t0));x<V&&(V=x)}p<V&&(p=V,u=d)}return t[0]=u,p}var N=new O.Vec2;var X=[new O.ClipVertex,new O.ClipVertex],Z=[new O.ClipVertex,new O.ClipVertex],W=[new O.ClipVertex,new O.ClipVertex],U=[0],Y=[0],K=new O.Vec2,H=new O.Vec2,Q=new O.Vec2,$=new O.Vec2,tt=new O.Vec2,et=new O.Vec2,it=new O.Vec2,st=new O.Vec2;O.collidePolygons=function(t,e,i,s,o){t.pointCount=0;var n=e.radius+s.radius,r=U;r[0]=0;var a=G(r,e,i,s,o);if(!(n<a)){var c=Y;c[0]=0;var l=G(c,s,o,e,i);if(!(n<l)){var h,u,p,d,f=0,y=0,y=a+.1*O.linearSlop<l?(h=s,u=e,p=o,d=i,f=c[0],t.type=O.ManifoldType.FaceB,1):(h=e,u=s,p=i,d=o,f=r[0],t.type=O.ManifoldType.FaceA,0),V=X;!function(t,e,i,s,o,n){for(var r=e.normals,a=o.count,c=o.vertices,l=o.normals,h=O.Rot.mulTRV(n.q,O.Rot.mulRV(i.q,r[s],O.Vec2.s_t0),N),u=0,p=O.maxFloat,d=0;d<a;++d){var f=O.Vec2.DotVV(h,l[d]);f<p&&(p=f,u=d)}var y=u,V=y+1<a?y+1:0,v=t[0];O.Transform.mulXV(n,c[y],v.v);var x=v.id.cf;x.indexA=s,x.indexB=y,x.typeA=O.ContactFeatureType.Face,x.typeB=O.ContactFeatureType.Vertex;var g=t[1];O.Transform.mulXV(n,c[V],g.v);var m=g.id.cf;m.indexA=s,m.indexB=V,m.typeA=O.ContactFeatureType.Face,m.typeB=O.ContactFeatureType.Vertex}(V,h,p,f,u,d);var v=h.count,x=h.vertices,g=f,m=f+1<v?f+1:0,B=x[g],A=x[m],w=O.Vec2.SubVV(A,B,K);w.normalize();var b=O.Vec2.CrossVOne(w,H),C=O.Vec2.MidVV(B,A,Q),_=O.Rot.mulRV(p.q,w,tt),S=O.Vec2.CrossVOne(_,$),M=O.Transform.mulXV(p,B,it),P=O.Transform.mulXV(p,A,st),I=O.Vec2.DotVV(S,M),T=-O.Vec2.DotVV(_,M)+n,F=O.Vec2.DotVV(_,P)+n,D=Z,L=W,R=O.Vec2.NegV(_,et),k=O.clipSegmentToLine(D,V,R,T,g);if(!(k<2||O.clipSegmentToLine(L,D,_,F,m)<2)){t.localNormal.copy(b),t.localPoint.copy(C);for(var q=0,J=0;J<O.maxManifoldPoints;++J){var E,z,j=L[J];O.Vec2.DotVV(S,j.v)-I<=n&&(E=t.points[q],O.Transform.mulTXV(d,j.v,E.localPoint),E.id.copy(j.id),y&&(z=E.id.cf,E.id.cf.indexA=z.indexB,E.id.cf.indexB=z.indexA,E.id.cf.typeA=z.typeB,E.id.cf.typeB=z.typeA),++q)}t.pointCount=q}}}}}(b2=b2||{}),function(v){function x(t){if(null===t)throw new Error;return t}var e=(Object.defineProperty(t.prototype,"userData",{get:function(){if(null===this._userData)throw new Error;return this._userData},set:function(t){if(null!==this._userData)throw new Error;this._userData=t},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this._userData=null},t.prototype.isLeaf=function(){return null===this.child1},t);function t(t){void 0===t&&(t=0),this.id=0,this.aabb=new v.AABB,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.moved=!1,this.id=t}v.TreeNode=e;var i=(g.prototype.query=function(t,e){var i=this.stack.reset();for(i.push(this.root);0<i.getCount();){var s=i.pop();if(null!==s)if(s.aabb.testOverlap(t))if(s.isLeaf()){if(!e(s))return}else i.push(s.child1),i.push(s.child2)}},g.prototype.queryPoint=function(t,e){var i=this.stack.reset();for(i.push(this.root);0<i.getCount();){var s=i.pop();if(null!==s)if(s.aabb.testContain(t))if(s.isLeaf()){if(!e(s))return}else i.push(s.child1),i.push(s.child2)}},g.prototype.rayCast=function(t,e){var i=t.p1,s=t.p2,o=v.Vec2.SubVV(s,i,g.sR);o.normalize();var n=v.Vec2.CrossOneV(o,g.sV),r=v.Vec2.AbsV(n,g.absV),a=t.maxFraction,c=g.segmentAABB,l=i.x+a*(s.x-i.x),h=i.y+a*(s.y-i.y);c.lowerBound.x=v.Min(i.x,l),c.lowerBound.y=v.Min(i.y,h),c.upperBound.x=v.Max(i.x,l),c.upperBound.y=v.Max(i.y,h);var u=this.stack.reset();for(u.push(this.root);0<u.getCount();){var p=u.pop();if(null!==p&&v.testOverlapAABB(p.aabb,c)){var d=p.aabb.getCenter(),f=p.aabb.getExtents();if(!(0<v.Abs(v.Vec2.DotVV(n,v.Vec2.SubVV(i,d,v.Vec2.s_t0)))-v.Vec2.DotVV(r,f)))if(p.isLeaf()){var y=g.subInput;y.p1.copy(t.p1),y.p2.copy(t.p2),y.maxFraction=a;var V=e(y,p);if(0===V)return;0<V&&(a=V,l=i.x+a*(s.x-i.x),h=i.y+a*(s.y-i.y),c.lowerBound.x=v.Min(i.x,l),c.lowerBound.y=v.Min(i.y,h),c.upperBound.x=v.Max(i.x,l),c.upperBound.y=v.Max(i.y,h))}else u.push(p.child1),u.push(p.child2)}}},g.prototype.allocateNode=function(){if(null===this.freeList)return new e(g.sNodeId++);var t=this.freeList;return this.freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t.moved=!1,t},g.prototype.freeNode=function(t){t.parent=this.freeList,t.child1=null,t.child2=null,t.height=-1,t.reset(),this.freeList=t},g.prototype.createProxy=function(t,e){var i=this.allocateNode(),s=v.aabbExtension,o=v.aabbExtension;return i.aabb.lowerBound.x=t.lowerBound.x-s,i.aabb.lowerBound.y=t.lowerBound.y-o,i.aabb.upperBound.x=t.upperBound.x+s,i.aabb.upperBound.y=t.upperBound.y+o,i.userData=e,i.height=0,i.moved=!0,this.insertLeaf(i),i},g.prototype.destroyProxy=function(t){this.removeLeaf(t),this.freeNode(t)},g.prototype.moveProxy=function(t,e,i){var s=g.moveProxy_s_fatAABB,o=v.aabbExtension,n=v.aabbExtension;s.lowerBound.x=e.lowerBound.x-o,s.lowerBound.y=e.lowerBound.y-n,s.upperBound.x=e.upperBound.x+o,s.upperBound.y=e.upperBound.y+n;var r=v.aabbMultiplier*i.x,a=v.aabbMultiplier*i.y;r<0?s.lowerBound.x+=r:s.upperBound.x+=r,a<0?s.lowerBound.y+=a:s.upperBound.y+=a;var c=t.aabb;if(c.contains(e)){var l=g.moveProxy_s_hugeAABB;if(l.lowerBound.x=s.lowerBound.x-4*o,l.lowerBound.y=s.lowerBound.y-4*n,l.upperBound.x=s.upperBound.x+4*o,l.upperBound.y=s.upperBound.y+4*n,l.contains(c))return!1}return this.removeLeaf(t),t.aabb.copy(s),this.insertLeaf(t),t.moved=!0},g.prototype.insertLeaf=function(t){if(++this.insertionCount,null===this.root)return this.root=t,void(this.root.parent=null);for(var e=t.aabb,i=this.root;!i.isLeaf();){var s=x(i.child1),o=x(i.child2),n=i.aabb.getPerimeter(),r=g.combinedAABB;r.combine2(i.aabb,e);var a=r.getPerimeter(),c=2*a,l=2*(a-n),h=void 0,u=g.sAabb,p=void 0,h=s.isLeaf()?(u.combine2(e,s.aabb),u.getPerimeter()+l):(u.combine2(e,s.aabb),p=s.aabb.getPerimeter(),u.getPerimeter()-p+l),d=void 0,d=o.isLeaf()?(u.combine2(e,o.aabb),u.getPerimeter()+l):(u.combine2(e,o.aabb),p=o.aabb.getPerimeter(),u.getPerimeter()-p+l);if(c<h&&c<d)break;i=h<d?s:o}var f=i.parent,y=this.allocateNode();y.parent=f,y.aabb.combine2(e,i.aabb),y.height=i.height+1,null!==f?(f.child1===i?f.child1=y:f.child2=y,y.child1=i,y.child2=t,i.parent=y,t.parent=y):(y.child1=i,y.child2=t,i.parent=y,t.parent=y,this.root=y);for(var V=t.parent;null!==V;){s=x((V=this.balance(V)).child1),o=x(V.child2);V.height=1+v.Max(s.height,o.height),V.aabb.combine2(s.aabb,o.aabb),V=V.parent}},g.prototype.removeLeaf=function(t){if(t!==this.root){var e=x(t.parent),i=e&&e.parent,s=x(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=s:i.child2=s,s.parent=i,this.freeNode(e);for(var o=i;null!==o;){var n=x((o=this.balance(o)).child1),r=x(o.child2);o.aabb.combine2(n.aabb,r.aabb),o.height=1+v.Max(n.height,r.height),o=o.parent}}else(this.root=s).parent=null,this.freeNode(e)}else this.root=null},g.prototype.balance=function(t){if(t.isLeaf()||t.height<2)return t;var e=x(t.child1),i=x(t.child2),s=i.height-e.height;if(1<s){var o=x(i.child1),n=x(i.child2);return i.child1=t,i.parent=t.parent,null!==(t.parent=i).parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.root=i,o.height>n.height?(i.child2=o,((t.child2=n).parent=t).aabb.combine2(e.aabb,n.aabb),i.aabb.combine2(t.aabb,o.aabb),t.height=1+v.Max(e.height,n.height),i.height=1+v.Max(t.height,o.height)):(i.child2=n,((t.child2=o).parent=t).aabb.combine2(e.aabb,o.aabb),i.aabb.combine2(t.aabb,n.aabb),t.height=1+v.Max(e.height,o.height),i.height=1+v.Max(t.height,n.height)),i}if(s<-1){var r=x(e.child1),a=x(e.child2);return e.child1=t,e.parent=t.parent,null!==(t.parent=e).parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.root=e,r.height>a.height?(e.child2=r,((t.child1=a).parent=t).aabb.combine2(i.aabb,a.aabb),e.aabb.combine2(t.aabb,r.aabb),t.height=1+v.Max(i.height,a.height),e.height=1+v.Max(t.height,r.height)):(e.child2=a,((t.child1=r).parent=t).aabb.combine2(i.aabb,r.aabb),e.aabb.combine2(t.aabb,a.aabb),t.height=1+v.Max(i.height,r.height),e.height=1+v.Max(t.height,a.height)),e}return t},g.prototype.getHeight=function(){return null===this.root?0:this.root.height},g.getAreaNode=function(t){if(null===t)return 0;if(t.isLeaf())return 0;var e=t.aabb.getPerimeter();return e+=g.getAreaNode(t.child1),e+=g.getAreaNode(t.child2)},g.prototype.getAreaRatio=function(){if(null===this.root)return 0;var t=this.root.aabb.getPerimeter();return g.getAreaNode(this.root)/t},g.computeHeightNode=function(t){if(null===t)return 0;if(t.isLeaf())return 0;var e=g.computeHeightNode(t.child1),i=g.computeHeightNode(t.child2);return 1+v.Max(e,i)},g.prototype.computeHeight=function(){return g.computeHeightNode(this.root)},g.prototype.validateStructure=function(t){var e,i;null!==t&&(this.root,t.isLeaf()||(e=x(t.child1),i=x(t.child2),this.validateStructure(e),this.validateStructure(i)))},g.prototype.validateMetrics=function(t){var e,i;null!==t&&(t.isLeaf()||(e=x(t.child1),i=x(t.child2),g.sAabb.combine2(e.aabb,i.aabb),this.validateMetrics(e),this.validateMetrics(i)))},g.prototype.validate=function(){},g.getMaxBalanceNode=function(t,e){if(null===t)return e;if(t.height<=1)return e;var i=x(t.child1),s=x(t.child2),o=v.Abs(s.height-i.height);return v.Max(e,o)},g.prototype.getMaxBalance=function(){return g.getMaxBalanceNode(this.root,0)},g.prototype.rebuildBottomUp=function(){this.validate()},g.shiftOriginNode=function(t,e){var i,s;null!==t&&(t.height<=1||(i=t.child1,s=t.child2,g.shiftOriginNode(i,e),g.shiftOriginNode(s,e),t.aabb.lowerBound.selfSub(e),t.aabb.upperBound.selfSub(e)))},g.prototype.shiftOrigin=function(t){g.shiftOriginNode(this.root,t)},g.sR=new v.Vec2,g.sV=new v.Vec2,g.absV=new v.Vec2,g.segmentAABB=new v.AABB,g.subInput=new v.RayCastInput,g.combinedAABB=new v.AABB,g.sAabb=new v.AABB,g.sNodeId=0,g.moveProxy_s_fatAABB=new v.AABB,g.moveProxy_s_hugeAABB=new v.AABB,g);function g(){this.root=null,this.freeList=null,this.insertionCount=0,this.stack=new v.GrowableStack(256)}v.DynamicTree=i}(b2=b2||{}),function(_){var i,t=(i=_.Shape,__extends(S,i),S.prototype.clone=function(){return(new S).copy(this)},S.prototype.copy=function(t){i.prototype.copy.call(this,t),this.centroid.copy(t.centroid),this.count=t.count,this.vertices=_.Vec2.MakeArray(this.count),this.normals=_.Vec2.MakeArray(this.count);for(var e=0;e<this.count;++e)this.vertices[e].copy(t.vertices[e]),this.normals[e].copy(t.normals[e]);return this},S.prototype.getChildCount=function(){return 1},S.prototype.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if("number"==typeof t[0][0]){var i=t[0];if(i.length%2!=0)throw new Error;return this._set(function(t){return{x:i[2*t],y:i[2*t+1]}},i.length/2)}var s=t[0],o=t[1]||s.length;return this._set(function(t){return s[t]},o)},S.prototype._set=function(t,e){if(e<3)return this.setAsBox(1,1);for(var i=e,s=[],o=0;o<i;++o){for(var n=t(o),r=!0,a=0;a<s.length;++a)if(_.Vec2.DistanceSquaredVV(n,s[a])<.5*_.linearSlop*(.5*_.linearSlop)){r=!1;break}r&&s.push(n)}if((i=s.length)<3)return this.setAsBox(1,1);for(var c=0,l=s[0].x,o=1;o<i;++o){var h=s[o].x;(l<h||h===l&&s[o].y<s[c].y)&&(c=o,l=h)}for(var u=[],p=0,d=c;;){u[p]=d;for(var f,y,V=0,a=1;a<i;++a){V!==d?(f=_.Vec2.SubVV(s[V],s[u[p]],S.Set_s_r),n=_.Vec2.SubVV(s[a],s[u[p]],S.Set_s_v),(y=_.Vec2.CrossVV(f,n))<0&&(V=a),0===y&&n.lengthSquared()>f.lengthSquared()&&(V=a)):V=a}if(++p,(d=V)===c)break}this.count=p,this.vertices=_.Vec2.MakeArray(this.count),this.normals=_.Vec2.MakeArray(this.count);for(o=0;o<p;++o)this.vertices[o].copy(s[u[o]]);for(o=0;o<p;++o){var v=this.vertices[o],x=this.vertices[(o+1)%p],g=_.Vec2.SubVV(x,v,_.Vec2.s_t0);_.Vec2.CrossVOne(g,this.normals[o]).selfNormalize()}return S.computeCentroid(this.vertices,p,this.centroid),this},S.prototype.setAsBox=function(t,e,i,s){if(void 0===s&&(s=0),this.count=4,this.vertices=_.Vec2.MakeArray(this.count),this.normals=_.Vec2.MakeArray(this.count),this.vertices[0].set(-t,-e),this.vertices[1].set(t,-e),this.vertices[2].set(t,e),this.vertices[3].set(-t,e),this.normals[0].set(0,-1),this.normals[1].set(1,0),this.normals[2].set(0,1),this.normals[3].set(-1,0),this.centroid.setZero(),i){this.centroid.copy(i);var o=new _.Transform;o.setPosition(i),o.setRotationAngle(s);for(var n=0;n<this.count;++n)_.Transform.mulXV(o,this.vertices[n],this.vertices[n]),_.Rot.mulRV(o.q,this.normals[n],this.normals[n])}return this},S.prototype.testPoint=function(t,e){for(var i=_.Transform.mulTXV(t,e,S.testPointSPLocal),s=0;s<this.count;++s){if(0<_.Vec2.DotVV(this.normals[s],_.Vec2.SubVV(i,this.vertices[s],_.Vec2.s_t0)))return!1}return!0},S.prototype.computeDistance=function(t,e,i,s){for(var o=_.Transform.mulTXV(t,e,S.computeDistance_s_pLocal),n=-_.maxFloat,r=S.computeDistance_s_normalForMaxDistance.copy(o),a=0;a<this.count;++a){var c=_.Vec2.DotVV(this.normals[a],_.Vec2.SubVV(o,this.vertices[a],_.Vec2.s_t0));n<c&&(n=c,r.copy(this.normals[a]))}if(0<n){for(var l=S.computeDistance_s_minDistance.copy(r),h=n*n,a=0;a<this.count;++a){var u=_.Vec2.SubVV(o,this.vertices[a],S.computeDistance_s_distance),p=u.lengthSquared();p<h&&(l.copy(u),h=p)}return _.Rot.mulRV(t.q,l,i),i.normalize(),Math.sqrt(h)}return _.Rot.mulRV(t.q,r,i),n},S.prototype.rayCast=function(t,e,i,s){for(var o=_.Transform.mulTXV(i,e.p1,S.rayCast_s_p1),n=_.Transform.mulTXV(i,e.p2,S.rayCast_s_p2),r=_.Vec2.SubVV(n,o,S.rayCast_s_d),a=0,c=e.maxFraction,l=-1,h=0;h<this.count;++h){var u=_.Vec2.DotVV(this.normals[h],_.Vec2.SubVV(this.vertices[h],o,_.Vec2.s_t0)),p=_.Vec2.DotVV(this.normals[h],r);if(0===p){if(u<0)return!1}else p<0&&u<a*p?(a=u/p,l=h):0<p&&u<c*p&&(c=u/p);if(c<a)return!1}return 0<=l&&(t.fraction=a,_.Rot.mulRV(i.q,this.normals[l],t.normal),!0)},S.prototype.computeAABB=function(t,e,i){for(var s=_.Transform.mulXV(e,this.vertices[0],t.lowerBound),o=t.upperBound.copy(s),n=0;n<this.count;++n){var r=_.Transform.mulXV(e,this.vertices[n],S.computeAABB_s_v);_.Vec2.MinV(r,s,s),_.Vec2.MaxV(r,o,o)}var a=this.radius;s.selfSubXY(a,a),o.selfAddXY(a,a)},S.prototype.computeMass=function(t,e){for(var i=S.computeMass_s_center.setZero(),s=0,o=0,n=S.computeMass_s_s.copy(this.vertices[0]),r=0;r<this.count;++r){var a=_.Vec2.SubVV(this.vertices[r],n,S.computeMass_s_e1),c=_.Vec2.SubVV(this.vertices[(r+1)%this.count],n,S.computeMass_s_e2),l=_.Vec2.CrossVV(a,c),h=.5*l;s+=h,i.selfAdd(_.Vec2.MulSV(1/3*h,_.Vec2.AddVV(a,c,_.Vec2.s_t0),_.Vec2.s_t1));var u=a.x,p=a.y,d=c.x,f=c.y;o+=1/3*.25*l*(u*u+d*u+d*d+(p*p+f*p+f*f))}t.mass=e*s,i.selfMul(1/s),_.Vec2.AddVV(i,n,t.center),t.I=e*o,t.I+=t.mass*(_.Vec2.DotVV(t.center,t.center)-_.Vec2.DotVV(i,i))},S.prototype.validate=function(){for(var t=0;t<this.count;++t)for(var e=t,i=(t+1)%this.count,s=this.vertices[e],o=_.Vec2.SubVV(this.vertices[i],s,S.validate_s_e),n=0;n<this.count;++n)if(n!==e&&n!==i){var r=_.Vec2.SubVV(this.vertices[n],s,S.validate_s_v);if(_.Vec2.CrossVV(o,r)<0)return!1}return!0},S.prototype.setupDistanceProxy=function(t,e){t.vertices=this.vertices,t.count=this.count,t.radius=this.radius},S.prototype.computeSubmergedArea=function(t,e,i,s){for(var o=_.Rot.mulTRV(i.q,t,S.ComputeSubmergedArea_s_normalL),n=e-_.Vec2.DotVV(t,i.p),r=[],a=0,c=-1,l=-1,h=!1,u=0;u<this.count;++u){r[u]=_.Vec2.DotVV(o,this.vertices[u])-n;var p=r[u]<-_.epsilon;0<u&&(p?h||(c=u-1,a++):h&&(l=u-1,a++)),h=p}switch(a){case 0:if(h){var d=S.ComputeSubmergedArea_s_md;return this.computeMass(d,1),_.Transform.mulXV(i,d.center,s),d.mass}return 0;case 1:-1===c?c=this.count-1:l=this.count-1}for(var f,y=(c+1)%this.count,V=(l+1)%this.count,v=(0-r[c])/(r[y]-r[c]),x=(0-r[l])/(r[V]-r[l]),g=S.ComputeSubmergedArea_s_intoVec.set(this.vertices[c].x*(1-v)+this.vertices[y].x*v,this.vertices[c].y*(1-v)+this.vertices[y].y*v),m=S.ComputeSubmergedArea_s_outoVec.set(this.vertices[l].x*(1-x)+this.vertices[V].x*x,this.vertices[l].y*(1-x)+this.vertices[V].y*x),B=0,A=S.ComputeSubmergedArea_s_center.setZero(),w=this.vertices[y],b=y;b!==V;){f=(b=(b+1)%this.count)===V?m:this.vertices[b];var C=.5*((w.x-g.x)*(f.y-g.y)-(w.y-g.y)*(f.x-g.x));B+=C,A.x+=C*(g.x+w.x+f.x)/3,A.y+=C*(g.y+w.y+f.y)/3,w=f}return A.selfMul(1/B),_.Transform.mulXV(i,A,s),B},S.prototype.dump=function(t){t("    const shape: PolygonShape = new PolygonShape();\n"),t("    const vs: Vec2[] = [];\n");for(var e=0;e<this.count;++e)t("    vs[%d] = new Vec2(%.15f, %.15f);\n",e,this.vertices[e].x,this.vertices[e].y);t("    shape.Set(vs, %d);\n",this.count)},S.computeCentroid=function(t,e,i){var s=i;s.setZero();for(var o=0,n=S.computeCentroid_s_s.copy(t[0]),r=0;r<e;++r){var a=_.Vec2.SubVV(t[0],n,S.computeCentroid_s_p1),c=_.Vec2.SubVV(t[r],n,S.computeCentroid_s_p2),l=_.Vec2.SubVV(t[(r+1)%e],n,S.computeCentroid_s_p3),h=_.Vec2.SubVV(c,a,S.computeCentroid_s_e1),u=_.Vec2.SubVV(l,a,S.computeCentroid_s_e2),p=.5*_.Vec2.CrossVV(h,u);o+=p,s.x+=1/3*p*(a.x+c.x+l.x),s.y+=1/3*p*(a.y+c.y+l.y)}return s.x=1/o*s.x+n.x,s.y=1/o*s.y+n.y,s},S.Set_s_r=new _.Vec2,S.Set_s_v=new _.Vec2,S.testPointSPLocal=new _.Vec2,S.computeDistance_s_pLocal=new _.Vec2,S.computeDistance_s_normalForMaxDistance=new _.Vec2,S.computeDistance_s_minDistance=new _.Vec2,S.computeDistance_s_distance=new _.Vec2,S.rayCast_s_p1=new _.Vec2,S.rayCast_s_p2=new _.Vec2,S.rayCast_s_d=new _.Vec2,S.computeAABB_s_v=new _.Vec2,S.computeMass_s_center=new _.Vec2,S.computeMass_s_s=new _.Vec2,S.computeMass_s_e1=new _.Vec2,S.computeMass_s_e2=new _.Vec2,S.validate_s_e=new _.Vec2,S.validate_s_v=new _.Vec2,S.ComputeSubmergedArea_s_normalL=new _.Vec2,S.ComputeSubmergedArea_s_md=new _.MassData,S.ComputeSubmergedArea_s_intoVec=new _.Vec2,S.ComputeSubmergedArea_s_outoVec=new _.Vec2,S.ComputeSubmergedArea_s_center=new _.Vec2,S.computeCentroid_s_s=new _.Vec2,S.computeCentroid_s_p1=new _.Vec2,S.computeCentroid_s_p2=new _.Vec2,S.computeCentroid_s_p3=new _.Vec2,S.computeCentroid_s_e1=new _.Vec2,S.computeCentroid_s_e2=new _.Vec2,S);function S(){var t=i.call(this,_.ShapeType.PolygonShape,_.polygonRadius)||this;return t.centroid=new _.Vec2(0,0),t.vertices=[],t.normals=[],t.count=0,t}_.PolygonShape=t}(b2=b2||{}),(b2||(b2={})).BlockAllocator=function(){},function(e){var t=(i.prototype.reset=function(){return this.count=0,this},i.prototype.push=function(t){this.stack[this.count]=t,this.count++},i.prototype.pop=function(){this.count--;var t=this.stack[this.count];return this.stack[this.count]=null,t},i.prototype.getCount=function(){return this.count},i);function i(t){this.stack=[],this.count=0,this.stack=e.MakeArray(t,function(t){return null}),this.count=0}e.GrowableStack=t}(b2=b2||{}),(b2||(b2={})).log=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];console.log.apply(console,[t].concat(e))},(b2||(b2={})).StackAllocator=function(){},function(d){var e,t=(e=d.Controller,__extends(i,e),i.prototype.step=function(t){if(this.bodyList){this.useWorldGravity&&this.gravity.copy(this.bodyList.body.getWorld().gravity);for(var e=this.bodyList;e;e=e.nextBody){var i=e.body;if(i.isAwake()){for(var s,o,n=new d.Vec2,r=new d.Vec2,a=0,c=0,l=i.getFixtureList();l;l=l.next){var h=new d.Vec2,u=l.getShape().computeSubmergedArea(this.normal,this.offset,i.getTransform(),h);a+=u,n.x+=u*h.x,n.y+=u*h.y;var p=0;c+=u*(p=this.useDensity?l.getDensity():1),r.x+=u*h.x*p,r.y+=u*h.y*p}n.x/=a,n.y/=a,r.x/=c,r.y/=c,a<d.epsilon||((s=this.gravity.clone().selfNeg()).selfMul(this.density*a),i.applyForce(s,r),(o=i.getLinearVelocityFromWorldPoint(n,new d.Vec2)).selfSub(this.velocity),o.selfMul(-this.linearDrag*a),i.applyForce(o,n),i.applyTorque(-i.getInertia()/i.getMass()*a*i.getAngularVelocity()*this.angularDrag))}}}},i.prototype.draw=function(t){var e=new d.Vec2,i=new d.Vec2;e.x=this.normal.x*this.offset+100*this.normal.y,e.y=this.normal.y*this.offset-100*this.normal.x,i.x=this.normal.x*this.offset-100*this.normal.y,i.y=this.normal.y*this.offset+100*this.normal.x;var s=new d.Color(0,0,.8);t.drawSegment(e,i,s)},i);function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.normal=new d.Vec2(0,1),t.offset=0,t.density=0,t.velocity=new d.Vec2(0,0),t.linearDrag=0,t.angularDrag=0,t.useDensity=!1,t.useWorldGravity=!0,t.gravity=new d.Vec2(0,0),t}d.BuoyancyController=t}(b2=b2||{}),function(o){var e,t=(e=o.Controller,__extends(n,e),n.prototype.step=function(t){for(var e=o.Vec2.MulSV(t.dt,this.A,n.step_s_dtA),i=this.bodyList;i;i=i.nextBody){var s=i.body;s.isAwake()&&s.setLinearVelocity(o.Vec2.AddVV(s.getLinearVelocity(),e,o.Vec2.s_t0))}},n.prototype.draw=function(t){},n.step_s_dtA=new o.Vec2,n);function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.A=new o.Vec2(0,0),t}o.ConstantAccelController=t}(b2=b2||{}),function(e){var i,t=(i=e.Controller,__extends(s,i),s.prototype.step=function(t){for(var e=this.bodyList;e;e=e.nextBody){var i=e.body;i.isAwake()&&i.applyForce(this.F,i.getWorldCenter())}},s.prototype.draw=function(t){},s);function s(){var t=null!==i&&i.apply(this,arguments)||this;return t.F=new e.Vec2(0,0),t}e.ConstantForceController=t}(b2=b2||{}),function(d){var e,t=(e=d.Controller,__extends(f,e),f.prototype.step=function(t){if(this.invSqr)for(var e=this.bodyList;e;e=e.nextBody)for(var i=(a=e.body).getWorldCenter(),s=a.getMass(),o=this.bodyList;o&&o!==e;o=o.nextBody){var n=(c=o.body).getWorldCenter(),r=c.getMass();(u=(l=n.x-i.x)*l+(h=n.y-i.y)*h)<d.epsilon||((p=f.step_s_f.set(l,h)).selfMul(this.G/u/d.Sqrt(u)*s*r),a.isAwake()&&a.applyForce(p,i),c.isAwake()&&c.applyForce(p.selfMul(-1),n))}else for(e=this.bodyList;e;e=e.nextBody)for(var a,i=(a=e.body).getWorldCenter(),s=a.getMass(),o=this.bodyList;o&&o!==e;o=o.nextBody){var c,l,h,u,p,n=(c=o.body).getWorldCenter(),r=c.getMass();(u=(l=n.x-i.x)*l+(h=n.y-i.y)*h)<d.epsilon||((p=f.step_s_f.set(l,h)).selfMul(this.G/u*s*r),a.isAwake()&&a.applyForce(p,i),c.isAwake()&&c.applyForce(p.selfMul(-1),n))}},f.prototype.draw=function(t){},f.step_s_f=new d.Vec2,f);function f(){var t=null!==e&&e.apply(this,arguments)||this;return t.G=1,t.invSqr=!0,t}d.GravityController=t}(b2=b2||{}),function(n){var e,t=(e=n.Controller,__extends(r,e),r.prototype.step=function(t){var e=t.dt;if(!(e<=n.epsilon)){e>this.maxTimestep&&0<this.maxTimestep&&(e=this.maxTimestep);for(var i=this.bodyList;i;i=i.nextBody){var s,o=i.body;o.isAwake()&&(s=o.getWorldVector(n.Mat22.mulMV(this.T,o.getLocalVector(o.getLinearVelocity(),n.Vec2.s_t0),n.Vec2.s_t1),r.step_s_damping),o.setLinearVelocity(n.Vec2.AddVV(o.getLinearVelocity(),n.Vec2.MulSV(e,s,n.Vec2.s_t0),n.Vec2.s_t1)))}}},r.prototype.draw=function(t){},r.prototype.setAxisAligned=function(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=0<t||0<e?1/n.Max(t,e):0},r.step_s_damping=new n.Vec2,r);function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.T=new n.Mat22,t.maxTimestep=0,t}n.TensorDampingController=t}(b2=b2||{}),function(f){var e,t=(e=f.JointDef,__extends(i,e),i.prototype.addBody=function(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)},i);function i(){var t=e.call(this,f.JointType.AreaJoint)||this;return t.bodies=[],t.stiffness=0,t.damping=0,t}f.AreaJointDef=t;var c,s=(c=f.Joint,__extends(o,c),o.prototype.getAnchorA=function(t){return t},o.prototype.getAnchorB=function(t){return t},o.prototype.getReactionForce=function(t,e){return e},o.prototype.getReactionTorque=function(t){return 0},o.prototype.setStiffness=function(t){this.stiffness=t;for(var e=0;e<this.joints.length;++e)this.joints[e].SetStiffness(t)},o.prototype.getStiffness=function(){return this.stiffness},o.prototype.setDamping=function(t){this.damping=t;for(var e=0;e<this.joints.length;++e)this.joints[e].SetDamping(t)},o.prototype.getDamping=function(){return this.damping},o.prototype.dump=function(t){t("Area joint dumping is not supported.\n")},o.prototype.initVelocityConstraints=function(t){for(var e=0;e<this.bodies.length;++e){var i=this.bodies[(e+this.bodies.length-1)%this.bodies.length],s=this.bodies[(e+1)%this.bodies.length],o=t.positions[i.islandIndex].c,n=t.positions[s.islandIndex].c,r=this.deltas[e];f.Vec2.SubVV(n,o,r)}if(t.step.warmStarting){this.impulse*=t.step.dtRatio;for(e=0;e<this.bodies.length;++e){var a=this.bodies[e],c=t.velocities[a.islandIndex].v,r=this.deltas[e];c.x+=a.invMass*r.y*.5*this.impulse,c.y+=a.invMass*-r.x*.5*this.impulse}}else this.impulse=0},o.prototype.solveVelocityConstraints=function(t){for(var e=0,i=0,s=0;s<this.bodies.length;++s){var o=this.bodies[s],n=t.velocities[o.islandIndex].v;e+=(a=this.deltas[s]).lengthSquared()/o.getMass(),i+=f.Vec2.CrossVV(n,a)}var r=-2*i/e;this.impulse+=r;for(s=0;s<this.bodies.length;++s){var o=this.bodies[s],n=t.velocities[o.islandIndex].v,a=this.deltas[s];n.x+=o.invMass*a.y*.5*r,n.y+=o.invMass*-a.x*.5*r}},o.prototype.solvePositionConstraints=function(t){for(var e=0,i=0,s=0;s<this.bodies.length;++s){var o=this.bodies[s],n=this.bodies[(s+1)%this.bodies.length],r=t.positions[o.islandIndex].c,a=t.positions[n.islandIndex].c,c=(u=f.Vec2.SubVV(a,r,this.delta)).length();c<f.epsilon&&(c=1),this.normals[s].x=u.y/c,this.normals[s].y=-u.x/c,e+=c,i+=f.Vec2.CrossVV(r,a)}i*=.5;for(var l=.5*(this.targetArea-i)/e,h=!0,s=0;s<this.bodies.length;++s){var u,o=this.bodies[s],r=t.positions[o.islandIndex].c,p=(s+1)%this.bodies.length;(u=f.Vec2.AddVV(this.normals[s],this.normals[p],this.delta)).selfMul(l);var d=u.lengthSquared();d>f.sqrt(f.maxLinearCorrection)&&u.selfMul(f.maxLinearCorrection/f.Sqrt(d)),d>f.sqrt(f.linearSlop)&&(h=!1),r.x+=u.x,r.y+=u.y}return h},o);function o(t){var e=c.call(this,t)||this;e.stiffness=0,e.damping=0,e.impulse=0,e.targetArea=0,e.delta=new f.Vec2,e.bodies=t.bodies,e.stiffness=f.maybe(t.stiffness,0),e.damping=f.maybe(t.damping,0),e.targetLengths=f.MakeNumberArray(t.bodies.length),e.normals=f.Vec2.MakeArray(t.bodies.length),e.joints=[],e.deltas=f.Vec2.MakeArray(t.bodies.length);var i=new f.DistanceJointDef;i.stiffness=e.stiffness,i.damping=e.damping;for(var s=e.targetArea=0;s<e.bodies.length;++s){var o=e.bodies[s],n=e.bodies[(s+1)%e.bodies.length],r=o.getWorldCenter(),a=n.getWorldCenter();e.targetLengths[s]=f.Vec2.DistanceVV(r,a),e.targetArea+=f.Vec2.CrossVV(r,a),i.Initialize(o,n,r,a),e.joints[s]=o.getWorld().createJoint(i)}return e.targetArea*=.5,e}f.AreaJoint=s}(b2=b2||{}),function(o){var n,t;(t=n=o.BodyType||(o.BodyType={}))[t.Unknown=-1]="Unknown",t[t.StaticBody=0]="StaticBody",t[t.KinematicBody=1]="KinematicBody",t[t.DynamicBody=2]="DynamicBody";function e(){this.type=n.StaticBody,this.position=new o.Vec2(0,0),this.angle=0,this.linearVelocity=new o.Vec2(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.enabled=!0,this.userData=null,this.gravityScale=1}o.BodyDef=e;var i=(r.prototype.createFixture=function(t,e){return void 0===e&&(e=0),t instanceof o.Shape?this.createFixtureShapeDensity(t,e):this.createFixtureDef(t)},r.prototype.createFixtureDef=function(t){if(this.world.isLocked())throw new Error;var e=new o.Fixture(this,t);return this.enabledFlag&&e.createProxies(),e.next=this.fixtureList,this.fixtureList=e,++this.fixtureCount,0<e.density&&this.resetMassData(),this.world.newContacts=!0,e},r.prototype.createFixtureShapeDensity=function(t,e){void 0===e&&(e=0);var i=r.createFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.createFixtureDef(i)},r.prototype.destroyFixture=function(t){if(this.world.isLocked())throw new Error;for(var e=this.fixtureList,i=null;null!==e;){if(e===t){i?i.next=t.next:this.fixtureList=t.next;break}e=(i=e).next}for(var s=this.contactList;s;){var o=s.contact,s=s.next,n=o.getFixtureA(),r=o.getFixtureB();t!==n&&t!==r||this.world.contactManager.destroy(o)}this.enabledFlag&&t.destroyProxies(),t.next=null,t.reset(),--this.fixtureCount,this.resetMassData()},r.prototype.setTransformVec=function(t,e){this.setTransformXY(t.x,t.y,e)},r.prototype.setTransformXY=function(t,e,i){if(this.world.isLocked())throw new Error;this.xf.q.setAngle(i),this.xf.p.set(t,e),this.xf0.copy(this.xf),o.Transform.mulXV(this.xf,this.sweep.localCenter,this.sweep.c),this.sweep.a=i,this.sweep.c0.copy(this.sweep.c),this.sweep.a0=i;for(var s=this.fixtureList;s;s=s.next)s.synchronizeProxies(this.xf,this.xf);this.world.newContacts=!0},r.prototype.setTransform=function(t){this.setTransformVec(t.p,t.getAngle())},r.prototype.getTransform=function(){return this.xf},r.prototype.getPosition=function(){return this.xf.p},r.prototype.setPosition=function(t){this.setTransformVec(t,this.getAngle())},r.prototype.setPositionXY=function(t,e){this.setTransformXY(t,e,this.getAngle())},r.prototype.getAngle=function(){return this.sweep.a},r.prototype.setAngle=function(t){this.setTransformVec(this.getPosition(),t)},r.prototype.getWorldCenter=function(){return this.sweep.c},r.prototype.getLocalCenter=function(){return this.sweep.localCenter},r.prototype.setLinearVelocity=function(t){this.type!==n.StaticBody&&(0<o.Vec2.DotVV(t,t)&&this.setAwake(!0),this.linearVelocity.copy(t))},r.prototype.getLinearVelocity=function(){return this.linearVelocity},r.prototype.setAngularVelocity=function(t){this.type!==n.StaticBody&&(0<t*t&&this.setAwake(!0),this.angularVelocity=t)},r.prototype.getAngularVelocity=function(){return this.angularVelocity},r.prototype.getDefinition=function(t){return t.type=this.getType(),t.allowSleep=this.autoSleepFlag,t.angle=this.getAngle(),t.angularDamping=this.angularDamping,t.gravityScale=this.gravityScale,t.angularVelocity=this.angularVelocity,t.fixedRotation=this.fixedRotationFlag,t.bullet=this.bulletFlag,t.awake=this.awakeFlag,t.linearDamping=this.linearDamping,t.linearVelocity.copy(this.getLinearVelocity()),t.position.copy(this.getPosition()),t.userData=this.getUserData(),t},r.prototype.applyForce=function(t,e,i){void 0===i&&(i=!0),this.type===n.DynamicBody&&(i&&!this.awakeFlag&&this.setAwake(!0),this.awakeFlag&&(this.force.x+=t.x,this.force.y+=t.y,this.torque+=(e.x-this.sweep.c.x)*t.y-(e.y-this.sweep.c.y)*t.x))},r.prototype.applyForceToCenter=function(t,e){void 0===e&&(e=!0),this.type===n.DynamicBody&&(e&&!this.awakeFlag&&this.setAwake(!0),this.awakeFlag&&(this.force.x+=t.x,this.force.y+=t.y))},r.prototype.applyTorque=function(t,e){void 0===e&&(e=!0),this.type===n.DynamicBody&&(e&&!this.awakeFlag&&this.setAwake(!0),this.awakeFlag&&(this.torque+=t))},r.prototype.applyLinearImpulse=function(t,e,i){void 0===i&&(i=!0),this.type===n.DynamicBody&&(i&&!this.awakeFlag&&this.setAwake(!0),this.awakeFlag&&(this.linearVelocity.x+=this.invMass*t.x,this.linearVelocity.y+=this.invMass*t.y,this.angularVelocity+=this.invI*((e.x-this.sweep.c.x)*t.y-(e.y-this.sweep.c.y)*t.x)))},r.prototype.applyLinearImpulseToCenter=function(t,e){void 0===e&&(e=!0),this.type===n.DynamicBody&&(e&&!this.awakeFlag&&this.setAwake(!0),this.awakeFlag&&(this.linearVelocity.x+=this.invMass*t.x,this.linearVelocity.y+=this.invMass*t.y))},r.prototype.applyAngularImpulse=function(t,e){void 0===e&&(e=!0),this.type===n.DynamicBody&&(e&&!this.awakeFlag&&this.setAwake(!0),this.awakeFlag&&(this.angularVelocity+=this.invI*t))},r.prototype.getMass=function(){return this.mass},r.prototype.getInertia=function(){return this.I+this.mass*o.Vec2.DotVV(this.sweep.localCenter,this.sweep.localCenter)},r.prototype.getMassData=function(t){return t.mass=this.mass,t.I=this.I+this.mass*o.Vec2.DotVV(this.sweep.localCenter,this.sweep.localCenter),t.center.copy(this.sweep.localCenter),t},r.prototype.setMassData=function(t){if(this.world.isLocked())throw new Error;var e;this.type===n.DynamicBody&&(this.invMass=0,this.I=0,this.invI=0,this.mass=t.mass,this.mass<=0&&(this.mass=1),this.invMass=1/this.mass,0<t.I&&!this.fixedRotationFlag&&(this.I=t.I-this.mass*o.Vec2.DotVV(t.center,t.center),this.invI=1/this.I),e=r.setMassData_s_oldCenter.copy(this.sweep.c),this.sweep.localCenter.copy(t.center),o.Transform.mulXV(this.xf,this.sweep.localCenter,this.sweep.c),this.sweep.c0.copy(this.sweep.c),o.Vec2.AddVCrossSV(this.linearVelocity,this.angularVelocity,o.Vec2.SubVV(this.sweep.c,e,o.Vec2.s_t0),this.linearVelocity))},r.prototype.resetMassData=function(){if(this.mass=0,this.invMass=0,this.I=0,this.invI=0,this.sweep.localCenter.setZero(),this.type===n.StaticBody||this.type===n.KinematicBody)return this.sweep.c0.copy(this.xf.p),this.sweep.c.copy(this.xf.p),void(this.sweep.a0=this.sweep.a);for(var t,e=r.resetMassData_s_localCenter.setZero(),i=this.fixtureList;i;i=i.next){0!==i.density&&(t=i.getMassData(r.resetMassData_s_massData),this.mass+=t.mass,e.x+=t.center.x*t.mass,e.y+=t.center.y*t.mass,this.I+=t.I)}0<this.mass&&(this.invMass=1/this.mass,e.x*=this.invMass,e.y*=this.invMass),0<this.I&&!this.fixedRotationFlag?(this.I-=this.mass*o.Vec2.DotVV(e,e),this.invI=1/this.I):(this.I=0,this.invI=0);var s=r.resetMassData_s_oldCenter.copy(this.sweep.c);this.sweep.localCenter.copy(e),o.Transform.mulXV(this.xf,this.sweep.localCenter,this.sweep.c),this.sweep.c0.copy(this.sweep.c),o.Vec2.AddVCrossSV(this.linearVelocity,this.angularVelocity,o.Vec2.SubVV(this.sweep.c,s,o.Vec2.s_t0),this.linearVelocity)},r.prototype.getWorldPoint=function(t,e){return o.Transform.mulXV(this.xf,t,e)},r.prototype.getWorldVector=function(t,e){return o.Rot.mulRV(this.xf.q,t,e)},r.prototype.getLocalPoint=function(t,e){return o.Transform.mulTXV(this.xf,t,e)},r.prototype.getLocalVector=function(t,e){return o.Rot.mulTRV(this.xf.q,t,e)},r.prototype.getLinearVelocityFromWorldPoint=function(t,e){return o.Vec2.AddVCrossSV(this.linearVelocity,this.angularVelocity,o.Vec2.SubVV(t,this.sweep.c,o.Vec2.s_t0),e)},r.prototype.getLinearVelocityFromLocalPoint=function(t,e){return this.getLinearVelocityFromWorldPoint(this.getWorldPoint(t,e),e)},r.prototype.getLinearDamping=function(){return this.linearDamping},r.prototype.setLinearDamping=function(t){this.linearDamping=t},r.prototype.getAngularDamping=function(){return this.angularDamping},r.prototype.setAngularDamping=function(t){this.angularDamping=t},r.prototype.getGravityScale=function(){return this.gravityScale},r.prototype.setGravityScale=function(t){this.gravityScale=t},r.prototype.setType=function(t){if(this.world.isLocked())throw new Error;if(this.type!==t){this.type=t,this.resetMassData(),this.type===n.StaticBody&&(this.linearVelocity.setZero(),this.angularVelocity=0,this.sweep.a0=this.sweep.a,this.sweep.c0.copy(this.sweep.c),this.awakeFlag=!1,this.synchronizeFixtures()),this.setAwake(!0),this.force.setZero(),this.torque=0;for(var e=this.contactList;e;){var i=e,e=e.next;this.world.contactManager.destroy(i.contact)}this.contactList=null;for(var s=this.fixtureList;s;s=s.next)s.touchProxies()}},r.prototype.getType=function(){return this.type},r.prototype.setBullet=function(t){this.bulletFlag=t},r.prototype.isBullet=function(){return this.bulletFlag},r.prototype.setSleepingAllowed=function(t){(this.autoSleepFlag=t)||this.setAwake(!0)},r.prototype.isSleepingAllowed=function(){return this.autoSleepFlag},r.prototype.setAwake=function(t){this.type!==n.StaticBody&&(t?(this.awakeFlag=!0,this.sleepTime=0):(this.awakeFlag=!1,this.sleepTime=0,this.linearVelocity.setZero(),this.angularVelocity=0,this.force.setZero(),this.torque=0))},r.prototype.isAwake=function(){return this.awakeFlag},r.prototype.setEnabled=function(t){if(this.world.isLocked())throw new Error;if(t!==this.isEnabled())if(this.enabledFlag=t){for(var e=this.fixtureList;e;e=e.next)e.createProxies();this.world.newContacts=!0}else{for(e=this.fixtureList;e;e=e.next)e.destroyProxies();for(var i=this.contactList;i;){var s=i,i=i.next;this.world.contactManager.destroy(s.contact)}this.contactList=null}},r.prototype.isEnabled=function(){return this.enabledFlag},r.prototype.setFixedRotation=function(t){this.fixedRotationFlag!==t&&(this.fixedRotationFlag=t,this.angularVelocity=0,this.resetMassData())},r.prototype.isFixedRotation=function(){return this.fixedRotationFlag},r.prototype.getFixtureList=function(){return this.fixtureList},r.prototype.getJointList=function(){return this.jointList},r.prototype.getContactList=function(){return this.contactList},r.prototype.getNext=function(){return this.next},r.prototype.getUserData=function(){return this.userData},r.prototype.setUserData=function(t){this.userData=t},r.prototype.getWorld=function(){return this.world},r.prototype.dump=function(t){var e=this.islandIndex;t("{\n"),t("  const bd: BodyDef = new BodyDef();\n");var i="";switch(this.type){case n.StaticBody:i="BodyType.staticBody";break;case n.KinematicBody:i="BodyType.kinematicBody";break;case n.DynamicBody:i="BodyType.dynamicBody"}t("  bd.type = %s;\n",i),t("  bd.position.Set(%.15f, %.15f);\n",this.xf.p.x,this.xf.p.y),t("  bd.angle = %.15f;\n",this.sweep.a),t("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.linearVelocity.x,this.linearVelocity.y),t("  bd.angularVelocity = %.15f;\n",this.angularVelocity),t("  bd.linearDamping = %.15f;\n",this.linearDamping),t("  bd.angularDamping = %.15f;\n",this.angularDamping),t("  bd.allowSleep = %s;\n",this.autoSleepFlag?"true":"false"),t("  bd.awake = %s;\n",this.awakeFlag?"true":"false"),t("  bd.fixedRotation = %s;\n",this.fixedRotationFlag?"true":"false"),t("  bd.bullet = %s;\n",this.bulletFlag?"true":"false"),t("  bd.active = %s;\n",this.enabledFlag?"true":"false"),t("  bd.gravityScale = %.15f;\n",this.gravityScale),t("\n"),t("  bodies[%d] = this.world.CreateBody(bd);\n",this.islandIndex),t("\n");for(var s=this.fixtureList;s;s=s.next)t("  {\n"),s.dump(t,e),t("  }\n");t("}\n")},r.prototype.synchronizeFixtures=function(){if(this.awakeFlag){var t=r.synchronizeFixtures_s_xf1;t.q.setAngle(this.sweep.a0),o.Rot.mulRV(t.q,this.sweep.localCenter,t.p),o.Vec2.SubVV(this.sweep.c0,t.p,t.p);for(var e=this.fixtureList;e;e=e.next)e.synchronizeProxies(t,this.xf)}else for(e=this.fixtureList;e;e=e.next)e.synchronizeProxies(this.xf,this.xf)},r.prototype.synchronizeTransform=function(){this.xf.q.setAngle(this.sweep.a),o.Rot.mulRV(this.xf.q,this.sweep.localCenter,this.xf.p),o.Vec2.SubVV(this.sweep.c,this.xf.p,this.xf.p)},r.prototype.shouldCollide=function(t){return(this.type!==n.StaticBody||t.type!==n.StaticBody)&&this.shouldCollideConnected(t)},r.prototype.shouldCollideConnected=function(t){for(var e=this.jointList;e;e=e.next)if(e.other===t&&!e.joint.collideConnected)return!1;return!0},r.prototype.advance=function(t){this.sweep.advance(t),this.sweep.c.copy(this.sweep.c0),this.sweep.a=this.sweep.a0,this.xf.q.setAngle(this.sweep.a),o.Rot.mulRV(this.xf.q,this.sweep.localCenter,this.xf.p),o.Vec2.SubVV(this.sweep.c,this.xf.p,this.xf.p)},r.prototype.getControllerList=function(){return this.controllerList},r.prototype.getControllerCount=function(){return this.controllerCount},r.createFixtureShapeDensity_s_def=new o.FixtureDef,r.setMassData_s_oldCenter=new o.Vec2,r.resetMassData_s_localCenter=new o.Vec2,r.resetMassData_s_oldCenter=new o.Vec2,r.resetMassData_s_massData=new o.MassData,r.synchronizeFixtures_s_xf1=new o.Transform,r);function r(t,e){this.type=n.StaticBody,this.islandFlag=!1,this.awakeFlag=!1,this.autoSleepFlag=!1,this.bulletFlag=!1,this.fixedRotationFlag=!1,this.enabledFlag=!1,this.toiFlag=!1,this.islandIndex=0,this.xf=new o.Transform,this.xf0=new o.Transform,this.sweep=new o.Sweep,this.linearVelocity=new o.Vec2,this.angularVelocity=0,this.force=new o.Vec2,this.torque=0,this.prev=null,this.next=null,this.fixtureList=null,this.fixtureCount=0,this.jointList=null,this.contactList=null,this.mass=1,this.invMass=1,this.I=0,this.invI=0,this.linearDamping=0,this.angularDamping=0,this.gravityScale=1,this.sleepTime=0,this.userData=null,this.controllerList=null,this.controllerCount=0,this.bulletFlag=o.maybe(t.bullet,!1),this.fixedRotationFlag=o.maybe(t.fixedRotation,!1),this.autoSleepFlag=o.maybe(t.allowSleep,!0),o.maybe(t.awake,!1)&&o.maybe(t.type,n.StaticBody)!==n.StaticBody&&(this.awakeFlag=!0),this.enabledFlag=o.maybe(t.enabled,!0),this.world=e,this.xf.p.copy(o.maybe(t.position,o.Vec2.ZERO)),this.xf.q.setAngle(o.maybe(t.angle,0)),this.xf0.copy(this.xf),this.sweep.localCenter.setZero(),this.sweep.c0.copy(this.xf.p),this.sweep.c.copy(this.xf.p),this.sweep.a0=this.sweep.a=this.xf.q.getAngle(),this.sweep.alpha0=0,this.linearVelocity.copy(o.maybe(t.linearVelocity,o.Vec2.ZERO)),this.angularVelocity=o.maybe(t.angularVelocity,0),this.linearDamping=o.maybe(t.linearDamping,0),this.angularDamping=o.maybe(t.angularDamping,0),this.gravityScale=o.maybe(t.gravityScale,1),this.force.setZero(),this.torque=0,this.sleepTime=0,this.type=o.maybe(t.type,n.StaticBody),this.mass=0,this.invMass=0,this.I=0,this.invI=0,this.userData=t.userData,this.fixtureList=null,this.fixtureCount=0,this.controllerList=null,this.controllerCount=0}o.Body=i}(b2=b2||{}),function(o){var t,e=(t=o.Contact,__extends(n,t),n.create=function(){return new n},n.destroy=function(t){},n.prototype.evaluate=function(t,e,i){var s=n.evaluate_s_edge;this.getShapeA().getChildEdge(s,this.indexA),o.collideEdgeAndCircle(t,s,e,this.getShapeB(),i)},n.evaluate_s_edge=new o.EdgeShape,n);function n(){return null!==t&&t.apply(this,arguments)||this}o.ChainAndCircleContact=e}(b2=b2||{}),function(o){var t,e=(t=o.Contact,__extends(n,t),n.create=function(){return new n},n.destroy=function(t){},n.prototype.evaluate=function(t,e,i){var s=n.evaluate_s_edge;this.getShapeA().getChildEdge(s,this.indexA),o.collideEdgeAndPolygon(t,s,e,this.getShapeB(),i)},n.evaluate_s_edge=new o.EdgeShape,n);function n(){return null!==t&&t.apply(this,arguments)||this}o.ChainAndPolygonContact=e}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.create=function(){return new i},i.destroy=function(t){},i.prototype.evaluate=function(t,e,i){s.collideCircles(t,this.getShapeA(),e,this.getShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.CircleContact=e}(b2=b2||{}),function(i){var s=function(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1};i.ContactRegister=s;var t=(e.prototype.addType=function(t,e,i,s){var o=[];function n(){return o.pop()||t()}function r(t){o.push(t)}this.registers[i][s].pool=o,this.registers[i][s].createFcn=n,this.registers[i][s].destroyFcn=r,this.registers[i][s].primary=!0,i!==s&&(this.registers[s][i].pool=o,this.registers[s][i].createFcn=n,this.registers[s][i].destroyFcn=r,this.registers[s][i].primary=!1)},e.prototype.initializeRegisters=function(){for(var t=0;t<i.ShapeType.ShapeTypeCount;t++){this.registers[t]=[];for(var e=0;e<i.ShapeType.ShapeTypeCount;e++)this.registers[t][e]=new s}this.addType(i.CircleContact.create,i.CircleContact.destroy,i.ShapeType.CircleShape,i.ShapeType.CircleShape),this.addType(i.PolygonAndCircleContact.create,i.PolygonAndCircleContact.destroy,i.ShapeType.PolygonShape,i.ShapeType.CircleShape),this.addType(i.PolygonContact.create,i.PolygonContact.destroy,i.ShapeType.PolygonShape,i.ShapeType.PolygonShape),this.addType(i.EdgeAndCircleContact.create,i.EdgeAndCircleContact.destroy,i.ShapeType.EdgeShape,i.ShapeType.CircleShape),this.addType(i.EdgeAndPolygonContact.create,i.EdgeAndPolygonContact.destroy,i.ShapeType.EdgeShape,i.ShapeType.PolygonShape),this.addType(i.ChainAndCircleContact.create,i.ChainAndCircleContact.destroy,i.ShapeType.ChainShape,i.ShapeType.CircleShape),this.addType(i.ChainAndPolygonContact.create,i.ChainAndPolygonContact.destroy,i.ShapeType.ChainShape,i.ShapeType.PolygonShape)},e.prototype.create=function(t,e,i,s){var o=t.getType(),n=i.getType(),r=this.registers[o][n];if(r.createFcn){var a=r.createFcn();return r.primary?a.reset(t,e,i,s):a.reset(i,s,t,e),a}return null},e.prototype.destroy=function(t){var e=t.fixtureA.getType(),i=t.fixtureB.getType(),s=this.registers[e][i];s.destroyFcn&&s.destroyFcn(t)},e);function e(){this.registers=[],this.initializeRegisters()}i.ContactFactory=t}(b2=b2||{}),function(p){var t=(e.prototype.addPair=function(t,e){var i=t.fixture,s=e.fixture,o=t.childIndex,n=e.childIndex,r=i.getBody(),a=s.getBody();if(r!==a){for(var c,l=a.getContactList();l;){if(l.other===r){var h=l.contact.getFixtureA(),u=l.contact.getFixtureB(),p=l.contact.getChildIndexA(),d=l.contact.getChildIndexB();if(h===i&&u===s&&p===o&&d===n)return;if(h===s&&u===i&&p===n&&d===o)return}l=l.next}this.contactFilter&&!this.contactFilter.ShouldCollide(i,s)||null!==(c=this.contactFactory.create(i,o,s,n))&&(i=c.getFixtureA(),s=c.getFixtureB(),o=c.getChildIndexA(),n=c.getChildIndexB(),r=i.body,a=s.body,c.prev=null,c.next=this.contactList,null!==this.contactList&&(this.contactList.prev=c),(this.contactList=c).nodeA.other=a,c.nodeA.prev=null,c.nodeA.next=r.contactList,null!==r.contactList&&(r.contactList.prev=c.nodeA),r.contactList=c.nodeA,c.nodeB.other=r,c.nodeB.prev=null,c.nodeB.next=a.contactList,null!==a.contactList&&(a.contactList.prev=c.nodeB),a.contactList=c.nodeB,++this.contactCount)}},e.prototype.findNewContacts=function(){var i=this;this.broadPhase.updatePairs(function(t,e){i.addPair(t,e)})},e.prototype.destroy=function(t){var e=t.getFixtureA(),i=t.getFixtureB(),s=e.getBody(),o=i.getBody();this.contactListener&&t.isTouching()&&this.contactListener.endContact(t),t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.contactList&&(this.contactList=t.next),t.nodeA.prev&&(t.nodeA.prev.next=t.nodeA.next),t.nodeA.next&&(t.nodeA.next.prev=t.nodeA.prev),t.nodeA===s.contactList&&(s.contactList=t.nodeA.next),t.nodeB.prev&&(t.nodeB.prev.next=t.nodeB.next),t.nodeB.next&&(t.nodeB.next.prev=t.nodeB.prev),t.nodeB===o.contactList&&(o.contactList=t.nodeB.next),0<t.manifold.pointCount&&!e.isSensor&&!i.isSensor&&(e.getBody().setAwake(!0),i.getBody().setAwake(!0)),this.contactFactory.destroy(t),--this.contactCount},e.prototype.collide=function(){for(var t=this.contactList;t;){var e=t.getFixtureA(),i=t.getFixtureB(),s=t.getChildIndexA(),o=t.getChildIndexB(),n=e.getBody(),r=i.getBody();if(t.filterFlag){if(this.contactFilter&&!this.contactFilter.ShouldCollide(e,i)){t=(l=t).next;this.destroy(l);continue}t.filterFlag=!1}var a,c,l,h=n.isAwake()&&n.type!==p.BodyType.StaticBody,u=r.isAwake()&&r.type!==p.BodyType.StaticBody;h||u?(a=e.proxies[s].treeNode,c=i.proxies[o].treeNode,p.testOverlapAABB(a.aabb,c.aabb)?(t.update(this.contactListener),t=t.next):(t=(l=t).next,this.destroy(l))):t=t.next}},e);function e(){this.broadPhase=new p.BroadPhase,this.contactList=null,this.contactCount=0,this.contactFilter=p.ContactFilter.defaultFilter,this.contactListener=p.ContactListener.defaultListener,this.contactFactory=new p.ContactFactory}p.ContactManager=t}(b2=b2||{}),function(g){var e,t=(e=g.JointDef,__extends(i,e),i.prototype.Initialize=function(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.getLocalPoint(i,this.localAnchorA),this.bodyB.getLocalPoint(s,this.localAnchorB),this.length=g.Max(g.Vec2.DistanceVV(i,s),g.linearSlop),this.minLength=this.length,this.maxLength=this.length},i);function i(){var t=e.call(this,g.JointType.DistanceJoint)||this;return t.localAnchorA=new g.Vec2,t.localAnchorB=new g.Vec2,t.length=1,t.minLength=0,t.maxLength=g.maxFloat,t.stiffness=0,t.damping=0,t}g.DistanceJointDef=t;var s,o=(s=g.Joint,__extends(m,s),m.prototype.getAnchorA=function(t){return this.bodyA.getWorldPoint(this.localAnchorA,t)},m.prototype.getAnchorB=function(t){return this.bodyB.getWorldPoint(this.localAnchorB,t)},m.prototype.getReactionForce=function(t,e){return e.x=t*(this.impulse+this.lowerImpulse-this.upperImpulse)*this.u.x,e.y=t*(this.impulse+this.lowerImpulse-this.upperImpulse)*this.u.y,e},m.prototype.getReactionTorque=function(t){return 0},m.prototype.GetLocalAnchorA=function(){return this.localAnchorA},m.prototype.GetLocalAnchorB=function(){return this.localAnchorB},m.prototype.SetLength=function(t){return this.impulse=0,this.length=g.Max(g.linearSlop,t),this.length},m.prototype.GetLength=function(){return this.length},m.prototype.SetMinLength=function(t){return this.lowerImpulse=0,this.minLength=g.clamp(t,g.linearSlop,this.maxLength),this.minLength},m.prototype.SetMaxLength=function(t){return this.upperImpulse=0,this.maxLength=g.Max(t,this.minLength),this.maxLength},m.prototype.GetCurrentLength=function(){var t=this.bodyA.getWorldPoint(this.localAnchorA,new g.Vec2),e=this.bodyB.getWorldPoint(this.localAnchorB,new g.Vec2);return g.Vec2.DistanceVV(t,e)},m.prototype.SetStiffness=function(t){this.stiffness=t},m.prototype.GetStiffness=function(){return this.stiffness},m.prototype.SetDamping=function(t){this.damping=t},m.prototype.GetDamping=function(){return this.damping},m.prototype.dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: DistanceJointDef = new DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.length = %.15f;\n",this.length),t("  jd.minLength = %.15f;\n",this.minLength),t("  jd.maxLength = %.15f;\n",this.maxLength),t("  jd.stiffness = %.15f;\n",this.stiffness),t("  jd.damping = %.15f;\n",this.damping),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},m.prototype.initVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.copy(this.bodyA.sweep.localCenter),this.localCenterB.copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.velocities[this.indexA].v,o=t.velocities[this.indexA].w,n=t.positions[this.indexB].c,r=t.positions[this.indexB].a,a=t.velocities[this.indexB].v,c=t.velocities[this.indexB].w,l=this.qA.setAngle(i),h=this.qB.setAngle(r);g.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),g.Rot.mulRV(l,this.lalcA,this.rA),g.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),g.Rot.mulRV(h,this.lalcB,this.rB),this.u.x=n.x+this.rB.x-e.x-this.rA.x,this.u.y=n.y+this.rB.y-e.y-this.rA.y,this.currentLength=this.u.length(),this.currentLength>g.linearSlop?this.u.selfMul(1/this.currentLength):(this.u.setZero(),this.mass=0,this.impulse=0,this.lowerImpulse=0,this.upperImpulse=0);var u,p,d,f,y,V=g.Vec2.CrossVV(this.rA,this.u),v=g.Vec2.CrossVV(this.rB,this.u),x=this.invMassA+this.invIA*V*V+this.invMassB+this.invIB*v*v;this.mass=0!==x?1/x:0,0<this.stiffness&&this.minLength<this.maxLength?(u=this.currentLength-this.length,p=this.damping,d=this.stiffness,f=t.step.dt,this.gamma=f*(p+f*d),this.gamma=0!==this.gamma?1/this.gamma:0,this.bias=u*f*d*this.gamma,x+=this.gamma,this.softMass=0!==x?1/x:0):(this.gamma=0,this.bias=0,this.softMass=this.mass),t.step.warmStarting?(this.impulse*=t.step.dtRatio,this.lowerImpulse*=t.step.dtRatio,this.upperImpulse*=t.step.dtRatio,y=g.Vec2.MulSV(this.impulse+this.lowerImpulse-this.upperImpulse,this.u,m.initVelocityConstraints_s_P),s.selfMulSub(this.invMassA,y),o-=this.invIA*g.Vec2.CrossVV(this.rA,y),a.selfMulAdd(this.invMassB,y),c+=this.invIB*g.Vec2.CrossVV(this.rB,y)):this.impulse=0,t.velocities[this.indexA].w=o,t.velocities[this.indexB].w=c},m.prototype.solveVelocityConstraints=function(t){var e,i,s,o,n,r,a,c,l=t.velocities[this.indexA].v,h=t.velocities[this.indexA].w,u=t.velocities[this.indexB].v,p=t.velocities[this.indexB].w;c=this.minLength<this.maxLength?(0<this.stiffness&&(o=g.Vec2.AddVCrossSV(l,h,this.rA,m.solveVelocityConstraints_s_vpA),n=g.Vec2.AddVCrossSV(u,p,this.rB,m.solveVelocityConstraints_s_vpB),r=g.Vec2.DotVV(this.u,g.Vec2.SubVV(n,o,g.Vec2.s_t0)),a=-this.softMass*(r+this.bias+this.gamma*this.impulse),this.impulse+=a,c=g.Vec2.MulSV(a,this.u,m.solveVelocityConstraints_s_P),l.selfMulSub(this.invMassA,c),h-=this.invIA*g.Vec2.CrossVV(this.rA,c),u.selfMulAdd(this.invMassB,c),p+=this.invIB*g.Vec2.CrossVV(this.rB,c)),e=this.currentLength-this.minLength,i=g.Max(0,e)*t.step.inv_dt,o=g.Vec2.AddVCrossSV(l,h,this.rA,m.solveVelocityConstraints_s_vpA),n=g.Vec2.AddVCrossSV(u,p,this.rB,m.solveVelocityConstraints_s_vpB),r=g.Vec2.DotVV(this.u,g.Vec2.SubVV(n,o,g.Vec2.s_t0)),a=-this.mass*(r+i),s=this.lowerImpulse,this.lowerImpulse=g.Max(0,this.lowerImpulse+a),a=this.lowerImpulse-s,c=g.Vec2.MulSV(a,this.u,m.solveVelocityConstraints_s_P),l.selfMulSub(this.invMassA,c),h-=this.invIA*g.Vec2.CrossVV(this.rA,c),u.selfMulAdd(this.invMassB,c),p+=this.invIB*g.Vec2.CrossVV(this.rB,c),e=this.maxLength-this.currentLength,i=g.Max(0,e)*t.step.inv_dt,o=g.Vec2.AddVCrossSV(l,h,this.rA,m.solveVelocityConstraints_s_vpA),n=g.Vec2.AddVCrossSV(u,p,this.rB,m.solveVelocityConstraints_s_vpB),r=g.Vec2.DotVV(this.u,g.Vec2.SubVV(o,n,g.Vec2.s_t0)),a=-this.mass*(r+i),s=this.upperImpulse,this.upperImpulse=g.Max(0,this.upperImpulse+a),a=this.upperImpulse-s,g.Vec2.MulSV(-a,this.u,m.solveVelocityConstraints_s_P)):(o=g.Vec2.AddVCrossSV(l,h,this.rA,m.solveVelocityConstraints_s_vpA),n=g.Vec2.AddVCrossSV(u,p,this.rB,m.solveVelocityConstraints_s_vpB),r=g.Vec2.DotVV(this.u,g.Vec2.SubVV(n,o,g.Vec2.s_t0)),a=-this.mass*r,this.impulse+=a,g.Vec2.MulSV(a,this.u,m.solveVelocityConstraints_s_P)),l.selfMulSub(this.invMassA,c),h-=this.invIA*g.Vec2.CrossVV(this.rA,c),u.selfMulAdd(this.invMassB,c),p+=this.invIB*g.Vec2.CrossVV(this.rB,c),t.velocities[this.indexA].w=h,t.velocities[this.indexB].w=p},m.prototype.solvePositionConstraints=function(t){var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.positions[this.indexB].c,o=t.positions[this.indexB].a,n=this.qA.setAngle(i),r=this.qB.setAngle(o),a=g.Rot.mulRV(n,this.lalcA,this.rA),c=g.Rot.mulRV(r,this.lalcB,this.rB),l=this.u;l.x=s.x+c.x-e.x-a.x,l.y=s.y+c.y-e.y-a.y;var h,u=this.u.normalize();if(this.minLength==this.maxLength)h=u-this.minLength;else if(u<this.minLength)h=u-this.minLength;else{if(!(this.maxLength<u))return!0;h=u-this.maxLength}var p=-this.mass*h,d=g.Vec2.MulSV(p,l,m.solvePositionConstraints_s_P);return e.selfMulSub(this.invMassA,d),i-=this.invIA*g.Vec2.CrossVV(a,d),s.selfMulAdd(this.invMassB,d),o+=this.invIB*g.Vec2.CrossVV(c,d),t.positions[this.indexA].a=i,t.positions[this.indexB].a=o,g.Abs(h)<g.linearSlop},m.prototype.draw=function(t){var e=this.bodyA.getTransform(),i=this.bodyB.getTransform(),s=g.Transform.mulXV(e,this.localAnchorA,m.draw_s_pA),o=g.Transform.mulXV(i,this.localAnchorB,m.draw_s_pB),n=g.Vec2.SubVV(o,s,m.draw_s_axis);n.normalize();var r=m.draw_s_c1,a=m.draw_s_c2,c=m.draw_s_c3,l=m.draw_s_c4;t.drawSegment(s,o,l);var h,u,p=g.Vec2.AddVMulSV(s,this.length,n,m.draw_s_pRest);t.drawPoint(p,8,r),this.minLength!=this.maxLength&&(this.minLength>g.linearSlop&&(h=g.Vec2.AddVMulSV(s,this.minLength,n,m.draw_s_pMin),t.drawPoint(h,4,a)),this.maxLength<g.maxFloat&&(u=g.Vec2.AddVMulSV(s,this.maxLength,n,m.draw_s_pMax),t.drawPoint(u,4,c)))},m.initVelocityConstraints_s_P=new g.Vec2,m.solveVelocityConstraints_s_vpA=new g.Vec2,m.solveVelocityConstraints_s_vpB=new g.Vec2,m.solveVelocityConstraints_s_P=new g.Vec2,m.solvePositionConstraints_s_P=new g.Vec2,m.draw_s_pA=new g.Vec2,m.draw_s_pB=new g.Vec2,m.draw_s_axis=new g.Vec2,m.draw_s_c1=new g.Color(.7,.7,.7),m.draw_s_c2=new g.Color(.3,.9,.3),m.draw_s_c3=new g.Color(.9,.3,.3),m.draw_s_c4=new g.Color(.4,.4,.4),m.draw_s_pRest=new g.Vec2,m.draw_s_pMin=new g.Vec2,m.draw_s_pMax=new g.Vec2,m);function m(t){var e=s.call(this,t)||this;return e.stiffness=0,e.damping=0,e.bias=0,e.length=0,e.minLength=0,e.maxLength=0,e.localAnchorA=new g.Vec2,e.localAnchorB=new g.Vec2,e.gamma=0,e.impulse=0,e.lowerImpulse=0,e.upperImpulse=0,e.indexA=0,e.indexB=0,e.u=new g.Vec2,e.rA=new g.Vec2,e.rB=new g.Vec2,e.localCenterA=new g.Vec2,e.localCenterB=new g.Vec2,e.currentLength=0,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.softMass=0,e.mass=0,e.qA=new g.Rot,e.qB=new g.Rot,e.lalcA=new g.Vec2,e.lalcB=new g.Vec2,e.localAnchorA.copy(g.maybe(t.localAnchorA,g.Vec2.ZERO)),e.localAnchorB.copy(g.maybe(t.localAnchorB,g.Vec2.ZERO)),e.length=g.Max(g.maybe(t.length,e.GetCurrentLength()),g.linearSlop),e.minLength=g.Max(g.maybe(t.minLength,e.length),g.linearSlop),e.maxLength=g.Max(g.maybe(t.maxLength,e.length),e.minLength),e.stiffness=g.maybe(t.stiffness,0),e.damping=g.maybe(t.damping,0),e}g.DistanceJoint=o}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.create=function(){return new i},i.destroy=function(t){},i.prototype.evaluate=function(t,e,i){s.collideEdgeAndCircle(t,this.getShapeA(),e,this.getShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.EdgeAndCircleContact=e}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.create=function(){return new i},i.destroy=function(t){},i.prototype.evaluate=function(t,e,i){s.collideEdgeAndPolygon(t,this.getShapeA(),e,this.getShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.EdgeAndPolygonContact=e}(b2=b2||{}),function(v){var e,t=(e=v.JointDef,__extends(i,e),i.prototype.initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.getLocalPoint(i,this.localAnchorA),this.bodyB.getLocalPoint(i,this.localAnchorB)},i);function i(){var t=e.call(this,v.JointType.FrictionJoint)||this;return t.localAnchorA=new v.Vec2,t.localAnchorB=new v.Vec2,t.maxForce=0,t.maxTorque=0,t}v.FrictionJointDef=t;var s,o=(s=v.Joint,__extends(x,s),x.prototype.initVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.copy(this.bodyA.sweep.localCenter),this.localCenterB.copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].a,i=t.velocities[this.indexA].v,s=t.velocities[this.indexA].w,o=t.positions[this.indexB].a,n=t.velocities[this.indexB].v,r=t.velocities[this.indexB].w,a=this.qA.setAngle(e),c=this.qB.setAngle(o);v.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var l=v.Rot.mulRV(a,this.lalcA,this.rA);v.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var h,u=v.Rot.mulRV(c,this.lalcB,this.rB),p=this.invMassA,d=this.invMassB,f=this.invIA,y=this.invIB,V=this.K;V.ex.x=p+d+f*l.y*l.y+y*u.y*u.y,V.ex.y=-f*l.x*l.y-y*u.x*u.y,V.ey.x=V.ex.y,V.ey.y=p+d+f*l.x*l.x+y*u.x*u.x,V.getInverse(this.linearMass),this.angularMass=f+y,0<this.angularMass&&(this.angularMass=1/this.angularMass),t.step.warmStarting?(this.linearImpulse.selfMul(t.step.dtRatio),this.angularImpulse*=t.step.dtRatio,h=this.linearImpulse,i.selfMulSub(p,h),s-=f*(v.Vec2.CrossVV(this.rA,h)+this.angularImpulse),n.selfMulAdd(d,h),r+=y*(v.Vec2.CrossVV(this.rB,h)+this.angularImpulse)):(this.linearImpulse.setZero(),this.angularImpulse=0),t.velocities[this.indexA].w=s,t.velocities[this.indexB].w=r},x.prototype.solveVelocityConstraints=function(t){var e=t.velocities[this.indexA].v,i=t.velocities[this.indexA].w,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=this.invMassA,r=this.invMassB,a=this.invIA,c=this.invIB,l=t.step.dt,h=o-i,u=-this.angularMass*h,p=this.angularImpulse,d=l*this.maxTorque;this.angularImpulse=v.clamp(this.angularImpulse+u,-d,d),i-=a*(u=this.angularImpulse-p),o+=c*u;var f=v.Vec2.SubVV(v.Vec2.AddVCrossSV(s,o,this.rB,v.Vec2.s_t0),v.Vec2.AddVCrossSV(e,i,this.rA,v.Vec2.s_t1),x.solveVelocityConstraints_s_Cdot_v2),y=v.Mat22.mulMV(this.linearMass,f,x.solveVelocityConstraints_s_impulseV).selfNeg(),V=x.solveVelocityConstraints_s_oldImpulseV.copy(this.linearImpulse);this.linearImpulse.selfAdd(y);d=l*this.maxForce;this.linearImpulse.lengthSquared()>d*d&&(this.linearImpulse.normalize(),this.linearImpulse.selfMul(d)),v.Vec2.SubVV(this.linearImpulse,V,y),e.selfMulSub(n,y),i-=a*v.Vec2.CrossVV(this.rA,y),s.selfMulAdd(r,y),o+=c*v.Vec2.CrossVV(this.rB,y),t.velocities[this.indexA].w=i,t.velocities[this.indexB].w=o},x.prototype.solvePositionConstraints=function(t){return!0},x.prototype.getAnchorA=function(t){return this.bodyA.getWorldPoint(this.localAnchorA,t)},x.prototype.getAnchorB=function(t){return this.bodyB.getWorldPoint(this.localAnchorB,t)},x.prototype.getReactionForce=function(t,e){return e.x=t*this.linearImpulse.x,e.y=t*this.linearImpulse.y,e},x.prototype.getReactionTorque=function(t){return t*this.angularImpulse},x.prototype.dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: FrictionJointDef = new FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.maxForce),t("  jd.maxTorque = %.15f;\n",this.maxTorque),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},x.solveVelocityConstraints_s_Cdot_v2=new v.Vec2,x.solveVelocityConstraints_s_impulseV=new v.Vec2,x.solveVelocityConstraints_s_oldImpulseV=new v.Vec2,x);function x(t){var e=s.call(this,t)||this;return e.localAnchorA=new v.Vec2,e.localAnchorB=new v.Vec2,e.linearImpulse=new v.Vec2,e.angularImpulse=0,e.maxForce=0,e.maxTorque=0,e.indexA=0,e.indexB=0,e.rA=new v.Vec2,e.rB=new v.Vec2,e.localCenterA=new v.Vec2,e.localCenterB=new v.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.linearMass=new v.Mat22,e.angularMass=0,e.qA=new v.Rot,e.qB=new v.Rot,e.lalcA=new v.Vec2,e.lalcB=new v.Vec2,e.K=new v.Mat22,e.localAnchorA.copy(v.maybe(t.localAnchorA,v.Vec2.ZERO)),e.localAnchorB.copy(v.maybe(t.localAnchorB,v.Vec2.ZERO)),e.linearImpulse.setZero(),e.maxForce=v.maybe(t.maxForce,0),e.maxTorque=v.maybe(t.maxTorque,0),e.linearMass.setZero(),e}v.FrictionJoint=o}(b2=b2||{}),function(D){var e,t=(e=D.JointDef,__extends(i,e),i);function i(){var t=e.call(this,D.JointType.GearJoint)||this;return t.ratio=1,t}D.GearJointDef=t;var x,s=(x=D.Joint,__extends(L,x),L.prototype.initVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.indexC=this.bodyC.islandIndex,this.indexD=this.bodyD.islandIndex,this.lcA.copy(this.bodyA.sweep.localCenter),this.lcB.copy(this.bodyB.sweep.localCenter),this.lcC.copy(this.bodyC.sweep.localCenter),this.lcD.copy(this.bodyD.sweep.localCenter),this.mA=this.bodyA.invMass,this.mB=this.bodyB.invMass,this.mC=this.bodyC.invMass,this.mD=this.bodyD.invMass,this.iA=this.bodyA.invI,this.iB=this.bodyB.invI,this.iC=this.bodyC.invI,this.iD=this.bodyD.invI;var e,i,s,o,n,r=t.positions[this.indexA].a,a=t.velocities[this.indexA].v,c=t.velocities[this.indexA].w,l=t.positions[this.indexB].a,h=t.velocities[this.indexB].v,u=t.velocities[this.indexB].w,p=t.positions[this.indexC].a,d=t.velocities[this.indexC].v,f=t.velocities[this.indexC].w,y=t.positions[this.indexD].a,V=t.velocities[this.indexD].v,v=t.velocities[this.indexD].w,x=this.qA.setAngle(r),g=this.qB.setAngle(l),m=this.qC.setAngle(p),B=this.qD.setAngle(y);this.mass=0,this.typeA===D.JointType.RevoluteJoint?(this.JvAC.setZero(),this.JwA=1,this.JwC=1,this.mass+=this.iA+this.iC):(s=D.Rot.mulRV(m,this.localAxisC,L.initVelocityConstraints_s_u),D.Vec2.SubVV(this.localAnchorC,this.lcC,this.lalcC),e=D.Rot.mulRV(m,this.lalcC,L.initVelocityConstraints_s_rC),D.Vec2.SubVV(this.localAnchorA,this.lcA,this.lalcA),i=D.Rot.mulRV(x,this.lalcA,L.initVelocityConstraints_s_rA),this.JvAC.copy(s),this.JwC=D.Vec2.CrossVV(e,s),this.JwA=D.Vec2.CrossVV(i,s),this.mass+=this.mC+this.mA+this.iC*this.JwC*this.JwC+this.iA*this.JwA*this.JwA),this.typeB===D.JointType.RevoluteJoint?(this.JvBD.setZero(),this.JwB=this.ratio,this.JwD=this.ratio,this.mass+=this.ratio*this.ratio*(this.iB+this.iD)):(s=D.Rot.mulRV(B,this.localAxisD,L.initVelocityConstraints_s_u),D.Vec2.SubVV(this.localAnchorD,this.lcD,this.lalcD),o=D.Rot.mulRV(B,this.lalcD,L.initVelocityConstraints_s_rD),D.Vec2.SubVV(this.localAnchorB,this.lcB,this.lalcB),n=D.Rot.mulRV(g,this.lalcB,L.initVelocityConstraints_s_rB),D.Vec2.MulSV(this.ratio,s,this.JvBD),this.JwD=this.ratio*D.Vec2.CrossVV(o,s),this.JwB=this.ratio*D.Vec2.CrossVV(n,s),this.mass+=this.ratio*this.ratio*(this.mD+this.mB)+this.iD*this.JwD*this.JwD+this.iB*this.JwB*this.JwB),this.mass=0<this.mass?1/this.mass:0,t.step.warmStarting?(a.selfMulAdd(this.mA*this.impulse,this.JvAC),c+=this.iA*this.impulse*this.JwA,h.selfMulAdd(this.mB*this.impulse,this.JvBD),u+=this.iB*this.impulse*this.JwB,d.selfMulSub(this.mC*this.impulse,this.JvAC),f-=this.iC*this.impulse*this.JwC,V.selfMulSub(this.mD*this.impulse,this.JvBD),v-=this.iD*this.impulse*this.JwD):this.impulse=0,t.velocities[this.indexA].w=c,t.velocities[this.indexB].w=u,t.velocities[this.indexC].w=f,t.velocities[this.indexD].w=v},L.prototype.solveVelocityConstraints=function(t){var e=t.velocities[this.indexA].v,i=t.velocities[this.indexA].w,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=t.velocities[this.indexC].v,r=t.velocities[this.indexC].w,a=t.velocities[this.indexD].v,c=t.velocities[this.indexD].w,l=D.Vec2.DotVV(this.JvAC,D.Vec2.SubVV(e,n,D.Vec2.s_t0))+D.Vec2.DotVV(this.JvBD,D.Vec2.SubVV(s,a,D.Vec2.s_t0));l+=this.JwA*i-this.JwC*r+(this.JwB*o-this.JwD*c);var h=-this.mass*l;this.impulse+=h,e.selfMulAdd(this.mA*h,this.JvAC),i+=this.iA*h*this.JwA,s.selfMulAdd(this.mB*h,this.JvBD),o+=this.iB*h*this.JwB,n.selfMulSub(this.mC*h,this.JvAC),r-=this.iC*h*this.JwC,a.selfMulSub(this.mD*h,this.JvBD),c-=this.iD*h*this.JwD,t.velocities[this.indexA].w=i,t.velocities[this.indexB].w=o,t.velocities[this.indexC].w=r,t.velocities[this.indexD].w=c},L.prototype.solvePositionConstraints=function(t){var e,i,s,o,n,r,a,c,l,h,u,p,d,f,y,V=t.positions[this.indexA].c,v=t.positions[this.indexA].a,x=t.positions[this.indexB].c,g=t.positions[this.indexB].a,m=t.positions[this.indexC].c,B=t.positions[this.indexC].a,A=t.positions[this.indexD].c,w=t.positions[this.indexD].a,b=this.qA.setAngle(v),C=this.qB.setAngle(g),_=this.qC.setAngle(B),S=this.qD.setAngle(w),M=this.JvAC,P=this.JvBD,I=0;l=this.typeA===D.JointType.RevoluteJoint?(M.setZero(),s=e=1,I+=this.iA+this.iC,v-B-this.referenceAngleA):(h=D.Rot.mulRV(_,this.localAxisC,L.solvePositionConstraints_s_u),n=D.Rot.mulRV(_,this.lalcC,L.solvePositionConstraints_s_rC),r=D.Rot.mulRV(b,this.lalcA,L.solvePositionConstraints_s_rA),M.copy(h),s=D.Vec2.CrossVV(n,h),e=D.Vec2.CrossVV(r,h),I+=this.mC+this.mA+this.iC*s*s+this.iA*e*e,a=this.lalcC,c=D.Rot.mulTRV(_,D.Vec2.AddVV(r,D.Vec2.SubVV(V,m,D.Vec2.s_t0),D.Vec2.s_t0),D.Vec2.s_t0),D.Vec2.DotVV(D.Vec2.SubVV(c,a,D.Vec2.s_t0),this.localAxisC)),y=this.typeB===D.JointType.RevoluteJoint?(P.setZero(),i=this.ratio,o=this.ratio,I+=this.ratio*this.ratio*(this.iB+this.iD),g-w-this.referenceAngleB):(h=D.Rot.mulRV(S,this.localAxisD,L.solvePositionConstraints_s_u),u=D.Rot.mulRV(S,this.lalcD,L.solvePositionConstraints_s_rD),p=D.Rot.mulRV(C,this.lalcB,L.solvePositionConstraints_s_rB),D.Vec2.MulSV(this.ratio,h,P),o=this.ratio*D.Vec2.CrossVV(u,h),i=this.ratio*D.Vec2.CrossVV(p,h),I+=this.ratio*this.ratio*(this.mD+this.mB)+this.iD*o*o+this.iB*i*i,d=this.lalcD,f=D.Rot.mulTRV(S,D.Vec2.AddVV(p,D.Vec2.SubVV(x,A,D.Vec2.s_t0),D.Vec2.s_t0),D.Vec2.s_t0),D.Vec2.DotVV(D.Vec2.SubVV(f,d,D.Vec2.s_t0),this.localAxisD));var T=l+this.ratio*y-this.constant,F=0<I?-T/I:0;return V.selfMulAdd(this.mA*F,M),v+=this.iA*F*e,x.selfMulAdd(this.mB*F,P),g+=this.iB*F*i,m.selfMulSub(this.mC*F,M),B-=this.iC*F*s,A.selfMulSub(this.mD*F,P),w-=this.iD*F*o,t.positions[this.indexA].a=v,t.positions[this.indexB].a=g,t.positions[this.indexC].a=B,t.positions[this.indexD].a=w,0<D.linearSlop},L.prototype.getAnchorA=function(t){return this.bodyA.getWorldPoint(this.localAnchorA,t)},L.prototype.getAnchorB=function(t){return this.bodyB.getWorldPoint(this.localAnchorB,t)},L.prototype.getReactionForce=function(t,e){return D.Vec2.MulSV(t*this.impulse,this.JvAC,e)},L.prototype.getReactionTorque=function(t){return t*this.impulse*this.JwA},L.prototype.dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex,s=this.joint1.index,o=this.joint2.index;t("  const jd: GearJointDef = new GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",s),t("  jd.joint2 = joints[%d];\n",o),t("  jd.ratio = %.15f;\n",this.ratio),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},L.initVelocityConstraints_s_u=new D.Vec2,L.initVelocityConstraints_s_rA=new D.Vec2,L.initVelocityConstraints_s_rB=new D.Vec2,L.initVelocityConstraints_s_rC=new D.Vec2,L.initVelocityConstraints_s_rD=new D.Vec2,L.solvePositionConstraints_s_u=new D.Vec2,L.solvePositionConstraints_s_rA=new D.Vec2,L.solvePositionConstraints_s_rB=new D.Vec2,L.solvePositionConstraints_s_rC=new D.Vec2,L.solvePositionConstraints_s_rD=new D.Vec2,L);function L(t){var e=x.call(this,t)||this;e.typeA=D.JointType.UnknownJoint,e.typeB=D.JointType.UnknownJoint,e.localAnchorA=new D.Vec2,e.localAnchorB=new D.Vec2,e.localAnchorC=new D.Vec2,e.localAnchorD=new D.Vec2,e.localAxisC=new D.Vec2,e.localAxisD=new D.Vec2,e.referenceAngleA=0,e.referenceAngleB=0,e.constant=0,e.ratio=0,e.impulse=0,e.indexA=0,e.indexB=0,e.indexC=0,e.indexD=0,e.lcA=new D.Vec2,e.lcB=new D.Vec2,e.lcC=new D.Vec2,e.lcD=new D.Vec2,e.mA=0,e.mB=0,e.mC=0,e.mD=0,e.iA=0,e.iB=0,e.iC=0,e.iD=0,e.JvAC=new D.Vec2,e.JvBD=new D.Vec2,e.JwA=0,e.JwB=0,e.JwC=0,e.JwD=0,e.mass=0,e.qA=new D.Rot,e.qB=new D.Rot,e.qC=new D.Rot,e.qD=new D.Rot,e.lalcA=new D.Vec2,e.lalcB=new D.Vec2,e.lalcC=new D.Vec2,e.lalcD=new D.Vec2,e.joint1=t.joint1,e.joint2=t.joint2,e.typeA=e.joint1.getType(),e.typeB=e.joint2.getType(),e.bodyC=e.joint1.getBodyA(),e.bodyA=e.joint1.getBodyB();var i,s,o,n=e.bodyA.xf,r=e.bodyA.sweep.a,a=e.bodyC.xf,c=e.bodyC.sweep.a;o=e.typeA===D.JointType.RevoluteJoint?(l=t.joint1,e.localAnchorC.copy(l.localAnchorA),e.localAnchorA.copy(l.localAnchorB),e.referenceAngleA=l.referenceAngle,e.localAxisC.setZero(),r-c-e.referenceAngleA):(h=t.joint1,e.localAnchorC.copy(h.localAnchorA),e.localAnchorA.copy(h.localAnchorB),e.referenceAngleA=h.referenceAngle,e.localAxisC.copy(h.localXAxisA),i=e.localAnchorC,s=D.Rot.mulTRV(a.q,D.Vec2.AddVV(D.Rot.mulRV(n.q,e.localAnchorA,D.Vec2.s_t0),D.Vec2.SubVV(n.p,a.p,D.Vec2.s_t1),D.Vec2.s_t0),D.Vec2.s_t0),D.Vec2.DotVV(D.Vec2.SubVV(s,i,D.Vec2.s_t0),e.localAxisC)),e.bodyD=e.joint2.getBodyA(),e.bodyB=e.joint2.getBodyB();var l,h,u,p,d,f=e.bodyB.xf,y=e.bodyB.sweep.a,V=e.bodyD.xf,v=e.bodyD.sweep.a;return d=e.typeB===D.JointType.RevoluteJoint?(l=t.joint2,e.localAnchorD.copy(l.localAnchorA),e.localAnchorB.copy(l.localAnchorB),e.referenceAngleB=l.referenceAngle,e.localAxisD.setZero(),y-v-e.referenceAngleB):(h=t.joint2,e.localAnchorD.copy(h.localAnchorA),e.localAnchorB.copy(h.localAnchorB),e.referenceAngleB=h.referenceAngle,e.localAxisD.copy(h.localXAxisA),u=e.localAnchorD,p=D.Rot.mulTRV(V.q,D.Vec2.AddVV(D.Rot.mulRV(f.q,e.localAnchorB,D.Vec2.s_t0),D.Vec2.SubVV(f.p,V.p,D.Vec2.s_t1),D.Vec2.s_t0),D.Vec2.s_t0),D.Vec2.DotVV(D.Vec2.SubVV(p,u,D.Vec2.s_t0),e.localAxisD)),e.ratio=D.maybe(t.ratio,1),e.constant=o+e.ratio*d,e.impulse=0,e}D.GearJoint=s}(b2=b2||{}),function(S){var t=(M.prototype.initialize=function(t,e,i,s){if(this.bodyCapacity=t,this.contactCapacity=e,this.jointCapacity=i,this.bodyCount=0,this.contactCount=0,this.jointCount=0,this.listener=s,this.positions.length<t)for(var o=S.Max(2*this.positions.length,t);this.positions.length<o;)this.positions[this.positions.length]=new S.Position;if(this.velocities.length<t)for(o=S.Max(2*this.velocities.length,t);this.velocities.length<o;)this.velocities[this.velocities.length]=new S.Velocity},M.prototype.clear=function(){this.bodyCount=0,this.contactCount=0,this.jointCount=0},M.prototype.addBody=function(t){t.islandIndex=this.bodyCount,this.bodies[this.bodyCount++]=t},M.prototype.addContact=function(t){this.contacts[this.contactCount++]=t},M.prototype.addJoint=function(t){this.joints[this.jointCount++]=t},M.prototype.solve=function(t,e,i,s){for(var o=M.s_timer.reset(),n=e.dt,r=0;r<this.bodyCount;++r){var a=this.bodies[r];this.positions[r].c.copy(a.sweep.c);var c=a.sweep.a,l=this.velocities[r].v.copy(a.linearVelocity),h=a.angularVelocity;a.sweep.c0.copy(a.sweep.c),a.sweep.a0=a.sweep.a,a.type===S.BodyType.DynamicBody&&(l.x+=n*a.invMass*(a.gravityScale*a.mass*i.x+a.force.x),l.y+=n*a.invMass*(a.gravityScale*a.mass*i.y+a.force.y),h+=n*a.invI*a.torque,l.selfMul(1/(1+n*a.linearDamping)),h*=1/(1+n*a.angularDamping)),this.positions[r].a=c,this.velocities[r].w=h}o.reset();var u=M.s_solverData;u.step.copy(e),u.positions=this.positions,u.velocities=this.velocities;var p=M.s_contactSolverDef;p.step.copy(e),p.contacts=this.contacts,p.count=this.contactCount,p.positions=this.positions,p.velocities=this.velocities;var d=M.s_contactSolver.initialize(p);d.initializeVelocityConstraints(),e.warmStarting&&d.warmStart();for(r=0;r<this.jointCount;++r)this.joints[r].initVelocityConstraints(u);t.solveInit=o.getMilliseconds(),o.reset();for(r=0;r<e.velocityIterations;++r){for(var f=0;f<this.jointCount;++f)this.joints[f].solveVelocityConstraints(u);d.solveVelocityConstraints()}d.storeImpulses(),t.solveVelocity=o.getMilliseconds();for(r=0;r<this.bodyCount;++r){var y=this.positions[r].c,c=this.positions[r].a,l=this.velocities[r].v,h=this.velocities[r].w,V=S.Vec2.MulSV(n,l,M.s_translation);S.Vec2.DotVV(V,V)>S.maxTranslationSquared&&(v=S.maxTranslation/V.length(),l.selfMul(v));var v,x=n*h;x*x>S.maxRotationSquared&&(h*=v=S.maxRotation/S.Abs(x)),y.x+=n*l.x,y.y+=n*l.y,c+=n*h,this.positions[r].a=c,this.velocities[r].w=h}o.reset();for(var g=!1,r=0;r<e.positionIterations;++r){for(var m=d.solvePositionConstraints(),B=!0,f=0;f<this.jointCount;++f)var A=this.joints[f].solvePositionConstraints(u),B=B&&A;if(m&&B){g=!0;break}}for(r=0;r<this.bodyCount;++r){var w=this.bodies[r];w.sweep.c.copy(this.positions[r].c),w.sweep.a=this.positions[r].a,w.linearVelocity.copy(this.velocities[r].v),w.angularVelocity=this.velocities[r].w,w.synchronizeTransform()}if(t.solvePosition=o.getMilliseconds(),this.report(d.velocityConstraints),s){for(var b=S.maxFloat,C=S.linearSleepTolerance*S.linearSleepTolerance,_=S.angularSleepTolerance*S.angularSleepTolerance,r=0;r<this.bodyCount;++r){(a=this.bodies[r]).getType()!==S.BodyType.StaticBody&&(b=!a.autoSleepFlag||a.angularVelocity*a.angularVelocity>_||S.Vec2.DotVV(a.linearVelocity,a.linearVelocity)>C?a.sleepTime=0:(a.sleepTime+=n,S.Min(b,a.sleepTime)))}if(b>=S.timeToSleep&&g)for(r=0;r<this.bodyCount;++r){(a=this.bodies[r]).setAwake(!1)}}},M.prototype.solveTOI=function(t,e,i){for(var s=0;s<this.bodyCount;++s){var o=this.bodies[s];this.positions[s].c.copy(o.sweep.c),this.positions[s].a=o.sweep.a,this.velocities[s].v.copy(o.linearVelocity),this.velocities[s].w=o.angularVelocity}var n=M.s_contactSolverDef;n.contacts=this.contacts,n.count=this.contactCount,n.step.copy(t),n.positions=this.positions,n.velocities=this.velocities;for(var r=M.s_contactSolver.initialize(n),s=0;s<t.positionIterations;++s){if(r.solveTOIPositionConstraints(e,i))break}this.bodies[e].sweep.c0.copy(this.positions[e].c),this.bodies[e].sweep.a0=this.positions[e].a,this.bodies[i].sweep.c0.copy(this.positions[i].c),this.bodies[i].sweep.a0=this.positions[i].a,r.initializeVelocityConstraints();for(s=0;s<t.velocityIterations;++s)r.solveVelocityConstraints();for(var a=t.dt,s=0;s<this.bodyCount;++s){var c=this.positions[s].c,l=this.positions[s].a,h=this.velocities[s].v,u=this.velocities[s].w,p=S.Vec2.MulSV(a,h,M.s_translation);S.Vec2.DotVV(p,p)>S.maxTranslationSquared&&(d=S.maxTranslation/p.length(),h.selfMul(d));var d,f=a*u;f*f>S.maxRotationSquared&&(u*=d=S.maxRotation/S.Abs(f)),c.selfMulAdd(a,h),l+=a*u,this.positions[s].a=l,this.velocities[s].w=u;var y=this.bodies[s];y.sweep.c.copy(c),y.sweep.a=l,y.linearVelocity.copy(h),y.angularVelocity=u,y.synchronizeTransform()}this.report(r.velocityConstraints)},M.prototype.report=function(t){if(null!==this.listener)for(var e=0;e<this.contactCount;++e){var i=this.contacts[e];if(i){var s=t[e],o=M.s_impulse;o.count=s.pointCount;for(var n=0;n<s.pointCount;++n)o.normalImpulses[n]=s.points[n].normalImpulse,o.tangentImpulses[n]=s.points[n].tangentImpulse;this.listener.postSolve(i,o)}}},M.s_timer=new S.Timer,M.s_solverData=new S.SolverData,M.s_contactSolverDef=new S.ContactSolverDef,M.s_contactSolver=new S.ContactSolver,M.s_translation=new S.Vec2,M.s_impulse=new S.ContactImpulse,M);function M(){this.bodies=[],this.contacts=[],this.joints=[],this.positions=S.Position.makeArray(1024),this.velocities=S.Velocity.makeArray(1024),this.bodyCount=0,this.jointCount=0,this.contactCount=0,this.bodyCapacity=0,this.contactCapacity=0,this.jointCapacity=0}S.Island=t}(b2=b2||{}),function(m){var e,t=(e=m.JointDef,__extends(i,e),i.prototype.initialize=function(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.getLocalPoint(this.bodyB.getPosition(),this.linearOffset);var i=this.bodyA.getAngle(),s=this.bodyB.getAngle();this.angularOffset=s-i},i);function i(){var t=e.call(this,m.JointType.MotorJoint)||this;return t.linearOffset=new m.Vec2(0,0),t.angularOffset=0,t.maxForce=1,t.maxTorque=1,t.correctionFactor=.3,t}m.MotorJointDef=t;var s,o=(s=m.Joint,__extends(B,s),B.prototype.getAnchorA=function(t){var e=this.bodyA.getPosition();return t.x=e.x,t.y=e.y,t},B.prototype.getAnchorB=function(t){var e=this.bodyB.getPosition();return t.x=e.x,t.y=e.y,t},B.prototype.getReactionForce=function(t,e){return m.Vec2.MulSV(t,this.linearImpulse,e)},B.prototype.getReactionTorque=function(t){return t*this.angularImpulse},B.prototype.setLinearOffset=function(t){m.Vec2.IsEqualToV(t,this.linearOffset)||(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.linearOffset.copy(t))},B.prototype.getLinearOffset=function(){return this.linearOffset},B.prototype.setAngularOffset=function(t){t!==this.angularOffset&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.angularOffset=t)},B.prototype.getAngularOffset=function(){return this.angularOffset},B.prototype.setMaxForce=function(t){this.maxForce=t},B.prototype.getMaxForce=function(){return this.maxForce},B.prototype.setMaxTorque=function(t){this.maxTorque=t},B.prototype.getMaxTorque=function(){return this.maxTorque},B.prototype.initVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.copy(this.bodyA.sweep.localCenter),this.localCenterB.copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e,i=t.positions[this.indexA].c,s=t.positions[this.indexA].a,o=t.velocities[this.indexA].v,n=t.velocities[this.indexA].w,r=t.positions[this.indexB].c,a=t.positions[this.indexB].a,c=t.velocities[this.indexB].v,l=t.velocities[this.indexB].w,h=this.qA.setAngle(s),u=this.qB.setAngle(a),p=m.Rot.mulRV(h,m.Vec2.SubVV(this.linearOffset,this.localCenterA,m.Vec2.s_t0),this.rA),d=m.Rot.mulRV(u,m.Vec2.NegV(this.localCenterB,m.Vec2.s_t0),this.rB),f=this.invMassA,y=this.invMassB,V=this.invIA,v=this.invIB,x=this.K;x.ex.x=f+y+V*p.y*p.y+v*d.y*d.y,x.ex.y=-V*p.x*p.y-v*d.x*d.y,x.ey.x=x.ex.y,x.ey.y=f+y+V*p.x*p.x+v*d.x*d.x,x.getInverse(this.linearMass),this.angularMass=V+v,0<this.angularMass&&(this.angularMass=1/this.angularMass),m.Vec2.SubVV(m.Vec2.AddVV(r,d,m.Vec2.s_t0),m.Vec2.AddVV(i,p,m.Vec2.s_t1),this.linearError),this.angularError=a-s-this.angularOffset,t.step.warmStarting?(this.linearImpulse.selfMul(t.step.dtRatio),this.angularImpulse*=t.step.dtRatio,e=this.linearImpulse,o.selfMulSub(f,e),n-=V*(m.Vec2.CrossVV(p,e)+this.angularImpulse),c.selfMulAdd(y,e),l+=v*(m.Vec2.CrossVV(d,e)+this.angularImpulse)):(this.linearImpulse.setZero(),this.angularImpulse=0),t.velocities[this.indexA].w=n,t.velocities[this.indexB].w=l},B.prototype.solveVelocityConstraints=function(t){var e=t.velocities[this.indexA].v,i=t.velocities[this.indexA].w,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=this.invMassA,r=this.invMassB,a=this.invIA,c=this.invIB,l=t.step.dt,h=t.step.inv_dt,u=o-i+h*this.correctionFactor*this.angularError,p=-this.angularMass*u,d=this.angularImpulse,f=l*this.maxTorque;this.angularImpulse=m.clamp(this.angularImpulse+p,-f,f),i-=a*(p=this.angularImpulse-d),o+=c*p;var y=this.rA,V=this.rB,v=m.Vec2.AddVV(m.Vec2.SubVV(m.Vec2.AddVV(s,m.Vec2.CrossSV(o,V,m.Vec2.s_t0),m.Vec2.s_t0),m.Vec2.AddVV(e,m.Vec2.CrossSV(i,y,m.Vec2.s_t1),m.Vec2.s_t1),m.Vec2.s_t2),m.Vec2.MulSV(h*this.correctionFactor,this.linearError,m.Vec2.s_t3),B.solveVelocityConstraints_s_Cdot_v2),x=m.Mat22.mulMV(this.linearMass,v,B.solveVelocityConstraints_s_impulse_v2).selfNeg(),g=B.solveVelocityConstraints_s_oldImpulse_v2.copy(this.linearImpulse);this.linearImpulse.selfAdd(x);f=l*this.maxForce;this.linearImpulse.lengthSquared()>f*f&&(this.linearImpulse.normalize(),this.linearImpulse.selfMul(f)),m.Vec2.SubVV(this.linearImpulse,g,x),e.selfMulSub(n,x),i-=a*m.Vec2.CrossVV(y,x),s.selfMulAdd(r,x),o+=c*m.Vec2.CrossVV(V,x),t.velocities[this.indexA].w=i,t.velocities[this.indexB].w=o},B.prototype.solvePositionConstraints=function(t){return!0},B.prototype.dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: MotorJointDef = new MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.linearOffset.x,this.linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.angularOffset),t("  jd.maxForce = %.15f;\n",this.maxForce),t("  jd.maxTorque = %.15f;\n",this.maxTorque),t("  jd.correctionFactor = %.15f;\n",this.correctionFactor),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},B.solveVelocityConstraints_s_Cdot_v2=new m.Vec2,B.solveVelocityConstraints_s_impulse_v2=new m.Vec2,B.solveVelocityConstraints_s_oldImpulse_v2=new m.Vec2,B);function B(t){var e=s.call(this,t)||this;return e.linearOffset=new m.Vec2,e.angularOffset=0,e.linearImpulse=new m.Vec2,e.angularImpulse=0,e.maxForce=0,e.maxTorque=0,e.correctionFactor=.3,e.indexA=0,e.indexB=0,e.rA=new m.Vec2,e.rB=new m.Vec2,e.localCenterA=new m.Vec2,e.localCenterB=new m.Vec2,e.linearError=new m.Vec2,e.angularError=0,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.linearMass=new m.Mat22,e.angularMass=0,e.qA=new m.Rot,e.qB=new m.Rot,e.K=new m.Mat22,e.linearOffset.copy(m.maybe(t.linearOffset,m.Vec2.ZERO)),e.linearImpulse.setZero(),e.maxForce=m.maybe(t.maxForce,0),e.maxTorque=m.maybe(t.maxTorque,0),e.correctionFactor=m.maybe(t.correctionFactor,.3),e}m.MotorJoint=o}(b2=b2||{}),function(p){var e,t=(e=p.JointDef,__extends(i,e),i);function i(){var t=e.call(this,p.JointType.MouseJoint)||this;return t.target=new p.Vec2,t.maxForce=0,t.stiffness=5,t.damping=.7,t}p.MouseJointDef=t;var s,o=(s=p.Joint,__extends(a,s),a.prototype.setTarget=function(t){this.bodyB.isAwake()||this.bodyB.setAwake(!0),this.targetA.copy(t)},a.prototype.getTarget=function(){return this.targetA},a.prototype.setMaxForce=function(t){this.maxForce=t},a.prototype.getMaxForce=function(){return this.maxForce},a.prototype.setStiffness=function(t){this.stiffness=t},a.prototype.getStiffness=function(){return this.stiffness},a.prototype.setDamping=function(t){this.damping=t},a.prototype.getDamping=function(){return this.damping},a.prototype.initVelocityConstraints=function(t){this.indexB=this.bodyB.islandIndex,this.localCenterB.copy(this.bodyB.sweep.localCenter),this.invMassB=this.bodyB.invMass,this.invIB=this.bodyB.invI;var e=t.positions[this.indexB].c,i=t.positions[this.indexB].a,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=this.qB.setAngle(i),r=this.bodyB.getMass(),a=2*p.pi*this.stiffness,c=2*r*this.damping*a,l=r*(a*a),h=t.step.dt;this.gamma=h*(c+h*l),0!==this.gamma&&(this.gamma=1/this.gamma),this.beta=h*l*this.gamma,p.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),p.Rot.mulRV(n,this.lalcB,this.rB);var u=this.K;u.ex.x=this.invMassB+this.invIB*this.rB.y*this.rB.y+this.gamma,u.ex.y=-this.invIB*this.rB.x*this.rB.y,u.ey.x=u.ex.y,u.ey.y=this.invMassB+this.invIB*this.rB.x*this.rB.x+this.gamma,u.getInverse(this.mass),this.C.x=e.x+this.rB.x-this.targetA.x,this.C.y=e.y+this.rB.y-this.targetA.y,this.C.selfMul(this.beta),o*=.98,t.step.warmStarting?(this.impulse.selfMul(t.step.dtRatio),s.x+=this.invMassB*this.impulse.x,s.y+=this.invMassB*this.impulse.y,o+=this.invIB*p.Vec2.CrossVV(this.rB,this.impulse)):this.impulse.setZero(),t.velocities[this.indexB].w=o},a.prototype.solveVelocityConstraints=function(t){var e=t.velocities[this.indexB].v,i=t.velocities[this.indexB].w,s=p.Vec2.AddVCrossSV(e,i,this.rB,a.solveVelocityConstraints_s_Cdot),o=p.Mat22.mulMV(this.mass,p.Vec2.AddVV(s,p.Vec2.AddVV(this.C,p.Vec2.MulSV(this.gamma,this.impulse,p.Vec2.s_t0),p.Vec2.s_t0),p.Vec2.s_t0).selfNeg(),a.solveVelocityConstraints_s_impulse),n=a.solveVelocityConstraints_s_oldImpulse.copy(this.impulse);this.impulse.selfAdd(o);var r=t.step.dt*this.maxForce;this.impulse.lengthSquared()>r*r&&this.impulse.selfMul(r/this.impulse.length()),p.Vec2.SubVV(this.impulse,n,o),e.selfMulAdd(this.invMassB,o),i+=this.invIB*p.Vec2.CrossVV(this.rB,o),t.velocities[this.indexB].w=i},a.prototype.solvePositionConstraints=function(t){return!0},a.prototype.getAnchorA=function(t){return t.x=this.targetA.x,t.y=this.targetA.y,t},a.prototype.getAnchorB=function(t){return this.bodyB.getWorldPoint(this.localAnchorB,t)},a.prototype.getReactionForce=function(t,e){return p.Vec2.MulSV(t,this.impulse,e)},a.prototype.getReactionTorque=function(t){return 0},a.prototype.dump=function(t){t("Mouse joint dumping is not supported.\n")},a.prototype.shiftOrigin=function(t){this.targetA.selfSub(t)},a.solveVelocityConstraints_s_Cdot=new p.Vec2,a.solveVelocityConstraints_s_impulse=new p.Vec2,a.solveVelocityConstraints_s_oldImpulse=new p.Vec2,a);function a(t){var e=s.call(this,t)||this;return e.localAnchorB=new p.Vec2,e.targetA=new p.Vec2,e.stiffness=0,e.damping=0,e.beta=0,e.impulse=new p.Vec2,e.maxForce=0,e.gamma=0,e.indexA=0,e.indexB=0,e.rB=new p.Vec2,e.localCenterB=new p.Vec2,e.invMassB=0,e.invIB=0,e.mass=new p.Mat22,e.C=new p.Vec2,e.qB=new p.Rot,e.lalcB=new p.Vec2,e.K=new p.Mat22,e.targetA.copy(p.maybe(t.target,p.Vec2.ZERO)),p.Transform.mulTXV(e.bodyB.getTransform(),e.targetA,e.localAnchorB),e.maxForce=p.maybe(t.maxForce,0),e.impulse.setZero(),e.stiffness=p.maybe(t.stiffness,0),e.damping=p.maybe(t.damping,0),e.beta=0,e.gamma=0,e}p.MouseJoint=o}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.create=function(){return new i},i.destroy=function(t){},i.prototype.evaluate=function(t,e,i){s.collidePolygonAndCircle(t,this.getShapeA(),e,this.getShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.PolygonAndCircleContact=e}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.create=function(){return new i},i.destroy=function(t){},i.prototype.evaluate=function(t,e,i){s.collidePolygons(t,this.getShapeA(),e,this.getShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.PolygonContact=e}(b2=b2||{}),function(z){var e,t=(e=z.JointDef,__extends(i,e),i.prototype.initialize=function(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.getLocalPoint(i,this.localAnchorA),this.bodyB.getLocalPoint(i,this.localAnchorB),this.bodyA.getLocalVector(s,this.localAxisA),this.referenceAngle=this.bodyB.getAngle()-this.bodyA.getAngle()},i);function i(){var t=e.call(this,z.JointType.PrismaticJoint)||this;return t.localAnchorA=new z.Vec2,t.localAnchorB=new z.Vec2,t.localAxisA=new z.Vec2(1,0),t.referenceAngle=0,t.enableLimit=!1,t.lowerTranslation=0,t.upperTranslation=0,t.enableMotor=!1,t.maxMotorForce=0,t.motorSpeed=0,t}z.PrismaticJointDef=t;var s,o=(s=z.Joint,__extends(j,s),j.prototype.initVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.copy(this.bodyA.sweep.localCenter),this.localCenterB.copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.velocities[this.indexA].v,o=t.velocities[this.indexA].w,n=t.positions[this.indexB].c,r=t.positions[this.indexB].a,a=t.velocities[this.indexB].v,c=t.velocities[this.indexB].w,l=this.qA.setAngle(i),h=this.qB.setAngle(r);z.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var u=z.Rot.mulRV(l,this.lalcA,this.rA);z.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var p,d,f,y,V=z.Rot.mulRV(h,this.lalcB,this.rB),v=z.Vec2.AddVV(z.Vec2.SubVV(n,e,z.Vec2.s_t0),z.Vec2.SubVV(V,u,z.Vec2.s_t1),j.initVelocityConstraints_s_d),x=this.invMassA,g=this.invMassB,m=this.invIA,B=this.invIB;z.Rot.mulRV(l,this.localXAxisA,this.axis),this.a1=z.Vec2.CrossVV(z.Vec2.AddVV(v,u,z.Vec2.s_t0),this.axis),this.a2=z.Vec2.CrossVV(V,this.axis),this.axialMass=x+g+m*this.a1*this.a1+B*this.a2*this.a2,0<this.axialMass&&(this.axialMass=1/this.axialMass),z.Rot.mulRV(l,this.localYAxisA,this.perp),this.s1=z.Vec2.CrossVV(z.Vec2.AddVV(v,u,z.Vec2.s_t0),this.perp),this.s2=z.Vec2.CrossVV(V,this.perp),this.K.ex.x=x+g+m*this.s1*this.s1+B*this.s2*this.s2,this.K.ex.y=m*this.s1+B*this.s2,this.K.ey.x=this.K.ex.y,this.K.ey.y=m+B,0===this.K.ey.y&&(this.K.ey.y=1),this.enableLimit?this.translation=z.Vec2.DotVV(this.axis,v):(this.lowerImpulse=0,this.upperImpulse=0),this.enableMotor||(this.motorImpulse=0),t.step.warmStarting?(this.impulse.selfMul(t.step.dtRatio),this.motorImpulse*=t.step.dtRatio,this.lowerImpulse*=t.step.dtRatio,this.upperImpulse*=t.step.dtRatio,p=this.motorImpulse+this.lowerImpulse-this.upperImpulse,d=z.Vec2.AddVV(z.Vec2.MulSV(this.impulse.x,this.perp,z.Vec2.s_t0),z.Vec2.MulSV(p,this.axis,z.Vec2.s_t1),j.initVelocityConstraints_s_P),f=this.impulse.x*this.s1+this.impulse.y+p*this.a1,y=this.impulse.x*this.s2+this.impulse.y+p*this.a2,s.selfMulSub(x,d),o-=m*f,a.selfMulAdd(g,d),c+=B*y):(this.impulse.setZero(),this.motorImpulse=0,this.lowerImpulse=0,this.upperImpulse=0),t.velocities[this.indexA].w=o,t.velocities[this.indexB].w=c},j.prototype.solveVelocityConstraints=function(t){var e,i,s,o,n,r=t.velocities[this.indexA].v,a=t.velocities[this.indexA].w,c=t.velocities[this.indexB].v,l=t.velocities[this.indexB].w,h=this.invMassA,u=this.invMassB,p=this.invIA,d=this.invIB;this.enableMotor&&(s=z.Vec2.DotVV(this.axis,z.Vec2.SubVV(c,r,z.Vec2.s_t0))+this.a2*l-this.a1*a,o=this.axialMass*(this.motorSpeed-s),n=this.motorImpulse,e=t.step.dt*this.maxMotorForce,this.motorImpulse=z.clamp(this.motorImpulse+o,-e,e),o=this.motorImpulse-n,v=z.Vec2.MulSV(o,this.axis,j.solveVelocityConstraints_s_P),x=o*this.a1,g=o*this.a2,r.selfMulSub(h,v),a-=p*x,c.selfMulAdd(u,v),l+=d*g),this.enableLimit&&(i=this.translation-this.lowerTranslation,s=z.Vec2.DotVV(this.axis,z.Vec2.SubVV(c,r,z.Vec2.s_t0))+this.a2*l-this.a1*a,o=-this.axialMass*(s+z.Max(i,0)*t.step.inv_dt),n=this.lowerImpulse,this.lowerImpulse=z.Max(this.lowerImpulse+o,0),o=this.lowerImpulse-n,v=z.Vec2.MulSV(o,this.axis,j.solveVelocityConstraints_s_P),x=o*this.a1,g=o*this.a2,r.selfMulSub(h,v),a-=p*x,c.selfMulAdd(u,v),l+=d*g,i=this.upperTranslation-this.translation,s=z.Vec2.DotVV(this.axis,z.Vec2.SubVV(r,c,z.Vec2.s_t0))+this.a1*a-this.a2*l,o=-this.axialMass*(s+z.Max(i,0)*t.step.inv_dt),n=this.upperImpulse,this.upperImpulse=z.Max(this.upperImpulse+o,0),o=this.upperImpulse-n,v=z.Vec2.MulSV(o,this.axis,j.solveVelocityConstraints_s_P),x=o*this.a1,g=o*this.a2,r.selfMulAdd(h,v),a+=p*x,c.selfMulSub(u,v),l-=d*g);var f=z.Vec2.DotVV(this.perp,z.Vec2.SubVV(c,r,z.Vec2.s_t0))+this.s2*l-this.s1*a,y=l-a,V=this.K.solve(-f,-y,j.solveVelocityConstraints_s_df);this.impulse.selfAdd(V);var v=z.Vec2.MulSV(V.x,this.perp,j.solveVelocityConstraints_s_P),x=V.x*this.s1+V.y,g=V.x*this.s2+V.y;r.selfMulSub(h,v),a-=p*x,c.selfMulAdd(u,v),l+=d*g,t.velocities[this.indexA].w=a,t.velocities[this.indexB].w=l},j.prototype.solvePositionConstraints=function(t){var e,i,s,o,n,r,a,c,l,h,u=t.positions[this.indexA].c,p=t.positions[this.indexA].a,d=t.positions[this.indexB].c,f=t.positions[this.indexB].a,y=this.qA.setAngle(p),V=this.qB.setAngle(f),v=this.invMassA,x=this.invMassB,g=this.invIA,m=this.invIB,B=z.Rot.mulRV(y,this.lalcA,this.rA),A=z.Rot.mulRV(V,this.lalcB,this.rB),w=z.Vec2.SubVV(z.Vec2.AddVV(d,A,z.Vec2.s_t0),z.Vec2.AddVV(u,B,z.Vec2.s_t1),j.solvePositionConstraints_s_d),b=z.Rot.mulRV(y,this.localXAxisA,this.axis),C=z.Vec2.CrossVV(z.Vec2.AddVV(w,B,z.Vec2.s_t0),b),_=z.Vec2.CrossVV(A,b),S=z.Rot.mulRV(y,this.localYAxisA,this.perp),M=z.Vec2.CrossVV(z.Vec2.AddVV(w,B,z.Vec2.s_t0),S),P=z.Vec2.CrossVV(A,S),I=j.solvePositionConstraints_s_impulse,T=z.Vec2.DotVV(S,w),F=f-p-this.referenceAngle,D=z.Abs(T),L=z.Abs(F),R=!1,k=0;this.enableLimit&&(e=z.Vec2.DotVV(b,w),z.Abs(this.upperTranslation-this.lowerTranslation)<2*z.linearSlop?(k=e,D=z.Max(D,z.Abs(e)),R=!0):e<=this.lowerTranslation?(k=z.Min(e-this.lowerTranslation,0),D=z.Max(D,this.lowerTranslation-e),R=!0):e>=this.upperTranslation&&(k=z.Max(e-this.upperTranslation,0),D=z.Max(D,e-this.upperTranslation),R=!0)),R?(r=v+x+g*M*M+m*P*P,a=g*M+m*P,i=g*M*C+m*P*_,0===(c=g+m)&&(c=1),s=g*C+m*_,o=v+x+g*C*C+m*_*_,(n=this.K3).ex.setXYZ(r,a,i),n.ey.setXYZ(a,c,s),n.ez.setXYZ(i,s,o),I=n.solve33(-T,-F,-k,I)):(r=v+x+g*M*M+m*P*P,a=g*M+m*P,0===(c=g+m)&&(c=1),(l=this.K2).ex.set(r,a),l.ey.set(a,c),h=l.solve(-T,-F,j.solvePositionConstraints_s_impulse1),I.x=h.x,I.y=h.y,I.z=0);var q=z.Vec2.AddVV(z.Vec2.MulSV(I.x,S,z.Vec2.s_t0),z.Vec2.MulSV(I.z,b,z.Vec2.s_t1),j.solvePositionConstraints_s_P),J=I.x*M+I.y+I.z*C,E=I.x*P+I.y+I.z*_;return u.selfMulSub(v,q),p-=g*J,d.selfMulAdd(x,q),f+=m*E,t.positions[this.indexA].a=p,t.positions[this.indexB].a=f,D<=z.linearSlop&&L<=z.angularSlop},j.prototype.getAnchorA=function(t){return this.bodyA.getWorldPoint(this.localAnchorA,t)},j.prototype.getAnchorB=function(t){return this.bodyB.getWorldPoint(this.localAnchorB,t)},j.prototype.getReactionForce=function(t,e){return e.x=t*(this.impulse.x*this.perp.x+(this.motorImpulse+this.lowerImpulse-this.upperImpulse)*this.axis.x),e.y=t*(this.impulse.y*this.perp.y+(this.motorImpulse+this.lowerImpulse-this.upperImpulse)*this.axis.y),e},j.prototype.getReactionTorque=function(t){return t*this.impulse.y},j.prototype.getJointTranslation=function(){var t=this.bodyA.getWorldPoint(this.localAnchorA,j.getJointTranslation_s_pA),e=this.bodyB.getWorldPoint(this.localAnchorB,j.getJointTranslation_s_pB),i=z.Vec2.SubVV(e,t,j.getJointTranslation_s_d),s=this.bodyA.getWorldVector(this.localXAxisA,j.getJointTranslation_s_axis);return z.Vec2.DotVV(i,s)},j.prototype.getJointSpeed=function(){var t=this.bodyA,e=this.bodyB;z.Vec2.SubVV(this.localAnchorA,t.sweep.localCenter,this.lalcA);var i=z.Rot.mulRV(t.xf.q,this.lalcA,this.rA);z.Vec2.SubVV(this.localAnchorB,e.sweep.localCenter,this.lalcB);var s=z.Rot.mulRV(e.xf.q,this.lalcB,this.rB),o=z.Vec2.AddVV(t.sweep.c,i,z.Vec2.s_t0),n=z.Vec2.AddVV(e.sweep.c,s,z.Vec2.s_t1),r=z.Vec2.SubVV(n,o,z.Vec2.s_t2),a=t.getWorldVector(this.localXAxisA,this.axis),c=t.linearVelocity,l=e.linearVelocity,h=t.angularVelocity,u=e.angularVelocity;return z.Vec2.DotVV(r,z.Vec2.CrossSV(h,a,z.Vec2.s_t0))+z.Vec2.DotVV(a,z.Vec2.SubVV(z.Vec2.AddVCrossSV(l,u,s,z.Vec2.s_t0),z.Vec2.AddVCrossSV(c,h,i,z.Vec2.s_t1),z.Vec2.s_t0))},j.prototype.isLimitEnabled=function(){return this.enableLimit},j.prototype.setEnableLimit=function(t){t!==this.enableLimit&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.enableLimit=t,this.lowerImpulse=0,this.upperImpulse=0)},j.prototype.getLowerLimit=function(){return this.lowerTranslation},j.prototype.getUpperLimit=function(){return this.upperTranslation},j.prototype.setLimits=function(t,e){t===this.lowerTranslation&&e===this.upperTranslation||(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.lowerTranslation=t,this.upperTranslation=e,this.lowerImpulse=0,this.upperImpulse=0)},j.prototype.isMotorEnabled=function(){return this.enableMotor},j.prototype.setEnableMotor=function(t){t!==this.enableMotor&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.enableMotor=t)},j.prototype.setMotorSpeed=function(t){t!==this.motorSpeed&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.motorSpeed=t)},j.prototype.getMotorSpeed=function(){return this.motorSpeed},j.prototype.setMaxMotorForce=function(t){t!==this.maxMotorForce&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.maxMotorForce=t)},j.prototype.getMaxMotorForce=function(){return this.maxMotorForce},j.prototype.getMotorForce=function(t){return t*this.motorImpulse},j.prototype.dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: PrismaticJointDef = new PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.localXAxisA.x,this.localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.referenceAngle),t("  jd.enableLimit = %s;\n",this.enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.upperTranslation),t("  jd.enableMotor = %s;\n",this.enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.maxMotorForce),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},j.prototype.draw=function(t){var e,i,s,o=this.bodyA.getTransform(),n=this.bodyB.getTransform(),r=z.Transform.mulXV(o,this.localAnchorA,j.draw_s_pA),a=z.Transform.mulXV(n,this.localAnchorB,j.draw_s_pB),c=z.Rot.mulRV(o.q,this.localXAxisA,j.draw_s_axis),l=j.draw_s_c1,h=j.draw_s_c2,u=j.draw_s_c3,p=j.draw_s_c4,d=j.draw_s_c5;t.drawSegment(r,a,d),this.enableLimit?(e=z.Vec2.AddVMulSV(r,this.lowerTranslation,c,j.draw_s_lower),i=z.Vec2.AddVMulSV(r,this.upperTranslation,c,j.draw_s_upper),s=z.Rot.mulRV(o.q,this.localYAxisA,j.draw_s_perp),t.drawSegment(e,i,l),t.drawSegment(z.Vec2.AddVMulSV(e,-.5,s,z.Vec2.s_t0),z.Vec2.AddVMulSV(e,.5,s,z.Vec2.s_t1),h),t.drawSegment(z.Vec2.AddVMulSV(i,-.5,s,z.Vec2.s_t0),z.Vec2.AddVMulSV(i,.5,s,z.Vec2.s_t1),u)):t.drawSegment(z.Vec2.AddVMulSV(r,-1,c,z.Vec2.s_t0),z.Vec2.AddVMulSV(r,1,c,z.Vec2.s_t1),l),t.drawPoint(r,5,l),t.drawPoint(a,5,p)},j.initVelocityConstraints_s_d=new z.Vec2,j.initVelocityConstraints_s_P=new z.Vec2,j.solveVelocityConstraints_s_P=new z.Vec2,j.solveVelocityConstraints_s_df=new z.Vec2,j.solvePositionConstraints_s_d=new z.Vec2,j.solvePositionConstraints_s_impulse=new z.Vec3,j.solvePositionConstraints_s_impulse1=new z.Vec2,j.solvePositionConstraints_s_P=new z.Vec2,j.getJointTranslation_s_pA=new z.Vec2,j.getJointTranslation_s_pB=new z.Vec2,j.getJointTranslation_s_d=new z.Vec2,j.getJointTranslation_s_axis=new z.Vec2,j.draw_s_pA=new z.Vec2,j.draw_s_pB=new z.Vec2,j.draw_s_axis=new z.Vec2,j.draw_s_c1=new z.Color(.7,.7,.7),j.draw_s_c2=new z.Color(.3,.9,.3),j.draw_s_c3=new z.Color(.9,.3,.3),j.draw_s_c4=new z.Color(.3,.3,.9),j.draw_s_c5=new z.Color(.4,.4,.4),j.draw_s_lower=new z.Vec2,j.draw_s_upper=new z.Vec2,j.draw_s_perp=new z.Vec2,j);function j(t){var e=s.call(this,t)||this;return e.localAnchorA=new z.Vec2,e.localAnchorB=new z.Vec2,e.localXAxisA=new z.Vec2,e.localYAxisA=new z.Vec2,e.referenceAngle=0,e.impulse=new z.Vec2(0,0),e.motorImpulse=0,e.lowerImpulse=0,e.upperImpulse=0,e.lowerTranslation=0,e.upperTranslation=0,e.maxMotorForce=0,e.motorSpeed=0,e.enableLimit=!1,e.enableMotor=!1,e.indexA=0,e.indexB=0,e.localCenterA=new z.Vec2,e.localCenterB=new z.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.axis=new z.Vec2(0,0),e.perp=new z.Vec2(0,0),e.s1=0,e.s2=0,e.a1=0,e.a2=0,e.K=new z.Mat22,e.K3=new z.Mat33,e.K2=new z.Mat22,e.translation=0,e.axialMass=0,e.qA=new z.Rot,e.qB=new z.Rot,e.lalcA=new z.Vec2,e.lalcB=new z.Vec2,e.rA=new z.Vec2,e.rB=new z.Vec2,e.localAnchorA.copy(z.maybe(t.localAnchorA,z.Vec2.ZERO)),e.localAnchorB.copy(z.maybe(t.localAnchorB,z.Vec2.ZERO)),e.localXAxisA.copy(z.maybe(t.localAxisA,new z.Vec2(1,0))).selfNormalize(),z.Vec2.CrossOneV(e.localXAxisA,e.localYAxisA),e.referenceAngle=z.maybe(t.referenceAngle,0),e.lowerTranslation=z.maybe(t.lowerTranslation,0),e.upperTranslation=z.maybe(t.upperTranslation,0),e.maxMotorForce=z.maybe(t.maxMotorForce,0),e.motorSpeed=z.maybe(t.motorSpeed,0),e.enableLimit=z.maybe(t.enableLimit,!1),e.enableMotor=z.maybe(t.enableMotor,!1),e}z.PrismaticJoint=o}(b2=b2||{}),function(w){w.minPulleyLength=2;var e,t=(e=w.JointDef,__extends(i,e),i.prototype.initialize=function(t,e,i,s,o,n,r){this.bodyA=t,this.bodyB=e,this.groundAnchorA.copy(i),this.groundAnchorB.copy(s),this.bodyA.getLocalPoint(o,this.localAnchorA),this.bodyB.getLocalPoint(n,this.localAnchorB),this.lengthA=w.Vec2.DistanceVV(o,i),this.lengthB=w.Vec2.DistanceVV(n,s),this.ratio=r},i);function i(){var t=e.call(this,w.JointType.PulleyJoint)||this;return t.groundAnchorA=new w.Vec2(-1,1),t.groundAnchorB=new w.Vec2(1,1),t.localAnchorA=new w.Vec2(-1,0),t.localAnchorB=new w.Vec2(1,0),t.lengthA=0,t.lengthB=0,t.ratio=1,t.collideConnected=!0,t}w.PulleyJointDef=t;var s,o=(s=w.Joint,__extends(b,s),b.prototype.initVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.copy(this.bodyA.sweep.localCenter),this.localCenterB.copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.velocities[this.indexA].v,o=t.velocities[this.indexA].w,n=t.positions[this.indexB].c,r=t.positions[this.indexB].a,a=t.velocities[this.indexB].v,c=t.velocities[this.indexB].w,l=this.qA.setAngle(i),h=this.qB.setAngle(r);w.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),w.Rot.mulRV(l,this.lalcA,this.rA),w.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),w.Rot.mulRV(h,this.lalcB,this.rB),this.uA.copy(e).selfAdd(this.rA).selfSub(this.groundAnchorA),this.uB.copy(n).selfAdd(this.rB).selfSub(this.groundAnchorB);var u=this.uA.length(),p=this.uB.length();u>10*w.linearSlop?this.uA.selfMul(1/u):this.uA.setZero(),p>10*w.linearSlop?this.uB.selfMul(1/p):this.uB.setZero();var d,f,y=w.Vec2.CrossVV(this.rA,this.uA),V=w.Vec2.CrossVV(this.rB,this.uB),v=this.invMassA+this.invIA*y*y,x=this.invMassB+this.invIB*V*V;this.mass=v+this.ratio*this.ratio*x,0<this.mass&&(this.mass=1/this.mass),t.step.warmStarting?(this.impulse*=t.step.dtRatio,d=w.Vec2.MulSV(-this.impulse,this.uA,b.initVelocityConstraints_s_PA),f=w.Vec2.MulSV(-this.ratio*this.impulse,this.uB,b.initVelocityConstraints_s_PB),s.selfMulAdd(this.invMassA,d),o+=this.invIA*w.Vec2.CrossVV(this.rA,d),a.selfMulAdd(this.invMassB,f),c+=this.invIB*w.Vec2.CrossVV(this.rB,f)):this.impulse=0,t.velocities[this.indexA].w=o,t.velocities[this.indexB].w=c},b.prototype.solveVelocityConstraints=function(t){var e=t.velocities[this.indexA].v,i=t.velocities[this.indexA].w,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=w.Vec2.AddVCrossSV(e,i,this.rA,b.solveVelocityConstraints_s_vpA),r=w.Vec2.AddVCrossSV(s,o,this.rB,b.solveVelocityConstraints_s_vpB),a=-w.Vec2.DotVV(this.uA,n)-this.ratio*w.Vec2.DotVV(this.uB,r),c=-this.mass*a;this.impulse+=c;var l=w.Vec2.MulSV(-c,this.uA,b.solveVelocityConstraints_s_PA),h=w.Vec2.MulSV(-this.ratio*c,this.uB,b.solveVelocityConstraints_s_PB);e.selfMulAdd(this.invMassA,l),i+=this.invIA*w.Vec2.CrossVV(this.rA,l),s.selfMulAdd(this.invMassB,h),o+=this.invIB*w.Vec2.CrossVV(this.rB,h),t.velocities[this.indexA].w=i,t.velocities[this.indexB].w=o},b.prototype.solvePositionConstraints=function(t){var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.positions[this.indexB].c,o=t.positions[this.indexB].a,n=this.qA.setAngle(i),r=this.qB.setAngle(o);w.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var a=w.Rot.mulRV(n,this.lalcA,this.rA);w.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var c=w.Rot.mulRV(r,this.lalcB,this.rB),l=this.uA.copy(e).selfAdd(a).selfSub(this.groundAnchorA),h=this.uB.copy(s).selfAdd(c).selfSub(this.groundAnchorB),u=l.length(),p=h.length();u>10*w.linearSlop?l.selfMul(1/u):l.setZero(),p>10*w.linearSlop?h.selfMul(1/p):h.setZero();var d=w.Vec2.CrossVV(a,l),f=w.Vec2.CrossVV(c,h),y=this.invMassA+this.invIA*d*d,V=this.invMassB+this.invIB*f*f,v=y+this.ratio*this.ratio*V;0<v&&(v=1/v);var x=this.constant-u-this.ratio*p,g=w.Abs(x),m=-v*x,B=w.Vec2.MulSV(-m,l,b.solvePositionConstraints_s_PA),A=w.Vec2.MulSV(-this.ratio*m,h,b.solvePositionConstraints_s_PB);return e.selfMulAdd(this.invMassA,B),i+=this.invIA*w.Vec2.CrossVV(a,B),s.selfMulAdd(this.invMassB,A),o+=this.invIB*w.Vec2.CrossVV(c,A),t.positions[this.indexA].a=i,t.positions[this.indexB].a=o,g<w.linearSlop},b.prototype.getAnchorA=function(t){return this.bodyA.getWorldPoint(this.localAnchorA,t)},b.prototype.getAnchorB=function(t){return this.bodyB.getWorldPoint(this.localAnchorB,t)},b.prototype.getReactionForce=function(t,e){return e.x=t*this.impulse*this.uB.x,e.y=t*this.impulse*this.uB.y,e},b.prototype.getReactionTorque=function(t){return 0},b.prototype.getGroundAnchorA=function(){return this.groundAnchorA},b.prototype.getGroundAnchorB=function(){return this.groundAnchorB},b.prototype.getCurrentLengthA=function(){var t=this.bodyA.getWorldPoint(this.localAnchorA,b.getCurrentLengthA_s_p),e=this.groundAnchorA;return w.Vec2.DistanceVV(t,e)},b.prototype.getCurrentLengthB=function(){var t=this.bodyB.getWorldPoint(this.localAnchorB,b.getCurrentLengthB_s_p),e=this.groundAnchorB;return w.Vec2.DistanceVV(t,e)},b.prototype.dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: PulleyJointDef = new PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.groundAnchorA.x,this.groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.groundAnchorB.x,this.groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.lengthA),t("  jd.lengthB = %.15f;\n",this.lengthB),t("  jd.ratio = %.15f;\n",this.ratio),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},b.prototype.shiftOrigin=function(t){this.groundAnchorA.selfSub(t),this.groundAnchorB.selfSub(t)},b.initVelocityConstraints_s_PA=new w.Vec2,b.initVelocityConstraints_s_PB=new w.Vec2,b.solveVelocityConstraints_s_vpA=new w.Vec2,b.solveVelocityConstraints_s_vpB=new w.Vec2,b.solveVelocityConstraints_s_PA=new w.Vec2,b.solveVelocityConstraints_s_PB=new w.Vec2,b.solvePositionConstraints_s_PA=new w.Vec2,b.solvePositionConstraints_s_PB=new w.Vec2,b.getCurrentLengthA_s_p=new w.Vec2,b.getCurrentLengthB_s_p=new w.Vec2,b);function b(t){var e=s.call(this,t)||this;return e.groundAnchorA=new w.Vec2,e.groundAnchorB=new w.Vec2,e.lengthA=0,e.lengthB=0,e.localAnchorA=new w.Vec2,e.localAnchorB=new w.Vec2,e.constant=0,e.ratio=0,e.impulse=0,e.indexA=0,e.indexB=0,e.uA=new w.Vec2,e.uB=new w.Vec2,e.rA=new w.Vec2,e.rB=new w.Vec2,e.localCenterA=new w.Vec2,e.localCenterB=new w.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.mass=0,e.qA=new w.Rot,e.qB=new w.Rot,e.lalcA=new w.Vec2,e.lalcB=new w.Vec2,e.groundAnchorA.copy(w.maybe(t.groundAnchorA,new w.Vec2(-1,1))),e.groundAnchorB.copy(w.maybe(t.groundAnchorB,new w.Vec2(1,0))),e.localAnchorA.copy(w.maybe(t.localAnchorA,new w.Vec2(-1,0))),e.localAnchorB.copy(w.maybe(t.localAnchorB,new w.Vec2(1,0))),e.lengthA=w.maybe(t.lengthA,0),e.lengthB=w.maybe(t.lengthB,0),e.ratio=w.maybe(t.ratio,1),e.constant=w.maybe(t.lengthA,0)+e.ratio*w.maybe(t.lengthB,0),e.impulse=0,e}w.PulleyJoint=o}(b2=b2||{}),function(A){var e,t=(e=A.JointDef,__extends(i,e),i.prototype.initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.getLocalPoint(i,this.localAnchorA),this.bodyB.getLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.getAngle()-this.bodyA.getAngle()},i);function i(){var t=e.call(this,A.JointType.RevoluteJoint)||this;return t.localAnchorA=new A.Vec2(0,0),t.localAnchorB=new A.Vec2(0,0),t.referenceAngle=0,t.enableLimit=!1,t.lowerAngle=0,t.upperAngle=0,t.enableMotor=!1,t.motorSpeed=0,t.maxMotorTorque=0,t}A.RevoluteJointDef=t;var s,o=(s=A.Joint,__extends(w,s),w.prototype.initVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.copy(this.bodyA.sweep.localCenter),this.localCenterB.copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].a,i=t.velocities[this.indexA].v,s=t.velocities[this.indexA].w,o=t.positions[this.indexB].a,n=t.velocities[this.indexB].v,r=t.velocities[this.indexB].w,a=this.qA.setAngle(e),c=this.qB.setAngle(o);A.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),A.Rot.mulRV(a,this.lalcA,this.rA),A.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),A.Rot.mulRV(c,this.lalcB,this.rB);var l,h,u,p=this.invMassA,d=this.invMassB,f=this.invIA,y=this.invIB;this.K.ex.x=p+d+this.rA.y*this.rA.y*f+this.rB.y*this.rB.y*y,this.K.ey.x=-this.rA.y*this.rA.x*f-this.rB.y*this.rB.x*y,this.K.ex.y=this.K.ey.x,this.K.ey.y=p+d+this.rA.x*this.rA.x*f+this.rB.x*this.rB.x*y,this.axialMass=f+y,l=!(0<this.axialMass)||(this.axialMass=1/this.axialMass,!1),this.angle=o-e-this.referenceAngle,!1!==this.enableLimit&&!l||(this.lowerImpulse=0,this.upperImpulse=0),!1!==this.enableMotor&&!l||(this.motorImpulse=0),t.step.warmStarting?(this.impulse.selfMul(t.step.dtRatio),this.motorImpulse*=t.step.dtRatio,this.lowerImpulse*=t.step.dtRatio,this.upperImpulse*=t.step.dtRatio,h=this.motorImpulse+this.lowerImpulse-this.upperImpulse,u=w.initVelocityConstraints_s_P.set(this.impulse.x,this.impulse.y),i.selfMulSub(p,u),s-=f*(A.Vec2.CrossVV(this.rA,u)+h),n.selfMulAdd(d,u),r+=y*(A.Vec2.CrossVV(this.rB,u)+h)):(this.impulse.setZero(),this.motorImpulse=0,this.lowerImpulse=0,this.upperImpulse=0),t.velocities[this.indexA].w=s,t.velocities[this.indexB].w=r},w.prototype.solveVelocityConstraints=function(t){var e,i,s,o,n,r=t.velocities[this.indexA].v,a=t.velocities[this.indexA].w,c=t.velocities[this.indexB].v,l=t.velocities[this.indexB].w,h=this.invMassA,u=this.invMassB,p=this.invIA,d=this.invIB,f=p+d===0;this.enableMotor&&!f&&(s=l-a-this.motorSpeed,o=-this.axialMass*s,n=this.motorImpulse,e=t.step.dt*this.maxMotorTorque,this.motorImpulse=A.clamp(this.motorImpulse+o,-e,e),a-=p*(o=this.motorImpulse-n),l+=d*o),this.enableLimit&&!f&&(i=this.angle-this.lowerAngle,s=l-a,o=-this.axialMass*(s+A.Max(i,0)*t.step.inv_dt),n=this.lowerImpulse,this.lowerImpulse=A.Max(this.lowerImpulse+o,0),a-=p*(o=this.lowerImpulse-n),l+=d*o,i=this.upperAngle-this.angle,s=a-l,o=-this.axialMass*(s+A.Max(i,0)*t.step.inv_dt),n=this.upperImpulse,this.upperImpulse=A.Max(this.upperImpulse+o,0),a+=p*(o=this.upperImpulse-n),l-=d*o);var y=A.Vec2.SubVV(A.Vec2.AddVCrossSV(c,l,this.rB,A.Vec2.s_t0),A.Vec2.AddVCrossSV(r,a,this.rA,A.Vec2.s_t1),w.solveVelocityConstraints_s_Cdot_v2),V=this.K.solve(-y.x,-y.y,w.solveVelocityConstraints_s_impulse_v2);this.impulse.x+=V.x,this.impulse.y+=V.y,r.selfMulSub(h,V),a-=p*A.Vec2.CrossVV(this.rA,V),c.selfMulAdd(u,V),l+=d*A.Vec2.CrossVV(this.rB,V),t.velocities[this.indexA].w=a,t.velocities[this.indexB].w=l},w.prototype.solvePositionConstraints=function(t){var e,i,s,o=t.positions[this.indexA].c,n=t.positions[this.indexA].a,r=t.positions[this.indexB].c,a=t.positions[this.indexB].a,c=this.qA.setAngle(n),l=this.qB.setAngle(a),h=0,u=this.invIA+this.invIB===0;this.enableLimit&&!u&&(e=a-n-this.referenceAngle,i=0,A.Abs(this.upperAngle-this.lowerAngle)<2*A.angularSlop?i=A.clamp(e-this.lowerAngle,-A.maxAngularCorrection,A.maxAngularCorrection):e<=this.lowerAngle?i=A.clamp(e-this.lowerAngle+A.angularSlop,-A.maxAngularCorrection,0):e>=this.upperAngle&&(i=A.clamp(e-this.upperAngle-A.angularSlop,0,A.maxAngularCorrection)),s=-this.axialMass*i,n-=this.invIA*s,a+=this.invIB*s,h=A.Abs(i)),c.setAngle(n),l.setAngle(a),A.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var p=A.Rot.mulRV(c,this.lalcA,this.rA);A.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var d=A.Rot.mulRV(l,this.lalcB,this.rB),f=A.Vec2.SubVV(A.Vec2.AddVV(r,d,A.Vec2.s_t0),A.Vec2.AddVV(o,p,A.Vec2.s_t1),w.solvePositionConstraints_s_C_v2),y=f.length(),V=this.invMassA,v=this.invMassB,x=this.invIA,g=this.invIB,m=this.K;m.ex.x=V+v+x*p.y*p.y+g*d.y*d.y,m.ex.y=-x*p.x*p.y-g*d.x*d.y,m.ey.x=m.ex.y,m.ey.y=V+v+x*p.x*p.x+g*d.x*d.x;var B=m.solve(f.x,f.y,w.solvePositionConstraints_s_impulse).selfNeg();return o.selfMulSub(V,B),n-=x*A.Vec2.CrossVV(p,B),r.selfMulAdd(v,B),a+=g*A.Vec2.CrossVV(d,B),t.positions[this.indexA].a=n,t.positions[this.indexB].a=a,y<=A.linearSlop&&h<=A.angularSlop},w.prototype.getAnchorA=function(t){return this.bodyA.getWorldPoint(this.localAnchorA,t)},w.prototype.getAnchorB=function(t){return this.bodyB.getWorldPoint(this.localAnchorB,t)},w.prototype.getReactionForce=function(t,e){return e.x=t*this.impulse.x,e.y=t*this.impulse.y,e},w.prototype.getReactionTorque=function(t){return t*(this.lowerImpulse-this.upperImpulse)},w.prototype.getJointAngle=function(){return this.bodyB.sweep.a-this.bodyA.sweep.a-this.referenceAngle},w.prototype.getJointSpeed=function(){return this.bodyB.angularVelocity-this.bodyA.angularVelocity},w.prototype.isMotorEnabled=function(){return this.enableMotor},w.prototype.setEnableMotor=function(t){t!==this.enableMotor&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.enableMotor=t)},w.prototype.getMotorTorque=function(t){return t*this.motorImpulse},w.prototype.getMotorSpeed=function(){return this.motorSpeed},w.prototype.setMaxMotorTorque=function(t){t!==this.maxMotorTorque&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.maxMotorTorque=t)},w.prototype.getMaxMotorTorque=function(){return this.maxMotorTorque},w.prototype.isLimitEnabled=function(){return this.enableLimit},w.prototype.setEnableLimit=function(t){t!==this.enableLimit&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.enableLimit=t,this.lowerImpulse=0,this.upperImpulse=0)},w.prototype.getLowerLimit=function(){return this.lowerAngle},w.prototype.getUpperLimit=function(){return this.upperAngle},w.prototype.setLimits=function(t,e){t===this.lowerAngle&&e===this.upperAngle||(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.lowerImpulse=0,this.upperImpulse=0,this.lowerAngle=t,this.upperAngle=e)},w.prototype.setMotorSpeed=function(t){t!==this.motorSpeed&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.motorSpeed=t)},w.prototype.dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: RevoluteJointDef = new RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.referenceAngle),t("  jd.enableLimit = %s;\n",this.enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.lowerAngle),t("  jd.upperAngle = %.15f;\n",this.upperAngle),t("  jd.enableMotor = %s;\n",this.enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.maxMotorTorque),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},w.prototype.draw=function(t){var e=this.bodyA.getTransform(),i=this.bodyB.getTransform(),s=A.Transform.mulXV(e,this.localAnchorA,w.draw_s_pA),o=A.Transform.mulXV(i,this.localAnchorB,w.draw_s_pB),n=w.draw_s_c1,r=w.draw_s_c2,a=w.draw_s_c3,c=w.draw_s_c4,l=w.draw_s_c5;t.drawPoint(s,5,c),t.drawPoint(o,5,l);var h,u,p=this.bodyA.getAngle(),d=this.bodyB.getAngle()-p-this.referenceAngle,f=w.draw_s_r.set(.5*Math.cos(d),.5*Math.sin(d));t.drawSegment(o,A.Vec2.AddVV(o,f,A.Vec2.s_t0),n),t.drawCircle(o,.5,n),this.enableLimit&&(h=w.draw_s_rlo.set(.5*Math.cos(this.lowerAngle),.5*Math.sin(this.lowerAngle)),u=w.draw_s_rhi.set(.5*Math.cos(this.upperAngle),.5*Math.sin(this.upperAngle)),t.drawSegment(o,A.Vec2.AddVV(o,h,A.Vec2.s_t0),r),t.drawSegment(o,A.Vec2.AddVV(o,u,A.Vec2.s_t0),a));var y=w.draw_s_color_;t.drawSegment(e.p,s,y),t.drawSegment(s,o,y),t.drawSegment(i.p,o,y)},w.initVelocityConstraints_s_P=new A.Vec2,w.solveVelocityConstraints_s_Cdot_v2=new A.Vec2,w.solveVelocityConstraints_s_impulse_v2=new A.Vec2,w.solvePositionConstraints_s_C_v2=new A.Vec2,w.solvePositionConstraints_s_impulse=new A.Vec2,w.draw_s_pA=new A.Vec2,w.draw_s_pB=new A.Vec2,w.draw_s_c1=new A.Color(.7,.7,.7),w.draw_s_c2=new A.Color(.3,.9,.3),w.draw_s_c3=new A.Color(.9,.3,.3),w.draw_s_c4=new A.Color(.3,.3,.9),w.draw_s_c5=new A.Color(.4,.4,.4),w.draw_s_color_=new A.Color(.5,.8,.8),w.draw_s_r=new A.Vec2,w.draw_s_rlo=new A.Vec2,w.draw_s_rhi=new A.Vec2,w);function w(t){var e=s.call(this,t)||this;return e.localAnchorA=new A.Vec2,e.localAnchorB=new A.Vec2,e.impulse=new A.Vec2,e.motorImpulse=0,e.lowerImpulse=0,e.upperImpulse=0,e.enableMotor=!1,e.maxMotorTorque=0,e.motorSpeed=0,e.enableLimit=!1,e.referenceAngle=0,e.lowerAngle=0,e.upperAngle=0,e.indexA=0,e.indexB=0,e.rA=new A.Vec2,e.rB=new A.Vec2,e.localCenterA=new A.Vec2,e.localCenterB=new A.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.K=new A.Mat22,e.angle=0,e.axialMass=0,e.qA=new A.Rot,e.qB=new A.Rot,e.lalcA=new A.Vec2,e.lalcB=new A.Vec2,e.localAnchorA.copy(A.maybe(t.localAnchorA,A.Vec2.ZERO)),e.localAnchorB.copy(A.maybe(t.localAnchorB,A.Vec2.ZERO)),e.referenceAngle=A.maybe(t.referenceAngle,0),e.impulse.setZero(),e.motorImpulse=0,e.lowerAngle=A.maybe(t.lowerAngle,0),e.upperAngle=A.maybe(t.upperAngle,0),e.maxMotorTorque=A.maybe(t.maxMotorTorque,0),e.motorSpeed=A.maybe(t.motorSpeed,0),e.enableLimit=A.maybe(t.enableLimit,!1),e.enableMotor=A.maybe(t.enableMotor,!1),e}A.RevoluteJoint=o}(b2=b2||{}),function(m){var e,t=(e=m.JointDef,__extends(i,e),i.prototype.initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.getLocalPoint(i,this.localAnchorA),this.bodyB.getLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.getAngle()-this.bodyA.getAngle()},i);function i(){var t=e.call(this,m.JointType.WeldJoint)||this;return t.localAnchorA=new m.Vec2,t.localAnchorB=new m.Vec2,t.referenceAngle=0,t.stiffness=0,t.damping=0,t}m.WeldJointDef=t;var s,o=(s=m.Joint,__extends(B,s),B.prototype.initVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.copy(this.bodyA.sweep.localCenter),this.localCenterB.copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].a,i=t.velocities[this.indexA].v,s=t.velocities[this.indexA].w,o=t.positions[this.indexB].a,n=t.velocities[this.indexB].v,r=t.velocities[this.indexB].w,a=this.qA.setAngle(e),c=this.qB.setAngle(o);m.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),m.Rot.mulRV(a,this.lalcA,this.rA),m.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),m.Rot.mulRV(c,this.lalcB,this.rB);var l,h,u,p,d,f,y=this.invMassA,V=this.invMassB,v=this.invIA,x=this.invIB,g=this.K;g.ex.x=y+V+this.rA.y*this.rA.y*v+this.rB.y*this.rB.y*x,g.ey.x=-this.rA.y*this.rA.x*v-this.rB.y*this.rB.x*x,g.ez.x=-this.rA.y*v-this.rB.y*x,g.ex.y=g.ey.x,g.ey.y=y+V+this.rA.x*this.rA.x*v+this.rB.x*this.rB.x*x,g.ez.y=this.rA.x*v+this.rB.x*x,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=v+x,0<this.stiffness?(g.getInverse22(this.mass),l=v+x,h=o-e-this.referenceAngle,u=this.damping,p=this.stiffness,d=t.step.dt,this.gamma=d*(u+d*p),this.gamma=0!==this.gamma?1/this.gamma:0,this.bias=h*d*p*this.gamma,l+=this.gamma,this.mass.ez.z=0!==l?1/l:0):(g.getSymInverse33(this.mass),this.gamma=0,this.bias=0),t.step.warmStarting?(this.impulse.selfMul(t.step.dtRatio),f=B.initVelocityConstraints_s_P.set(this.impulse.x,this.impulse.y),i.selfMulSub(y,f),s-=v*(m.Vec2.CrossVV(this.rA,f)+this.impulse.z),n.selfMulAdd(V,f),r+=x*(m.Vec2.CrossVV(this.rB,f)+this.impulse.z)):this.impulse.setZero(),t.velocities[this.indexA].w=s,t.velocities[this.indexB].w=r},B.prototype.solveVelocityConstraints=function(t){var e,i,s,o,n,r,a=t.velocities[this.indexA].v,c=t.velocities[this.indexA].w,l=t.velocities[this.indexB].v,h=t.velocities[this.indexB].w,u=this.invMassA,p=this.invMassB,d=this.invIA,f=this.invIB;0<this.stiffness?(o=h-c,e=-this.mass.ez.z*(o+this.bias+this.gamma*this.impulse.z),this.impulse.z+=e,c-=d*e,h+=f*e,s=m.Vec2.SubVV(m.Vec2.AddVCrossSV(l,h,this.rB,m.Vec2.s_t0),m.Vec2.AddVCrossSV(a,c,this.rA,m.Vec2.s_t1),B.solveVelocityConstraints_s_Cdot1),i=m.Mat33.mulM33XY(this.mass,s.x,s.y,B.solveVelocityConstraints_s_impulse1).selfNeg(),this.impulse.x+=i.x,this.impulse.y+=i.y,r=i,a.selfMulSub(u,r),c-=d*m.Vec2.CrossVV(this.rA,r),l.selfMulAdd(p,r),h+=f*m.Vec2.CrossVV(this.rB,r)):(s=m.Vec2.SubVV(m.Vec2.AddVCrossSV(l,h,this.rB,m.Vec2.s_t0),m.Vec2.AddVCrossSV(a,c,this.rA,m.Vec2.s_t1),B.solveVelocityConstraints_s_Cdot1),o=h-c,n=m.Mat33.mulM33XYZ(this.mass,s.x,s.y,o,B.solveVelocityConstraints_s_impulse).selfNeg(),this.impulse.selfAdd(n),r=B.solveVelocityConstraints_s_P.set(n.x,n.y),a.selfMulSub(u,r),c-=d*(m.Vec2.CrossVV(this.rA,r)+n.z),l.selfMulAdd(p,r),h+=f*(m.Vec2.CrossVV(this.rB,r)+n.z)),t.velocities[this.indexA].w=c,t.velocities[this.indexB].w=h},B.prototype.solvePositionConstraints=function(t){var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.positions[this.indexB].c,o=t.positions[this.indexB].a,n=this.qA.setAngle(i),r=this.qB.setAngle(o),a=this.invMassA,c=this.invMassB,l=this.invIA,h=this.invIB;m.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var u=m.Rot.mulRV(n,this.lalcA,this.rA);m.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var p,d,f,y,V,v,x=m.Rot.mulRV(r,this.lalcB,this.rB),g=this.K;return g.ex.x=a+c+u.y*u.y*l+x.y*x.y*h,g.ey.x=-u.y*u.x*l-x.y*x.x*h,g.ez.x=-u.y*l-x.y*h,g.ex.y=g.ey.x,g.ey.y=a+c+u.x*u.x*l+x.x*x.x*h,g.ez.y=u.x*l+x.x*h,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=l+h,0<this.stiffness?(p=(f=m.Vec2.SubVV(m.Vec2.AddVV(s,x,m.Vec2.s_t0),m.Vec2.AddVV(e,u,m.Vec2.s_t1),B.solvePositionConstraints_s_C1)).length(),d=0,v=g.solve22(f.x,f.y,B.solvePositionConstraints_s_P).selfNeg(),e.selfMulSub(a,v),i-=l*m.Vec2.CrossVV(u,v),s.selfMulAdd(c,v),o+=h*m.Vec2.CrossVV(x,v)):(f=m.Vec2.SubVV(m.Vec2.AddVV(s,x,m.Vec2.s_t0),m.Vec2.AddVV(e,u,m.Vec2.s_t1),B.solvePositionConstraints_s_C1),y=o-i-this.referenceAngle,p=f.length(),d=m.Abs(y),V=g.solve33(f.x,f.y,y,B.solvePositionConstraints_s_impulse).selfNeg(),v=B.solvePositionConstraints_s_P.set(V.x,V.y),e.selfMulSub(a,v),i-=l*(m.Vec2.CrossVV(this.rA,v)+V.z),s.selfMulAdd(c,v),o+=h*(m.Vec2.CrossVV(this.rB,v)+V.z)),t.positions[this.indexA].a=i,t.positions[this.indexB].a=o,p<=m.linearSlop&&d<=m.angularSlop},B.prototype.getAnchorA=function(t){return this.bodyA.getWorldPoint(this.localAnchorA,t)},B.prototype.getAnchorB=function(t){return this.bodyB.getWorldPoint(this.localAnchorB,t)},B.prototype.getReactionForce=function(t,e){return e.x=t*this.impulse.x,e.y=t*this.impulse.y,e},B.prototype.getReactionTorque=function(t){return t*this.impulse.z},B.prototype.setStiffness=function(t){this.stiffness=t},B.prototype.getStiffness=function(){return this.stiffness},B.prototype.setDamping=function(t){this.damping=t},B.prototype.getDamping=function(){return this.damping},B.prototype.dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: WeldJointDef = new WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.referenceAngle),t("  jd.stiffness = %.15f;\n",this.stiffness),t("  jd.damping = %.15f;\n",this.damping),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},B.initVelocityConstraints_s_P=new m.Vec2,B.solveVelocityConstraints_s_Cdot1=new m.Vec2,B.solveVelocityConstraints_s_impulse1=new m.Vec2,B.solveVelocityConstraints_s_impulse=new m.Vec3,B.solveVelocityConstraints_s_P=new m.Vec2,B.solvePositionConstraints_s_C1=new m.Vec2,B.solvePositionConstraints_s_P=new m.Vec2,B.solvePositionConstraints_s_impulse=new m.Vec3,B);function B(t){var e=s.call(this,t)||this;return e.stiffness=0,e.damping=0,e.bias=0,e.localAnchorA=new m.Vec2,e.localAnchorB=new m.Vec2,e.referenceAngle=0,e.gamma=0,e.impulse=new m.Vec3(0,0,0),e.indexA=0,e.indexB=0,e.rA=new m.Vec2,e.rB=new m.Vec2,e.localCenterA=new m.Vec2,e.localCenterB=new m.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.mass=new m.Mat33,e.qA=new m.Rot,e.qB=new m.Rot,e.lalcA=new m.Vec2,e.lalcB=new m.Vec2,e.K=new m.Mat33,e.stiffness=m.maybe(t.stiffness,0),e.damping=m.maybe(t.damping,0),e.localAnchorA.copy(m.maybe(t.localAnchorA,m.Vec2.ZERO)),e.localAnchorB.copy(m.maybe(t.localAnchorB,m.Vec2.ZERO)),e.referenceAngle=m.maybe(t.referenceAngle,0),e.impulse.setZero(),e}m.WeldJoint=o}(b2=b2||{}),function(C){var e,t=(e=C.JointDef,__extends(i,e),i.prototype.initialize=function(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.getLocalPoint(i,this.localAnchorA),this.bodyB.getLocalPoint(i,this.localAnchorB),this.bodyA.getLocalVector(s,this.localAxisA)},i);function i(){var t=e.call(this,C.JointType.WheelJoint)||this;return t.localAnchorA=new C.Vec2(0,0),t.localAnchorB=new C.Vec2(0,0),t.localAxisA=new C.Vec2(1,0),t.enableLimit=!1,t.lowerTranslation=0,t.upperTranslation=0,t.enableMotor=!1,t.maxMotorTorque=0,t.motorSpeed=0,t.stiffness=0,t.damping=0,t}C.WheelJointDef=t;var s,o=(s=C.Joint,__extends(_,s),_.prototype.getMotorSpeed=function(){return this.motorSpeed},_.prototype.getMaxMotorTorque=function(){return this.maxMotorTorque},_.prototype.setSpringFrequencyHz=function(t){this.stiffness=t},_.prototype.getSpringFrequencyHz=function(){return this.stiffness},_.prototype.setSpringDampingRatio=function(t){this.damping=t},_.prototype.getSpringDampingRatio=function(){return this.damping},_.prototype.initVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.copy(this.bodyA.sweep.localCenter),this.localCenterB.copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=this.invMassA,i=this.invMassB,s=this.invIA,o=this.invIB,n=t.positions[this.indexA].c,r=t.positions[this.indexA].a,a=t.velocities[this.indexA].v,c=t.velocities[this.indexA].w,l=t.positions[this.indexB].c,h=t.positions[this.indexB].a,u=t.velocities[this.indexB].v,p=t.velocities[this.indexB].w,d=this.qA.setAngle(r),f=this.qB.setAngle(h);C.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var y=C.Rot.mulRV(d,this.lalcA,this.rA);C.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var V=C.Rot.mulRV(f,this.lalcB,this.rB),v=C.Vec2.SubVV(C.Vec2.AddVV(l,V,C.Vec2.s_t0),C.Vec2.AddVV(n,y,C.Vec2.s_t1),_.initVelocityConstraints_s_d);C.Rot.mulRV(d,this.localYAxisA,this.ay),this.sAy=C.Vec2.CrossVV(C.Vec2.AddVV(v,y,C.Vec2.s_t0),this.ay),this.sBy=C.Vec2.CrossVV(V,this.ay),this.mass=e+i+s*this.sAy*this.sAy+o*this.sBy*this.sBy,0<this.mass&&(this.mass=1/this.mass),C.Rot.mulRV(d,this.localXAxisA,this.ax),this.sAx=C.Vec2.CrossVV(C.Vec2.AddVV(v,y,C.Vec2.s_t0),this.ax),this.sBx=C.Vec2.CrossVV(V,this.ax);var x,g,m,B,A,w,b=e+i+s*this.sAx*this.sAx+o*this.sBx*this.sBx;this.axialMass=0<b?1/b:0,this.springMass=0,this.bias=0,(this.gamma=0)<this.stiffness&&0<b?(this.springMass=1/b,x=C.Vec2.DotVV(v,this.ax),g=t.step.dt,this.gamma=g*(this.damping+g*this.stiffness),0<this.gamma&&(this.gamma=1/this.gamma),this.bias=x*g*this.stiffness*this.gamma,this.springMass=b+this.gamma,0<this.springMass&&(this.springMass=1/this.springMass)):this.springImpulse=0,this.enableLimit?this.translation=C.Vec2.DotVV(this.ax,v):(this.lowerImpulse=0,this.upperImpulse=0),this.enableMotor?(this.motorMass=s+o,0<this.motorMass&&(this.motorMass=1/this.motorMass)):(this.motorMass=0,this.motorImpulse=0),t.step.warmStarting?(this.impulse*=t.step.dtRatio,this.springImpulse*=t.step.dtRatio,this.motorImpulse*=t.step.dtRatio,m=this.springImpulse+this.lowerImpulse-this.upperImpulse,B=C.Vec2.AddVV(C.Vec2.MulSV(this.impulse,this.ay,C.Vec2.s_t0),C.Vec2.MulSV(m,this.ax,C.Vec2.s_t1),_.initVelocityConstraints_s_P),A=this.impulse*this.sAy+m*this.sAx+this.motorImpulse,w=this.impulse*this.sBy+m*this.sBx+this.motorImpulse,a.selfMulSub(this.invMassA,B),c-=this.invIA*A,u.selfMulAdd(this.invMassB,B),p+=this.invIB*w):(this.impulse=0,this.springImpulse=0,this.motorImpulse=0,this.lowerImpulse=0,this.upperImpulse=0),t.velocities[this.indexA].w=c,t.velocities[this.indexB].w=p},_.prototype.solveVelocityConstraints=function(t){var e=this.invMassA,i=this.invMassB,s=this.invIA,o=this.invIB,n=t.velocities[this.indexA].v,r=t.velocities[this.indexA].w,a=t.velocities[this.indexB].v,c=t.velocities[this.indexB].w,l=C.Vec2.DotVV(this.ax,C.Vec2.SubVV(a,n,C.Vec2.s_t0))+this.sBx*c-this.sAx*r,h=-this.springMass*(l+this.bias+this.gamma*this.springImpulse);this.springImpulse+=h;var u=C.Vec2.MulSV(h,this.ax,_.solveVelocityConstraints_s_P),p=h*this.sAx,d=h*this.sBx;n.selfMulSub(e,u),r-=s*p,a.selfMulAdd(i,u);var f,l=(c+=o*d)-r-this.motorSpeed,h=-this.motorMass*l,y=this.motorImpulse,V=t.step.dt*this.maxMotorTorque;this.motorImpulse=C.clamp(this.motorImpulse+h,-V,V),r-=s*(h=this.motorImpulse-y),c+=o*h,this.enableLimit&&(f=this.translation-this.lowerTranslation,l=C.Vec2.DotVV(this.ax,C.Vec2.SubVV(a,n,C.Vec2.s_t0))+this.sBx*c-this.sAx*r,h=-this.axialMass*(l+C.Max(f,0)*t.step.inv_dt),y=this.lowerImpulse,this.lowerImpulse=C.Max(this.lowerImpulse+h,0),h=this.lowerImpulse-y,u=C.Vec2.MulSV(h,this.ax,_.solveVelocityConstraints_s_P),p=h*this.sAx,d=h*this.sBx,n.selfMulSub(e,u),r-=s*p,a.selfMulAdd(i,u),c+=o*d,f=this.upperTranslation-this.translation,l=C.Vec2.DotVV(this.ax,C.Vec2.SubVV(n,a,C.Vec2.s_t0))+this.sAx*r-this.sBx*c,h=-this.axialMass*(l+C.Max(f,0)*t.step.inv_dt),y=this.upperImpulse,this.upperImpulse=C.Max(this.upperImpulse+h,0),h=this.upperImpulse-y,u=C.Vec2.MulSV(h,this.ax,_.solveVelocityConstraints_s_P),p=h*this.sAx,d=h*this.sBx,n.selfMulAdd(e,u),r+=s*p,a.selfMulSub(i,u),c-=o*d);l=C.Vec2.DotVV(this.ay,C.Vec2.SubVV(a,n,C.Vec2.s_t0))+this.sBy*c-this.sAy*r,h=-this.mass*l;this.impulse+=h;u=C.Vec2.MulSV(h,this.ay,_.solveVelocityConstraints_s_P),p=h*this.sAy,d=h*this.sBy;n.selfMulSub(e,u),r-=s*p,a.selfMulAdd(i,u),c+=o*d,t.velocities[this.indexA].w=r,t.velocities[this.indexB].w=c},_.prototype.solvePositionConstraints=function(t){var e,i,s,o,n=t.positions[this.indexA].c,r=t.positions[this.indexA].a,a=t.positions[this.indexB].c,c=t.positions[this.indexB].a,l=0;this.enableLimit&&(h=this.qA.setAngle(r),u=this.qB.setAngle(c),C.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),p=C.Rot.mulRV(h,this.lalcA,this.rA),C.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),f=C.Rot.mulRV(u,this.lalcB,this.rB),y=C.Vec2.AddVV(C.Vec2.SubVV(a,n,C.Vec2.s_t0),C.Vec2.SubVV(f,p,C.Vec2.s_t1),_.solvePositionConstraints_s_d),e=C.Rot.mulRV(h,this.localXAxisA,this.ax),i=C.Vec2.CrossVV(C.Vec2.AddVV(y,p,C.Vec2.s_t0),this.ax),s=C.Vec2.CrossVV(f,this.ax),g=0,o=C.Vec2.DotVV(e,y),C.Abs(this.upperTranslation-this.lowerTranslation)<2*C.linearSlop?g=o:o<=this.lowerTranslation?g=C.Min(o-this.lowerTranslation,0):o>=this.upperTranslation&&(g=C.Max(o-this.upperTranslation,0)),0!==g&&((m=0)!==(d=this.invMassA+this.invMassB+this.invIA*i*i+this.invIB*s*s)&&(m=-g/d),B=C.Vec2.MulSV(m,e,_.solvePositionConstraints_s_P),A=m*i,w=m*s,n.selfMulSub(this.invMassA,B),r-=this.invIA*A,a.selfMulAdd(this.invMassB,B),c+=this.invIB*w,l=C.Abs(g)));var h=this.qA.setAngle(r),u=this.qB.setAngle(c);C.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var p=C.Rot.mulRV(h,this.lalcA,this.rA);C.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var d,f=C.Rot.mulRV(u,this.lalcB,this.rB),y=C.Vec2.AddVV(C.Vec2.SubVV(a,n,C.Vec2.s_t0),C.Vec2.SubVV(f,p,C.Vec2.s_t1),_.solvePositionConstraints_s_d),V=C.Rot.mulRV(h,this.localYAxisA,this.ay),v=C.Vec2.CrossVV(C.Vec2.AddVV(y,p,C.Vec2.s_t0),V),x=C.Vec2.CrossVV(f,V),g=C.Vec2.DotVV(y,V),m=0;0!==(d=this.invMassA+this.invMassB+this.invIA*this.sAy*this.sAy+this.invIB*this.sBy*this.sBy)&&(m=-g/d);var B=C.Vec2.MulSV(m,V,_.solvePositionConstraints_s_P),A=m*v,w=m*x;return n.selfMulSub(this.invMassA,B),r-=this.invIA*A,a.selfMulAdd(this.invMassB,B),c+=this.invIB*w,l=C.Max(l,C.Abs(g)),t.positions[this.indexA].a=r,t.positions[this.indexB].a=c,l<=C.linearSlop},_.prototype.getDefinition=function(t){return t},_.prototype.getAnchorA=function(t){return this.bodyA.getWorldPoint(this.localAnchorA,t)},_.prototype.getAnchorB=function(t){return this.bodyB.getWorldPoint(this.localAnchorB,t)},_.prototype.getReactionForce=function(t,e){return e.x=t*(this.impulse*this.ay.x+(this.springImpulse+this.lowerImpulse-this.upperImpulse)*this.ax.x),e.y=t*(this.impulse*this.ay.y+(this.springImpulse+this.lowerImpulse-this.upperImpulse)*this.ax.y),e},_.prototype.getReactionTorque=function(t){return t*this.motorImpulse},_.prototype.getJointTranslation=function(){return this.getPrismaticJointTranslation()},_.prototype.getJointLinearSpeed=function(){return this.getPrismaticJointSpeed()},_.prototype.getJointAngle=function(){return this.getRevoluteJointAngle()},_.prototype.getJointAngularSpeed=function(){return this.getRevoluteJointSpeed()},_.prototype.getPrismaticJointTranslation=function(){var t=this.bodyA,e=this.bodyB,i=t.getWorldPoint(this.localAnchorA,new C.Vec2),s=e.getWorldPoint(this.localAnchorB,new C.Vec2),o=C.Vec2.SubVV(s,i,new C.Vec2),n=t.getWorldVector(this.localXAxisA,new C.Vec2);return C.Vec2.DotVV(o,n)},_.prototype.getPrismaticJointSpeed=function(){var t=this.bodyA,e=this.bodyB;C.Vec2.SubVV(this.localAnchorA,t.sweep.localCenter,this.lalcA);var i=C.Rot.mulRV(t.xf.q,this.lalcA,this.rA);C.Vec2.SubVV(this.localAnchorB,e.sweep.localCenter,this.lalcB);var s=C.Rot.mulRV(e.xf.q,this.lalcB,this.rB),o=C.Vec2.AddVV(t.sweep.c,i,C.Vec2.s_t0),n=C.Vec2.AddVV(e.sweep.c,s,C.Vec2.s_t1),r=C.Vec2.SubVV(n,o,C.Vec2.s_t2),a=t.getWorldVector(this.localXAxisA,new C.Vec2),c=t.linearVelocity,l=e.linearVelocity,h=t.angularVelocity,u=e.angularVelocity;return C.Vec2.DotVV(r,C.Vec2.CrossSV(h,a,C.Vec2.s_t0))+C.Vec2.DotVV(a,C.Vec2.SubVV(C.Vec2.AddVCrossSV(l,u,s,C.Vec2.s_t0),C.Vec2.AddVCrossSV(c,h,i,C.Vec2.s_t1),C.Vec2.s_t0))},_.prototype.getRevoluteJointAngle=function(){return this.bodyB.sweep.a-this.bodyA.sweep.a},_.prototype.getRevoluteJointSpeed=function(){var t=this.bodyA.angularVelocity;return this.bodyB.angularVelocity-t},_.prototype.isMotorEnabled=function(){return this.enableMotor},_.prototype.setEnableMotor=function(t){t!==this.enableMotor&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.enableMotor=t)},_.prototype.setMotorSpeed=function(t){t!==this.motorSpeed&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.motorSpeed=t)},_.prototype.setMaxMotorTorque=function(t){t!==this.maxMotorTorque&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.maxMotorTorque=t)},_.prototype.getMotorTorque=function(t){return t*this.motorImpulse},_.prototype.isLimitEnabled=function(){return this.enableLimit},_.prototype.setEnableLimit=function(t){t!==this.enableLimit&&(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.enableLimit=t,this.lowerImpulse=0,this.upperImpulse=0)},_.prototype.getLowerLimit=function(){return this.lowerTranslation},_.prototype.getUpperLimit=function(){return this.upperTranslation},_.prototype.setLimits=function(t,e){t===this.lowerTranslation&&e===this.upperTranslation||(this.bodyA.setAwake(!0),this.bodyB.setAwake(!0),this.lowerTranslation=t,this.upperTranslation=e,this.lowerImpulse=0,this.upperImpulse=0)},_.prototype.dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: WheelJointDef = new WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.localXAxisA.x,this.localXAxisA.y),t("  jd.enableMotor = %s;\n",this.enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.maxMotorTorque),t("  jd.stiffness = %.15f;\n",this.stiffness),t("  jd.damping = %.15f;\n",this.damping),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},_.prototype.draw=function(t){var e,i,s,o=this.bodyA.getTransform(),n=this.bodyB.getTransform(),r=C.Transform.mulXV(o,this.localAnchorA,_.draw_s_pA),a=C.Transform.mulXV(n,this.localAnchorB,_.draw_s_pB),c=C.Rot.mulRV(o.q,this.localXAxisA,_.draw_s_axis),l=_.draw_s_c1,h=_.draw_s_c2,u=_.draw_s_c3,p=_.draw_s_c4,d=_.draw_s_c5;t.drawSegment(r,a,d),this.enableLimit?(e=C.Vec2.AddVMulSV(r,this.lowerTranslation,c,_.draw_s_lower),i=C.Vec2.AddVMulSV(r,this.upperTranslation,c,_.draw_s_upper),s=C.Rot.mulRV(o.q,this.localYAxisA,_.draw_s_perp),t.drawSegment(e,i,l),t.drawSegment(C.Vec2.AddVMulSV(e,-.5,s,C.Vec2.s_t0),C.Vec2.AddVMulSV(e,.5,s,C.Vec2.s_t1),h),t.drawSegment(C.Vec2.AddVMulSV(i,-.5,s,C.Vec2.s_t0),C.Vec2.AddVMulSV(i,.5,s,C.Vec2.s_t1),u)):t.drawSegment(C.Vec2.AddVMulSV(r,-1,c,C.Vec2.s_t0),C.Vec2.AddVMulSV(r,1,c,C.Vec2.s_t1),l),t.drawPoint(r,5,l),t.drawPoint(a,5,p)},_.initVelocityConstraints_s_d=new C.Vec2,_.initVelocityConstraints_s_P=new C.Vec2,_.solveVelocityConstraints_s_P=new C.Vec2,_.solvePositionConstraints_s_d=new C.Vec2,_.solvePositionConstraints_s_P=new C.Vec2,_.draw_s_pA=new C.Vec2,_.draw_s_pB=new C.Vec2,_.draw_s_axis=new C.Vec2,_.draw_s_c1=new C.Color(.7,.7,.7),_.draw_s_c2=new C.Color(.3,.9,.3),_.draw_s_c3=new C.Color(.9,.3,.3),_.draw_s_c4=new C.Color(.3,.3,.9),_.draw_s_c5=new C.Color(.4,.4,.4),_.draw_s_lower=new C.Vec2,_.draw_s_upper=new C.Vec2,_.draw_s_perp=new C.Vec2,_);function _(t){var e=s.call(this,t)||this;return e.localAnchorA=new C.Vec2,e.localAnchorB=new C.Vec2,e.localXAxisA=new C.Vec2,e.localYAxisA=new C.Vec2,e.impulse=0,e.motorImpulse=0,e.springImpulse=0,e.lowerImpulse=0,e.upperImpulse=0,e.translation=0,e.lowerTranslation=0,e.upperTranslation=0,e.maxMotorTorque=0,e.motorSpeed=0,e.enableLimit=!1,e.enableMotor=!1,e.stiffness=0,e.damping=0,e.indexA=0,e.indexB=0,e.localCenterA=new C.Vec2,e.localCenterB=new C.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.ax=new C.Vec2,e.ay=new C.Vec2,e.sAx=0,e.sBx=0,e.sAy=0,e.sBy=0,e.mass=0,e.motorMass=0,e.axialMass=0,e.springMass=0,e.bias=0,e.gamma=0,e.qA=new C.Rot,e.qB=new C.Rot,e.lalcA=new C.Vec2,e.lalcB=new C.Vec2,e.rA=new C.Vec2,e.rB=new C.Vec2,e.localAnchorA.copy(C.maybe(t.localAnchorA,C.Vec2.ZERO)),e.localAnchorB.copy(C.maybe(t.localAnchorB,C.Vec2.ZERO)),e.localXAxisA.copy(C.maybe(t.localAxisA,C.Vec2.UNITX)),C.Vec2.CrossOneV(e.localXAxisA,e.localYAxisA),e.lowerTranslation=C.maybe(t.lowerTranslation,0),e.upperTranslation=C.maybe(t.upperTranslation,0),e.enableLimit=C.maybe(t.enableLimit,!1),e.maxMotorTorque=C.maybe(t.maxMotorTorque,0),e.motorSpeed=C.maybe(t.motorSpeed,0),e.enableMotor=C.maybe(t.enableMotor,!1),e.ax.setZero(),e.ay.setZero(),e.stiffness=C.maybe(t.stiffness,0),e.damping=C.maybe(t.damping,0),e}C.WheelJoint=o}(b2=b2||{}),function(J){var t=(E.prototype.setDestructionListener=function(t){this.destructionListener=t},E.prototype.setContactFilter=function(t){this.contactManager.contactFilter=t},E.prototype.setContactListener=function(t){this.contactManager.contactListener=t},E.prototype.setDebugDraw=function(t){this.debugDrawInstance=t},E.prototype.createBody=function(t){if(void 0===t&&(t={}),this.isLocked())throw new Error;var e=new J.Body(t,this);return e.prev=null,e.next=this.bodyList,this.bodyList&&(this.bodyList.prev=e),this.bodyList=e,++this.bodyCount,e},E.prototype.destroyBody=function(t){if(this.isLocked())throw new Error;for(var e=t.jointList;e;){var i=e,e=e.next;this.destructionListener&&this.destructionListener.sayGoodbyeJoint(i.joint),this.destroyJoint(i.joint),t.jointList=e}t.jointList=null;for(var s=t.controllerList;s;){var o=s,s=s.nextController;o.controller.removeBody(t)}for(var n=t.contactList;n;){var r=n,n=n.next;this.contactManager.destroy(r.contact)}t.contactList=null;for(var a=t.fixtureList;a;){var c=a,a=a.next;this.destructionListener&&this.destructionListener.sayGoodbyeFixture(c),c.destroyProxies(),c.reset(),t.fixtureList=a,--t.fixtureCount}t.fixtureList=null,t.fixtureCount=0,t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.bodyList&&(this.bodyList=t.next),--this.bodyCount},E._createJoint=function(t){switch(t.type){case J.JointType.DistanceJoint:return new J.DistanceJoint(t);case J.JointType.MouseJoint:return new J.MouseJoint(t);case J.JointType.PrismaticJoint:return new J.PrismaticJoint(t);case J.JointType.RevoluteJoint:return new J.RevoluteJoint(t);case J.JointType.PulleyJoint:return new J.PulleyJoint(t);case J.JointType.GearJoint:return new J.GearJoint(t);case J.JointType.WheelJoint:return new J.WheelJoint(t);case J.JointType.WeldJoint:return new J.WeldJoint(t);case J.JointType.FrictionJoint:return new J.FrictionJoint(t);case J.JointType.MotorJoint:return new J.MotorJoint(t);case J.JointType.AreaJoint:return new J.AreaJoint(t)}throw new Error},E._destroyJoint=function(t){},E.prototype.createJoint=function(t){if(this.isLocked())throw new Error;var e=E._createJoint(t);e.prev=null,e.next=this.jointList,this.jointList&&(this.jointList.prev=e),this.jointList=e,++this.jointCount,e.edgeA.prev=null,e.edgeA.next=e.bodyA.jointList,e.bodyA.jointList&&(e.bodyA.jointList.prev=e.edgeA),e.bodyA.jointList=e.edgeA,e.edgeB.prev=null,e.edgeB.next=e.bodyB.jointList,e.bodyB.jointList&&(e.bodyB.jointList.prev=e.edgeB),e.bodyB.jointList=e.edgeB;var i=e.bodyA,s=e.bodyB;if(!e.collideConnected)for(var o=s.getContactList();o;)o.other===i&&o.contact.glagForFiltering(),o=o.next;return e},E.prototype.destroyJoint=function(t){if(this.isLocked())throw new Error;t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.jointList&&(this.jointList=t.next);var e=t.bodyA,i=t.bodyB,s=t.collideConnected;if(e.setAwake(!0),i.setAwake(!0),t.edgeA.prev&&(t.edgeA.prev.next=t.edgeA.next),t.edgeA.next&&(t.edgeA.next.prev=t.edgeA.prev),t.edgeA===e.jointList&&(e.jointList=t.edgeA.next),t.edgeA.reset(),t.edgeB.prev&&(t.edgeB.prev.next=t.edgeB.next),t.edgeB.next&&(t.edgeB.next.prev=t.edgeB.prev),t.edgeB===i.jointList&&(i.jointList=t.edgeB.next),t.edgeB.reset(),E._destroyJoint(t),--this.jointCount,!s)for(var o=i.getContactList();o;)o.other===e&&o.contact.glagForFiltering(),o=o.next},E.prototype.createParticleSystem=function(t){if(this.isLocked())throw new Error;var e=new J.ParticleSystem(t,this);return e.prev=null,e.next=this.particleSystemList,this.particleSystemList&&(this.particleSystemList.prev=e),this.particleSystemList=e},E.prototype.destroyParticleSystem=function(t){if(this.isLocked())throw new Error;t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.particleSystemList&&(this.particleSystemList=t.next)},E.prototype.calculateReasonableParticleIterations=function(t){if(null===this.particleSystemList)return 1;return J.CalculateParticleIterations(this.gravity.length(),function(t){for(var e=J.maxFloat,i=t.getParticleSystemList();null!==i;i=i.next)e=J.Min(e,i.getRadius());return e}(this),t)},E.prototype.step=function(t,e,i,s){void 0===s&&(s=this.calculateReasonableParticleIterations(t));var o=E.step_s_stepTimer.reset();this.newContacts&&(this.contactManager.findNewContacts(),this.newContacts=!1),this.locked=!0;var n=E.step_s_step;n.dt=t,n.velocityIterations=e,n.positionIterations=i,n.particleIterations=s,n.inv_dt=0<t?1/t:0,n.dtRatio=this.inv_dt0*t,n.warmStarting=this.warmStarting;var r,a=E.step_s_timer.reset();if(this.contactManager.collide(),this.profile.collide=a.getMilliseconds(),this.stepComplete&&0<n.dt){for(var c=E.step_s_timer.reset(),l=this.particleSystemList;l;l=l.next)l.solve(n);this.solve(n),this.profile.solve=c.getMilliseconds()}this.continuousPhysics&&0<n.dt&&(r=E.step_s_timer.reset(),this.solveTOI(n),this.profile.solveTOI=r.getMilliseconds()),0<n.dt&&(this.inv_dt0=n.inv_dt),this.clearForcesFlag&&this.clearForces(),this.locked=!1,this.profile.step=o.getMilliseconds()},E.prototype.clearForces=function(){for(var t=this.bodyList;t;t=t.next)t.force.setZero(),t.torque=0},E.prototype.drawParticleSystem=function(t){var e,i,s,o;null===this.debugDrawInstance||(e=t.getParticleCount())&&(i=t.getRadius(),s=t.getPositionBuffer(),t.colorBuffer.data?(o=t.getColorBuffer(),this.debugDrawInstance.drawParticles(s,i,o,e)):this.debugDrawInstance.drawParticles(s,i,null,e))},E.prototype.debugDraw=function(){if(null!==this.debugDrawInstance){var t=this.debugDrawInstance.getFlags(),e=E.debugdraw_s_color.setRGB(0,0,0);if(t&J.DrawFlags.ShapeBit)for(var i=this.bodyList;i;i=i.next){var s=i.xf;this.debugDrawInstance.pushTransform(s);for(var o=i.getFixtureList();o;o=o.next)i.getType()===J.BodyType.DynamicBody&&0===i.mass?this.drawShape(o,new J.Color(1,0,0)):(i.isEnabled()?i.getType()===J.BodyType.StaticBody?e.setRGB(.5,.9,.5):i.getType()===J.BodyType.KinematicBody?e.setRGB(.5,.5,.9):i.isAwake()?e.setRGB(.9,.7,.7):e.setRGB(.6,.6,.6):e.setRGB(.5,.5,.3),this.drawShape(o,e));this.debugDrawInstance.popTransform(s)}if(t&J.DrawFlags.ParticleBit)for(var n=this.particleSystemList;n;n=n.next)this.drawParticleSystem(n);if(t&J.DrawFlags.JointBit)for(var r=this.jointList;r;r=r.next)r.draw(this.debugDrawInstance);if(t&J.DrawFlags.PairBit){e.setRGB(.3,.9,.9);for(var a=this.contactManager.contactList;a;a=a.next){var c=a.getFixtureA(),l=a.getFixtureB(),h=a.getChildIndexA(),u=a.getChildIndexB(),p=c.getAABB(h).getCenter(),d=l.getAABB(u).getCenter();this.debugDrawInstance.drawSegment(p,d,e)}}if(t&J.DrawFlags.AABBBit){e.setRGB(.9,.3,.9);for(var f=E.debugdraw_s_vs,i=this.bodyList;i;i=i.next)if(i.isEnabled())for(o=i.getFixtureList();o;o=o.next)for(var y=0;y<o.proxyCount;++y){var V=o.proxies[y].treeNode.aabb;f[0].set(V.lowerBound.x,V.lowerBound.y),f[1].set(V.upperBound.x,V.lowerBound.y),f[2].set(V.upperBound.x,V.upperBound.y),f[3].set(V.lowerBound.x,V.upperBound.y),this.debugDrawInstance.drawPolygon(f,4,e)}}if(t&J.DrawFlags.CenterOfMassBit)for(i=this.bodyList;i;i=i.next){(s=E.debugdraw_s_xf).q.copy(i.xf.q),s.p.copy(i.getWorldCenter()),this.debugDrawInstance.drawTransform(s)}if(t&J.DrawFlags.ControllerBit)for(var v=this.controllerList;v;v=v.next)v.draw(this.debugDrawInstance)}},E.prototype.queryAABB=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof J.QueryCallback?this._queryAABB(t[0],t[1]):this._queryAABB(null,t[0],t[1])},E.prototype._queryAABB=function(i,t,s){if(this.contactManager.broadPhase.query(t,function(t){var e=t.userData.fixture;return i?i.reportFixture(e):!s||s(e)}),i instanceof J.QueryCallback)for(var e=this.particleSystemList;e;e=e.next)i.shouldQueryParticleSystem(e)&&e.queryAABB(i,t)},E.prototype.queryAllAABB=function(t,e){return void 0===e&&(e=[]),this.queryAABB(t,function(t){return e.push(t),!0}),e},E.prototype.queryPointAABB=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof J.QueryCallback?this._queryPointAABB(t[0],t[1]):this._queryPointAABB(null,t[0],t[1])},E.prototype._queryPointAABB=function(i,t,s){if(this.contactManager.broadPhase.queryPoint(t,function(t){var e=t.userData.fixture;return i?i.reportFixture(e):!s||s(e)}),i instanceof J.QueryCallback)for(var e=this.particleSystemList;e;e=e.next)i.shouldQueryParticleSystem(e)&&e.queryPointAABB(i,t)},E.prototype.queryAllPointAABB=function(t,e){return void 0===e&&(e=[]),this.queryPointAABB(t,function(t){return e.push(t),!0}),e},E.prototype.queryFixtureShape=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof J.QueryCallback?this._queryFixtureShape(t[0],t[1],t[2],t[3]):this._queryFixtureShape(null,t[0],t[1],t[2],t[3])},E.prototype._queryFixtureShape=function(s,o,n,r,a){var t=E.queryFixtureShape_s_aabb;if(o.computeAABB(t,r,n),this.contactManager.broadPhase.query(t,function(t){var e=t.userData,i=e.fixture;if(J.testOverlapShape(o,n,i.getShape(),e.childIndex,r,i.getBody().getTransform())){if(s)return s.reportFixture(i);if(a)return a(i)}return!0}),s instanceof J.QueryCallback)for(var e=this.particleSystemList;e;e=e.next)s.shouldQueryParticleSystem(e)&&e.queryAABB(s,t)},E.prototype.queryAllFixtureShape=function(t,e,i,s){return void 0===s&&(s=[]),this.queryFixtureShape(t,e,i,function(t){return s.push(t),!0}),s},E.prototype.queryFixturePoint=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof J.QueryCallback?this._queryFixturePoint(t[0],t[1]):this._queryFixturePoint(null,t[0],t[1])},E.prototype._queryFixturePoint=function(i,s,o){if(this.contactManager.broadPhase.queryPoint(s,function(t){var e=t.userData.fixture;if(e.testPoint(s)){if(i)return i.reportFixture(e);if(o)return o(e)}return!0}),i)for(var t=this.particleSystemList;t;t=t.next)i.shouldQueryParticleSystem(t)&&t.queryPointAABB(i,s)},E.prototype.queryAllFixturePoint=function(t,e){return void 0===e&&(e=[]),this.queryFixturePoint(t,function(t){return e.push(t),!0}),e},E.prototype.rayCast=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof J.RayCastCallback?this._rayCast(t[0],t[1],t[2]):this._rayCast(null,t[0],t[1],t[2])},E.prototype._rayCast=function(c,l,h,u){var t=E.rayCast_s_input;if(t.maxFraction=1,t.p1.copy(l),t.p2.copy(h),this.contactManager.broadPhase.rayCast(t,function(t,e){var i=e.userData,s=i.fixture,o=i.childIndex,n=E.rayCast_s_output;if(s.rayCast(n,t,o)){var r=n.fraction,a=E.rayCast_s_point;if(a.set((1-r)*l.x+r*h.x,(1-r)*l.y+r*h.y),c)return c.reportFixture(s,a,n.normal,r);if(u)return u(s,a,n.normal,r)}return t.maxFraction}),c)for(var e=this.particleSystemList;e;e=e.next)c.shouldQueryParticleSystem(e)&&e.rayCast(c,l,h)},E.prototype.rayCastOne=function(t,e){var o=null,n=1;return this.rayCast(t,e,function(t,e,i,s){return s<n&&(n=s,o=t),n}),o},E.prototype.rayCastAll=function(t,e,o){return void 0===o&&(o=[]),this.rayCast(t,e,function(t,e,i,s){return o.push(t),1}),o},E.prototype.getParticleSystemList=function(){return this.particleSystemList},E.prototype.getContactList=function(){return this.contactManager.contactList},E.prototype.setAllowSleeping=function(t){if(t!==this.allowSleep&&(this.allowSleep=t,!this.allowSleep))for(var e=this.bodyList;e;e=e.next)e.setAwake(!0)},E.prototype.getAllowSleeping=function(){return this.allowSleep},E.prototype.setWarmStarting=function(t){this.warmStarting=t},E.prototype.getWarmStarting=function(){return this.warmStarting},E.prototype.setContinuousPhysics=function(t){this.continuousPhysics=t},E.prototype.getContinuousPhysics=function(){return this.continuousPhysics},E.prototype.setSubStepping=function(t){this.subStepping=t},E.prototype.getSubStepping=function(){return this.subStepping},E.prototype.getProxyCount=function(){return this.contactManager.broadPhase.getProxyCount()},E.prototype.getBodyCount=function(){return this.bodyCount},E.prototype.getJointCount=function(){return this.jointCount},E.prototype.getContactCount=function(){return this.contactManager.contactCount},E.prototype.getTreeHeight=function(){return this.contactManager.broadPhase.getTreeHeight()},E.prototype.getTreeBalance=function(){return this.contactManager.broadPhase.getTreeBalance()},E.prototype.getTreeQuality=function(){return this.contactManager.broadPhase.getTreeQuality()},E.prototype.setGravity=function(t,e){if(void 0===e&&(e=!0),!J.Vec2.IsEqualToV(this.gravity,t)&&(this.gravity.copy(t),e))for(var i=this.bodyList;i;i=i.next)i.setAwake(!0)},E.prototype.isLocked=function(){return this.locked},E.prototype.setAutoClearForces=function(t){this.clearForcesFlag=t},E.prototype.getAutoClearForces=function(){return this.clearForcesFlag},E.prototype.shiftOrigin=function(t){if(this.isLocked())throw new Error;for(var e=this.bodyList;e;e=e.next)e.xf.p.selfSub(t),e.sweep.c0.selfSub(t),e.sweep.c.selfSub(t);for(var i=this.jointList;i;i=i.next)i.shiftOrigin(t);this.contactManager.broadPhase.shiftOrigin(t)},E.prototype.getContactManager=function(){return this.contactManager},E.prototype.getProfile=function(){return this.profile},E.prototype.dump=function(t){if(!this.locked){t("const g: Vec2 = new Vec2(%.15f, %.15f);\n",this.gravity.x,this.gravity.y),t("this.world.SetGravity(g);\n"),t("const bodies: Body[] = [];\n"),t("const joints: Joint[] = [];\n");for(var e=0,i=this.bodyList;i;i=i.next)i.islandIndex=e,i.dump(t),++e;e=0;for(var s=this.jointList;s;s=s.next)s.index=e,++e;for(s=this.jointList;s;s=s.next)s.type!==J.JointType.GearJoint&&(t("{\n"),s.dump(t),t("}\n"));for(s=this.jointList;s;s=s.next)s.type===J.JointType.GearJoint&&(t("{\n"),s.dump(t),t("}\n"))}},E.prototype.drawShape=function(t,e){if(null!==this.debugDrawInstance){var i=t.getShape();switch(i.type){case J.ShapeType.CircleShape:var s=i.p,o=i.radius,n=J.Vec2.UNITX;this.debugDrawInstance.drawSolidCircle(s,o,n,e);break;case J.ShapeType.EdgeShape:var r=i,a=r.vertex1,c=r.vertex2;this.debugDrawInstance.drawSegment(a,c,e),!1===r.oneSided&&(this.debugDrawInstance.drawPoint(a,4,e),this.debugDrawInstance.drawPoint(c,4,e));break;case J.ShapeType.ChainShape:for(var l=i.count,a=(p=i.vertices)[0],h=1;h<l;++h){c=p[h];this.debugDrawInstance.drawSegment(a,c,e),a=c}break;case J.ShapeType.PolygonShape:var u=i.count,p=i.vertices;this.debugDrawInstance.drawSolidPolygon(p,u,e)}}},E.prototype.solve=function(t){for(var e=this.bodyList;e;e=e.next)e.xf0.copy(e.xf);for(var i=this.controllerList;i;i=i.next)i.step(t);this.profile.solveInit=0,this.profile.solveVelocity=0,this.profile.solvePosition=0;var s=this.island;s.initialize(this.bodyCount,this.contactManager.contactCount,this.jointCount,this.contactManager.contactListener);for(e=this.bodyList;e;e=e.next)e.islandFlag=!1;for(var o=this.contactManager.contactList;o;o=o.next)o.islandFlag=!1;for(var n=this.jointList;n;n=n.next)n.islandFlag=!1;for(var r=this.s_stack,a=this.bodyList;a;a=a.next)if(!a.islandFlag&&a.isAwake()&&a.isEnabled()&&a.getType()!==J.BodyType.StaticBody){s.clear();var c=0;for((r[c++]=a).islandFlag=!0;0<c;){if(!(e=r[--c]))throw new Error;if(s.addBody(e),e.getType()!==J.BodyType.StaticBody){e.awakeFlag=!0;for(var l=e.contactList;l;l=l.next){var h,u,p=l.contact;p.islandFlag||p.isEnabled()&&p.isTouching()&&(h=p.fixtureA.isSensor,u=p.fixtureB.isSensor,h||u||(s.addContact(p),p.islandFlag=!0,(d=l.other).islandFlag||((r[c++]=d).islandFlag=!0)))}for(var d,f=e.jointList;f;f=f.next){f.joint.islandFlag||(d=f.other).isEnabled()&&(s.addJoint(f.joint),f.joint.islandFlag=!0,d.islandFlag||((r[c++]=d).islandFlag=!0))}}}var y=new J.Profile;s.solve(y,t,this.gravity,this.allowSleep),this.profile.solveInit+=y.solveInit,this.profile.solveVelocity+=y.solveVelocity,this.profile.solvePosition+=y.solvePosition;for(var V=0;V<s.bodyCount;++V){(e=s.bodies[V]).getType()===J.BodyType.StaticBody&&(e.islandFlag=!1)}}for(V=0;V<r.length&&r[V];++V)r[V]=null;for(var v=new J.Timer,e=this.bodyList;e;e=e.next)e.islandFlag&&e.getType()!==J.BodyType.StaticBody&&e.synchronizeFixtures();this.contactManager.findNewContacts(),this.profile.broadphase=v.getMilliseconds()},E.prototype.solveTOI=function(t){var e=this.island;if(e.initialize(2*J.maxTOIContacts,J.maxTOIContacts,0,this.contactManager.contactListener),this.stepComplete){for(var i=this.bodyList;i;i=i.next)i.islandFlag=!1,i.sweep.alpha0=0;for(var s=this.contactManager.contactList;s;s=s.next)s.toiFlag=!1,s.islandFlag=!1,s.toiCount=0,s.toi=1}for(;;){for(var o=null,n=1,s=this.contactManager.contactList;s;s=s.next)if(s.isEnabled()&&!(s.toiCount>J.maxSubSteps)){var r=1;if(s.toiFlag)r=s.toi;else{var a=s.getFixtureA(),c=s.getFixtureB();if(a.isSensor||c.isSensor)continue;var l=a.getBody(),h=c.getBody(),u=l.type,p=h.type,d=l.isAwake()&&u!==J.BodyType.StaticBody,f=h.isAwake()&&p!==J.BodyType.StaticBody;if(!d&&!f)continue;var y=l.isBullet()||u!==J.BodyType.DynamicBody,V=h.isBullet()||p!==J.BodyType.DynamicBody;if(!y&&!V)continue;var v=l.sweep.alpha0;l.sweep.alpha0<h.sweep.alpha0?(v=h.sweep.alpha0,l.sweep.advance(v)):h.sweep.alpha0<l.sweep.alpha0&&(v=l.sweep.alpha0,h.sweep.advance(v));var x=s.getChildIndexA(),g=s.getChildIndexB(),m=E.solveTOI_s_toi_input;m.proxyA.setShape(a.getShape(),x),m.proxyB.setShape(c.getShape(),g),m.sweepA.copy(l.sweep),m.sweepB.copy(h.sweep),m.tMax=1;var B=E.solveTOI_s_toi_output;J.timeOfImpact(B,m);var A=B.t,r=B.state===J.TOIOutputState.Touching?J.Min(v+(1-v)*A,1):1;s.toi=r,s.toiFlag=!0}r<n&&(o=s,n=r)}if(null===o||1-10*J.epsilon<n){this.stepComplete=!0;break}var w=o.getFixtureA(),b=o.getFixtureB(),C=w.getBody(),_=b.getBody(),S=E.solveTOI_s_backup1.copy(C.sweep),M=E.solveTOI_s_backup2.copy(_.sweep);if(C.advance(n),_.advance(n),o.update(this.contactManager.contactListener),o.toiFlag=!1,++o.toiCount,o.isEnabled()&&o.isTouching()){C.setAwake(!0),_.setAwake(!0),e.clear(),e.addBody(C),e.addBody(_),e.addContact(o),C.islandFlag=!0,_.islandFlag=!0,o.islandFlag=!0;for(var P=0;P<2;++P){if((q=0===P?C:_).type===J.BodyType.DynamicBody)for(var I=q.contactList;I&&e.bodyCount!==e.bodyCapacity&&e.contactCount!==e.contactCapacity;I=I.next){var T,F,D,L,R=I.contact;R.islandFlag||((T=I.other).type!==J.BodyType.DynamicBody||q.isBullet()||T.isBullet())&&(F=R.fixtureA.isSensor,D=R.fixtureB.isSensor,F||D||(L=E.solveTOI_s_backup.copy(T.sweep),T.islandFlag||T.advance(n),R.update(this.contactManager.contactListener),R.isEnabled()&&R.isTouching()?(R.islandFlag=!0,e.addContact(R),T.islandFlag||(T.islandFlag=!0,T.type!==J.BodyType.StaticBody&&T.setAwake(!0),e.addBody(T))):(T.sweep.copy(L),T.synchronizeTransform())))}}var k=E.solveTOI_s_subStep;k.dt=(1-n)*t.dt,k.inv_dt=1/k.dt,k.dtRatio=1,k.positionIterations=20,k.velocityIterations=t.velocityIterations,k.particleIterations=t.particleIterations,k.warmStarting=!1,e.solveTOI(k,C.islandIndex,_.islandIndex);for(var q,P=0;P<e.bodyCount;++P){if((q=e.bodies[P]).islandFlag=!1,q.type===J.BodyType.DynamicBody){q.synchronizeFixtures();for(I=q.contactList;I;I=I.next)I.contact.toiFlag=!1,I.contact.islandFlag=!1}}if(this.contactManager.findNewContacts(),this.subStepping){this.stepComplete=!1;break}}else o.setEnabled(!1),C.sweep.copy(S),_.sweep.copy(M),C.synchronizeTransform(),_.synchronizeTransform()}},E.prototype.addController=function(t){return t.next=this.controllerList,t.prev=null,this.controllerList&&(this.controllerList.prev=t),this.controllerList=t,++this.controllerCount,t},E.prototype.removeController=function(t){return t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),this.controllerList===t&&(this.controllerList=t.next),--this.controllerCount,t.prev=null,t.next=null,t},E.step_s_step=new J.TimeStep,E.step_s_stepTimer=new J.Timer,E.step_s_timer=new J.Timer,E.debugdraw_s_color=new J.Color(0,0,0),E.debugdraw_s_vs=J.Vec2.MakeArray(4),E.debugdraw_s_xf=new J.Transform,E.queryFixtureShape_s_aabb=new J.AABB,E.rayCast_s_input=new J.RayCastInput,E.rayCast_s_output=new J.RayCastOutput,E.rayCast_s_point=new J.Vec2,E.solveTOI_s_subStep=new J.TimeStep,E.solveTOI_s_backup=new J.Sweep,E.solveTOI_s_backup1=new J.Sweep,E.solveTOI_s_backup2=new J.Sweep,E.solveTOI_s_toi_input=new J.TOIInput,E.solveTOI_s_toi_output=new J.TOIOutput,E);function E(t){this.contactManager=new J.ContactManager,this.bodyList=null,this.jointList=null,this.particleSystemList=null,this.bodyCount=0,this.jointCount=0,this.gravity=new J.Vec2,this.allowSleep=!0,this.inv_dt0=0,this.newContacts=!1,this.locked=!1,this.clearForcesFlag=!0,this.warmStarting=!0,this.continuousPhysics=!0,this.subStepping=!1,this.stepComplete=!0,this.profile=new J.Profile,this.island=new J.Island,this.s_stack=[],this.controllerList=null,this.controllerCount=0,this.gravity.copy(t)}J.World=t}(b2=b2||{}),function(n){var e,t;(t=e=n.ParticleGroupFlag||(n.ParticleGroupFlag={}))[t.SolidParticleGroup=1]="SolidParticleGroup",t[t.RigidParticleGroup=2]="RigidParticleGroup",t[t.ParticleGroupCanBeEmpty=4]="ParticleGroupCanBeEmpty",t[t.ParticleGroupWillBeDestroyed=8]="ParticleGroupWillBeDestroyed",t[t.ParticleGroupNeedsUpdateDepth=16]="ParticleGroupNeedsUpdateDepth",t[t.ParticleGroupInternalMask=24]="ParticleGroupInternalMask";function i(){this.flags=0,this.groupFlags=0,this.position=new n.Vec2,this.angle=0,this.linearVelocity=new n.Vec2,this.angularVelocity=0,this.color=new n.Color,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null}n.ParticleGroupDef=i;var s=(o.prototype.getNext=function(){return this.next},o.prototype.getParticleSystem=function(){return this.system},o.prototype.getParticleCount=function(){return this.lastIndex-this.firstIndex},o.prototype.getBufferIndex=function(){return this.firstIndex},o.prototype.containsParticle=function(t){return this.firstIndex<=t&&t<this.lastIndex},o.prototype.getAllParticleFlags=function(){if(!this.system.flagsBuffer.data)throw new Error;for(var t=0,e=this.firstIndex;e<this.lastIndex;e++)t|=this.system.flagsBuffer.data[e];return t},o.prototype.getGroupFlags=function(){return this.groupFlags},o.prototype.setGroupFlags=function(t){t|=this.groupFlags&e.ParticleGroupInternalMask,this.system.setGroupFlags(this,t)},o.prototype.getMass=function(){return this.updateStatistics(),this.mass},o.prototype.getInertia=function(){return this.updateStatistics(),this.inertia},o.prototype.getCenter=function(){return this.updateStatistics(),this.center},o.prototype.getLinearVelocity=function(){return this.updateStatistics(),this.linearVelocity},o.prototype.getAngularVelocity=function(){return this.updateStatistics(),this.angularVelocity},o.prototype.getTransform=function(){return this.transform},o.prototype.getPosition=function(){return this.transform.p},o.prototype.getAngle=function(){return this.transform.q.getAngle()},o.prototype.getLinearVelocityFromWorldPoint=function(t,e){var i=o.GetLinearVelocityFromWorldPoint_s_t0;return this.updateStatistics(),n.Vec2.AddVCrossSV(this.linearVelocity,this.angularVelocity,n.Vec2.SubVV(t,this.center,i),e)},o.prototype.getUserData=function(){return this.userData},o.prototype.setUserData=function(t){this.userData=t},o.prototype.applyForce=function(t){this.system.applyForce(this.firstIndex,this.lastIndex,t)},o.prototype.applyLinearImpulse=function(t){this.system.applyLinearImpulse(this.firstIndex,this.lastIndex,t)},o.prototype.destroyParticles=function(t){if(this.system.world.isLocked())throw new Error;for(var e=this.firstIndex;e<this.lastIndex;e++)this.system.destroyParticle(e,t)},o.prototype.updateStatistics=function(){if(!this.system.positionBuffer.data)throw new Error;if(!this.system.velocityBuffer.data)throw new Error;var t=new n.Vec2,e=new n.Vec2;if(this.timestamp!==this.system.timestamp){var i=this.system.getParticleMass();this.mass=i*(this.lastIndex-this.firstIndex),this.center.setZero(),this.linearVelocity.setZero();for(var s,o=this.firstIndex;o<this.lastIndex;o++)this.center.selfMulAdd(i,this.system.positionBuffer.data[o]),this.linearVelocity.selfMulAdd(i,this.system.velocityBuffer.data[o]);0<this.mass&&(s=1/this.mass,this.center.selfMul(s),this.linearVelocity.selfMul(s)),this.inertia=0,this.angularVelocity=0;for(o=this.firstIndex;o<this.lastIndex;o++)n.Vec2.SubVV(this.system.positionBuffer.data[o],this.center,t),n.Vec2.SubVV(this.system.velocityBuffer.data[o],this.linearVelocity,e),this.inertia+=i*n.Vec2.DotVV(t,t),this.angularVelocity+=i*n.Vec2.CrossVV(t,e);0<this.inertia&&(this.angularVelocity*=1/this.inertia),this.timestamp=this.system.timestamp}},o.GetLinearVelocityFromWorldPoint_s_t0=new n.Vec2,o);function o(t){this.firstIndex=0,this.lastIndex=0,this.groupFlags=0,this.strength=1,this.prev=null,this.next=null,this.timestamp=-1,this.mass=0,this.inertia=0,this.center=new n.Vec2,this.linearVelocity=new n.Vec2,this.angularVelocity=0,this.transform=new n.Transform,this.userData=null,this.system=t}n.ParticleGroup=s}(b2=b2||{}),function(tt){function l(t,e,i){var s=t[e];t[e]=t[i],t[i]=s}function h(t,e){return t<e}function u(t,e,i,s){void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===s&&(s=h);for(var o=e,n=[],r=0;;){for(;o+1<i;i++){var a=t[o+Math.floor(Math.random()*(i-o))];n[r++]=i;for(var c=o-1;;){for(;s(t[++c],a););for(;s(a,t[--i]););if(i<=c)break;l(t,c,i)}}if(0===r)break;o=i,i=n[--r]}return t}function v(t,e,i,s){return void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===s&&(s=h),u(t,e,i,s)}function e(t,e,i){void 0===i&&(i=t.length);for(var s=0,o=0;o<i;++o)e(t[o])||(o!==s?l(t,s++,o):++s);return s}function p(t,e,i,s,o){for(var n=i-e;0<n;){var r=Math.floor(n/2),a=e+r;o(t[a],s)?(e=++a,n-=r+1):n=r}return e}function d(t,e,i,s,o){for(var n=i-e;0<n;){var r=Math.floor(n/2),a=e+r;o(s,t[a])?n=r:(e=++a,n-=r+1)}return e}function f(t,e,i,s){for(var o=i;e!==o;)l(t,e++,o++),o===s?o=i:e===i&&(i=o)}var i=(t.prototype.append=function(){return this.count>=this.capacity&&this.grow(),this.count++},t.prototype.reserve=function(t){if(!(this.capacity>=t)){for(var e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}},t.prototype.grow=function(){var t=this.capacity?2*this.capacity:tt.minParticleSystemBufferCapacity;this.reserve(t)},t.prototype.free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},t.prototype.shorten=function(t){},t.prototype.getData=function(){return this.data},t.prototype.getCount=function(){return this.count},t.prototype.setCount=function(t){this.count=t},t.prototype.getCapacity=function(){return this.capacity},t.prototype.removeIf=function(t){this.count=e(this.data,t,this.count)},t.prototype.unique=function(t){this.count=function(t,e,i,s){if(e===i)return i;for(var o=e;++e!==i;)s(t[o],t[e])||l(t,++o,e);return++o}(this.data,0,this.count,t)},t);function t(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}tt.GrowableBuffer=i;var s,o=(s=tt.QueryCallback,__extends(n,s),n.prototype.shouldQueryParticleSystem=function(t){return!1},n.prototype.reportFixture=function(t){if(t.isSensor)return!0;for(var e=t.getShape().getChildCount(),i=0;i<e;i++)for(var s,o=t.getAABB(i),n=this.system.getInsideBoundsEnumerator(o);0<=(s=n.getNext());)this.reportFixtureAndParticle(t,i,s);return!0},n.prototype.reportParticle=function(t,e){return!1},n.prototype.reportFixtureAndParticle=function(t,e,i){},n);function n(t){var e=s.call(this)||this;return e.system=t,e}tt.FixtureParticleQueryCallback=o;var r=(a.prototype.setIndices=function(t,e){this.indexA=t,this.indexB=e},a.prototype.setWeight=function(t){this.weight=t},a.prototype.setNormal=function(t){this.normal.copy(t)},a.prototype.setFlags=function(t){this.flags=t},a.prototype.getIndexA=function(){return this.indexA},a.prototype.getIndexB=function(){return this.indexB},a.prototype.getWeight=function(){return this.weight},a.prototype.getNormal=function(){return this.normal},a.prototype.getFlags=function(){return this.flags},a.prototype.isEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y},a.prototype.isNotEqual=function(t){return!this.isEqual(t)},a.prototype.approximatelyEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&tt.Abs(this.weight-t.weight)<.01&&tt.Vec2.DistanceSquaredVV(this.normal,t.normal)<1e-4},a);function a(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new tt.Vec2,this.flags=0}tt.ParticleContact=r;var c=function(){this.index=0,this.weight=0,this.normal=new tt.Vec2,this.mass=0};tt.ParticleBodyContact=c;var y=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0};tt.ParticlePair=y;var V=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new tt.Vec2(0,0),this.pb=new tt.Vec2(0,0),this.pc=new tt.Vec2(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0};tt.ParticleTriad=V;var x=(g.prototype.Copy=function(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this},g.prototype.clone=function(){return(new g).Copy(this)},g);function g(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}tt.ParticleSystemDef=x;var m=(et.computeTag=function(t,e){return(e+et.yOffset>>>0<<et.yShift)+(et.xScale*t+et.xOffset>>>0)>>>0},et.computeRelativeTag=function(t,e,i){return t+(i<<et.yShift)+(e<<et.xShift)>>>0},et.prototype.drop=function(){for(;this.groupList;)this.destroyParticleGroup(this.groupList);this.freeUserOverridableBuffer(this.handleIndexBuffer),this.freeUserOverridableBuffer(this.flagsBuffer),this.freeUserOverridableBuffer(this.lastBodyContactStepBuffer),this.freeUserOverridableBuffer(this.bodyContactCountBuffer),this.freeUserOverridableBuffer(this.consecutiveContactStepsBuffer),this.freeUserOverridableBuffer(this.positionBuffer),this.freeUserOverridableBuffer(this.velocityBuffer),this.freeUserOverridableBuffer(this.colorBuffer),this.freeUserOverridableBuffer(this.userDataBuffer),this.freeUserOverridableBuffer(this.expirationTimeBuffer),this.freeUserOverridableBuffer(this.indexByExpirationTimeBuffer),this.freeBuffer(this.forceBuffer,this.internalAllocatedCapacity),this.freeBuffer(this.weightBuffer,this.internalAllocatedCapacity),this.freeBuffer(this.staticPressureBuffer,this.internalAllocatedCapacity),this.freeBuffer(this.accumulationBuffer,this.internalAllocatedCapacity),this.freeBuffer(this.accumulation2Buffer,this.internalAllocatedCapacity),this.freeBuffer(this.depthBuffer,this.internalAllocatedCapacity),this.freeBuffer(this.groupBuffer,this.internalAllocatedCapacity)},et.prototype.createParticle=function(t){if(this.world.isLocked())throw new Error;var e;if(this.count>=this.internalAllocatedCapacity&&(e=this.count?2*this.count:tt.minParticleSystemBufferCapacity,this.reallocateInternalAllocatedBuffers(e)),this.count>=this.internalAllocatedCapacity){if(!this.def.destroyByAge)return tt.invalidParticleIndex;this.destroyOldestParticle(0,!1),this.solveZombie()}var i=this.count++;this.flagsBuffer.data[i]=0,this.lastBodyContactStepBuffer.data&&(this.lastBodyContactStepBuffer.data[i]=0),this.bodyContactCountBuffer.data&&(this.bodyContactCountBuffer.data[i]=0),this.consecutiveContactStepsBuffer.data&&(this.consecutiveContactStepsBuffer.data[i]=0),this.positionBuffer.data[i]=(this.positionBuffer.data[i]||new tt.Vec2).copy(tt.maybe(t.position,tt.Vec2.ZERO)),this.velocityBuffer.data[i]=(this.velocityBuffer.data[i]||new tt.Vec2).copy(tt.maybe(t.velocity,tt.Vec2.ZERO)),this.weightBuffer[i]=0,this.forceBuffer[i]=(this.forceBuffer[i]||new tt.Vec2).setZero(),this.staticPressureBuffer&&(this.staticPressureBuffer[i]=0),this.depthBuffer&&(this.depthBuffer[i]=0);var s=(new tt.Color).copy(tt.maybe(t.color,tt.Color.ZERO));!this.colorBuffer.data&&s.isZero()||(this.colorBuffer.data=this.requestBuffer(this.colorBuffer.data),this.colorBuffer.data[i]=(this.colorBuffer.data[i]||new tt.Color).copy(s)),(this.userDataBuffer.data||t.userData)&&(this.userDataBuffer.data=this.requestBuffer(this.userDataBuffer.data),this.userDataBuffer.data[i]=t.userData),this.handleIndexBuffer.data&&(this.handleIndexBuffer.data[i]=null);var o=this.proxyBuffer.data[this.proxyBuffer.append()],n=tt.maybe(t.lifetime,0),r=0<n;(this.expirationTimeBuffer.data||r)&&(this.setParticleLifetime(i,r?n:this.expirationTimeToLifetime(-this.getQuantizedTimeElapsed())),this.indexByExpirationTimeBuffer.data[i]=i),o.index=i;var a=tt.maybe(t.group,null);return(this.groupBuffer[i]=a)&&(a.firstIndex<a.lastIndex?this.rotateBuffer(a.firstIndex,a.lastIndex,i):a.firstIndex=i,a.lastIndex=1+i),this.setParticleFlags(i,tt.maybe(t.flags,0)),i},et.prototype.getParticleHandleFromIndex=function(t){this.handleIndexBuffer.data=this.requestBuffer(this.handleIndexBuffer.data);var e=this.handleIndexBuffer.data[t];return e||((e=new tt.ParticleHandle).setIndex(t),this.handleIndexBuffer.data[t]=e)},et.prototype.destroyParticle=function(t,e){void 0===e&&(e=!1);var i=tt.ParticleFlag.ZombieParticle;e&&(i|=tt.ParticleFlag.DestructionListenerParticle),this.setParticleFlags(t,this.flagsBuffer.data[t]|i)},et.prototype.destroyOldestParticle=function(t,e){void 0===e&&(e=!1);var i=this.getParticleCount(),s=this.indexByExpirationTimeBuffer.data[i-(t+1)],o=this.indexByExpirationTimeBuffer.data[t];this.destroyParticle(0<this.expirationTimeBuffer.data[s]?s:o,e)},et.prototype.destroyParticlesInShape=function(t,e,i){void 0===i&&(i=!1);var s=et.DestroyParticlesInShape_s_aabb;if(this.world.isLocked())throw new Error;var o=new j(this,t,e,i),n=s;return t.computeAABB(n,e,0),this.world.queryAABB(o,n),o.isDestroyed()},et.prototype.createParticleGroup=function(t){var e=et.createParticleGroup_s_transform;if(this.world.isLocked())throw new Error;var i=e;i.setPositionAngle(tt.maybe(t.position,tt.Vec2.ZERO),tt.maybe(t.angle,0));var s=this.count;if(t.shape&&this.createParticlesWithShapeForGroup(t.shape,t,i),t.shapes&&this.createParticlesWithShapesForGroup(t.shapes,tt.maybe(t.shapeCount,t.shapes.length),t,i),t.positionData)for(var o=tt.maybe(t.particleCount,t.positionData.length),n=0;n<o;n++){var r=t.positionData[n];this.createParticleForGroup(t,i,r)}var a=this.count,c=new tt.ParticleGroup(this);c.firstIndex=s,c.lastIndex=a,c.strength=tt.maybe(t.strength,1),c.userData=t.userData,c.transform.copy(i),c.prev=null,c.next=this.groupList,this.groupList&&(this.groupList.prev=c),this.groupList=c,++this.groupCount;for(n=s;n<a;n++)this.groupBuffer[n]=c;this.setGroupFlags(c,tt.maybe(t.groupFlags,0));var l=new J;return this.updateContacts(!0),this.updatePairsAndTriads(s,a,l),t.group&&(this.joinParticleGroups(t.group,c),c=t.group),c},et.prototype.joinParticleGroups=function(t,e){if(this.world.isLocked())throw new Error;this.rotateBuffer(e.firstIndex,e.lastIndex,this.count),this.rotateBuffer(t.firstIndex,t.lastIndex,e.firstIndex);var i=new N(e.firstIndex);this.updateContacts(!0),this.updatePairsAndTriads(t.firstIndex,e.lastIndex,i);for(var s=e.firstIndex;s<e.lastIndex;s++)this.groupBuffer[s]=t;var o=t.groupFlags|e.groupFlags;this.setGroupFlags(t,o),t.lastIndex=e.lastIndex,e.firstIndex=e.lastIndex,this.destroyParticleGroup(e)},et.prototype.splitParticleGroup=function(t){this.updateContacts(!0);var e=t.getParticleCount(),i=tt.MakeArray(e,function(t){return new S});et.initializeParticleLists(t,i),this.mergeParticleListsInContact(t,i);var s=et.findLongestParticleList(t,i);this.mergeZombieParticleListNodes(t,i,s),this.createParticleGroupsFromParticleList(t,i,s),this.updatePairsAndTriadsWithParticleList(t,i)},et.prototype.getParticleGroupList=function(){return this.groupList},et.prototype.getParticleGroupCount=function(){return this.groupCount},et.prototype.getParticleCount=function(){return this.count},et.prototype.getMaxParticleCount=function(){return this.def.maxCount},et.prototype.setMaxParticleCount=function(t){this.def.maxCount=t},et.prototype.getAllParticleFlags=function(){return this.allParticleFlags},et.prototype.getAllGroupFlags=function(){return this.allGroupFlags},et.prototype.setPaused=function(t){this.paused=t},et.prototype.getPaused=function(){return this.paused},et.prototype.setDensity=function(t){this.def.density=t,this.inverseDensity=1/this.def.density},et.prototype.getDensity=function(){return this.def.density},et.prototype.setGravityScale=function(t){this.def.gravityScale=t},et.prototype.getGravityScale=function(){return this.def.gravityScale},et.prototype.setDamping=function(t){this.def.dampingStrength=t},et.prototype.getDamping=function(){return this.def.dampingStrength},et.prototype.setStaticPressureIterations=function(t){this.def.staticPressureIterations=t},et.prototype.getStaticPressureIterations=function(){return this.def.staticPressureIterations},et.prototype.setRadius=function(t){this.particleDiameter=2*t,this.squaredDiameter=this.particleDiameter*this.particleDiameter,this.inverseDiameter=1/this.particleDiameter},et.prototype.getRadius=function(){return this.particleDiameter/2},et.prototype.getPositionBuffer=function(){return this.positionBuffer.data},et.prototype.getVelocityBuffer=function(){return this.velocityBuffer.data},et.prototype.getColorBuffer=function(){return this.colorBuffer.data=this.requestBuffer(this.colorBuffer.data),this.colorBuffer.data},et.prototype.getGroupBuffer=function(){return this.groupBuffer},et.prototype.getWeightBuffer=function(){return this.weightBuffer},et.prototype.getUserDataBuffer=function(){return this.userDataBuffer.data=this.requestBuffer(this.userDataBuffer.data),this.userDataBuffer.data},et.prototype.getFlagsBuffer=function(){return this.flagsBuffer.data},et.prototype.setParticleFlags=function(t,e){this.flagsBuffer.data[t]&~e&&(this.needsUpdateAllParticleFlags=!0),~this.allParticleFlags&e&&(e&tt.ParticleFlag.TensileParticle&&(this.accumulation2Buffer=this.requestBuffer(this.accumulation2Buffer)),e&tt.ParticleFlag.ColorMixingParticle&&(this.colorBuffer.data=this.requestBuffer(this.colorBuffer.data)),this.allParticleFlags|=e),this.flagsBuffer.data[t]=e},et.prototype.getParticleFlags=function(t){return this.flagsBuffer.data[t]},et.prototype.setFlagsBuffer=function(t){this.setUserOverridableBuffer(this.flagsBuffer,t)},et.prototype.setPositionBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,i=new Array(e),s=0;s<e;++s)i[s]=new tt.TypedVec2(t.subarray(2*s,2*s+2));t=i}this.setUserOverridableBuffer(this.positionBuffer,t)},et.prototype.setVelocityBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,i=new Array(e),s=0;s<e;++s)i[s]=new tt.TypedVec2(t.subarray(2*s,2*s+2));t=i}this.setUserOverridableBuffer(this.velocityBuffer,t)},et.prototype.setColorBuffer=function(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;for(var e=t.length/4,i=new Array(e),s=0;s<e;++s)i[s]=new tt.TypedColor(t.subarray(4*s,4*s+4));t=i}this.setUserOverridableBuffer(this.colorBuffer,t)},et.prototype.setUserDataBuffer=function(t){this.setUserOverridableBuffer(this.userDataBuffer,t)},et.prototype.getContacts=function(){return this.contactBuffer.data},et.prototype.getContactCount=function(){return this.contactBuffer.count},et.prototype.getBodyContacts=function(){return this.bodyContactBuffer.data},et.prototype.getBodyContactCount=function(){return this.bodyContactBuffer.count},et.prototype.getPairs=function(){return this.pairBuffer.data},et.prototype.getPairCount=function(){return this.pairBuffer.count},et.prototype.getTriads=function(){return this.triadBuffer.data},et.prototype.getTriadCount=function(){return this.triadBuffer.count},et.prototype.setStuckThreshold=function(t){0<(this.stuckThreshold=t)&&(this.lastBodyContactStepBuffer.data=this.requestBuffer(this.lastBodyContactStepBuffer.data),this.bodyContactCountBuffer.data=this.requestBuffer(this.bodyContactCountBuffer.data),this.consecutiveContactStepsBuffer.data=this.requestBuffer(this.consecutiveContactStepsBuffer.data))},et.prototype.getStuckCandidates=function(){return this.stuckParticleBuffer.getData()},et.prototype.getStuckCandidateCount=function(){return this.stuckParticleBuffer.getCount()},et.prototype.computeCollisionEnergy=function(){for(var t=et.computeCollisionEnergy_s_v,e=this.velocityBuffer.data,i=0,s=0;s<this.contactBuffer.count;s++){var o=this.contactBuffer.data[s],n=o.indexA,r=o.indexB,a=o.normal,c=tt.Vec2.SubVV(e[r],e[n],t),l=tt.Vec2.DotVV(c,a);l<0&&(i+=l*l)}return.5*this.getParticleMass()*i},et.prototype.setStrictContactCheck=function(t){this.def.strictContactCheck=t},et.prototype.getStrictContactCheck=function(){return this.def.strictContactCheck},et.prototype.setParticleLifetime=function(t,e){var i=null===this.indexByExpirationTimeBuffer.data;if(this.expirationTimeBuffer.data=this.requestBuffer(this.expirationTimeBuffer.data),this.indexByExpirationTimeBuffer.data=this.requestBuffer(this.indexByExpirationTimeBuffer.data),i)for(var s=this.getParticleCount(),o=0;o<s;++o)this.indexByExpirationTimeBuffer.data[o]=o;var n=e/this.def.lifetimeGranularity,r=0<n?this.getQuantizedTimeElapsed()+n:n;r!==this.expirationTimeBuffer.data[t]&&(this.expirationTimeBuffer.data[t]=r,this.expirationTimeBufferRequiresSorting=!0)},et.prototype.getParticleLifetime=function(t){return this.expirationTimeToLifetime(this.getExpirationTimeBuffer()[t])},et.prototype.setDestructionByAge=function(t){t&&this.getExpirationTimeBuffer(),this.def.destroyByAge=t},et.prototype.getDestructionByAge=function(){return this.def.destroyByAge},et.prototype.getExpirationTimeBuffer=function(){return this.expirationTimeBuffer.data=this.requestBuffer(this.expirationTimeBuffer.data),this.expirationTimeBuffer.data},et.prototype.expirationTimeToLifetime=function(t){return(0<t?t-this.getQuantizedTimeElapsed():t)*this.def.lifetimeGranularity},et.prototype.getIndexByExpirationTimeBuffer=function(){return this.getParticleCount()?this.setParticleLifetime(0,this.getParticleLifetime(0)):this.indexByExpirationTimeBuffer.data=this.requestBuffer(this.indexByExpirationTimeBuffer.data),this.indexByExpirationTimeBuffer.data},et.prototype.particleApplyLinearImpulse=function(t,e){this.applyLinearImpulse(t,t+1,e)},et.prototype.applyLinearImpulse=function(t,e,i){for(var s=this.velocityBuffer.data,o=(e-t)*this.getParticleMass(),n=(new tt.Vec2).copy(i).selfMul(1/o),r=t;r<e;r++)s[r].selfAdd(n)},et.isSignificantForce=function(t){return 0!==t.x||0!==t.y},et.prototype.particleApplyForce=function(t,e){et.isSignificantForce(e)&&this.forceCanBeApplied(this.flagsBuffer.data[t])&&(this.prepareForceBuffer(),this.forceBuffer[t].selfAdd(e))},et.prototype.applyForce=function(t,e,i){var s=(new tt.Vec2).copy(i).selfMul(1/(e-t));if(et.isSignificantForce(s)){this.prepareForceBuffer();for(var o=t;o<e;o++)this.forceBuffer[o].selfAdd(s)}},et.prototype.getNext=function(){return this.next},et.prototype.queryAABB=function(t,e){if(0!==this.proxyBuffer.count)for(var i=this.proxyBuffer.count,s=p(this.proxyBuffer.data,0,i,et.computeTag(this.inverseDiameter*e.lowerBound.x,this.inverseDiameter*e.lowerBound.y),w.compareProxyTag),o=d(this.proxyBuffer.data,s,i,et.computeTag(this.inverseDiameter*e.upperBound.x,this.inverseDiameter*e.upperBound.y),w.compareTagProxy),n=this.positionBuffer.data,r=s;r<o;++r){var a=this.proxyBuffer.data[r].index,c=n[a];if(e.lowerBound.x<c.x&&c.x<e.upperBound.x&&e.lowerBound.y<c.y&&c.y<e.upperBound.y&&!t.reportParticle(this,a))break}},et.prototype.queryShapeAABB=function(t,e,i,s){void 0===s&&(s=0);var o=et.queryShapeAABB_s_aabb;e.computeAABB(o,i,s),this.queryAABB(t,o)},et.prototype.queryPointAABB=function(t,e,i){void 0===i&&(i=tt.linearSlop);var s=et.QueryPointAABB_s_aabb;s.lowerBound.set(e.x-i,e.y-i),s.upperBound.set(e.x+i,e.y+i),this.queryAABB(t,s)},et.prototype.rayCast=function(t,e,i){var s=et.rayCast_s_aabb,o=et.rayCast_s_p,n=et.rayCast_s_v,r=et.rayCast_s_n,a=et.rayCast_s_point;if(0!==this.proxyBuffer.count){var c=this.positionBuffer.data,l=s;tt.Vec2.MinV(e,i,l.lowerBound),tt.Vec2.MaxV(e,i,l.upperBound);for(var h,u=1,p=tt.Vec2.SubVV(i,e,n),d=tt.Vec2.DotVV(p,p),f=this.getInsideBoundsEnumerator(l);0<=(h=f.getNext());){var y=tt.Vec2.SubVV(e,c[h],o),V=tt.Vec2.DotVV(y,p),v=V*V-d*(tt.Vec2.DotVV(y,y)-this.squaredDiameter);if(0<=v){var x=tt.Sqrt(v),g=(-V-x)/d;if(u<g)continue;if(g<0&&((g=(-V+x)/d)<0||u<g))continue;var m=tt.Vec2.AddVMulSV(y,g,p,r);m.normalize();var B=t.reportParticle(this,h,tt.Vec2.AddVMulSV(e,g,p,a),m,g);if((u=tt.Min(u,B))<=0)break}}}},et.prototype.computeAABB=function(t){var e=this.getParticleCount();t.lowerBound.x=+tt.maxFloat,t.lowerBound.y=+tt.maxFloat,t.upperBound.x=-tt.maxFloat,t.upperBound.y=-tt.maxFloat;for(var i=this.positionBuffer.data,s=0;s<e;s++){var o=i[s];tt.Vec2.MinV(t.lowerBound,o,t.lowerBound),tt.Vec2.MaxV(t.upperBound,o,t.upperBound)}t.lowerBound.x-=this.particleDiameter,t.lowerBound.y-=this.particleDiameter,t.upperBound.x+=this.particleDiameter,t.upperBound.y+=this.particleDiameter},et.prototype.freeBuffer=function(t,e){null!==t&&(t.length=0)},et.prototype.freeUserOverridableBuffer=function(t){0===t.userSuppliedCapacity&&this.freeBuffer(t.data,this.internalAllocatedCapacity)},et.prototype.reallocateBuffer3=function(t,e,i){if(i<=e)throw new Error;var s=t?t.slice():[];return s.length=i,s},et.prototype.reallocateBuffer5=function(t,e,i,s,o){if(s<=i)throw new Error;if(e&&!(s<=e))throw new Error;return o&&!t||e||(t=this.reallocateBuffer3(t,i,s)),t},et.prototype.reallocateBuffer4=function(t,e,i,s){return this.reallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,s)},et.prototype.requestBuffer=function(t){return t||(0===this.internalAllocatedCapacity&&this.reallocateInternalAllocatedBuffers(tt.minParticleSystemBufferCapacity),(t=[]).length=this.internalAllocatedCapacity),t},et.prototype.reallocateHandleBuffers=function(t){this.handleIndexBuffer.data=this.reallocateBuffer4(this.handleIndexBuffer,this.internalAllocatedCapacity,t,!0)},et.prototype.reallocateInternalAllocatedBuffers=function(t){function e(t,e){return e&&e<t?e:t}var i;t=e(t,this.def.maxCount),t=e(t,this.flagsBuffer.userSuppliedCapacity),t=e(t,this.positionBuffer.userSuppliedCapacity),t=e(t,this.velocityBuffer.userSuppliedCapacity),t=e(t,this.colorBuffer.userSuppliedCapacity),t=e(t,this.userDataBuffer.userSuppliedCapacity),this.internalAllocatedCapacity<t&&(this.reallocateHandleBuffers(t),this.flagsBuffer.data=this.reallocateBuffer4(this.flagsBuffer,this.internalAllocatedCapacity,t,!1),i=0<this.stuckThreshold,this.lastBodyContactStepBuffer.data=this.reallocateBuffer4(this.lastBodyContactStepBuffer,this.internalAllocatedCapacity,t,i),this.bodyContactCountBuffer.data=this.reallocateBuffer4(this.bodyContactCountBuffer,this.internalAllocatedCapacity,t,i),this.consecutiveContactStepsBuffer.data=this.reallocateBuffer4(this.consecutiveContactStepsBuffer,this.internalAllocatedCapacity,t,i),this.positionBuffer.data=this.reallocateBuffer4(this.positionBuffer,this.internalAllocatedCapacity,t,!1),this.velocityBuffer.data=this.reallocateBuffer4(this.velocityBuffer,this.internalAllocatedCapacity,t,!1),this.forceBuffer=this.reallocateBuffer5(this.forceBuffer,0,this.internalAllocatedCapacity,t,!1),this.weightBuffer=this.reallocateBuffer5(this.weightBuffer,0,this.internalAllocatedCapacity,t,!1),this.staticPressureBuffer=this.reallocateBuffer5(this.staticPressureBuffer,0,this.internalAllocatedCapacity,t,!0),this.accumulationBuffer=this.reallocateBuffer5(this.accumulationBuffer,0,this.internalAllocatedCapacity,t,!1),this.accumulation2Buffer=this.reallocateBuffer5(this.accumulation2Buffer,0,this.internalAllocatedCapacity,t,!0),this.depthBuffer=this.reallocateBuffer5(this.depthBuffer,0,this.internalAllocatedCapacity,t,!0),this.colorBuffer.data=this.reallocateBuffer4(this.colorBuffer,this.internalAllocatedCapacity,t,!0),this.groupBuffer=this.reallocateBuffer5(this.groupBuffer,0,this.internalAllocatedCapacity,t,!1),this.userDataBuffer.data=this.reallocateBuffer4(this.userDataBuffer,this.internalAllocatedCapacity,t,!0),this.expirationTimeBuffer.data=this.reallocateBuffer4(this.expirationTimeBuffer,this.internalAllocatedCapacity,t,!0),this.indexByExpirationTimeBuffer.data=this.reallocateBuffer4(this.indexByExpirationTimeBuffer,this.internalAllocatedCapacity,t,!1),this.internalAllocatedCapacity=t)},et.prototype.createParticleForGroup=function(t,e,i){var s=new tt.ParticleDef;s.flags=tt.maybe(t.flags,0),tt.Transform.mulXV(e,i,s.position),tt.Vec2.AddVV(tt.maybe(t.linearVelocity,tt.Vec2.ZERO),tt.Vec2.CrossSV(tt.maybe(t.angularVelocity,0),tt.Vec2.SubVV(s.position,tt.maybe(t.position,tt.Vec2.ZERO),tt.Vec2.s_t0),tt.Vec2.s_t0),s.velocity),s.color.copy(tt.maybe(t.color,tt.Color.ZERO)),s.lifetime=tt.maybe(t.lifetime,0),s.userData=t.userData,this.createParticle(s)},et.prototype.createParticlesStrokeShapeForGroup=function(t,e,i){var s=et.createParticlesStrokeShapeForGroup_s_edge,o=et.createParticlesStrokeShapeForGroup_s_d,n=et.createParticlesStrokeShapeForGroup_s_p,r=tt.maybe(e.stride,0);0===r&&(r=this.getParticleStride());for(var a=0,c=t.getChildCount(),l=0;l<c;l++){var h=null;t.getType()===tt.ShapeType.EdgeShape?h=t:(h=s,t.getChildEdge(h,l));for(var u=tt.Vec2.SubVV(h.vertex2,h.vertex1,o),p=u.length();a<p;){var d=tt.Vec2.AddVMulSV(h.vertex1,a/p,u,n);this.createParticleForGroup(e,i,d),a+=r}a-=p}},et.prototype.createParticlesFillShapeForGroup=function(t,e,i){var s=et.createParticlesFillShapeForGroup_s_aabb,o=et.createParticlesFillShapeForGroup_s_p,n=tt.maybe(e.stride,0);0===n&&(n=this.getParticleStride());var r=tt.Transform.IDENTITY,a=s;t.computeAABB(a,r,0);for(var c=Math.floor(a.lowerBound.y/n)*n;c<a.upperBound.y;c+=n)for(var l=Math.floor(a.lowerBound.x/n)*n;l<a.upperBound.x;l+=n){var h=o.set(l,c);t.testPoint(r,h)&&this.createParticleForGroup(e,i,h)}},et.prototype.createParticlesWithShapeForGroup=function(t,e,i){switch(t.getType()){case tt.ShapeType.EdgeShape:case tt.ShapeType.ChainShape:this.createParticlesStrokeShapeForGroup(t,e,i);break;case tt.ShapeType.PolygonShape:case tt.ShapeType.CircleShape:this.createParticlesFillShapeForGroup(t,e,i)}},et.prototype.createParticlesWithShapesForGroup=function(t,e,i,s){var o=new W(t,e);this.createParticlesFillShapeForGroup(o,i,s)},et.prototype.cloneParticle=function(t,e){var i=new tt.ParticleDef;i.flags=this.flagsBuffer.data[t],i.position.copy(this.positionBuffer.data[t]),i.velocity.copy(this.velocityBuffer.data[t]),this.colorBuffer.data&&i.color.copy(this.colorBuffer.data[t]),this.userDataBuffer.data&&(i.userData=this.userDataBuffer.data[t]),i.group=e;var s,o=this.createParticle(i);return this.handleIndexBuffer.data&&((s=this.handleIndexBuffer.data[t])&&s.setIndex(o),this.handleIndexBuffer.data[o]=s,this.handleIndexBuffer.data[t]=null),this.lastBodyContactStepBuffer.data&&(this.lastBodyContactStepBuffer.data[o]=this.lastBodyContactStepBuffer.data[t]),this.bodyContactCountBuffer.data&&(this.bodyContactCountBuffer.data[o]=this.bodyContactCountBuffer.data[t]),this.consecutiveContactStepsBuffer.data&&(this.consecutiveContactStepsBuffer.data[o]=this.consecutiveContactStepsBuffer.data[t]),this.hasForce&&this.forceBuffer[o].copy(this.forceBuffer[t]),this.staticPressureBuffer&&(this.staticPressureBuffer[o]=this.staticPressureBuffer[t]),this.depthBuffer&&(this.depthBuffer[o]=this.depthBuffer[t]),this.expirationTimeBuffer.data&&(this.expirationTimeBuffer.data[o]=this.expirationTimeBuffer.data[t]),o},et.prototype.destroyParticlesInGroup=function(t,e){void 0===e&&(e=!1);for(var i=t.firstIndex;i<t.lastIndex;i++)this.destroyParticle(i,e)},et.prototype.destroyParticleGroup=function(t){this.world.destructionListener&&this.world.destructionListener.sayGoodbyeParticleGroup(t),this.setGroupFlags(t,0);for(var e=t.firstIndex;e<t.lastIndex;e++)this.groupBuffer[e]=null;t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.groupList&&(this.groupList=t.next),--this.groupCount},et.particleCanBeConnected=function(t,e){return 0!=(t&(tt.ParticleFlag.WallParticle|tt.ParticleFlag.SpringParticle|tt.ParticleFlag.ElasticParticle))||null!==e&&0!=(e.getGroupFlags()&tt.ParticleGroupFlag.RigidParticleGroup)},et.prototype.updatePairsAndTriads=function(t,e,g){for(var m=et.updatePairsAndTriads_s_dab,B=et.updatePairsAndTriads_s_dbc,A=et.updatePairsAndTriads_s_dca,w=this.positionBuffer.data,i=0,s=t;s<e;s++)i|=this.flagsBuffer.data[s];if(i&et.k_pairFlags)for(var o=0;o<this.contactBuffer.count;o++){var n,r=this.contactBuffer.data[o],a=r.indexA,c=r.indexB,l=this.flagsBuffer.data[a],h=this.flagsBuffer.data[c],u=this.groupBuffer[a],p=this.groupBuffer[c];t<=a&&a<e&&t<=c&&c<e&&!((l|h)&tt.ParticleFlag.ZombieParticle)&&(l|h)&et.k_pairFlags&&(g.isNecessary(a)||g.isNecessary(c))&&et.particleCanBeConnected(l,u)&&et.particleCanBeConnected(h,p)&&g.shouldCreatePair(a,c)&&((n=this.pairBuffer.data[this.pairBuffer.append()]).indexA=a,n.indexB=c,n.flags=r.flags,n.strength=tt.Min(u?u.strength:1,p?p.strength:1),n.distance=tt.Vec2.DistanceVV(w[a],w[c])),v(this.pairBuffer.data,0,this.pairBuffer.count,et.comparePairIndices),this.pairBuffer.unique(et.matchPairIndices)}if(i&et.k_triadFlags){for(var d=new tt.VoronoiDiagram(e-t),s=t;s<e;s++){var f=this.flagsBuffer.data[s],y=this.groupBuffer[s];f&tt.ParticleFlag.ZombieParticle||!et.particleCanBeConnected(f,y)||d.addGenerator(w[s],s,g.isNecessary(s))}var V=this.getParticleStride();d.generate(V/2,2*V);var b=this;d.getNodes(function(t,e,i){var s=b.flagsBuffer.data[t],o=b.flagsBuffer.data[e],n=b.flagsBuffer.data[i];if((s|o|n)&et.k_triadFlags&&g.shouldCreateTriad(t,e,i)){var r=w[t],a=w[e],c=w[i],l=tt.Vec2.SubVV(r,a,m),h=tt.Vec2.SubVV(a,c,B),u=tt.Vec2.SubVV(c,r,A),p=tt.maxTriadDistanceSquared*b.squaredDiameter;if(tt.Vec2.DotVV(l,l)>p||tt.Vec2.DotVV(h,h)>p||tt.Vec2.DotVV(u,u)>p)return;var d=b.groupBuffer[t],f=b.groupBuffer[e],y=b.groupBuffer[i],V=b.triadBuffer.data[b.triadBuffer.append()];V.indexA=t,V.indexB=e,V.indexC=i,V.flags=s|o|n,V.strength=tt.Min(tt.Min(d?d.strength:1,f?f.strength:1),y?y.strength:1);var v=(r.x+a.x+c.x)/3,x=(r.y+a.y+c.y)/3;V.pa.x=r.x-v,V.pa.y=r.y-x,V.pb.x=a.x-v,V.pb.y=a.y-x,V.pc.x=c.x-v,V.pc.y=c.y-x,V.ka=-tt.Vec2.DotVV(u,l),V.kb=-tt.Vec2.DotVV(l,h),V.kc=-tt.Vec2.DotVV(h,u),V.s=tt.Vec2.CrossVV(r,a)+tt.Vec2.CrossVV(a,c)+tt.Vec2.CrossVV(c,r)}}),v(this.triadBuffer.data,0,this.triadBuffer.count,et.compareTriadIndices),this.triadBuffer.unique(et.matchTriadIndices)}},et.prototype.updatePairsAndTriadsWithReactiveParticles=function(){var t=new K(this.flagsBuffer);this.updatePairsAndTriads(0,this.count,t);for(var e=0;e<this.count;e++)this.flagsBuffer.data[e]&=~tt.ParticleFlag.ReactiveParticle;this.allParticleFlags&=~tt.ParticleFlag.ReactiveParticle},et.comparePairIndices=function(t,e){var i=t.indexA-e.indexA;return 0!=i?i<0:t.indexB<e.indexB},et.matchPairIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB},et.compareTriadIndices=function(t,e){var i=t.indexA-e.indexA;if(0!=i)return i<0;var s=t.indexB-e.indexB;return 0!=s?s<0:t.indexC<e.indexC},et.matchTriadIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC},et.initializeParticleLists=function(t,e){for(var i=t.getBufferIndex(),s=t.getParticleCount(),o=0;o<s;o++){var n=e[o];(n.list=n).next=null,n.count=1,n.index=o+i}},et.prototype.mergeParticleListsInContact=function(t,e){for(var i=t.getBufferIndex(),s=0;s<this.contactBuffer.count;s++){var o,n,r,a=this.contactBuffer.data[s],c=a.indexA,l=a.indexB;t.containsParticle(c)&&t.containsParticle(l)&&((n=e[c-i].list)!==(r=e[l-i].list)&&(n.count<r.count&&(o=n,n=r,r=o),et.mergeParticleLists(n,r)))}},et.mergeParticleLists=function(t,e){for(var i=e;;){i.list=t;var s=i.next;if(!s){i.next=t.next;break}i=s}t.next=e,t.count+=e.count,e.count=0},et.findLongestParticleList=function(t,e){for(var i=t.getParticleCount(),s=e[0],o=0;o<i;o++){var n=e[o];s.count<n.count&&(s=n)}return s},et.prototype.mergeZombieParticleListNodes=function(t,e,i){for(var s=t.getParticleCount(),o=0;o<s;o++){var n=e[o];n!==i&&this.flagsBuffer.data[n.index]&tt.ParticleFlag.ZombieParticle&&et.mergeParticleListAndNode(i,n)}},et.mergeParticleListAndNode=function(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0},et.prototype.createParticleGroupsFromParticleList=function(t,e,i){var s=t.getParticleCount(),o=new tt.ParticleGroupDef;o.groupFlags=t.getGroupFlags(),o.userData=t.getUserData();for(var n=0;n<s;n++){var r=e[n];if(r.count&&r!==i)for(var a=this.createParticleGroup(o),c=r;c;c=c.next){var l=c.index,h=this.cloneParticle(l,a);this.flagsBuffer.data[l]|=tt.ParticleFlag.ZombieParticle,c.index=h}}},et.prototype.updatePairsAndTriadsWithParticleList=function(t,e){for(var i=t.getBufferIndex(),s=0;s<this.pairBuffer.count;s++){var o=this.pairBuffer.data[s],n=o.indexA,r=o.indexB;t.containsParticle(n)&&(o.indexA=e[n-i].index),t.containsParticle(r)&&(o.indexB=e[r-i].index)}for(s=0;s<this.triadBuffer.count;s++){var a=this.triadBuffer.data[s],n=a.indexA,r=a.indexB,c=a.indexC;t.containsParticle(n)&&(a.indexA=e[n-i].index),t.containsParticle(r)&&(a.indexB=e[r-i].index),t.containsParticle(c)&&(a.indexC=e[c-i].index)}},et.prototype.computeDepth=function(){for(var t=[],e=0,i=0;i<this.contactBuffer.count;i++){var s=(V=this.contactBuffer.data[i]).indexA,o=V.indexB,n=this.groupBuffer[s],r=this.groupBuffer[o];n&&n===r&&n.groupFlags&tt.ParticleGroupFlag.ParticleGroupNeedsUpdateDepth&&(t[e++]=V)}for(var a=[],c=0,l=this.groupList;l;l=l.getNext())if(l.groupFlags&tt.ParticleGroupFlag.ParticleGroupNeedsUpdateDepth){a[c++]=l,this.setGroupFlags(l,l.groupFlags&~tt.ParticleGroupFlag.ParticleGroupNeedsUpdateDepth);for(var h=l.firstIndex;h<l.lastIndex;h++)this.accumulationBuffer[h]=0}for(i=0;i<e;i++){var s=(V=t[i]).indexA,o=V.indexB,u=V.weight;this.accumulationBuffer[s]+=u,this.accumulationBuffer[o]+=u}for(h=0;h<c;h++)for(var p=(l=a[h]).firstIndex;p<l.lastIndex;p++){u=this.accumulationBuffer[p];this.depthBuffer[p]=u<.8?0:tt.maxFloat}for(var d=tt.Sqrt(this.count)>>0,f=0;f<d;f++){for(var y=!1,i=0;i<e;i++){var V,s=(V=t[i]).indexA,o=V.indexB,v=1-V.weight,x=this.depthBuffer[s],g=this.depthBuffer[o],m=g+v,B=x+v;m<x&&(this.depthBuffer[s]=m,y=!0),B<g&&(this.depthBuffer[o]=B,y=!0)}if(!y)break}for(h=0;h<c;h++)for(var A=(l=a[h]).firstIndex;A<l.lastIndex;A++)this.depthBuffer[A]<tt.maxFloat?this.depthBuffer[A]*=this.particleDiameter:this.depthBuffer[A]=0},et.prototype.getInsideBoundsEnumerator=function(t){var e=et.computeTag(this.inverseDiameter*t.lowerBound.x-1,this.inverseDiameter*t.lowerBound.y-1),i=et.computeTag(this.inverseDiameter*t.upperBound.x+1,this.inverseDiameter*t.upperBound.y+1),s=this.proxyBuffer.count,o=p(this.proxyBuffer.data,0,s,e,w.compareProxyTag),n=d(this.proxyBuffer.data,0,s,i,w.compareTagProxy);return new C(this,e,i,o,n)},et.prototype.updateAllParticleFlags=function(){for(var t=this.allParticleFlags=0;t<this.count;t++)this.allParticleFlags|=this.flagsBuffer.data[t];this.needsUpdateAllParticleFlags=!1},et.prototype.updateAllGroupFlags=function(){this.allGroupFlags=0;for(var t=this.groupList;t;t=t.getNext())this.allGroupFlags|=t.groupFlags;this.needsUpdateAllGroupFlags=!1},et.prototype.addContact=function(t,e,i){var s,o,n=this.flagsBuffer.data,r=this.positionBuffer.data,a=tt.Vec2.SubVV(r[e],r[t],et.addContact_s_d),c=tt.Vec2.DotVV(a,a);0<c&&c<this.squaredDiameter&&(s=tt.invSqrt(c),(o=this.contactBuffer.data[this.contactBuffer.append()]).indexA=t,o.indexB=e,o.flags=n[t]|n[e],o.weight=1-c*s*this.inverseDiameter,o.normal.x=s*a.x,o.normal.y=s*a.y)},et.prototype.findContacts_Reference=function(t){for(var e=this.proxyBuffer.count,i=this.contactBuffer.count=0,s=0;i<e;i++){for(var o=et.computeRelativeTag(this.proxyBuffer.data[i].tag,1,0),n=i+1;n<e&&!(o<this.proxyBuffer.data[n].tag);n++)this.addContact(this.proxyBuffer.data[i].index,this.proxyBuffer.data[n].index,this.contactBuffer);for(var r=et.computeRelativeTag(this.proxyBuffer.data[i].tag,-1,1);s<e&&!(r<=this.proxyBuffer.data[s].tag);s++);for(var a=et.computeRelativeTag(this.proxyBuffer.data[i].tag,1,1),n=s;n<e&&!(a<this.proxyBuffer.data[n].tag);n++)this.addContact(this.proxyBuffer.data[i].index,this.proxyBuffer.data[n].index,this.contactBuffer)}},et.prototype.findContacts=function(t){this.findContacts_Reference(t)},et.prototype.updateProxies_Reference=function(t){for(var e=this.positionBuffer.data,i=this.inverseDiameter,s=0;s<this.proxyBuffer.count;++s){var o=this.proxyBuffer.data[s],n=e[o.index];o.tag=et.computeTag(i*n.x,i*n.y)}},et.prototype.updateProxies=function(t){this.updateProxies_Reference(t)},et.prototype.sortProxies=function(t){u(this.proxyBuffer.data,0,this.proxyBuffer.count,w.compareProxyProxy)},et.prototype.filterContacts=function(t){var e,i=this.getParticleContactFilter();null!==i&&(e=this).contactBuffer.removeIf(function(t){return 0!=(t.flags&tt.ParticleFlag.ParticleContactFilterParticle)&&!i.shouldCollideParticleParticle(e,t.indexA,t.indexB)})},et.prototype.notifyContactListenerPreContact=function(t){if(null!==this.getParticleContactListener())throw t.initialize(this.contactBuffer,this.flagsBuffer),new Error},et.prototype.notifyContactListenerPostContact=function(t){var e=this.getParticleContactListener();if(null!==e){for(var i=0;i<this.contactBuffer.count;++i){var s=this.contactBuffer.data[i];e.beginContactParticleParticle(this,s)}throw new Error}},et.particleContactIsZombie=function(t){return(t.flags&tt.ParticleFlag.ZombieParticle)===tt.ParticleFlag.ZombieParticle},et.prototype.updateContacts=function(t){this.updateProxies(this.proxyBuffer),this.sortProxies(this.proxyBuffer);var e=new k;this.notifyContactListenerPreContact(e),this.findContacts(this.contactBuffer),this.filterContacts(this.contactBuffer),this.notifyContactListenerPostContact(e),t&&this.contactBuffer.removeIf(et.particleContactIsZombie)},et.prototype.notifyBodyContactListenerPreContact=function(t){if(null!==this.getFixtureContactListener())throw t.initialize(this.bodyContactBuffer,this.flagsBuffer),new Error},et.prototype.notifyBodyContactListenerPostContact=function(t){var e=this.getFixtureContactListener();if(null!==e){for(var i=0;i<this.bodyContactBuffer.count;i++){var s=this.bodyContactBuffer.data[i];e.beginContactFixtureParticle(this,s)}throw new Error}},et.prototype.updateBodyContacts=function(){var t=et.updateBodyContacts_s_aabb,e=new F;if(this.notifyBodyContactListenerPreContact(e),0<this.stuckThreshold)for(var i=this.getParticleCount(),s=0;s<i;s++)this.bodyContactCountBuffer.data[s]=0,this.timestamp>this.lastBodyContactStepBuffer.data[s]+1&&(this.consecutiveContactStepsBuffer.data[s]=0);this.bodyContactBuffer.setCount(0),this.stuckParticleBuffer.setCount(0);var o=t;this.computeAABB(o),null===this.updateBodyContacts_callback&&(this.updateBodyContacts_callback=new $(this));var n=this.updateBodyContacts_callback;n.contactFilter=this.getFixtureContactFilter(),this.world.queryAABB(n,o),this.def.strictContactCheck&&this.removeSpuriousBodyContacts(),this.notifyBodyContactListenerPostContact(e)},et.prototype.solve=function(t){var e=et.solve_s_subStep;if(0!==this.count&&(this.expirationTimeBuffer.data&&this.solveLifetimes(t),this.allParticleFlags&tt.ParticleFlag.ZombieParticle&&this.solveZombie(),this.needsUpdateAllParticleFlags&&this.updateAllParticleFlags(),this.needsUpdateAllGroupFlags&&this.updateAllGroupFlags(),!this.paused))for(this.iterationIndex=0;this.iterationIndex<t.particleIterations;this.iterationIndex++){++this.timestamp;var i=e.copy(t);i.dt/=t.particleIterations,i.inv_dt*=t.particleIterations,this.updateContacts(!1),this.updateBodyContacts(),this.computeWeight(),this.allGroupFlags&tt.ParticleGroupFlag.ParticleGroupNeedsUpdateDepth&&this.computeDepth(),this.allParticleFlags&tt.ParticleFlag.ReactiveParticle&&this.updatePairsAndTriadsWithReactiveParticles(),this.hasForce&&this.solveForce(i),this.allParticleFlags&tt.ParticleFlag.ViscousParticle&&this.solveViscous(),this.allParticleFlags&tt.ParticleFlag.RepulsiveParticle&&this.solveRepulsive(i),this.allParticleFlags&tt.ParticleFlag.PowderParticle&&this.solvePowder(i),this.allParticleFlags&tt.ParticleFlag.TensileParticle&&this.solveTensile(i),this.allGroupFlags&tt.ParticleGroupFlag.SolidParticleGroup&&this.solveSolid(i),this.allParticleFlags&tt.ParticleFlag.ColorMixingParticle&&this.solveColorMixing(),this.solveGravity(i),this.allParticleFlags&tt.ParticleFlag.StaticPressureParticle&&this.solveStaticPressure(i),this.solvePressure(i),this.solveDamping(i),this.allParticleFlags&et.k_extraDampingFlags&&this.solveExtraDamping(),this.allParticleFlags&tt.ParticleFlag.ElasticParticle&&this.solveElastic(i),this.allParticleFlags&tt.ParticleFlag.SpringParticle&&this.solveSpring(i),this.limitVelocity(i),this.allGroupFlags&tt.ParticleGroupFlag.RigidParticleGroup&&this.solveRigidDamping(),this.allParticleFlags&tt.ParticleFlag.BarrierParticle&&this.solveBarrier(i),this.solveCollision(i),this.allGroupFlags&tt.ParticleGroupFlag.RigidParticleGroup&&this.solveRigid(i),this.allParticleFlags&tt.ParticleFlag.WallParticle&&this.solveWall();for(var s=0;s<this.count;s++)this.positionBuffer.data[s].selfMulAdd(i.dt,this.velocityBuffer.data[s])}},et.prototype.solveCollision=function(t){var e=et.solveCollision_s_aabb,i=this.positionBuffer.data,s=this.velocityBuffer.data,o=e;o.lowerBound.x=+tt.maxFloat,o.lowerBound.y=+tt.maxFloat,o.upperBound.x=-tt.maxFloat,o.upperBound.y=-tt.maxFloat;for(var n=0;n<this.count;n++){var r=s[n],a=i[n],c=a.x+t.dt*r.x,l=a.y+t.dt*r.y;o.lowerBound.x=tt.Min(o.lowerBound.x,tt.Min(a.x,c)),o.lowerBound.y=tt.Min(o.lowerBound.y,tt.Min(a.y,l)),o.upperBound.x=tt.Max(o.upperBound.x,tt.Max(a.x,c)),o.upperBound.y=tt.Max(o.upperBound.y,tt.Max(a.y,l))}null===this.solveCollision_callback&&(this.solveCollision_callback=new ot(this,t));var h=this.solveCollision_callback;h.step=t,this.world.queryAABB(h,o)},et.prototype.limitVelocity=function(t){for(var e=this.velocityBuffer.data,i=this.getCriticalVelocitySquared(t),s=0;s<this.count;s++){var o=e[s],n=tt.Vec2.DotVV(o,o);i<n&&o.selfMul(tt.Sqrt(i/n))}},et.prototype.solveGravity=function(t){for(var e=et.SolveGravity_s_gravity,i=this.velocityBuffer.data,s=tt.Vec2.MulSV(t.dt*this.def.gravityScale,this.world.gravity,e),o=0;o<this.count;o++)i[o].selfAdd(s)},et.prototype.solveBarrier=function(t){for(var e=et.solveBarrier_s_aabb,i=et.solveBarrier_s_va,s=et.solveBarrier_s_vb,o=et.solveBarrier_s_pba,n=et.solveBarrier_s_vba,r=et.solveBarrier_s_vc,a=et.solveBarrier_s_pca,c=et.solveBarrier_s_vca,l=et.solveBarrier_s_qba,h=et.solveBarrier_s_qca,u=et.solveBarrier_s_dv,p=et.solveBarrier_s_f,d=this.positionBuffer.data,f=this.velocityBuffer.data,y=0;y<this.count;y++){0!=(this.flagsBuffer.data[y]&et.k_barrierWallFlags)&&f[y].setZero()}for(var V=tt.barrierCollisionTime*t.dt,v=this.getParticleMass(),x=0;x<this.pairBuffer.count;x++){var g=this.pairBuffer.data[x];if(g.flags&tt.ParticleFlag.BarrierParticle){var m=g.indexA,B=g.indexB,A=d[m],w=d[B],b=e;tt.Vec2.MinV(A,w,b.lowerBound),tt.Vec2.MaxV(A,w,b.upperBound);for(var C,_=this.groupBuffer[m],S=this.groupBuffer[B],M=this.getLinearVelocity(_,m,A,i),P=this.getLinearVelocity(S,B,w,s),I=tt.Vec2.SubVV(w,A,o),T=tt.Vec2.SubVV(P,M,n),F=this.getInsideBoundsEnumerator(b);0<=(C=F.getNext());){var D=d[C],L=this.groupBuffer[C];if(_!==L&&S!==L){var R=this.getLinearVelocity(L,C,D,r),k=tt.Vec2.SubVV(D,A,a),q=tt.Vec2.SubVV(R,M,c),J=tt.Vec2.CrossVV(T,q),E=tt.Vec2.CrossVV(I,q)-tt.Vec2.CrossVV(k,T),z=tt.Vec2.CrossVV(I,k),j=void 0,O=void 0,G=l,N=h;if(0===J){if(0==E)continue;if(!(0<=(O=-z/E)&&O<V))continue;if(tt.Vec2.AddVMulSV(I,O,T,G),tt.Vec2.AddVMulSV(k,O,q,N),!(0<=(j=tt.Vec2.DotVV(G,N)/tt.Vec2.DotVV(G,G))&&j<=1))continue}else{var X=E*E-4*z*J;if(X<0)continue;var Z,W=tt.Sqrt(X),U=(-E-W)/(2*J),Y=(-E+W)/(2*J);if(Y<U&&(Z=U,U=Y,Y=Z),O=U,tt.Vec2.AddVMulSV(I,O,T,G),tt.Vec2.AddVMulSV(k,O,q,N),j=tt.Vec2.DotVV(G,N)/tt.Vec2.DotVV(G,G),!(0<=O&&O<V&&0<=j&&j<=1)){if(!(0<=(O=Y)&&O<V))continue;if(tt.Vec2.AddVMulSV(I,O,T,G),tt.Vec2.AddVMulSV(k,O,q,N),!(0<=(j=tt.Vec2.DotVV(G,N)/tt.Vec2.DotVV(G,G))&&j<=1))continue}}var K=u;K.x=M.x+j*T.x-R.x,K.y=M.y+j*T.y-R.y;var H,Q,$=tt.Vec2.MulSV(v,K,p);L&&this.isRigidGroup(L)?(H=L.getMass(),Q=L.getInertia(),0<H&&L.linearVelocity.selfMulAdd(1/H,$),0<Q&&(L.angularVelocity+=tt.Vec2.CrossVV(tt.Vec2.SubVV(D,L.getCenter(),tt.Vec2.s_t0),$)/Q)):f[C].selfAdd(K),this.particleApplyForce(C,$.selfMul(-t.inv_dt))}}}}},et.prototype.solveStaticPressure=function(t){this.staticPressureBuffer=this.requestBuffer(this.staticPressureBuffer);for(var e=this.getCriticalPressure(t),i=this.def.staticPressureStrength*e,s=tt.maxParticlePressure*e,o=this.def.staticPressureRelaxation,n=0;n<this.def.staticPressureIterations;n++){for(var r=0;r<this.count;r++)this.accumulationBuffer[r]=0;for(var a=0;a<this.contactBuffer.count;a++){var c,l,h=this.contactBuffer.data[a];h.flags&tt.ParticleFlag.StaticPressureParticle&&(c=h.indexA,l=h.indexB,p=h.weight,this.accumulationBuffer[c]+=p*this.staticPressureBuffer[l],this.accumulationBuffer[l]+=p*this.staticPressureBuffer[c])}for(r=0;r<this.count;r++){var u,p=this.weightBuffer[r];this.flagsBuffer.data[r]&tt.ParticleFlag.StaticPressureParticle?(u=(this.accumulationBuffer[r]+i*(p-tt.minParticleWeight))/(p+o),this.staticPressureBuffer[r]=tt.clamp(u,0,s)):this.staticPressureBuffer[r]=0}}},et.prototype.computeWeight=function(){for(var t=0;t<this.count;t++)this.weightBuffer[t]=0;for(t=0;t<this.bodyContactBuffer.count;t++){var e=(s=this.bodyContactBuffer.data[t]).index,i=s.weight;this.weightBuffer[e]+=i}for(t=0;t<this.contactBuffer.count;t++){var s,e=(s=this.contactBuffer.data[t]).indexA,o=s.indexB,i=s.weight;this.weightBuffer[e]+=i,this.weightBuffer[o]+=i}},et.prototype.solvePressure=function(t){for(var e=et.solvePressure_s_f,i=this.positionBuffer.data,s=this.velocityBuffer.data,o=this.getCriticalPressure(t),n=this.def.pressureStrength*o,r=tt.maxParticlePressure*o,a=0;a<this.count;a++){var c=this.weightBuffer[a],l=n*tt.Max(0,c-tt.minParticleWeight);this.accumulationBuffer[a]=tt.Min(l,r)}if(this.allParticleFlags&et.k_noPressureFlags)for(a=0;a<this.count;a++)this.flagsBuffer.data[a]&et.k_noPressureFlags&&(this.accumulationBuffer[a]=0);if(this.allParticleFlags&tt.ParticleFlag.StaticPressureParticle)for(a=0;a<this.count;a++)this.flagsBuffer.data[a]&tt.ParticleFlag.StaticPressureParticle&&(this.accumulationBuffer[a]+=this.staticPressureBuffer[a]);for(var h=t.dt/(this.def.density*this.particleDiameter),u=this.getParticleInvMass(),p=0;p<this.bodyContactBuffer.count;p++){var d=(g=this.bodyContactBuffer.data[p]).index,f=g.body,c=g.weight,y=g.mass,V=g.normal,v=i[d],l=this.accumulationBuffer[d]+n*c,x=tt.Vec2.MulSV(h*c*y*l,V,e);s[d].selfMulSub(u,x),f.applyLinearImpulse(x,v,!0)}for(p=0;p<this.contactBuffer.count;p++){var g,d=(g=this.contactBuffer.data[p]).indexA,f=g.indexB,c=g.weight,V=g.normal,l=this.accumulationBuffer[d]+this.accumulationBuffer[f],x=tt.Vec2.MulSV(h*c*l,V,e);s[d].selfSub(x),s[f].selfAdd(x)}},et.prototype.solveDamping=function(t){for(var e=et.solveDamping_s_v,i=et.solveDamping_s_f,s=this.positionBuffer.data,o=this.velocityBuffer.data,n=this.def.dampingStrength,r=1/this.getCriticalVelocity(t),a=this.getParticleInvMass(),c=0;c<this.bodyContactBuffer.count;c++){var l=(V=this.bodyContactBuffer.data[c]).index,h=V.body,u=V.weight,p=V.mass,d=V.normal,f=s[l],y=tt.Vec2.SubVV(h.getLinearVelocityFromWorldPoint(f,tt.Vec2.s_t0),o[l],e);(v=tt.Vec2.DotVV(y,d))<0&&(x=tt.Max(n*u,tt.Min(-r*v,.5)),g=tt.Vec2.MulSV(x*p*v,d,i),o[l].selfMulAdd(a,g),h.applyLinearImpulse(g.selfNeg(),f,!0))}for(c=0;c<this.contactBuffer.count;c++){var V,v,x,g,l=(V=this.contactBuffer.data[c]).indexA,h=V.indexB,u=V.weight,d=V.normal,y=tt.Vec2.SubVV(o[h],o[l],e);(v=tt.Vec2.DotVV(y,d))<0&&(x=tt.Max(n*u,tt.Min(-r*v,.5)),g=tt.Vec2.MulSV(x*v,d,i),o[l].selfAdd(g),o[h].selfSub(g))}},et.prototype.solveRigidDamping=function(){for(var t=et.solveRigidDamping_s_t0,e=et.solveRigidDamping_s_t1,i=et.solveRigidDamping_s_p,s=et.solveRigidDamping_s_v,o=[0],n=[0],r=[0],a=[0],c=[0],l=[0],h=this.positionBuffer.data,u=this.def.dampingStrength,p=0;p<this.bodyContactBuffer.count;p++){var d=(f=this.bodyContactBuffer.data[p]).index;(A=this.groupBuffer[d])&&this.isRigidGroup(A)&&(g=f.body,m=f.normal,B=f.weight,y=h[d],V=tt.Vec2.SubVV(g.getLinearVelocityFromWorldPoint(y,t),A.getLinearVelocityFromWorldPoint(y,e),s),(v=tt.Vec2.DotVV(V,m))<0&&(this.initDampingParameterWithRigidGroupOrParticle(o,n,r,!0,A,d,y,m),this.initDampingParameter(a,c,l,g.getMass(),g.getInertia()-g.getMass()*g.getLocalCenter().lengthSquared(),g.getWorldCenter(),y,m),x=u*tt.Min(B,1)*this.computeDampingImpulse(o[0],n[0],r[0],a[0],c[0],l[0],v),this.applyDamping(o[0],n[0],r[0],!0,A,d,x,m),g.applyLinearImpulse(tt.Vec2.MulSV(-x,m,tt.Vec2.s_t0),y,!0)))}for(p=0;p<this.contactBuffer.count;p++){var f,y,V,v,x,d=(f=this.contactBuffer.data[p]).indexA,g=f.indexB,m=f.normal,B=f.weight,A=this.groupBuffer[d],w=this.groupBuffer[g],b=this.isRigidGroup(A),C=this.isRigidGroup(w);A!==w&&(b||C)&&(y=tt.Vec2.MidVV(h[d],h[g],i),V=tt.Vec2.SubVV(this.getLinearVelocity(w,g,y,t),this.getLinearVelocity(A,d,y,e),s),(v=tt.Vec2.DotVV(V,m))<0&&(this.initDampingParameterWithRigidGroupOrParticle(o,n,r,b,A,d,y,m),this.initDampingParameterWithRigidGroupOrParticle(a,c,l,C,w,g,y,m),x=u*B*this.computeDampingImpulse(o[0],n[0],r[0],a[0],c[0],l[0],v),this.applyDamping(o[0],n[0],r[0],b,A,d,x,m),this.applyDamping(a[0],c[0],l[0],C,w,g,-x,m)))}},et.prototype.solveExtraDamping=function(){for(var t=et.solveExtraDamping_s_v,e=et.solveExtraDamping_s_f,i=this.velocityBuffer.data,s=this.positionBuffer.data,o=this.getParticleInvMass(),n=0;n<this.bodyContactBuffer.count;n++){var r,a,c,l,h,u,p,d=this.bodyContactBuffer.data[n],f=d.index;this.flagsBuffer.data[f]&et.k_extraDampingFlags&&(r=d.body,a=d.mass,c=d.normal,l=s[f],h=tt.Vec2.SubVV(r.getLinearVelocityFromWorldPoint(l,tt.Vec2.s_t0),i[f],t),(u=tt.Vec2.DotVV(h,c))<0&&(p=tt.Vec2.MulSV(.5*a*u,c,e),i[f].selfMulAdd(o,p),r.applyLinearImpulse(p.selfNeg(),l,!0)))}},et.prototype.solveWall=function(){for(var t=this.velocityBuffer.data,e=0;e<this.count;e++)this.flagsBuffer.data[e]&tt.ParticleFlag.WallParticle&&t[e].setZero()},et.prototype.solveRigid=function(t){for(var e=et.solveRigid_s_position,i=et.solveRigid_s_rotation,s=et.solveRigid_s_transform,o=et.solveRigid_s_velocityTransform,n=this.positionBuffer.data,r=this.velocityBuffer.data,a=this.groupList;a;a=a.getNext())if(a.groupFlags&tt.ParticleGroupFlag.RigidParticleGroup){a.updateStatistics();var c=i;c.setAngle(t.dt*a.angularVelocity);var l=tt.Vec2.AddVV(a.center,tt.Vec2.SubVV(tt.Vec2.MulSV(t.dt,a.linearVelocity,tt.Vec2.s_t0),tt.Rot.mulRV(c,a.center,tt.Vec2.s_t1),tt.Vec2.s_t0),e),h=s;h.setPositionRotation(l,c),tt.Transform.mulXX(h,a.transform,a.transform);var u=o;u.p.x=t.inv_dt*h.p.x,u.p.y=t.inv_dt*h.p.y,u.q.s=t.inv_dt*h.q.s,u.q.c=t.inv_dt*(h.q.c-1);for(var p=a.firstIndex;p<a.lastIndex;p++)tt.Transform.mulXV(u,n[p],r[p])}},et.prototype.solveElastic=function(t){for(var e=et.solveElastic_s_pa,i=et.solveElastic_s_pb,s=et.solveElastic_s_pc,o=et.solveElastic_s_r,n=et.solveElastic_s_t0,r=this.positionBuffer.data,a=this.velocityBuffer.data,c=t.inv_dt*this.def.elasticStrength,l=0;l<this.triadBuffer.count;l++){var h,u,p,d,f,y,V,v,x,g,m,B,A,w,b,C,_,S,M=this.triadBuffer.data[l];M.flags&tt.ParticleFlag.ElasticParticle&&(h=M.indexA,u=M.indexB,p=M.indexC,d=M.pa,f=M.pb,y=M.pc,V=e.copy(r[h]),v=i.copy(r[u]),x=s.copy(r[p]),g=a[h],m=a[u],B=a[p],V.selfMulAdd(t.dt,g),v.selfMulAdd(t.dt,m),x.selfMulAdd(t.dt,B),A=(V.x+v.x+x.x)/3,w=(V.y+v.y+x.y)/3,V.x-=A,V.y-=w,v.x-=A,v.y-=w,x.x-=A,x.y-=w,(b=o).s=tt.Vec2.CrossVV(d,V)+tt.Vec2.CrossVV(f,v)+tt.Vec2.CrossVV(y,x),b.c=tt.Vec2.DotVV(d,V)+tt.Vec2.DotVV(f,v)+tt.Vec2.DotVV(y,x),C=b.s*b.s+b.c*b.c,_=tt.invSqrt(C),isFinite(_)||(_=198177537e11),b.s*=_,b.c*=_,S=c*M.strength,tt.Rot.mulRV(b,d,n),tt.Vec2.SubVV(n,V,n),tt.Vec2.MulSV(S,n,n),g.selfAdd(n),tt.Rot.mulRV(b,f,n),tt.Vec2.SubVV(n,v,n),tt.Vec2.MulSV(S,n,n),m.selfAdd(n),tt.Rot.mulRV(b,y,n),tt.Vec2.SubVV(n,x,n),tt.Vec2.MulSV(S,n,n),B.selfAdd(n))}},et.prototype.solveSpring=function(t){for(var e=et.solveSpring_s_pa,i=et.solveSpring_s_pb,s=et.solveSpring_s_d,o=et.solveSpring_s_f,n=this.positionBuffer.data,r=this.velocityBuffer.data,a=t.inv_dt*this.def.springStrength,c=0;c<this.pairBuffer.count;c++){var l,h,u,p,d,f,y,V,v,x,g,m=this.pairBuffer.data[c];m.flags&tt.ParticleFlag.SpringParticle&&(l=m.indexA,h=m.indexB,u=e.copy(n[l]),p=i.copy(n[h]),d=r[l],f=r[h],u.selfMulAdd(t.dt,d),p.selfMulAdd(t.dt,f),y=tt.Vec2.SubVV(p,u,s),V=m.distance,v=y.length(),x=a*m.strength,g=tt.Vec2.MulSV(x*(V-v)/v,y,o),d.selfSub(g),f.selfAdd(g))}},et.prototype.solveTensile=function(t){for(var e=et.solveTensile_s_weightedNormal,i=et.solveTensile_s_s,s=et.solveTensile_s_f,o=this.velocityBuffer.data,n=0;n<this.count;n++)this.accumulation2Buffer[n]=new tt.Vec2,this.accumulation2Buffer[n].setZero();for(var r,a=0;a<this.contactBuffer.count;a++){(c=this.contactBuffer.data[a]).flags&tt.ParticleFlag.TensileParticle&&(l=c.indexA,h=c.indexB,u=c.weight,p=c.normal,r=tt.Vec2.MulSV((1-u)*u,p,e),this.accumulation2Buffer[l].selfSub(r),this.accumulation2Buffer[h].selfAdd(r))}for(var c,l,h,u,p,d,f,y,V,v=this.getCriticalVelocity(t),x=this.def.surfaceTensionPressureStrength*v,g=this.def.surfaceTensionNormalStrength*v,m=tt.maxParticleForce*v,a=0;a<this.contactBuffer.count;a++){(c=this.contactBuffer.data[a]).flags&tt.ParticleFlag.TensileParticle&&(l=c.indexA,h=c.indexB,u=c.weight,p=c.normal,d=this.weightBuffer[l]+this.weightBuffer[h],f=tt.Vec2.SubVV(this.accumulation2Buffer[h],this.accumulation2Buffer[l],i),y=tt.Min(x*(d-2)+g*tt.Vec2.DotVV(f,p),m)*u,V=tt.Vec2.MulSV(y,p,s),o[l].selfSub(V),o[h].selfAdd(V))}},et.prototype.solveViscous=function(){for(var t=et.solveViscous_s_v,e=et.solveViscous_s_f,i=this.positionBuffer.data,s=this.velocityBuffer.data,o=this.def.viscousStrength,n=this.getParticleInvMass(),r=0;r<this.bodyContactBuffer.count;r++){var a,c,l=(h=this.bodyContactBuffer.data[r]).index;this.flagsBuffer.data[l]&tt.ParticleFlag.ViscousParticle&&(u=h.body,p=h.weight,a=h.mass,c=i[l],d=tt.Vec2.SubVV(u.getLinearVelocityFromWorldPoint(c,tt.Vec2.s_t0),s[l],t),f=tt.Vec2.MulSV(o*a*p,d,e),s[l].selfMulAdd(n,f),u.applyLinearImpulse(f.selfNeg(),c,!0))}for(var h,u,p,d,f,r=0;r<this.contactBuffer.count;r++){(h=this.contactBuffer.data[r]).flags&tt.ParticleFlag.ViscousParticle&&(l=h.indexA,u=h.indexB,p=h.weight,d=tt.Vec2.SubVV(s[u],s[l],t),f=tt.Vec2.MulSV(o*p,d,e),s[l].selfAdd(f),s[u].selfSub(f))}},et.prototype.solveRepulsive=function(t){for(var e=et.solveRepulsive_s_f,i=this.velocityBuffer.data,s=this.def.repulsiveStrength*this.getCriticalVelocity(t),o=0;o<this.contactBuffer.count;o++){var n,r,a,c,l,h=this.contactBuffer.data[o];h.flags&tt.ParticleFlag.RepulsiveParticle&&(n=h.indexA,r=h.indexB,this.groupBuffer[n]!==this.groupBuffer[r]&&(a=h.weight,c=h.normal,l=tt.Vec2.MulSV(s*a,c,e),i[n].selfSub(l),i[r].selfAdd(l)))}},et.prototype.solvePowder=function(t){for(var e=et.solvePowder_s_f,i=this.positionBuffer.data,s=this.velocityBuffer.data,o=this.def.powderStrength*this.getCriticalVelocity(t),n=1-tt.particleStride,r=this.getParticleInvMass(),a=0;a<this.bodyContactBuffer.count;a++){var c,l,h=(u=this.bodyContactBuffer.data[a]).index;this.flagsBuffer.data[h]&tt.ParticleFlag.PowderParticle&&n<(p=u.weight)&&(d=u.body,c=u.mass,l=i[h],f=u.normal,y=tt.Vec2.MulSV(o*c*(p-n),f,e),s[h].selfMulSub(r,y),d.applyLinearImpulse(y,l,!0))}for(var u,p,d,f,y,a=0;a<this.contactBuffer.count;a++){(u=this.contactBuffer.data[a]).flags&tt.ParticleFlag.PowderParticle&&n<(p=u.weight)&&(h=u.indexA,d=u.indexB,f=u.normal,y=tt.Vec2.MulSV(o*(p-n),f,e),s[h].selfSub(y),s[d].selfAdd(y))}},et.prototype.solveSolid=function(t){var e=et.SolveSolid_s_f,i=this.velocityBuffer.data;this.depthBuffer=this.requestBuffer(this.depthBuffer);for(var s=t.inv_dt*this.def.ejectionStrength,o=0;o<this.contactBuffer.count;o++){var n,r,a,c,l=this.contactBuffer.data[o],h=l.indexA,u=l.indexB;this.groupBuffer[h]!==this.groupBuffer[u]&&(n=l.weight,r=l.normal,a=this.depthBuffer[h]+this.depthBuffer[u],c=tt.Vec2.MulSV(s*a*n,r,e),i[h].selfSub(c),i[u].selfAdd(c))}},et.prototype.solveForce=function(t){for(var e=this.velocityBuffer.data,i=t.dt*this.getParticleInvMass(),s=0;s<this.count;s++)e[s].selfMulAdd(i,this.forceBuffer[s]);this.hasForce=!1},et.prototype.solveColorMixing=function(){var t=.5*this.def.colorMixingStrength;if(t)for(var e=0;e<this.contactBuffer.count;e++){var i,s,o=this.contactBuffer.data[e],n=o.indexA,r=o.indexB;this.flagsBuffer.data[n]&this.flagsBuffer.data[r]&tt.ParticleFlag.ColorMixingParticle&&(i=this.colorBuffer.data[n],s=this.colorBuffer.data[r],tt.Color.mixColors(i,s,t))}},et.prototype.solveZombie=function(){for(var t=0,e=[],i=0;i<this.count;i++)e[i]=tt.invalidParticleIndex;for(var s=0,i=0;i<this.count;i++){var o,n,r=this.flagsBuffer.data[i];r&tt.ParticleFlag.ZombieParticle?(o=this.world.destructionListener,r&tt.ParticleFlag.DestructionListenerParticle&&o&&o.sayGoodbyeParticle(this,i),this.handleIndexBuffer.data&&(n=this.handleIndexBuffer.data[i])&&(n.setIndex(tt.invalidParticleIndex),this.handleIndexBuffer.data[i]=null),e[i]=tt.invalidParticleIndex):(i!==(e[i]=t)&&(this.handleIndexBuffer.data&&((n=this.handleIndexBuffer.data[i])&&n.setIndex(t),this.handleIndexBuffer.data[t]=n),this.flagsBuffer.data[t]=this.flagsBuffer.data[i],this.lastBodyContactStepBuffer.data&&(this.lastBodyContactStepBuffer.data[t]=this.lastBodyContactStepBuffer.data[i]),this.bodyContactCountBuffer.data&&(this.bodyContactCountBuffer.data[t]=this.bodyContactCountBuffer.data[i]),this.consecutiveContactStepsBuffer.data&&(this.consecutiveContactStepsBuffer.data[t]=this.consecutiveContactStepsBuffer.data[i]),this.positionBuffer.data[t].copy(this.positionBuffer.data[i]),this.velocityBuffer.data[t].copy(this.velocityBuffer.data[i]),this.groupBuffer[t]=this.groupBuffer[i],this.hasForce&&this.forceBuffer[t].copy(this.forceBuffer[i]),this.staticPressureBuffer&&(this.staticPressureBuffer[t]=this.staticPressureBuffer[i]),this.depthBuffer&&(this.depthBuffer[t]=this.depthBuffer[i]),this.colorBuffer.data&&this.colorBuffer.data[t].copy(this.colorBuffer.data[i]),this.userDataBuffer.data&&(this.userDataBuffer.data[t]=this.userDataBuffer.data[i]),this.expirationTimeBuffer.data&&(this.expirationTimeBuffer.data[t]=this.expirationTimeBuffer.data[i])),t++,s|=r)}for(var a=function(t){return t.index<0},c=function(t){return t.indexA<0||t.indexB<0},l=function(t){return t.index<0},h=function(t){return t.indexA<0||t.indexB<0},u=function(t){return t.indexA<0||t.indexB<0||t.indexC<0},p=0;p<this.proxyBuffer.count;p++){var d=this.proxyBuffer.data[p];d.index=e[d.index]}this.proxyBuffer.removeIf(a);for(p=0;p<this.contactBuffer.count;p++){(f=this.contactBuffer.data[p]).indexA=e[f.indexA],f.indexB=e[f.indexB]}this.contactBuffer.removeIf(c);for(var f,p=0;p<this.bodyContactBuffer.count;p++){(f=this.bodyContactBuffer.data[p]).index=e[f.index]}this.bodyContactBuffer.removeIf(l);for(p=0;p<this.pairBuffer.count;p++){var y=this.pairBuffer.data[p];y.indexA=e[y.indexA],y.indexB=e[y.indexB]}this.pairBuffer.removeIf(h);for(p=0;p<this.triadBuffer.count;p++){var V=this.triadBuffer.data[p];V.indexA=e[V.indexA],V.indexB=e[V.indexB],V.indexC=e[V.indexC]}if(this.triadBuffer.removeIf(u),this.indexByExpirationTimeBuffer.data)for(var v=0,x=0;x<this.count;x++){var g=e[this.indexByExpirationTimeBuffer.data[x]];g!==tt.invalidParticleIndex&&(this.indexByExpirationTimeBuffer.data[v++]=g)}for(var m=this.groupList;m;m=m.getNext()){for(var B=t,A=0,w=!1,i=m.firstIndex;i<m.lastIndex;i++){var b=e[i];0<=b?(B=tt.Min(B,b),A=tt.Max(A,b+1)):w=!0}B<A?(m.firstIndex=B,m.lastIndex=A,w&&m.groupFlags&tt.ParticleGroupFlag.SolidParticleGroup&&this.setGroupFlags(m,m.groupFlags|tt.ParticleGroupFlag.ParticleGroupNeedsUpdateDepth)):(m.firstIndex=0,m.lastIndex=0,m.groupFlags&tt.ParticleGroupFlag.ParticleGroupCanBeEmpty||this.setGroupFlags(m,m.groupFlags|tt.ParticleGroupFlag.ParticleGroupWillBeDestroyed))}this.count=t,this.allParticleFlags=s,this.needsUpdateAllParticleFlags=!1;for(m=this.groupList;m;){var C=m.getNext();m.groupFlags&tt.ParticleGroupFlag.ParticleGroupWillBeDestroyed&&this.destroyParticleGroup(m),m=C}},et.prototype.solveLifetimes=function(t){this.timeElapsed=this.lifetimeToExpirationTime(t.dt);var e=this.getQuantizedTimeElapsed(),n=this.expirationTimeBuffer.data,i=this.indexByExpirationTimeBuffer.data,s=this.getParticleCount();this.expirationTimeBufferRequiresSorting&&(u(i,0,s,function(t,e){var i=n[t],s=n[e],o=i<=0;return o==s<=0?s<i:o}),this.expirationTimeBufferRequiresSorting=!1);for(var o=s-1;0<=o;--o){var r=i[o],a=n[r];if(e<a||a<=0)break;this.destroyParticle(r)}},et.prototype.rotateBuffer=function(e,i,s){if(e!==i&&i!==s){if(f(this.flagsBuffer.data,e,i,s),this.lastBodyContactStepBuffer.data&&f(this.lastBodyContactStepBuffer.data,e,i,s),this.bodyContactCountBuffer.data&&f(this.bodyContactCountBuffer.data,e,i,s),this.consecutiveContactStepsBuffer.data&&f(this.consecutiveContactStepsBuffer.data,e,i,s),f(this.positionBuffer.data,e,i,s),f(this.velocityBuffer.data,e,i,s),f(this.groupBuffer,e,i,s),this.hasForce&&f(this.forceBuffer,e,i,s),this.staticPressureBuffer&&f(this.staticPressureBuffer,e,i,s),this.depthBuffer&&f(this.depthBuffer,e,i,s),this.colorBuffer.data&&f(this.colorBuffer.data,e,i,s),this.userDataBuffer.data&&f(this.userDataBuffer.data,e,i,s),this.handleIndexBuffer.data){f(this.handleIndexBuffer.data,e,i,s);for(var t=e;t<s;++t){var o=this.handleIndexBuffer.data[t];o&&o.setIndex(d(o.getIndex()))}}if(this.expirationTimeBuffer.data){f(this.expirationTimeBuffer.data,e,i,s);for(var n=this.getParticleCount(),r=this.indexByExpirationTimeBuffer.data,t=0;t<n;++t)r[t]=d(r[t])}for(var a=0;a<this.proxyBuffer.count;a++){var c=this.proxyBuffer.data[a];c.index=d(c.index)}for(a=0;a<this.contactBuffer.count;a++){(l=this.contactBuffer.data[a]).indexA=d(l.indexA),l.indexB=d(l.indexB)}for(var l,a=0;a<this.bodyContactBuffer.count;a++){(l=this.bodyContactBuffer.data[a]).index=d(l.index)}for(a=0;a<this.pairBuffer.count;a++){var h=this.pairBuffer.data[a];h.indexA=d(h.indexA),h.indexB=d(h.indexB)}for(a=0;a<this.triadBuffer.count;a++){var u=this.triadBuffer.data[a];u.indexA=d(u.indexA),u.indexB=d(u.indexB),u.indexC=d(u.indexC)}for(var p=this.groupList;p;p=p.getNext())p.firstIndex=d(p.firstIndex),p.lastIndex=d(p.lastIndex-1)+1}function d(t){return t<e?t:t<i?t+s-i:t<s?t+e-i:t}},et.prototype.getCriticalVelocity=function(t){return this.particleDiameter*t.inv_dt},et.prototype.getCriticalVelocitySquared=function(t){var e=this.getCriticalVelocity(t);return e*e},et.prototype.getCriticalPressure=function(t){return this.def.density*this.getCriticalVelocitySquared(t)},et.prototype.getParticleStride=function(){return tt.particleStride*this.particleDiameter},et.prototype.getParticleMass=function(){var t=this.getParticleStride();return this.def.density*t*t},et.prototype.getParticleInvMass=function(){var t=this.inverseDiameter*(1/tt.particleStride);return this.inverseDensity*t*t},et.prototype.getFixtureContactFilter=function(){return this.allParticleFlags&tt.ParticleFlag.FixtureContactFilterParticle?this.world.contactManager.contactFilter:null},et.prototype.getParticleContactFilter=function(){return this.allParticleFlags&tt.ParticleFlag.ParticleContactFilterParticle?this.world.contactManager.contactFilter:null},et.prototype.getFixtureContactListener=function(){return this.allParticleFlags&tt.ParticleFlag.FixtureContactListenerParticle?this.world.contactManager.contactListener:null},et.prototype.getParticleContactListener=function(){return this.allParticleFlags&tt.ParticleFlag.ParticleContactListenerParticle?this.world.contactManager.contactListener:null},et.prototype.setUserOverridableBuffer=function(t,e){t.data=e,t.userSuppliedCapacity=e.length},et.prototype.setGroupFlags=function(t,e){var i=t.groupFlags;(i^e)&tt.ParticleGroupFlag.SolidParticleGroup&&(e|=tt.ParticleGroupFlag.ParticleGroupNeedsUpdateDepth),i&~e&&(this.needsUpdateAllGroupFlags=!0),~this.allGroupFlags&e&&(e&tt.ParticleGroupFlag.SolidParticleGroup&&(this.depthBuffer=this.requestBuffer(this.depthBuffer)),this.allGroupFlags|=e),t.groupFlags=e},et.bodyContactCompare=function(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index},et.prototype.removeSpuriousBodyContacts=function(){u(this.bodyContactBuffer.data,0,this.bodyContactBuffer.count,et.bodyContactCompare);var n=et.removeSpuriousBodyContacts_s_n,r=et.removeSpuriousBodyContacts_s_pos,a=et.removeSpuriousBodyContacts_s_normal,c=this,l=-1,h=0;this.bodyContactBuffer.count=e(this.bodyContactBuffer.data,function(t){if(t.index!==l&&(h=0,l=t.index),3<h++)return!0;var e=n.copy(t.normal);e.selfMul(c.particleDiameter*(1-t.weight));var i=tt.Vec2.AddVV(c.positionBuffer.data[t.index],e,r);if(t.fixture.testPoint(i))return!1;for(var s=t.fixture.getShape().getChildCount(),o=0;o<s;o++){if(t.fixture.computeDistance(i,a,o)<tt.linearSlop)return!1}return!0},this.bodyContactBuffer.count)},et.prototype.detectStuckParticle=function(t){this.stuckThreshold<=0||(++this.bodyContactCountBuffer.data[t],2===this.bodyContactCountBuffer.data[t]&&(++this.consecutiveContactStepsBuffer.data[t],this.consecutiveContactStepsBuffer.data[t]>this.stuckThreshold&&(this.stuckParticleBuffer.data[this.stuckParticleBuffer.append()]=t)),this.lastBodyContactStepBuffer.data[t]=this.timestamp)},et.prototype.validateParticleIndex=function(t){return 0<=t&&t<this.getParticleCount()&&t!==tt.invalidParticleIndex},et.prototype.getQuantizedTimeElapsed=function(){return Math.floor(this.timeElapsed/4294967296)},et.prototype.lifetimeToExpirationTime=function(t){return this.timeElapsed+Math.floor(t/this.def.lifetimeGranularity*4294967296)},et.prototype.forceCanBeApplied=function(t){return!(t&tt.ParticleFlag.WallParticle)},et.prototype.prepareForceBuffer=function(){if(!this.hasForce){for(var t=0;t<this.count;t++)this.forceBuffer[t].setZero();this.hasForce=!0}},et.prototype.isRigidGroup=function(t){return null!==t&&0!=(t.groupFlags&tt.ParticleGroupFlag.RigidParticleGroup)},et.prototype.getLinearVelocity=function(t,e,i,s){return t&&this.isRigidGroup(t)?t.getLinearVelocityFromWorldPoint(i,s):s.copy(this.velocityBuffer.data[e])},et.prototype.initDampingParameter=function(t,e,i,s,o,n,r,a){t[0]=0<s?1/s:0,e[0]=0<o?1/o:0,i[0]=tt.Vec2.CrossVV(tt.Vec2.SubVV(r,n,tt.Vec2.s_t0),a)},et.prototype.initDampingParameterWithRigidGroupOrParticle=function(t,e,i,s,o,n,r,a){var c;o&&s?this.initDampingParameter(t,e,i,o.getMass(),o.getInertia(),o.getCenter(),r,a):(c=this.flagsBuffer.data[n],this.initDampingParameter(t,e,i,c&tt.ParticleFlag.WallParticle?0:this.getParticleMass(),0,r,r,a))},et.prototype.computeDampingImpulse=function(t,e,i,s,o,n,r){var a=t+e*i*i+s+o*n*n;return 0<a?r/a:0},et.prototype.applyDamping=function(t,e,i,s,o,n,r,a){o&&s?(o.linearVelocity.selfMulAdd(r*t,a),o.angularVelocity+=r*i*e):this.velocityBuffer.data[n].selfMulAdd(r*t,a)},et.xTruncBits=12,et.yTruncBits=12,et.tagBits=32,et.yOffset=1<<et.yTruncBits-1,et.yShift=et.tagBits-et.yTruncBits,et.xOffset=(et.xScale=1<<(et.xShift=et.tagBits-et.yTruncBits-et.xTruncBits))*(1<<et.xTruncBits-1),et.xMask=~(et.yMask=(1<<et.yTruncBits)-1<<et.yShift),et.DestroyParticlesInShape_s_aabb=new tt.AABB,et.createParticleGroup_s_transform=new tt.Transform,et.computeCollisionEnergy_s_v=new tt.Vec2,et.queryShapeAABB_s_aabb=new tt.AABB,et.QueryPointAABB_s_aabb=new tt.AABB,et.rayCast_s_aabb=new tt.AABB,et.rayCast_s_p=new tt.Vec2,et.rayCast_s_v=new tt.Vec2,et.rayCast_s_n=new tt.Vec2,et.rayCast_s_point=new tt.Vec2,et.k_pairFlags=tt.ParticleFlag.SpringParticle,et.k_triadFlags=tt.ParticleFlag.ElasticParticle,et.k_noPressureFlags=tt.ParticleFlag.PowderParticle|tt.ParticleFlag.TensileParticle,et.k_extraDampingFlags=tt.ParticleFlag.StaticPressureParticle,et.k_barrierWallFlags=tt.ParticleFlag.BarrierParticle|tt.ParticleFlag.WallParticle,et.createParticlesStrokeShapeForGroup_s_edge=new tt.EdgeShape,et.createParticlesStrokeShapeForGroup_s_d=new tt.Vec2,et.createParticlesStrokeShapeForGroup_s_p=new tt.Vec2,et.createParticlesFillShapeForGroup_s_aabb=new tt.AABB,et.createParticlesFillShapeForGroup_s_p=new tt.Vec2,et.updatePairsAndTriads_s_dab=new tt.Vec2,et.updatePairsAndTriads_s_dbc=new tt.Vec2,et.updatePairsAndTriads_s_dca=new tt.Vec2,et.addContact_s_d=new tt.Vec2,et.updateBodyContacts_s_aabb=new tt.AABB,et.solve_s_subStep=new tt.TimeStep,et.solveCollision_s_aabb=new tt.AABB,et.SolveGravity_s_gravity=new tt.Vec2,et.solveBarrier_s_aabb=new tt.AABB,et.solveBarrier_s_va=new tt.Vec2,et.solveBarrier_s_vb=new tt.Vec2,et.solveBarrier_s_pba=new tt.Vec2,et.solveBarrier_s_vba=new tt.Vec2,et.solveBarrier_s_vc=new tt.Vec2,et.solveBarrier_s_pca=new tt.Vec2,et.solveBarrier_s_vca=new tt.Vec2,et.solveBarrier_s_qba=new tt.Vec2,et.solveBarrier_s_qca=new tt.Vec2,et.solveBarrier_s_dv=new tt.Vec2,et.solveBarrier_s_f=new tt.Vec2,et.solvePressure_s_f=new tt.Vec2,et.solveDamping_s_v=new tt.Vec2,et.solveDamping_s_f=new tt.Vec2,et.solveRigidDamping_s_t0=new tt.Vec2,et.solveRigidDamping_s_t1=new tt.Vec2,et.solveRigidDamping_s_p=new tt.Vec2,et.solveRigidDamping_s_v=new tt.Vec2,et.solveExtraDamping_s_v=new tt.Vec2,et.solveExtraDamping_s_f=new tt.Vec2,et.solveRigid_s_position=new tt.Vec2,et.solveRigid_s_rotation=new tt.Rot,et.solveRigid_s_transform=new tt.Transform,et.solveRigid_s_velocityTransform=new tt.Transform,et.solveElastic_s_pa=new tt.Vec2,et.solveElastic_s_pb=new tt.Vec2,et.solveElastic_s_pc=new tt.Vec2,et.solveElastic_s_r=new tt.Rot,et.solveElastic_s_t0=new tt.Vec2,et.solveSpring_s_pa=new tt.Vec2,et.solveSpring_s_pb=new tt.Vec2,et.solveSpring_s_d=new tt.Vec2,et.solveSpring_s_f=new tt.Vec2,et.solveTensile_s_weightedNormal=new tt.Vec2,et.solveTensile_s_s=new tt.Vec2,et.solveTensile_s_f=new tt.Vec2,et.solveViscous_s_v=new tt.Vec2,et.solveViscous_s_f=new tt.Vec2,et.solveRepulsive_s_f=new tt.Vec2,et.solvePowder_s_f=new tt.Vec2,et.SolveSolid_s_f=new tt.Vec2,et.removeSpuriousBodyContacts_s_n=new tt.Vec2,et.removeSpuriousBodyContacts_s_pos=new tt.Vec2,et.removeSpuriousBodyContacts_s_normal=new tt.Vec2,et);function et(t,e){this.paused=!1,this.timestamp=0,this.allParticleFlags=0,this.needsUpdateAllParticleFlags=!1,this.allGroupFlags=0,this.needsUpdateAllGroupFlags=!1,this.hasForce=!1,this.iterationIndex=0,this.inverseDensity=0,this.particleDiameter=0,this.inverseDiameter=0,this.squaredDiameter=0,this.count=0,this.internalAllocatedCapacity=0,this.handleIndexBuffer=new B,this.flagsBuffer=new B,this.positionBuffer=new B,this.velocityBuffer=new B,this.forceBuffer=[],this.weightBuffer=[],this.staticPressureBuffer=[],this.accumulationBuffer=[],this.accumulation2Buffer=[],this.depthBuffer=[],this.colorBuffer=new B,this.groupBuffer=[],this.userDataBuffer=new B,this.stuckThreshold=0,this.lastBodyContactStepBuffer=new B,this.bodyContactCountBuffer=new B,this.consecutiveContactStepsBuffer=new B,this.stuckParticleBuffer=new i(function(){return 0}),this.proxyBuffer=new i(function(){return new w}),this.contactBuffer=new i(function(){return new r}),this.bodyContactBuffer=new i(function(){return new c}),this.pairBuffer=new i(function(){return new y}),this.triadBuffer=new i(function(){return new V}),this.expirationTimeBuffer=new B,this.indexByExpirationTimeBuffer=new B,this.timeElapsed=0,this.expirationTimeBufferRequiresSorting=!1,this.groupCount=0,this.groupList=null,this.def=new x,this.prev=null,this.next=null,this.updateBodyContacts_callback=null,this.solveCollision_callback=null,this.setStrictContactCheck(t.strictContactCheck),this.setDensity(t.density),this.setGravityScale(t.gravityScale),this.setRadius(t.radius),this.setMaxParticleCount(t.maxCount),this.def=t.clone(),this.world=e,this.setDestructionByAge(this.def.destroyByAge)}tt.ParticleSystem=m;var B=(Object.defineProperty(A.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t},enumerable:!0,configurable:!0}),A);function A(){this._data=null,this.userSuppliedCapacity=0}tt.ParticleSysteUserOverridableBuffer=B;var w=(b.compareProxyProxy=function(t,e){return t.tag<e.tag},b.compareTagProxy=function(t,e){return t<e.tag},b.compareProxyTag=function(t,e){return t.tag<e},b);function b(){this.index=tt.invalidParticleIndex,this.tag=0}tt.ParticleSysteProxy=w;var C=(_.prototype.getNext=function(){for(;this.first<this.last;){var t=(this.system.proxyBuffer.data[this.first].tag&m.xMask)>>>0;if(t>=this.xLower&&t<=this.xUpper)return this.system.proxyBuffer.data[this.first++].index;this.first++}return tt.invalidParticleIndex},_);function _(t,e,i,s,o){this.system=t,this.xLower=(e&m.xMask)>>>0,this.xUpper=(i&m.xMask)>>>0,this.yLower=(e&m.yMask)>>>0,this.yUpper=(i&m.yMask)>>>0,this.first=s,this.last=o}tt.ParticleSysteInsideBoundsEnumerator=C;var S=function(){this.next=null,this.count=0,this.index=0};tt.ParticleSysteParticleListNode=S;var M=(P.prototype.allocate=function(t,e){return e},P.prototype.clear=function(){},P.prototype.getCount=function(){return 0},P.prototype.invalidate=function(t){},P.prototype.getValidBuffer=function(){return[]},P.prototype.getBuffer=function(){return[]},P.prototype.setCount=function(t){},P);function P(){}tt.ParticleSysteFixedSetAllocator=M;function I(t,e){this.second=tt.invalidParticleIndex,this.first=t,this.second=e}tt.ParticleSysteFixtureParticle=I;var T,F=(__extends(D,T=M),D.prototype.initialize=function(t,e){},D.prototype.find=function(t){return tt.invalidParticleIndex},D);function D(){return null!==T&&T.apply(this,arguments)||this}tt.ParticleSysteFixtureParticleSet=F;function L(t,e){this.first=tt.invalidParticleIndex,this.second=tt.invalidParticleIndex,this.first=t,this.second=e}tt.ParticleSysteParticlePair=L;var R,k=(__extends(q,R=M),q.prototype.initialize=function(t,e){},q.prototype.find=function(t){return tt.invalidParticleIndex},q);function q(){return null!==R&&R.apply(this,arguments)||this}tt.ParticlePairSet=k;var J=(E.prototype.isNecessary=function(t){return!0},E.prototype.shouldCreatePair=function(t,e){return!0},E.prototype.shouldCreateTriad=function(t,e,i){return!0},E);function E(){}tt.ParticleSysteConnectionFilter=J;var z,j=(z=tt.QueryCallback,__extends(O,z),O.prototype.reportFixture=function(t){return!1},O.prototype.reportParticle=function(t,e){return t===this.system&&(this.shape.testPoint(this.xf,this.system.positionBuffer.data[e])&&(this.system.destroyParticle(e,this.callDestructionListener),this.destroyed++),!0)},O.prototype.isDestroyed=function(){return this.destroyed},O);function O(t,e,i,s){var o=z.call(this)||this;return o.callDestructionListener=!1,o.destroyed=0,o.system=t,o.shape=e,o.xf=i,o.callDestructionListener=s,o.destroyed=0,o}tt.ParticleSysteDestroyParticlesInShapeCallback=j;var G,N=(__extends(X,G=J),X.prototype.shouldCreatePair=function(t,e){return t<this.threshold&&this.threshold<=e||e<this.threshold&&this.threshold<=t},X.prototype.shouldCreateTriad=function(t,e,i){return(t<this.threshold||e<this.threshold||i<this.threshold)&&(this.threshold<=t||this.threshold<=e||this.threshold<=i)},X);function X(t){var e=G.call(this)||this;return e.threshold=0,e.threshold=t,e}tt.ParticleSysteJoinParticleGroupsFilter=N;var Z,W=(Z=tt.Shape,__extends(U,Z),U.prototype.clone=function(){throw new Error},U.prototype.getChildCount=function(){return 1},U.prototype.testPoint=function(t,e){for(var i=0;i<this.shapeCount;i++)if(this.shapes[i].testPoint(t,e))return!0;return!1},U.prototype.computeDistance=function(t,e,i,s){return 0},U.prototype.rayCast=function(t,e,i,s){return!1},U.prototype.computeAABB=function(t,e,i){var s=new tt.AABB;t.lowerBound.x=+tt.maxFloat,t.lowerBound.y=+tt.maxFloat,t.upperBound.x=-tt.maxFloat,t.upperBound.y=-tt.maxFloat;for(var o=0;o<this.shapeCount;o++)for(var n=this.shapes[o].getChildCount(),r=0;r<n;r++){var a=s;this.shapes[o].computeAABB(a,e,r),t.combine1(a)}},U.prototype.computeMass=function(t,e){},U.prototype.setupDistanceProxy=function(t,e){},U.prototype.computeSubmergedArea=function(t,e,i,s){return 0},U.prototype.dump=function(t){},U);function U(t,e){void 0===e&&(e=t.length);var i=Z.call(this,tt.ShapeType.Unknown,0)||this;return i.shapeCount=0,i.shapes=t,i.shapeCount=e,i}tt.ParticleSysteCompositeShape=W;var Y,K=(__extends(H,Y=J),H.prototype.isNecessary=function(t){return 0!=(this.flagsBuffer.data[t]&tt.ParticleFlag.ReactiveParticle)},H);function H(t){var e=Y.call(this)||this;return e.flagsBuffer=t,e}tt.ParticleSysteReactiveFilter=K;var Q,$=(__extends(it,Q=o),it.prototype.shouldCollideFixtureParticle=function(t,e,i){if(this.contactFilter&&this.system.getFlagsBuffer()[i]&tt.ParticleFlag.FixtureContactFilterParticle)return this.contactFilter.shouldCollideFixtureParticle(t,this.system,i);return!0},it.prototype.reportFixtureAndParticle=function(t,e,i){var s,o,n,r,a,c,l,h,u,p,d,f=it.ReportFixtureAndParticle_s_n,y=it.ReportFixtureAndParticle_s_rp,V=this.system.positionBuffer.data[i],v=f,x=t.computeDistance(V,v,e);x<this.system.particleDiameter&&this.shouldCollideFixtureParticle(t,this.system,i)&&(o=(s=t.getBody()).getWorldCenter(),a=0<(n=s.getMass())?1/n:0,c=0<(r=s.getInertia()-n*s.getLocalCenter().lengthSquared())?1/r:0,l=this.system.flagsBuffer.data[i]&tt.ParticleFlag.WallParticle?0:this.system.getParticleInvMass(),h=tt.Vec2.SubVV(V,o,y),p=l+a+c*(u=tt.Vec2.CrossVV(h,v))*u,(d=this.system.bodyContactBuffer.data[this.system.bodyContactBuffer.append()]).index=i,d.body=s,d.fixture=t,d.weight=1-x*this.system.inverseDiameter,d.normal.copy(v.selfNeg()),d.mass=0<p?1/p:0,this.system.detectStuckParticle(i))},it.ReportFixtureAndParticle_s_n=new tt.Vec2,it.ReportFixtureAndParticle_s_rp=new tt.Vec2,it);function it(t,e){void 0===e&&(e=null);var i=Q.call(this,t)||this;return i.contactFilter=null,i.contactFilter=e,i}tt.ParticleSysteUpdateBodyContactsCallback=$;var st,ot=(__extends(nt,st=o),nt.prototype.reportFixtureAndParticle=function(t,e,i){var s,o,n,r,a,c=nt.ReportFixtureAndParticle_s_p1,l=nt.ReportFixtureAndParticle_s_output,h=nt.ReportFixtureAndParticle_s_input,u=nt.ReportFixtureAndParticle_s_p,p=nt.ReportFixtureAndParticle_s_v,d=nt.ReportFixtureAndParticle_s_f,f=t.getBody(),y=this.system.positionBuffer.data[i],V=this.system.velocityBuffer.data[i],v=l,x=h;0===this.system.iterationIndex?(s=tt.Transform.mulTXV(f.xf0,y,c),t.getShape().getType()===tt.ShapeType.CircleShape&&(s.selfSub(f.getLocalCenter()),tt.Rot.mulRV(f.xf0.q,s,s),tt.Rot.mulTRV(f.xf.q,s,s),s.selfAdd(f.getLocalCenter())),tt.Transform.mulXV(f.xf,s,x.p1)):x.p1.copy(y),tt.Vec2.AddVMulSV(y,this.step.dt,V,x.p2),x.maxFraction=1,t.rayCast(v,x,e)&&(o=v.normal,(n=u).x=(1-v.fraction)*x.p1.x+v.fraction*x.p2.x+tt.linearSlop*o.x,n.y=(1-v.fraction)*x.p1.y+v.fraction*x.p2.y+tt.linearSlop*o.y,(r=p).x=this.step.inv_dt*(n.x-y.x),r.y=this.step.inv_dt*(n.y-y.y),this.system.velocityBuffer.data[i].copy(r),(a=d).x=this.step.inv_dt*this.system.getParticleMass()*(V.x-r.x),a.y=this.step.inv_dt*this.system.getParticleMass()*(V.y-r.y),this.system.particleApplyForce(i,a))},nt.prototype.reportParticle=function(t,e){return!1},nt.ReportFixtureAndParticle_s_p1=new tt.Vec2,nt.ReportFixtureAndParticle_s_output=new tt.RayCastOutput,nt.ReportFixtureAndParticle_s_input=new tt.RayCastInput,nt.ReportFixtureAndParticle_s_p=new tt.Vec2,nt.ReportFixtureAndParticle_s_v=new tt.Vec2,nt.ReportFixtureAndParticle_s_f=new tt.Vec2,nt);function nt(t,e){var i=st.call(this,t)||this;return i.step=e,i}tt.ParticleSysteSolveCollisionCallback=ot}(b2=b2||{}),function(t){var e=(Object.defineProperty(i.prototype,"capacity",{get:function(){return this.buffer.length},enumerable:!0,configurable:!0}),i.prototype.push=function(t){if(this.back>=this.capacity){for(var e=this.front;e<this.back;e++)this.buffer[e-this.front]=this.buffer[e];this.back-=this.front,this.front=0}this.buffer[this.back]=t,this.back++},i.prototype.pop=function(){this.buffer[this.front]=null,this.front++},i.prototype.empty=function(){return this.front===this.back},i.prototype.getFront=function(){var t=this.buffer[this.front];if(!t)throw new Error;return t},i);function i(t){this.buffer=[],this.front=0;for(var e=this.back=0;e<t;e++)this.buffer[e]=null}t.StackQueue=e}(b2=b2||{}),function(g){var t=(e.prototype.addGenerator=function(t,e,i){var s=this.generatorBuffer[this.generatorCount++];s.center.copy(t),s.tag=e,s.necessary=i},e.prototype.generate=function(t,e){for(var i=1/t,s=new g.Vec2(+g.maxFloat,+g.maxFloat),o=new g.Vec2(-g.maxFloat,-g.maxFloat),n=0,r=0;r<this.generatorCount;r++){(u=this.generatorBuffer[r]).necessary&&(g.Vec2.MinV(s,u.center,s),g.Vec2.MaxV(o,u.center,o),++n)}if(0===n)return this.countX=0,void(this.countY=0);s.x-=e,s.y-=e,o.x+=e,o.y+=e,this.countX=1+Math.floor(i*(o.x-s.x)),this.countY=1+Math.floor(i*(o.y-s.y)),this.diagram=[];for(var a=new g.StackQueue(4*this.countX*this.countY),r=0;r<this.generatorCount;r++){(u=this.generatorBuffer[r]).center.selfSub(s).selfMul(i);var c=Math.floor(u.center.x),l=Math.floor(u.center.y);0<=c&&0<=l&&c<this.countX&&l<this.countY&&a.push(new m(c,l,c+l*this.countX,u))}for(;!a.empty();){var c=(p=a.getFront()).x,l=p.y,h=p.i,u=p.generator;a.pop(),this.diagram[h]||(this.diagram[h]=u,0<c&&a.push(new m(c-1,l,h-1,u)),0<l&&a.push(new m(c,l-1,h-this.countX,u)),c<this.countX-1&&a.push(new m(c+1,l,h+1,u)),l<this.countY-1&&a.push(new m(c,l+1,h+this.countX,u)))}for(l=0;l<this.countY;l++)for(c=0;c<this.countX-1;c++){h=c+l*this.countX;(d=this.diagram[h])!==(f=this.diagram[h+1])&&(a.push(new m(c,l,h,f)),a.push(new m(c+1,l,h+1,d)))}for(l=0;l<this.countY-1;l++)for(c=0;c<this.countX;c++){h=c+l*this.countX;(d=this.diagram[h])!==(f=this.diagram[h+this.countX])&&(a.push(new m(c,l,h,f)),a.push(new m(c,l+1,h+this.countX,d)))}for(;!a.empty();){var p,d,f,y,V,v,x,c=(p=a.getFront()).x,l=p.y,h=p.i,r=p.generator;a.pop(),(d=this.diagram[h])!==(f=r)&&(y=d.center.x-c,V=d.center.y-l,(v=f.center.x-c)*v+(x=f.center.y-l)*x<y*y+V*V&&(this.diagram[h]=f,0<c&&a.push(new m(c-1,l,h-1,f)),0<l&&a.push(new m(c,l-1,h-this.countX,f)),c<this.countX-1&&a.push(new m(c+1,l,h+1,f)),l<this.countY-1&&a.push(new m(c,l+1,h+this.countX,f))))}},e.prototype.getNodes=function(t){for(var e=0;e<this.countY-1;e++)for(var i=0;i<this.countX-1;i++){var s=i+e*this.countX,o=this.diagram[s],n=this.diagram[s+1],r=this.diagram[s+this.countX],a=this.diagram[s+1+this.countX];n!==r&&(o!==n&&o!==r&&(o.necessary||n.necessary||r.necessary)&&t(o.tag,n.tag,r.tag),a!==n&&a!==r&&(o.necessary||n.necessary||r.necessary)&&t(n.tag,a.tag,r.tag))}},e);function e(t){this.generatorCapacity=0,this.generatorCount=0,this.countX=0,this.countY=0,this.diagram=[],this.generatorBuffer=g.MakeArray(t,function(t){return new i}),this.generatorCapacity=t}g.VoronoiDiagram=t;var i=function(){this.center=new g.Vec2,this.tag=0,this.necessary=!1};g.VoronoiDiagraGenerator=i;var m=function(t,e,i,s){this.x=t,this.y=e,this.i=i,this.generator=s};g.VoronoiDiagraTask=m}(b2=b2||{}),function(S){var r,t,a,e;(t=r=S.StretchingModel||(S.StretchingModel={}))[t.pbdStretchingModel=0]="pbdStretchingModel",t[t.xpbdStretchingModel=1]="xpbdStretchingModel",(e=a=S.BendingModel||(S.BendingModel={}))[e.springAngleBendingModel=0]="springAngleBendingModel",e[e.pbdAngleBendingModel=1]="pbdAngleBendingModel",e[e.xpbdAngleBendingModel=2]="xpbdAngleBendingModel",e[e.pbdDistanceBendingModel=3]="pbdDistanceBendingModel",e[e.pbdHeightBendingModel=4]="pbdHeightBendingModel",e[e.pbdTriangleBendingModel=5]="pbdTriangleBendingModel";var i=(s.prototype.copy=function(t){return this.stretchingModel=t.stretchingModel,this.bendingModel=t.bendingModel,this.damping=t.damping,this.stretchStiffness=t.stretchStiffness,this.stretchHertz=t.stretchHertz,this.stretchDamping=t.stretchDamping,this.bendStiffness=t.bendStiffness,this.bendHertz=t.bendHertz,this.bendDamping=t.bendDamping,this.isometric=t.isometric,this.fixedEffectiveMass=t.fixedEffectiveMass,this.warmStart=t.warmStart,this},s);function s(){this.stretchingModel=r.pbdStretchingModel,this.bendingModel=a.pbdAngleBendingModel,this.damping=0,this.stretchStiffness=1,this.stretchHertz=0,this.stretchDamping=0,this.bendStiffness=.5,this.bendHertz=1,this.bendDamping=0,this.isometric=!1,this.fixedEffectiveMass=!1,this.warmStart=!1}S.RopeTuning=i;function o(){this.position=new S.Vec2,this.vertices=[],this.count=0,this.masses=[],this.gravity=new S.Vec2,this.tuning=new i}S.RopeDef=o;var g=function(){this.i1=0,this.i2=0,this.invMass1=0,this.invMass2=0,this.L=0,this.lambda=0,this.spring=0,this.damper=0},m=function(){this.i1=0,this.i2=0,this.i3=0,this.invMass1=0,this.invMass2=0,this.invMass3=0,this.invEffectiveMass=0,this.lambda=0,this.L1=0,this.L2=0,this.alpha1=0,this.alpha2=0,this.spring=0,this.damper=0},n=(c.prototype.create=function(t){function e(t,e,i){for(var s=0;s<e;++s)t[s]=i(s)}this.position.copy(t.position),this.count=t.count,e(this.bindPositions,this.count,function(){return new S.Vec2}),e(this.ps,this.count,function(){return new S.Vec2}),e(this.p0s,this.count,function(){return new S.Vec2}),e(this.vs,this.count,function(){return new S.Vec2}),e(this.invMasses,this.count,function(){return 0});for(var i=0;i<this.count;++i){this.bindPositions[i].copy(t.vertices[i]),this.ps[i].copy(t.vertices[i]).selfAdd(this.position),this.p0s[i].copy(t.vertices[i]).selfAdd(this.position),this.vs[i].setZero();var s=t.masses[i];this.invMasses[i]=0<s?1/s:0}this.stretchCount=this.count-1,this.bendCount=this.count-2,e(this.stretchConstraints,this.stretchCount,function(){return new g}),e(this.bendConstraints,this.bendCount,function(){return new m});for(i=0;i<this.stretchCount;++i){var o=this.stretchConstraints[i],n=this.ps[i],r=this.ps[i+1];o.i1=i,o.i2=i+1,o.L=S.Vec2.DistanceVV(n,r),o.invMass1=this.invMasses[i],o.invMass2=this.invMasses[i+1],o.lambda=0,o.damper=0,o.spring=0}for(i=0;i<this.bendCount;++i){var o=this.bendConstraints[i],n=this.ps[i],r=this.ps[i+1],a=this.ps[i+2];o.i1=i,o.i2=i+1,o.i3=i+2,o.invMass1=this.invMasses[i],o.invMass2=this.invMasses[i+1],o.invMass3=this.invMasses[i+2],o.invEffectiveMass=0,o.L1=S.Vec2.DistanceVV(n,r),o.L2=S.Vec2.DistanceVV(r,a),o.lambda=0;var c,l,h,u,p,d,f,y=S.Vec2.SubVV(r,n,new S.Vec2),V=S.Vec2.SubVV(a,r,new S.Vec2),v=y.lengthSquared(),x=V.lengthSquared();v*x!=0&&(c=(new S.Vec2).copy(y).selfSkew().selfMul(-1/v),l=(new S.Vec2).copy(V).selfSkew().selfMul(1/x),h=c.clone().selfNeg(),u=c.clone().selfSub(l),p=l.clone(),o.invEffectiveMass=o.invMass1*S.Vec2.DotVV(h,h)+o.invMass2*S.Vec2.DotVV(u,u)+o.invMass3*S.Vec2.DotVV(p,p),0!==(f=(d=S.Vec2.SubVV(a,n,new S.Vec2)).lengthSquared())&&(o.alpha1=S.Vec2.DotVV(V,d)/f,o.alpha2=S.Vec2.DotVV(y,d)/f))}this.gravity.copy(t.gravity),this.setTuning(t.tuning)},c.prototype.setTuning=function(t){this.tuning.copy(t);for(var e=2*S.pi*this.tuning.bendHertz,i=0;i<this.bendCount;++i){var s,o=(r=this.bendConstraints[i]).L1*r.L1,n=r.L2*r.L2;o*n!=0?(s=1/r.L1+1/r.L2,0!==(a=r.invMass1/o+r.invMass2*s*s+r.invMass3/n)?(c=1/a,r.spring=c*e*e,r.damper=2*c*this.tuning.bendDamping*e):(r.spring=0,r.damper=0)):(r.spring=0,r.damper=0)}for(var r,a,c,l=2*S.pi*this.tuning.stretchHertz,i=0;i<this.stretchCount;++i){0!==(a=(r=this.stretchConstraints[i]).invMass1+r.invMass2)&&(c=1/a,r.spring=c*l*l,r.damper=2*c*this.tuning.stretchDamping*l)}},c.prototype.step=function(t,e,i){if(0!==t){for(var s=1/t,o=Math.exp(-t*this.tuning.damping),n=0;n<this.count;++n)0<this.invMasses[n]?(this.vs[n].x*=o,this.vs[n].y*=o,this.vs[n].x+=t*this.gravity.x,this.vs[n].y+=t*this.gravity.y):(this.vs[n].x=s*(this.bindPositions[n].x+i.x-this.p0s[n].x),this.vs[n].y=s*(this.bindPositions[n].y+i.y-this.p0s[n].y));this.tuning.bendingModel===a.springAngleBendingModel&&this.applyBendForces(t);for(n=0;n<this.bendCount;++n)this.bendConstraints[n].lambda=0;for(n=0;n<this.stretchCount;++n)this.stretchConstraints[n].lambda=0;for(n=0;n<this.count;++n)this.ps[n].x+=t*this.vs[n].x,this.ps[n].y+=t*this.vs[n].y;for(n=0;n<e;++n)this.tuning.bendingModel===a.pbdAngleBendingModel?this.solveBendPBDAngle():this.tuning.bendingModel===a.xpbdAngleBendingModel?this.solveBendXPBDAngle(t):this.tuning.bendingModel===a.pbdDistanceBendingModel?this.solveBendPBDDistance():this.tuning.bendingModel===a.pbdHeightBendingModel?this.solveBendPBDHeight():this.tuning.bendingModel===a.pbdTriangleBendingModel&&this.solveBendPBDTriangle(),this.tuning.stretchingModel===r.pbdStretchingModel?this.solveStretchPBD():this.tuning.stretchingModel===r.xpbdStretchingModel&&this.solveStretchXPBD(t);for(n=0;n<this.count;++n)this.vs[n].x=s*(this.ps[n].x-this.p0s[n].x),this.vs[n].y=s*(this.ps[n].y-this.p0s[n].y),this.p0s[n].copy(this.ps[n])}},c.prototype.reset=function(t){this.position.copy(t);for(var e=0;e<this.count;++e)this.ps[e].x=this.bindPositions[e].x+this.position.x,this.ps[e].y=this.bindPositions[e].y+this.position.y,this.p0s[e].x=this.bindPositions[e].x+this.position.x,this.p0s[e].y=this.bindPositions[e].y+this.position.y,this.vs[e].setZero();for(e=0;e<this.bendCount;++e)this.bendConstraints[e].lambda=0;for(e=0;e<this.stretchCount;++e)this.stretchConstraints[e].lambda=0},c.prototype.draw=function(t){for(var e=new S.Color(.4,.5,.7),i=new S.Color(.1,.8,.1),s=new S.Color(.7,.2,.4),o=0;o<this.count-1;++o){t.drawSegment(this.ps[o],this.ps[o+1],e);var n=0<this.invMasses[o]?s:i;t.drawPoint(this.ps[o],5,n)}var r=0<this.invMasses[this.count-1]?s:i;t.drawPoint(this.ps[this.count-1],5,r)},c.prototype.solveStretchPBD=function(){for(var t=this.tuning.stretchStiffness,e=0;e<this.stretchCount;++e){var i,s,o=this.stretchConstraints[e],n=this.ps[o.i1].clone(),r=this.ps[o.i2].clone(),a=r.clone().selfSub(n),c=a.normalize(),l=o.invMass1+o.invMass2;0!==l&&(i=o.invMass1/l,s=o.invMass2/l,n.x-=t*i*(o.L-c)*a.x,n.y-=t*i*(o.L-c)*a.y,r.x+=t*s*(o.L-c)*a.x,r.y+=t*s*(o.L-c)*a.y,this.ps[o.i1].copy(n),this.ps[o.i2].copy(r))}},c.prototype.solveStretchXPBD=function(t){for(var e=0;e<this.stretchCount;++e){var i,s,o,n,r,a=this.stretchConstraints[e],c=this.ps[a.i1].clone(),l=this.ps[a.i2].clone(),h=c.clone().selfSub(this.p0s[a.i1]),u=l.clone().selfSub(this.p0s[a.i2]),p=l.clone().selfSub(c),d=p.normalize(),f=p.clone().selfNeg(),y=p,V=a.invMass1+a.invMass2;0!==V&&(s=(i=1/(a.spring*t*t))*(t*t*a.damper)/t,o=d-a.L,n=S.Vec2.DotVV(f,h)+S.Vec2.DotVV(y,u),r=-(o+i*a.lambda+s*n)/((1+s)*V+i),c.x+=a.invMass1*r*f.x,c.y+=a.invMass1*r*f.y,l.x+=a.invMass2*r*y.x,l.y+=a.invMass2*r*y.y,this.ps[a.i1].copy(c),this.ps[a.i2].copy(l),a.lambda+=r)}},c.prototype.solveBendPBDAngle=function(){for(var t=this.tuning.bendStiffness,e=0;e<this.bendCount;++e){var i,s,o,n,r,a,c,l=this.bendConstraints[e],h=this.ps[l.i1],u=this.ps[l.i2],p=this.ps[l.i3],d=u.clone().selfSub(h),f=p.clone().selfSub(u),y=S.Vec2.CrossVV(d,f),V=S.Vec2.DotVV(d,f),v=S.Atan2(y,V),x=0,g=0,g=this.tuning.isometric?(x=l.L1*l.L1,l.L2*l.L2):(x=d.lengthSquared(),f.lengthSquared());x*g!=0&&(i=(new S.Vec2).copy(d).selfSkew().selfMul(-1/x),s=(new S.Vec2).copy(f).selfSkew().selfMul(1/g),o=i.clone().selfNeg(),n=i.clone().selfSub(s),r=s,(a=0)===(a=this.tuning.fixedEffectiveMass?l.invEffectiveMass:l.invMass1*S.Vec2.DotVV(o,o)+l.invMass2*S.Vec2.DotVV(n,n)+l.invMass3*S.Vec2.DotVV(r,r))&&(a=l.invEffectiveMass),c=-t*v/a,h.x+=l.invMass1*c*o.x,h.y+=l.invMass1*c*o.y,u.x+=l.invMass2*c*n.x,u.y+=l.invMass2*c*n.y,p.x+=l.invMass3*c*r.x,p.y+=l.invMass3*c*r.y,this.ps[l.i1].copy(h),this.ps[l.i2].copy(u),this.ps[l.i3].copy(p))}},c.prototype.solveBendXPBDAngle=function(t){for(var e=0;e<this.bendCount;++e){var i,s,o,n,r,a,c,l,h,u,p,d,f,y,V=this.bendConstraints[e],v=this.ps[V.i1],x=this.ps[V.i2],g=this.ps[V.i3],m=v.clone().selfSub(this.p0s[V.i1]),B=x.clone().selfSub(this.p0s[V.i2]),A=g.clone().selfSub(this.p0s[V.i3]),w=x.clone().selfSub(v),b=g.clone().selfSub(x),C=void 0,_=void 0,_=this.tuning.isometric?(C=V.L1*V.L1,V.L2*V.L2):(C=w.lengthSquared(),b.lengthSquared());C*_!=0&&(i=S.Vec2.CrossVV(w,b),s=S.Vec2.DotVV(w,b),o=S.Atan2(i,s),n=(new S.Vec2).copy(w).selfSkew().selfMul(-1/C),r=(new S.Vec2).copy(b).selfSkew().selfMul(1/_),a=n.clone().selfNeg(),c=n.clone().selfSub(r),l=r,y=void 0,0!==(y=this.tuning.fixedEffectiveMass?V.invEffectiveMass:V.invMass1*S.Vec2.DotVV(a,a)+V.invMass2*S.Vec2.DotVV(c,c)+V.invMass3*S.Vec2.DotVV(l,l))&&(u=(h=1/(V.spring*t*t))*(t*t*V.damper)/t,p=o,d=S.Vec2.DotVV(a,m)+S.Vec2.DotVV(c,B)+S.Vec2.DotVV(l,A),f=-(p+h*V.lambda+u*d)/((1+u)*y+h),v.x+=V.invMass1*f*a.x,v.y+=V.invMass1*f*a.y,x.x+=V.invMass2*f*c.x,x.y+=V.invMass2*f*c.y,g.x+=V.invMass3*f*l.x,g.y+=V.invMass3*f*l.y,this.ps[V.i1].copy(v),this.ps[V.i2].copy(x),this.ps[V.i3].copy(g),V.lambda+=f))}},c.prototype.solveBendPBDDistance=function(){for(var t=this.tuning.bendStiffness,e=0;e<this.bendCount;++e){var i,s,o=this.bendConstraints[e],n=o.i1,r=o.i3,a=this.ps[n].clone(),c=this.ps[r].clone(),l=c.clone().selfSub(a),h=l.normalize(),u=o.invMass1+o.invMass3;0!==u&&(i=o.invMass1/u,s=o.invMass3/u,a.x-=t*i*(o.L1+o.L2-h)*l.x,a.y-=t*i*(o.L1+o.L2-h)*l.y,c.x+=t*s*(o.L1+o.L2-h)*l.x,c.y+=t*s*(o.L1+o.L2-h)*l.y,this.ps[n].copy(a),this.ps[r].copy(c))}},c.prototype.solveBendPBDHeight=function(){for(var t=this.tuning.bendStiffness,e=0;e<this.bendCount;++e){var i=this.bendConstraints[e],s=this.ps[i.i1].clone(),o=this.ps[i.i2].clone(),n=this.ps[i.i3].clone(),r=new S.Vec2;r.x=i.alpha1*s.x+i.alpha2*n.x-o.x,r.y=i.alpha1*s.y+i.alpha2*n.y-o.y;var a,c,l,h,u,p,d=r.length();0!==d&&(c=(a=r.clone().selfMul(1/d)).clone().selfMul(i.alpha1),l=a.clone().selfNeg(),h=a.clone().selfMul(i.alpha2),0!==(u=i.invMass1*i.alpha1*i.alpha1+i.invMass2+i.invMass3*i.alpha2*i.alpha2)&&(p=-t*(1/u)*d,s.x+=i.invMass1*p*c.x,s.y+=i.invMass1*p*c.y,o.x+=i.invMass2*p*l.x,o.y+=i.invMass2*p*l.y,n.x+=i.invMass3*p*h.x,n.y+=i.invMass3*p*h.y,this.ps[i.i1].copy(s),this.ps[i.i2].copy(o),this.ps[i.i3].copy(n)))}},c.prototype.solveBendPBDTriangle=function(){for(var t=this.tuning.bendStiffness,e=0;e<this.bendCount;++e){var i=this.bendConstraints[e],s=this.ps[i.i1].clone(),o=this.ps[i.i2].clone(),n=this.ps[i.i3].clone(),r=i.invMass1,a=i.invMass2,c=i.invMass3,l=t/(r+c+2*a),h=new S.Vec2;h.x=o.x-1/3*(s.x+o.x+n.x),h.y=o.y-1/3*(s.y+o.y+n.y);var u=new S.Vec2;u.x=2*r*l*h.x,u.y=2*r*l*h.y;var p=new S.Vec2;p.x=-4*a*l*h.x,p.y=-4*a*l*h.y;var d=new S.Vec2;d.x=2*c*l*h.x,d.y=2*c*l*h.y,s.selfAdd(u),o.selfAdd(p),n.selfAdd(d),this.ps[i.i1].copy(s),this.ps[i.i2].copy(o),this.ps[i.i3].copy(n)}},c.prototype.applyBendForces=function(t){for(var e=2*S.pi*this.tuning.bendHertz,i=0;i<this.bendCount;++i){var s,o,n,r,a,c,l,h,u,p,d,f=this.bendConstraints[i],y=this.ps[f.i1].clone(),V=this.ps[f.i2].clone(),v=this.ps[f.i3].clone(),x=this.vs[f.i1],g=this.vs[f.i2],m=this.vs[f.i3],B=y.clone().selfSub(y),A=v.clone().selfSub(V),w=void 0,b=void 0,b=this.tuning.isometric?(w=f.L1*f.L1,f.L2*f.L2):(w=B.lengthSquared(),A.lengthSquared());w*b!=0&&(s=S.Vec2.CrossVV(B,A),o=S.Vec2.DotVV(B,A),n=S.Atan2(s,o),r=(new S.Vec2).copy(B).selfSkew().selfMul(-1/w),a=(new S.Vec2).copy(A).selfSkew().selfMul(1/b),c=r.clone().selfNeg(),l=r.clone().selfSub(a),h=a,(d=0)!==(d=this.tuning.fixedEffectiveMass?f.invEffectiveMass:f.invMass1*S.Vec2.DotVV(c,c)+f.invMass2*S.Vec2.DotVV(l,l)+f.invMass3*S.Vec2.DotVV(h,h))&&(p=-t*((u=1/d)*e*e*n+2*u*this.tuning.bendDamping*e*(S.Vec2.DotVV(c,x)+S.Vec2.DotVV(l,g)+S.Vec2.DotVV(h,m))),this.vs[f.i1].x+=f.invMass1*p*c.x,this.vs[f.i1].y+=f.invMass1*p*c.y,this.vs[f.i2].x+=f.invMass2*p*l.x,this.vs[f.i2].y+=f.invMass2*p*l.y,this.vs[f.i3].x+=f.invMass3*p*h.x,this.vs[f.i3].y+=f.invMass3*p*h.y))}},c);function c(){this.position=new S.Vec2,this.count=0,this.stretchCount=0,this.bendCount=0,this.stretchConstraints=[],this.bendConstraints=[],this.bindPositions=[],this.ps=[],this.p0s=[],this.vs=[],this.invMasses=[],this.gravity=new S.Vec2,this.tuning=new i}S.Rope=n}(b2=b2||{});