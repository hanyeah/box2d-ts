var b2,__extends=this&&this.__extends||function(){var s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){t.Assert=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(!t)throw new Error(e.join("\n"))},t.Maybe=function(t,e){return void 0!==t?t:e},t.maxFloat=1e37,t.epsilon=1e-5,t.epsilon_sq=t.epsilon*t.epsilon,t.pi=3.14159265359,t.lengthUnitsPerMeter=1,t.maxPolygonVertices=8,t.maxManifoldPoints=2,t.aabbExtension=.1*t.lengthUnitsPerMeter,t.aabbMultiplier=4,t.linearSlop=.005*t.lengthUnitsPerMeter,t.angularSlop=2/180*t.pi,t.polygonRadius=2*t.linearSlop,t.maxSubSteps=8,t.maxTOIContacts=32,t.maxLinearCorrection=.2*t.lengthUnitsPerMeter,t.maxAngularCorrection=8/180*t.pi,t.maxTranslation=2*t.lengthUnitsPerMeter,t.maxTranslationSquared=t.maxTranslation*t.maxTranslation,t.maxRotation=.5*t.pi,t.maxRotationSquared=t.maxRotation*t.maxRotation,t.baumgarte=.2,t.toiBaumgarte=.75,t.invalidParticleIndex=-1,t.maxParticleIndex=2147483647,t.particleStride=.75,t.minParticleWeight=1,t.maxParticlePressure=.25,t.maxParticleForce=.5,t.maxTriadDistance=2*t.lengthUnitsPerMeter,t.maxTriadDistanceSquared=t.maxTriadDistance*t.maxTriadDistance,t.minParticleSystemBufferCapacity=256,t.barrierCollisionTime=2.5,t.timeToSleep=.5,t.linearSleepTolerance=.01*t.lengthUnitsPerMeter,t.angularSleepTolerance=2/180*t.pi;var e=(i.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},i);function i(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}t.Version=e,t.version=new e(2,4,1),t.branch="master",t.commit="9ebbbcd960ad424e03e5de6e66a40764c16f51bc",t.ParseInt=function(t){return parseInt(t,10)},t.ParseUInt=function(t){return Math.abs(parseInt(t,10))},t.MakeArray=function(t,e){for(var i=new Array(t),s=0;s<t;++s)i[s]=e(s);return i},t.MakeNullArray=function(t){for(var e=new Array(t),i=0;i<t;++i)e[i]=null;return e},t.MakeNumberArray=function(t,e){void 0===e&&(e=0);for(var i=new Array(t),s=0;s<t;++s)i[s]=e;return i}}(b2=b2||{}),function(o){function s(t,e){return t<e?t:e}function n(t,e){return e<t?t:e}function r(t,e,i){return t<e?e:i<t?i:t}o.pi_over_180=o.pi/180,o._180_over_pi=180/o.pi,o.two_pi=2*o.pi,o.Abs=Math.abs,o.Min=s,o.Max=n,o.Clamp=r,o.Swap=function(t,e){var i=t[0];t[0]=e[0],e[0]=i},o.IsValid=isFinite,o.Sq=function(t){return t*t},o.InvSqrt=function(t){return 1/Math.sqrt(t)},o.Sqrt=Math.sqrt,o.Pow=Math.pow,o.DegToRad=function(t){return t*o.pi_over_180},o.RadToDeg=function(t){return t*o._180_over_pi},o.Cos=Math.cos,o.Sin=Math.sin,o.Acos=Math.acos,o.Asin=Math.asin,o.Atan2=Math.atan2,o.NextPowerOfTwo=function(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,(t|=t>>16&65535)+1},o.IsPowerOfTwo=function(t){return 0<t&&0==(t&t-1)},o.Random=function(){return 2*Math.random()-1},o.RandomRange=function(t,e){return(e-t)*Math.random()+t};var a=(e.prototype.Clone=function(){return new e(this.x,this.y)},e.prototype.SetZero=function(){return this.x=0,this.y=0,this},e.prototype.Set=function(t,e){return this.x=t,this.y=e,this},e.prototype.Copy=function(t){return this.x=t.x,this.y=t.y,this},e.prototype.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},e.prototype.SelfAddXY=function(t,e){return this.x+=t,this.y+=e,this},e.prototype.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this},e.prototype.SelfSubXY=function(t,e){return this.x-=t,this.y-=e,this},e.prototype.SelfMul=function(t){return this.x*=t,this.y*=t,this},e.prototype.SelfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},e.prototype.SelfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},e.prototype.Dot=function(t){return this.x*t.x+this.y*t.y},e.prototype.Cross=function(t){return this.x*t.y-this.y*t.x},e.prototype.Length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},e.prototype.LengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},e.prototype.Normalize=function(){var t,e=this.Length();return e>=o.epsilon&&(t=1/e,this.x*=t,this.y*=t),e},e.prototype.SelfNormalize=function(){var t,e=this.Length();return e>=o.epsilon&&(t=1/e,this.x*=t,this.y*=t),this},e.prototype.SelfRotate=function(t){var e=Math.cos(t),i=Math.sin(t),s=this.x;return this.x=e*s-i*this.y,this.y=i*s+e*this.y,this},e.prototype.SelfRotateCosSin=function(t,e){var i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this},e.prototype.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},e.prototype.SelfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},e.prototype.SelfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},e.prototype.SelfMinV=function(t){return this.x=s(this.x,t.x),this.y=s(this.y,t.y),this},e.prototype.SelfMaxV=function(t){return this.x=n(this.x,t.x),this.y=n(this.y,t.y),this},e.prototype.SelfAbs=function(){return this.x=o.Abs(this.x),this.y=o.Abs(this.y),this},e.prototype.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},e.prototype.SelfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},e.MakeArray=function(t){return o.MakeArray(t,function(t){return new e})},e.AbsV=function(t,e){return e.x=o.Abs(t.x),e.y=o.Abs(t.y),e},e.MinV=function(t,e,i){return i.x=s(t.x,e.x),i.y=s(t.y,e.y),i},e.MaxV=function(t,e,i){return i.x=n(t.x,e.x),i.y=n(t.y,e.y),i},e.ClampV=function(t,e,i,s){return s.x=r(t.x,e.x,i.x),s.y=r(t.y,e.y,i.y),s},e.RotateV=function(t,e,i){var s=t.x,o=t.y,n=Math.cos(e),r=Math.sin(e);return i.x=n*s-r*o,i.y=r*s+n*o,i},e.DotVV=function(t,e){return t.x*e.x+t.y*e.y},e.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},e.CrossVS=function(t,e,i){var s=t.x;return i.x=e*t.y,i.y=-e*s,i},e.CrossVOne=function(t,e){var i=t.x;return e.x=t.y,e.y=-i,e},e.CrossSV=function(t,e,i){var s=e.x;return i.x=-t*e.y,i.y=t*s,i},e.CrossOneV=function(t,e){var i=t.x;return e.x=-t.y,e.y=i,e},e.AddVV=function(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i},e.SubVV=function(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i},e.MulSV=function(t,e,i){return i.x=e.x*t,i.y=e.y*t,i},e.MulVS=function(t,e,i){return i.x=t.x*e,i.y=t.y*e,i},e.AddVMulSV=function(t,e,i,s){return s.x=t.x+e*i.x,s.y=t.y+e*i.y,s},e.SubVMulSV=function(t,e,i,s){return s.x=t.x-e*i.x,s.y=t.y-e*i.y,s},e.AddVCrossSV=function(t,e,i,s){var o=i.x;return s.x=t.x-e*i.y,s.y=t.y+e*o,s},e.MidVV=function(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i},e.ExtVV=function(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i},e.IsEqualToV=function(t,e){return t.x===e.x&&t.y===e.y},e.DistanceVV=function(t,e){var i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)},e.DistanceSquaredVV=function(t,e){var i=t.x-e.x,s=t.y-e.y;return i*i+s*s},e.NegV=function(t,e){return e.x=-t.x,e.y=-t.y,e},e.ZERO=new e(0,0),e.UNITX=new e(1,0),e.UNITY=new e(0,1),e.s_t0=new e,e.s_t1=new e,e.s_t2=new e,e.s_t3=new e,e);function e(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}o.Vec2=a,o.Vec2_zero=new a(0,0);var t=(Object.defineProperty(i.prototype,"x",{get:function(){return this.data[0]},set:function(t){this.data[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"y",{get:function(){return this.data[1]},set:function(t){this.data[1]=t},enumerable:!0,configurable:!0}),i.prototype.Clone=function(){return new i(new Float32Array(this.data))},i.prototype.SetZero=function(){return this.x=0,this.y=0,this},i.prototype.Set=function(t,e){return this.x=t,this.y=e,this},i.prototype.Copy=function(t){return t instanceof i?this.data.set(t.data):(this.x=t.x,this.y=t.y),this},i.prototype.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},i.prototype.SelfAddXY=function(t,e){return this.x+=t,this.y+=e,this},i.prototype.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this},i.prototype.SelfSubXY=function(t,e){return this.x-=t,this.y-=e,this},i.prototype.SelfMul=function(t){return this.x*=t,this.y*=t,this},i.prototype.SelfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},i.prototype.SelfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},i.prototype.Dot=function(t){return this.x*t.x+this.y*t.y},i.prototype.Cross=function(t){return this.x*t.y-this.y*t.x},i.prototype.Length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},i.prototype.LengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},i.prototype.Normalize=function(){var t,e=this.Length();return e>=o.epsilon&&(t=1/e,this.x*=t,this.y*=t),e},i.prototype.SelfNormalize=function(){var t,e=this.Length();return e>=o.epsilon&&(t=1/e,this.x*=t,this.y*=t),this},i.prototype.SelfRotate=function(t){var e=Math.cos(t),i=Math.sin(t),s=this.x;return this.x=e*s-i*this.y,this.y=i*s+e*this.y,this},i.prototype.SelfRotateCosSin=function(t,e){var i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this},i.prototype.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},i.prototype.SelfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},i.prototype.SelfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},i.prototype.SelfMinV=function(t){return this.x=s(this.x,t.x),this.y=s(this.y,t.y),this},i.prototype.SelfMaxV=function(t){return this.x=n(this.x,t.x),this.y=n(this.y,t.y),this},i.prototype.SelfAbs=function(){return this.x=o.Abs(this.x),this.y=o.Abs(this.y),this},i.prototype.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},i.prototype.SelfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},i);function i(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t[0]instanceof Float32Array){if(2!==t[0].length)throw new Error;this.data=t[0]}else{var i="number"==typeof t[0]?t[0]:0,s="number"==typeof t[1]?t[1]:0;this.data=new Float32Array([i,s])}}o.TypedVec2=t;var l=(Object.defineProperty(c.prototype,"x",{get:function(){return this.data[0]},set:function(t){this.data[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"y",{get:function(){return this.data[1]},set:function(t){this.data[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"z",{get:function(){return this.data[2]},set:function(t){this.data[2]=t},enumerable:!0,configurable:!0}),c.prototype.Clone=function(){return new c(this.x,this.y,this.z)},c.prototype.SetZero=function(){return this.x=0,this.y=0,this.z=0,this},c.prototype.SetXYZ=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},c.prototype.Copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},c.prototype.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},c.prototype.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},c.prototype.SelfAddXYZ=function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},c.prototype.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},c.prototype.SelfSubXYZ=function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},c.prototype.SelfMul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},c.DotV3V3=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},c.CrossV3V3=function(t,e,i){var s=t.x,o=t.y,n=t.z,r=e.x,a=e.y,l=e.z;return i.x=o*l-n*a,i.y=n*r-s*l,i.z=s*a-o*r,i},c.ZERO=new c(0,0,0),c.s_t0=new c,c);function c(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t[0]instanceof Float32Array){if(3!==t[0].length)throw new Error;this.data=t[0]}else{var i="number"==typeof t[0]?t[0]:0,s="number"==typeof t[1]?t[1]:0,o="number"==typeof t[2]?t[2]:0;this.data=new Float32Array([i,s,o])}}o.Vec3=l;var h=(u.prototype.Clone=function(){return(new u).Copy(this)},u.FromVV=function(t,e){return(new u).SetVV(t,e)},u.FromSSSS=function(t,e,i,s){return(new u).SetSSSS(t,e,i,s)},u.FromAngle=function(t){return(new u).SetAngle(t)},u.prototype.SetSSSS=function(t,e,i,s){return this.ex.Set(t,i),this.ey.Set(e,s),this},u.prototype.SetVV=function(t,e){return this.ex.Copy(t),this.ey.Copy(e),this},u.prototype.SetAngle=function(t){var e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this},u.prototype.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this},u.prototype.SetIdentity=function(){return this.ex.Set(1,0),this.ey.Set(0,1),this},u.prototype.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this},u.prototype.GetAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},u.prototype.GetInverse=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;return 0!==n&&(n=1/n),t.ex.x=n*o,t.ey.x=-n*i,t.ex.y=-n*s,t.ey.y=n*e,t},u.prototype.Solve=function(t,e,i){var s=this.ex.x,o=this.ey.x,n=this.ex.y,r=this.ey.y,a=s*r-o*n;return 0!==a&&(a=1/a),i.x=a*(r*t-o*e),i.y=a*(s*e-n*t),i},u.prototype.SelfAbs=function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this},u.prototype.SelfInv=function(){return this.GetInverse(this),this},u.prototype.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this},u.prototype.SelfSubM=function(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this},u.AbsM=function(t,e){var i=t.ex,s=t.ey;return e.ex.x=o.Abs(i.x),e.ex.y=o.Abs(i.y),e.ey.x=o.Abs(s.x),e.ey.y=o.Abs(s.y),e},u.MulMV=function(t,e,i){var s=t.ex,o=t.ey,n=e.x,r=e.y;return i.x=s.x*n+o.x*r,i.y=s.y*n+o.y*r,i},u.MulTMV=function(t,e,i){var s=t.ex,o=t.ey,n=e.x,r=e.y;return i.x=s.x*n+s.y*r,i.y=o.x*n+o.y*r,i},u.AddMM=function(t,e,i){var s=t.ex,o=t.ey,n=e.ex,r=e.ey;return i.ex.x=s.x+n.x,i.ex.y=s.y+n.y,i.ey.x=o.x+r.x,i.ey.y=o.y+r.y,i},u.MulMM=function(t,e,i){var s=t.ex.x,o=t.ex.y,n=t.ey.x,r=t.ey.y,a=e.ex.x,l=e.ex.y,c=e.ey.x,h=e.ey.y;return i.ex.x=s*a+n*l,i.ex.y=o*a+r*l,i.ey.x=s*c+n*h,i.ey.y=o*c+r*h,i},u.MulTMM=function(t,e,i){var s=t.ex.x,o=t.ex.y,n=t.ey.x,r=t.ey.y,a=e.ex.x,l=e.ex.y,c=e.ey.x,h=e.ey.y;return i.ex.x=s*a+o*l,i.ex.y=n*a+r*l,i.ey.x=s*c+o*h,i.ey.y=n*c+r*h,i},u.IDENTITY=new u,u);function u(){this.ex=new a(1,0),this.ey=new a(0,1)}o.Mat22=h;var p=(f.prototype.Clone=function(){return(new f).Copy(this)},f.prototype.SetVVV=function(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this},f.prototype.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this},f.prototype.SetIdentity=function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this},f.prototype.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this},f.prototype.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this},f.prototype.Solve33=function(t,e,i,s){var o=this.ex.x,n=this.ex.y,r=this.ex.z,a=this.ey.x,l=this.ey.y,c=this.ey.z,h=this.ez.x,u=this.ez.y,p=this.ez.z,f=o*(l*p-c*u)+n*(c*h-a*p)+r*(a*u-l*h);return 0!==f&&(f=1/f),s.x=f*(t*(l*p-c*u)+e*(c*h-a*p)+i*(a*u-l*h)),s.y=f*(o*(e*p-i*u)+n*(i*h-t*p)+r*(t*u-e*h)),s.z=f*(o*(l*i-c*e)+n*(c*t-a*i)+r*(a*e-l*t)),s},f.prototype.Solve22=function(t,e,i){var s=this.ex.x,o=this.ey.x,n=this.ex.y,r=this.ey.y,a=s*r-o*n;return 0!==a&&(a=1/a),i.x=a*(r*t-o*e),i.y=a*(s*e-n*t),i},f.prototype.GetInverse22=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;0!==n&&(n=1/n),t.ex.x=n*o,t.ey.x=-n*i,t.ex.z=0,t.ex.y=-n*s,t.ey.y=n*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},f.prototype.GetSymInverse33=function(t){var e=l.DotV3V3(this.ex,l.CrossV3V3(this.ey,this.ez,l.s_t0));0!==e&&(e=1/e);var i=this.ex.x,s=this.ey.x,o=this.ez.x,n=this.ey.y,r=this.ez.y,a=this.ez.z;t.ex.x=e*(n*a-r*r),t.ex.y=e*(o*r-s*a),t.ex.z=e*(s*r-o*n),t.ey.x=t.ex.y,t.ey.y=e*(i*a-o*o),t.ey.z=e*(o*s-i*r),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*n-s*s)},f.MulM33V3=function(t,e,i){var s=e.x,o=e.y,n=e.z;return i.x=t.ex.x*s+t.ey.x*o+t.ez.x*n,i.y=t.ex.y*s+t.ey.y*o+t.ez.y*n,i.z=t.ex.z*s+t.ey.z*o+t.ez.z*n,i},f.MulM33XYZ=function(t,e,i,s,o){return o.x=t.ex.x*e+t.ey.x*i+t.ez.x*s,o.y=t.ex.y*e+t.ey.y*i+t.ez.y*s,o.z=t.ex.z*e+t.ey.z*i+t.ez.z*s,o},f.MulM33V2=function(t,e,i){var s=e.x,o=e.y;return i.x=t.ex.x*s+t.ey.x*o,i.y=t.ex.y*s+t.ey.y*o,i},f.MulM33XY=function(t,e,i,s){return s.x=t.ex.x*e+t.ey.x*i,s.y=t.ex.y*e+t.ey.y*i,s},f.IDENTITY=new f,f);function f(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new l(this.data.subarray(0,3)),this.ey=new l(this.data.subarray(3,6)),this.ez=new l(this.data.subarray(6,9))}o.Mat33=p;var d=(y.prototype.Clone=function(){return(new y).Copy(this)},y.prototype.Copy=function(t){return this.s=t.s,this.c=t.c,this},y.prototype.SetAngle=function(t){return this.s=Math.sin(t),this.c=Math.cos(t),this},y.prototype.SetIdentity=function(){return this.s=0,this.c=1,this},y.prototype.GetAngle=function(){return Math.atan2(this.s,this.c)},y.prototype.GetXAxis=function(t){return t.x=this.c,t.y=this.s,t},y.prototype.GetYAxis=function(t){return t.x=-this.s,t.y=this.c,t},y.MulRR=function(t,e,i){var s=t.c,o=t.s,n=e.c,r=e.s;return i.s=o*n+s*r,i.c=s*n-o*r,i},y.MulTRR=function(t,e,i){var s=t.c,o=t.s,n=e.c,r=e.s;return i.s=s*r-o*n,i.c=s*n+o*r,i},y.MulRV=function(t,e,i){var s=t.c,o=t.s,n=e.x,r=e.y;return i.x=s*n-o*r,i.y=o*n+s*r,i},y.MulTRV=function(t,e,i){var s=t.c,o=t.s,n=e.x,r=e.y;return i.x=s*n+o*r,i.y=-o*n+s*r,i},y.IDENTITY=new y,y);function y(t){void 0===t&&(t=0),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}o.Rot=d;var V=(v.prototype.Clone=function(){return(new v).Copy(this)},v.prototype.Copy=function(t){return this.p.Copy(t.p),this.q.Copy(t.q),this},v.prototype.SetIdentity=function(){return this.p.SetZero(),this.q.SetIdentity(),this},v.prototype.SetPositionRotation=function(t,e){return this.p.Copy(t),this.q.Copy(e),this},v.prototype.SetPositionAngle=function(t,e){return this.p.Copy(t),this.q.SetAngle(e),this},v.prototype.SetPosition=function(t){return this.p.Copy(t),this},v.prototype.SetPositionXY=function(t,e){return this.p.Set(t,e),this},v.prototype.SetRotation=function(t){return this.q.Copy(t),this},v.prototype.SetRotationAngle=function(t){return this.q.SetAngle(t),this},v.prototype.GetPosition=function(){return this.p},v.prototype.GetRotation=function(){return this.q},v.prototype.GetRotationAngle=function(){return this.q.GetAngle()},v.prototype.GetAngle=function(){return this.q.GetAngle()},v.MulXV=function(t,e,i){var s=t.q.c,o=t.q.s,n=e.x,r=e.y;return i.x=s*n-o*r+t.p.x,i.y=o*n+s*r+t.p.y,i},v.MulTXV=function(t,e,i){var s=t.q.c,o=t.q.s,n=e.x-t.p.x,r=e.y-t.p.y;return i.x=s*n+o*r,i.y=-o*n+s*r,i},v.MulXX=function(t,e,i){return d.MulRR(t.q,e.q,i.q),a.AddVV(d.MulRV(t.q,e.p,i.p),t.p,i.p),i},v.MulTXX=function(t,e,i){return d.MulTRR(t.q,e.q,i.q),d.MulTRV(t.q,a.SubVV(e.p,t.p,i.p),i.p),i},v.IDENTITY=new v,v);function v(){this.p=new a,this.q=new d}o.Transform=V;var x=(S.prototype.Clone=function(){return(new S).Copy(this)},S.prototype.Copy=function(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this},S.prototype.GetTransform=function(t,e){t.p.x=(1-e)*this.c0.x+e*this.c.x,t.p.y=(1-e)*this.c0.y+e*this.c.y;var i=(1-e)*this.a0+e*this.a;return t.q.SetAngle(i),t.p.SelfSub(d.MulRV(t.q,this.localCenter,a.s_t0)),t},S.prototype.Advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t},S.prototype.Normalize=function(){var t=o.two_pi*Math.floor(this.a0/o.two_pi);this.a0-=t,this.a-=t},S);function S(){this.localCenter=new a,this.c0=new a,this.c=new a,this.a0=0,this.a=0,this.alpha0=0}o.Sweep=x}(b2=b2||{}),function(g){var t=(e.prototype.Copy=function(t){return t.vertices===t.buffer?(this.vertices=this.buffer,this.buffer[0].Copy(t.buffer[0]),this.buffer[1].Copy(t.buffer[1])):this.vertices=t.vertices,this.count=t.count,this.radius=t.radius,this},e.prototype.Reset=function(){return this.vertices=this.buffer,this.count=0,this.radius=0,this},e.prototype.SetShape=function(t,e){t.SetupDistanceProxy(this,e)},e.prototype.SetVerticesRadius=function(t,e,i){this.vertices=t,this.count=e,this.radius=i},e.prototype.GetSupport=function(t){for(var e=0,i=g.Vec2.DotVV(this.vertices[0],t),s=1;s<this.count;++s){var o=g.Vec2.DotVV(this.vertices[s],t);i<o&&(e=s,i=o)}return e},e.prototype.GetSupportVertex=function(t){for(var e=0,i=g.Vec2.DotVV(this.vertices[0],t),s=1;s<this.count;++s){var o=g.Vec2.DotVV(this.vertices[s],t);i<o&&(e=s,i=o)}return this.vertices[e]},e.prototype.GetVertexCount=function(){return this.count},e.prototype.GetVertex=function(t){return this.vertices[t]},e);function e(){this.buffer=g.Vec2.MakeArray(2),this.vertices=this.buffer,this.count=0,this.radius=0}g.DistanceProxy=t;var i=(s.prototype.Reset=function(){return this.metric=0,this.count=0,this},s);function s(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}g.SimplexCache=i;var o=(n.prototype.Reset=function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this},n);function n(){this.proxyA=new t,this.proxyB=new t,this.transformA=new g.Transform,this.transformB=new g.Transform,this.useRadii=!1}g.DistanceInput=o;var r=(a.prototype.Reset=function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this},a);function a(){this.pointA=new g.Vec2,this.pointB=new g.Vec2,this.distance=0,this.iterations=0}g.DistanceOutput=r;function l(){this.proxyA=new t,this.proxyB=new t,this.transformA=new g.Transform,this.transformB=new g.Transform,this.translationB=new g.Vec2}g.ShapeCastInput=l;function c(){this.point=new g.Vec2,this.normal=new g.Vec2,this.lambda=0,this.iterations=0}g.ShapeCastOutput=c,g.gjkCalls=0,g.gjkIters=0,g.gjkMaxIters=0,g.gjk_reset=function(){g.gjkCalls=0,g.gjkIters=0,g.gjkMaxIters=0};var h=(u.prototype.Copy=function(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this},u);function u(){this.wA=new g.Vec2,this.wB=new g.Vec2,this.w=new g.Vec2,this.a=0,this.indexA=0,this.indexB=0}g.SimplexVertex=h;var p=(m.prototype.ReadCache=function(t,e,i,s,o){this.count=t.count;for(var n,r,a,l=this.vertices,c=0;c<this.count;++c){(a=l[c]).indexA=t.indexA[c],a.indexB=t.indexB[c];var h=e.GetVertex(a.indexA),u=s.GetVertex(a.indexB);g.Transform.MulXV(i,h,a.wA),g.Transform.MulXV(o,u,a.wB),g.Vec2.SubVV(a.wB,a.wA,a.w),a.a=0}1<this.count&&(n=t.metric,((r=this.GetMetric())<.5*n||2*n<r||r<g.epsilon)&&(this.count=0)),0===this.count&&((a=l[0]).indexA=0,a.indexB=0,h=e.GetVertex(0),u=s.GetVertex(0),g.Transform.MulXV(i,h,a.wA),g.Transform.MulXV(o,u,a.wB),g.Vec2.SubVV(a.wB,a.wA,a.w),a.a=1,this.count=1)},m.prototype.WriteCache=function(t){t.metric=this.GetMetric(),t.count=this.count;for(var e=this.vertices,i=0;i<this.count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB},m.prototype.GetSearchDirection=function(t){switch(this.count){case 1:return g.Vec2.NegV(this.v1.w,t);case 2:var e=g.Vec2.SubVV(this.v2.w,this.v1.w,t);return 0<g.Vec2.CrossVV(e,g.Vec2.NegV(this.v1.w,g.Vec2.s_t0))?g.Vec2.CrossOneV(e,t):g.Vec2.CrossVOne(e,t);default:return t.SetZero()}},m.prototype.GetClosestPoint=function(t){switch(this.count){case 0:return t.SetZero();case 1:return t.Copy(this.v1.w);case 2:return t.Set(this.v1.a*this.v1.w.x+this.v2.a*this.v2.w.x,this.v1.a*this.v1.w.y+this.v2.a*this.v2.w.y);case 3:default:return t.SetZero()}},m.prototype.GetWitnessPoints=function(t,e){switch(this.count){case 0:break;case 1:t.Copy(this.v1.wA),e.Copy(this.v1.wB);break;case 2:t.x=this.v1.a*this.v1.wA.x+this.v2.a*this.v2.wA.x,t.y=this.v1.a*this.v1.wA.y+this.v2.a*this.v2.wA.y,e.x=this.v1.a*this.v1.wB.x+this.v2.a*this.v2.wB.x,e.y=this.v1.a*this.v1.wB.y+this.v2.a*this.v2.wB.y;break;case 3:e.x=t.x=this.v1.a*this.v1.wA.x+this.v2.a*this.v2.wA.x+this.v3.a*this.v3.wA.x,e.y=t.y=this.v1.a*this.v1.wA.y+this.v2.a*this.v2.wA.y+this.v3.a*this.v3.wA.y}},m.prototype.GetMetric=function(){switch(this.count){case 0:case 1:return 0;case 2:return g.Vec2.DistanceVV(this.v1.w,this.v2.w);case 3:return g.Vec2.CrossVV(g.Vec2.SubVV(this.v2.w,this.v1.w,g.Vec2.s_t0),g.Vec2.SubVV(this.v3.w,this.v1.w,g.Vec2.s_t1));default:return 0}},m.prototype.Solve2=function(){var t=this.v1.w,e=this.v2.w,i=g.Vec2.SubVV(e,t,m.s_e12),s=-g.Vec2.DotVV(t,i);if(s<=0)return this.v1.a=1,void(this.count=1);var o=g.Vec2.DotVV(e,i);if(o<=0)return this.v2.a=1,this.count=1,void this.v1.Copy(this.v2);var n=1/(o+s);this.v1.a=o*n,this.v2.a=s*n,this.count=2},m.prototype.Solve3=function(){var t=this.v1.w,e=this.v2.w,i=this.v3.w,s=g.Vec2.SubVV(e,t,m.s_e12),o=g.Vec2.DotVV(t,s),n=g.Vec2.DotVV(e,s),r=-o,a=g.Vec2.SubVV(i,t,m.s_e13),l=g.Vec2.DotVV(t,a),c=g.Vec2.DotVV(i,a),h=-l,u=g.Vec2.SubVV(i,e,m.s_e23),p=g.Vec2.DotVV(e,u),f=g.Vec2.DotVV(i,u),d=-p,y=g.Vec2.CrossVV(s,a),V=y*g.Vec2.CrossVV(e,i),v=y*g.Vec2.CrossVV(i,t),x=y*g.Vec2.CrossVV(t,e);if(r<=0&&h<=0)return this.v1.a=1,void(this.count=1);if(0<n&&0<r&&x<=0){var S=1/(n+r);return this.v1.a=n*S,this.v2.a=r*S,void(this.count=2)}if(0<c&&0<h&&v<=0){var B=1/(c+h);return this.v1.a=c*B,this.v3.a=h*B,this.count=2,void this.v2.Copy(this.v3)}if(n<=0&&d<=0)return this.v2.a=1,this.count=1,void this.v1.Copy(this.v2);if(c<=0&&f<=0)return this.v3.a=1,this.count=1,void this.v1.Copy(this.v3);if(0<f&&0<d&&V<=0){var A=1/(f+d);return this.v2.a=f*A,this.v3.a=d*A,this.count=2,void this.v1.Copy(this.v3)}var C=1/(V+v+x);this.v1.a=V*C,this.v2.a=v*C,this.v3.a=x*C,this.count=3},m.s_e12=new g.Vec2,m.s_e13=new g.Vec2,m.s_e23=new g.Vec2,m);function m(){this.v1=new h,this.v2=new h,this.v3=new h,this.vertices=[],this.count=0,this.vertices[0]=this.v1,this.vertices[1]=this.v2,this.vertices[2]=this.v3}var A=new(g.Simplex=p),C=[0,0,0],w=[0,0,0],_=new g.Vec2,b=new g.Vec2,M=new g.Vec2,P=new g.Vec2,I=new g.Vec2;g.Distance=function(t,e,i){++g.gjkCalls;var s=i.proxyA,o=i.proxyB,n=i.transformA,r=i.transformB,a=A;a.ReadCache(e,s,n,o,r);for(var l,c,h,u,p,f=a.vertices,d=C,y=w,V=0;V<20;){l=a.count;for(var v=0;v<l;++v)d[v]=f[v].indexA,y[v]=f[v].indexB;switch(a.count){case 1:break;case 2:a.Solve2();break;case 3:a.Solve3()}if(3===a.count)break;var x=a.GetSearchDirection(b);if(x.LengthSquared()<g.epsilon_sq)break;var S=f[a.count];S.indexA=s.GetSupport(g.Rot.MulTRV(n.q,g.Vec2.NegV(x,g.Vec2.s_t0),P)),g.Transform.MulXV(n,s.GetVertex(S.indexA),S.wA),S.indexB=o.GetSupport(g.Rot.MulTRV(r.q,x,I)),g.Transform.MulXV(r,o.GetVertex(S.indexB),S.wB),g.Vec2.SubVV(S.wB,S.wA,S.w),++V,++g.gjkIters;for(var B=!1,v=0;v<l;++v)if(S.indexA===d[v]&&S.indexB===y[v]){B=!0;break}if(B)break;++a.count}g.gjkMaxIters=g.Max(g.gjkMaxIters,V),a.GetWitnessPoints(t.pointA,t.pointB),t.distance=g.Vec2.DistanceVV(t.pointA,t.pointB),t.iterations=V,a.WriteCache(e),i.useRadii&&(c=s.radius,h=o.radius,t.distance>c+h&&t.distance>g.epsilon?(t.distance-=c+h,(u=g.Vec2.SubVV(t.pointB,t.pointA,M)).Normalize(),t.pointA.SelfMulAdd(c,u),t.pointB.SelfMulSub(h,u)):(p=g.Vec2.MidVV(t.pointA,t.pointB,_),t.pointA.Copy(p),t.pointB.Copy(p),t.distance=0))};var D=new g.Vec2,G=new p,T=new g.Vec2,F=new g.Vec2,R=new g.Vec2,L=new g.Vec2,k=new g.Vec2,q=new g.Vec2;g.ShapeCast=function(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();var i=e.proxyA,s=e.proxyB,o=g.Max(i.radius,g.polygonRadius)+g.Max(s.radius,g.polygonRadius),n=e.transformA,r=e.transformB,a=e.translationB,l=D.Set(0,0),c=0,h=G;h.count=0;for(var u=h.vertices,p=i.GetSupport(g.Rot.MulTRV(n.q,g.Vec2.NegV(a,g.Vec2.s_t1),g.Vec2.s_t0)),f=g.Transform.MulXV(n,i.GetVertex(p),T),d=s.GetSupport(g.Rot.MulTRV(r.q,a,g.Vec2.s_t0)),y=g.Transform.MulXV(r,s.GetVertex(d),F),V=g.Vec2.SubVV(f,y,R),v=g.Max(g.polygonRadius,o-g.polygonRadius),x=.5*g.linearSlop,S=0;S<20&&V.Length()-v>x;){t.iterations+=1,p=i.GetSupport(g.Rot.MulTRV(n.q,g.Vec2.NegV(V,g.Vec2.s_t1),g.Vec2.s_t0)),f=g.Transform.MulXV(n,i.GetVertex(p),T),d=s.GetSupport(g.Rot.MulTRV(r.q,V,g.Vec2.s_t0)),y=g.Transform.MulXV(r,s.GetVertex(d),F);var B=g.Vec2.SubVV(f,y,L);V.Normalize();var A=g.Vec2.DotVV(V,B),C=g.Vec2.DotVV(V,a);if(c*C<A-v){if(C<=0)return!1;if(1<(c=(A-v)/C))return!1;l.Copy(V).SelfNeg(),h.count=0}var m=u[h.count];switch(m.indexA=d,m.wA.Copy(y).SelfMulAdd(c,a),m.indexB=p,m.wB.Copy(f),m.w.Copy(m.wB).SelfSub(m.wA),m.a=1,h.count+=1,h.count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.count)return!1;h.GetClosestPoint(V),++S}return 0!==S&&(h.GetWitnessPoints(k,q),0<V.LengthSquared()&&(l.Copy(V).SelfNeg(),l.Normalize()),t.normal.Copy(l),t.lambda=c,t.iterations=S,!0)}}(b2=b2||{}),function(t){var e=(i.prototype.Reset=function(){return this.start=Date.now(),this},i.prototype.GetMilliseconds=function(){return Date.now()-this.start},i);function i(){this.start=Date.now()}t.Timer=e;var s=(o.prototype.GetCount=function(){return this.count},o.prototype.GetMinCount=function(){return this.min_count},o.prototype.GetMaxCount=function(){return this.max_count},o.prototype.ResetCount=function(){var t=this.count;return this.count=0,t},o.prototype.ResetMinCount=function(){this.min_count=0},o.prototype.ResetMaxCount=function(){this.max_count=0},o.prototype.Increment=function(){this.count++,this.max_count<this.count&&(this.max_count=this.count)},o.prototype.Decrement=function(){this.count--,this.min_count>this.count&&(this.min_count=this.count)},o);function o(){this.count=0,this.min_count=0,this.max_count=0}t.Counter=s}(b2=b2||{}),function(V){var f,t;(t=f=V.ContactFeatureType||(V.ContactFeatureType={}))[t.e_vertex=0]="e_vertex",t[t.e_face=1]="e_face";var e=(Object.defineProperty(i.prototype,"key",{get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"indexA",{get:function(){return this._indexA},set:function(t){this._indexA=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"indexB",{get:function(){return this._indexB},set:function(t){this._indexB=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"typeA",{get:function(){return this._typeA},set:function(t){this._typeA=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"typeB",{get:function(){return this._typeB},set:function(t){this._typeB=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),i);function i(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}V.ContactFeature=e;var s=(o.prototype.Copy=function(t){return this.key=t.key,this},o.prototype.Clone=function(){return(new o).Copy(this)},Object.defineProperty(o.prototype,"key",{get:function(){return this.cf.key},set:function(t){this.cf.key=t},enumerable:!0,configurable:!0}),o);function o(){this.cf=new e}V.ContactID=s;var d,n,r=(a.MakeArray=function(t){return V.MakeArray(t,function(t){return new a})},a.prototype.Reset=function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},a.prototype.Copy=function(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this},a);function a(){this.localPoint=new V.Vec2,this.normalImpulse=0,this.tangentImpulse=0,this.id=new s}V.ManifoldPoint=r,(n=d=V.ManifoldType||(V.ManifoldType={}))[n.e_unknown=-1]="e_unknown",n[n.e_circles=0]="e_circles",n[n.e_faceA=1]="e_faceA",n[n.e_faceB=2]="e_faceB";var l=(c.prototype.Reset=function(){for(var t=0;t<V.maxManifoldPoints;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=d.e_unknown,this.pointCount=0},c.prototype.Copy=function(t){this.pointCount=t.pointCount;for(var e=0;e<V.maxManifoldPoints;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this},c.prototype.Clone=function(){return(new c).Copy(this)},c);function c(){this.points=r.MakeArray(V.maxManifoldPoints),this.localNormal=new V.Vec2,this.localPoint=new V.Vec2,this.type=d.e_unknown,this.pointCount=0}V.Manifold=l;var h,u,p=(y.prototype.Initialize=function(t,e,i,s,o){if(0!==t.pointCount)switch(t.type){case d.e_circles:this.normal.Set(1,0);var n=V.Transform.MulXV(e,t.localPoint,y.Initialize_s_pointA),r=V.Transform.MulXV(s,t.points[0].localPoint,y.Initialize_s_pointB);V.Vec2.DistanceSquaredVV(n,r)>V.epsilon_sq&&V.Vec2.SubVV(r,n,this.normal).SelfNormalize();var a=V.Vec2.AddVMulSV(n,i,this.normal,y.Initialize_s_cA),l=V.Vec2.SubVMulSV(r,o,this.normal,y.Initialize_s_cB);V.Vec2.MidVV(a,l,this.points[0]),this.separations[0]=V.Vec2.DotVV(V.Vec2.SubVV(l,a,V.Vec2.s_t0),this.normal);break;case d.e_faceA:V.Rot.MulRV(e.q,t.localNormal,this.normal);for(var c=V.Transform.MulXV(e,t.localPoint,y.Initialize_s_planePoint),h=0;h<t.pointCount;++h){var u=V.Transform.MulXV(s,t.points[h].localPoint,y.Initialize_s_clipPoint),p=i-V.Vec2.DotVV(V.Vec2.SubVV(u,c,V.Vec2.s_t0),this.normal),a=V.Vec2.AddVMulSV(u,p,this.normal,y.Initialize_s_cA),l=V.Vec2.SubVMulSV(u,o,this.normal,y.Initialize_s_cB);V.Vec2.MidVV(a,l,this.points[h]),this.separations[h]=V.Vec2.DotVV(V.Vec2.SubVV(l,a,V.Vec2.s_t0),this.normal)}break;case d.e_faceB:V.Rot.MulRV(s.q,t.localNormal,this.normal);for(c=V.Transform.MulXV(s,t.localPoint,y.Initialize_s_planePoint),h=0;h<t.pointCount;++h){u=V.Transform.MulXV(e,t.points[h].localPoint,y.Initialize_s_clipPoint),p=o-V.Vec2.DotVV(V.Vec2.SubVV(u,c,V.Vec2.s_t0),this.normal),l=V.Vec2.AddVMulSV(u,p,this.normal,y.Initialize_s_cB),a=V.Vec2.SubVMulSV(u,i,this.normal,y.Initialize_s_cA);V.Vec2.MidVV(a,l,this.points[h]),this.separations[h]=V.Vec2.DotVV(V.Vec2.SubVV(a,l,V.Vec2.s_t0),this.normal)}this.normal.SelfNeg()}},y.Initialize_s_pointA=new V.Vec2,y.Initialize_s_pointB=new V.Vec2,y.Initialize_s_cA=new V.Vec2,y.Initialize_s_cB=new V.Vec2,y.Initialize_s_planePoint=new V.Vec2,y.Initialize_s_clipPoint=new V.Vec2,y);function y(){this.normal=new V.Vec2,this.points=V.Vec2.MakeArray(V.maxManifoldPoints),this.separations=V.MakeNumberArray(V.maxManifoldPoints)}V.WorldManifold=p,(u=h=V.PointState||(V.PointState={}))[u.nullState=0]="nullState",u[u.addState=1]="addState",u[u.persistState=2]="persistState",u[u.removeState=3]="removeState",V.GetPointStates=function(t,e,i,s){for(var o=0;o<i.pointCount;++o){var n=i.points[o].id.key;t[o]=h.removeState;for(var r=0,a=s.pointCount;r<a;++r)if(s.points[r].id.key===n){t[o]=h.persistState;break}}for(;o<V.maxManifoldPoints;++o)t[o]=h.nullState;for(o=0;o<s.pointCount;++o){n=s.points[o].id.key;e[o]=h.addState;for(r=0,a=i.pointCount;r<a;++r)if(i.points[r].id.key===n){e[o]=h.persistState;break}}for(;o<V.maxManifoldPoints;++o)e[o]=h.nullState};var v=(x.MakeArray=function(t){return V.MakeArray(t,function(t){return new x})},x.prototype.Copy=function(t){return this.v.Copy(t.v),this.id.Copy(t.id),this},x);function x(){this.v=new V.Vec2,this.id=new s}V.ClipVertex=v;var S=(B.prototype.Copy=function(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this},B);function B(){this.p1=new V.Vec2,this.p2=new V.Vec2,this.maxFraction=1}V.RayCastInput=S;var A=(C.prototype.Copy=function(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this},C);function C(){this.normal=new V.Vec2,this.fraction=0}V.RayCastOutput=A;var m=(g.prototype.Copy=function(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this},g.prototype.IsValid=function(){return!!this.lowerBound.IsValid()&&(!!this.upperBound.IsValid()&&(!(this.upperBound.x<this.lowerBound.x)&&!(this.upperBound.y<this.lowerBound.y)))},g.prototype.GetCenter=function(){return V.Vec2.MidVV(this.lowerBound,this.upperBound,this.cache_center)},g.prototype.GetExtents=function(){return V.Vec2.ExtVV(this.lowerBound,this.upperBound,this.cache_extent)},g.prototype.GetPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},g.prototype.Combine1=function(t){return this.lowerBound.x=V.Min(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=V.Min(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=V.Max(this.upperBound.x,t.upperBound.x),this.upperBound.y=V.Max(this.upperBound.y,t.upperBound.y),this},g.prototype.Combine2=function(t,e){return this.lowerBound.x=V.Min(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=V.Min(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=V.Max(t.upperBound.x,e.upperBound.x),this.upperBound.y=V.Max(t.upperBound.y,e.upperBound.y),this},g.Combine=function(t,e,i){return i.Combine2(t,e),i},g.prototype.Contains=function(t){return this.lowerBound.x<=t.lowerBound.x&&this.lowerBound.y<=t.lowerBound.y&&t.upperBound.x<=this.upperBound.x&&t.upperBound.y<=this.upperBound.y},g.prototype.RayCast=function(t,e){var i=-V.maxFloat,s=V.maxFloat,o=e.p1.x,n=e.p1.y,r=e.p2.x-e.p1.x,a=e.p2.y-e.p1.y,l=V.Abs(r),c=V.Abs(a),h=t.normal;if(l<V.epsilon){if(o<this.lowerBound.x||this.upperBound.x<o)return!1}else{var u=1/r,p=(this.lowerBound.x-o)*u,f=-1;if((d=(this.upperBound.x-o)*u)<p&&(y=p,p=d,d=y,f=1),i<p&&(h.x=f,h.y=0,i=p),(s=V.Min(s,d))<i)return!1}if(c<V.epsilon){if(n<this.lowerBound.y||this.upperBound.y<n)return!1}else{var d,y,u=1/a,p=(this.lowerBound.y-n)*u,f=-1;if((d=(this.upperBound.y-n)*u)<p&&(y=p,p=d,d=y,f=1),i<p&&(h.x=0,h.y=f,i=p),(s=V.Min(s,d))<i)return!1}return!(i<0||e.maxFraction<i)&&(t.fraction=i,!0)},g.prototype.TestContain=function(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x)&&!(t.y<this.lowerBound.y||this.upperBound.y<t.y)},g.prototype.TestOverlap=function(t){return!(this.upperBound.x<t.lowerBound.x)&&(!(this.upperBound.y<t.lowerBound.y)&&(!(t.upperBound.x<this.lowerBound.x)&&!(t.upperBound.y<this.lowerBound.y)))},g);function g(){this.lowerBound=new V.Vec2,this.upperBound=new V.Vec2,this.cache_center=new V.Vec2,this.cache_extent=new V.Vec2}V.AABB=m,V.TestOverlapAABB=function(t,e){return!(t.upperBound.x<e.lowerBound.x)&&(!(t.upperBound.y<e.lowerBound.y)&&(!(e.upperBound.x<t.lowerBound.x)&&!(e.upperBound.y<t.lowerBound.y)))},V.ClipSegmentToLine=function(t,e,i,s,o){var n,r,a,l=0,c=e[0],h=e[1],u=V.Vec2.DotVV(i,c.v)-s,p=V.Vec2.DotVV(i,h.v)-s;return u<=0&&t[l++].Copy(c),p<=0&&t[l++].Copy(h),u*p<0&&(n=u/(u-p),(r=t[l].v).x=c.v.x+n*(h.v.x-c.v.x),r.y=c.v.y+n*(h.v.y-c.v.y),(a=t[l].id).cf.indexA=o,a.cf.indexB=c.id.cf.indexB,a.cf.typeA=f.e_vertex,a.cf.typeB=f.e_face,++l),l};var w=new V.DistanceInput,_=new V.SimplexCache,b=new V.DistanceOutput;V.TestOverlapShape=function(t,e,i,s,o,n){var r=w.Reset();r.proxyA.SetShape(t,e),r.proxyB.SetShape(i,s),r.transformA.Copy(o),r.transformB.Copy(n),r.useRadii=!0;var a=_.Reset();a.count=0;var l=b.Reset();return V.Distance(l,a,r),l.distance<10*V.epsilon}}(b2=b2||{}),function(t){function e(){this.mass=0,this.center=new t.Vec2(0,0),this.I=0}var i,s;t.MassData=e,(s=i=t.ShapeType||(t.ShapeType={}))[s.e_unknown=-1]="e_unknown",s[s.e_circleShape=0]="e_circleShape",s[s.e_edgeShape=1]="e_edgeShape",s[s.e_polygonShape=2]="e_polygonShape",s[s.e_chainShape=3]="e_chainShape",s[s.e_shapeTypeCount=4]="e_shapeTypeCount";var o=(n.prototype.Copy=function(t){return this.radius=t.radius,this},n.prototype.GetType=function(){return this.type},n);function n(t,e){this.type=i.e_unknown,this.radius=0,this.type=t,this.radius=e}t.Shape=o}(b2=b2||{}),function(T){T.toiTime=0,T.toiMaxTime=0,T.toiCalls=0,T.toiIters=0,T.toiMaxIters=0,T.toiRootIters=0,T.toiMaxRootIters=0,T.toi_reset=function(){T.toiTime=0,T.toiMaxTime=0,T.toiCalls=0,T.toiIters=0,T.toiMaxIters=0,T.toiRootIters=0,T.toiMaxRootIters=0};function t(){this.proxyA=new T.DistanceProxy,this.proxyB=new T.DistanceProxy,this.sweepA=new T.Sweep,this.sweepB=new T.Sweep,this.tMax=0}var F,e,R=new T.Transform,L=new T.Transform,S=new T.Vec2,B=new T.Vec2,A=new T.Vec2,p=new T.Vec2,f=new T.Vec2;T.TOIInput=t,(e=F=T.TOIOutputState||(T.TOIOutputState={}))[e.e_unknown=0]="e_unknown",e[e.e_failed=1]="e_failed",e[e.e_overlapped=2]="e_overlapped",e[e.e_touching=3]="e_touching",e[e.e_separated=4]="e_separated";function i(){this.state=F.e_unknown,this.t=0}var C,s;T.TOIOutput=i,(s=C=T.SeparationFunctionType||(T.SeparationFunctionType={}))[s.e_unknown=-1]="e_unknown",s[s.e_points=0]="e_points",s[s.e_faceA=1]="e_faceA",s[s.e_faceB=2]="e_faceB";var o=(n.prototype.Initialize=function(t,e,i,s,o,n){this.proxyA=e,this.proxyB=s;var r=t.count;this.sweepA.Copy(i),this.sweepB.Copy(o);var a=R,l=L;if(this.sweepA.GetTransform(a,n),this.sweepB.GetTransform(l,n),1===r){this.type=C.e_points;var c=this.proxyA.GetVertex(t.indexA[0]),h=this.proxyB.GetVertex(t.indexB[0]),u=T.Transform.MulXV(a,c,S),p=T.Transform.MulXV(l,h,B);T.Vec2.SubVV(p,u,this.axis);var f=this.axis.Normalize();return this.localPoint.SetZero(),f}if(t.indexA[0]===t.indexA[1]){this.type=C.e_faceB;var d=this.proxyB.GetVertex(t.indexB[0]),y=this.proxyB.GetVertex(t.indexB[1]);T.Vec2.CrossVOne(T.Vec2.SubVV(y,d,T.Vec2.s_t0),this.axis).SelfNormalize();var V=T.Rot.MulRV(l.q,this.axis,A);T.Vec2.MidVV(d,y,this.localPoint);p=T.Transform.MulXV(l,this.localPoint,B),c=this.proxyA.GetVertex(t.indexA[0]),u=T.Transform.MulXV(a,c,S);return(f=T.Vec2.DotVV(T.Vec2.SubVV(u,p,T.Vec2.s_t0),V))<0&&(this.axis.SelfNeg(),f=-f),f}this.type=C.e_faceA;var v=this.proxyA.GetVertex(t.indexA[0]),x=this.proxyA.GetVertex(t.indexA[1]);T.Vec2.CrossVOne(T.Vec2.SubVV(x,v,T.Vec2.s_t0),this.axis).SelfNormalize();V=T.Rot.MulRV(a.q,this.axis,A);T.Vec2.MidVV(v,x,this.localPoint);u=T.Transform.MulXV(a,this.localPoint,S),h=this.proxyB.GetVertex(t.indexB[0]),p=T.Transform.MulXV(l,h,B);return(f=T.Vec2.DotVV(T.Vec2.SubVV(p,u,T.Vec2.s_t0),V))<0&&(this.axis.SelfNeg(),f=-f),f},n.prototype.FindMinSeparation=function(t,e,i){var s=R,o=L;switch(this.sweepA.GetTransform(s,i),this.sweepB.GetTransform(o,i),this.type){case C.e_points:var n=T.Rot.MulTRV(s.q,this.axis,p),r=T.Rot.MulTRV(o.q,T.Vec2.NegV(this.axis,T.Vec2.s_t0),f);t[0]=this.proxyA.GetSupport(n),e[0]=this.proxyB.GetSupport(r);var a=this.proxyA.GetVertex(t[0]),l=this.proxyB.GetVertex(e[0]),c=T.Transform.MulXV(s,a,S),h=T.Transform.MulXV(o,l,B);return T.Vec2.DotVV(T.Vec2.SubVV(h,c,T.Vec2.s_t0),this.axis);case C.e_faceA:var u=T.Rot.MulRV(s.q,this.axis,A),c=T.Transform.MulXV(s,this.localPoint,S),r=T.Rot.MulTRV(o.q,T.Vec2.NegV(u,T.Vec2.s_t0),f);t[0]=-1,e[0]=this.proxyB.GetSupport(r);l=this.proxyB.GetVertex(e[0]),h=T.Transform.MulXV(o,l,B);return T.Vec2.DotVV(T.Vec2.SubVV(h,c,T.Vec2.s_t0),u);case C.e_faceB:u=T.Rot.MulRV(o.q,this.axis,A),h=T.Transform.MulXV(o,this.localPoint,B),n=T.Rot.MulTRV(s.q,T.Vec2.NegV(u,T.Vec2.s_t0),p);e[0]=-1,t[0]=this.proxyA.GetSupport(n);a=this.proxyA.GetVertex(t[0]),c=T.Transform.MulXV(s,a,S);return T.Vec2.DotVV(T.Vec2.SubVV(c,h,T.Vec2.s_t0),u);default:return t[0]=-1,e[0]=-1,0}},n.prototype.Evaluate=function(t,e,i){var s=R,o=L;switch(this.sweepA.GetTransform(s,i),this.sweepB.GetTransform(o,i),this.type){case C.e_points:var n=this.proxyA.GetVertex(t),r=this.proxyB.GetVertex(e),a=T.Transform.MulXV(s,n,S),l=T.Transform.MulXV(o,r,B);return T.Vec2.DotVV(T.Vec2.SubVV(l,a,T.Vec2.s_t0),this.axis);case C.e_faceA:var c=T.Rot.MulRV(s.q,this.axis,A),a=T.Transform.MulXV(s,this.localPoint,S),r=this.proxyB.GetVertex(e),l=T.Transform.MulXV(o,r,B);return T.Vec2.DotVV(T.Vec2.SubVV(l,a,T.Vec2.s_t0),c);case C.e_faceB:c=T.Rot.MulRV(o.q,this.axis,A),l=T.Transform.MulXV(o,this.localPoint,B),n=this.proxyA.GetVertex(t),a=T.Transform.MulXV(s,n,S);return T.Vec2.DotVV(T.Vec2.SubVV(a,l,T.Vec2.s_t0),c);default:return 0}},n);function n(){this.sweepA=new T.Sweep,this.sweepB=new T.Sweep,this.type=C.e_unknown,this.localPoint=new T.Vec2,this.axis=new T.Vec2}T.SeparationFunction=o;var k=new T.Timer,q=new T.SimplexCache,J=new T.DistanceInput,E=new T.DistanceOutput,z=new o,j=[0],N=[0],O=new T.Sweep,X=new T.Sweep;T.TimeOfImpact=function(t,e){var i=k.Reset();++T.toiCalls,t.state=F.e_unknown,t.t=e.tMax;var s=e.proxyA,o=e.proxyB,n=T.Max(T.maxPolygonVertices,T.Max(s.count,o.count)),r=O.Copy(e.sweepA),a=X.Copy(e.sweepB);r.Normalize(),a.Normalize();var l=e.tMax,c=s.radius+o.radius,h=T.Max(T.linearSlop,c-3*T.linearSlop),u=.25*T.linearSlop,p=0,f=0,d=q;d.count=0;var y=J;for(y.proxyA.Copy(e.proxyA),y.proxyB.Copy(e.proxyB),y.useRadii=!1;;){var V=R,v=L;r.GetTransform(V,p),a.GetTransform(v,p),y.transformA.Copy(V),y.transformB.Copy(v);var x=E;if(T.Distance(x,d,y),x.distance<=0){t.state=F.e_overlapped,t.t=0;break}if(x.distance<h+u){t.state=F.e_touching,t.t=p;break}var S=z;S.Initialize(d,s,r,o,a,p);for(var B=!1,A=l,C=0;;){var m=j,g=N,w=S.FindMinSeparation(m,g,A);if(h+u<w){t.state=F.e_separated,t.t=l,B=!0;break}if(h-u<w){p=A;break}var _=S.Evaluate(m[0],g[0],p);if(_<h-u){t.state=F.e_failed,t.t=p,B=!0;break}if(_<=h+u){t.state=F.e_touching,t.t=p,B=!0;break}for(var b=0,M=p,P=A;;){var I=0,I=1&b?M+(h-_)*(P-M)/(w-_):.5*(M+P);++b,++T.toiRootIters;var D=S.Evaluate(m[0],g[0],I);if(T.Abs(D-h)<u){A=I;break}if(h<D?(M=I,_=D):(P=I,w=D),50===b)break}if(T.toiMaxRootIters=T.Max(T.toiMaxRootIters,b),++C===n)break}if(++f,++T.toiIters,B)break;if(20===f){t.state=F.e_failed,t.t=p;break}}T.toiMaxIters=T.Max(T.toiMaxIters,f);var G=i.GetMilliseconds();T.toiMaxTime=T.Max(T.toiMaxTime,G),T.toiTime+=G}}(b2=b2||{}),function(t){var i=(s.prototype.Clone=function(){return(new s).Copy(this)},s.prototype.Copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},s.prototype.IsEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},s.prototype.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},s.prototype.Set=function(t,e,i,s){void 0===s&&(s=this.a),this.SetRGBA(t,e,i,s)},s.prototype.SetByteRGB=function(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this},s.prototype.SetByteRGBA=function(t,e,i,s){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=s/255,this},s.prototype.SetRGB=function(t,e,i){return this.r=t,this.g=e,this.b=i,this},s.prototype.SetRGBA=function(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=s,this},s.prototype.SelfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},s.prototype.Add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},s.prototype.SelfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},s.prototype.Sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},s.prototype.SelfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},s.prototype.Mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},s.prototype.Mix=function(t,e){s.MixColors(this,t,e)},s.MixColors=function(t,e,i){var s=i*(e.r-t.r),o=i*(e.g-t.g),n=i*(e.b-t.b),r=i*(e.a-t.a);t.r+=s,t.g+=o,t.b+=n,t.a+=r,e.r-=s,e.g-=o,e.b-=n,e.a-=r},s.prototype.MakeStyleString=function(t){return void 0===t&&(t=this.a),s.MakeStyleString(this.r,this.g,this.b,t)},s.MakeStyleString=function(t,e,i,s){return void 0===s&&(s=1),t*=255,e*=255,i*=255,s<1?"rgba("+t+","+e+","+i+","+s+")":"rgb("+t+","+e+","+i+")"},s.ZERO=new s(0,0,0,0),s.RED=new s(1,0,0),s.GREEN=new s(0,1,0),s.BLUE=new s(0,0,1),s);function s(t,e,i,s){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===i&&(i=.5),void 0===s&&(s=1),this.r=t,this.g=e,this.b=i,this.a=s}t.Color=i;var e,o=(Object.defineProperty(n.prototype,"r",{get:function(){return this.data[0]},set:function(t){this.data[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"g",{get:function(){return this.data[1]},set:function(t){this.data[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"b",{get:function(){return this.data[2]},set:function(t){this.data[2]=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"a",{get:function(){return this.data[3]},set:function(t){this.data[3]=t},enumerable:!0,configurable:!0}),n.prototype.Clone=function(){return new n(new Float32Array(this.data))},n.prototype.Copy=function(t){return t instanceof n?this.data.set(t.data):(this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a),this},n.prototype.IsEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},n.prototype.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},n.prototype.Set=function(t,e,i,s){void 0===s&&(s=this.a),this.SetRGBA(t,e,i,s)},n.prototype.SetByteRGB=function(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this},n.prototype.SetByteRGBA=function(t,e,i,s){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=s/255,this},n.prototype.SetRGB=function(t,e,i){return this.r=t,this.g=e,this.b=i,this},n.prototype.SetRGBA=function(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=s,this},n.prototype.SelfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},n.prototype.Add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},n.prototype.SelfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},n.prototype.Sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},n.prototype.SelfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},n.prototype.Mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},n.prototype.Mix=function(t,e){i.MixColors(this,t,e)},n.prototype.MakeStyleString=function(t){return void 0===t&&(t=this.a),i.MakeStyleString(this.r,this.g,this.b,t)},n);function n(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t[0]instanceof Float32Array){if(4!==t[0].length)throw new Error;this.data=t[0]}else{var i="number"==typeof t[0]?t[0]:.5,s="number"==typeof t[1]?t[1]:.5,o="number"==typeof t[2]?t[2]:.5,n="number"==typeof t[3]?t[3]:1;this.data=new Float32Array([i,s,o,n])}}t.TypedColor=o,(e=t.DrawFlags||(t.DrawFlags={}))[e.e_none=0]="e_none",e[e.e_shapeBit=1]="e_shapeBit",e[e.e_jointBit=2]="e_jointBit",e[e.e_aabbBit=4]="e_aabbBit",e[e.e_pairBit=8]="e_pairBit",e[e.e_centerOfMassBit=16]="e_centerOfMassBit",e[e.e_particleBit=32]="e_particleBit",e[e.e_controllerBit=64]="e_controllerBit",e[e.e_all=63]="e_all";var r=(a.prototype.SetFlags=function(t){this.drawFlags=t},a.prototype.GetFlags=function(){return this.drawFlags},a.prototype.AppendFlags=function(t){this.drawFlags|=t},a.prototype.ClearFlags=function(t){this.drawFlags&=~t},a.prototype.PushTransform=function(t){},a.prototype.PopTransform=function(t){},a.prototype.DrawPolygon=function(t,e,i){},a.prototype.DrawSolidPolygon=function(t,e,i){},a.prototype.DrawCircle=function(t,e,i){},a.prototype.DrawSolidCircle=function(t,e,i,s){},a.prototype.DrawParticles=function(t,e,i,s){},a.prototype.DrawSegment=function(t,e,i){},a.prototype.DrawTransform=function(t){},a.prototype.DrawPoint=function(t,e,i){},a);function a(){this.drawFlags=0}t.Draw=r}(b2=b2||{}),function(e){var t=(i.prototype.Reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},i);function i(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}e.Profile=t;var s=(o.prototype.Copy=function(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this},o);function o(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}e.TimeStep=s;var n=(r.MakeArray=function(t){return e.MakeArray(t,function(t){return new r})},r);function r(){this.c=new e.Vec2,this.a=0}e.Position=n;var a=(l.MakeArray=function(t){return e.MakeArray(t,function(t){return new l})},l);function l(){this.v=new e.Vec2,this.w=0}e.Velocity=a;function c(){this.step=new s}e.SolverData=c}(b2=b2||{}),function(x){var e,t=(e=x.Shape,__extends(S,e),S.prototype.SetOneSided=function(t,e,i,s){return this.vertex0.Copy(t),this.vertex1.Copy(e),this.vertex2.Copy(i),this.vertex3.Copy(s),this.oneSided=!0,this},S.prototype.SetTwoSided=function(t,e){return this.vertex1.Copy(t),this.vertex2.Copy(e),this.oneSided=!1,this},S.prototype.Clone=function(){return(new S).Copy(this)},S.prototype.Copy=function(t){return e.prototype.Copy.call(this,t),this.vertex1.Copy(t.vertex1),this.vertex2.Copy(t.vertex2),this.vertex0.Copy(t.vertex0),this.vertex3.Copy(t.vertex3),this.oneSided=t.oneSided,this},S.prototype.GetChildCount=function(){return 1},S.prototype.TestPoint=function(t,e){return!1},S.prototype.ComputeDistance=function(t,e,i,s){var o,n=x.Transform.MulXV(t,this.vertex1,S.ComputeDistance_s_v1),r=x.Transform.MulXV(t,this.vertex2,S.ComputeDistance_s_v2),a=x.Vec2.SubVV(e,n,S.ComputeDistance_s_d),l=x.Vec2.SubVV(r,n,S.ComputeDistance_s_s),c=x.Vec2.DotVV(a,l);return 0<c&&((o=x.Vec2.DotVV(l,l))<c?x.Vec2.SubVV(e,r,a):a.SelfMulSub(c/o,l)),i.Copy(a),i.Normalize()},S.prototype.RayCast=function(t,e,i,s){var o=x.Transform.MulTXV(i,e.p1,S.RayCast_s_p1),n=x.Transform.MulTXV(i,e.p2,S.RayCast_s_p2),r=x.Vec2.SubVV(n,o,S.RayCast_s_d),a=this.vertex1,l=this.vertex2,c=x.Vec2.SubVV(l,a,S.RayCast_s_e),h=t.normal.Set(c.y,-c.x).SelfNormalize(),u=x.Vec2.DotVV(h,x.Vec2.SubVV(a,o,x.Vec2.s_t0));if(this.oneSided&&0<u)return!1;var p=x.Vec2.DotVV(h,r);if(0===p)return!1;var f=u/p;if(f<0||e.maxFraction<f)return!1;var d=x.Vec2.AddVMulSV(o,f,r,S.RayCast_s_q),y=x.Vec2.SubVV(l,a,S.RayCast_s_r),V=x.Vec2.DotVV(y,y);if(0===V)return!1;var v=x.Vec2.DotVV(x.Vec2.SubVV(d,a,x.Vec2.s_t0),y)/V;return!(v<0||1<v)&&(t.fraction=f,x.Rot.MulRV(i.q,t.normal,t.normal),0<u&&t.normal.SelfNeg(),!0)},S.prototype.ComputeAABB=function(t,e,i){var s=x.Transform.MulXV(e,this.vertex1,S.ComputeAABB_s_v1),o=x.Transform.MulXV(e,this.vertex2,S.ComputeAABB_s_v2);x.Vec2.MinV(s,o,t.lowerBound),x.Vec2.MaxV(s,o,t.upperBound);var n=this.radius;t.lowerBound.SelfSubXY(n,n),t.upperBound.SelfAddXY(n,n)},S.prototype.ComputeMass=function(t,e){t.mass=0,x.Vec2.MidVV(this.vertex1,this.vertex2,t.center),t.I=0},S.prototype.SetupDistanceProxy=function(t,e){t.vertices=t.buffer,t.vertices[0].Copy(this.vertex1),t.vertices[1].Copy(this.vertex2),t.count=2,t.radius=this.radius},S.prototype.ComputeSubmergedArea=function(t,e,i,s){return s.SetZero(),0},S.prototype.Dump=function(t){t("    const shape: EdgeShape = new EdgeShape();\n"),t("    shape.radius = %.15f;\n",this.radius),t("    shape.vertex0.Set(%.15f, %.15f);\n",this.vertex0.x,this.vertex0.y),t("    shape.vertex1.Set(%.15f, %.15f);\n",this.vertex1.x,this.vertex1.y),t("    shape.vertex2.Set(%.15f, %.15f);\n",this.vertex2.x,this.vertex2.y),t("    shape.vertex3.Set(%.15f, %.15f);\n",this.vertex3.x,this.vertex3.y),t("    shape.oneSided = %s;\n",this.oneSided)},S.ComputeDistance_s_v1=new x.Vec2,S.ComputeDistance_s_v2=new x.Vec2,S.ComputeDistance_s_d=new x.Vec2,S.ComputeDistance_s_s=new x.Vec2,S.RayCast_s_p1=new x.Vec2,S.RayCast_s_p2=new x.Vec2,S.RayCast_s_d=new x.Vec2,S.RayCast_s_e=new x.Vec2,S.RayCast_s_q=new x.Vec2,S.RayCast_s_r=new x.Vec2,S.ComputeAABB_s_v1=new x.Vec2,S.ComputeAABB_s_v2=new x.Vec2,S);function S(){var t=e.call(this,x.ShapeType.e_edgeShape,x.polygonRadius)||this;return t.vertex1=new x.Vec2,t.vertex2=new x.Vec2,t.vertex0=new x.Vec2,t.vertex3=new x.Vec2,t.oneSided=!1,t}x.EdgeShape=t}(b2=b2||{}),function(t){var i=function(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e};t.ControllerEdge=i;var e=(s.prototype.GetNext=function(){return this.next},s.prototype.GetPrev=function(){return this.prev},s.prototype.GetBodyList=function(){return this.bodyList},s.prototype.AddBody=function(t){var e=new i(this,t);e.nextBody=this.bodyList,e.prevBody=null,this.bodyList&&(this.bodyList.prevBody=e),this.bodyList=e,++this.bodyCount,e.nextController=t.controllerList,e.prevController=null,t.controllerList&&(t.controllerList.prevController=e),t.controllerList=e,++t.controllerCount},s.prototype.RemoveBody=function(t){if(this.bodyCount<=0)throw new Error;for(var e=this.bodyList;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.bodyList===e&&(this.bodyList=e.nextBody),--this.bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.controllerList===e&&(t.controllerList=e.nextController),--t.controllerCount},s.prototype.Clear=function(){for(;this.bodyList;)this.RemoveBody(this.bodyList.body);this.bodyCount=0},s);function s(){this.bodyList=null,this.bodyCount=0,this.prev=null,this.next=null}t.Controller=e}(b2=b2||{}),function(x){function o(t,e){return x.Sqrt(t*e)}function n(t,e){return e<t?t:e}function r(t,e){return t<e?t:e}x.MixFriction=o,x.MixRestitution=n,x.MixRestitutionThreshold=r;var t=(Object.defineProperty(e.prototype,"other",{get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t},enumerable:!0,configurable:!0}),e.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},e);function e(t){this._other=null,this.prev=null,this.next=null,this.contact=t}x.ContactEdge=t;var i=(a.prototype.GetManifold=function(){return this.manifold},a.prototype.GetWorldManifold=function(t){var e=this.fixtureA.GetBody(),i=this.fixtureB.GetBody(),s=this.GetShapeA(),o=this.GetShapeB();t.Initialize(this.manifold,e.GetTransform(),s.radius,i.GetTransform(),o.radius)},a.prototype.IsTouching=function(){return this.touchingFlag},a.prototype.SetEnabled=function(t){this.enabledFlag=t},a.prototype.IsEnabled=function(){return this.enabledFlag},a.prototype.GetNext=function(){return this.next},a.prototype.GetFixtureA=function(){return this.fixtureA},a.prototype.GetChildIndexA=function(){return this.indexA},a.prototype.GetShapeA=function(){return this.fixtureA.GetShape()},a.prototype.GetFixtureB=function(){return this.fixtureB},a.prototype.GetChildIndexB=function(){return this.indexB},a.prototype.GetShapeB=function(){return this.fixtureB.GetShape()},a.prototype.FlagForFiltering=function(){this.filterFlag=!0},a.prototype.SetFriction=function(t){this.friction=t},a.prototype.GetFriction=function(){return this.friction},a.prototype.ResetFriction=function(){this.friction=o(this.fixtureA.friction,this.fixtureB.friction)},a.prototype.SetRestitution=function(t){this.restitution=t},a.prototype.GetRestitution=function(){return this.restitution},a.prototype.ResetRestitution=function(){this.restitution=n(this.fixtureA.restitution,this.fixtureB.restitution)},a.prototype.SetRestitutionThreshold=function(t){this.restitutionThreshold=t},a.prototype.GetRestitutionThreshold=function(){return this.restitutionThreshold},a.prototype.ResetRestitutionThreshold=function(){this.restitutionThreshold=r(this.fixtureA.restitutionThreshold,this.fixtureB.restitutionThreshold)},a.prototype.SetTangentSpeed=function(t){this.tangentSpeed=t},a.prototype.GetTangentSpeed=function(){return this.tangentSpeed},a.prototype.Reset=function(t,e,i,s){this.islandFlag=!1,this.touchingFlag=!1,this.enabledFlag=!0,this.filterFlag=!1,this.bulletHitFlag=!1,this.toiFlag=!1,this.fixtureA=t,this.fixtureB=i,this.indexA=e,this.indexB=s,this.manifold.pointCount=0,this.prev=null,this.next=null,this.nodeA.Reset(),this.nodeB.Reset(),this.toiCount=0,this.friction=o(this.fixtureA.friction,this.fixtureB.friction),this.restitution=n(this.fixtureA.restitution,this.fixtureB.restitution),this.restitutionThreshold=r(this.fixtureA.restitutionThreshold,this.fixtureB.restitutionThreshold)},a.prototype.Update=function(t){var e=this.oldManifold;this.oldManifold=this.manifold,this.manifold=e;var i=!(this.enabledFlag=!0),s=this.touchingFlag,o=this.fixtureA.IsSensor(),n=this.fixtureB.IsSensor(),r=o||n,a=this.fixtureA.GetBody(),l=this.fixtureB.GetBody(),c=a.GetTransform(),h=l.GetTransform();if(r){var u=this.GetShapeA(),p=this.GetShapeB(),i=x.TestOverlapShape(u,this.indexA,p,this.indexB,c,h);this.manifold.pointCount=0}else{this.Evaluate(this.manifold,c,h),i=0<this.manifold.pointCount;for(var f=0;f<this.manifold.pointCount;++f){var d=this.manifold.points[f];d.normalImpulse=0,d.tangentImpulse=0;for(var y=d.id,V=0;V<this.oldManifold.pointCount;++V){var v=this.oldManifold.points[V];if(v.id.key===y.key){d.normalImpulse=v.normalImpulse,d.tangentImpulse=v.tangentImpulse;break}}}i!==s&&(a.SetAwake(!0),l.SetAwake(!0))}this.touchingFlag=i,!s&&i&&t&&t.BeginContact(this),s&&!i&&t&&t.EndContact(this),!r&&i&&t&&t.PreSolve(this,this.oldManifold)},a.prototype.ComputeTOI=function(t,e){var i=a.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.indexA),i.proxyB.SetShape(this.GetShapeB(),this.indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=x.linearSlop;var s=a.ComputeTOI_s_output;return x.TimeOfImpact(s,i),s.t},a.ComputeTOI_s_input=new x.TOIInput,a.ComputeTOI_s_output=new x.TOIOutput,a);function a(){this.islandFlag=!1,this.touchingFlag=!1,this.enabledFlag=!1,this.filterFlag=!1,this.bulletHitFlag=!1,this.toiFlag=!1,this.prev=null,this.next=null,this.nodeA=new t(this),this.nodeB=new t(this),this.indexA=0,this.indexB=0,this.manifold=new x.Manifold,this.toiCount=0,this.toi=0,this.friction=0,this.restitution=0,this.restitutionThreshold=0,this.tangentSpeed=0,this.oldManifold=new x.Manifold}x.Contact=i}(b2=b2||{}),function(X){X.g_blockSolve=!1,X.get_g_blockSolve=function(){return X.g_blockSolve},X.set_g_blockSolve=function(t){X.g_blockSolve=t};var t=(e.MakeArray=function(t){return X.MakeArray(t,function(t){return new e})},e);function e(){this.rA=new X.Vec2,this.rB=new X.Vec2,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}X.VelocityConstraintPoint=t;var S=(i.MakeArray=function(t){return X.MakeArray(t,function(t){return new i})},i);function i(){this.points=t.MakeArray(X.maxManifoldPoints),this.normal=new X.Vec2,this.tangent=new X.Vec2,this.normalMass=new X.Mat22,this.K=new X.Mat22,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.threshold=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}X.ContactVelocityConstraint=S;var B=(s.MakeArray=function(t){return X.MakeArray(t,function(t){return new s})},s);function s(){this.localPoints=X.Vec2.MakeArray(X.maxManifoldPoints),this.localNormal=new X.Vec2,this.localPoint=new X.Vec2,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new X.Vec2,this.localCenterB=new X.Vec2,this.invIA=0,this.invIB=0,this.type=X.ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}X.ContactPositionConstraint=B;function o(){this.step=new X.TimeStep,this.count=0}X.ContactSolverDef=o;var n=(l.prototype.Initialize=function(t,e,i,s){var o=l.Initialize_s_pointA,n=l.Initialize_s_pointB,r=l.Initialize_s_planePoint,a=l.Initialize_s_clipPoint;switch(t.type){case X.ManifoldType.e_circles:X.Transform.MulXV(e,t.localPoint,o),X.Transform.MulXV(i,t.localPoints[0],n),X.Vec2.SubVV(n,o,this.normal).SelfNormalize(),X.Vec2.MidVV(o,n,this.point),this.separation=X.Vec2.DotVV(X.Vec2.SubVV(n,o,X.Vec2.s_t0),this.normal)-t.radiusA-t.radiusB;break;case X.ManifoldType.e_faceA:X.Rot.MulRV(e.q,t.localNormal,this.normal),X.Transform.MulXV(e,t.localPoint,r),X.Transform.MulXV(i,t.localPoints[s],a),this.separation=X.Vec2.DotVV(X.Vec2.SubVV(a,r,X.Vec2.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(a);break;case X.ManifoldType.e_faceB:X.Rot.MulRV(i.q,t.localNormal,this.normal),X.Transform.MulXV(i,t.localPoint,r),X.Transform.MulXV(e,t.localPoints[s],a),this.separation=X.Vec2.DotVV(X.Vec2.SubVV(a,r,X.Vec2.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(a),this.normal.SelfNeg()}},l.Initialize_s_pointA=new X.Vec2,l.Initialize_s_pointB=new X.Vec2,l.Initialize_s_planePoint=new X.Vec2,l.Initialize_s_clipPoint=new X.Vec2,l);function l(){this.normal=new X.Vec2,this.point=new X.Vec2,this.separation=0}X.PositionSolverManifold=n;var r=(Z.prototype.Initialize=function(t){if(this.step.Copy(t.step),this.count=t.count,this.positionConstraints.length<this.count)for(var e=X.Max(2*this.positionConstraints.length,this.count);this.positionConstraints.length<e;)this.positionConstraints[this.positionConstraints.length]=new B;if(this.velocityConstraints.length<this.count)for(e=X.Max(2*this.velocityConstraints.length,this.count);this.velocityConstraints.length<e;)this.velocityConstraints[this.velocityConstraints.length]=new S;this.positions=t.positions,this.velocities=t.velocities,this.contacts=t.contacts;for(var i=0;i<this.count;++i){var s=this.contacts[i],o=s.fixtureA,n=s.fixtureB,r=o.GetShape(),a=n.GetShape(),l=r.radius,c=a.radius,h=o.GetBody(),u=n.GetBody(),p=s.GetManifold(),f=p.pointCount,d=this.velocityConstraints[i];d.friction=s.friction,d.restitution=s.restitution,d.threshold=s.restitutionThreshold,d.tangentSpeed=s.tangentSpeed,d.indexA=h.islandIndex,d.indexB=u.islandIndex,d.invMassA=h.invMass,d.invMassB=u.invMass,d.invIA=h.invI,d.invIB=u.invI,d.contactIndex=i,d.pointCount=f,d.K.SetZero(),d.normalMass.SetZero();var y=this.positionConstraints[i];y.indexA=h.islandIndex,y.indexB=u.islandIndex,y.invMassA=h.invMass,y.invMassB=u.invMass,y.localCenterA.Copy(h.sweep.localCenter),y.localCenterB.Copy(u.sweep.localCenter),y.invIA=h.invI,y.invIB=u.invI,y.localNormal.Copy(p.localNormal),y.localPoint.Copy(p.localPoint),y.pointCount=f,y.radiusA=l,y.radiusB=c,y.type=p.type;for(var V=0;V<f;++V){var v=p.points[V],x=d.points[V];this.step.warmStarting?(x.normalImpulse=this.step.dtRatio*v.normalImpulse,x.tangentImpulse=this.step.dtRatio*v.tangentImpulse):(x.normalImpulse=0,x.tangentImpulse=0),x.rA.SetZero(),x.rB.SetZero(),x.normalMass=0,x.tangentMass=0,x.velocityBias=0,y.localPoints[V].Copy(v.localPoint)}}return this},Z.prototype.InitializeVelocityConstraints=function(){for(var t=Z.InitializeVelocityConstraints_s_xfA,e=Z.InitializeVelocityConstraints_s_xfB,i=Z.InitializeVelocityConstraints_s_worldManifold,s=0;s<this.count;++s){var o=this.velocityConstraints[s],n=this.positionConstraints[s],r=n.radiusA,a=n.radiusB,l=this.contacts[o.contactIndex].GetManifold(),c=o.indexA,h=o.indexB,u=o.invMassA,p=o.invMassB,f=o.invIA,d=o.invIB,y=n.localCenterA,V=n.localCenterB,v=this.positions[c].c,x=this.positions[c].a,S=this.velocities[c].v,B=this.velocities[c].w,A=this.positions[h].c,C=this.positions[h].a,m=this.velocities[h].v,g=this.velocities[h].w;t.q.SetAngle(x),e.q.SetAngle(C),X.Vec2.SubVV(v,X.Rot.MulRV(t.q,y,X.Vec2.s_t0),t.p),X.Vec2.SubVV(A,X.Rot.MulRV(e.q,V,X.Vec2.s_t0),e.p),i.Initialize(l,t,r,e,a),o.normal.Copy(i.normal),X.Vec2.CrossVOne(o.normal,o.tangent);for(var w,_,b,M,P,I,D,G,T,F=o.pointCount,R=0;R<F;++R){var L=o.points[R];X.Vec2.SubVV(i.points[R],v,L.rA),X.Vec2.SubVV(i.points[R],A,L.rB);var k=X.Vec2.CrossVV(L.rA,o.normal),q=X.Vec2.CrossVV(L.rB,o.normal),J=u+p+f*k*k+d*q*q;L.normalMass=0<J?1/J:0;var E=o.tangent,z=X.Vec2.CrossVV(L.rA,E),j=X.Vec2.CrossVV(L.rB,E),N=u+p+f*z*z+d*j*j;L.tangentMass=0<N?1/N:0,L.velocityBias=0;var O=X.Vec2.DotVV(o.normal,X.Vec2.SubVV(X.Vec2.AddVCrossSV(m,g,L.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(S,B,L.rA,X.Vec2.s_t1),X.Vec2.s_t0));O<-o.threshold&&(L.velocityBias+=-o.restitution*O)}2===o.pointCount&&X.g_blockSolve&&(w=o.points[0],_=o.points[1],(D=u+p+f*(b=X.Vec2.CrossVV(w.rA,o.normal))*b+d*(M=X.Vec2.CrossVV(w.rB,o.normal))*M)*D<1e3*(D*(G=u+p+f*(P=X.Vec2.CrossVV(_.rA,o.normal))*P+d*(I=X.Vec2.CrossVV(_.rB,o.normal))*I)-(T=u+p+f*b*P+d*M*I)*T)?(o.K.ex.Set(D,T),o.K.ey.Set(T,G),o.K.GetInverse(o.normalMass)):o.pointCount=1)}},Z.prototype.WarmStart=function(){for(var t=Z.WarmStart_s_P,e=0;e<this.count;++e){for(var i=this.velocityConstraints[e],s=i.indexA,o=i.indexB,n=i.invMassA,r=i.invIA,a=i.invMassB,l=i.invIB,c=i.pointCount,h=this.velocities[s].v,u=this.velocities[s].w,p=this.velocities[o].v,f=this.velocities[o].w,d=i.normal,y=i.tangent,V=0;V<c;++V){var v=i.points[V];X.Vec2.AddVV(X.Vec2.MulSV(v.normalImpulse,d,X.Vec2.s_t0),X.Vec2.MulSV(v.tangentImpulse,y,X.Vec2.s_t1),t),u-=r*X.Vec2.CrossVV(v.rA,t),h.SelfMulSub(n,t),f+=l*X.Vec2.CrossVV(v.rB,t),p.SelfMulAdd(a,t)}this.velocities[s].w=u,this.velocities[o].w=f}},Z.prototype.SolveVelocityConstraints=function(){for(var t=Z.SolveVelocityConstraints_s_dv,e=Z.SolveVelocityConstraints_s_dv1,i=Z.SolveVelocityConstraints_s_dv2,s=Z.SolveVelocityConstraints_s_P,o=Z.SolveVelocityConstraints_s_a,n=Z.SolveVelocityConstraints_s_b,r=Z.SolveVelocityConstraints_s_x,a=Z.SolveVelocityConstraints_s_d,l=Z.SolveVelocityConstraints_s_P1,c=Z.SolveVelocityConstraints_s_P2,h=Z.SolveVelocityConstraints_s_P1P2,u=0;u<this.count;++u){for(var p=this.velocityConstraints[u],f=p.indexA,d=p.indexB,y=p.invMassA,V=p.invIA,v=p.invMassB,x=p.invIB,S=p.pointCount,B=this.velocities[f].v,A=this.velocities[f].w,C=this.velocities[d].v,m=this.velocities[d].w,g=p.normal,w=p.tangent,_=p.friction,b=0;b<S;++b){var M=p.points[b];X.Vec2.SubVV(X.Vec2.AddVCrossSV(C,m,M.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(B,A,M.rA,X.Vec2.s_t1),t);var P=X.Vec2.DotVV(t,w)-p.tangentSpeed,I=M.tangentMass*-P,D=_*M.normalImpulse;I=(G=X.Clamp(M.tangentImpulse+I,-D,D))-M.tangentImpulse,M.tangentImpulse=G,X.Vec2.MulSV(I,w,s),B.SelfMulSub(y,s),A-=V*X.Vec2.CrossVV(M.rA,s),C.SelfMulAdd(v,s),m+=x*X.Vec2.CrossVV(M.rB,s)}if(1===p.pointCount||!1===X.g_blockSolve)for(b=0;b<S;++b){M=p.points[b];X.Vec2.SubVV(X.Vec2.AddVCrossSV(C,m,M.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(B,A,M.rA,X.Vec2.s_t1),t);var G,T=X.Vec2.DotVV(t,g),I=-M.normalMass*(T-M.velocityBias);I=(G=X.Max(M.normalImpulse+I,0))-M.normalImpulse,M.normalImpulse=G,X.Vec2.MulSV(I,g,s),B.SelfMulSub(y,s),A-=V*X.Vec2.CrossVV(M.rA,s),C.SelfMulAdd(v,s),m+=x*X.Vec2.CrossVV(M.rB,s)}else{var F=p.points[0],R=p.points[1];o.Set(F.normalImpulse,R.normalImpulse),X.Vec2.SubVV(X.Vec2.AddVCrossSV(C,m,F.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(B,A,F.rA,X.Vec2.s_t1),e),X.Vec2.SubVV(X.Vec2.AddVCrossSV(C,m,R.rB,X.Vec2.s_t0),X.Vec2.AddVCrossSV(B,A,R.rA,X.Vec2.s_t1),i);var L=X.Vec2.DotVV(e,g),k=X.Vec2.DotVV(i,g);for(n.x=L-F.velocityBias,n.y=k-R.velocityBias,n.SelfSub(X.Mat22.MulMV(p.K,o,X.Vec2.s_t0));;){if(X.Mat22.MulMV(p.normalMass,n,r).SelfNeg(),0<=r.x&&0<=r.y){X.Vec2.SubVV(r,o,a),X.Vec2.MulSV(a.x,g,l),X.Vec2.MulSV(a.y,g,c),X.Vec2.AddVV(l,c,h),B.SelfMulSub(y,h),A-=V*(X.Vec2.CrossVV(F.rA,l)+X.Vec2.CrossVV(R.rA,c)),C.SelfMulAdd(v,h),m+=x*(X.Vec2.CrossVV(F.rB,l)+X.Vec2.CrossVV(R.rB,c)),F.normalImpulse=r.x,R.normalImpulse=r.y;break}if(r.x=-F.normalMass*n.x,L=r.y=0,k=p.K.ex.y*r.x+n.y,0<=r.x&&0<=k){X.Vec2.SubVV(r,o,a),X.Vec2.MulSV(a.x,g,l),X.Vec2.MulSV(a.y,g,c),X.Vec2.AddVV(l,c,h),B.SelfMulSub(y,h),A-=V*(X.Vec2.CrossVV(F.rA,l)+X.Vec2.CrossVV(R.rA,c)),C.SelfMulAdd(v,h),m+=x*(X.Vec2.CrossVV(F.rB,l)+X.Vec2.CrossVV(R.rB,c)),F.normalImpulse=r.x,R.normalImpulse=r.y;break}if(r.x=0,r.y=-R.normalMass*n.y,L=p.K.ey.x*r.y+n.x,(k=0)<=r.y&&0<=L){X.Vec2.SubVV(r,o,a),X.Vec2.MulSV(a.x,g,l),X.Vec2.MulSV(a.y,g,c),X.Vec2.AddVV(l,c,h),B.SelfMulSub(y,h),A-=V*(X.Vec2.CrossVV(F.rA,l)+X.Vec2.CrossVV(R.rA,c)),C.SelfMulAdd(v,h),m+=x*(X.Vec2.CrossVV(F.rB,l)+X.Vec2.CrossVV(R.rB,c)),F.normalImpulse=r.x,R.normalImpulse=r.y;break}if(r.x=0,r.y=0,L=n.x,k=n.y,0<=L&&0<=k){X.Vec2.SubVV(r,o,a),X.Vec2.MulSV(a.x,g,l),X.Vec2.MulSV(a.y,g,c),X.Vec2.AddVV(l,c,h),B.SelfMulSub(y,h),A-=V*(X.Vec2.CrossVV(F.rA,l)+X.Vec2.CrossVV(R.rA,c)),C.SelfMulAdd(v,h),m+=x*(X.Vec2.CrossVV(F.rB,l)+X.Vec2.CrossVV(R.rB,c)),F.normalImpulse=r.x,R.normalImpulse=r.y;break}break}}this.velocities[f].w=A,this.velocities[d].w=m}},Z.prototype.StoreImpulses=function(){for(var t=0;t<this.count;++t)for(var e=this.velocityConstraints[t],i=this.contacts[e.contactIndex].GetManifold(),s=0;s<e.pointCount;++s)i.points[s].normalImpulse=e.points[s].normalImpulse,i.points[s].tangentImpulse=e.points[s].tangentImpulse},Z.prototype.SolvePositionConstraints=function(){for(var t=Z.SolvePositionConstraints_s_xfA,e=Z.SolvePositionConstraints_s_xfB,i=Z.SolvePositionConstraints_s_psm,s=Z.SolvePositionConstraints_s_rA,o=Z.SolvePositionConstraints_s_rB,n=Z.SolvePositionConstraints_s_P,r=0,a=0;a<this.count;++a){for(var l=this.positionConstraints[a],c=l.indexA,h=l.indexB,u=l.localCenterA,p=l.invMassA,f=l.invIA,d=l.localCenterB,y=l.invMassB,V=l.invIB,v=l.pointCount,x=this.positions[c].c,S=this.positions[c].a,B=this.positions[h].c,A=this.positions[h].a,C=0;C<v;++C){t.q.SetAngle(S),e.q.SetAngle(A),X.Vec2.SubVV(x,X.Rot.MulRV(t.q,u,X.Vec2.s_t0),t.p),X.Vec2.SubVV(B,X.Rot.MulRV(e.q,d,X.Vec2.s_t0),e.p),i.Initialize(l,t,e,C);var m=i.normal,g=i.point,w=i.separation;X.Vec2.SubVV(g,x,s),X.Vec2.SubVV(g,B,o),r=X.Min(r,w);var _=X.Clamp(X.baumgarte*(w+X.linearSlop),-X.maxLinearCorrection,0),b=X.Vec2.CrossVV(s,m),M=X.Vec2.CrossVV(o,m),P=p+y+f*b*b+V*M*M,I=0<P?-_/P:0;X.Vec2.MulSV(I,m,n),x.SelfMulSub(p,n),S-=f*X.Vec2.CrossVV(s,n),B.SelfMulAdd(y,n),A+=V*X.Vec2.CrossVV(o,n)}this.positions[c].a=S,this.positions[h].a=A}return r>-3*X.linearSlop},Z.prototype.SolveTOIPositionConstraints=function(t,e){for(var i=Z.SolveTOIPositionConstraints_s_xfA,s=Z.SolveTOIPositionConstraints_s_xfB,o=Z.SolveTOIPositionConstraints_s_psm,n=Z.SolveTOIPositionConstraints_s_rA,r=Z.SolveTOIPositionConstraints_s_rB,a=Z.SolveTOIPositionConstraints_s_P,l=0,c=0;c<this.count;++c){var h=this.positionConstraints[c],u=h.indexA,p=h.indexB,f=h.localCenterA,d=h.localCenterB,y=h.pointCount,V=0,v=0;u!==t&&u!==e||(V=h.invMassA,v=h.invIA);var x=0,S=0;p!==t&&p!==e||(x=h.invMassB,S=h.invIB);for(var B=this.positions[u].c,A=this.positions[u].a,C=this.positions[p].c,m=this.positions[p].a,g=0;g<y;++g){i.q.SetAngle(A),s.q.SetAngle(m),X.Vec2.SubVV(B,X.Rot.MulRV(i.q,f,X.Vec2.s_t0),i.p),X.Vec2.SubVV(C,X.Rot.MulRV(s.q,d,X.Vec2.s_t0),s.p),o.Initialize(h,i,s,g);var w=o.normal,_=o.point,b=o.separation;X.Vec2.SubVV(_,B,n),X.Vec2.SubVV(_,C,r),l=X.Min(l,b);var M=X.Clamp(X.toiBaumgarte*(b+X.linearSlop),-X.maxLinearCorrection,0),P=X.Vec2.CrossVV(n,w),I=X.Vec2.CrossVV(r,w),D=V+x+v*P*P+S*I*I,G=0<D?-M/D:0;X.Vec2.MulSV(G,w,a),B.SelfMulSub(V,a),A-=v*X.Vec2.CrossVV(n,a),C.SelfMulAdd(x,a),m+=S*X.Vec2.CrossVV(r,a)}this.positions[u].a=A,this.positions[p].a=m}return l>=-1.5*X.linearSlop},Z.InitializeVelocityConstraints_s_xfA=new X.Transform,Z.InitializeVelocityConstraints_s_xfB=new X.Transform,Z.InitializeVelocityConstraints_s_worldManifold=new X.WorldManifold,Z.WarmStart_s_P=new X.Vec2,Z.SolveVelocityConstraints_s_dv=new X.Vec2,Z.SolveVelocityConstraints_s_dv1=new X.Vec2,Z.SolveVelocityConstraints_s_dv2=new X.Vec2,Z.SolveVelocityConstraints_s_P=new X.Vec2,Z.SolveVelocityConstraints_s_a=new X.Vec2,Z.SolveVelocityConstraints_s_b=new X.Vec2,Z.SolveVelocityConstraints_s_x=new X.Vec2,Z.SolveVelocityConstraints_s_d=new X.Vec2,Z.SolveVelocityConstraints_s_P1=new X.Vec2,Z.SolveVelocityConstraints_s_P2=new X.Vec2,Z.SolveVelocityConstraints_s_P1P2=new X.Vec2,Z.SolvePositionConstraints_s_xfA=new X.Transform,Z.SolvePositionConstraints_s_xfB=new X.Transform,Z.SolvePositionConstraints_s_psm=new n,Z.SolvePositionConstraints_s_rA=new X.Vec2,Z.SolvePositionConstraints_s_rB=new X.Vec2,Z.SolvePositionConstraints_s_P=new X.Vec2,Z.SolveTOIPositionConstraints_s_xfA=new X.Transform,Z.SolveTOIPositionConstraints_s_xfB=new X.Transform,Z.SolveTOIPositionConstraints_s_psm=new n,Z.SolveTOIPositionConstraints_s_rA=new X.Vec2,Z.SolveTOIPositionConstraints_s_rB=new X.Vec2,Z.SolveTOIPositionConstraints_s_P=new X.Vec2,Z);function Z(){this.step=new X.TimeStep,this.positionConstraints=B.MakeArray(1024),this.velocityConstraints=S.MakeArray(1024),this.count=0}X.ContactSolver=r}(b2=b2||{}),function(n){var i=(t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this},t.DEFAULT=new t,t);function t(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}n.Filter=i;function e(){this.userData=null,this.friction=.2,this.restitution=0,this.restitutionThreshold=+n.lengthUnitsPerMeter,this.density=0,this.isSensor=!1,this.filter=new i}n.FixtureDef=e;var s=(r.prototype.Reset=function(){this.fixture.body.world.contactManager.broadPhase.DestroyProxy(this.treeNode)},r.prototype.Touch=function(){this.fixture.body.world.contactManager.broadPhase.TouchProxy(this.treeNode)},r.prototype.Synchronize=function(t,e){var i,s,o;t===e?(this.fixture.shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.body.world.contactManager.broadPhase.MoveProxy(this.treeNode,this.aabb,n.Vec2.ZERO)):(i=r.Synchronize_s_aabb1,s=r.Synchronize_s_aab,this.fixture.shape.ComputeAABB(i,t,this.childIndex),this.fixture.shape.ComputeAABB(s,e,this.childIndex),this.aabb.Combine2(i,s),(o=r.Synchronize_s_displacement).Copy(s.GetCenter()).SelfSub(i.GetCenter()),this.fixture.body.world.contactManager.broadPhase.MoveProxy(this.treeNode,this.aabb,o))},r.Synchronize_s_aabb1=new n.AABB,r.Synchronize_s_aab=new n.AABB,r.Synchronize_s_displacement=new n.Vec2,r);function r(t,e){this.aabb=new n.AABB,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.shape.ComputeAABB(this.aabb,this.fixture.body.GetTransform(),e),this.treeNode=this.fixture.body.world.contactManager.broadPhase.CreateProxy(this.aabb,this)}n.FixtureProxy=s;var o=(Object.defineProperty(a.prototype,"proxyCount",{get:function(){return this.proxies.length},enumerable:!0,configurable:!0}),a.prototype.Reset=function(){},a.prototype.GetType=function(){return this.shape.GetType()},a.prototype.GetShape=function(){return this.shape},a.prototype.SetSensor=function(t){t!==this.isSensor&&(this.body.SetAwake(!0),this.isSensor=t)},a.prototype.IsSensor=function(){return this.isSensor},a.prototype.SetFilterData=function(t){this.filter.Copy(t),this.Refilter()},a.prototype.GetFilterData=function(){return this.filter},a.prototype.Refilter=function(){for(var t=this.body.GetContactList();t;){var e=t.contact,i=e.GetFixtureA(),s=e.GetFixtureB();i!==this&&s!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()},a.prototype.GetBody=function(){return this.body},a.prototype.GetNext=function(){return this.next},a.prototype.GetUserData=function(){return this.userData},a.prototype.SetUserData=function(t){this.userData=t},a.prototype.TestPoint=function(t){return this.shape.TestPoint(this.body.GetTransform(),t)},a.prototype.ComputeDistance=function(t,e,i){return this.shape.ComputeDistance(this.body.GetTransform(),t,e,i)},a.prototype.RayCast=function(t,e,i){return this.shape.RayCast(t,e,this.body.GetTransform(),i)},a.prototype.GetMassData=function(t){return void 0===t&&(t=new n.MassData),this.shape.ComputeMass(t,this.density),t},a.prototype.SetDensity=function(t){this.density=t},a.prototype.GetDensity=function(){return this.density},a.prototype.GetFriction=function(){return this.friction},a.prototype.SetFriction=function(t){this.friction=t},a.prototype.GetRestitution=function(){return this.restitution},a.prototype.SetRestitution=function(t){this.restitution=t},a.prototype.GetRestitutionThreshold=function(){return this.restitutionThreshold},a.prototype.SetRestitutionThreshold=function(t){this.restitutionThreshold=t},a.prototype.GetAABB=function(t){return this.proxies[t].aabb},a.prototype.Dump=function(t,e){t("    const fd: FixtureDef = new FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.friction),t("    fd.restitution = %.15f;\n",this.restitution),t("    fd.restitutionThreshold = %.15f;\n",this.restitutionThreshold),t("    fd.density = %.15f;\n",this.density),t("    fd.isSensor = %s;\n",this.isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.filter.groupIndex),this.shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)},a.prototype.CreateProxies=function(){if(0!==this.proxies.length)throw new Error;for(var t=0;t<this.shape.GetChildCount();++t)this.proxies[t]=new s(this,t)},a.prototype.DestroyProxies=function(){for(var t=0,e=this.proxies;t<e.length;t++){e[t].Reset()}this.proxies.length=0},a.prototype.TouchProxies=function(){for(var t=0,e=this.proxies;t<e.length;t++){e[t].Touch()}},a.prototype.SynchronizeProxies=function(t,e){for(var i=0,s=this.proxies;i<s.length;i++){s[i].Synchronize(t,e)}},a);function a(t,e){this.density=0,this.next=null,this.friction=0,this.restitution=0,this.restitutionThreshold=+n.lengthUnitsPerMeter,this.proxies=[],this.filter=new i,this.isSensor=!1,this.userData=null,this.body=t,this.shape=e.shape.Clone(),this.userData=n.Maybe(e.userData,null),this.friction=n.Maybe(e.friction,.2),this.restitution=n.Maybe(e.restitution,0),this.restitutionThreshold=n.Maybe(e.restitutionThreshold,0),this.filter.Copy(n.Maybe(e.filter,i.DEFAULT)),this.isSensor=n.Maybe(e.isSensor,!1),this.density=n.Maybe(e.density,0)}n.Fixture=o}(b2=b2||{}),function(c){var u,t;(t=u=c.JointType||(c.JointType={}))[t.e_unknownJoint=0]="e_unknownJoint",t[t.e_revoluteJoint=1]="e_revoluteJoint",t[t.e_prismaticJoint=2]="e_prismaticJoint",t[t.e_distanceJoint=3]="e_distanceJoint",t[t.e_pulleyJoint=4]="e_pulleyJoint",t[t.e_mouseJoint=5]="e_mouseJoint",t[t.e_gearJoint=6]="e_gearJoint",t[t.e_wheelJoint=7]="e_wheelJoint",t[t.e_weldJoint=8]="e_weldJoint",t[t.e_frictionJoint=9]="e_frictionJoint",t[t.e_ropeJoint=10]="e_ropeJoint",t[t.e_motorJoint=11]="e_motorJoint",t[t.e_areaJoint=12]="e_areaJoint";var e=(i.prototype.SetZero=function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this},i.prototype.Set=function(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this},i);function i(){this.linear=new c.Vec2,this.angularA=0,this.angularB=0}c.Jacobian=e;var s=(Object.defineProperty(o.prototype,"other",{get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t},enumerable:!0,configurable:!0}),o.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},o);function o(t){this._other=null,this.prev=null,this.next=null,this.joint=t}c.JointEdge=s;function n(t){this.type=u.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=t}c.JointDef=n,c.LinearStiffness=function(t,e,i,s,o){var n=s.GetMass(),r=o.GetMass(),a=0<n&&0<r?n*r/(n+r):0<n?n:r,l=2*c.pi*e;t.stiffness=a*l*l,t.damping=2*a*i*l},c.AngularStiffness=function(t,e,i,s,o){var n=s.GetInertia(),r=o.GetInertia(),a=0<n&&0<r?n*r/(n+r):0<n?n:r,l=2*c.pi*e;t.stiffness=a*l*l,t.damping=2*a*i*l};var r=(p.prototype.GetType=function(){return this.type},p.prototype.GetBodyA=function(){return this.bodyA},p.prototype.GetBodyB=function(){return this.bodyB},p.prototype.GetNext=function(){return this.next},p.prototype.GetUserData=function(){return this.userData},p.prototype.SetUserData=function(t){this.userData=t},p.prototype.IsEnabled=function(){return this.bodyA.IsEnabled()&&this.bodyB.IsEnabled()},p.prototype.GetCollideConnected=function(){return this.collideConnected},p.prototype.Dump=function(t){t("// Dump is not supported for this joint type.\n")},p.prototype.ShiftOrigin=function(t){},p.prototype.Draw=function(t){var e=this.bodyA.GetTransform(),i=this.bodyB.GetTransform(),s=e.p,o=i.p,n=this.GetAnchorA(p.Draw_s_p1),r=this.GetAnchorB(p.Draw_s_p2),a=p.Draw_s_color.SetRGB(.5,.8,.8);switch(this.type){case u.e_distanceJoint:t.DrawSegment(n,r,a);break;case u.e_pulleyJoint:var l=this.GetGroundAnchorA(),c=this.GetGroundAnchorB();t.DrawSegment(l,n,a),t.DrawSegment(c,r,a),t.DrawSegment(l,c,a);break;case u.e_mouseJoint:var h=p.Draw_s_c;h.Set(0,1,0),t.DrawPoint(n,4,h),t.DrawPoint(r,4,h),h.Set(.8,.8,.8),t.DrawSegment(n,r,h);break;default:t.DrawSegment(s,n,a),t.DrawSegment(n,r,a),t.DrawSegment(o,r,a)}},p.Draw_s_p1=new c.Vec2,p.Draw_s_p2=new c.Vec2,p.Draw_s_color=new c.Color(.5,.8,.8),p.Draw_s_c=new c.Color,p);function p(t){this.type=u.e_unknownJoint,this.prev=null,this.next=null,this.edgeA=new s(this),this.edgeB=new s(this),this.index=0,this.islandFlag=!1,this.collideConnected=!1,this.userData=null,this.type=t.type,this.edgeA.other=t.bodyB,this.edgeB.other=t.bodyA,this.bodyA=t.bodyA,this.bodyB=t.bodyB,this.collideConnected=c.Maybe(t.collideConnected,!1),this.userData=c.Maybe(t.userData,null)}c.Joint=r}(b2=b2||{}),function(r){var t=(e.prototype.SayGoodbyeJoint=function(t){},e.prototype.SayGoodbyeFixture=function(t){},e.prototype.SayGoodbyeParticleGroup=function(t){},e.prototype.SayGoodbyeParticle=function(t,e){},e);function e(){}r.DestructionListener=t;var i=(s.prototype.ShouldCollide=function(t,e){var i=t.GetBody(),s=e.GetBody();if(s.GetType()===r.BodyType.staticBody&&i.GetType()===r.BodyType.staticBody)return!1;if(!s.ShouldCollideConnected(i))return!1;var o=t.GetFilterData(),n=e.GetFilterData();return o.groupIndex===n.groupIndex&&0!==o.groupIndex?0<o.groupIndex:0!=(o.maskBits&n.categoryBits)&&0!=(o.categoryBits&n.maskBits)},s.prototype.ShouldCollideFixtureParticle=function(t,e,i){return!0},s.prototype.ShouldCollideParticleParticle=function(t,e,i){return!0},s.defaultFilter=new s,s);function s(){}r.ContactFilter=i;function o(){this.normalImpulses=r.MakeNumberArray(r.maxManifoldPoints),this.tangentImpulses=r.MakeNumberArray(r.maxManifoldPoints),this.count=0}r.ContactImpulse=o;var n=(a.prototype.BeginContact=function(t){},a.prototype.EndContact=function(t){},a.prototype.BeginContactFixtureParticle=function(t,e){},a.prototype.EndContactFixtureParticle=function(t,e){},a.prototype.BeginContactParticleParticle=function(t,e){},a.prototype.EndContactParticleParticle=function(t,e){},a.prototype.PreSolve=function(t,e){},a.prototype.PostSolve=function(t,e){},a.defaultListener=new a,a);function a(){}r.ContactListener=n;var l=(c.prototype.ReportFixture=function(t){return!0},c.prototype.ReportParticle=function(t,e){return!1},c.prototype.ShouldQueryParticleSystem=function(t){return!0},c);function c(){}r.QueryCallback=l;var h=(u.prototype.ReportFixture=function(t,e,i,s){return s},u.prototype.ReportParticle=function(t,e,i,s,o){return 0},u.prototype.ShouldQueryParticleSystem=function(t){return!0},u);function u(){}r.RayCastCallback=h}(b2=b2||{}),function(o){var t;(t=o.ParticleFlag||(o.ParticleFlag={}))[t.waterParticle=0]="waterParticle",t[t.zombieParticle=2]="zombieParticle",t[t.wallParticle=4]="wallParticle",t[t.springParticle=8]="springParticle",t[t.elasticParticle=16]="elasticParticle",t[t.viscousParticle=32]="viscousParticle",t[t.powderParticle=64]="powderParticle",t[t.tensileParticle=128]="tensileParticle",t[t.colorMixingParticle=256]="colorMixingParticle",t[t.destructionListenerParticle=512]="destructionListenerParticle",t[t.barrierParticle=1024]="barrierParticle",t[t.staticPressureParticle=2048]="staticPressureParticle",t[t.reactiveParticle=4096]="reactiveParticle",t[t.repulsiveParticle=8192]="repulsiveParticle",t[t.fixtureContactListenerParticle=16384]="fixtureContactListenerParticle",t[t.particleContactListenerParticle=32768]="particleContactListenerParticle",t[t.fixtureContactFilterParticle=65536]="fixtureContactFilterParticle",t[t.particleContactFilterParticle=131072]="particleContactFilterParticle";function e(){this.flags=0,this.position=new o.Vec2,this.velocity=new o.Vec2,this.color=new o.Color(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null}o.ParticleDef=e,o.CalculateParticleIterations=function(t,e,i){var s=Math.ceil(Math.sqrt(t/(.01*e))*i);return o.Clamp(s,1,8)};var i=(s.prototype.GetIndex=function(){return this.index},s.prototype.SetIndex=function(t){this.index=t},s);function s(){this.index=o.invalidParticleIndex}o.ParticleHandle=i}(b2=b2||{}),function(t){var r=function(t,e){this.proxyA=t,this.proxyB=e};t.Pair=r;var e=(i.prototype.CreateProxy=function(t,e){var i=this.tree.CreateProxy(t,e);return++this.proxyCount,this.BufferMove(i),i},i.prototype.DestroyProxy=function(t){this.UnBufferMove(t),--this.proxyCount,this.tree.DestroyProxy(t)},i.prototype.MoveProxy=function(t,e,i){this.tree.MoveProxy(t,e,i)&&this.BufferMove(t)},i.prototype.TouchProxy=function(t){this.BufferMove(t)},i.prototype.GetProxyCount=function(){return this.proxyCount},i.prototype.UpdatePairs=function(t){var n=this;this.pairCount=0;for(var i=this,e=0;e<this.moveCount;++e)!function(t){var o=i.moveBuffer[t];if(null===o)return;var e=o.aabb;i.tree.Query(e,function(t){return t.id===o.id||t.moved&&t.id>o.id||(i=t.id<o.id?(e=t,o):(e=o,t),n.pairCount===n.pairBuffer.length?n.pairBuffer[n.pairCount]=new r(e,i):((s=n.pairBuffer[n.pairCount]).proxyA=e,s.proxyB=i),++n.pairCount),!0;var e,i,s})}(e);for(e=0;e<this.pairCount;++e){var s=this.pairBuffer[e];t(s.proxyA.userData,s.proxyB.userData)}for(e=0;e<this.moveCount;++e){var o=this.moveBuffer[e];null!==o&&(o.moved=!1)}this.moveCount=0},i.prototype.Query=function(t,e){this.tree.Query(t,e)},i.prototype.QueryPoint=function(t,e){this.tree.QueryPoint(t,e)},i.prototype.RayCast=function(t,e){this.tree.RayCast(t,e)},i.prototype.GetTreeHeight=function(){return this.tree.GetHeight()},i.prototype.GetTreeBalance=function(){return this.tree.GetMaxBalance()},i.prototype.GetTreeQuality=function(){return this.tree.GetAreaRatio()},i.prototype.ShiftOrigin=function(t){this.tree.ShiftOrigin(t)},i.prototype.BufferMove=function(t){this.moveBuffer[this.moveCount]=t,++this.moveCount},i.prototype.UnBufferMove=function(t){var e=this.moveBuffer.indexOf(t);this.moveBuffer[e]=null},i);function i(){this.tree=new t.DynamicTree,this.proxyCount=0,this.moveCount=0,this.moveBuffer=[],this.pairCount=0,this.pairBuffer=[]}t.BroadPhase=e}(b2=b2||{}),function(c){var i,t=(i=c.Shape,__extends(h,i),h.prototype.CreateLoop=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if("number"==typeof t[0][0]){var i=t[0];if(i.length%2!=0)throw new Error;return this._CreateLoop(function(t){return{x:i[2*t],y:i[2*t+1]}},i.length/2)}var s=t[0],o=t[1]||s.length;return this._CreateLoop(function(t){return s[t]},o)},h.prototype._CreateLoop=function(t,e){if(e<3)return this;this.count=e+1,this.vertices=c.Vec2.MakeArray(this.count);for(var i=0;i<e;++i)this.vertices[i].Copy(t(i));return this.vertices[e].Copy(this.vertices[0]),this.prevVertex.Copy(this.vertices[this.count-2]),this.nextVertex.Copy(this.vertices[1]),this},h.prototype.CreateChain=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if("number"==typeof t[0][0]){var i=t[0],s=t[1],o=t[2];if(i.length%2!=0)throw new Error;return this._CreateChain(function(t){return{x:i[2*t],y:i[2*t+1]}},i.length/2,s,o)}var n=t[0],r=t[1]||n.length,s=t[2],o=t[3];return this._CreateChain(function(t){return n[t]},r,s,o)},h.prototype._CreateChain=function(t,e,i,s){this.count=e,this.vertices=c.Vec2.MakeArray(e);for(var o=0;o<e;++o)this.vertices[o].Copy(t(o));return this.prevVertex.Copy(i),this.nextVertex.Copy(s),this},h.prototype.Clone=function(){return(new h).Copy(this)},h.prototype.Copy=function(e){return i.prototype.Copy.call(this,e),this._CreateChain(function(t){return e.vertices[t]},e.count,e.prevVertex,e.nextVertex),this.prevVertex.Copy(e.prevVertex),this.nextVertex.Copy(e.nextVertex),this},h.prototype.GetChildCount=function(){return this.count-1},h.prototype.GetChildEdge=function(t,e){t.radius=this.radius,t.vertex1.Copy(this.vertices[e]),t.vertex2.Copy(this.vertices[e+1]),t.oneSided=!0,0<e?t.vertex0.Copy(this.vertices[e-1]):t.vertex0.Copy(this.prevVertex),e<this.count-2?t.vertex3.Copy(this.vertices[e+2]):t.vertex3.Copy(this.nextVertex)},h.prototype.TestPoint=function(t,e){return!1},h.prototype.ComputeDistance=function(t,e,i,s){var o=h.ComputeDistance_s_edgeShape;return this.GetChildEdge(o,s),o.ComputeDistance(t,e,i,0)},h.prototype.RayCast=function(t,e,i,s){var o=h.RayCast_s_edgeShape;return o.vertex1.Copy(this.vertices[s]),o.vertex2.Copy(this.vertices[(s+1)%this.count]),o.RayCast(t,e,i,0)},h.prototype.ComputeAABB=function(t,e,i){var s=this.vertices[i],o=this.vertices[(i+1)%this.count],n=c.Transform.MulXV(e,s,h.ComputeAABB_s_v1),r=c.Transform.MulXV(e,o,h.ComputeAABB_s_v2),a=c.Vec2.MinV(n,r,h.ComputeAABB_s_lower),l=c.Vec2.MaxV(n,r,h.ComputeAABB_s_upper);t.lowerBound.x=a.x-this.radius,t.lowerBound.y=a.y-this.radius,t.upperBound.x=l.x+this.radius,t.upperBound.y=l.y+this.radius},h.prototype.ComputeMass=function(t,e){t.mass=0,t.center.SetZero(),t.I=0},h.prototype.SetupDistanceProxy=function(t,e){t.vertices=t.buffer,t.vertices[0].Copy(this.vertices[e]),e+1<this.count?t.vertices[1].Copy(this.vertices[e+1]):t.vertices[1].Copy(this.vertices[0]),t.count=2,t.radius=this.radius},h.prototype.ComputeSubmergedArea=function(t,e,i,s){return s.SetZero(),0},h.prototype.Dump=function(t){t("    const shape: ChainShape = new ChainShape();\n"),t("    const vs: Vec2[] = [];\n");for(var e=0;e<this.count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.vertices[e].x,this.vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.count),t("    shape.prevVertex.Set(%.15f, %.15f);\n",this.prevVertex.x,this.prevVertex.y),t("    shape.nextVertex.Set(%.15f, %.15f);\n",this.nextVertex.x,this.nextVertex.y)},h.ComputeDistance_s_edgeShape=new c.EdgeShape,h.RayCast_s_edgeShape=new c.EdgeShape,h.ComputeAABB_s_v1=new c.Vec2,h.ComputeAABB_s_v2=new c.Vec2,h.ComputeAABB_s_lower=new c.Vec2,h.ComputeAABB_s_upper=new c.Vec2,h);function h(){var t=i.call(this,c.ShapeType.e_chainShape,c.polygonRadius)||this;return t.vertices=[],t.count=0,t.prevVertex=new c.Vec2,t.nextVertex=new c.Vec2,t}c.ChainShape=t}(b2=b2||{}),function(p){var i,t=(i=p.Shape,__extends(f,i),f.prototype.Set=function(t,e){return void 0===e&&(e=this.radius),this.p.Copy(t),this.radius=e,this},f.prototype.Clone=function(){return(new f).Copy(this)},f.prototype.Copy=function(t){return i.prototype.Copy.call(this,t),this.p.Copy(t.p),this},f.prototype.GetChildCount=function(){return 1},f.prototype.TestPoint=function(t,e){var i=p.Transform.MulXV(t,this.p,f.TestPoint_s_center),s=p.Vec2.SubVV(e,i,f.TestPoint_s_d);return p.Vec2.DotVV(s,s)<=p.Sq(this.radius)},f.prototype.ComputeDistance=function(t,e,i,s){var o=p.Transform.MulXV(t,this.p,f.ComputeDistance_s_center);return p.Vec2.SubVV(e,o,i),i.Normalize()-this.radius},f.prototype.RayCast=function(t,e,i,s){var o=p.Transform.MulXV(i,this.p,f.RayCast_s_position),n=p.Vec2.SubVV(e.p1,o,f.RayCast_s_s),r=p.Vec2.DotVV(n,n)-p.Sq(this.radius),a=p.Vec2.SubVV(e.p2,e.p1,f.RayCast_s_r),l=p.Vec2.DotVV(n,a),c=p.Vec2.DotVV(a,a),h=l*l-c*r;if(h<0||c<p.epsilon)return!1;var u=-(l+p.Sqrt(h));return 0<=u&&u<=e.maxFraction*c&&(u/=c,t.fraction=u,p.Vec2.AddVMulSV(n,u,a,t.normal).SelfNormalize(),!0)},f.prototype.ComputeAABB=function(t,e,i){var s=p.Transform.MulXV(e,this.p,f.ComputeAABB_s_p);t.lowerBound.Set(s.x-this.radius,s.y-this.radius),t.upperBound.Set(s.x+this.radius,s.y+this.radius)},f.prototype.ComputeMass=function(t,e){var i=p.Sq(this.radius);t.mass=e*p.pi*i,t.center.Copy(this.p),t.I=t.mass*(.5*i+p.Vec2.DotVV(this.p,this.p))},f.prototype.SetupDistanceProxy=function(t,e){t.vertices=t.buffer,t.vertices[0].Copy(this.p),t.count=1,t.radius=this.radius},f.prototype.ComputeSubmergedArea=function(t,e,i,s){var o=p.Transform.MulXV(i,this.p,new p.Vec2),n=-(p.Vec2.DotVV(t,o)-e);if(n<-this.radius+p.epsilon)return 0;if(n>this.radius)return s.Copy(o),p.pi*this.radius*this.radius;var r=this.radius*this.radius,a=n*n,l=r*(p.Asin(n/this.radius)+p.pi/2)+n*p.Sqrt(r-a),c=-2/3*p.Pow(r-a,1.5)/l;return s.x=o.x+t.x*c,s.y=o.y+t.y*c,l},f.prototype.Dump=function(t){t("    const shape: CircleShape = new CircleShape();\n"),t("    shape.radius = %.15f;\n",this.radius),t("    shape.p.Set(%.15f, %.15f);\n",this.p.x,this.p.y)},f.TestPoint_s_center=new p.Vec2,f.TestPoint_s_d=new p.Vec2,f.ComputeDistance_s_center=new p.Vec2,f.RayCast_s_position=new p.Vec2,f.RayCast_s_s=new p.Vec2,f.RayCast_s_r=new p.Vec2,f.ComputeAABB_s_p=new p.Vec2,f);function f(t){void 0===t&&(t=0);var e=i.call(this,p.ShapeType.e_circleShape,t)||this;return e.p=new p.Vec2,e}p.CircleShape=t}(b2=b2||{}),function(C){var c=new C.Vec2,h=new C.Vec2;C.CollideCircles=function(t,e,i,s,o){t.pointCount=0;var n=C.Transform.MulXV(i,e.p,c),r=C.Transform.MulXV(o,s.p,h),a=C.Vec2.DistanceSquaredVV(n,r),l=e.radius+s.radius;l*l<a||(t.type=C.ManifoldType.e_circles,t.localPoint.Copy(e.p),t.localNormal.SetZero(),t.pointCount=1,t.points[0].localPoint.Copy(s.p),t.points[0].id.key=0)};var m=new C.Vec2,g=new C.Vec2,w=new C.Vec2;C.CollidePolygonAndCircle=function(t,e,i,s,o){t.pointCount=0;for(var n=C.Transform.MulXV(o,s.p,m),r=C.Transform.MulTXV(i,n,g),a=0,l=-C.maxFloat,c=e.radius+s.radius,h=e.count,u=e.vertices,p=e.normals,f=0;f<h;++f){var d=C.Vec2.DotVV(p[f],C.Vec2.SubVV(r,u[f],C.Vec2.s_t0));if(c<d)return;l<d&&(l=d,a=f)}var y=a,V=(y+1)%h,v=u[y],x=u[V];if(l<C.epsilon)return t.pointCount=1,t.type=C.ManifoldType.e_faceA,t.localNormal.Copy(p[a]),C.Vec2.MidVV(v,x,t.localPoint),t.points[0].localPoint.Copy(s.p),void(t.points[0].id.key=0);var S=C.Vec2.DotVV(C.Vec2.SubVV(r,v,C.Vec2.s_t0),C.Vec2.SubVV(x,v,C.Vec2.s_t1)),B=C.Vec2.DotVV(C.Vec2.SubVV(r,x,C.Vec2.s_t0),C.Vec2.SubVV(v,x,C.Vec2.s_t1));if(S<=0){if(C.Vec2.DistanceSquaredVV(r,v)>c*c)return;t.pointCount=1,t.type=C.ManifoldType.e_faceA,C.Vec2.SubVV(r,v,t.localNormal).SelfNormalize(),t.localPoint.Copy(v),t.points[0].localPoint.Copy(s.p),t.points[0].id.key=0}else if(B<=0){if(C.Vec2.DistanceSquaredVV(r,x)>c*c)return;t.pointCount=1,t.type=C.ManifoldType.e_faceA,C.Vec2.SubVV(r,x,t.localNormal).SelfNormalize(),t.localPoint.Copy(x),t.points[0].localPoint.Copy(s.p),t.points[0].id.key=0}else{var A=C.Vec2.MidVV(v,x,w);if(c<C.Vec2.DotVV(C.Vec2.SubVV(r,A,C.Vec2.s_t1),p[y]))return;t.pointCount=1,t.type=C.ManifoldType.e_faceA,t.localNormal.Copy(p[y]).SelfNormalize(),t.localPoint.Copy(A),t.points[0].localPoint.Copy(s.p),t.points[0].id.key=0}}}(b2=b2||{}),function(k){var q,t,M=new k.Vec2,P=new k.Vec2,I=new k.Vec2,D=new k.Vec2,G=new k.Vec2,T=new k.Vec2,F=new k.Vec2,R=new k.ContactID;k.CollideEdgeAndCircle=function(t,e,i,s,o){t.pointCount=0;var n=k.Transform.MulTXV(i,k.Transform.MulXV(o,s.p,k.Vec2.s_t0),M),r=e.vertex1,a=e.vertex2,l=k.Vec2.SubVV(a,r,P),c=F.Set(l.y,-l.x),h=k.Vec2.DotVV(c,k.Vec2.SubVV(n,r,k.Vec2.s_t0));if(!(e.oneSided&&h<0)){var u=k.Vec2.DotVV(l,k.Vec2.SubVV(a,n,k.Vec2.s_t0)),p=k.Vec2.DotVV(l,k.Vec2.SubVV(n,r,k.Vec2.s_t0)),f=e.radius+s.radius,d=R;if(d.cf.indexB=0,d.cf.typeB=k.ContactFeatureType.e_vertex,p<=0){var y=r,V=k.Vec2.SubVV(n,y,I);if(f*f<k.Vec2.DotVV(V,V))return;if(e.oneSided){var v=e.vertex0,x=r,S=k.Vec2.SubVV(x,v,D);if(0<k.Vec2.DotVV(S,k.Vec2.SubVV(x,n,k.Vec2.s_t0)))return}return d.cf.indexA=0,d.cf.typeA=k.ContactFeatureType.e_vertex,t.pointCount=1,t.type=k.ManifoldType.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(y),t.points[0].id.Copy(d),void t.points[0].localPoint.Copy(s.p)}if(u<=0){var B=a,A=k.Vec2.SubVV(n,B,I);if(f*f<k.Vec2.DotVV(A,A))return;if(e.oneSided){var C=e.vertex3,m=a,g=k.Vec2.SubVV(C,m,G);if(0<k.Vec2.DotVV(g,k.Vec2.SubVV(n,m,k.Vec2.s_t0)))return}return d.cf.indexA=1,d.cf.typeA=k.ContactFeatureType.e_vertex,t.pointCount=1,t.type=k.ManifoldType.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(B),t.points[0].id.Copy(d),void t.points[0].localPoint.Copy(s.p)}var w=k.Vec2.DotVV(l,l),_=T;_.x=1/w*(u*r.x+p*a.x),_.y=1/w*(u*r.y+p*a.y);var b=k.Vec2.SubVV(n,_,I);f*f<k.Vec2.DotVV(b,b)||(h<0&&c.Set(-c.x,-c.y),c.Normalize(),d.cf.indexA=0,d.cf.typeA=k.ContactFeatureType.e_face,t.pointCount=1,t.type=k.ManifoldType.e_faceA,t.localNormal.Copy(c),t.localPoint.Copy(r),t.points[0].id.Copy(d),t.points[0].localPoint.Copy(s.p))}},(t=q=q||{})[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB";var e=function(){this.normal=new k.Vec2,this.type=q.e_unknown,this.index=0,this.separation=0},i=function(){this.vertices=[],this.normals=[],this.count=0},s=function(){this.i1=0,this.i2=0,this.v1=new k.Vec2,this.v2=new k.Vec2,this.normal=new k.Vec2,this.sideNormal1=new k.Vec2,this.sideOffset1=0,this.sideNormal2=new k.Vec2,this.sideOffset2=0},J=new e,E=[new k.Vec2,new k.Vec2];var z=new e,j=new k.Vec2;var N=new k.Transform,O=new k.Vec2,X=new k.Vec2,Z=new k.Vec2,U=new k.Vec2,W=new k.Vec2,Q=new k.Vec2,Y=new k.Vec2,K=new i,H=new s,$=[new k.ClipVertex,new k.ClipVertex],tt=[new k.ClipVertex,new k.ClipVertex],et=[new k.ClipVertex,new k.ClipVertex];k.CollideEdgeAndPolygon=function(t,e,i,s,o){t.pointCount=0;var n=k.Transform.MulTXX(i,o,N),r=k.Transform.MulXV(n,s.centroid,O),a=e.vertex1,l=e.vertex2,c=k.Vec2.SubVV(l,a,X);c.Normalize();var h=Z.Set(c.y,-c.x),u=k.Vec2.DotVV(h,k.Vec2.SubVV(r,a,k.Vec2.s_t0)),p=e.oneSided;if(!(p&&u<0)){var f=K;f.count=s.count;for(var d=0;d<s.count;++d)f.vertices.length<=d&&f.vertices.push(new k.Vec2),f.normals.length<=d&&f.normals.push(new k.Vec2),k.Transform.MulXV(n,s.vertices[d],f.vertices[d]),k.Rot.MulRV(n.q,s.normals[d],f.normals[d]);var y=s.radius+e.radius,V=function(t,e,i){var s=J;s.type=q.e_edgeA,s.index=-1,s.separation=-Number.MAX_VALUE,s.normal.SetZero();var o=E;o[0].Copy(i),o[1].Copy(i).SelfNeg();for(var n=0;n<2;++n){for(var r=Number.MAX_VALUE,a=0;a<t.count;++a){var l=k.Vec2.DotVV(o[n],k.Vec2.SubVV(t.vertices[a],e,k.Vec2.s_t0));l<r&&(r=l)}r>s.separation&&(s.index=n,s.separation=r,s.normal.Copy(o[n]))}return s}(f,a,h);if(!(V.separation>y)){var v=function(t,e,i){var s=z;s.type=q.e_unknown,s.index=-1,s.separation=-Number.MAX_VALUE,s.normal.SetZero();for(var o=0;o<t.count;++o){var n=k.Vec2.NegV(t.normals[o],j),r=k.Vec2.DotVV(n,k.Vec2.SubVV(t.vertices[o],e,k.Vec2.s_t0)),a=k.Vec2.DotVV(n,k.Vec2.SubVV(t.vertices[o],i,k.Vec2.s_t0)),l=k.Min(r,a);l>s.separation&&(s.type=q.e_edgeB,s.index=o,s.separation=l,s.normal.Copy(n))}return s}(f,a,l);if(!(v.separation>y)){var x=v.separation-y>.98*(V.separation-y)+.001?v:V;if(p){var S=k.Vec2.SubVV(a,e.vertex0,U);S.Normalize();var B=W.Set(S.y,-S.x),A=0<=k.Vec2.CrossVV(S,c),C=k.Vec2.SubVV(e.vertex3,l,Q);C.Normalize();var m=Y.Set(C.y,-C.x),g=0<=k.Vec2.CrossVV(c,C);if(k.Vec2.DotVV(x.normal,c)<=0)if(A){if(.1<k.Vec2.CrossVV(x.normal,B))return}else x=V;else if(g){if(.1<k.Vec2.CrossVV(m,x.normal))return}else x=V}var w=$,_=H;if(x.type===q.e_edgeA){t.type=k.ManifoldType.e_faceA;for(var b=0,M=k.Vec2.DotVV(x.normal,f.normals[0]),d=1;d<f.count;++d){var P=k.Vec2.DotVV(x.normal,f.normals[d]);P<M&&(M=P,b=d)}var I=b,D=I+1<f.count?I+1:0;w[0].v.Copy(f.vertices[I]),w[0].id.cf.indexA=0,w[0].id.cf.indexB=I,w[0].id.cf.typeA=k.ContactFeatureType.e_face,w[0].id.cf.typeB=k.ContactFeatureType.e_vertex,w[1].v.Copy(f.vertices[D]),w[1].id.cf.indexA=0,w[1].id.cf.indexB=D,w[1].id.cf.typeA=k.ContactFeatureType.e_face,w[1].id.cf.typeB=k.ContactFeatureType.e_vertex,_.i1=0,_.i2=1,_.v1.Copy(a),_.v2.Copy(l),_.normal.Copy(x.normal),_.sideNormal1.Copy(c).SelfNeg(),_.sideNormal2.Copy(c)}else t.type=k.ManifoldType.e_faceB,w[0].v.Copy(l),w[0].id.cf.indexA=1,w[0].id.cf.indexB=x.index,w[0].id.cf.typeA=k.ContactFeatureType.e_vertex,w[0].id.cf.typeB=k.ContactFeatureType.e_face,w[1].v.Copy(a),w[1].id.cf.indexA=0,w[1].id.cf.indexB=x.index,w[1].id.cf.typeA=k.ContactFeatureType.e_vertex,w[1].id.cf.typeB=k.ContactFeatureType.e_face,_.i1=x.index,_.i2=_.i1+1<f.count?_.i1+1:0,_.v1.Copy(f.vertices[_.i1]),_.v2.Copy(f.vertices[_.i2]),_.normal.Copy(f.normals[_.i1]),_.sideNormal1.Set(_.normal.y,-_.normal.x),_.sideNormal2.Copy(_.sideNormal1).SelfNeg();_.sideOffset1=k.Vec2.DotVV(_.sideNormal1,_.v1),_.sideOffset2=k.Vec2.DotVV(_.sideNormal2,_.v2);var G=tt,T=et,F=k.ClipSegmentToLine(G,w,_.sideNormal1,_.sideOffset1,_.i1);if(!(F<k.maxManifoldPoints||k.ClipSegmentToLine(T,G,_.sideNormal2,_.sideOffset2,_.i2)<k.maxManifoldPoints)){x.type===q.e_edgeA?(t.localNormal.Copy(_.normal),t.localPoint.Copy(_.v1)):(t.localNormal.Copy(s.normals[_.i1]),t.localPoint.Copy(s.vertices[_.i1]));for(var R,L=0,d=0;d<k.maxManifoldPoints;++d){k.Vec2.DotVV(_.normal,k.Vec2.SubVV(T[d].v,_.v1,k.Vec2.s_t0))<=y&&(R=t.points[L],x.type===q.e_edgeA?(k.Transform.MulTXV(n,T[d].v,R.localPoint),R.id.Copy(T[d].id)):(R.localPoint.Copy(T[d].v),R.id.cf.typeA=T[d].id.cf.typeB,R.id.cf.typeB=T[d].id.cf.typeA,R.id.cf.indexA=T[d].id.cf.indexB,R.id.cf.indexB=T[d].id.cf.indexA),++L)}t.pointCount=L}}}}}}(b2=b2||{}),function(j){var S=new j.Transform,B=new j.Vec2,A=new j.Vec2;function N(t,e,i,s,o){for(var n=e.count,r=s.count,a=e.normals,l=e.vertices,c=s.vertices,h=j.Transform.MulTXX(o,i,S),u=0,p=-j.maxFloat,f=0;f<n;++f){for(var d=j.Rot.MulRV(h.q,a[f],B),y=j.Transform.MulXV(h,l[f],A),V=j.maxFloat,v=0;v<r;++v){var x=j.Vec2.DotVV(d,j.Vec2.SubVV(c[v],y,j.Vec2.s_t0));x<V&&(V=x)}p<V&&(p=V,u=f)}return t[0]=u,p}var O=new j.Vec2;var X=[new j.ClipVertex,new j.ClipVertex],Z=[new j.ClipVertex,new j.ClipVertex],U=[new j.ClipVertex,new j.ClipVertex],W=[0],Q=[0],Y=new j.Vec2,K=new j.Vec2,H=new j.Vec2,$=new j.Vec2,tt=new j.Vec2,et=new j.Vec2,it=new j.Vec2,st=new j.Vec2;j.CollidePolygons=function(t,e,i,s,o){t.pointCount=0;var n=e.radius+s.radius,r=W;r[0]=0;var a=N(r,e,i,s,o);if(!(n<a)){var l=Q;l[0]=0;var c=N(l,s,o,e,i);if(!(n<c)){var h,u,p,f,d=0,y=0,y=a+.1*j.linearSlop<c?(h=s,u=e,p=o,f=i,d=l[0],t.type=j.ManifoldType.e_faceB,1):(h=e,u=s,p=i,f=o,d=r[0],t.type=j.ManifoldType.e_faceA,0),V=X;!function(t,e,i,s,o,n){for(var r=e.normals,a=o.count,l=o.vertices,c=o.normals,h=j.Rot.MulTRV(n.q,j.Rot.MulRV(i.q,r[s],j.Vec2.s_t0),O),u=0,p=j.maxFloat,f=0;f<a;++f){var d=j.Vec2.DotVV(h,c[f]);d<p&&(p=d,u=f)}var y=u,V=y+1<a?y+1:0,v=t[0];j.Transform.MulXV(n,l[y],v.v);var x=v.id.cf;x.indexA=s,x.indexB=y,x.typeA=j.ContactFeatureType.e_face,x.typeB=j.ContactFeatureType.e_vertex;var S=t[1];j.Transform.MulXV(n,l[V],S.v);var B=S.id.cf;B.indexA=s,B.indexB=V,B.typeA=j.ContactFeatureType.e_face,B.typeB=j.ContactFeatureType.e_vertex}(V,h,p,d,u,f);var v=h.count,x=h.vertices,S=d,B=d+1<v?d+1:0,A=x[S],C=x[B],m=j.Vec2.SubVV(C,A,Y);m.Normalize();var g=j.Vec2.CrossVOne(m,K),w=j.Vec2.MidVV(A,C,H),_=j.Rot.MulRV(p.q,m,tt),b=j.Vec2.CrossVOne(_,$),M=j.Transform.MulXV(p,A,it),P=j.Transform.MulXV(p,C,st),I=j.Vec2.DotVV(b,M),D=-j.Vec2.DotVV(_,M)+n,G=j.Vec2.DotVV(_,P)+n,T=Z,F=U,R=j.Vec2.NegV(_,et),L=j.ClipSegmentToLine(T,V,R,D,S);if(!(L<2||j.ClipSegmentToLine(F,T,_,G,B)<2)){t.localNormal.Copy(g),t.localPoint.Copy(w);for(var k=0,q=0;q<j.maxManifoldPoints;++q){var J,E,z=F[q];j.Vec2.DotVV(b,z.v)-I<=n&&(J=t.points[k],j.Transform.MulTXV(f,z.v,J.localPoint),J.id.Copy(z.id),y&&(E=J.id.cf,J.id.cf.indexA=E.indexB,J.id.cf.indexB=E.indexA,J.id.cf.typeA=E.typeB,J.id.cf.typeB=E.typeA),++k)}t.pointCount=k}}}}}(b2=b2||{}),function(v){function x(t){if(null===t)throw new Error;return t}var e=(Object.defineProperty(t.prototype,"userData",{get:function(){if(null===this._userData)throw new Error;return this._userData},set:function(t){if(null!==this._userData)throw new Error;this._userData=t},enumerable:!0,configurable:!0}),t.prototype.Reset=function(){this._userData=null},t.prototype.IsLeaf=function(){return null===this.child1},t);function t(t){void 0===t&&(t=0),this.id=0,this.aabb=new v.AABB,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.moved=!1,this.id=t}v.TreeNode=e;var i=(S.prototype.Query=function(t,e){var i=this.stack.Reset();for(i.Push(this.root);0<i.GetCount();){var s=i.Pop();if(null!==s)if(s.aabb.TestOverlap(t))if(s.IsLeaf()){if(!e(s))return}else i.Push(s.child1),i.Push(s.child2)}},S.prototype.QueryPoint=function(t,e){var i=this.stack.Reset();for(i.Push(this.root);0<i.GetCount();){var s=i.Pop();if(null!==s)if(s.aabb.TestContain(t))if(s.IsLeaf()){if(!e(s))return}else i.Push(s.child1),i.Push(s.child2)}},S.prototype.RayCast=function(t,e){var i=t.p1,s=t.p2,o=v.Vec2.SubVV(s,i,S.s_r);o.Normalize();var n=v.Vec2.CrossOneV(o,S.s_v),r=v.Vec2.AbsV(n,S.s_abs_v),a=t.maxFraction,l=S.s_segmentAABB,c=i.x+a*(s.x-i.x),h=i.y+a*(s.y-i.y);l.lowerBound.x=v.Min(i.x,c),l.lowerBound.y=v.Min(i.y,h),l.upperBound.x=v.Max(i.x,c),l.upperBound.y=v.Max(i.y,h);var u=this.stack.Reset();for(u.Push(this.root);0<u.GetCount();){var p=u.Pop();if(null!==p&&v.TestOverlapAABB(p.aabb,l)){var f=p.aabb.GetCenter(),d=p.aabb.GetExtents();if(!(0<v.Abs(v.Vec2.DotVV(n,v.Vec2.SubVV(i,f,v.Vec2.s_t0)))-v.Vec2.DotVV(r,d)))if(p.IsLeaf()){var y=S.s_subInput;y.p1.Copy(t.p1),y.p2.Copy(t.p2),y.maxFraction=a;var V=e(y,p);if(0===V)return;0<V&&(a=V,c=i.x+a*(s.x-i.x),h=i.y+a*(s.y-i.y),l.lowerBound.x=v.Min(i.x,c),l.lowerBound.y=v.Min(i.y,h),l.upperBound.x=v.Max(i.x,c),l.upperBound.y=v.Max(i.y,h))}else u.Push(p.child1),u.Push(p.child2)}}},S.prototype.AllocateNode=function(){if(null===this.freeList)return new e(S.s_node_id++);var t=this.freeList;return this.freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t.moved=!1,t},S.prototype.FreeNode=function(t){t.parent=this.freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.freeList=t},S.prototype.CreateProxy=function(t,e){var i=this.AllocateNode(),s=v.aabbExtension,o=v.aabbExtension;return i.aabb.lowerBound.x=t.lowerBound.x-s,i.aabb.lowerBound.y=t.lowerBound.y-o,i.aabb.upperBound.x=t.upperBound.x+s,i.aabb.upperBound.y=t.upperBound.y+o,i.userData=e,i.height=0,i.moved=!0,this.InsertLeaf(i),i},S.prototype.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},S.prototype.MoveProxy=function(t,e,i){var s=S.MoveProxy_s_fatAABB,o=v.aabbExtension,n=v.aabbExtension;s.lowerBound.x=e.lowerBound.x-o,s.lowerBound.y=e.lowerBound.y-n,s.upperBound.x=e.upperBound.x+o,s.upperBound.y=e.upperBound.y+n;var r=v.aabbMultiplier*i.x,a=v.aabbMultiplier*i.y;r<0?s.lowerBound.x+=r:s.upperBound.x+=r,a<0?s.lowerBound.y+=a:s.upperBound.y+=a;var l=t.aabb;if(l.Contains(e)){var c=S.MoveProxy_s_hugeAABB;if(c.lowerBound.x=s.lowerBound.x-4*o,c.lowerBound.y=s.lowerBound.y-4*n,c.upperBound.x=s.upperBound.x+4*o,c.upperBound.y=s.upperBound.y+4*n,c.Contains(l))return!1}return this.RemoveLeaf(t),t.aabb.Copy(s),this.InsertLeaf(t),t.moved=!0},S.prototype.InsertLeaf=function(t){if(++this.insertionCount,null===this.root)return this.root=t,void(this.root.parent=null);for(var e=t.aabb,i=this.root;!i.IsLeaf();){var s=x(i.child1),o=x(i.child2),n=i.aabb.GetPerimeter(),r=S.s_combinedAABB;r.Combine2(i.aabb,e);var a=r.GetPerimeter(),l=2*a,c=2*(a-n),h=void 0,u=S.s_aabb,p=void 0,h=s.IsLeaf()?(u.Combine2(e,s.aabb),u.GetPerimeter()+c):(u.Combine2(e,s.aabb),p=s.aabb.GetPerimeter(),u.GetPerimeter()-p+c),f=void 0,f=o.IsLeaf()?(u.Combine2(e,o.aabb),u.GetPerimeter()+c):(u.Combine2(e,o.aabb),p=o.aabb.GetPerimeter(),u.GetPerimeter()-p+c);if(l<h&&l<f)break;i=h<f?s:o}var d=i.parent,y=this.AllocateNode();y.parent=d,y.aabb.Combine2(e,i.aabb),y.height=i.height+1,null!==d?(d.child1===i?d.child1=y:d.child2=y,y.child1=i,y.child2=t,i.parent=y,t.parent=y):(y.child1=i,y.child2=t,i.parent=y,t.parent=y,this.root=y);for(var V=t.parent;null!==V;){s=x((V=this.Balance(V)).child1),o=x(V.child2);V.height=1+v.Max(s.height,o.height),V.aabb.Combine2(s.aabb,o.aabb),V=V.parent}},S.prototype.RemoveLeaf=function(t){if(t!==this.root){var e=x(t.parent),i=e&&e.parent,s=x(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=s:i.child2=s,s.parent=i,this.FreeNode(e);for(var o=i;null!==o;){var n=x((o=this.Balance(o)).child1),r=x(o.child2);o.aabb.Combine2(n.aabb,r.aabb),o.height=1+v.Max(n.height,r.height),o=o.parent}}else(this.root=s).parent=null,this.FreeNode(e)}else this.root=null},S.prototype.Balance=function(t){if(t.IsLeaf()||t.height<2)return t;var e=x(t.child1),i=x(t.child2),s=i.height-e.height;if(1<s){var o=x(i.child1),n=x(i.child2);return i.child1=t,i.parent=t.parent,null!==(t.parent=i).parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.root=i,o.height>n.height?(i.child2=o,((t.child2=n).parent=t).aabb.Combine2(e.aabb,n.aabb),i.aabb.Combine2(t.aabb,o.aabb),t.height=1+v.Max(e.height,n.height),i.height=1+v.Max(t.height,o.height)):(i.child2=n,((t.child2=o).parent=t).aabb.Combine2(e.aabb,o.aabb),i.aabb.Combine2(t.aabb,n.aabb),t.height=1+v.Max(e.height,o.height),i.height=1+v.Max(t.height,n.height)),i}if(s<-1){var r=x(e.child1),a=x(e.child2);return e.child1=t,e.parent=t.parent,null!==(t.parent=e).parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.root=e,r.height>a.height?(e.child2=r,((t.child1=a).parent=t).aabb.Combine2(i.aabb,a.aabb),e.aabb.Combine2(t.aabb,r.aabb),t.height=1+v.Max(i.height,a.height),e.height=1+v.Max(t.height,r.height)):(e.child2=a,((t.child1=r).parent=t).aabb.Combine2(i.aabb,r.aabb),e.aabb.Combine2(t.aabb,a.aabb),t.height=1+v.Max(i.height,r.height),e.height=1+v.Max(t.height,a.height)),e}return t},S.prototype.GetHeight=function(){return null===this.root?0:this.root.height},S.GetAreaNode=function(t){if(null===t)return 0;if(t.IsLeaf())return 0;var e=t.aabb.GetPerimeter();return e+=S.GetAreaNode(t.child1),e+=S.GetAreaNode(t.child2)},S.prototype.GetAreaRatio=function(){if(null===this.root)return 0;var t=this.root.aabb.GetPerimeter();return S.GetAreaNode(this.root)/t},S.ComputeHeightNode=function(t){if(null===t)return 0;if(t.IsLeaf())return 0;var e=S.ComputeHeightNode(t.child1),i=S.ComputeHeightNode(t.child2);return 1+v.Max(e,i)},S.prototype.ComputeHeight=function(){return S.ComputeHeightNode(this.root)},S.prototype.ValidateStructure=function(t){var e,i;null!==t&&(this.root,t.IsLeaf()||(e=x(t.child1),i=x(t.child2),this.ValidateStructure(e),this.ValidateStructure(i)))},S.prototype.ValidateMetrics=function(t){var e,i;null!==t&&(t.IsLeaf()||(e=x(t.child1),i=x(t.child2),S.s_aabb.Combine2(e.aabb,i.aabb),this.ValidateMetrics(e),this.ValidateMetrics(i)))},S.prototype.Validate=function(){},S.GetMaxBalanceNode=function(t,e){if(null===t)return e;if(t.height<=1)return e;var i=x(t.child1),s=x(t.child2),o=v.Abs(s.height-i.height);return v.Max(e,o)},S.prototype.GetMaxBalance=function(){return S.GetMaxBalanceNode(this.root,0)},S.prototype.RebuildBottomUp=function(){this.Validate()},S.ShiftOriginNode=function(t,e){var i,s;null!==t&&(t.height<=1||(i=t.child1,s=t.child2,S.ShiftOriginNode(i,e),S.ShiftOriginNode(s,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)))},S.prototype.ShiftOrigin=function(t){S.ShiftOriginNode(this.root,t)},S.s_r=new v.Vec2,S.s_v=new v.Vec2,S.s_abs_v=new v.Vec2,S.s_segmentAABB=new v.AABB,S.s_subInput=new v.RayCastInput,S.s_combinedAABB=new v.AABB,S.s_aabb=new v.AABB,S.s_node_id=0,S.MoveProxy_s_fatAABB=new v.AABB,S.MoveProxy_s_hugeAABB=new v.AABB,S);function S(){this.root=null,this.freeList=null,this.insertionCount=0,this.stack=new v.GrowableStack(256)}v.DynamicTree=i}(b2=b2||{}),function(_){var i,t=(i=_.Shape,__extends(b,i),b.prototype.Clone=function(){return(new b).Copy(this)},b.prototype.Copy=function(t){i.prototype.Copy.call(this,t),this.centroid.Copy(t.centroid),this.count=t.count,this.vertices=_.Vec2.MakeArray(this.count),this.normals=_.Vec2.MakeArray(this.count);for(var e=0;e<this.count;++e)this.vertices[e].Copy(t.vertices[e]),this.normals[e].Copy(t.normals[e]);return this},b.prototype.GetChildCount=function(){return 1},b.prototype.Set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if("number"==typeof t[0][0]){var i=t[0];if(i.length%2!=0)throw new Error;return this._Set(function(t){return{x:i[2*t],y:i[2*t+1]}},i.length/2)}var s=t[0],o=t[1]||s.length;return this._Set(function(t){return s[t]},o)},b.prototype._Set=function(t,e){if(e<3)return this.SetAsBox(1,1);for(var i=e,s=[],o=0;o<i;++o){for(var n=t(o),r=!0,a=0;a<s.length;++a)if(_.Vec2.DistanceSquaredVV(n,s[a])<.5*_.linearSlop*(.5*_.linearSlop)){r=!1;break}r&&s.push(n)}if((i=s.length)<3)return this.SetAsBox(1,1);for(var l=0,c=s[0].x,o=1;o<i;++o){var h=s[o].x;(c<h||h===c&&s[o].y<s[l].y)&&(l=o,c=h)}for(var u=[],p=0,f=l;;){u[p]=f;for(var d,y,V=0,a=1;a<i;++a){V!==f?(d=_.Vec2.SubVV(s[V],s[u[p]],b.Set_s_r),n=_.Vec2.SubVV(s[a],s[u[p]],b.Set_s_v),(y=_.Vec2.CrossVV(d,n))<0&&(V=a),0===y&&n.LengthSquared()>d.LengthSquared()&&(V=a)):V=a}if(++p,(f=V)===l)break}this.count=p,this.vertices=_.Vec2.MakeArray(this.count),this.normals=_.Vec2.MakeArray(this.count);for(o=0;o<p;++o)this.vertices[o].Copy(s[u[o]]);for(o=0;o<p;++o){var v=this.vertices[o],x=this.vertices[(o+1)%p],S=_.Vec2.SubVV(x,v,_.Vec2.s_t0);_.Vec2.CrossVOne(S,this.normals[o]).SelfNormalize()}return b.ComputeCentroid(this.vertices,p,this.centroid),this},b.prototype.SetAsBox=function(t,e,i,s){if(void 0===s&&(s=0),this.count=4,this.vertices=_.Vec2.MakeArray(this.count),this.normals=_.Vec2.MakeArray(this.count),this.vertices[0].Set(-t,-e),this.vertices[1].Set(t,-e),this.vertices[2].Set(t,e),this.vertices[3].Set(-t,e),this.normals[0].Set(0,-1),this.normals[1].Set(1,0),this.normals[2].Set(0,1),this.normals[3].Set(-1,0),this.centroid.SetZero(),i){this.centroid.Copy(i);var o=new _.Transform;o.SetPosition(i),o.SetRotationAngle(s);for(var n=0;n<this.count;++n)_.Transform.MulXV(o,this.vertices[n],this.vertices[n]),_.Rot.MulRV(o.q,this.normals[n],this.normals[n])}return this},b.prototype.TestPoint=function(t,e){for(var i=_.Transform.MulTXV(t,e,b.TestPoint_s_pLocal),s=0;s<this.count;++s){if(0<_.Vec2.DotVV(this.normals[s],_.Vec2.SubVV(i,this.vertices[s],_.Vec2.s_t0)))return!1}return!0},b.prototype.ComputeDistance=function(t,e,i,s){for(var o=_.Transform.MulTXV(t,e,b.ComputeDistance_s_pLocal),n=-_.maxFloat,r=b.ComputeDistance_s_normalForMaxDistance.Copy(o),a=0;a<this.count;++a){var l=_.Vec2.DotVV(this.normals[a],_.Vec2.SubVV(o,this.vertices[a],_.Vec2.s_t0));n<l&&(n=l,r.Copy(this.normals[a]))}if(0<n){for(var c=b.ComputeDistance_s_minDistance.Copy(r),h=n*n,a=0;a<this.count;++a){var u=_.Vec2.SubVV(o,this.vertices[a],b.ComputeDistance_s_distance),p=u.LengthSquared();p<h&&(c.Copy(u),h=p)}return _.Rot.MulRV(t.q,c,i),i.Normalize(),Math.sqrt(h)}return _.Rot.MulRV(t.q,r,i),n},b.prototype.RayCast=function(t,e,i,s){for(var o=_.Transform.MulTXV(i,e.p1,b.RayCast_s_p1),n=_.Transform.MulTXV(i,e.p2,b.RayCast_s_p2),r=_.Vec2.SubVV(n,o,b.RayCast_s_d),a=0,l=e.maxFraction,c=-1,h=0;h<this.count;++h){var u=_.Vec2.DotVV(this.normals[h],_.Vec2.SubVV(this.vertices[h],o,_.Vec2.s_t0)),p=_.Vec2.DotVV(this.normals[h],r);if(0===p){if(u<0)return!1}else p<0&&u<a*p?(a=u/p,c=h):0<p&&u<l*p&&(l=u/p);if(l<a)return!1}return 0<=c&&(t.fraction=a,_.Rot.MulRV(i.q,this.normals[c],t.normal),!0)},b.prototype.ComputeAABB=function(t,e,i){for(var s=_.Transform.MulXV(e,this.vertices[0],t.lowerBound),o=t.upperBound.Copy(s),n=0;n<this.count;++n){var r=_.Transform.MulXV(e,this.vertices[n],b.ComputeAABB_s_v);_.Vec2.MinV(r,s,s),_.Vec2.MaxV(r,o,o)}var a=this.radius;s.SelfSubXY(a,a),o.SelfAddXY(a,a)},b.prototype.ComputeMass=function(t,e){for(var i=b.ComputeMass_s_center.SetZero(),s=0,o=0,n=b.ComputeMass_s_s.Copy(this.vertices[0]),r=0;r<this.count;++r){var a=_.Vec2.SubVV(this.vertices[r],n,b.ComputeMass_s_e1),l=_.Vec2.SubVV(this.vertices[(r+1)%this.count],n,b.ComputeMass_s_e2),c=_.Vec2.CrossVV(a,l),h=.5*c;s+=h,i.SelfAdd(_.Vec2.MulSV(1/3*h,_.Vec2.AddVV(a,l,_.Vec2.s_t0),_.Vec2.s_t1));var u=a.x,p=a.y,f=l.x,d=l.y;o+=1/3*.25*c*(u*u+f*u+f*f+(p*p+d*p+d*d))}t.mass=e*s,i.SelfMul(1/s),_.Vec2.AddVV(i,n,t.center),t.I=e*o,t.I+=t.mass*(_.Vec2.DotVV(t.center,t.center)-_.Vec2.DotVV(i,i))},b.prototype.Validate=function(){for(var t=0;t<this.count;++t)for(var e=t,i=(t+1)%this.count,s=this.vertices[e],o=_.Vec2.SubVV(this.vertices[i],s,b.Validate_s_e),n=0;n<this.count;++n)if(n!==e&&n!==i){var r=_.Vec2.SubVV(this.vertices[n],s,b.Validate_s_v);if(_.Vec2.CrossVV(o,r)<0)return!1}return!0},b.prototype.SetupDistanceProxy=function(t,e){t.vertices=this.vertices,t.count=this.count,t.radius=this.radius},b.prototype.ComputeSubmergedArea=function(t,e,i,s){for(var o=_.Rot.MulTRV(i.q,t,b.ComputeSubmergedArea_s_normalL),n=e-_.Vec2.DotVV(t,i.p),r=[],a=0,l=-1,c=-1,h=!1,u=0;u<this.count;++u){r[u]=_.Vec2.DotVV(o,this.vertices[u])-n;var p=r[u]<-_.epsilon;0<u&&(p?h||(l=u-1,a++):h&&(c=u-1,a++)),h=p}switch(a){case 0:if(h){var f=b.ComputeSubmergedArea_s_md;return this.ComputeMass(f,1),_.Transform.MulXV(i,f.center,s),f.mass}return 0;case 1:-1===l?l=this.count-1:c=this.count-1}for(var d,y=(l+1)%this.count,V=(c+1)%this.count,v=(0-r[l])/(r[y]-r[l]),x=(0-r[c])/(r[V]-r[c]),S=b.ComputeSubmergedArea_s_intoVec.Set(this.vertices[l].x*(1-v)+this.vertices[y].x*v,this.vertices[l].y*(1-v)+this.vertices[y].y*v),B=b.ComputeSubmergedArea_s_outoVec.Set(this.vertices[c].x*(1-x)+this.vertices[V].x*x,this.vertices[c].y*(1-x)+this.vertices[V].y*x),A=0,C=b.ComputeSubmergedArea_s_center.SetZero(),m=this.vertices[y],g=y;g!==V;){d=(g=(g+1)%this.count)===V?B:this.vertices[g];var w=.5*((m.x-S.x)*(d.y-S.y)-(m.y-S.y)*(d.x-S.x));A+=w,C.x+=w*(S.x+m.x+d.x)/3,C.y+=w*(S.y+m.y+d.y)/3,m=d}return C.SelfMul(1/A),_.Transform.MulXV(i,C,s),A},b.prototype.Dump=function(t){t("    const shape: PolygonShape = new PolygonShape();\n"),t("    const vs: Vec2[] = [];\n");for(var e=0;e<this.count;++e)t("    vs[%d] = new Vec2(%.15f, %.15f);\n",e,this.vertices[e].x,this.vertices[e].y);t("    shape.Set(vs, %d);\n",this.count)},b.ComputeCentroid=function(t,e,i){var s=i;s.SetZero();for(var o=0,n=b.ComputeCentroid_s_s.Copy(t[0]),r=0;r<e;++r){var a=_.Vec2.SubVV(t[0],n,b.ComputeCentroid_s_p1),l=_.Vec2.SubVV(t[r],n,b.ComputeCentroid_s_p2),c=_.Vec2.SubVV(t[(r+1)%e],n,b.ComputeCentroid_s_p3),h=_.Vec2.SubVV(l,a,b.ComputeCentroid_s_e1),u=_.Vec2.SubVV(c,a,b.ComputeCentroid_s_e2),p=.5*_.Vec2.CrossVV(h,u);o+=p,s.x+=1/3*p*(a.x+l.x+c.x),s.y+=1/3*p*(a.y+l.y+c.y)}return s.x=1/o*s.x+n.x,s.y=1/o*s.y+n.y,s},b.Set_s_r=new _.Vec2,b.Set_s_v=new _.Vec2,b.TestPoint_s_pLocal=new _.Vec2,b.ComputeDistance_s_pLocal=new _.Vec2,b.ComputeDistance_s_normalForMaxDistance=new _.Vec2,b.ComputeDistance_s_minDistance=new _.Vec2,b.ComputeDistance_s_distance=new _.Vec2,b.RayCast_s_p1=new _.Vec2,b.RayCast_s_p2=new _.Vec2,b.RayCast_s_d=new _.Vec2,b.ComputeAABB_s_v=new _.Vec2,b.ComputeMass_s_center=new _.Vec2,b.ComputeMass_s_s=new _.Vec2,b.ComputeMass_s_e1=new _.Vec2,b.ComputeMass_s_e2=new _.Vec2,b.Validate_s_e=new _.Vec2,b.Validate_s_v=new _.Vec2,b.ComputeSubmergedArea_s_normalL=new _.Vec2,b.ComputeSubmergedArea_s_md=new _.MassData,b.ComputeSubmergedArea_s_intoVec=new _.Vec2,b.ComputeSubmergedArea_s_outoVec=new _.Vec2,b.ComputeSubmergedArea_s_center=new _.Vec2,b.ComputeCentroid_s_s=new _.Vec2,b.ComputeCentroid_s_p1=new _.Vec2,b.ComputeCentroid_s_p2=new _.Vec2,b.ComputeCentroid_s_p3=new _.Vec2,b.ComputeCentroid_s_e1=new _.Vec2,b.ComputeCentroid_s_e2=new _.Vec2,b);function b(){var t=i.call(this,_.ShapeType.e_polygonShape,_.polygonRadius)||this;return t.centroid=new _.Vec2(0,0),t.vertices=[],t.normals=[],t.count=0,t}_.PolygonShape=t}(b2=b2||{}),(b2||(b2={})).BlockAllocator=function(){},function(e){var t=(i.prototype.Reset=function(){return this.count=0,this},i.prototype.Push=function(t){this.stack[this.count]=t,this.count++},i.prototype.Pop=function(){this.count--;var t=this.stack[this.count];return this.stack[this.count]=null,t},i.prototype.GetCount=function(){return this.count},i);function i(t){this.stack=[],this.count=0,this.stack=e.MakeArray(t,function(t){return null}),this.count=0}e.GrowableStack=t}(b2=b2||{}),function(t){t.Alloc=function(t){return null},t.Free=function(t){},t.Log=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i]}}(b2=b2||{}),(b2||(b2={})).StackAllocator=function(){},function(f){var e,t=(e=f.Controller,__extends(i,e),i.prototype.Step=function(t){if(this.bodyList){this.useWorldGravity&&this.gravity.Copy(this.bodyList.body.GetWorld().GetGravity());for(var e=this.bodyList;e;e=e.nextBody){var i=e.body;if(i.IsAwake()){for(var s,o,n=new f.Vec2,r=new f.Vec2,a=0,l=0,c=i.GetFixtureList();c;c=c.next){var h=new f.Vec2,u=c.GetShape().ComputeSubmergedArea(this.normal,this.offset,i.GetTransform(),h);a+=u,n.x+=u*h.x,n.y+=u*h.y;var p=0;l+=u*(p=this.useDensity?c.GetDensity():1),r.x+=u*h.x*p,r.y+=u*h.y*p}n.x/=a,n.y/=a,r.x/=l,r.y/=l,a<f.epsilon||((s=this.gravity.Clone().SelfNeg()).SelfMul(this.density*a),i.ApplyForce(s,r),(o=i.GetLinearVelocityFromWorldPoint(n,new f.Vec2)).SelfSub(this.velocity),o.SelfMul(-this.linearDrag*a),i.ApplyForce(o,n),i.ApplyTorque(-i.GetInertia()/i.GetMass()*a*i.GetAngularVelocity()*this.angularDrag))}}}},i.prototype.Draw=function(t){var e=new f.Vec2,i=new f.Vec2;e.x=this.normal.x*this.offset+100*this.normal.y,e.y=this.normal.y*this.offset-100*this.normal.x,i.x=this.normal.x*this.offset-100*this.normal.y,i.y=this.normal.y*this.offset+100*this.normal.x;var s=new f.Color(0,0,.8);t.DrawSegment(e,i,s)},i);function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.normal=new f.Vec2(0,1),t.offset=0,t.density=0,t.velocity=new f.Vec2(0,0),t.linearDrag=0,t.angularDrag=0,t.useDensity=!1,t.useWorldGravity=!0,t.gravity=new f.Vec2(0,0),t}f.BuoyancyController=t}(b2=b2||{}),function(o){var e,t=(e=o.Controller,__extends(n,e),n.prototype.Step=function(t){for(var e=o.Vec2.MulSV(t.dt,this.A,n.Step_s_dtA),i=this.bodyList;i;i=i.nextBody){var s=i.body;s.IsAwake()&&s.SetLinearVelocity(o.Vec2.AddVV(s.GetLinearVelocity(),e,o.Vec2.s_t0))}},n.prototype.Draw=function(t){},n.Step_s_dtA=new o.Vec2,n);function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.A=new o.Vec2(0,0),t}o.ConstantAccelController=t}(b2=b2||{}),function(e){var i,t=(i=e.Controller,__extends(s,i),s.prototype.Step=function(t){for(var e=this.bodyList;e;e=e.nextBody){var i=e.body;i.IsAwake()&&i.ApplyForce(this.F,i.GetWorldCenter())}},s.prototype.Draw=function(t){},s);function s(){var t=null!==i&&i.apply(this,arguments)||this;return t.F=new e.Vec2(0,0),t}e.ConstantForceController=t}(b2=b2||{}),function(f){var e,t=(e=f.Controller,__extends(d,e),d.prototype.Step=function(t){if(this.invSqr)for(var e=this.bodyList;e;e=e.nextBody)for(var i=(a=e.body).GetWorldCenter(),s=a.GetMass(),o=this.bodyList;o&&o!==e;o=o.nextBody){var n=(l=o.body).GetWorldCenter(),r=l.GetMass();(u=(c=n.x-i.x)*c+(h=n.y-i.y)*h)<f.epsilon||((p=d.Step_s_f.Set(c,h)).SelfMul(this.G/u/f.Sqrt(u)*s*r),a.IsAwake()&&a.ApplyForce(p,i),l.IsAwake()&&l.ApplyForce(p.SelfMul(-1),n))}else for(e=this.bodyList;e;e=e.nextBody)for(var a,i=(a=e.body).GetWorldCenter(),s=a.GetMass(),o=this.bodyList;o&&o!==e;o=o.nextBody){var l,c,h,u,p,n=(l=o.body).GetWorldCenter(),r=l.GetMass();(u=(c=n.x-i.x)*c+(h=n.y-i.y)*h)<f.epsilon||((p=d.Step_s_f.Set(c,h)).SelfMul(this.G/u*s*r),a.IsAwake()&&a.ApplyForce(p,i),l.IsAwake()&&l.ApplyForce(p.SelfMul(-1),n))}},d.prototype.Draw=function(t){},d.Step_s_f=new f.Vec2,d);function d(){var t=null!==e&&e.apply(this,arguments)||this;return t.G=1,t.invSqr=!0,t}f.GravityController=t}(b2=b2||{}),function(n){var e,t=(e=n.Controller,__extends(r,e),r.prototype.Step=function(t){var e=t.dt;if(!(e<=n.epsilon)){e>this.maxTimestep&&0<this.maxTimestep&&(e=this.maxTimestep);for(var i=this.bodyList;i;i=i.nextBody){var s,o=i.body;o.IsAwake()&&(s=o.GetWorldVector(n.Mat22.MulMV(this.T,o.GetLocalVector(o.GetLinearVelocity(),n.Vec2.s_t0),n.Vec2.s_t1),r.Step_s_damping),o.SetLinearVelocity(n.Vec2.AddVV(o.GetLinearVelocity(),n.Vec2.MulSV(e,s,n.Vec2.s_t0),n.Vec2.s_t1)))}}},r.prototype.Draw=function(t){},r.prototype.SetAxisAligned=function(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=0<t||0<e?1/n.Max(t,e):0},r.Step_s_damping=new n.Vec2,r);function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.T=new n.Mat22,t.maxTimestep=0,t}n.TensorDampingController=t}(b2=b2||{}),function(d){var e,t=(e=d.JointDef,__extends(i,e),i.prototype.AddBody=function(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)},i);function i(){var t=e.call(this,d.JointType.e_areaJoint)||this;return t.bodies=[],t.stiffness=0,t.damping=0,t}d.AreaJointDef=t;var l,s=(l=d.Joint,__extends(o,l),o.prototype.GetAnchorA=function(t){return t},o.prototype.GetAnchorB=function(t){return t},o.prototype.GetReactionForce=function(t,e){return e},o.prototype.GetReactionTorque=function(t){return 0},o.prototype.SetStiffness=function(t){this.stiffness=t;for(var e=0;e<this.joints.length;++e)this.joints[e].SetStiffness(t)},o.prototype.GetStiffness=function(){return this.stiffness},o.prototype.SetDamping=function(t){this.damping=t;for(var e=0;e<this.joints.length;++e)this.joints[e].SetDamping(t)},o.prototype.GetDamping=function(){return this.damping},o.prototype.Dump=function(t){t("Area joint dumping is not supported.\n")},o.prototype.InitVelocityConstraints=function(t){for(var e=0;e<this.bodies.length;++e){var i=this.bodies[(e+this.bodies.length-1)%this.bodies.length],s=this.bodies[(e+1)%this.bodies.length],o=t.positions[i.islandIndex].c,n=t.positions[s.islandIndex].c,r=this.deltas[e];d.Vec2.SubVV(n,o,r)}if(t.step.warmStarting){this.impulse*=t.step.dtRatio;for(e=0;e<this.bodies.length;++e){var a=this.bodies[e],l=t.velocities[a.islandIndex].v,r=this.deltas[e];l.x+=a.invMass*r.y*.5*this.impulse,l.y+=a.invMass*-r.x*.5*this.impulse}}else this.impulse=0},o.prototype.SolveVelocityConstraints=function(t){for(var e=0,i=0,s=0;s<this.bodies.length;++s){var o=this.bodies[s],n=t.velocities[o.islandIndex].v;e+=(a=this.deltas[s]).LengthSquared()/o.GetMass(),i+=d.Vec2.CrossVV(n,a)}var r=-2*i/e;this.impulse+=r;for(s=0;s<this.bodies.length;++s){var o=this.bodies[s],n=t.velocities[o.islandIndex].v,a=this.deltas[s];n.x+=o.invMass*a.y*.5*r,n.y+=o.invMass*-a.x*.5*r}},o.prototype.SolvePositionConstraints=function(t){for(var e=0,i=0,s=0;s<this.bodies.length;++s){var o=this.bodies[s],n=this.bodies[(s+1)%this.bodies.length],r=t.positions[o.islandIndex].c,a=t.positions[n.islandIndex].c,l=(u=d.Vec2.SubVV(a,r,this.delta)).Length();l<d.epsilon&&(l=1),this.normals[s].x=u.y/l,this.normals[s].y=-u.x/l,e+=l,i+=d.Vec2.CrossVV(r,a)}i*=.5;for(var c=.5*(this.targetArea-i)/e,h=!0,s=0;s<this.bodies.length;++s){var u,o=this.bodies[s],r=t.positions[o.islandIndex].c,p=(s+1)%this.bodies.length;(u=d.Vec2.AddVV(this.normals[s],this.normals[p],this.delta)).SelfMul(c);var f=u.LengthSquared();f>d.Sq(d.maxLinearCorrection)&&u.SelfMul(d.maxLinearCorrection/d.Sqrt(f)),f>d.Sq(d.linearSlop)&&(h=!1),r.x+=u.x,r.y+=u.y}return h},o);function o(t){var e=l.call(this,t)||this;e.stiffness=0,e.damping=0,e.impulse=0,e.targetArea=0,e.delta=new d.Vec2,e.bodies=t.bodies,e.stiffness=d.Maybe(t.stiffness,0),e.damping=d.Maybe(t.damping,0),e.targetLengths=d.MakeNumberArray(t.bodies.length),e.normals=d.Vec2.MakeArray(t.bodies.length),e.joints=[],e.deltas=d.Vec2.MakeArray(t.bodies.length);var i=new d.DistanceJointDef;i.stiffness=e.stiffness,i.damping=e.damping;for(var s=e.targetArea=0;s<e.bodies.length;++s){var o=e.bodies[s],n=e.bodies[(s+1)%e.bodies.length],r=o.GetWorldCenter(),a=n.GetWorldCenter();e.targetLengths[s]=d.Vec2.DistanceVV(r,a),e.targetArea+=d.Vec2.CrossVV(r,a),i.Initialize(o,n,r,a),e.joints[s]=o.GetWorld().CreateJoint(i)}return e.targetArea*=.5,e}d.AreaJoint=s}(b2=b2||{}),function(o){var n,t;(t=n=o.BodyType||(o.BodyType={}))[t.unknown=-1]="unknown",t[t.staticBody=0]="staticBody",t[t.kinematicBody=1]="kinematicBody",t[t.dynamicBody=2]="dynamicBody";function e(){this.type=n.staticBody,this.position=new o.Vec2(0,0),this.angle=0,this.linearVelocity=new o.Vec2(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.enabled=!0,this.userData=null,this.gravityScale=1}o.BodyDef=e;var i=(r.prototype.CreateFixture=function(t,e){return void 0===e&&(e=0),t instanceof o.Shape?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)},r.prototype.CreateFixtureDef=function(t){if(this.world.IsLocked())throw new Error;var e=new o.Fixture(this,t);return this.enabledFlag&&e.CreateProxies(),e.next=this.fixtureList,this.fixtureList=e,++this.fixtureCount,0<e.density&&this.ResetMassData(),this.world.newContacts=!0,e},r.prototype.CreateFixtureShapeDensity=function(t,e){void 0===e&&(e=0);var i=r.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)},r.prototype.DestroyFixture=function(t){if(this.world.IsLocked())throw new Error;for(var e=this.fixtureList,i=null;null!==e;){if(e===t){i?i.next=t.next:this.fixtureList=t.next;break}e=(i=e).next}for(var s=this.contactList;s;){var o=s.contact,s=s.next,n=o.GetFixtureA(),r=o.GetFixtureB();t!==n&&t!==r||this.world.contactManager.Destroy(o)}this.enabledFlag&&t.DestroyProxies(),t.next=null,t.Reset(),--this.fixtureCount,this.ResetMassData()},r.prototype.SetTransformVec=function(t,e){this.SetTransformXY(t.x,t.y,e)},r.prototype.SetTransformXY=function(t,e,i){if(this.world.IsLocked())throw new Error;this.xf.q.SetAngle(i),this.xf.p.Set(t,e),this.xf0.Copy(this.xf),o.Transform.MulXV(this.xf,this.sweep.localCenter,this.sweep.c),this.sweep.a=i,this.sweep.c0.Copy(this.sweep.c),this.sweep.a0=i;for(var s=this.fixtureList;s;s=s.next)s.SynchronizeProxies(this.xf,this.xf);this.world.newContacts=!0},r.prototype.SetTransform=function(t){this.SetTransformVec(t.p,t.GetAngle())},r.prototype.GetTransform=function(){return this.xf},r.prototype.GetPosition=function(){return this.xf.p},r.prototype.SetPosition=function(t){this.SetTransformVec(t,this.GetAngle())},r.prototype.SetPositionXY=function(t,e){this.SetTransformXY(t,e,this.GetAngle())},r.prototype.GetAngle=function(){return this.sweep.a},r.prototype.SetAngle=function(t){this.SetTransformVec(this.GetPosition(),t)},r.prototype.GetWorldCenter=function(){return this.sweep.c},r.prototype.GetLocalCenter=function(){return this.sweep.localCenter},r.prototype.SetLinearVelocity=function(t){this.type!==n.staticBody&&(0<o.Vec2.DotVV(t,t)&&this.SetAwake(!0),this.linearVelocity.Copy(t))},r.prototype.GetLinearVelocity=function(){return this.linearVelocity},r.prototype.SetAngularVelocity=function(t){this.type!==n.staticBody&&(0<t*t&&this.SetAwake(!0),this.angularVelocity=t)},r.prototype.GetAngularVelocity=function(){return this.angularVelocity},r.prototype.GetDefinition=function(t){return t.type=this.GetType(),t.allowSleep=this.autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.angularDamping,t.gravityScale=this.gravityScale,t.angularVelocity=this.angularVelocity,t.fixedRotation=this.fixedRotationFlag,t.bullet=this.bulletFlag,t.awake=this.awakeFlag,t.linearDamping=this.linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t},r.prototype.ApplyForce=function(t,e,i){void 0===i&&(i=!0),this.type===n.dynamicBody&&(i&&!this.awakeFlag&&this.SetAwake(!0),this.awakeFlag&&(this.force.x+=t.x,this.force.y+=t.y,this.torque+=(e.x-this.sweep.c.x)*t.y-(e.y-this.sweep.c.y)*t.x))},r.prototype.ApplyForceToCenter=function(t,e){void 0===e&&(e=!0),this.type===n.dynamicBody&&(e&&!this.awakeFlag&&this.SetAwake(!0),this.awakeFlag&&(this.force.x+=t.x,this.force.y+=t.y))},r.prototype.ApplyTorque=function(t,e){void 0===e&&(e=!0),this.type===n.dynamicBody&&(e&&!this.awakeFlag&&this.SetAwake(!0),this.awakeFlag&&(this.torque+=t))},r.prototype.ApplyLinearImpulse=function(t,e,i){void 0===i&&(i=!0),this.type===n.dynamicBody&&(i&&!this.awakeFlag&&this.SetAwake(!0),this.awakeFlag&&(this.linearVelocity.x+=this.invMass*t.x,this.linearVelocity.y+=this.invMass*t.y,this.angularVelocity+=this.invI*((e.x-this.sweep.c.x)*t.y-(e.y-this.sweep.c.y)*t.x)))},r.prototype.ApplyLinearImpulseToCenter=function(t,e){void 0===e&&(e=!0),this.type===n.dynamicBody&&(e&&!this.awakeFlag&&this.SetAwake(!0),this.awakeFlag&&(this.linearVelocity.x+=this.invMass*t.x,this.linearVelocity.y+=this.invMass*t.y))},r.prototype.ApplyAngularImpulse=function(t,e){void 0===e&&(e=!0),this.type===n.dynamicBody&&(e&&!this.awakeFlag&&this.SetAwake(!0),this.awakeFlag&&(this.angularVelocity+=this.invI*t))},r.prototype.GetMass=function(){return this.mass},r.prototype.GetInertia=function(){return this.I+this.mass*o.Vec2.DotVV(this.sweep.localCenter,this.sweep.localCenter)},r.prototype.GetMassData=function(t){return t.mass=this.mass,t.I=this.I+this.mass*o.Vec2.DotVV(this.sweep.localCenter,this.sweep.localCenter),t.center.Copy(this.sweep.localCenter),t},r.prototype.SetMassData=function(t){if(this.world.IsLocked())throw new Error;var e;this.type===n.dynamicBody&&(this.invMass=0,this.I=0,this.invI=0,this.mass=t.mass,this.mass<=0&&(this.mass=1),this.invMass=1/this.mass,0<t.I&&!this.fixedRotationFlag&&(this.I=t.I-this.mass*o.Vec2.DotVV(t.center,t.center),this.invI=1/this.I),e=r.SetMassData_s_oldCenter.Copy(this.sweep.c),this.sweep.localCenter.Copy(t.center),o.Transform.MulXV(this.xf,this.sweep.localCenter,this.sweep.c),this.sweep.c0.Copy(this.sweep.c),o.Vec2.AddVCrossSV(this.linearVelocity,this.angularVelocity,o.Vec2.SubVV(this.sweep.c,e,o.Vec2.s_t0),this.linearVelocity))},r.prototype.ResetMassData=function(){if(this.mass=0,this.invMass=0,this.I=0,this.invI=0,this.sweep.localCenter.SetZero(),this.type===n.staticBody||this.type===n.kinematicBody)return this.sweep.c0.Copy(this.xf.p),this.sweep.c.Copy(this.xf.p),void(this.sweep.a0=this.sweep.a);for(var t,e=r.ResetMassData_s_localCenter.SetZero(),i=this.fixtureList;i;i=i.next){0!==i.density&&(t=i.GetMassData(r.ResetMassData_s_massData),this.mass+=t.mass,e.x+=t.center.x*t.mass,e.y+=t.center.y*t.mass,this.I+=t.I)}0<this.mass&&(this.invMass=1/this.mass,e.x*=this.invMass,e.y*=this.invMass),0<this.I&&!this.fixedRotationFlag?(this.I-=this.mass*o.Vec2.DotVV(e,e),this.invI=1/this.I):(this.I=0,this.invI=0);var s=r.ResetMassData_s_oldCenter.Copy(this.sweep.c);this.sweep.localCenter.Copy(e),o.Transform.MulXV(this.xf,this.sweep.localCenter,this.sweep.c),this.sweep.c0.Copy(this.sweep.c),o.Vec2.AddVCrossSV(this.linearVelocity,this.angularVelocity,o.Vec2.SubVV(this.sweep.c,s,o.Vec2.s_t0),this.linearVelocity)},r.prototype.GetWorldPoint=function(t,e){return o.Transform.MulXV(this.xf,t,e)},r.prototype.GetWorldVector=function(t,e){return o.Rot.MulRV(this.xf.q,t,e)},r.prototype.GetLocalPoint=function(t,e){return o.Transform.MulTXV(this.xf,t,e)},r.prototype.GetLocalVector=function(t,e){return o.Rot.MulTRV(this.xf.q,t,e)},r.prototype.GetLinearVelocityFromWorldPoint=function(t,e){return o.Vec2.AddVCrossSV(this.linearVelocity,this.angularVelocity,o.Vec2.SubVV(t,this.sweep.c,o.Vec2.s_t0),e)},r.prototype.GetLinearVelocityFromLocalPoint=function(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)},r.prototype.GetLinearDamping=function(){return this.linearDamping},r.prototype.SetLinearDamping=function(t){this.linearDamping=t},r.prototype.GetAngularDamping=function(){return this.angularDamping},r.prototype.SetAngularDamping=function(t){this.angularDamping=t},r.prototype.GetGravityScale=function(){return this.gravityScale},r.prototype.SetGravityScale=function(t){this.gravityScale=t},r.prototype.SetType=function(t){if(this.world.IsLocked())throw new Error;if(this.type!==t){this.type=t,this.ResetMassData(),this.type===n.staticBody&&(this.linearVelocity.SetZero(),this.angularVelocity=0,this.sweep.a0=this.sweep.a,this.sweep.c0.Copy(this.sweep.c),this.awakeFlag=!1,this.SynchronizeFixtures()),this.SetAwake(!0),this.force.SetZero(),this.torque=0;for(var e=this.contactList;e;){var i=e,e=e.next;this.world.contactManager.Destroy(i.contact)}this.contactList=null;for(var s=this.fixtureList;s;s=s.next)s.TouchProxies()}},r.prototype.GetType=function(){return this.type},r.prototype.SetBullet=function(t){this.bulletFlag=t},r.prototype.IsBullet=function(){return this.bulletFlag},r.prototype.SetSleepingAllowed=function(t){(this.autoSleepFlag=t)||this.SetAwake(!0)},r.prototype.IsSleepingAllowed=function(){return this.autoSleepFlag},r.prototype.SetAwake=function(t){this.type!==n.staticBody&&(t?(this.awakeFlag=!0,this.sleepTime=0):(this.awakeFlag=!1,this.sleepTime=0,this.linearVelocity.SetZero(),this.angularVelocity=0,this.force.SetZero(),this.torque=0))},r.prototype.IsAwake=function(){return this.awakeFlag},r.prototype.SetEnabled=function(t){if(this.world.IsLocked())throw new Error;if(t!==this.IsEnabled())if(this.enabledFlag=t){for(var e=this.fixtureList;e;e=e.next)e.CreateProxies();this.world.newContacts=!0}else{for(e=this.fixtureList;e;e=e.next)e.DestroyProxies();for(var i=this.contactList;i;){var s=i,i=i.next;this.world.contactManager.Destroy(s.contact)}this.contactList=null}},r.prototype.IsEnabled=function(){return this.enabledFlag},r.prototype.SetFixedRotation=function(t){this.fixedRotationFlag!==t&&(this.fixedRotationFlag=t,this.angularVelocity=0,this.ResetMassData())},r.prototype.IsFixedRotation=function(){return this.fixedRotationFlag},r.prototype.GetFixtureList=function(){return this.fixtureList},r.prototype.GetJointList=function(){return this.jointList},r.prototype.GetContactList=function(){return this.contactList},r.prototype.GetNext=function(){return this.next},r.prototype.GetUserData=function(){return this.userData},r.prototype.SetUserData=function(t){this.userData=t},r.prototype.GetWorld=function(){return this.world},r.prototype.Dump=function(t){var e=this.islandIndex;t("{\n"),t("  const bd: BodyDef = new BodyDef();\n");var i="";switch(this.type){case n.staticBody:i="BodyType.staticBody";break;case n.kinematicBody:i="BodyType.kinematicBody";break;case n.dynamicBody:i="BodyType.dynamicBody"}t("  bd.type = %s;\n",i),t("  bd.position.Set(%.15f, %.15f);\n",this.xf.p.x,this.xf.p.y),t("  bd.angle = %.15f;\n",this.sweep.a),t("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.linearVelocity.x,this.linearVelocity.y),t("  bd.angularVelocity = %.15f;\n",this.angularVelocity),t("  bd.linearDamping = %.15f;\n",this.linearDamping),t("  bd.angularDamping = %.15f;\n",this.angularDamping),t("  bd.allowSleep = %s;\n",this.autoSleepFlag?"true":"false"),t("  bd.awake = %s;\n",this.awakeFlag?"true":"false"),t("  bd.fixedRotation = %s;\n",this.fixedRotationFlag?"true":"false"),t("  bd.bullet = %s;\n",this.bulletFlag?"true":"false"),t("  bd.active = %s;\n",this.enabledFlag?"true":"false"),t("  bd.gravityScale = %.15f;\n",this.gravityScale),t("\n"),t("  bodies[%d] = this.world.CreateBody(bd);\n",this.islandIndex),t("\n");for(var s=this.fixtureList;s;s=s.next)t("  {\n"),s.Dump(t,e),t("  }\n");t("}\n")},r.prototype.SynchronizeFixtures=function(){if(this.awakeFlag){var t=r.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.sweep.a0),o.Rot.MulRV(t.q,this.sweep.localCenter,t.p),o.Vec2.SubVV(this.sweep.c0,t.p,t.p);for(var e=this.fixtureList;e;e=e.next)e.SynchronizeProxies(t,this.xf)}else for(e=this.fixtureList;e;e=e.next)e.SynchronizeProxies(this.xf,this.xf)},r.prototype.SynchronizeTransform=function(){this.xf.q.SetAngle(this.sweep.a),o.Rot.MulRV(this.xf.q,this.sweep.localCenter,this.xf.p),o.Vec2.SubVV(this.sweep.c,this.xf.p,this.xf.p)},r.prototype.ShouldCollide=function(t){return(this.type!==n.staticBody||t.type!==n.staticBody)&&this.ShouldCollideConnected(t)},r.prototype.ShouldCollideConnected=function(t){for(var e=this.jointList;e;e=e.next)if(e.other===t&&!e.joint.collideConnected)return!1;return!0},r.prototype.Advance=function(t){this.sweep.Advance(t),this.sweep.c.Copy(this.sweep.c0),this.sweep.a=this.sweep.a0,this.xf.q.SetAngle(this.sweep.a),o.Rot.MulRV(this.xf.q,this.sweep.localCenter,this.xf.p),o.Vec2.SubVV(this.sweep.c,this.xf.p,this.xf.p)},r.prototype.GetControllerList=function(){return this.controllerList},r.prototype.GetControllerCount=function(){return this.controllerCount},r.CreateFixtureShapeDensity_s_def=new o.FixtureDef,r.SetMassData_s_oldCenter=new o.Vec2,r.ResetMassData_s_localCenter=new o.Vec2,r.ResetMassData_s_oldCenter=new o.Vec2,r.ResetMassData_s_massData=new o.MassData,r.SynchronizeFixtures_s_xf1=new o.Transform,r);function r(t,e){this.type=n.staticBody,this.islandFlag=!1,this.awakeFlag=!1,this.autoSleepFlag=!1,this.bulletFlag=!1,this.fixedRotationFlag=!1,this.enabledFlag=!1,this.toiFlag=!1,this.islandIndex=0,this.xf=new o.Transform,this.xf0=new o.Transform,this.sweep=new o.Sweep,this.linearVelocity=new o.Vec2,this.angularVelocity=0,this.force=new o.Vec2,this.torque=0,this.prev=null,this.next=null,this.fixtureList=null,this.fixtureCount=0,this.jointList=null,this.contactList=null,this.mass=1,this.invMass=1,this.I=0,this.invI=0,this.linearDamping=0,this.angularDamping=0,this.gravityScale=1,this.sleepTime=0,this.userData=null,this.controllerList=null,this.controllerCount=0,this.bulletFlag=o.Maybe(t.bullet,!1),this.fixedRotationFlag=o.Maybe(t.fixedRotation,!1),this.autoSleepFlag=o.Maybe(t.allowSleep,!0),o.Maybe(t.awake,!1)&&o.Maybe(t.type,n.staticBody)!==n.staticBody&&(this.awakeFlag=!0),this.enabledFlag=o.Maybe(t.enabled,!0),this.world=e,this.xf.p.Copy(o.Maybe(t.position,o.Vec2.ZERO)),this.xf.q.SetAngle(o.Maybe(t.angle,0)),this.xf0.Copy(this.xf),this.sweep.localCenter.SetZero(),this.sweep.c0.Copy(this.xf.p),this.sweep.c.Copy(this.xf.p),this.sweep.a0=this.sweep.a=this.xf.q.GetAngle(),this.sweep.alpha0=0,this.linearVelocity.Copy(o.Maybe(t.linearVelocity,o.Vec2.ZERO)),this.angularVelocity=o.Maybe(t.angularVelocity,0),this.linearDamping=o.Maybe(t.linearDamping,0),this.angularDamping=o.Maybe(t.angularDamping,0),this.gravityScale=o.Maybe(t.gravityScale,1),this.force.SetZero(),this.torque=0,this.sleepTime=0,this.type=o.Maybe(t.type,n.staticBody),this.mass=0,this.invMass=0,this.I=0,this.invI=0,this.userData=t.userData,this.fixtureList=null,this.fixtureCount=0,this.controllerList=null,this.controllerCount=0}o.Body=i}(b2=b2||{}),function(o){var t,e=(t=o.Contact,__extends(n,t),n.Create=function(){return new n},n.Destroy=function(t){},n.prototype.Evaluate=function(t,e,i){var s=n.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.indexA),o.CollideEdgeAndCircle(t,s,e,this.GetShapeB(),i)},n.Evaluate_s_edge=new o.EdgeShape,n);function n(){return null!==t&&t.apply(this,arguments)||this}o.ChainAndCircleContact=e}(b2=b2||{}),function(o){var t,e=(t=o.Contact,__extends(n,t),n.Create=function(){return new n},n.Destroy=function(t){},n.prototype.Evaluate=function(t,e,i){var s=n.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.indexA),o.CollideEdgeAndPolygon(t,s,e,this.GetShapeB(),i)},n.Evaluate_s_edge=new o.EdgeShape,n);function n(){return null!==t&&t.apply(this,arguments)||this}o.ChainAndPolygonContact=e}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.Create=function(){return new i},i.Destroy=function(t){},i.prototype.Evaluate=function(t,e,i){s.CollideCircles(t,this.GetShapeA(),e,this.GetShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.CircleContact=e}(b2=b2||{}),function(i){var s=function(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1};i.ContactRegister=s;var t=(e.prototype.AddType=function(t,e,i,s){var o=[];function n(){return o.pop()||t()}function r(t){o.push(t)}this.registers[i][s].pool=o,this.registers[i][s].createFcn=n,this.registers[i][s].destroyFcn=r,this.registers[i][s].primary=!0,i!==s&&(this.registers[s][i].pool=o,this.registers[s][i].createFcn=n,this.registers[s][i].destroyFcn=r,this.registers[s][i].primary=!1)},e.prototype.InitializeRegisters=function(){for(var t=0;t<i.ShapeType.e_shapeTypeCount;t++){this.registers[t]=[];for(var e=0;e<i.ShapeType.e_shapeTypeCount;e++)this.registers[t][e]=new s}this.AddType(i.CircleContact.Create,i.CircleContact.Destroy,i.ShapeType.e_circleShape,i.ShapeType.e_circleShape),this.AddType(i.PolygonAndCircleContact.Create,i.PolygonAndCircleContact.Destroy,i.ShapeType.e_polygonShape,i.ShapeType.e_circleShape),this.AddType(i.PolygonContact.Create,i.PolygonContact.Destroy,i.ShapeType.e_polygonShape,i.ShapeType.e_polygonShape),this.AddType(i.EdgeAndCircleContact.Create,i.EdgeAndCircleContact.Destroy,i.ShapeType.e_edgeShape,i.ShapeType.e_circleShape),this.AddType(i.EdgeAndPolygonContact.Create,i.EdgeAndPolygonContact.Destroy,i.ShapeType.e_edgeShape,i.ShapeType.e_polygonShape),this.AddType(i.ChainAndCircleContact.Create,i.ChainAndCircleContact.Destroy,i.ShapeType.e_chainShape,i.ShapeType.e_circleShape),this.AddType(i.ChainAndPolygonContact.Create,i.ChainAndPolygonContact.Destroy,i.ShapeType.e_chainShape,i.ShapeType.e_polygonShape)},e.prototype.Create=function(t,e,i,s){var o=t.GetType(),n=i.GetType(),r=this.registers[o][n];if(r.createFcn){var a=r.createFcn();return r.primary?a.Reset(t,e,i,s):a.Reset(i,s,t,e),a}return null},e.prototype.Destroy=function(t){var e=t.fixtureA.GetType(),i=t.fixtureB.GetType(),s=this.registers[e][i];s.destroyFcn&&s.destroyFcn(t)},e);function e(){this.registers=[],this.InitializeRegisters()}i.ContactFactory=t}(b2=b2||{}),function(p){var t=(e.prototype.AddPair=function(t,e){var i=t.fixture,s=e.fixture,o=t.childIndex,n=e.childIndex,r=i.GetBody(),a=s.GetBody();if(r!==a){for(var l,c=a.GetContactList();c;){if(c.other===r){var h=c.contact.GetFixtureA(),u=c.contact.GetFixtureB(),p=c.contact.GetChildIndexA(),f=c.contact.GetChildIndexB();if(h===i&&u===s&&p===o&&f===n)return;if(h===s&&u===i&&p===n&&f===o)return}c=c.next}this.contactFilter&&!this.contactFilter.ShouldCollide(i,s)||null!==(l=this.contactFactory.Create(i,o,s,n))&&(i=l.GetFixtureA(),s=l.GetFixtureB(),o=l.GetChildIndexA(),n=l.GetChildIndexB(),r=i.body,a=s.body,l.prev=null,l.next=this.contactList,null!==this.contactList&&(this.contactList.prev=l),(this.contactList=l).nodeA.other=a,l.nodeA.prev=null,l.nodeA.next=r.contactList,null!==r.contactList&&(r.contactList.prev=l.nodeA),r.contactList=l.nodeA,l.nodeB.other=r,l.nodeB.prev=null,l.nodeB.next=a.contactList,null!==a.contactList&&(a.contactList.prev=l.nodeB),a.contactList=l.nodeB,++this.contactCount)}},e.prototype.FindNewContacts=function(){var i=this;this.broadPhase.UpdatePairs(function(t,e){i.AddPair(t,e)})},e.prototype.Destroy=function(t){var e=t.GetFixtureA(),i=t.GetFixtureB(),s=e.GetBody(),o=i.GetBody();this.contactListener&&t.IsTouching()&&this.contactListener.EndContact(t),t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.contactList&&(this.contactList=t.next),t.nodeA.prev&&(t.nodeA.prev.next=t.nodeA.next),t.nodeA.next&&(t.nodeA.next.prev=t.nodeA.prev),t.nodeA===s.contactList&&(s.contactList=t.nodeA.next),t.nodeB.prev&&(t.nodeB.prev.next=t.nodeB.next),t.nodeB.next&&(t.nodeB.next.prev=t.nodeB.prev),t.nodeB===o.contactList&&(o.contactList=t.nodeB.next),0<t.manifold.pointCount&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.contactFactory.Destroy(t),--this.contactCount},e.prototype.Collide=function(){for(var t=this.contactList;t;){var e=t.GetFixtureA(),i=t.GetFixtureB(),s=t.GetChildIndexA(),o=t.GetChildIndexB(),n=e.GetBody(),r=i.GetBody();if(t.filterFlag){if(this.contactFilter&&!this.contactFilter.ShouldCollide(e,i)){t=(c=t).next;this.Destroy(c);continue}t.filterFlag=!1}var a,l,c,h=n.IsAwake()&&n.type!==p.BodyType.staticBody,u=r.IsAwake()&&r.type!==p.BodyType.staticBody;h||u?(a=e.proxies[s].treeNode,l=i.proxies[o].treeNode,p.TestOverlapAABB(a.aabb,l.aabb)?(t.Update(this.contactListener),t=t.next):(t=(c=t).next,this.Destroy(c))):t=t.next}},e);function e(){this.broadPhase=new p.BroadPhase,this.contactList=null,this.contactCount=0,this.contactFilter=p.ContactFilter.defaultFilter,this.contactListener=p.ContactListener.defaultListener,this.contactFactory=new p.ContactFactory}p.ContactManager=t}(b2=b2||{}),function(S){var e,t=(e=S.JointDef,__extends(i,e),i.prototype.Initialize=function(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(s,this.localAnchorB),this.length=S.Max(S.Vec2.DistanceVV(i,s),S.linearSlop),this.minLength=this.length,this.maxLength=this.length},i);function i(){var t=e.call(this,S.JointType.e_distanceJoint)||this;return t.localAnchorA=new S.Vec2,t.localAnchorB=new S.Vec2,t.length=1,t.minLength=0,t.maxLength=S.maxFloat,t.stiffness=0,t.damping=0,t}S.DistanceJointDef=t;var s,o=(s=S.Joint,__extends(B,s),B.prototype.GetAnchorA=function(t){return this.bodyA.GetWorldPoint(this.localAnchorA,t)},B.prototype.GetAnchorB=function(t){return this.bodyB.GetWorldPoint(this.localAnchorB,t)},B.prototype.GetReactionForce=function(t,e){return e.x=t*(this.impulse+this.lowerImpulse-this.upperImpulse)*this.u.x,e.y=t*(this.impulse+this.lowerImpulse-this.upperImpulse)*this.u.y,e},B.prototype.GetReactionTorque=function(t){return 0},B.prototype.GetLocalAnchorA=function(){return this.localAnchorA},B.prototype.GetLocalAnchorB=function(){return this.localAnchorB},B.prototype.SetLength=function(t){return this.impulse=0,this.length=S.Max(S.linearSlop,t),this.length},B.prototype.GetLength=function(){return this.length},B.prototype.SetMinLength=function(t){return this.lowerImpulse=0,this.minLength=S.Clamp(t,S.linearSlop,this.maxLength),this.minLength},B.prototype.SetMaxLength=function(t){return this.upperImpulse=0,this.maxLength=S.Max(t,this.minLength),this.maxLength},B.prototype.GetCurrentLength=function(){var t=this.bodyA.GetWorldPoint(this.localAnchorA,new S.Vec2),e=this.bodyB.GetWorldPoint(this.localAnchorB,new S.Vec2);return S.Vec2.DistanceVV(t,e)},B.prototype.SetStiffness=function(t){this.stiffness=t},B.prototype.GetStiffness=function(){return this.stiffness},B.prototype.SetDamping=function(t){this.damping=t},B.prototype.GetDamping=function(){return this.damping},B.prototype.Dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: DistanceJointDef = new DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.length = %.15f;\n",this.length),t("  jd.minLength = %.15f;\n",this.minLength),t("  jd.maxLength = %.15f;\n",this.maxLength),t("  jd.stiffness = %.15f;\n",this.stiffness),t("  jd.damping = %.15f;\n",this.damping),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},B.prototype.InitVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.Copy(this.bodyA.sweep.localCenter),this.localCenterB.Copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.velocities[this.indexA].v,o=t.velocities[this.indexA].w,n=t.positions[this.indexB].c,r=t.positions[this.indexB].a,a=t.velocities[this.indexB].v,l=t.velocities[this.indexB].w,c=this.qA.SetAngle(i),h=this.qB.SetAngle(r);S.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),S.Rot.MulRV(c,this.lalcA,this.rA),S.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),S.Rot.MulRV(h,this.lalcB,this.rB),this.u.x=n.x+this.rB.x-e.x-this.rA.x,this.u.y=n.y+this.rB.y-e.y-this.rA.y,this.currentLength=this.u.Length(),this.currentLength>S.linearSlop?this.u.SelfMul(1/this.currentLength):(this.u.SetZero(),this.mass=0,this.impulse=0,this.lowerImpulse=0,this.upperImpulse=0);var u,p,f,d,y,V=S.Vec2.CrossVV(this.rA,this.u),v=S.Vec2.CrossVV(this.rB,this.u),x=this.invMassA+this.invIA*V*V+this.invMassB+this.invIB*v*v;this.mass=0!==x?1/x:0,0<this.stiffness&&this.minLength<this.maxLength?(u=this.currentLength-this.length,p=this.damping,f=this.stiffness,d=t.step.dt,this.gamma=d*(p+d*f),this.gamma=0!==this.gamma?1/this.gamma:0,this.bias=u*d*f*this.gamma,x+=this.gamma,this.softMass=0!==x?1/x:0):(this.gamma=0,this.bias=0,this.softMass=this.mass),t.step.warmStarting?(this.impulse*=t.step.dtRatio,this.lowerImpulse*=t.step.dtRatio,this.upperImpulse*=t.step.dtRatio,y=S.Vec2.MulSV(this.impulse+this.lowerImpulse-this.upperImpulse,this.u,B.InitVelocityConstraints_s_P),s.SelfMulSub(this.invMassA,y),o-=this.invIA*S.Vec2.CrossVV(this.rA,y),a.SelfMulAdd(this.invMassB,y),l+=this.invIB*S.Vec2.CrossVV(this.rB,y)):this.impulse=0,t.velocities[this.indexA].w=o,t.velocities[this.indexB].w=l},B.prototype.SolveVelocityConstraints=function(t){var e,i,s,o,n,r,a,l,c=t.velocities[this.indexA].v,h=t.velocities[this.indexA].w,u=t.velocities[this.indexB].v,p=t.velocities[this.indexB].w;l=this.minLength<this.maxLength?(0<this.stiffness&&(o=S.Vec2.AddVCrossSV(c,h,this.rA,B.SolveVelocityConstraints_s_vpA),n=S.Vec2.AddVCrossSV(u,p,this.rB,B.SolveVelocityConstraints_s_vpB),r=S.Vec2.DotVV(this.u,S.Vec2.SubVV(n,o,S.Vec2.s_t0)),a=-this.softMass*(r+this.bias+this.gamma*this.impulse),this.impulse+=a,l=S.Vec2.MulSV(a,this.u,B.SolveVelocityConstraints_s_P),c.SelfMulSub(this.invMassA,l),h-=this.invIA*S.Vec2.CrossVV(this.rA,l),u.SelfMulAdd(this.invMassB,l),p+=this.invIB*S.Vec2.CrossVV(this.rB,l)),e=this.currentLength-this.minLength,i=S.Max(0,e)*t.step.inv_dt,o=S.Vec2.AddVCrossSV(c,h,this.rA,B.SolveVelocityConstraints_s_vpA),n=S.Vec2.AddVCrossSV(u,p,this.rB,B.SolveVelocityConstraints_s_vpB),r=S.Vec2.DotVV(this.u,S.Vec2.SubVV(n,o,S.Vec2.s_t0)),a=-this.mass*(r+i),s=this.lowerImpulse,this.lowerImpulse=S.Max(0,this.lowerImpulse+a),a=this.lowerImpulse-s,l=S.Vec2.MulSV(a,this.u,B.SolveVelocityConstraints_s_P),c.SelfMulSub(this.invMassA,l),h-=this.invIA*S.Vec2.CrossVV(this.rA,l),u.SelfMulAdd(this.invMassB,l),p+=this.invIB*S.Vec2.CrossVV(this.rB,l),e=this.maxLength-this.currentLength,i=S.Max(0,e)*t.step.inv_dt,o=S.Vec2.AddVCrossSV(c,h,this.rA,B.SolveVelocityConstraints_s_vpA),n=S.Vec2.AddVCrossSV(u,p,this.rB,B.SolveVelocityConstraints_s_vpB),r=S.Vec2.DotVV(this.u,S.Vec2.SubVV(o,n,S.Vec2.s_t0)),a=-this.mass*(r+i),s=this.upperImpulse,this.upperImpulse=S.Max(0,this.upperImpulse+a),a=this.upperImpulse-s,S.Vec2.MulSV(-a,this.u,B.SolveVelocityConstraints_s_P)):(o=S.Vec2.AddVCrossSV(c,h,this.rA,B.SolveVelocityConstraints_s_vpA),n=S.Vec2.AddVCrossSV(u,p,this.rB,B.SolveVelocityConstraints_s_vpB),r=S.Vec2.DotVV(this.u,S.Vec2.SubVV(n,o,S.Vec2.s_t0)),a=-this.mass*r,this.impulse+=a,S.Vec2.MulSV(a,this.u,B.SolveVelocityConstraints_s_P)),c.SelfMulSub(this.invMassA,l),h-=this.invIA*S.Vec2.CrossVV(this.rA,l),u.SelfMulAdd(this.invMassB,l),p+=this.invIB*S.Vec2.CrossVV(this.rB,l),t.velocities[this.indexA].w=h,t.velocities[this.indexB].w=p},B.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.positions[this.indexB].c,o=t.positions[this.indexB].a,n=this.qA.SetAngle(i),r=this.qB.SetAngle(o),a=S.Rot.MulRV(n,this.lalcA,this.rA),l=S.Rot.MulRV(r,this.lalcB,this.rB),c=this.u;c.x=s.x+l.x-e.x-a.x,c.y=s.y+l.y-e.y-a.y;var h,u=this.u.Normalize();if(this.minLength==this.maxLength)h=u-this.minLength;else if(u<this.minLength)h=u-this.minLength;else{if(!(this.maxLength<u))return!0;h=u-this.maxLength}var p=-this.mass*h,f=S.Vec2.MulSV(p,c,B.SolvePositionConstraints_s_P);return e.SelfMulSub(this.invMassA,f),i-=this.invIA*S.Vec2.CrossVV(a,f),s.SelfMulAdd(this.invMassB,f),o+=this.invIB*S.Vec2.CrossVV(l,f),t.positions[this.indexA].a=i,t.positions[this.indexB].a=o,S.Abs(h)<S.linearSlop},B.prototype.Draw=function(t){var e=this.bodyA.GetTransform(),i=this.bodyB.GetTransform(),s=S.Transform.MulXV(e,this.localAnchorA,B.Draw_s_pA),o=S.Transform.MulXV(i,this.localAnchorB,B.Draw_s_pB),n=S.Vec2.SubVV(o,s,B.Draw_s_axis);n.Normalize();var r=B.Draw_s_c1,a=B.Draw_s_c2,l=B.Draw_s_c3,c=B.Draw_s_c4;t.DrawSegment(s,o,c);var h,u,p=S.Vec2.AddVMulSV(s,this.length,n,B.Draw_s_pRest);t.DrawPoint(p,8,r),this.minLength!=this.maxLength&&(this.minLength>S.linearSlop&&(h=S.Vec2.AddVMulSV(s,this.minLength,n,B.Draw_s_pMin),t.DrawPoint(h,4,a)),this.maxLength<S.maxFloat&&(u=S.Vec2.AddVMulSV(s,this.maxLength,n,B.Draw_s_pMax),t.DrawPoint(u,4,l)))},B.InitVelocityConstraints_s_P=new S.Vec2,B.SolveVelocityConstraints_s_vpA=new S.Vec2,B.SolveVelocityConstraints_s_vpB=new S.Vec2,B.SolveVelocityConstraints_s_P=new S.Vec2,B.SolvePositionConstraints_s_P=new S.Vec2,B.Draw_s_pA=new S.Vec2,B.Draw_s_pB=new S.Vec2,B.Draw_s_axis=new S.Vec2,B.Draw_s_c1=new S.Color(.7,.7,.7),B.Draw_s_c2=new S.Color(.3,.9,.3),B.Draw_s_c3=new S.Color(.9,.3,.3),B.Draw_s_c4=new S.Color(.4,.4,.4),B.Draw_s_pRest=new S.Vec2,B.Draw_s_pMin=new S.Vec2,B.Draw_s_pMax=new S.Vec2,B);function B(t){var e=s.call(this,t)||this;return e.stiffness=0,e.damping=0,e.bias=0,e.length=0,e.minLength=0,e.maxLength=0,e.localAnchorA=new S.Vec2,e.localAnchorB=new S.Vec2,e.gamma=0,e.impulse=0,e.lowerImpulse=0,e.upperImpulse=0,e.indexA=0,e.indexB=0,e.u=new S.Vec2,e.rA=new S.Vec2,e.rB=new S.Vec2,e.localCenterA=new S.Vec2,e.localCenterB=new S.Vec2,e.currentLength=0,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.softMass=0,e.mass=0,e.qA=new S.Rot,e.qB=new S.Rot,e.lalcA=new S.Vec2,e.lalcB=new S.Vec2,e.localAnchorA.Copy(S.Maybe(t.localAnchorA,S.Vec2.ZERO)),e.localAnchorB.Copy(S.Maybe(t.localAnchorB,S.Vec2.ZERO)),e.length=S.Max(S.Maybe(t.length,e.GetCurrentLength()),S.linearSlop),e.minLength=S.Max(S.Maybe(t.minLength,e.length),S.linearSlop),e.maxLength=S.Max(S.Maybe(t.maxLength,e.length),e.minLength),e.stiffness=S.Maybe(t.stiffness,0),e.damping=S.Maybe(t.damping,0),e}S.DistanceJoint=o}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.Create=function(){return new i},i.Destroy=function(t){},i.prototype.Evaluate=function(t,e,i){s.CollideEdgeAndCircle(t,this.GetShapeA(),e,this.GetShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.EdgeAndCircleContact=e}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.Create=function(){return new i},i.Destroy=function(t){},i.prototype.Evaluate=function(t,e,i){s.CollideEdgeAndPolygon(t,this.GetShapeA(),e,this.GetShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.EdgeAndPolygonContact=e}(b2=b2||{}),function(v){var e,t=(e=v.JointDef,__extends(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)},i);function i(){var t=e.call(this,v.JointType.e_frictionJoint)||this;return t.localAnchorA=new v.Vec2,t.localAnchorB=new v.Vec2,t.maxForce=0,t.maxTorque=0,t}v.FrictionJointDef=t;var s,o=(s=v.Joint,__extends(x,s),x.prototype.InitVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.Copy(this.bodyA.sweep.localCenter),this.localCenterB.Copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].a,i=t.velocities[this.indexA].v,s=t.velocities[this.indexA].w,o=t.positions[this.indexB].a,n=t.velocities[this.indexB].v,r=t.velocities[this.indexB].w,a=this.qA.SetAngle(e),l=this.qB.SetAngle(o);v.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var c=v.Rot.MulRV(a,this.lalcA,this.rA);v.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var h,u=v.Rot.MulRV(l,this.lalcB,this.rB),p=this.invMassA,f=this.invMassB,d=this.invIA,y=this.invIB,V=this.K;V.ex.x=p+f+d*c.y*c.y+y*u.y*u.y,V.ex.y=-d*c.x*c.y-y*u.x*u.y,V.ey.x=V.ex.y,V.ey.y=p+f+d*c.x*c.x+y*u.x*u.x,V.GetInverse(this.linearMass),this.angularMass=d+y,0<this.angularMass&&(this.angularMass=1/this.angularMass),t.step.warmStarting?(this.linearImpulse.SelfMul(t.step.dtRatio),this.angularImpulse*=t.step.dtRatio,h=this.linearImpulse,i.SelfMulSub(p,h),s-=d*(v.Vec2.CrossVV(this.rA,h)+this.angularImpulse),n.SelfMulAdd(f,h),r+=y*(v.Vec2.CrossVV(this.rB,h)+this.angularImpulse)):(this.linearImpulse.SetZero(),this.angularImpulse=0),t.velocities[this.indexA].w=s,t.velocities[this.indexB].w=r},x.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.indexA].v,i=t.velocities[this.indexA].w,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=this.invMassA,r=this.invMassB,a=this.invIA,l=this.invIB,c=t.step.dt,h=o-i,u=-this.angularMass*h,p=this.angularImpulse,f=c*this.maxTorque;this.angularImpulse=v.Clamp(this.angularImpulse+u,-f,f),i-=a*(u=this.angularImpulse-p),o+=l*u;var d=v.Vec2.SubVV(v.Vec2.AddVCrossSV(s,o,this.rB,v.Vec2.s_t0),v.Vec2.AddVCrossSV(e,i,this.rA,v.Vec2.s_t1),x.SolveVelocityConstraints_s_Cdot_v2),y=v.Mat22.MulMV(this.linearMass,d,x.SolveVelocityConstraints_s_impulseV).SelfNeg(),V=x.SolveVelocityConstraints_s_oldImpulseV.Copy(this.linearImpulse);this.linearImpulse.SelfAdd(y);f=c*this.maxForce;this.linearImpulse.LengthSquared()>f*f&&(this.linearImpulse.Normalize(),this.linearImpulse.SelfMul(f)),v.Vec2.SubVV(this.linearImpulse,V,y),e.SelfMulSub(n,y),i-=a*v.Vec2.CrossVV(this.rA,y),s.SelfMulAdd(r,y),o+=l*v.Vec2.CrossVV(this.rB,y),t.velocities[this.indexA].w=i,t.velocities[this.indexB].w=o},x.prototype.SolvePositionConstraints=function(t){return!0},x.prototype.GetAnchorA=function(t){return this.bodyA.GetWorldPoint(this.localAnchorA,t)},x.prototype.GetAnchorB=function(t){return this.bodyB.GetWorldPoint(this.localAnchorB,t)},x.prototype.GetReactionForce=function(t,e){return e.x=t*this.linearImpulse.x,e.y=t*this.linearImpulse.y,e},x.prototype.GetReactionTorque=function(t){return t*this.angularImpulse},x.prototype.GetLocalAnchorA=function(){return this.localAnchorA},x.prototype.GetLocalAnchorB=function(){return this.localAnchorB},x.prototype.SetMaxForce=function(t){this.maxForce=t},x.prototype.GetMaxForce=function(){return this.maxForce},x.prototype.SetMaxTorque=function(t){this.maxTorque=t},x.prototype.GetMaxTorque=function(){return this.maxTorque},x.prototype.Dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: FrictionJointDef = new FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.maxForce),t("  jd.maxTorque = %.15f;\n",this.maxTorque),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},x.SolveVelocityConstraints_s_Cdot_v2=new v.Vec2,x.SolveVelocityConstraints_s_impulseV=new v.Vec2,x.SolveVelocityConstraints_s_oldImpulseV=new v.Vec2,x);function x(t){var e=s.call(this,t)||this;return e.localAnchorA=new v.Vec2,e.localAnchorB=new v.Vec2,e.linearImpulse=new v.Vec2,e.angularImpulse=0,e.maxForce=0,e.maxTorque=0,e.indexA=0,e.indexB=0,e.rA=new v.Vec2,e.rB=new v.Vec2,e.localCenterA=new v.Vec2,e.localCenterB=new v.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.linearMass=new v.Mat22,e.angularMass=0,e.qA=new v.Rot,e.qB=new v.Rot,e.lalcA=new v.Vec2,e.lalcB=new v.Vec2,e.K=new v.Mat22,e.localAnchorA.Copy(v.Maybe(t.localAnchorA,v.Vec2.ZERO)),e.localAnchorB.Copy(v.Maybe(t.localAnchorB,v.Vec2.ZERO)),e.linearImpulse.SetZero(),e.maxForce=v.Maybe(t.maxForce,0),e.maxTorque=v.Maybe(t.maxTorque,0),e.linearMass.SetZero(),e}v.FrictionJoint=o}(b2=b2||{}),function(T){var e,t=(e=T.JointDef,__extends(i,e),i);function i(){var t=e.call(this,T.JointType.e_gearJoint)||this;return t.ratio=1,t}T.GearJointDef=t;var x,s=(x=T.Joint,__extends(F,x),F.prototype.InitVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.indexC=this.bodyC.islandIndex,this.indexD=this.bodyD.islandIndex,this.lcA.Copy(this.bodyA.sweep.localCenter),this.lcB.Copy(this.bodyB.sweep.localCenter),this.lcC.Copy(this.bodyC.sweep.localCenter),this.lcD.Copy(this.bodyD.sweep.localCenter),this.mA=this.bodyA.invMass,this.mB=this.bodyB.invMass,this.mC=this.bodyC.invMass,this.mD=this.bodyD.invMass,this.iA=this.bodyA.invI,this.iB=this.bodyB.invI,this.iC=this.bodyC.invI,this.iD=this.bodyD.invI;var e,i,s,o,n,r=t.positions[this.indexA].a,a=t.velocities[this.indexA].v,l=t.velocities[this.indexA].w,c=t.positions[this.indexB].a,h=t.velocities[this.indexB].v,u=t.velocities[this.indexB].w,p=t.positions[this.indexC].a,f=t.velocities[this.indexC].v,d=t.velocities[this.indexC].w,y=t.positions[this.indexD].a,V=t.velocities[this.indexD].v,v=t.velocities[this.indexD].w,x=this.qA.SetAngle(r),S=this.qB.SetAngle(c),B=this.qC.SetAngle(p),A=this.qD.SetAngle(y);this.mass=0,this.typeA===T.JointType.e_revoluteJoint?(this.JvAC.SetZero(),this.JwA=1,this.JwC=1,this.mass+=this.iA+this.iC):(s=T.Rot.MulRV(B,this.localAxisC,F.InitVelocityConstraints_s_u),T.Vec2.SubVV(this.localAnchorC,this.lcC,this.lalcC),e=T.Rot.MulRV(B,this.lalcC,F.InitVelocityConstraints_s_rC),T.Vec2.SubVV(this.localAnchorA,this.lcA,this.lalcA),i=T.Rot.MulRV(x,this.lalcA,F.InitVelocityConstraints_s_rA),this.JvAC.Copy(s),this.JwC=T.Vec2.CrossVV(e,s),this.JwA=T.Vec2.CrossVV(i,s),this.mass+=this.mC+this.mA+this.iC*this.JwC*this.JwC+this.iA*this.JwA*this.JwA),this.typeB===T.JointType.e_revoluteJoint?(this.JvBD.SetZero(),this.JwB=this.ratio,this.JwD=this.ratio,this.mass+=this.ratio*this.ratio*(this.iB+this.iD)):(s=T.Rot.MulRV(A,this.localAxisD,F.InitVelocityConstraints_s_u),T.Vec2.SubVV(this.localAnchorD,this.lcD,this.lalcD),o=T.Rot.MulRV(A,this.lalcD,F.InitVelocityConstraints_s_rD),T.Vec2.SubVV(this.localAnchorB,this.lcB,this.lalcB),n=T.Rot.MulRV(S,this.lalcB,F.InitVelocityConstraints_s_rB),T.Vec2.MulSV(this.ratio,s,this.JvBD),this.JwD=this.ratio*T.Vec2.CrossVV(o,s),this.JwB=this.ratio*T.Vec2.CrossVV(n,s),this.mass+=this.ratio*this.ratio*(this.mD+this.mB)+this.iD*this.JwD*this.JwD+this.iB*this.JwB*this.JwB),this.mass=0<this.mass?1/this.mass:0,t.step.warmStarting?(a.SelfMulAdd(this.mA*this.impulse,this.JvAC),l+=this.iA*this.impulse*this.JwA,h.SelfMulAdd(this.mB*this.impulse,this.JvBD),u+=this.iB*this.impulse*this.JwB,f.SelfMulSub(this.mC*this.impulse,this.JvAC),d-=this.iC*this.impulse*this.JwC,V.SelfMulSub(this.mD*this.impulse,this.JvBD),v-=this.iD*this.impulse*this.JwD):this.impulse=0,t.velocities[this.indexA].w=l,t.velocities[this.indexB].w=u,t.velocities[this.indexC].w=d,t.velocities[this.indexD].w=v},F.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.indexA].v,i=t.velocities[this.indexA].w,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=t.velocities[this.indexC].v,r=t.velocities[this.indexC].w,a=t.velocities[this.indexD].v,l=t.velocities[this.indexD].w,c=T.Vec2.DotVV(this.JvAC,T.Vec2.SubVV(e,n,T.Vec2.s_t0))+T.Vec2.DotVV(this.JvBD,T.Vec2.SubVV(s,a,T.Vec2.s_t0));c+=this.JwA*i-this.JwC*r+(this.JwB*o-this.JwD*l);var h=-this.mass*c;this.impulse+=h,e.SelfMulAdd(this.mA*h,this.JvAC),i+=this.iA*h*this.JwA,s.SelfMulAdd(this.mB*h,this.JvBD),o+=this.iB*h*this.JwB,n.SelfMulSub(this.mC*h,this.JvAC),r-=this.iC*h*this.JwC,a.SelfMulSub(this.mD*h,this.JvBD),l-=this.iD*h*this.JwD,t.velocities[this.indexA].w=i,t.velocities[this.indexB].w=o,t.velocities[this.indexC].w=r,t.velocities[this.indexD].w=l},F.prototype.SolvePositionConstraints=function(t){var e,i,s,o,n,r,a,l,c,h,u,p,f,d,y,V=t.positions[this.indexA].c,v=t.positions[this.indexA].a,x=t.positions[this.indexB].c,S=t.positions[this.indexB].a,B=t.positions[this.indexC].c,A=t.positions[this.indexC].a,C=t.positions[this.indexD].c,m=t.positions[this.indexD].a,g=this.qA.SetAngle(v),w=this.qB.SetAngle(S),_=this.qC.SetAngle(A),b=this.qD.SetAngle(m),M=this.JvAC,P=this.JvBD,I=0;c=this.typeA===T.JointType.e_revoluteJoint?(M.SetZero(),s=e=1,I+=this.iA+this.iC,v-A-this.referenceAngleA):(h=T.Rot.MulRV(_,this.localAxisC,F.SolvePositionConstraints_s_u),n=T.Rot.MulRV(_,this.lalcC,F.SolvePositionConstraints_s_rC),r=T.Rot.MulRV(g,this.lalcA,F.SolvePositionConstraints_s_rA),M.Copy(h),s=T.Vec2.CrossVV(n,h),e=T.Vec2.CrossVV(r,h),I+=this.mC+this.mA+this.iC*s*s+this.iA*e*e,a=this.lalcC,l=T.Rot.MulTRV(_,T.Vec2.AddVV(r,T.Vec2.SubVV(V,B,T.Vec2.s_t0),T.Vec2.s_t0),T.Vec2.s_t0),T.Vec2.DotVV(T.Vec2.SubVV(l,a,T.Vec2.s_t0),this.localAxisC)),y=this.typeB===T.JointType.e_revoluteJoint?(P.SetZero(),i=this.ratio,o=this.ratio,I+=this.ratio*this.ratio*(this.iB+this.iD),S-m-this.referenceAngleB):(h=T.Rot.MulRV(b,this.localAxisD,F.SolvePositionConstraints_s_u),u=T.Rot.MulRV(b,this.lalcD,F.SolvePositionConstraints_s_rD),p=T.Rot.MulRV(w,this.lalcB,F.SolvePositionConstraints_s_rB),T.Vec2.MulSV(this.ratio,h,P),o=this.ratio*T.Vec2.CrossVV(u,h),i=this.ratio*T.Vec2.CrossVV(p,h),I+=this.ratio*this.ratio*(this.mD+this.mB)+this.iD*o*o+this.iB*i*i,f=this.lalcD,d=T.Rot.MulTRV(b,T.Vec2.AddVV(p,T.Vec2.SubVV(x,C,T.Vec2.s_t0),T.Vec2.s_t0),T.Vec2.s_t0),T.Vec2.DotVV(T.Vec2.SubVV(d,f,T.Vec2.s_t0),this.localAxisD));var D=c+this.ratio*y-this.constant,G=0<I?-D/I:0;return V.SelfMulAdd(this.mA*G,M),v+=this.iA*G*e,x.SelfMulAdd(this.mB*G,P),S+=this.iB*G*i,B.SelfMulSub(this.mC*G,M),A-=this.iC*G*s,C.SelfMulSub(this.mD*G,P),m-=this.iD*G*o,t.positions[this.indexA].a=v,t.positions[this.indexB].a=S,t.positions[this.indexC].a=A,t.positions[this.indexD].a=m,0<T.linearSlop},F.prototype.GetAnchorA=function(t){return this.bodyA.GetWorldPoint(this.localAnchorA,t)},F.prototype.GetAnchorB=function(t){return this.bodyB.GetWorldPoint(this.localAnchorB,t)},F.prototype.GetReactionForce=function(t,e){return T.Vec2.MulSV(t*this.impulse,this.JvAC,e)},F.prototype.GetReactionTorque=function(t){return t*this.impulse*this.JwA},F.prototype.GetJoint1=function(){return this.joint1},F.prototype.GetJoint2=function(){return this.joint2},F.prototype.GetRatio=function(){return this.ratio},F.prototype.SetRatio=function(t){this.ratio=t},F.prototype.Dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex,s=this.joint1.index,o=this.joint2.index;t("  const jd: GearJointDef = new GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",s),t("  jd.joint2 = joints[%d];\n",o),t("  jd.ratio = %.15f;\n",this.ratio),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},F.InitVelocityConstraints_s_u=new T.Vec2,F.InitVelocityConstraints_s_rA=new T.Vec2,F.InitVelocityConstraints_s_rB=new T.Vec2,F.InitVelocityConstraints_s_rC=new T.Vec2,F.InitVelocityConstraints_s_rD=new T.Vec2,F.SolvePositionConstraints_s_u=new T.Vec2,F.SolvePositionConstraints_s_rA=new T.Vec2,F.SolvePositionConstraints_s_rB=new T.Vec2,F.SolvePositionConstraints_s_rC=new T.Vec2,F.SolvePositionConstraints_s_rD=new T.Vec2,F);function F(t){var e=x.call(this,t)||this;e.typeA=T.JointType.e_unknownJoint,e.typeB=T.JointType.e_unknownJoint,e.localAnchorA=new T.Vec2,e.localAnchorB=new T.Vec2,e.localAnchorC=new T.Vec2,e.localAnchorD=new T.Vec2,e.localAxisC=new T.Vec2,e.localAxisD=new T.Vec2,e.referenceAngleA=0,e.referenceAngleB=0,e.constant=0,e.ratio=0,e.impulse=0,e.indexA=0,e.indexB=0,e.indexC=0,e.indexD=0,e.lcA=new T.Vec2,e.lcB=new T.Vec2,e.lcC=new T.Vec2,e.lcD=new T.Vec2,e.mA=0,e.mB=0,e.mC=0,e.mD=0,e.iA=0,e.iB=0,e.iC=0,e.iD=0,e.JvAC=new T.Vec2,e.JvBD=new T.Vec2,e.JwA=0,e.JwB=0,e.JwC=0,e.JwD=0,e.mass=0,e.qA=new T.Rot,e.qB=new T.Rot,e.qC=new T.Rot,e.qD=new T.Rot,e.lalcA=new T.Vec2,e.lalcB=new T.Vec2,e.lalcC=new T.Vec2,e.lalcD=new T.Vec2,e.joint1=t.joint1,e.joint2=t.joint2,e.typeA=e.joint1.GetType(),e.typeB=e.joint2.GetType(),e.bodyC=e.joint1.GetBodyA(),e.bodyA=e.joint1.GetBodyB();var i,s,o,n=e.bodyA.xf,r=e.bodyA.sweep.a,a=e.bodyC.xf,l=e.bodyC.sweep.a;o=e.typeA===T.JointType.e_revoluteJoint?(c=t.joint1,e.localAnchorC.Copy(c.localAnchorA),e.localAnchorA.Copy(c.localAnchorB),e.referenceAngleA=c.referenceAngle,e.localAxisC.SetZero(),r-l-e.referenceAngleA):(h=t.joint1,e.localAnchorC.Copy(h.localAnchorA),e.localAnchorA.Copy(h.localAnchorB),e.referenceAngleA=h.referenceAngle,e.localAxisC.Copy(h.localXAxisA),i=e.localAnchorC,s=T.Rot.MulTRV(a.q,T.Vec2.AddVV(T.Rot.MulRV(n.q,e.localAnchorA,T.Vec2.s_t0),T.Vec2.SubVV(n.p,a.p,T.Vec2.s_t1),T.Vec2.s_t0),T.Vec2.s_t0),T.Vec2.DotVV(T.Vec2.SubVV(s,i,T.Vec2.s_t0),e.localAxisC)),e.bodyD=e.joint2.GetBodyA(),e.bodyB=e.joint2.GetBodyB();var c,h,u,p,f,d=e.bodyB.xf,y=e.bodyB.sweep.a,V=e.bodyD.xf,v=e.bodyD.sweep.a;return f=e.typeB===T.JointType.e_revoluteJoint?(c=t.joint2,e.localAnchorD.Copy(c.localAnchorA),e.localAnchorB.Copy(c.localAnchorB),e.referenceAngleB=c.referenceAngle,e.localAxisD.SetZero(),y-v-e.referenceAngleB):(h=t.joint2,e.localAnchorD.Copy(h.localAnchorA),e.localAnchorB.Copy(h.localAnchorB),e.referenceAngleB=h.referenceAngle,e.localAxisD.Copy(h.localXAxisA),u=e.localAnchorD,p=T.Rot.MulTRV(V.q,T.Vec2.AddVV(T.Rot.MulRV(d.q,e.localAnchorB,T.Vec2.s_t0),T.Vec2.SubVV(d.p,V.p,T.Vec2.s_t1),T.Vec2.s_t0),T.Vec2.s_t0),T.Vec2.DotVV(T.Vec2.SubVV(p,u,T.Vec2.s_t0),e.localAxisD)),e.ratio=T.Maybe(t.ratio,1),e.constant=o+e.ratio*f,e.impulse=0,e}T.GearJoint=s}(b2=b2||{}),function(b){var t=(M.prototype.Initialize=function(t,e,i,s){if(this.bodyCapacity=t,this.contactCapacity=e,this.jointCapacity=i,this.bodyCount=0,this.contactCount=0,this.jointCount=0,this.listener=s,this.positions.length<t)for(var o=b.Max(2*this.positions.length,t);this.positions.length<o;)this.positions[this.positions.length]=new b.Position;if(this.velocities.length<t)for(o=b.Max(2*this.velocities.length,t);this.velocities.length<o;)this.velocities[this.velocities.length]=new b.Velocity},M.prototype.Clear=function(){this.bodyCount=0,this.contactCount=0,this.jointCount=0},M.prototype.AddBody=function(t){t.islandIndex=this.bodyCount,this.bodies[this.bodyCount++]=t},M.prototype.AddContact=function(t){this.contacts[this.contactCount++]=t},M.prototype.AddJoint=function(t){this.joints[this.jointCount++]=t},M.prototype.Solve=function(t,e,i,s){for(var o=M.s_timer.Reset(),n=e.dt,r=0;r<this.bodyCount;++r){var a=this.bodies[r];this.positions[r].c.Copy(a.sweep.c);var l=a.sweep.a,c=this.velocities[r].v.Copy(a.linearVelocity),h=a.angularVelocity;a.sweep.c0.Copy(a.sweep.c),a.sweep.a0=a.sweep.a,a.type===b.BodyType.dynamicBody&&(c.x+=n*a.invMass*(a.gravityScale*a.mass*i.x+a.force.x),c.y+=n*a.invMass*(a.gravityScale*a.mass*i.y+a.force.y),h+=n*a.invI*a.torque,c.SelfMul(1/(1+n*a.linearDamping)),h*=1/(1+n*a.angularDamping)),this.positions[r].a=l,this.velocities[r].w=h}o.Reset();var u=M.s_solverData;u.step.Copy(e),u.positions=this.positions,u.velocities=this.velocities;var p=M.s_contactSolverDef;p.step.Copy(e),p.contacts=this.contacts,p.count=this.contactCount,p.positions=this.positions,p.velocities=this.velocities;var f=M.s_contactSolver.Initialize(p);f.InitializeVelocityConstraints(),e.warmStarting&&f.WarmStart();for(r=0;r<this.jointCount;++r)this.joints[r].InitVelocityConstraints(u);t.solveInit=o.GetMilliseconds(),o.Reset();for(r=0;r<e.velocityIterations;++r){for(var d=0;d<this.jointCount;++d)this.joints[d].SolveVelocityConstraints(u);f.SolveVelocityConstraints()}f.StoreImpulses(),t.solveVelocity=o.GetMilliseconds();for(r=0;r<this.bodyCount;++r){var y=this.positions[r].c,l=this.positions[r].a,c=this.velocities[r].v,h=this.velocities[r].w,V=b.Vec2.MulSV(n,c,M.s_translation);b.Vec2.DotVV(V,V)>b.maxTranslationSquared&&(v=b.maxTranslation/V.Length(),c.SelfMul(v));var v,x=n*h;x*x>b.maxRotationSquared&&(h*=v=b.maxRotation/b.Abs(x)),y.x+=n*c.x,y.y+=n*c.y,l+=n*h,this.positions[r].a=l,this.velocities[r].w=h}o.Reset();for(var S=!1,r=0;r<e.positionIterations;++r){for(var B=f.SolvePositionConstraints(),A=!0,d=0;d<this.jointCount;++d)var C=this.joints[d].SolvePositionConstraints(u),A=A&&C;if(B&&A){S=!0;break}}for(r=0;r<this.bodyCount;++r){var m=this.bodies[r];m.sweep.c.Copy(this.positions[r].c),m.sweep.a=this.positions[r].a,m.linearVelocity.Copy(this.velocities[r].v),m.angularVelocity=this.velocities[r].w,m.SynchronizeTransform()}if(t.solvePosition=o.GetMilliseconds(),this.Report(f.velocityConstraints),s){for(var g=b.maxFloat,w=b.linearSleepTolerance*b.linearSleepTolerance,_=b.angularSleepTolerance*b.angularSleepTolerance,r=0;r<this.bodyCount;++r){(a=this.bodies[r]).GetType()!==b.BodyType.staticBody&&(g=!a.autoSleepFlag||a.angularVelocity*a.angularVelocity>_||b.Vec2.DotVV(a.linearVelocity,a.linearVelocity)>w?a.sleepTime=0:(a.sleepTime+=n,b.Min(g,a.sleepTime)))}if(g>=b.timeToSleep&&S)for(r=0;r<this.bodyCount;++r){(a=this.bodies[r]).SetAwake(!1)}}},M.prototype.SolveTOI=function(t,e,i){for(var s=0;s<this.bodyCount;++s){var o=this.bodies[s];this.positions[s].c.Copy(o.sweep.c),this.positions[s].a=o.sweep.a,this.velocities[s].v.Copy(o.linearVelocity),this.velocities[s].w=o.angularVelocity}var n=M.s_contactSolverDef;n.contacts=this.contacts,n.count=this.contactCount,n.step.Copy(t),n.positions=this.positions,n.velocities=this.velocities;for(var r=M.s_contactSolver.Initialize(n),s=0;s<t.positionIterations;++s){if(r.SolveTOIPositionConstraints(e,i))break}this.bodies[e].sweep.c0.Copy(this.positions[e].c),this.bodies[e].sweep.a0=this.positions[e].a,this.bodies[i].sweep.c0.Copy(this.positions[i].c),this.bodies[i].sweep.a0=this.positions[i].a,r.InitializeVelocityConstraints();for(s=0;s<t.velocityIterations;++s)r.SolveVelocityConstraints();for(var a=t.dt,s=0;s<this.bodyCount;++s){var l=this.positions[s].c,c=this.positions[s].a,h=this.velocities[s].v,u=this.velocities[s].w,p=b.Vec2.MulSV(a,h,M.s_translation);b.Vec2.DotVV(p,p)>b.maxTranslationSquared&&(f=b.maxTranslation/p.Length(),h.SelfMul(f));var f,d=a*u;d*d>b.maxRotationSquared&&(u*=f=b.maxRotation/b.Abs(d)),l.SelfMulAdd(a,h),c+=a*u,this.positions[s].a=c,this.velocities[s].w=u;var y=this.bodies[s];y.sweep.c.Copy(l),y.sweep.a=c,y.linearVelocity.Copy(h),y.angularVelocity=u,y.SynchronizeTransform()}this.Report(r.velocityConstraints)},M.prototype.Report=function(t){if(null!==this.listener)for(var e=0;e<this.contactCount;++e){var i=this.contacts[e];if(i){var s=t[e],o=M.s_impulse;o.count=s.pointCount;for(var n=0;n<s.pointCount;++n)o.normalImpulses[n]=s.points[n].normalImpulse,o.tangentImpulses[n]=s.points[n].tangentImpulse;this.listener.PostSolve(i,o)}}},M.s_timer=new b.Timer,M.s_solverData=new b.SolverData,M.s_contactSolverDef=new b.ContactSolverDef,M.s_contactSolver=new b.ContactSolver,M.s_translation=new b.Vec2,M.s_impulse=new b.ContactImpulse,M);function M(){this.bodies=[],this.contacts=[],this.joints=[],this.positions=b.Position.MakeArray(1024),this.velocities=b.Velocity.MakeArray(1024),this.bodyCount=0,this.jointCount=0,this.contactCount=0,this.bodyCapacity=0,this.contactCapacity=0,this.jointCapacity=0}b.Island=t}(b2=b2||{}),function(B){var e,t=(e=B.JointDef,__extends(i,e),i.prototype.Initialize=function(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var i=this.bodyA.GetAngle(),s=this.bodyB.GetAngle();this.angularOffset=s-i},i);function i(){var t=e.call(this,B.JointType.e_motorJoint)||this;return t.linearOffset=new B.Vec2(0,0),t.angularOffset=0,t.maxForce=1,t.maxTorque=1,t.correctionFactor=.3,t}B.MotorJointDef=t;var s,o=(s=B.Joint,__extends(A,s),A.prototype.GetAnchorA=function(t){var e=this.bodyA.GetPosition();return t.x=e.x,t.y=e.y,t},A.prototype.GetAnchorB=function(t){var e=this.bodyB.GetPosition();return t.x=e.x,t.y=e.y,t},A.prototype.GetReactionForce=function(t,e){return B.Vec2.MulSV(t,this.linearImpulse,e)},A.prototype.GetReactionTorque=function(t){return t*this.angularImpulse},A.prototype.SetLinearOffset=function(t){B.Vec2.IsEqualToV(t,this.linearOffset)||(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.linearOffset.Copy(t))},A.prototype.GetLinearOffset=function(){return this.linearOffset},A.prototype.SetAngularOffset=function(t){t!==this.angularOffset&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.angularOffset=t)},A.prototype.GetAngularOffset=function(){return this.angularOffset},A.prototype.SetMaxForce=function(t){this.maxForce=t},A.prototype.GetMaxForce=function(){return this.maxForce},A.prototype.SetMaxTorque=function(t){this.maxTorque=t},A.prototype.GetMaxTorque=function(){return this.maxTorque},A.prototype.InitVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.Copy(this.bodyA.sweep.localCenter),this.localCenterB.Copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e,i=t.positions[this.indexA].c,s=t.positions[this.indexA].a,o=t.velocities[this.indexA].v,n=t.velocities[this.indexA].w,r=t.positions[this.indexB].c,a=t.positions[this.indexB].a,l=t.velocities[this.indexB].v,c=t.velocities[this.indexB].w,h=this.qA.SetAngle(s),u=this.qB.SetAngle(a),p=B.Rot.MulRV(h,B.Vec2.SubVV(this.linearOffset,this.localCenterA,B.Vec2.s_t0),this.rA),f=B.Rot.MulRV(u,B.Vec2.NegV(this.localCenterB,B.Vec2.s_t0),this.rB),d=this.invMassA,y=this.invMassB,V=this.invIA,v=this.invIB,x=this.K;x.ex.x=d+y+V*p.y*p.y+v*f.y*f.y,x.ex.y=-V*p.x*p.y-v*f.x*f.y,x.ey.x=x.ex.y,x.ey.y=d+y+V*p.x*p.x+v*f.x*f.x,x.GetInverse(this.linearMass),this.angularMass=V+v,0<this.angularMass&&(this.angularMass=1/this.angularMass),B.Vec2.SubVV(B.Vec2.AddVV(r,f,B.Vec2.s_t0),B.Vec2.AddVV(i,p,B.Vec2.s_t1),this.linearError),this.angularError=a-s-this.angularOffset,t.step.warmStarting?(this.linearImpulse.SelfMul(t.step.dtRatio),this.angularImpulse*=t.step.dtRatio,e=this.linearImpulse,o.SelfMulSub(d,e),n-=V*(B.Vec2.CrossVV(p,e)+this.angularImpulse),l.SelfMulAdd(y,e),c+=v*(B.Vec2.CrossVV(f,e)+this.angularImpulse)):(this.linearImpulse.SetZero(),this.angularImpulse=0),t.velocities[this.indexA].w=n,t.velocities[this.indexB].w=c},A.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.indexA].v,i=t.velocities[this.indexA].w,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=this.invMassA,r=this.invMassB,a=this.invIA,l=this.invIB,c=t.step.dt,h=t.step.inv_dt,u=o-i+h*this.correctionFactor*this.angularError,p=-this.angularMass*u,f=this.angularImpulse,d=c*this.maxTorque;this.angularImpulse=B.Clamp(this.angularImpulse+p,-d,d),i-=a*(p=this.angularImpulse-f),o+=l*p;var y=this.rA,V=this.rB,v=B.Vec2.AddVV(B.Vec2.SubVV(B.Vec2.AddVV(s,B.Vec2.CrossSV(o,V,B.Vec2.s_t0),B.Vec2.s_t0),B.Vec2.AddVV(e,B.Vec2.CrossSV(i,y,B.Vec2.s_t1),B.Vec2.s_t1),B.Vec2.s_t2),B.Vec2.MulSV(h*this.correctionFactor,this.linearError,B.Vec2.s_t3),A.SolveVelocityConstraints_s_Cdot_v2),x=B.Mat22.MulMV(this.linearMass,v,A.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),S=A.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.linearImpulse);this.linearImpulse.SelfAdd(x);d=c*this.maxForce;this.linearImpulse.LengthSquared()>d*d&&(this.linearImpulse.Normalize(),this.linearImpulse.SelfMul(d)),B.Vec2.SubVV(this.linearImpulse,S,x),e.SelfMulSub(n,x),i-=a*B.Vec2.CrossVV(y,x),s.SelfMulAdd(r,x),o+=l*B.Vec2.CrossVV(V,x),t.velocities[this.indexA].w=i,t.velocities[this.indexB].w=o},A.prototype.SolvePositionConstraints=function(t){return!0},A.prototype.Dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: MotorJointDef = new MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.linearOffset.x,this.linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.angularOffset),t("  jd.maxForce = %.15f;\n",this.maxForce),t("  jd.maxTorque = %.15f;\n",this.maxTorque),t("  jd.correctionFactor = %.15f;\n",this.correctionFactor),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},A.SolveVelocityConstraints_s_Cdot_v2=new B.Vec2,A.SolveVelocityConstraints_s_impulse_v2=new B.Vec2,A.SolveVelocityConstraints_s_oldImpulse_v2=new B.Vec2,A);function A(t){var e=s.call(this,t)||this;return e.linearOffset=new B.Vec2,e.angularOffset=0,e.linearImpulse=new B.Vec2,e.angularImpulse=0,e.maxForce=0,e.maxTorque=0,e.correctionFactor=.3,e.indexA=0,e.indexB=0,e.rA=new B.Vec2,e.rB=new B.Vec2,e.localCenterA=new B.Vec2,e.localCenterB=new B.Vec2,e.linearError=new B.Vec2,e.angularError=0,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.linearMass=new B.Mat22,e.angularMass=0,e.qA=new B.Rot,e.qB=new B.Rot,e.K=new B.Mat22,e.linearOffset.Copy(B.Maybe(t.linearOffset,B.Vec2.ZERO)),e.linearImpulse.SetZero(),e.maxForce=B.Maybe(t.maxForce,0),e.maxTorque=B.Maybe(t.maxTorque,0),e.correctionFactor=B.Maybe(t.correctionFactor,.3),e}B.MotorJoint=o}(b2=b2||{}),function(p){var e,t=(e=p.JointDef,__extends(i,e),i);function i(){var t=e.call(this,p.JointType.e_mouseJoint)||this;return t.target=new p.Vec2,t.maxForce=0,t.stiffness=5,t.damping=.7,t}p.MouseJointDef=t;var s,o=(s=p.Joint,__extends(a,s),a.prototype.SetTarget=function(t){this.bodyB.IsAwake()||this.bodyB.SetAwake(!0),this.targetA.Copy(t)},a.prototype.GetTarget=function(){return this.targetA},a.prototype.SetMaxForce=function(t){this.maxForce=t},a.prototype.GetMaxForce=function(){return this.maxForce},a.prototype.SetStiffness=function(t){this.stiffness=t},a.prototype.GetStiffness=function(){return this.stiffness},a.prototype.SetDamping=function(t){this.damping=t},a.prototype.GetDamping=function(){return this.damping},a.prototype.InitVelocityConstraints=function(t){this.indexB=this.bodyB.islandIndex,this.localCenterB.Copy(this.bodyB.sweep.localCenter),this.invMassB=this.bodyB.invMass,this.invIB=this.bodyB.invI;var e=t.positions[this.indexB].c,i=t.positions[this.indexB].a,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=this.qB.SetAngle(i),r=this.bodyB.GetMass(),a=2*p.pi*this.stiffness,l=2*r*this.damping*a,c=r*(a*a),h=t.step.dt;this.gamma=h*(l+h*c),0!==this.gamma&&(this.gamma=1/this.gamma),this.beta=h*c*this.gamma,p.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),p.Rot.MulRV(n,this.lalcB,this.rB);var u=this.K;u.ex.x=this.invMassB+this.invIB*this.rB.y*this.rB.y+this.gamma,u.ex.y=-this.invIB*this.rB.x*this.rB.y,u.ey.x=u.ex.y,u.ey.y=this.invMassB+this.invIB*this.rB.x*this.rB.x+this.gamma,u.GetInverse(this.mass),this.C.x=e.x+this.rB.x-this.targetA.x,this.C.y=e.y+this.rB.y-this.targetA.y,this.C.SelfMul(this.beta),o*=.98,t.step.warmStarting?(this.impulse.SelfMul(t.step.dtRatio),s.x+=this.invMassB*this.impulse.x,s.y+=this.invMassB*this.impulse.y,o+=this.invIB*p.Vec2.CrossVV(this.rB,this.impulse)):this.impulse.SetZero(),t.velocities[this.indexB].w=o},a.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.indexB].v,i=t.velocities[this.indexB].w,s=p.Vec2.AddVCrossSV(e,i,this.rB,a.SolveVelocityConstraints_s_Cdot),o=p.Mat22.MulMV(this.mass,p.Vec2.AddVV(s,p.Vec2.AddVV(this.C,p.Vec2.MulSV(this.gamma,this.impulse,p.Vec2.s_t0),p.Vec2.s_t0),p.Vec2.s_t0).SelfNeg(),a.SolveVelocityConstraints_s_impulse),n=a.SolveVelocityConstraints_s_oldImpulse.Copy(this.impulse);this.impulse.SelfAdd(o);var r=t.step.dt*this.maxForce;this.impulse.LengthSquared()>r*r&&this.impulse.SelfMul(r/this.impulse.Length()),p.Vec2.SubVV(this.impulse,n,o),e.SelfMulAdd(this.invMassB,o),i+=this.invIB*p.Vec2.CrossVV(this.rB,o),t.velocities[this.indexB].w=i},a.prototype.SolvePositionConstraints=function(t){return!0},a.prototype.GetAnchorA=function(t){return t.x=this.targetA.x,t.y=this.targetA.y,t},a.prototype.GetAnchorB=function(t){return this.bodyB.GetWorldPoint(this.localAnchorB,t)},a.prototype.GetReactionForce=function(t,e){return p.Vec2.MulSV(t,this.impulse,e)},a.prototype.GetReactionTorque=function(t){return 0},a.prototype.Dump=function(t){t("Mouse joint dumping is not supported.\n")},a.prototype.ShiftOrigin=function(t){this.targetA.SelfSub(t)},a.SolveVelocityConstraints_s_Cdot=new p.Vec2,a.SolveVelocityConstraints_s_impulse=new p.Vec2,a.SolveVelocityConstraints_s_oldImpulse=new p.Vec2,a);function a(t){var e=s.call(this,t)||this;return e.localAnchorB=new p.Vec2,e.targetA=new p.Vec2,e.stiffness=0,e.damping=0,e.beta=0,e.impulse=new p.Vec2,e.maxForce=0,e.gamma=0,e.indexA=0,e.indexB=0,e.rB=new p.Vec2,e.localCenterB=new p.Vec2,e.invMassB=0,e.invIB=0,e.mass=new p.Mat22,e.C=new p.Vec2,e.qB=new p.Rot,e.lalcB=new p.Vec2,e.K=new p.Mat22,e.targetA.Copy(p.Maybe(t.target,p.Vec2.ZERO)),p.Transform.MulTXV(e.bodyB.GetTransform(),e.targetA,e.localAnchorB),e.maxForce=p.Maybe(t.maxForce,0),e.impulse.SetZero(),e.stiffness=p.Maybe(t.stiffness,0),e.damping=p.Maybe(t.damping,0),e.beta=0,e.gamma=0,e}p.MouseJoint=o}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.Create=function(){return new i},i.Destroy=function(t){},i.prototype.Evaluate=function(t,e,i){s.CollidePolygonAndCircle(t,this.GetShapeA(),e,this.GetShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.PolygonAndCircleContact=e}(b2=b2||{}),function(s){var t,e=(t=s.Contact,__extends(i,t),i.Create=function(){return new i},i.Destroy=function(t){},i.prototype.Evaluate=function(t,e,i){s.CollidePolygons(t,this.GetShapeA(),e,this.GetShapeB(),i)},i);function i(){return null!==t&&t.apply(this,arguments)||this}s.PolygonContact=e}(b2=b2||{}),function(E){var e,t=(e=E.JointDef,__extends(i,e),i.prototype.Initialize=function(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(s,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i);function i(){var t=e.call(this,E.JointType.e_prismaticJoint)||this;return t.localAnchorA=new E.Vec2,t.localAnchorB=new E.Vec2,t.localAxisA=new E.Vec2(1,0),t.referenceAngle=0,t.enableLimit=!1,t.lowerTranslation=0,t.upperTranslation=0,t.enableMotor=!1,t.maxMotorForce=0,t.motorSpeed=0,t}E.PrismaticJointDef=t;var s,o=(s=E.Joint,__extends(z,s),z.prototype.InitVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.Copy(this.bodyA.sweep.localCenter),this.localCenterB.Copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.velocities[this.indexA].v,o=t.velocities[this.indexA].w,n=t.positions[this.indexB].c,r=t.positions[this.indexB].a,a=t.velocities[this.indexB].v,l=t.velocities[this.indexB].w,c=this.qA.SetAngle(i),h=this.qB.SetAngle(r);E.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var u=E.Rot.MulRV(c,this.lalcA,this.rA);E.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var p,f,d,y,V=E.Rot.MulRV(h,this.lalcB,this.rB),v=E.Vec2.AddVV(E.Vec2.SubVV(n,e,E.Vec2.s_t0),E.Vec2.SubVV(V,u,E.Vec2.s_t1),z.InitVelocityConstraints_s_d),x=this.invMassA,S=this.invMassB,B=this.invIA,A=this.invIB;E.Rot.MulRV(c,this.localXAxisA,this.axis),this.a1=E.Vec2.CrossVV(E.Vec2.AddVV(v,u,E.Vec2.s_t0),this.axis),this.a2=E.Vec2.CrossVV(V,this.axis),this.axialMass=x+S+B*this.a1*this.a1+A*this.a2*this.a2,0<this.axialMass&&(this.axialMass=1/this.axialMass),E.Rot.MulRV(c,this.localYAxisA,this.perp),this.s1=E.Vec2.CrossVV(E.Vec2.AddVV(v,u,E.Vec2.s_t0),this.perp),this.s2=E.Vec2.CrossVV(V,this.perp),this.K.ex.x=x+S+B*this.s1*this.s1+A*this.s2*this.s2,this.K.ex.y=B*this.s1+A*this.s2,this.K.ey.x=this.K.ex.y,this.K.ey.y=B+A,0===this.K.ey.y&&(this.K.ey.y=1),this.enableLimit?this.translation=E.Vec2.DotVV(this.axis,v):(this.lowerImpulse=0,this.upperImpulse=0),this.enableMotor||(this.motorImpulse=0),t.step.warmStarting?(this.impulse.SelfMul(t.step.dtRatio),this.motorImpulse*=t.step.dtRatio,this.lowerImpulse*=t.step.dtRatio,this.upperImpulse*=t.step.dtRatio,p=this.motorImpulse+this.lowerImpulse-this.upperImpulse,f=E.Vec2.AddVV(E.Vec2.MulSV(this.impulse.x,this.perp,E.Vec2.s_t0),E.Vec2.MulSV(p,this.axis,E.Vec2.s_t1),z.InitVelocityConstraints_s_P),d=this.impulse.x*this.s1+this.impulse.y+p*this.a1,y=this.impulse.x*this.s2+this.impulse.y+p*this.a2,s.SelfMulSub(x,f),o-=B*d,a.SelfMulAdd(S,f),l+=A*y):(this.impulse.SetZero(),this.motorImpulse=0,this.lowerImpulse=0,this.upperImpulse=0),t.velocities[this.indexA].w=o,t.velocities[this.indexB].w=l},z.prototype.SolveVelocityConstraints=function(t){var e,i,s,o,n,r=t.velocities[this.indexA].v,a=t.velocities[this.indexA].w,l=t.velocities[this.indexB].v,c=t.velocities[this.indexB].w,h=this.invMassA,u=this.invMassB,p=this.invIA,f=this.invIB;this.enableMotor&&(s=E.Vec2.DotVV(this.axis,E.Vec2.SubVV(l,r,E.Vec2.s_t0))+this.a2*c-this.a1*a,o=this.axialMass*(this.motorSpeed-s),n=this.motorImpulse,e=t.step.dt*this.maxMotorForce,this.motorImpulse=E.Clamp(this.motorImpulse+o,-e,e),o=this.motorImpulse-n,v=E.Vec2.MulSV(o,this.axis,z.SolveVelocityConstraints_s_P),x=o*this.a1,S=o*this.a2,r.SelfMulSub(h,v),a-=p*x,l.SelfMulAdd(u,v),c+=f*S),this.enableLimit&&(i=this.translation-this.lowerTranslation,s=E.Vec2.DotVV(this.axis,E.Vec2.SubVV(l,r,E.Vec2.s_t0))+this.a2*c-this.a1*a,o=-this.axialMass*(s+E.Max(i,0)*t.step.inv_dt),n=this.lowerImpulse,this.lowerImpulse=E.Max(this.lowerImpulse+o,0),o=this.lowerImpulse-n,v=E.Vec2.MulSV(o,this.axis,z.SolveVelocityConstraints_s_P),x=o*this.a1,S=o*this.a2,r.SelfMulSub(h,v),a-=p*x,l.SelfMulAdd(u,v),c+=f*S,i=this.upperTranslation-this.translation,s=E.Vec2.DotVV(this.axis,E.Vec2.SubVV(r,l,E.Vec2.s_t0))+this.a1*a-this.a2*c,o=-this.axialMass*(s+E.Max(i,0)*t.step.inv_dt),n=this.upperImpulse,this.upperImpulse=E.Max(this.upperImpulse+o,0),o=this.upperImpulse-n,v=E.Vec2.MulSV(o,this.axis,z.SolveVelocityConstraints_s_P),x=o*this.a1,S=o*this.a2,r.SelfMulAdd(h,v),a+=p*x,l.SelfMulSub(u,v),c-=f*S);var d=E.Vec2.DotVV(this.perp,E.Vec2.SubVV(l,r,E.Vec2.s_t0))+this.s2*c-this.s1*a,y=c-a,V=this.K.Solve(-d,-y,z.SolveVelocityConstraints_s_df);this.impulse.SelfAdd(V);var v=E.Vec2.MulSV(V.x,this.perp,z.SolveVelocityConstraints_s_P),x=V.x*this.s1+V.y,S=V.x*this.s2+V.y;r.SelfMulSub(h,v),a-=p*x,l.SelfMulAdd(u,v),c+=f*S,t.velocities[this.indexA].w=a,t.velocities[this.indexB].w=c},z.prototype.SolvePositionConstraints=function(t){var e,i,s,o,n,r,a,l,c,h,u=t.positions[this.indexA].c,p=t.positions[this.indexA].a,f=t.positions[this.indexB].c,d=t.positions[this.indexB].a,y=this.qA.SetAngle(p),V=this.qB.SetAngle(d),v=this.invMassA,x=this.invMassB,S=this.invIA,B=this.invIB,A=E.Rot.MulRV(y,this.lalcA,this.rA),C=E.Rot.MulRV(V,this.lalcB,this.rB),m=E.Vec2.SubVV(E.Vec2.AddVV(f,C,E.Vec2.s_t0),E.Vec2.AddVV(u,A,E.Vec2.s_t1),z.SolvePositionConstraints_s_d),g=E.Rot.MulRV(y,this.localXAxisA,this.axis),w=E.Vec2.CrossVV(E.Vec2.AddVV(m,A,E.Vec2.s_t0),g),_=E.Vec2.CrossVV(C,g),b=E.Rot.MulRV(y,this.localYAxisA,this.perp),M=E.Vec2.CrossVV(E.Vec2.AddVV(m,A,E.Vec2.s_t0),b),P=E.Vec2.CrossVV(C,b),I=z.SolvePositionConstraints_s_impulse,D=E.Vec2.DotVV(b,m),G=d-p-this.referenceAngle,T=E.Abs(D),F=E.Abs(G),R=!1,L=0;this.enableLimit&&(e=E.Vec2.DotVV(g,m),E.Abs(this.upperTranslation-this.lowerTranslation)<2*E.linearSlop?(L=e,T=E.Max(T,E.Abs(e)),R=!0):e<=this.lowerTranslation?(L=E.Min(e-this.lowerTranslation,0),T=E.Max(T,this.lowerTranslation-e),R=!0):e>=this.upperTranslation&&(L=E.Max(e-this.upperTranslation,0),T=E.Max(T,e-this.upperTranslation),R=!0)),R?(r=v+x+S*M*M+B*P*P,a=S*M+B*P,i=S*M*w+B*P*_,0===(l=S+B)&&(l=1),s=S*w+B*_,o=v+x+S*w*w+B*_*_,(n=this.K3).ex.SetXYZ(r,a,i),n.ey.SetXYZ(a,l,s),n.ez.SetXYZ(i,s,o),I=n.Solve33(-D,-G,-L,I)):(r=v+x+S*M*M+B*P*P,a=S*M+B*P,0===(l=S+B)&&(l=1),(c=this.K2).ex.Set(r,a),c.ey.Set(a,l),h=c.Solve(-D,-G,z.SolvePositionConstraints_s_impulse1),I.x=h.x,I.y=h.y,I.z=0);var k=E.Vec2.AddVV(E.Vec2.MulSV(I.x,b,E.Vec2.s_t0),E.Vec2.MulSV(I.z,g,E.Vec2.s_t1),z.SolvePositionConstraints_s_P),q=I.x*M+I.y+I.z*w,J=I.x*P+I.y+I.z*_;return u.SelfMulSub(v,k),p-=S*q,f.SelfMulAdd(x,k),d+=B*J,t.positions[this.indexA].a=p,t.positions[this.indexB].a=d,T<=E.linearSlop&&F<=E.angularSlop},z.prototype.GetAnchorA=function(t){return this.bodyA.GetWorldPoint(this.localAnchorA,t)},z.prototype.GetAnchorB=function(t){return this.bodyB.GetWorldPoint(this.localAnchorB,t)},z.prototype.GetReactionForce=function(t,e){return e.x=t*(this.impulse.x*this.perp.x+(this.motorImpulse+this.lowerImpulse-this.upperImpulse)*this.axis.x),e.y=t*(this.impulse.y*this.perp.y+(this.motorImpulse+this.lowerImpulse-this.upperImpulse)*this.axis.y),e},z.prototype.GetReactionTorque=function(t){return t*this.impulse.y},z.prototype.GetLocalAnchorA=function(){return this.localAnchorA},z.prototype.GetLocalAnchorB=function(){return this.localAnchorB},z.prototype.GetLocalAxisA=function(){return this.localXAxisA},z.prototype.GetReferenceAngle=function(){return this.referenceAngle},z.prototype.GetJointTranslation=function(){var t=this.bodyA.GetWorldPoint(this.localAnchorA,z.GetJointTranslation_s_pA),e=this.bodyB.GetWorldPoint(this.localAnchorB,z.GetJointTranslation_s_pB),i=E.Vec2.SubVV(e,t,z.GetJointTranslation_s_d),s=this.bodyA.GetWorldVector(this.localXAxisA,z.GetJointTranslation_s_axis);return E.Vec2.DotVV(i,s)},z.prototype.GetJointSpeed=function(){var t=this.bodyA,e=this.bodyB;E.Vec2.SubVV(this.localAnchorA,t.sweep.localCenter,this.lalcA);var i=E.Rot.MulRV(t.xf.q,this.lalcA,this.rA);E.Vec2.SubVV(this.localAnchorB,e.sweep.localCenter,this.lalcB);var s=E.Rot.MulRV(e.xf.q,this.lalcB,this.rB),o=E.Vec2.AddVV(t.sweep.c,i,E.Vec2.s_t0),n=E.Vec2.AddVV(e.sweep.c,s,E.Vec2.s_t1),r=E.Vec2.SubVV(n,o,E.Vec2.s_t2),a=t.GetWorldVector(this.localXAxisA,this.axis),l=t.linearVelocity,c=e.linearVelocity,h=t.angularVelocity,u=e.angularVelocity;return E.Vec2.DotVV(r,E.Vec2.CrossSV(h,a,E.Vec2.s_t0))+E.Vec2.DotVV(a,E.Vec2.SubVV(E.Vec2.AddVCrossSV(c,u,s,E.Vec2.s_t0),E.Vec2.AddVCrossSV(l,h,i,E.Vec2.s_t1),E.Vec2.s_t0))},z.prototype.IsLimitEnabled=function(){return this.enableLimit},z.prototype.EnableLimit=function(t){t!==this.enableLimit&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.enableLimit=t,this.lowerImpulse=0,this.upperImpulse=0)},z.prototype.GetLowerLimit=function(){return this.lowerTranslation},z.prototype.GetUpperLimit=function(){return this.upperTranslation},z.prototype.SetLimits=function(t,e){t===this.lowerTranslation&&e===this.upperTranslation||(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.lowerTranslation=t,this.upperTranslation=e,this.lowerImpulse=0,this.upperImpulse=0)},z.prototype.IsMotorEnabled=function(){return this.enableMotor},z.prototype.EnableMotor=function(t){t!==this.enableMotor&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.enableMotor=t)},z.prototype.SetMotorSpeed=function(t){t!==this.motorSpeed&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.motorSpeed=t)},z.prototype.GetMotorSpeed=function(){return this.motorSpeed},z.prototype.SetMaxMotorForce=function(t){t!==this.maxMotorForce&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.maxMotorForce=t)},z.prototype.GetMaxMotorForce=function(){return this.maxMotorForce},z.prototype.GetMotorForce=function(t){return t*this.motorImpulse},z.prototype.Dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: PrismaticJointDef = new PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.localXAxisA.x,this.localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.referenceAngle),t("  jd.enableLimit = %s;\n",this.enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.upperTranslation),t("  jd.enableMotor = %s;\n",this.enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.maxMotorForce),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},z.prototype.Draw=function(t){var e,i,s,o=this.bodyA.GetTransform(),n=this.bodyB.GetTransform(),r=E.Transform.MulXV(o,this.localAnchorA,z.Draw_s_pA),a=E.Transform.MulXV(n,this.localAnchorB,z.Draw_s_pB),l=E.Rot.MulRV(o.q,this.localXAxisA,z.Draw_s_axis),c=z.Draw_s_c1,h=z.Draw_s_c2,u=z.Draw_s_c3,p=z.Draw_s_c4,f=z.Draw_s_c5;t.DrawSegment(r,a,f),this.enableLimit?(e=E.Vec2.AddVMulSV(r,this.lowerTranslation,l,z.Draw_s_lower),i=E.Vec2.AddVMulSV(r,this.upperTranslation,l,z.Draw_s_upper),s=E.Rot.MulRV(o.q,this.localYAxisA,z.Draw_s_perp),t.DrawSegment(e,i,c),t.DrawSegment(E.Vec2.AddVMulSV(e,-.5,s,E.Vec2.s_t0),E.Vec2.AddVMulSV(e,.5,s,E.Vec2.s_t1),h),t.DrawSegment(E.Vec2.AddVMulSV(i,-.5,s,E.Vec2.s_t0),E.Vec2.AddVMulSV(i,.5,s,E.Vec2.s_t1),u)):t.DrawSegment(E.Vec2.AddVMulSV(r,-1,l,E.Vec2.s_t0),E.Vec2.AddVMulSV(r,1,l,E.Vec2.s_t1),c),t.DrawPoint(r,5,c),t.DrawPoint(a,5,p)},z.InitVelocityConstraints_s_d=new E.Vec2,z.InitVelocityConstraints_s_P=new E.Vec2,z.SolveVelocityConstraints_s_P=new E.Vec2,z.SolveVelocityConstraints_s_df=new E.Vec2,z.SolvePositionConstraints_s_d=new E.Vec2,z.SolvePositionConstraints_s_impulse=new E.Vec3,z.SolvePositionConstraints_s_impulse1=new E.Vec2,z.SolvePositionConstraints_s_P=new E.Vec2,z.GetJointTranslation_s_pA=new E.Vec2,z.GetJointTranslation_s_pB=new E.Vec2,z.GetJointTranslation_s_d=new E.Vec2,z.GetJointTranslation_s_axis=new E.Vec2,z.Draw_s_pA=new E.Vec2,z.Draw_s_pB=new E.Vec2,z.Draw_s_axis=new E.Vec2,z.Draw_s_c1=new E.Color(.7,.7,.7),z.Draw_s_c2=new E.Color(.3,.9,.3),z.Draw_s_c3=new E.Color(.9,.3,.3),z.Draw_s_c4=new E.Color(.3,.3,.9),z.Draw_s_c5=new E.Color(.4,.4,.4),z.Draw_s_lower=new E.Vec2,z.Draw_s_upper=new E.Vec2,z.Draw_s_perp=new E.Vec2,z);function z(t){var e=s.call(this,t)||this;return e.localAnchorA=new E.Vec2,e.localAnchorB=new E.Vec2,e.localXAxisA=new E.Vec2,e.localYAxisA=new E.Vec2,e.referenceAngle=0,e.impulse=new E.Vec2(0,0),e.motorImpulse=0,e.lowerImpulse=0,e.upperImpulse=0,e.lowerTranslation=0,e.upperTranslation=0,e.maxMotorForce=0,e.motorSpeed=0,e.enableLimit=!1,e.enableMotor=!1,e.indexA=0,e.indexB=0,e.localCenterA=new E.Vec2,e.localCenterB=new E.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.axis=new E.Vec2(0,0),e.perp=new E.Vec2(0,0),e.s1=0,e.s2=0,e.a1=0,e.a2=0,e.K=new E.Mat22,e.K3=new E.Mat33,e.K2=new E.Mat22,e.translation=0,e.axialMass=0,e.qA=new E.Rot,e.qB=new E.Rot,e.lalcA=new E.Vec2,e.lalcB=new E.Vec2,e.rA=new E.Vec2,e.rB=new E.Vec2,e.localAnchorA.Copy(E.Maybe(t.localAnchorA,E.Vec2.ZERO)),e.localAnchorB.Copy(E.Maybe(t.localAnchorB,E.Vec2.ZERO)),e.localXAxisA.Copy(E.Maybe(t.localAxisA,new E.Vec2(1,0))).SelfNormalize(),E.Vec2.CrossOneV(e.localXAxisA,e.localYAxisA),e.referenceAngle=E.Maybe(t.referenceAngle,0),e.lowerTranslation=E.Maybe(t.lowerTranslation,0),e.upperTranslation=E.Maybe(t.upperTranslation,0),e.maxMotorForce=E.Maybe(t.maxMotorForce,0),e.motorSpeed=E.Maybe(t.motorSpeed,0),e.enableLimit=E.Maybe(t.enableLimit,!1),e.enableMotor=E.Maybe(t.enableMotor,!1),e}E.PrismaticJoint=o}(b2=b2||{}),function(m){m.minPulleyLength=2;var e,t=(e=m.JointDef,__extends(i,e),i.prototype.Initialize=function(t,e,i,s,o,n,r){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(s),this.bodyA.GetLocalPoint(o,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.lengthA=m.Vec2.DistanceVV(o,i),this.lengthB=m.Vec2.DistanceVV(n,s),this.ratio=r},i);function i(){var t=e.call(this,m.JointType.e_pulleyJoint)||this;return t.groundAnchorA=new m.Vec2(-1,1),t.groundAnchorB=new m.Vec2(1,1),t.localAnchorA=new m.Vec2(-1,0),t.localAnchorB=new m.Vec2(1,0),t.lengthA=0,t.lengthB=0,t.ratio=1,t.collideConnected=!0,t}m.PulleyJointDef=t;var s,o=(s=m.Joint,__extends(g,s),g.prototype.InitVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.Copy(this.bodyA.sweep.localCenter),this.localCenterB.Copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.velocities[this.indexA].v,o=t.velocities[this.indexA].w,n=t.positions[this.indexB].c,r=t.positions[this.indexB].a,a=t.velocities[this.indexB].v,l=t.velocities[this.indexB].w,c=this.qA.SetAngle(i),h=this.qB.SetAngle(r);m.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),m.Rot.MulRV(c,this.lalcA,this.rA),m.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),m.Rot.MulRV(h,this.lalcB,this.rB),this.uA.Copy(e).SelfAdd(this.rA).SelfSub(this.groundAnchorA),this.uB.Copy(n).SelfAdd(this.rB).SelfSub(this.groundAnchorB);var u=this.uA.Length(),p=this.uB.Length();u>10*m.linearSlop?this.uA.SelfMul(1/u):this.uA.SetZero(),p>10*m.linearSlop?this.uB.SelfMul(1/p):this.uB.SetZero();var f,d,y=m.Vec2.CrossVV(this.rA,this.uA),V=m.Vec2.CrossVV(this.rB,this.uB),v=this.invMassA+this.invIA*y*y,x=this.invMassB+this.invIB*V*V;this.mass=v+this.ratio*this.ratio*x,0<this.mass&&(this.mass=1/this.mass),t.step.warmStarting?(this.impulse*=t.step.dtRatio,f=m.Vec2.MulSV(-this.impulse,this.uA,g.InitVelocityConstraints_s_PA),d=m.Vec2.MulSV(-this.ratio*this.impulse,this.uB,g.InitVelocityConstraints_s_PB),s.SelfMulAdd(this.invMassA,f),o+=this.invIA*m.Vec2.CrossVV(this.rA,f),a.SelfMulAdd(this.invMassB,d),l+=this.invIB*m.Vec2.CrossVV(this.rB,d)):this.impulse=0,t.velocities[this.indexA].w=o,t.velocities[this.indexB].w=l},g.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.indexA].v,i=t.velocities[this.indexA].w,s=t.velocities[this.indexB].v,o=t.velocities[this.indexB].w,n=m.Vec2.AddVCrossSV(e,i,this.rA,g.SolveVelocityConstraints_s_vpA),r=m.Vec2.AddVCrossSV(s,o,this.rB,g.SolveVelocityConstraints_s_vpB),a=-m.Vec2.DotVV(this.uA,n)-this.ratio*m.Vec2.DotVV(this.uB,r),l=-this.mass*a;this.impulse+=l;var c=m.Vec2.MulSV(-l,this.uA,g.SolveVelocityConstraints_s_PA),h=m.Vec2.MulSV(-this.ratio*l,this.uB,g.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.invMassA,c),i+=this.invIA*m.Vec2.CrossVV(this.rA,c),s.SelfMulAdd(this.invMassB,h),o+=this.invIB*m.Vec2.CrossVV(this.rB,h),t.velocities[this.indexA].w=i,t.velocities[this.indexB].w=o},g.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.positions[this.indexB].c,o=t.positions[this.indexB].a,n=this.qA.SetAngle(i),r=this.qB.SetAngle(o);m.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var a=m.Rot.MulRV(n,this.lalcA,this.rA);m.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var l=m.Rot.MulRV(r,this.lalcB,this.rB),c=this.uA.Copy(e).SelfAdd(a).SelfSub(this.groundAnchorA),h=this.uB.Copy(s).SelfAdd(l).SelfSub(this.groundAnchorB),u=c.Length(),p=h.Length();u>10*m.linearSlop?c.SelfMul(1/u):c.SetZero(),p>10*m.linearSlop?h.SelfMul(1/p):h.SetZero();var f=m.Vec2.CrossVV(a,c),d=m.Vec2.CrossVV(l,h),y=this.invMassA+this.invIA*f*f,V=this.invMassB+this.invIB*d*d,v=y+this.ratio*this.ratio*V;0<v&&(v=1/v);var x=this.constant-u-this.ratio*p,S=m.Abs(x),B=-v*x,A=m.Vec2.MulSV(-B,c,g.SolvePositionConstraints_s_PA),C=m.Vec2.MulSV(-this.ratio*B,h,g.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.invMassA,A),i+=this.invIA*m.Vec2.CrossVV(a,A),s.SelfMulAdd(this.invMassB,C),o+=this.invIB*m.Vec2.CrossVV(l,C),t.positions[this.indexA].a=i,t.positions[this.indexB].a=o,S<m.linearSlop},g.prototype.GetAnchorA=function(t){return this.bodyA.GetWorldPoint(this.localAnchorA,t)},g.prototype.GetAnchorB=function(t){return this.bodyB.GetWorldPoint(this.localAnchorB,t)},g.prototype.GetReactionForce=function(t,e){return e.x=t*this.impulse*this.uB.x,e.y=t*this.impulse*this.uB.y,e},g.prototype.GetReactionTorque=function(t){return 0},g.prototype.GetGroundAnchorA=function(){return this.groundAnchorA},g.prototype.GetGroundAnchorB=function(){return this.groundAnchorB},g.prototype.GetLengthA=function(){return this.lengthA},g.prototype.GetLengthB=function(){return this.lengthB},g.prototype.GetRatio=function(){return this.ratio},g.prototype.GetCurrentLengthA=function(){var t=this.bodyA.GetWorldPoint(this.localAnchorA,g.GetCurrentLengthA_s_p),e=this.groundAnchorA;return m.Vec2.DistanceVV(t,e)},g.prototype.GetCurrentLengthB=function(){var t=this.bodyB.GetWorldPoint(this.localAnchorB,g.GetCurrentLengthB_s_p),e=this.groundAnchorB;return m.Vec2.DistanceVV(t,e)},g.prototype.Dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: PulleyJointDef = new PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.groundAnchorA.x,this.groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.groundAnchorB.x,this.groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.lengthA),t("  jd.lengthB = %.15f;\n",this.lengthB),t("  jd.ratio = %.15f;\n",this.ratio),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},g.prototype.ShiftOrigin=function(t){this.groundAnchorA.SelfSub(t),this.groundAnchorB.SelfSub(t)},g.InitVelocityConstraints_s_PA=new m.Vec2,g.InitVelocityConstraints_s_PB=new m.Vec2,g.SolveVelocityConstraints_s_vpA=new m.Vec2,g.SolveVelocityConstraints_s_vpB=new m.Vec2,g.SolveVelocityConstraints_s_PA=new m.Vec2,g.SolveVelocityConstraints_s_PB=new m.Vec2,g.SolvePositionConstraints_s_PA=new m.Vec2,g.SolvePositionConstraints_s_PB=new m.Vec2,g.GetCurrentLengthA_s_p=new m.Vec2,g.GetCurrentLengthB_s_p=new m.Vec2,g);function g(t){var e=s.call(this,t)||this;return e.groundAnchorA=new m.Vec2,e.groundAnchorB=new m.Vec2,e.lengthA=0,e.lengthB=0,e.localAnchorA=new m.Vec2,e.localAnchorB=new m.Vec2,e.constant=0,e.ratio=0,e.impulse=0,e.indexA=0,e.indexB=0,e.uA=new m.Vec2,e.uB=new m.Vec2,e.rA=new m.Vec2,e.rB=new m.Vec2,e.localCenterA=new m.Vec2,e.localCenterB=new m.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.mass=0,e.qA=new m.Rot,e.qB=new m.Rot,e.lalcA=new m.Vec2,e.lalcB=new m.Vec2,e.groundAnchorA.Copy(m.Maybe(t.groundAnchorA,new m.Vec2(-1,1))),e.groundAnchorB.Copy(m.Maybe(t.groundAnchorB,new m.Vec2(1,0))),e.localAnchorA.Copy(m.Maybe(t.localAnchorA,new m.Vec2(-1,0))),e.localAnchorB.Copy(m.Maybe(t.localAnchorB,new m.Vec2(1,0))),e.lengthA=m.Maybe(t.lengthA,0),e.lengthB=m.Maybe(t.lengthB,0),e.ratio=m.Maybe(t.ratio,1),e.constant=m.Maybe(t.lengthA,0)+e.ratio*m.Maybe(t.lengthB,0),e.impulse=0,e}m.PulleyJoint=o}(b2=b2||{}),function(C){var e,t=(e=C.JointDef,__extends(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i);function i(){var t=e.call(this,C.JointType.e_revoluteJoint)||this;return t.localAnchorA=new C.Vec2(0,0),t.localAnchorB=new C.Vec2(0,0),t.referenceAngle=0,t.enableLimit=!1,t.lowerAngle=0,t.upperAngle=0,t.enableMotor=!1,t.motorSpeed=0,t.maxMotorTorque=0,t}C.RevoluteJointDef=t;var s,o=(s=C.Joint,__extends(m,s),m.prototype.InitVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.Copy(this.bodyA.sweep.localCenter),this.localCenterB.Copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].a,i=t.velocities[this.indexA].v,s=t.velocities[this.indexA].w,o=t.positions[this.indexB].a,n=t.velocities[this.indexB].v,r=t.velocities[this.indexB].w,a=this.qA.SetAngle(e),l=this.qB.SetAngle(o);C.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),C.Rot.MulRV(a,this.lalcA,this.rA),C.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),C.Rot.MulRV(l,this.lalcB,this.rB);var c,h,u,p=this.invMassA,f=this.invMassB,d=this.invIA,y=this.invIB;this.K.ex.x=p+f+this.rA.y*this.rA.y*d+this.rB.y*this.rB.y*y,this.K.ey.x=-this.rA.y*this.rA.x*d-this.rB.y*this.rB.x*y,this.K.ex.y=this.K.ey.x,this.K.ey.y=p+f+this.rA.x*this.rA.x*d+this.rB.x*this.rB.x*y,this.axialMass=d+y,c=!(0<this.axialMass)||(this.axialMass=1/this.axialMass,!1),this.angle=o-e-this.referenceAngle,!1!==this.enableLimit&&!c||(this.lowerImpulse=0,this.upperImpulse=0),!1!==this.enableMotor&&!c||(this.motorImpulse=0),t.step.warmStarting?(this.impulse.SelfMul(t.step.dtRatio),this.motorImpulse*=t.step.dtRatio,this.lowerImpulse*=t.step.dtRatio,this.upperImpulse*=t.step.dtRatio,h=this.motorImpulse+this.lowerImpulse-this.upperImpulse,u=m.InitVelocityConstraints_s_P.Set(this.impulse.x,this.impulse.y),i.SelfMulSub(p,u),s-=d*(C.Vec2.CrossVV(this.rA,u)+h),n.SelfMulAdd(f,u),r+=y*(C.Vec2.CrossVV(this.rB,u)+h)):(this.impulse.SetZero(),this.motorImpulse=0,this.lowerImpulse=0,this.upperImpulse=0),t.velocities[this.indexA].w=s,t.velocities[this.indexB].w=r},m.prototype.SolveVelocityConstraints=function(t){var e,i,s,o,n,r=t.velocities[this.indexA].v,a=t.velocities[this.indexA].w,l=t.velocities[this.indexB].v,c=t.velocities[this.indexB].w,h=this.invMassA,u=this.invMassB,p=this.invIA,f=this.invIB,d=p+f===0;this.enableMotor&&!d&&(s=c-a-this.motorSpeed,o=-this.axialMass*s,n=this.motorImpulse,e=t.step.dt*this.maxMotorTorque,this.motorImpulse=C.Clamp(this.motorImpulse+o,-e,e),a-=p*(o=this.motorImpulse-n),c+=f*o),this.enableLimit&&!d&&(i=this.angle-this.lowerAngle,s=c-a,o=-this.axialMass*(s+C.Max(i,0)*t.step.inv_dt),n=this.lowerImpulse,this.lowerImpulse=C.Max(this.lowerImpulse+o,0),a-=p*(o=this.lowerImpulse-n),c+=f*o,i=this.upperAngle-this.angle,s=a-c,o=-this.axialMass*(s+C.Max(i,0)*t.step.inv_dt),n=this.upperImpulse,this.upperImpulse=C.Max(this.upperImpulse+o,0),a+=p*(o=this.upperImpulse-n),c-=f*o);var y=C.Vec2.SubVV(C.Vec2.AddVCrossSV(l,c,this.rB,C.Vec2.s_t0),C.Vec2.AddVCrossSV(r,a,this.rA,C.Vec2.s_t1),m.SolveVelocityConstraints_s_Cdot_v2),V=this.K.Solve(-y.x,-y.y,m.SolveVelocityConstraints_s_impulse_v2);this.impulse.x+=V.x,this.impulse.y+=V.y,r.SelfMulSub(h,V),a-=p*C.Vec2.CrossVV(this.rA,V),l.SelfMulAdd(u,V),c+=f*C.Vec2.CrossVV(this.rB,V),t.velocities[this.indexA].w=a,t.velocities[this.indexB].w=c},m.prototype.SolvePositionConstraints=function(t){var e,i,s,o=t.positions[this.indexA].c,n=t.positions[this.indexA].a,r=t.positions[this.indexB].c,a=t.positions[this.indexB].a,l=this.qA.SetAngle(n),c=this.qB.SetAngle(a),h=0,u=this.invIA+this.invIB===0;this.enableLimit&&!u&&(e=a-n-this.referenceAngle,i=0,C.Abs(this.upperAngle-this.lowerAngle)<2*C.angularSlop?i=C.Clamp(e-this.lowerAngle,-C.maxAngularCorrection,C.maxAngularCorrection):e<=this.lowerAngle?i=C.Clamp(e-this.lowerAngle+C.angularSlop,-C.maxAngularCorrection,0):e>=this.upperAngle&&(i=C.Clamp(e-this.upperAngle-C.angularSlop,0,C.maxAngularCorrection)),s=-this.axialMass*i,n-=this.invIA*s,a+=this.invIB*s,h=C.Abs(i)),l.SetAngle(n),c.SetAngle(a),C.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var p=C.Rot.MulRV(l,this.lalcA,this.rA);C.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var f=C.Rot.MulRV(c,this.lalcB,this.rB),d=C.Vec2.SubVV(C.Vec2.AddVV(r,f,C.Vec2.s_t0),C.Vec2.AddVV(o,p,C.Vec2.s_t1),m.SolvePositionConstraints_s_C_v2),y=d.Length(),V=this.invMassA,v=this.invMassB,x=this.invIA,S=this.invIB,B=this.K;B.ex.x=V+v+x*p.y*p.y+S*f.y*f.y,B.ex.y=-x*p.x*p.y-S*f.x*f.y,B.ey.x=B.ex.y,B.ey.y=V+v+x*p.x*p.x+S*f.x*f.x;var A=B.Solve(d.x,d.y,m.SolvePositionConstraints_s_impulse).SelfNeg();return o.SelfMulSub(V,A),n-=x*C.Vec2.CrossVV(p,A),r.SelfMulAdd(v,A),a+=S*C.Vec2.CrossVV(f,A),t.positions[this.indexA].a=n,t.positions[this.indexB].a=a,y<=C.linearSlop&&h<=C.angularSlop},m.prototype.GetAnchorA=function(t){return this.bodyA.GetWorldPoint(this.localAnchorA,t)},m.prototype.GetAnchorB=function(t){return this.bodyB.GetWorldPoint(this.localAnchorB,t)},m.prototype.GetReactionForce=function(t,e){return e.x=t*this.impulse.x,e.y=t*this.impulse.y,e},m.prototype.GetReactionTorque=function(t){return t*(this.lowerImpulse-this.upperImpulse)},m.prototype.GetLocalAnchorA=function(){return this.localAnchorA},m.prototype.GetLocalAnchorB=function(){return this.localAnchorB},m.prototype.GetReferenceAngle=function(){return this.referenceAngle},m.prototype.GetJointAngle=function(){return this.bodyB.sweep.a-this.bodyA.sweep.a-this.referenceAngle},m.prototype.GetJointSpeed=function(){return this.bodyB.angularVelocity-this.bodyA.angularVelocity},m.prototype.IsMotorEnabled=function(){return this.enableMotor},m.prototype.EnableMotor=function(t){t!==this.enableMotor&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.enableMotor=t)},m.prototype.GetMotorTorque=function(t){return t*this.motorImpulse},m.prototype.GetMotorSpeed=function(){return this.motorSpeed},m.prototype.SetMaxMotorTorque=function(t){t!==this.maxMotorTorque&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.maxMotorTorque=t)},m.prototype.GetMaxMotorTorque=function(){return this.maxMotorTorque},m.prototype.IsLimitEnabled=function(){return this.enableLimit},m.prototype.EnableLimit=function(t){t!==this.enableLimit&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.enableLimit=t,this.lowerImpulse=0,this.upperImpulse=0)},m.prototype.GetLowerLimit=function(){return this.lowerAngle},m.prototype.GetUpperLimit=function(){return this.upperAngle},m.prototype.SetLimits=function(t,e){t===this.lowerAngle&&e===this.upperAngle||(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.lowerImpulse=0,this.upperImpulse=0,this.lowerAngle=t,this.upperAngle=e)},m.prototype.SetMotorSpeed=function(t){t!==this.motorSpeed&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.motorSpeed=t)},m.prototype.Dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: RevoluteJointDef = new RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.referenceAngle),t("  jd.enableLimit = %s;\n",this.enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.lowerAngle),t("  jd.upperAngle = %.15f;\n",this.upperAngle),t("  jd.enableMotor = %s;\n",this.enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.maxMotorTorque),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},m.prototype.Draw=function(t){var e=this.bodyA.GetTransform(),i=this.bodyB.GetTransform(),s=C.Transform.MulXV(e,this.localAnchorA,m.Draw_s_pA),o=C.Transform.MulXV(i,this.localAnchorB,m.Draw_s_pB),n=m.Draw_s_c1,r=m.Draw_s_c2,a=m.Draw_s_c3,l=m.Draw_s_c4,c=m.Draw_s_c5;t.DrawPoint(s,5,l),t.DrawPoint(o,5,c);var h,u,p=this.bodyA.GetAngle(),f=this.bodyB.GetAngle()-p-this.referenceAngle,d=m.Draw_s_r.Set(.5*Math.cos(f),.5*Math.sin(f));t.DrawSegment(o,C.Vec2.AddVV(o,d,C.Vec2.s_t0),n),t.DrawCircle(o,.5,n),this.enableLimit&&(h=m.Draw_s_rlo.Set(.5*Math.cos(this.lowerAngle),.5*Math.sin(this.lowerAngle)),u=m.Draw_s_rhi.Set(.5*Math.cos(this.upperAngle),.5*Math.sin(this.upperAngle)),t.DrawSegment(o,C.Vec2.AddVV(o,h,C.Vec2.s_t0),r),t.DrawSegment(o,C.Vec2.AddVV(o,u,C.Vec2.s_t0),a));var y=m.Draw_s_color_;t.DrawSegment(e.p,s,y),t.DrawSegment(s,o,y),t.DrawSegment(i.p,o,y)},m.InitVelocityConstraints_s_P=new C.Vec2,m.SolveVelocityConstraints_s_Cdot_v2=new C.Vec2,m.SolveVelocityConstraints_s_impulse_v2=new C.Vec2,m.SolvePositionConstraints_s_C_v2=new C.Vec2,m.SolvePositionConstraints_s_impulse=new C.Vec2,m.Draw_s_pA=new C.Vec2,m.Draw_s_pB=new C.Vec2,m.Draw_s_c1=new C.Color(.7,.7,.7),m.Draw_s_c2=new C.Color(.3,.9,.3),m.Draw_s_c3=new C.Color(.9,.3,.3),m.Draw_s_c4=new C.Color(.3,.3,.9),m.Draw_s_c5=new C.Color(.4,.4,.4),m.Draw_s_color_=new C.Color(.5,.8,.8),m.Draw_s_r=new C.Vec2,m.Draw_s_rlo=new C.Vec2,m.Draw_s_rhi=new C.Vec2,m);function m(t){var e=s.call(this,t)||this;return e.localAnchorA=new C.Vec2,e.localAnchorB=new C.Vec2,e.impulse=new C.Vec2,e.motorImpulse=0,e.lowerImpulse=0,e.upperImpulse=0,e.enableMotor=!1,e.maxMotorTorque=0,e.motorSpeed=0,e.enableLimit=!1,e.referenceAngle=0,e.lowerAngle=0,e.upperAngle=0,e.indexA=0,e.indexB=0,e.rA=new C.Vec2,e.rB=new C.Vec2,e.localCenterA=new C.Vec2,e.localCenterB=new C.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.K=new C.Mat22,e.angle=0,e.axialMass=0,e.qA=new C.Rot,e.qB=new C.Rot,e.lalcA=new C.Vec2,e.lalcB=new C.Vec2,e.localAnchorA.Copy(C.Maybe(t.localAnchorA,C.Vec2.ZERO)),e.localAnchorB.Copy(C.Maybe(t.localAnchorB,C.Vec2.ZERO)),e.referenceAngle=C.Maybe(t.referenceAngle,0),e.impulse.SetZero(),e.motorImpulse=0,e.lowerAngle=C.Maybe(t.lowerAngle,0),e.upperAngle=C.Maybe(t.upperAngle,0),e.maxMotorTorque=C.Maybe(t.maxMotorTorque,0),e.motorSpeed=C.Maybe(t.motorSpeed,0),e.enableLimit=C.Maybe(t.enableLimit,!1),e.enableMotor=C.Maybe(t.enableMotor,!1),e}C.RevoluteJoint=o}(b2=b2||{}),function(B){var e,t=(e=B.JointDef,__extends(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i);function i(){var t=e.call(this,B.JointType.e_weldJoint)||this;return t.localAnchorA=new B.Vec2,t.localAnchorB=new B.Vec2,t.referenceAngle=0,t.stiffness=0,t.damping=0,t}B.WeldJointDef=t;var s,o=(s=B.Joint,__extends(A,s),A.prototype.InitVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.Copy(this.bodyA.sweep.localCenter),this.localCenterB.Copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=t.positions[this.indexA].a,i=t.velocities[this.indexA].v,s=t.velocities[this.indexA].w,o=t.positions[this.indexB].a,n=t.velocities[this.indexB].v,r=t.velocities[this.indexB].w,a=this.qA.SetAngle(e),l=this.qB.SetAngle(o);B.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),B.Rot.MulRV(a,this.lalcA,this.rA),B.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),B.Rot.MulRV(l,this.lalcB,this.rB);var c,h,u,p,f,d,y=this.invMassA,V=this.invMassB,v=this.invIA,x=this.invIB,S=this.K;S.ex.x=y+V+this.rA.y*this.rA.y*v+this.rB.y*this.rB.y*x,S.ey.x=-this.rA.y*this.rA.x*v-this.rB.y*this.rB.x*x,S.ez.x=-this.rA.y*v-this.rB.y*x,S.ex.y=S.ey.x,S.ey.y=y+V+this.rA.x*this.rA.x*v+this.rB.x*this.rB.x*x,S.ez.y=this.rA.x*v+this.rB.x*x,S.ex.z=S.ez.x,S.ey.z=S.ez.y,S.ez.z=v+x,0<this.stiffness?(S.GetInverse22(this.mass),c=v+x,h=o-e-this.referenceAngle,u=this.damping,p=this.stiffness,f=t.step.dt,this.gamma=f*(u+f*p),this.gamma=0!==this.gamma?1/this.gamma:0,this.bias=h*f*p*this.gamma,c+=this.gamma,this.mass.ez.z=0!==c?1/c:0):(S.GetSymInverse33(this.mass),this.gamma=0,this.bias=0),t.step.warmStarting?(this.impulse.SelfMul(t.step.dtRatio),d=A.InitVelocityConstraints_s_P.Set(this.impulse.x,this.impulse.y),i.SelfMulSub(y,d),s-=v*(B.Vec2.CrossVV(this.rA,d)+this.impulse.z),n.SelfMulAdd(V,d),r+=x*(B.Vec2.CrossVV(this.rB,d)+this.impulse.z)):this.impulse.SetZero(),t.velocities[this.indexA].w=s,t.velocities[this.indexB].w=r},A.prototype.SolveVelocityConstraints=function(t){var e,i,s,o,n,r,a=t.velocities[this.indexA].v,l=t.velocities[this.indexA].w,c=t.velocities[this.indexB].v,h=t.velocities[this.indexB].w,u=this.invMassA,p=this.invMassB,f=this.invIA,d=this.invIB;0<this.stiffness?(o=h-l,e=-this.mass.ez.z*(o+this.bias+this.gamma*this.impulse.z),this.impulse.z+=e,l-=f*e,h+=d*e,s=B.Vec2.SubVV(B.Vec2.AddVCrossSV(c,h,this.rB,B.Vec2.s_t0),B.Vec2.AddVCrossSV(a,l,this.rA,B.Vec2.s_t1),A.SolveVelocityConstraints_s_Cdot1),i=B.Mat33.MulM33XY(this.mass,s.x,s.y,A.SolveVelocityConstraints_s_impulse1).SelfNeg(),this.impulse.x+=i.x,this.impulse.y+=i.y,r=i,a.SelfMulSub(u,r),l-=f*B.Vec2.CrossVV(this.rA,r),c.SelfMulAdd(p,r),h+=d*B.Vec2.CrossVV(this.rB,r)):(s=B.Vec2.SubVV(B.Vec2.AddVCrossSV(c,h,this.rB,B.Vec2.s_t0),B.Vec2.AddVCrossSV(a,l,this.rA,B.Vec2.s_t1),A.SolveVelocityConstraints_s_Cdot1),o=h-l,n=B.Mat33.MulM33XYZ(this.mass,s.x,s.y,o,A.SolveVelocityConstraints_s_impulse).SelfNeg(),this.impulse.SelfAdd(n),r=A.SolveVelocityConstraints_s_P.Set(n.x,n.y),a.SelfMulSub(u,r),l-=f*(B.Vec2.CrossVV(this.rA,r)+n.z),c.SelfMulAdd(p,r),h+=d*(B.Vec2.CrossVV(this.rB,r)+n.z)),t.velocities[this.indexA].w=l,t.velocities[this.indexB].w=h},A.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.indexA].c,i=t.positions[this.indexA].a,s=t.positions[this.indexB].c,o=t.positions[this.indexB].a,n=this.qA.SetAngle(i),r=this.qB.SetAngle(o),a=this.invMassA,l=this.invMassB,c=this.invIA,h=this.invIB;B.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var u=B.Rot.MulRV(n,this.lalcA,this.rA);B.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var p,f,d,y,V,v,x=B.Rot.MulRV(r,this.lalcB,this.rB),S=this.K;return S.ex.x=a+l+u.y*u.y*c+x.y*x.y*h,S.ey.x=-u.y*u.x*c-x.y*x.x*h,S.ez.x=-u.y*c-x.y*h,S.ex.y=S.ey.x,S.ey.y=a+l+u.x*u.x*c+x.x*x.x*h,S.ez.y=u.x*c+x.x*h,S.ex.z=S.ez.x,S.ey.z=S.ez.y,S.ez.z=c+h,0<this.stiffness?(p=(d=B.Vec2.SubVV(B.Vec2.AddVV(s,x,B.Vec2.s_t0),B.Vec2.AddVV(e,u,B.Vec2.s_t1),A.SolvePositionConstraints_s_C1)).Length(),f=0,v=S.Solve22(d.x,d.y,A.SolvePositionConstraints_s_P).SelfNeg(),e.SelfMulSub(a,v),i-=c*B.Vec2.CrossVV(u,v),s.SelfMulAdd(l,v),o+=h*B.Vec2.CrossVV(x,v)):(d=B.Vec2.SubVV(B.Vec2.AddVV(s,x,B.Vec2.s_t0),B.Vec2.AddVV(e,u,B.Vec2.s_t1),A.SolvePositionConstraints_s_C1),y=o-i-this.referenceAngle,p=d.Length(),f=B.Abs(y),V=S.Solve33(d.x,d.y,y,A.SolvePositionConstraints_s_impulse).SelfNeg(),v=A.SolvePositionConstraints_s_P.Set(V.x,V.y),e.SelfMulSub(a,v),i-=c*(B.Vec2.CrossVV(this.rA,v)+V.z),s.SelfMulAdd(l,v),o+=h*(B.Vec2.CrossVV(this.rB,v)+V.z)),t.positions[this.indexA].a=i,t.positions[this.indexB].a=o,p<=B.linearSlop&&f<=B.angularSlop},A.prototype.GetAnchorA=function(t){return this.bodyA.GetWorldPoint(this.localAnchorA,t)},A.prototype.GetAnchorB=function(t){return this.bodyB.GetWorldPoint(this.localAnchorB,t)},A.prototype.GetReactionForce=function(t,e){return e.x=t*this.impulse.x,e.y=t*this.impulse.y,e},A.prototype.GetReactionTorque=function(t){return t*this.impulse.z},A.prototype.GetLocalAnchorA=function(){return this.localAnchorA},A.prototype.GetLocalAnchorB=function(){return this.localAnchorB},A.prototype.GetReferenceAngle=function(){return this.referenceAngle},A.prototype.SetStiffness=function(t){this.stiffness=t},A.prototype.GetStiffness=function(){return this.stiffness},A.prototype.SetDamping=function(t){this.damping=t},A.prototype.GetDamping=function(){return this.damping},A.prototype.Dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: WeldJointDef = new WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.referenceAngle),t("  jd.stiffness = %.15f;\n",this.stiffness),t("  jd.damping = %.15f;\n",this.damping),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},A.InitVelocityConstraints_s_P=new B.Vec2,A.SolveVelocityConstraints_s_Cdot1=new B.Vec2,A.SolveVelocityConstraints_s_impulse1=new B.Vec2,A.SolveVelocityConstraints_s_impulse=new B.Vec3,A.SolveVelocityConstraints_s_P=new B.Vec2,A.SolvePositionConstraints_s_C1=new B.Vec2,A.SolvePositionConstraints_s_P=new B.Vec2,A.SolvePositionConstraints_s_impulse=new B.Vec3,A);function A(t){var e=s.call(this,t)||this;return e.stiffness=0,e.damping=0,e.bias=0,e.localAnchorA=new B.Vec2,e.localAnchorB=new B.Vec2,e.referenceAngle=0,e.gamma=0,e.impulse=new B.Vec3(0,0,0),e.indexA=0,e.indexB=0,e.rA=new B.Vec2,e.rB=new B.Vec2,e.localCenterA=new B.Vec2,e.localCenterB=new B.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.mass=new B.Mat33,e.qA=new B.Rot,e.qB=new B.Rot,e.lalcA=new B.Vec2,e.lalcB=new B.Vec2,e.K=new B.Mat33,e.stiffness=B.Maybe(t.stiffness,0),e.damping=B.Maybe(t.damping,0),e.localAnchorA.Copy(B.Maybe(t.localAnchorA,B.Vec2.ZERO)),e.localAnchorB.Copy(B.Maybe(t.localAnchorB,B.Vec2.ZERO)),e.referenceAngle=B.Maybe(t.referenceAngle,0),e.impulse.SetZero(),e}B.WeldJoint=o}(b2=b2||{}),function(w){var e,t=(e=w.JointDef,__extends(i,e),i.prototype.Initialize=function(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(s,this.localAxisA)},i);function i(){var t=e.call(this,w.JointType.e_wheelJoint)||this;return t.localAnchorA=new w.Vec2(0,0),t.localAnchorB=new w.Vec2(0,0),t.localAxisA=new w.Vec2(1,0),t.enableLimit=!1,t.lowerTranslation=0,t.upperTranslation=0,t.enableMotor=!1,t.maxMotorTorque=0,t.motorSpeed=0,t.stiffness=0,t.damping=0,t}w.WheelJointDef=t;var s,o=(s=w.Joint,__extends(_,s),_.prototype.GetMotorSpeed=function(){return this.motorSpeed},_.prototype.GetMaxMotorTorque=function(){return this.maxMotorTorque},_.prototype.SetSpringFrequencyHz=function(t){this.stiffness=t},_.prototype.GetSpringFrequencyHz=function(){return this.stiffness},_.prototype.SetSpringDampingRatio=function(t){this.damping=t},_.prototype.GetSpringDampingRatio=function(){return this.damping},_.prototype.InitVelocityConstraints=function(t){this.indexA=this.bodyA.islandIndex,this.indexB=this.bodyB.islandIndex,this.localCenterA.Copy(this.bodyA.sweep.localCenter),this.localCenterB.Copy(this.bodyB.sweep.localCenter),this.invMassA=this.bodyA.invMass,this.invMassB=this.bodyB.invMass,this.invIA=this.bodyA.invI,this.invIB=this.bodyB.invI;var e=this.invMassA,i=this.invMassB,s=this.invIA,o=this.invIB,n=t.positions[this.indexA].c,r=t.positions[this.indexA].a,a=t.velocities[this.indexA].v,l=t.velocities[this.indexA].w,c=t.positions[this.indexB].c,h=t.positions[this.indexB].a,u=t.velocities[this.indexB].v,p=t.velocities[this.indexB].w,f=this.qA.SetAngle(r),d=this.qB.SetAngle(h);w.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var y=w.Rot.MulRV(f,this.lalcA,this.rA);w.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var V=w.Rot.MulRV(d,this.lalcB,this.rB),v=w.Vec2.SubVV(w.Vec2.AddVV(c,V,w.Vec2.s_t0),w.Vec2.AddVV(n,y,w.Vec2.s_t1),_.InitVelocityConstraints_s_d);w.Rot.MulRV(f,this.localYAxisA,this.ay),this.sAy=w.Vec2.CrossVV(w.Vec2.AddVV(v,y,w.Vec2.s_t0),this.ay),this.sBy=w.Vec2.CrossVV(V,this.ay),this.mass=e+i+s*this.sAy*this.sAy+o*this.sBy*this.sBy,0<this.mass&&(this.mass=1/this.mass),w.Rot.MulRV(f,this.localXAxisA,this.ax),this.sAx=w.Vec2.CrossVV(w.Vec2.AddVV(v,y,w.Vec2.s_t0),this.ax),this.sBx=w.Vec2.CrossVV(V,this.ax);var x,S,B,A,C,m,g=e+i+s*this.sAx*this.sAx+o*this.sBx*this.sBx;this.axialMass=0<g?1/g:0,this.springMass=0,this.bias=0,(this.gamma=0)<this.stiffness&&0<g?(this.springMass=1/g,x=w.Vec2.DotVV(v,this.ax),S=t.step.dt,this.gamma=S*(this.damping+S*this.stiffness),0<this.gamma&&(this.gamma=1/this.gamma),this.bias=x*S*this.stiffness*this.gamma,this.springMass=g+this.gamma,0<this.springMass&&(this.springMass=1/this.springMass)):this.springImpulse=0,this.enableLimit?this.translation=w.Vec2.DotVV(this.ax,v):(this.lowerImpulse=0,this.upperImpulse=0),this.enableMotor?(this.motorMass=s+o,0<this.motorMass&&(this.motorMass=1/this.motorMass)):(this.motorMass=0,this.motorImpulse=0),t.step.warmStarting?(this.impulse*=t.step.dtRatio,this.springImpulse*=t.step.dtRatio,this.motorImpulse*=t.step.dtRatio,B=this.springImpulse+this.lowerImpulse-this.upperImpulse,A=w.Vec2.AddVV(w.Vec2.MulSV(this.impulse,this.ay,w.Vec2.s_t0),w.Vec2.MulSV(B,this.ax,w.Vec2.s_t1),_.InitVelocityConstraints_s_P),C=this.impulse*this.sAy+B*this.sAx+this.motorImpulse,m=this.impulse*this.sBy+B*this.sBx+this.motorImpulse,a.SelfMulSub(this.invMassA,A),l-=this.invIA*C,u.SelfMulAdd(this.invMassB,A),p+=this.invIB*m):(this.impulse=0,this.springImpulse=0,this.motorImpulse=0,this.lowerImpulse=0,this.upperImpulse=0),t.velocities[this.indexA].w=l,t.velocities[this.indexB].w=p},_.prototype.SolveVelocityConstraints=function(t){var e=this.invMassA,i=this.invMassB,s=this.invIA,o=this.invIB,n=t.velocities[this.indexA].v,r=t.velocities[this.indexA].w,a=t.velocities[this.indexB].v,l=t.velocities[this.indexB].w,c=w.Vec2.DotVV(this.ax,w.Vec2.SubVV(a,n,w.Vec2.s_t0))+this.sBx*l-this.sAx*r,h=-this.springMass*(c+this.bias+this.gamma*this.springImpulse);this.springImpulse+=h;var u=w.Vec2.MulSV(h,this.ax,_.SolveVelocityConstraints_s_P),p=h*this.sAx,f=h*this.sBx;n.SelfMulSub(e,u),r-=s*p,a.SelfMulAdd(i,u);var d,c=(l+=o*f)-r-this.motorSpeed,h=-this.motorMass*c,y=this.motorImpulse,V=t.step.dt*this.maxMotorTorque;this.motorImpulse=w.Clamp(this.motorImpulse+h,-V,V),r-=s*(h=this.motorImpulse-y),l+=o*h,this.enableLimit&&(d=this.translation-this.lowerTranslation,c=w.Vec2.DotVV(this.ax,w.Vec2.SubVV(a,n,w.Vec2.s_t0))+this.sBx*l-this.sAx*r,h=-this.axialMass*(c+w.Max(d,0)*t.step.inv_dt),y=this.lowerImpulse,this.lowerImpulse=w.Max(this.lowerImpulse+h,0),h=this.lowerImpulse-y,u=w.Vec2.MulSV(h,this.ax,_.SolveVelocityConstraints_s_P),p=h*this.sAx,f=h*this.sBx,n.SelfMulSub(e,u),r-=s*p,a.SelfMulAdd(i,u),l+=o*f,d=this.upperTranslation-this.translation,c=w.Vec2.DotVV(this.ax,w.Vec2.SubVV(n,a,w.Vec2.s_t0))+this.sAx*r-this.sBx*l,h=-this.axialMass*(c+w.Max(d,0)*t.step.inv_dt),y=this.upperImpulse,this.upperImpulse=w.Max(this.upperImpulse+h,0),h=this.upperImpulse-y,u=w.Vec2.MulSV(h,this.ax,_.SolveVelocityConstraints_s_P),p=h*this.sAx,f=h*this.sBx,n.SelfMulAdd(e,u),r+=s*p,a.SelfMulSub(i,u),l-=o*f);c=w.Vec2.DotVV(this.ay,w.Vec2.SubVV(a,n,w.Vec2.s_t0))+this.sBy*l-this.sAy*r,h=-this.mass*c;this.impulse+=h;u=w.Vec2.MulSV(h,this.ay,_.SolveVelocityConstraints_s_P),p=h*this.sAy,f=h*this.sBy;n.SelfMulSub(e,u),r-=s*p,a.SelfMulAdd(i,u),l+=o*f,t.velocities[this.indexA].w=r,t.velocities[this.indexB].w=l},_.prototype.SolvePositionConstraints=function(t){var e,i,s,o,n=t.positions[this.indexA].c,r=t.positions[this.indexA].a,a=t.positions[this.indexB].c,l=t.positions[this.indexB].a,c=0;this.enableLimit&&(h=this.qA.SetAngle(r),u=this.qB.SetAngle(l),w.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA),p=w.Rot.MulRV(h,this.lalcA,this.rA),w.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB),d=w.Rot.MulRV(u,this.lalcB,this.rB),y=w.Vec2.AddVV(w.Vec2.SubVV(a,n,w.Vec2.s_t0),w.Vec2.SubVV(d,p,w.Vec2.s_t1),_.SolvePositionConstraints_s_d),e=w.Rot.MulRV(h,this.localXAxisA,this.ax),i=w.Vec2.CrossVV(w.Vec2.AddVV(y,p,w.Vec2.s_t0),this.ax),s=w.Vec2.CrossVV(d,this.ax),S=0,o=w.Vec2.DotVV(e,y),w.Abs(this.upperTranslation-this.lowerTranslation)<2*w.linearSlop?S=o:o<=this.lowerTranslation?S=w.Min(o-this.lowerTranslation,0):o>=this.upperTranslation&&(S=w.Max(o-this.upperTranslation,0)),0!==S&&((B=0)!==(f=this.invMassA+this.invMassB+this.invIA*i*i+this.invIB*s*s)&&(B=-S/f),A=w.Vec2.MulSV(B,e,_.SolvePositionConstraints_s_P),C=B*i,m=B*s,n.SelfMulSub(this.invMassA,A),r-=this.invIA*C,a.SelfMulAdd(this.invMassB,A),l+=this.invIB*m,c=w.Abs(S)));var h=this.qA.SetAngle(r),u=this.qB.SetAngle(l);w.Vec2.SubVV(this.localAnchorA,this.localCenterA,this.lalcA);var p=w.Rot.MulRV(h,this.lalcA,this.rA);w.Vec2.SubVV(this.localAnchorB,this.localCenterB,this.lalcB);var f,d=w.Rot.MulRV(u,this.lalcB,this.rB),y=w.Vec2.AddVV(w.Vec2.SubVV(a,n,w.Vec2.s_t0),w.Vec2.SubVV(d,p,w.Vec2.s_t1),_.SolvePositionConstraints_s_d),V=w.Rot.MulRV(h,this.localYAxisA,this.ay),v=w.Vec2.CrossVV(w.Vec2.AddVV(y,p,w.Vec2.s_t0),V),x=w.Vec2.CrossVV(d,V),S=w.Vec2.DotVV(y,V),B=0;0!==(f=this.invMassA+this.invMassB+this.invIA*this.sAy*this.sAy+this.invIB*this.sBy*this.sBy)&&(B=-S/f);var A=w.Vec2.MulSV(B,V,_.SolvePositionConstraints_s_P),C=B*v,m=B*x;return n.SelfMulSub(this.invMassA,A),r-=this.invIA*C,a.SelfMulAdd(this.invMassB,A),l+=this.invIB*m,c=w.Max(c,w.Abs(S)),t.positions[this.indexA].a=r,t.positions[this.indexB].a=l,c<=w.linearSlop},_.prototype.GetDefinition=function(t){return t},_.prototype.GetAnchorA=function(t){return this.bodyA.GetWorldPoint(this.localAnchorA,t)},_.prototype.GetAnchorB=function(t){return this.bodyB.GetWorldPoint(this.localAnchorB,t)},_.prototype.GetReactionForce=function(t,e){return e.x=t*(this.impulse*this.ay.x+(this.springImpulse+this.lowerImpulse-this.upperImpulse)*this.ax.x),e.y=t*(this.impulse*this.ay.y+(this.springImpulse+this.lowerImpulse-this.upperImpulse)*this.ax.y),e},_.prototype.GetReactionTorque=function(t){return t*this.motorImpulse},_.prototype.GetLocalAnchorA=function(){return this.localAnchorA},_.prototype.GetLocalAnchorB=function(){return this.localAnchorB},_.prototype.GetLocalAxisA=function(){return this.localXAxisA},_.prototype.GetJointTranslation=function(){return this.GetPrismaticJointTranslation()},_.prototype.GetJointLinearSpeed=function(){return this.GetPrismaticJointSpeed()},_.prototype.GetJointAngle=function(){return this.GetRevoluteJointAngle()},_.prototype.GetJointAngularSpeed=function(){return this.GetRevoluteJointSpeed()},_.prototype.GetPrismaticJointTranslation=function(){var t=this.bodyA,e=this.bodyB,i=t.GetWorldPoint(this.localAnchorA,new w.Vec2),s=e.GetWorldPoint(this.localAnchorB,new w.Vec2),o=w.Vec2.SubVV(s,i,new w.Vec2),n=t.GetWorldVector(this.localXAxisA,new w.Vec2);return w.Vec2.DotVV(o,n)},_.prototype.GetPrismaticJointSpeed=function(){var t=this.bodyA,e=this.bodyB;w.Vec2.SubVV(this.localAnchorA,t.sweep.localCenter,this.lalcA);var i=w.Rot.MulRV(t.xf.q,this.lalcA,this.rA);w.Vec2.SubVV(this.localAnchorB,e.sweep.localCenter,this.lalcB);var s=w.Rot.MulRV(e.xf.q,this.lalcB,this.rB),o=w.Vec2.AddVV(t.sweep.c,i,w.Vec2.s_t0),n=w.Vec2.AddVV(e.sweep.c,s,w.Vec2.s_t1),r=w.Vec2.SubVV(n,o,w.Vec2.s_t2),a=t.GetWorldVector(this.localXAxisA,new w.Vec2),l=t.linearVelocity,c=e.linearVelocity,h=t.angularVelocity,u=e.angularVelocity;return w.Vec2.DotVV(r,w.Vec2.CrossSV(h,a,w.Vec2.s_t0))+w.Vec2.DotVV(a,w.Vec2.SubVV(w.Vec2.AddVCrossSV(c,u,s,w.Vec2.s_t0),w.Vec2.AddVCrossSV(l,h,i,w.Vec2.s_t1),w.Vec2.s_t0))},_.prototype.GetRevoluteJointAngle=function(){return this.bodyB.sweep.a-this.bodyA.sweep.a},_.prototype.GetRevoluteJointSpeed=function(){var t=this.bodyA.angularVelocity;return this.bodyB.angularVelocity-t},_.prototype.IsMotorEnabled=function(){return this.enableMotor},_.prototype.EnableMotor=function(t){t!==this.enableMotor&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.enableMotor=t)},_.prototype.SetMotorSpeed=function(t){t!==this.motorSpeed&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.motorSpeed=t)},_.prototype.SetMaxMotorTorque=function(t){t!==this.maxMotorTorque&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.maxMotorTorque=t)},_.prototype.GetMotorTorque=function(t){return t*this.motorImpulse},_.prototype.IsLimitEnabled=function(){return this.enableLimit},_.prototype.EnableLimit=function(t){t!==this.enableLimit&&(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.enableLimit=t,this.lowerImpulse=0,this.upperImpulse=0)},_.prototype.GetLowerLimit=function(){return this.lowerTranslation},_.prototype.GetUpperLimit=function(){return this.upperTranslation},_.prototype.SetLimits=function(t,e){t===this.lowerTranslation&&e===this.upperTranslation||(this.bodyA.SetAwake(!0),this.bodyB.SetAwake(!0),this.lowerTranslation=t,this.upperTranslation=e,this.lowerImpulse=0,this.upperImpulse=0)},_.prototype.Dump=function(t){var e=this.bodyA.islandIndex,i=this.bodyB.islandIndex;t("  const jd: WheelJointDef = new WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.localAnchorA.x,this.localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.localAnchorB.x,this.localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.localXAxisA.x,this.localXAxisA.y),t("  jd.enableMotor = %s;\n",this.enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.maxMotorTorque),t("  jd.stiffness = %.15f;\n",this.stiffness),t("  jd.damping = %.15f;\n",this.damping),t("  joints[%d] = this.world.CreateJoint(jd);\n",this.index)},_.prototype.Draw=function(t){var e,i,s,o=this.bodyA.GetTransform(),n=this.bodyB.GetTransform(),r=w.Transform.MulXV(o,this.localAnchorA,_.Draw_s_pA),a=w.Transform.MulXV(n,this.localAnchorB,_.Draw_s_pB),l=w.Rot.MulRV(o.q,this.localXAxisA,_.Draw_s_axis),c=_.Draw_s_c1,h=_.Draw_s_c2,u=_.Draw_s_c3,p=_.Draw_s_c4,f=_.Draw_s_c5;t.DrawSegment(r,a,f),this.enableLimit?(e=w.Vec2.AddVMulSV(r,this.lowerTranslation,l,_.Draw_s_lower),i=w.Vec2.AddVMulSV(r,this.upperTranslation,l,_.Draw_s_upper),s=w.Rot.MulRV(o.q,this.localYAxisA,_.Draw_s_perp),t.DrawSegment(e,i,c),t.DrawSegment(w.Vec2.AddVMulSV(e,-.5,s,w.Vec2.s_t0),w.Vec2.AddVMulSV(e,.5,s,w.Vec2.s_t1),h),t.DrawSegment(w.Vec2.AddVMulSV(i,-.5,s,w.Vec2.s_t0),w.Vec2.AddVMulSV(i,.5,s,w.Vec2.s_t1),u)):t.DrawSegment(w.Vec2.AddVMulSV(r,-1,l,w.Vec2.s_t0),w.Vec2.AddVMulSV(r,1,l,w.Vec2.s_t1),c),t.DrawPoint(r,5,c),t.DrawPoint(a,5,p)},_.InitVelocityConstraints_s_d=new w.Vec2,_.InitVelocityConstraints_s_P=new w.Vec2,_.SolveVelocityConstraints_s_P=new w.Vec2,_.SolvePositionConstraints_s_d=new w.Vec2,_.SolvePositionConstraints_s_P=new w.Vec2,_.Draw_s_pA=new w.Vec2,_.Draw_s_pB=new w.Vec2,_.Draw_s_axis=new w.Vec2,_.Draw_s_c1=new w.Color(.7,.7,.7),_.Draw_s_c2=new w.Color(.3,.9,.3),_.Draw_s_c3=new w.Color(.9,.3,.3),_.Draw_s_c4=new w.Color(.3,.3,.9),_.Draw_s_c5=new w.Color(.4,.4,.4),_.Draw_s_lower=new w.Vec2,_.Draw_s_upper=new w.Vec2,_.Draw_s_perp=new w.Vec2,_);function _(t){var e=s.call(this,t)||this;return e.localAnchorA=new w.Vec2,e.localAnchorB=new w.Vec2,e.localXAxisA=new w.Vec2,e.localYAxisA=new w.Vec2,e.impulse=0,e.motorImpulse=0,e.springImpulse=0,e.lowerImpulse=0,e.upperImpulse=0,e.translation=0,e.lowerTranslation=0,e.upperTranslation=0,e.maxMotorTorque=0,e.motorSpeed=0,e.enableLimit=!1,e.enableMotor=!1,e.stiffness=0,e.damping=0,e.indexA=0,e.indexB=0,e.localCenterA=new w.Vec2,e.localCenterB=new w.Vec2,e.invMassA=0,e.invMassB=0,e.invIA=0,e.invIB=0,e.ax=new w.Vec2,e.ay=new w.Vec2,e.sAx=0,e.sBx=0,e.sAy=0,e.sBy=0,e.mass=0,e.motorMass=0,e.axialMass=0,e.springMass=0,e.bias=0,e.gamma=0,e.qA=new w.Rot,e.qB=new w.Rot,e.lalcA=new w.Vec2,e.lalcB=new w.Vec2,e.rA=new w.Vec2,e.rB=new w.Vec2,e.localAnchorA.Copy(w.Maybe(t.localAnchorA,w.Vec2.ZERO)),e.localAnchorB.Copy(w.Maybe(t.localAnchorB,w.Vec2.ZERO)),e.localXAxisA.Copy(w.Maybe(t.localAxisA,w.Vec2.UNITX)),w.Vec2.CrossOneV(e.localXAxisA,e.localYAxisA),e.lowerTranslation=w.Maybe(t.lowerTranslation,0),e.upperTranslation=w.Maybe(t.upperTranslation,0),e.enableLimit=w.Maybe(t.enableLimit,!1),e.maxMotorTorque=w.Maybe(t.maxMotorTorque,0),e.motorSpeed=w.Maybe(t.motorSpeed,0),e.enableMotor=w.Maybe(t.enableMotor,!1),e.ax.SetZero(),e.ay.SetZero(),e.stiffness=w.Maybe(t.stiffness,0),e.damping=w.Maybe(t.damping,0),e}w.WheelJoint=o}(b2=b2||{}),function(q){var t=(J.prototype.SetDestructionListener=function(t){this.destructionListener=t},J.prototype.SetContactFilter=function(t){this.contactManager.contactFilter=t},J.prototype.SetContactListener=function(t){this.contactManager.contactListener=t},J.prototype.SetDebugDraw=function(t){this.debugDraw=t},J.prototype.CreateBody=function(t){if(void 0===t&&(t={}),this.IsLocked())throw new Error;var e=new q.Body(t,this);return e.prev=null,e.next=this.bodyList,this.bodyList&&(this.bodyList.prev=e),this.bodyList=e,++this.bodyCount,e},J.prototype.DestroyBody=function(t){if(this.IsLocked())throw new Error;for(var e=t.jointList;e;){var i=e,e=e.next;this.destructionListener&&this.destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.jointList=e}t.jointList=null;for(var s=t.controllerList;s;){var o=s,s=s.nextController;o.controller.RemoveBody(t)}for(var n=t.contactList;n;){var r=n,n=n.next;this.contactManager.Destroy(r.contact)}t.contactList=null;for(var a=t.fixtureList;a;){var l=a,a=a.next;this.destructionListener&&this.destructionListener.SayGoodbyeFixture(l),l.DestroyProxies(),l.Reset(),t.fixtureList=a,--t.fixtureCount}t.fixtureList=null,t.fixtureCount=0,t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.bodyList&&(this.bodyList=t.next),--this.bodyCount},J._Joint_Create=function(t){switch(t.type){case q.JointType.e_distanceJoint:return new q.DistanceJoint(t);case q.JointType.e_mouseJoint:return new q.MouseJoint(t);case q.JointType.e_prismaticJoint:return new q.PrismaticJoint(t);case q.JointType.e_revoluteJoint:return new q.RevoluteJoint(t);case q.JointType.e_pulleyJoint:return new q.PulleyJoint(t);case q.JointType.e_gearJoint:return new q.GearJoint(t);case q.JointType.e_wheelJoint:return new q.WheelJoint(t);case q.JointType.e_weldJoint:return new q.WeldJoint(t);case q.JointType.e_frictionJoint:return new q.FrictionJoint(t);case q.JointType.e_motorJoint:return new q.MotorJoint(t);case q.JointType.e_areaJoint:return new q.AreaJoint(t)}throw new Error},J._Joint_Destroy=function(t){},J.prototype.CreateJoint=function(t){if(this.IsLocked())throw new Error;var e=J._Joint_Create(t);e.prev=null,e.next=this.jointList,this.jointList&&(this.jointList.prev=e),this.jointList=e,++this.jointCount,e.edgeA.prev=null,e.edgeA.next=e.bodyA.jointList,e.bodyA.jointList&&(e.bodyA.jointList.prev=e.edgeA),e.bodyA.jointList=e.edgeA,e.edgeB.prev=null,e.edgeB.next=e.bodyB.jointList,e.bodyB.jointList&&(e.bodyB.jointList.prev=e.edgeB),e.bodyB.jointList=e.edgeB;var i=e.bodyA,s=e.bodyB;if(!e.collideConnected)for(var o=s.GetContactList();o;)o.other===i&&o.contact.FlagForFiltering(),o=o.next;return e},J.prototype.DestroyJoint=function(t){if(this.IsLocked())throw new Error;t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.jointList&&(this.jointList=t.next);var e=t.bodyA,i=t.bodyB,s=t.collideConnected;if(e.SetAwake(!0),i.SetAwake(!0),t.edgeA.prev&&(t.edgeA.prev.next=t.edgeA.next),t.edgeA.next&&(t.edgeA.next.prev=t.edgeA.prev),t.edgeA===e.jointList&&(e.jointList=t.edgeA.next),t.edgeA.Reset(),t.edgeB.prev&&(t.edgeB.prev.next=t.edgeB.next),t.edgeB.next&&(t.edgeB.next.prev=t.edgeB.prev),t.edgeB===i.jointList&&(i.jointList=t.edgeB.next),t.edgeB.Reset(),J._Joint_Destroy(t),--this.jointCount,!s)for(var o=i.GetContactList();o;)o.other===e&&o.contact.FlagForFiltering(),o=o.next},J.prototype.CreateParticleSystem=function(t){if(this.IsLocked())throw new Error;var e=new q.ParticleSystem(t,this);return e.prev=null,e.next=this.particleSystemList,this.particleSystemList&&(this.particleSystemList.prev=e),this.particleSystemList=e},J.prototype.DestroyParticleSystem=function(t){if(this.IsLocked())throw new Error;t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.particleSystemList&&(this.particleSystemList=t.next)},J.prototype.CalculateReasonableParticleIterations=function(t){if(null===this.particleSystemList)return 1;return q.CalculateParticleIterations(this.gravity.Length(),function(t){for(var e=q.maxFloat,i=t.GetParticleSystemList();null!==i;i=i.next)e=q.Min(e,i.GetRadius());return e}(this),t)},J.prototype.Step=function(t,e,i,s){void 0===s&&(s=this.CalculateReasonableParticleIterations(t));var o=J.Step_s_stepTimer.Reset();this.newContacts&&(this.contactManager.FindNewContacts(),this.newContacts=!1),this.locked=!0;var n=J.Step_s_step;n.dt=t,n.velocityIterations=e,n.positionIterations=i,n.particleIterations=s,n.inv_dt=0<t?1/t:0,n.dtRatio=this.inv_dt0*t,n.warmStarting=this.warmStarting;var r,a=J.Step_s_timer.Reset();if(this.contactManager.Collide(),this.profile.collide=a.GetMilliseconds(),this.stepComplete&&0<n.dt){for(var l=J.Step_s_timer.Reset(),c=this.particleSystemList;c;c=c.next)c.Solve(n);this.Solve(n),this.profile.solve=l.GetMilliseconds()}this.continuousPhysics&&0<n.dt&&(r=J.Step_s_timer.Reset(),this.SolveTOI(n),this.profile.solveTOI=r.GetMilliseconds()),0<n.dt&&(this.inv_dt0=n.inv_dt),this.clearForces&&this.ClearForces(),this.locked=!1,this.profile.step=o.GetMilliseconds()},J.prototype.ClearForces=function(){for(var t=this.bodyList;t;t=t.next)t.force.SetZero(),t.torque=0},J.prototype.DrawParticleSystem=function(t){var e,i,s,o;null===this.debugDraw||(e=t.GetParticleCount())&&(i=t.GetRadius(),s=t.GetPositionBuffer(),t.colorBuffer.data?(o=t.GetColorBuffer(),this.debugDraw.DrawParticles(s,i,o,e)):this.debugDraw.DrawParticles(s,i,null,e))},J.prototype.DebugDraw=function(){if(null!==this.debugDraw){var t=this.debugDraw.GetFlags(),e=J.DebugDraw_s_color.SetRGB(0,0,0);if(t&q.DrawFlags.e_shapeBit)for(var i=this.bodyList;i;i=i.next){var s=i.xf;this.debugDraw.PushTransform(s);for(var o=i.GetFixtureList();o;o=o.next)i.GetType()===q.BodyType.dynamicBody&&0===i.mass?this.DrawShape(o,new q.Color(1,0,0)):(i.IsEnabled()?i.GetType()===q.BodyType.staticBody?e.SetRGB(.5,.9,.5):i.GetType()===q.BodyType.kinematicBody?e.SetRGB(.5,.5,.9):i.IsAwake()?e.SetRGB(.9,.7,.7):e.SetRGB(.6,.6,.6):e.SetRGB(.5,.5,.3),this.DrawShape(o,e));this.debugDraw.PopTransform(s)}if(t&q.DrawFlags.e_particleBit)for(var n=this.particleSystemList;n;n=n.next)this.DrawParticleSystem(n);if(t&q.DrawFlags.e_jointBit)for(var r=this.jointList;r;r=r.next)r.Draw(this.debugDraw);if(t&q.DrawFlags.e_pairBit){e.SetRGB(.3,.9,.9);for(var a=this.contactManager.contactList;a;a=a.next){var l=a.GetFixtureA(),c=a.GetFixtureB(),h=a.GetChildIndexA(),u=a.GetChildIndexB(),p=l.GetAABB(h).GetCenter(),f=c.GetAABB(u).GetCenter();this.debugDraw.DrawSegment(p,f,e)}}if(t&q.DrawFlags.e_aabbBit){e.SetRGB(.9,.3,.9);for(var d=J.DebugDraw_s_vs,i=this.bodyList;i;i=i.next)if(i.IsEnabled())for(o=i.GetFixtureList();o;o=o.next)for(var y=0;y<o.proxyCount;++y){var V=o.proxies[y].treeNode.aabb;d[0].Set(V.lowerBound.x,V.lowerBound.y),d[1].Set(V.upperBound.x,V.lowerBound.y),d[2].Set(V.upperBound.x,V.upperBound.y),d[3].Set(V.lowerBound.x,V.upperBound.y),this.debugDraw.DrawPolygon(d,4,e)}}if(t&q.DrawFlags.e_centerOfMassBit)for(i=this.bodyList;i;i=i.next){(s=J.DebugDraw_s_xf).q.Copy(i.xf.q),s.p.Copy(i.GetWorldCenter()),this.debugDraw.DrawTransform(s)}if(t&q.DrawFlags.e_controllerBit)for(var v=this.controllerList;v;v=v.next)v.Draw(this.debugDraw)}},J.prototype.QueryAABB=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof q.QueryCallback?this._QueryAABB(t[0],t[1]):this._QueryAABB(null,t[0],t[1])},J.prototype._QueryAABB=function(i,t,s){if(this.contactManager.broadPhase.Query(t,function(t){var e=t.userData.fixture;return i?i.ReportFixture(e):!s||s(e)}),i instanceof q.QueryCallback)for(var e=this.particleSystemList;e;e=e.next)i.ShouldQueryParticleSystem(e)&&e.QueryAABB(i,t)},J.prototype.QueryAllAABB=function(t,e){return void 0===e&&(e=[]),this.QueryAABB(t,function(t){return e.push(t),!0}),e},J.prototype.QueryPointAABB=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof q.QueryCallback?this._QueryPointAABB(t[0],t[1]):this._QueryPointAABB(null,t[0],t[1])},J.prototype._QueryPointAABB=function(i,t,s){if(this.contactManager.broadPhase.QueryPoint(t,function(t){var e=t.userData.fixture;return i?i.ReportFixture(e):!s||s(e)}),i instanceof q.QueryCallback)for(var e=this.particleSystemList;e;e=e.next)i.ShouldQueryParticleSystem(e)&&e.QueryPointAABB(i,t)},J.prototype.QueryAllPointAABB=function(t,e){return void 0===e&&(e=[]),this.QueryPointAABB(t,function(t){return e.push(t),!0}),e},J.prototype.QueryFixtureShape=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof q.QueryCallback?this._QueryFixtureShape(t[0],t[1],t[2],t[3]):this._QueryFixtureShape(null,t[0],t[1],t[2],t[3])},J.prototype._QueryFixtureShape=function(s,o,n,r,a){var t=J.QueryFixtureShape_s_aabb;if(o.ComputeAABB(t,r,n),this.contactManager.broadPhase.Query(t,function(t){var e=t.userData,i=e.fixture;if(q.TestOverlapShape(o,n,i.GetShape(),e.childIndex,r,i.GetBody().GetTransform())){if(s)return s.ReportFixture(i);if(a)return a(i)}return!0}),s instanceof q.QueryCallback)for(var e=this.particleSystemList;e;e=e.next)s.ShouldQueryParticleSystem(e)&&e.QueryAABB(s,t)},J.prototype.QueryAllFixtureShape=function(t,e,i,s){return void 0===s&&(s=[]),this.QueryFixtureShape(t,e,i,function(t){return s.push(t),!0}),s},J.prototype.QueryFixturePoint=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof q.QueryCallback?this._QueryFixturePoint(t[0],t[1]):this._QueryFixturePoint(null,t[0],t[1])},J.prototype._QueryFixturePoint=function(i,s,o){if(this.contactManager.broadPhase.QueryPoint(s,function(t){var e=t.userData.fixture;if(e.TestPoint(s)){if(i)return i.ReportFixture(e);if(o)return o(e)}return!0}),i)for(var t=this.particleSystemList;t;t=t.next)i.ShouldQueryParticleSystem(t)&&t.QueryPointAABB(i,s)},J.prototype.QueryAllFixturePoint=function(t,e){return void 0===e&&(e=[]),this.QueryFixturePoint(t,function(t){return e.push(t),!0}),e},J.prototype.RayCast=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t[0]instanceof q.RayCastCallback?this._RayCast(t[0],t[1],t[2]):this._RayCast(null,t[0],t[1],t[2])},J.prototype._RayCast=function(l,c,h,u){var t=J.RayCast_s_input;if(t.maxFraction=1,t.p1.Copy(c),t.p2.Copy(h),this.contactManager.broadPhase.RayCast(t,function(t,e){var i=e.userData,s=i.fixture,o=i.childIndex,n=J.RayCast_s_output;if(s.RayCast(n,t,o)){var r=n.fraction,a=J.RayCast_s_point;if(a.Set((1-r)*c.x+r*h.x,(1-r)*c.y+r*h.y),l)return l.ReportFixture(s,a,n.normal,r);if(u)return u(s,a,n.normal,r)}return t.maxFraction}),l)for(var e=this.particleSystemList;e;e=e.next)l.ShouldQueryParticleSystem(e)&&e.RayCast(l,c,h)},J.prototype.RayCastOne=function(t,e){var o=null,n=1;return this.RayCast(t,e,function(t,e,i,s){return s<n&&(n=s,o=t),n}),o},J.prototype.RayCastAll=function(t,e,o){return void 0===o&&(o=[]),this.RayCast(t,e,function(t,e,i,s){return o.push(t),1}),o},J.prototype.GetBodyList=function(){return this.bodyList},J.prototype.GetJointList=function(){return this.jointList},J.prototype.GetParticleSystemList=function(){return this.particleSystemList},J.prototype.GetContactList=function(){return this.contactManager.contactList},J.prototype.SetAllowSleeping=function(t){if(t!==this.allowSleep&&(this.allowSleep=t,!this.allowSleep))for(var e=this.bodyList;e;e=e.next)e.SetAwake(!0)},J.prototype.GetAllowSleeping=function(){return this.allowSleep},J.prototype.SetWarmStarting=function(t){this.warmStarting=t},J.prototype.GetWarmStarting=function(){return this.warmStarting},J.prototype.SetContinuousPhysics=function(t){this.continuousPhysics=t},J.prototype.GetContinuousPhysics=function(){return this.continuousPhysics},J.prototype.SetSubStepping=function(t){this.subStepping=t},J.prototype.GetSubStepping=function(){return this.subStepping},J.prototype.GetProxyCount=function(){return this.contactManager.broadPhase.GetProxyCount()},J.prototype.GetBodyCount=function(){return this.bodyCount},J.prototype.GetJointCount=function(){return this.jointCount},J.prototype.GetContactCount=function(){return this.contactManager.contactCount},J.prototype.GetTreeHeight=function(){return this.contactManager.broadPhase.GetTreeHeight()},J.prototype.GetTreeBalance=function(){return this.contactManager.broadPhase.GetTreeBalance()},J.prototype.GetTreeQuality=function(){return this.contactManager.broadPhase.GetTreeQuality()},J.prototype.SetGravity=function(t,e){if(void 0===e&&(e=!0),!q.Vec2.IsEqualToV(this.gravity,t)&&(this.gravity.Copy(t),e))for(var i=this.bodyList;i;i=i.next)i.SetAwake(!0)},J.prototype.GetGravity=function(){return this.gravity},J.prototype.IsLocked=function(){return this.locked},J.prototype.SetAutoClearForces=function(t){this.clearForces=t},J.prototype.GetAutoClearForces=function(){return this.clearForces},J.prototype.ShiftOrigin=function(t){if(this.IsLocked())throw new Error;for(var e=this.bodyList;e;e=e.next)e.xf.p.SelfSub(t),e.sweep.c0.SelfSub(t),e.sweep.c.SelfSub(t);for(var i=this.jointList;i;i=i.next)i.ShiftOrigin(t);this.contactManager.broadPhase.ShiftOrigin(t)},J.prototype.GetContactManager=function(){return this.contactManager},J.prototype.GetProfile=function(){return this.profile},J.prototype.Dump=function(t){if(!this.locked){t("const g: Vec2 = new Vec2(%.15f, %.15f);\n",this.gravity.x,this.gravity.y),t("this.world.SetGravity(g);\n"),t("const bodies: Body[] = [];\n"),t("const joints: Joint[] = [];\n");for(var e=0,i=this.bodyList;i;i=i.next)i.islandIndex=e,i.Dump(t),++e;e=0;for(var s=this.jointList;s;s=s.next)s.index=e,++e;for(s=this.jointList;s;s=s.next)s.type!==q.JointType.e_gearJoint&&(t("{\n"),s.Dump(t),t("}\n"));for(s=this.jointList;s;s=s.next)s.type===q.JointType.e_gearJoint&&(t("{\n"),s.Dump(t),t("}\n"))}},J.prototype.DrawShape=function(t,e){if(null!==this.debugDraw){var i=t.GetShape();switch(i.type){case q.ShapeType.e_circleShape:var s=i.p,o=i.radius,n=q.Vec2.UNITX;this.debugDraw.DrawSolidCircle(s,o,n,e);break;case q.ShapeType.e_edgeShape:var r=i,a=r.vertex1,l=r.vertex2;this.debugDraw.DrawSegment(a,l,e),!1===r.oneSided&&(this.debugDraw.DrawPoint(a,4,e),this.debugDraw.DrawPoint(l,4,e));break;case q.ShapeType.e_chainShape:for(var c=i.count,a=(p=i.vertices)[0],h=1;h<c;++h){l=p[h];this.debugDraw.DrawSegment(a,l,e),a=l}break;case q.ShapeType.e_polygonShape:var u=i.count,p=i.vertices;this.debugDraw.DrawSolidPolygon(p,u,e)}}},J.prototype.Solve=function(t){for(var e=this.bodyList;e;e=e.next)e.xf0.Copy(e.xf);for(var i=this.controllerList;i;i=i.next)i.Step(t);this.profile.solveInit=0,this.profile.solveVelocity=0,this.profile.solvePosition=0;var s=this.island;s.Initialize(this.bodyCount,this.contactManager.contactCount,this.jointCount,this.contactManager.contactListener);for(e=this.bodyList;e;e=e.next)e.islandFlag=!1;for(var o=this.contactManager.contactList;o;o=o.next)o.islandFlag=!1;for(var n=this.jointList;n;n=n.next)n.islandFlag=!1;for(var r=this.s_stack,a=this.bodyList;a;a=a.next)if(!a.islandFlag&&a.IsAwake()&&a.IsEnabled()&&a.GetType()!==q.BodyType.staticBody){s.Clear();var l=0;for((r[l++]=a).islandFlag=!0;0<l;){if(!(e=r[--l]))throw new Error;if(s.AddBody(e),e.GetType()!==q.BodyType.staticBody){e.awakeFlag=!0;for(var c=e.contactList;c;c=c.next){var h,u,p=c.contact;p.islandFlag||p.IsEnabled()&&p.IsTouching()&&(h=p.fixtureA.isSensor,u=p.fixtureB.isSensor,h||u||(s.AddContact(p),p.islandFlag=!0,(f=c.other).islandFlag||((r[l++]=f).islandFlag=!0)))}for(var f,d=e.jointList;d;d=d.next){d.joint.islandFlag||(f=d.other).IsEnabled()&&(s.AddJoint(d.joint),d.joint.islandFlag=!0,f.islandFlag||((r[l++]=f).islandFlag=!0))}}}var y=new q.Profile;s.Solve(y,t,this.gravity,this.allowSleep),this.profile.solveInit+=y.solveInit,this.profile.solveVelocity+=y.solveVelocity,this.profile.solvePosition+=y.solvePosition;for(var V=0;V<s.bodyCount;++V){(e=s.bodies[V]).GetType()===q.BodyType.staticBody&&(e.islandFlag=!1)}}for(V=0;V<r.length&&r[V];++V)r[V]=null;for(var v=new q.Timer,e=this.bodyList;e;e=e.next)e.islandFlag&&e.GetType()!==q.BodyType.staticBody&&e.SynchronizeFixtures();this.contactManager.FindNewContacts(),this.profile.broadphase=v.GetMilliseconds()},J.prototype.SolveTOI=function(t){var e=this.island;if(e.Initialize(2*q.maxTOIContacts,q.maxTOIContacts,0,this.contactManager.contactListener),this.stepComplete){for(var i=this.bodyList;i;i=i.next)i.islandFlag=!1,i.sweep.alpha0=0;for(var s=this.contactManager.contactList;s;s=s.next)s.toiFlag=!1,s.islandFlag=!1,s.toiCount=0,s.toi=1}for(;;){for(var o=null,n=1,s=this.contactManager.contactList;s;s=s.next)if(s.IsEnabled()&&!(s.toiCount>q.maxSubSteps)){var r=1;if(s.toiFlag)r=s.toi;else{var a=s.GetFixtureA(),l=s.GetFixtureB();if(a.IsSensor()||l.IsSensor())continue;var c=a.GetBody(),h=l.GetBody(),u=c.type,p=h.type,f=c.IsAwake()&&u!==q.BodyType.staticBody,d=h.IsAwake()&&p!==q.BodyType.staticBody;if(!f&&!d)continue;var y=c.IsBullet()||u!==q.BodyType.dynamicBody,V=h.IsBullet()||p!==q.BodyType.dynamicBody;if(!y&&!V)continue;var v=c.sweep.alpha0;c.sweep.alpha0<h.sweep.alpha0?(v=h.sweep.alpha0,c.sweep.Advance(v)):h.sweep.alpha0<c.sweep.alpha0&&(v=c.sweep.alpha0,h.sweep.Advance(v));var x=s.GetChildIndexA(),S=s.GetChildIndexB(),B=J.SolveTOI_s_toi_input;B.proxyA.SetShape(a.GetShape(),x),B.proxyB.SetShape(l.GetShape(),S),B.sweepA.Copy(c.sweep),B.sweepB.Copy(h.sweep),B.tMax=1;var A=J.SolveTOI_s_toi_output;q.TimeOfImpact(A,B);var C=A.t,r=A.state===q.TOIOutputState.e_touching?q.Min(v+(1-v)*C,1):1;s.toi=r,s.toiFlag=!0}r<n&&(o=s,n=r)}if(null===o||1-10*q.epsilon<n){this.stepComplete=!0;break}var m=o.GetFixtureA(),g=o.GetFixtureB(),w=m.GetBody(),_=g.GetBody(),b=J.SolveTOI_s_backup1.Copy(w.sweep),M=J.SolveTOI_s_backup2.Copy(_.sweep);if(w.Advance(n),_.Advance(n),o.Update(this.contactManager.contactListener),o.toiFlag=!1,++o.toiCount,o.IsEnabled()&&o.IsTouching()){w.SetAwake(!0),_.SetAwake(!0),e.Clear(),e.AddBody(w),e.AddBody(_),e.AddContact(o),w.islandFlag=!0,_.islandFlag=!0,o.islandFlag=!0;for(var P=0;P<2;++P){if((k=0===P?w:_).type===q.BodyType.dynamicBody)for(var I=k.contactList;I&&e.bodyCount!==e.bodyCapacity&&e.contactCount!==e.contactCapacity;I=I.next){var D,G,T,F,R=I.contact;R.islandFlag||((D=I.other).type!==q.BodyType.dynamicBody||k.IsBullet()||D.IsBullet())&&(G=R.fixtureA.isSensor,T=R.fixtureB.isSensor,G||T||(F=J.SolveTOI_s_backup.Copy(D.sweep),D.islandFlag||D.Advance(n),R.Update(this.contactManager.contactListener),R.IsEnabled()&&R.IsTouching()?(R.islandFlag=!0,e.AddContact(R),D.islandFlag||(D.islandFlag=!0,D.type!==q.BodyType.staticBody&&D.SetAwake(!0),e.AddBody(D))):(D.sweep.Copy(F),D.SynchronizeTransform())))}}var L=J.SolveTOI_s_subStep;L.dt=(1-n)*t.dt,L.inv_dt=1/L.dt,L.dtRatio=1,L.positionIterations=20,L.velocityIterations=t.velocityIterations,L.particleIterations=t.particleIterations,L.warmStarting=!1,e.SolveTOI(L,w.islandIndex,_.islandIndex);for(var k,P=0;P<e.bodyCount;++P){if((k=e.bodies[P]).islandFlag=!1,k.type===q.BodyType.dynamicBody){k.SynchronizeFixtures();for(I=k.contactList;I;I=I.next)I.contact.toiFlag=!1,I.contact.islandFlag=!1}}if(this.contactManager.FindNewContacts(),this.subStepping){this.stepComplete=!1;break}}else o.SetEnabled(!1),w.sweep.Copy(b),_.sweep.Copy(M),w.SynchronizeTransform(),_.SynchronizeTransform()}},J.prototype.AddController=function(t){return t.next=this.controllerList,t.prev=null,this.controllerList&&(this.controllerList.prev=t),this.controllerList=t,++this.controllerCount,t},J.prototype.RemoveController=function(t){return t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),this.controllerList===t&&(this.controllerList=t.next),--this.controllerCount,t.prev=null,t.next=null,t},J.Step_s_step=new q.TimeStep,J.Step_s_stepTimer=new q.Timer,J.Step_s_timer=new q.Timer,J.DebugDraw_s_color=new q.Color(0,0,0),J.DebugDraw_s_vs=q.Vec2.MakeArray(4),J.DebugDraw_s_xf=new q.Transform,J.QueryFixtureShape_s_aabb=new q.AABB,J.RayCast_s_input=new q.RayCastInput,J.RayCast_s_output=new q.RayCastOutput,J.RayCast_s_point=new q.Vec2,J.SolveTOI_s_subStep=new q.TimeStep,J.SolveTOI_s_backup=new q.Sweep,J.SolveTOI_s_backup1=new q.Sweep,J.SolveTOI_s_backup2=new q.Sweep,J.SolveTOI_s_toi_input=new q.TOIInput,J.SolveTOI_s_toi_output=new q.TOIOutput,J);function J(t){this.contactManager=new q.ContactManager,this.bodyList=null,this.jointList=null,this.particleSystemList=null,this.bodyCount=0,this.jointCount=0,this.gravity=new q.Vec2,this.allowSleep=!0,this.destructionListener=null,this.inv_dt0=0,this.newContacts=!1,this.locked=!1,this.clearForces=!0,this.warmStarting=!0,this.continuousPhysics=!0,this.subStepping=!1,this.stepComplete=!0,this.profile=new q.Profile,this.island=new q.Island,this.s_stack=[],this.controllerList=null,this.controllerCount=0,this.gravity.Copy(t)}q.World=t}(b2=b2||{}),function(n){var e,t;(t=e=n.ParticleGroupFlag||(n.ParticleGroupFlag={}))[t.solidParticleGroup=1]="solidParticleGroup",t[t.rigidParticleGroup=2]="rigidParticleGroup",t[t.particleGroupCanBeEmpty=4]="particleGroupCanBeEmpty",t[t.particleGroupWillBeDestroyed=8]="particleGroupWillBeDestroyed",t[t.particleGroupNeedsUpdateDepth=16]="particleGroupNeedsUpdateDepth",t[t.particleGroupInternalMask=24]="particleGroupInternalMask";function i(){this.flags=0,this.groupFlags=0,this.position=new n.Vec2,this.angle=0,this.linearVelocity=new n.Vec2,this.angularVelocity=0,this.color=new n.Color,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null}n.ParticleGroupDef=i;var s=(o.prototype.GetNext=function(){return this.next},o.prototype.GetParticleSystem=function(){return this.system},o.prototype.GetParticleCount=function(){return this.lastIndex-this.firstIndex},o.prototype.GetBufferIndex=function(){return this.firstIndex},o.prototype.ContainsParticle=function(t){return this.firstIndex<=t&&t<this.lastIndex},o.prototype.GetAllParticleFlags=function(){if(!this.system.flagsBuffer.data)throw new Error;for(var t=0,e=this.firstIndex;e<this.lastIndex;e++)t|=this.system.flagsBuffer.data[e];return t},o.prototype.GetGroupFlags=function(){return this.groupFlags},o.prototype.SetGroupFlags=function(t){t|=this.groupFlags&e.particleGroupInternalMask,this.system.SetGroupFlags(this,t)},o.prototype.GetMass=function(){return this.UpdateStatistics(),this.mass},o.prototype.GetInertia=function(){return this.UpdateStatistics(),this.inertia},o.prototype.GetCenter=function(){return this.UpdateStatistics(),this.center},o.prototype.GetLinearVelocity=function(){return this.UpdateStatistics(),this.linearVelocity},o.prototype.GetAngularVelocity=function(){return this.UpdateStatistics(),this.angularVelocity},o.prototype.GetTransform=function(){return this.transform},o.prototype.GetPosition=function(){return this.transform.p},o.prototype.GetAngle=function(){return this.transform.q.GetAngle()},o.prototype.GetLinearVelocityFromWorldPoint=function(t,e){var i=o.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),n.Vec2.AddVCrossSV(this.linearVelocity,this.angularVelocity,n.Vec2.SubVV(t,this.center,i),e)},o.prototype.GetUserData=function(){return this.userData},o.prototype.SetUserData=function(t){this.userData=t},o.prototype.ApplyForce=function(t){this.system.ApplyForce(this.firstIndex,this.lastIndex,t)},o.prototype.ApplyLinearImpulse=function(t){this.system.ApplyLinearImpulse(this.firstIndex,this.lastIndex,t)},o.prototype.DestroyParticles=function(t){if(this.system.world.IsLocked())throw new Error;for(var e=this.firstIndex;e<this.lastIndex;e++)this.system.DestroyParticle(e,t)},o.prototype.UpdateStatistics=function(){if(!this.system.positionBuffer.data)throw new Error;if(!this.system.velocityBuffer.data)throw new Error;var t=new n.Vec2,e=new n.Vec2;if(this.timestamp!==this.system.timestamp){var i=this.system.GetParticleMass();this.mass=i*(this.lastIndex-this.firstIndex),this.center.SetZero(),this.linearVelocity.SetZero();for(var s,o=this.firstIndex;o<this.lastIndex;o++)this.center.SelfMulAdd(i,this.system.positionBuffer.data[o]),this.linearVelocity.SelfMulAdd(i,this.system.velocityBuffer.data[o]);0<this.mass&&(s=1/this.mass,this.center.SelfMul(s),this.linearVelocity.SelfMul(s)),this.inertia=0,this.angularVelocity=0;for(o=this.firstIndex;o<this.lastIndex;o++)n.Vec2.SubVV(this.system.positionBuffer.data[o],this.center,t),n.Vec2.SubVV(this.system.velocityBuffer.data[o],this.linearVelocity,e),this.inertia+=i*n.Vec2.DotVV(t,t),this.angularVelocity+=i*n.Vec2.CrossVV(t,e);0<this.inertia&&(this.angularVelocity*=1/this.inertia),this.timestamp=this.system.timestamp}},o.GetLinearVelocityFromWorldPoint_s_t0=new n.Vec2,o);function o(t){this.firstIndex=0,this.lastIndex=0,this.groupFlags=0,this.strength=1,this.prev=null,this.next=null,this.timestamp=-1,this.mass=0,this.inertia=0,this.center=new n.Vec2,this.linearVelocity=new n.Vec2,this.angularVelocity=0,this.transform=new n.Transform,this.userData=null,this.system=t}n.ParticleGroup=s}(b2=b2||{}),function(tt){function c(t,e,i){var s=t[e];t[e]=t[i],t[i]=s}function h(t,e){return t<e}function u(t,e,i,s){void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===s&&(s=h);for(var o=e,n=[],r=0;;){for(;o+1<i;i++){var a=t[o+Math.floor(Math.random()*(i-o))];n[r++]=i;for(var l=o-1;;){for(;s(t[++l],a););for(;s(a,t[--i]););if(i<=l)break;c(t,l,i)}}if(0===r)break;o=i,i=n[--r]}return t}function v(t,e,i,s){return void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===s&&(s=h),u(t,e,i,s)}function e(t,e,i){void 0===i&&(i=t.length);for(var s=0,o=0;o<i;++o)e(t[o])||(o!==s?c(t,s++,o):++s);return s}function p(t,e,i,s,o){for(var n=i-e;0<n;){var r=Math.floor(n/2),a=e+r;o(t[a],s)?(e=++a,n-=r+1):n=r}return e}function f(t,e,i,s,o){for(var n=i-e;0<n;){var r=Math.floor(n/2),a=e+r;o(s,t[a])?n=r:(e=++a,n-=r+1)}return e}function d(t,e,i,s){for(var o=i;e!==o;)c(t,e++,o++),o===s?o=i:e===i&&(i=o)}var i=(t.prototype.Append=function(){return this.count>=this.capacity&&this.Grow(),this.count++},t.prototype.Reserve=function(t){if(!(this.capacity>=t)){for(var e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}},t.prototype.Grow=function(){var t=this.capacity?2*this.capacity:tt.minParticleSystemBufferCapacity;this.Reserve(t)},t.prototype.Free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},t.prototype.Shorten=function(t){},t.prototype.Data=function(){return this.data},t.prototype.GetCount=function(){return this.count},t.prototype.SetCount=function(t){this.count=t},t.prototype.GetCapacity=function(){return this.capacity},t.prototype.RemoveIf=function(t){this.count=e(this.data,t,this.count)},t.prototype.Unique=function(t){this.count=function(t,e,i,s){if(e===i)return i;for(var o=e;++e!==i;)s(t[o],t[e])||c(t,++o,e);return++o}(this.data,0,this.count,t)},t);function t(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}tt.GrowableBuffer=i;var s,o=(s=tt.QueryCallback,__extends(n,s),n.prototype.ShouldQueryParticleSystem=function(t){return!1},n.prototype.ReportFixture=function(t){if(t.IsSensor())return!0;for(var e=t.GetShape().GetChildCount(),i=0;i<e;i++)for(var s,o=t.GetAABB(i),n=this.system.GetInsideBoundsEnumerator(o);0<=(s=n.GetNext());)this.ReportFixtureAndParticle(t,i,s);return!0},n.prototype.ReportParticle=function(t,e){return!1},n.prototype.ReportFixtureAndParticle=function(t,e,i){},n);function n(t){var e=s.call(this)||this;return e.system=t,e}tt.FixtureParticleQueryCallback=o;var r=(a.prototype.SetIndices=function(t,e){this.indexA=t,this.indexB=e},a.prototype.SetWeight=function(t){this.weight=t},a.prototype.SetNormal=function(t){this.normal.Copy(t)},a.prototype.SetFlags=function(t){this.flags=t},a.prototype.GetIndexA=function(){return this.indexA},a.prototype.GetIndexB=function(){return this.indexB},a.prototype.GetWeight=function(){return this.weight},a.prototype.GetNormal=function(){return this.normal},a.prototype.GetFlags=function(){return this.flags},a.prototype.IsEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y},a.prototype.IsNotEqual=function(t){return!this.IsEqual(t)},a.prototype.ApproximatelyEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&tt.Abs(this.weight-t.weight)<.01&&tt.Vec2.DistanceSquaredVV(this.normal,t.normal)<1e-4},a);function a(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new tt.Vec2,this.flags=0}tt.ParticleContact=r;var l=function(){this.index=0,this.weight=0,this.normal=new tt.Vec2,this.mass=0};tt.ParticleBodyContact=l;var y=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0};tt.ParticlePair=y;var V=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new tt.Vec2(0,0),this.pb=new tt.Vec2(0,0),this.pc=new tt.Vec2(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0};tt.ParticleTriad=V;var x=(S.prototype.Copy=function(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this},S.prototype.Clone=function(){return(new S).Copy(this)},S);function S(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}tt.ParticleSystemDef=x;var B=(et.computeTag=function(t,e){return(e+et.yOffset>>>0<<et.yShift)+(et.xScale*t+et.xOffset>>>0)>>>0},et.computeRelativeTag=function(t,e,i){return t+(i<<et.yShift)+(e<<et.xShift)>>>0},et.prototype.Drop=function(){for(;this.groupList;)this.DestroyParticleGroup(this.groupList);this.FreeUserOverridableBuffer(this.handleIndexBuffer),this.FreeUserOverridableBuffer(this.flagsBuffer),this.FreeUserOverridableBuffer(this.lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.positionBuffer),this.FreeUserOverridableBuffer(this.velocityBuffer),this.FreeUserOverridableBuffer(this.colorBuffer),this.FreeUserOverridableBuffer(this.userDataBuffer),this.FreeUserOverridableBuffer(this.expirationTimeBuffer),this.FreeUserOverridableBuffer(this.indexByExpirationTimeBuffer),this.FreeBuffer(this.forceBuffer,this.internalAllocatedCapacity),this.FreeBuffer(this.weightBuffer,this.internalAllocatedCapacity),this.FreeBuffer(this.staticPressureBuffer,this.internalAllocatedCapacity),this.FreeBuffer(this.accumulationBuffer,this.internalAllocatedCapacity),this.FreeBuffer(this.accumulation2Buffer,this.internalAllocatedCapacity),this.FreeBuffer(this.depthBuffer,this.internalAllocatedCapacity),this.FreeBuffer(this.groupBuffer,this.internalAllocatedCapacity)},et.prototype.CreateParticle=function(t){if(this.world.IsLocked())throw new Error;var e;if(this.count>=this.internalAllocatedCapacity&&(e=this.count?2*this.count:tt.minParticleSystemBufferCapacity,this.ReallocateInternalAllocatedBuffers(e)),this.count>=this.internalAllocatedCapacity){if(!this.def.destroyByAge)return tt.invalidParticleIndex;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var i=this.count++;this.flagsBuffer.data[i]=0,this.lastBodyContactStepBuffer.data&&(this.lastBodyContactStepBuffer.data[i]=0),this.bodyContactCountBuffer.data&&(this.bodyContactCountBuffer.data[i]=0),this.consecutiveContactStepsBuffer.data&&(this.consecutiveContactStepsBuffer.data[i]=0),this.positionBuffer.data[i]=(this.positionBuffer.data[i]||new tt.Vec2).Copy(tt.Maybe(t.position,tt.Vec2.ZERO)),this.velocityBuffer.data[i]=(this.velocityBuffer.data[i]||new tt.Vec2).Copy(tt.Maybe(t.velocity,tt.Vec2.ZERO)),this.weightBuffer[i]=0,this.forceBuffer[i]=(this.forceBuffer[i]||new tt.Vec2).SetZero(),this.staticPressureBuffer&&(this.staticPressureBuffer[i]=0),this.depthBuffer&&(this.depthBuffer[i]=0);var s=(new tt.Color).Copy(tt.Maybe(t.color,tt.Color.ZERO));!this.colorBuffer.data&&s.IsZero()||(this.colorBuffer.data=this.RequestBuffer(this.colorBuffer.data),this.colorBuffer.data[i]=(this.colorBuffer.data[i]||new tt.Color).Copy(s)),(this.userDataBuffer.data||t.userData)&&(this.userDataBuffer.data=this.RequestBuffer(this.userDataBuffer.data),this.userDataBuffer.data[i]=t.userData),this.handleIndexBuffer.data&&(this.handleIndexBuffer.data[i]=null);var o=this.proxyBuffer.data[this.proxyBuffer.Append()],n=tt.Maybe(t.lifetime,0),r=0<n;(this.expirationTimeBuffer.data||r)&&(this.SetParticleLifetime(i,r?n:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.indexByExpirationTimeBuffer.data[i]=i),o.index=i;var a=tt.Maybe(t.group,null);return(this.groupBuffer[i]=a)&&(a.firstIndex<a.lastIndex?this.RotateBuffer(a.firstIndex,a.lastIndex,i):a.firstIndex=i,a.lastIndex=1+i),this.SetParticleFlags(i,tt.Maybe(t.flags,0)),i},et.prototype.GetParticleHandleFromIndex=function(t){this.handleIndexBuffer.data=this.RequestBuffer(this.handleIndexBuffer.data);var e=this.handleIndexBuffer.data[t];return e||((e=new tt.ParticleHandle).SetIndex(t),this.handleIndexBuffer.data[t]=e)},et.prototype.DestroyParticle=function(t,e){void 0===e&&(e=!1);var i=tt.ParticleFlag.zombieParticle;e&&(i|=tt.ParticleFlag.destructionListenerParticle),this.SetParticleFlags(t,this.flagsBuffer.data[t]|i)},et.prototype.DestroyOldestParticle=function(t,e){void 0===e&&(e=!1);var i=this.GetParticleCount(),s=this.indexByExpirationTimeBuffer.data[i-(t+1)],o=this.indexByExpirationTimeBuffer.data[t];this.DestroyParticle(0<this.expirationTimeBuffer.data[s]?s:o,e)},et.prototype.DestroyParticlesInShape=function(t,e,i){void 0===i&&(i=!1);var s=et.DestroyParticlesInShape_s_aabb;if(this.world.IsLocked())throw new Error;var o=new z(this,t,e,i),n=s;return t.ComputeAABB(n,e,0),this.world.QueryAABB(o,n),o.Destroyed()},et.prototype.CreateParticleGroup=function(t){var e=et.CreateParticleGroup_s_transform;if(this.world.IsLocked())throw new Error;var i=e;i.SetPositionAngle(tt.Maybe(t.position,tt.Vec2.ZERO),tt.Maybe(t.angle,0));var s=this.count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,i),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,tt.Maybe(t.shapeCount,t.shapes.length),t,i),t.positionData)for(var o=tt.Maybe(t.particleCount,t.positionData.length),n=0;n<o;n++){var r=t.positionData[n];this.CreateParticleForGroup(t,i,r)}var a=this.count,l=new tt.ParticleGroup(this);l.firstIndex=s,l.lastIndex=a,l.strength=tt.Maybe(t.strength,1),l.userData=t.userData,l.transform.Copy(i),l.prev=null,l.next=this.groupList,this.groupList&&(this.groupList.prev=l),this.groupList=l,++this.groupCount;for(n=s;n<a;n++)this.groupBuffer[n]=l;this.SetGroupFlags(l,tt.Maybe(t.groupFlags,0));var c=new q;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(s,a,c),t.group&&(this.JoinParticleGroups(t.group,l),l=t.group),l},et.prototype.JoinParticleGroups=function(t,e){if(this.world.IsLocked())throw new Error;this.RotateBuffer(e.firstIndex,e.lastIndex,this.count),this.RotateBuffer(t.firstIndex,t.lastIndex,e.firstIndex);var i=new O(e.firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.firstIndex,e.lastIndex,i);for(var s=e.firstIndex;s<e.lastIndex;s++)this.groupBuffer[s]=t;var o=t.groupFlags|e.groupFlags;this.SetGroupFlags(t,o),t.lastIndex=e.lastIndex,e.firstIndex=e.lastIndex,this.DestroyParticleGroup(e)},et.prototype.SplitParticleGroup=function(t){this.UpdateContacts(!0);var e=t.GetParticleCount(),i=tt.MakeArray(e,function(t){return new b});et.InitializeParticleLists(t,i),this.MergeParticleListsInContact(t,i);var s=et.FindLongestParticleList(t,i);this.MergeZombieParticleListNodes(t,i,s),this.CreateParticleGroupsFromParticleList(t,i,s),this.UpdatePairsAndTriadsWithParticleList(t,i)},et.prototype.GetParticleGroupList=function(){return this.groupList},et.prototype.GetParticleGroupCount=function(){return this.groupCount},et.prototype.GetParticleCount=function(){return this.count},et.prototype.GetMaxParticleCount=function(){return this.def.maxCount},et.prototype.SetMaxParticleCount=function(t){this.def.maxCount=t},et.prototype.GetAllParticleFlags=function(){return this.allParticleFlags},et.prototype.GetAllGroupFlags=function(){return this.allGroupFlags},et.prototype.SetPaused=function(t){this.paused=t},et.prototype.GetPaused=function(){return this.paused},et.prototype.SetDensity=function(t){this.def.density=t,this.inverseDensity=1/this.def.density},et.prototype.GetDensity=function(){return this.def.density},et.prototype.SetGravityScale=function(t){this.def.gravityScale=t},et.prototype.GetGravityScale=function(){return this.def.gravityScale},et.prototype.SetDamping=function(t){this.def.dampingStrength=t},et.prototype.GetDamping=function(){return this.def.dampingStrength},et.prototype.SetStaticPressureIterations=function(t){this.def.staticPressureIterations=t},et.prototype.GetStaticPressureIterations=function(){return this.def.staticPressureIterations},et.prototype.SetRadius=function(t){this.particleDiameter=2*t,this.squaredDiameter=this.particleDiameter*this.particleDiameter,this.inverseDiameter=1/this.particleDiameter},et.prototype.GetRadius=function(){return this.particleDiameter/2},et.prototype.GetPositionBuffer=function(){return this.positionBuffer.data},et.prototype.GetVelocityBuffer=function(){return this.velocityBuffer.data},et.prototype.GetColorBuffer=function(){return this.colorBuffer.data=this.RequestBuffer(this.colorBuffer.data),this.colorBuffer.data},et.prototype.GetGroupBuffer=function(){return this.groupBuffer},et.prototype.GetWeightBuffer=function(){return this.weightBuffer},et.prototype.GetUserDataBuffer=function(){return this.userDataBuffer.data=this.RequestBuffer(this.userDataBuffer.data),this.userDataBuffer.data},et.prototype.GetFlagsBuffer=function(){return this.flagsBuffer.data},et.prototype.SetParticleFlags=function(t,e){this.flagsBuffer.data[t]&~e&&(this.needsUpdateAllParticleFlags=!0),~this.allParticleFlags&e&&(e&tt.ParticleFlag.tensileParticle&&(this.accumulation2Buffer=this.RequestBuffer(this.accumulation2Buffer)),e&tt.ParticleFlag.colorMixingParticle&&(this.colorBuffer.data=this.RequestBuffer(this.colorBuffer.data)),this.allParticleFlags|=e),this.flagsBuffer.data[t]=e},et.prototype.GetParticleFlags=function(t){return this.flagsBuffer.data[t]},et.prototype.SetFlagsBuffer=function(t){this.SetUserOverridableBuffer(this.flagsBuffer,t)},et.prototype.SetPositionBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,i=new Array(e),s=0;s<e;++s)i[s]=new tt.TypedVec2(t.subarray(2*s,2*s+2));t=i}this.SetUserOverridableBuffer(this.positionBuffer,t)},et.prototype.SetVelocityBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,i=new Array(e),s=0;s<e;++s)i[s]=new tt.TypedVec2(t.subarray(2*s,2*s+2));t=i}this.SetUserOverridableBuffer(this.velocityBuffer,t)},et.prototype.SetColorBuffer=function(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;for(var e=t.length/4,i=new Array(e),s=0;s<e;++s)i[s]=new tt.TypedColor(t.subarray(4*s,4*s+4));t=i}this.SetUserOverridableBuffer(this.colorBuffer,t)},et.prototype.SetUserDataBuffer=function(t){this.SetUserOverridableBuffer(this.userDataBuffer,t)},et.prototype.GetContacts=function(){return this.contactBuffer.data},et.prototype.GetContactCount=function(){return this.contactBuffer.count},et.prototype.GetBodyContacts=function(){return this.bodyContactBuffer.data},et.prototype.GetBodyContactCount=function(){return this.bodyContactBuffer.count},et.prototype.GetPairs=function(){return this.pairBuffer.data},et.prototype.GetPairCount=function(){return this.pairBuffer.count},et.prototype.GetTriads=function(){return this.triadBuffer.data},et.prototype.GetTriadCount=function(){return this.triadBuffer.count},et.prototype.SetStuckThreshold=function(t){0<(this.stuckThreshold=t)&&(this.lastBodyContactStepBuffer.data=this.RequestBuffer(this.lastBodyContactStepBuffer.data),this.bodyContactCountBuffer.data=this.RequestBuffer(this.bodyContactCountBuffer.data),this.consecutiveContactStepsBuffer.data=this.RequestBuffer(this.consecutiveContactStepsBuffer.data))},et.prototype.GetStuckCandidates=function(){return this.stuckParticleBuffer.Data()},et.prototype.GetStuckCandidateCount=function(){return this.stuckParticleBuffer.GetCount()},et.prototype.ComputeCollisionEnergy=function(){for(var t=et.ComputeCollisionEnergy_s_v,e=this.velocityBuffer.data,i=0,s=0;s<this.contactBuffer.count;s++){var o=this.contactBuffer.data[s],n=o.indexA,r=o.indexB,a=o.normal,l=tt.Vec2.SubVV(e[r],e[n],t),c=tt.Vec2.DotVV(l,a);c<0&&(i+=c*c)}return.5*this.GetParticleMass()*i},et.prototype.SetStrictContactCheck=function(t){this.def.strictContactCheck=t},et.prototype.GetStrictContactCheck=function(){return this.def.strictContactCheck},et.prototype.SetParticleLifetime=function(t,e){var i=null===this.indexByExpirationTimeBuffer.data;if(this.expirationTimeBuffer.data=this.RequestBuffer(this.expirationTimeBuffer.data),this.indexByExpirationTimeBuffer.data=this.RequestBuffer(this.indexByExpirationTimeBuffer.data),i)for(var s=this.GetParticleCount(),o=0;o<s;++o)this.indexByExpirationTimeBuffer.data[o]=o;var n=e/this.def.lifetimeGranularity,r=0<n?this.GetQuantizedTimeElapsed()+n:n;r!==this.expirationTimeBuffer.data[t]&&(this.expirationTimeBuffer.data[t]=r,this.expirationTimeBufferRequiresSorting=!0)},et.prototype.GetParticleLifetime=function(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])},et.prototype.SetDestructionByAge=function(t){t&&this.GetExpirationTimeBuffer(),this.def.destroyByAge=t},et.prototype.GetDestructionByAge=function(){return this.def.destroyByAge},et.prototype.GetExpirationTimeBuffer=function(){return this.expirationTimeBuffer.data=this.RequestBuffer(this.expirationTimeBuffer.data),this.expirationTimeBuffer.data},et.prototype.ExpirationTimeToLifetime=function(t){return(0<t?t-this.GetQuantizedTimeElapsed():t)*this.def.lifetimeGranularity},et.prototype.GetIndexByExpirationTimeBuffer=function(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.indexByExpirationTimeBuffer.data=this.RequestBuffer(this.indexByExpirationTimeBuffer.data),this.indexByExpirationTimeBuffer.data},et.prototype.ParticleApplyLinearImpulse=function(t,e){this.ApplyLinearImpulse(t,t+1,e)},et.prototype.ApplyLinearImpulse=function(t,e,i){for(var s=this.velocityBuffer.data,o=(e-t)*this.GetParticleMass(),n=(new tt.Vec2).Copy(i).SelfMul(1/o),r=t;r<e;r++)s[r].SelfAdd(n)},et.IsSignificantForce=function(t){return 0!==t.x||0!==t.y},et.prototype.ParticleApplyForce=function(t,e){et.IsSignificantForce(e)&&this.ForceCanBeApplied(this.flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.forceBuffer[t].SelfAdd(e))},et.prototype.ApplyForce=function(t,e,i){var s=(new tt.Vec2).Copy(i).SelfMul(1/(e-t));if(et.IsSignificantForce(s)){this.PrepareForceBuffer();for(var o=t;o<e;o++)this.forceBuffer[o].SelfAdd(s)}},et.prototype.GetNext=function(){return this.next},et.prototype.QueryAABB=function(t,e){if(0!==this.proxyBuffer.count)for(var i=this.proxyBuffer.count,s=p(this.proxyBuffer.data,0,i,et.computeTag(this.inverseDiameter*e.lowerBound.x,this.inverseDiameter*e.lowerBound.y),m.CompareProxyTag),o=f(this.proxyBuffer.data,s,i,et.computeTag(this.inverseDiameter*e.upperBound.x,this.inverseDiameter*e.upperBound.y),m.CompareTagProxy),n=this.positionBuffer.data,r=s;r<o;++r){var a=this.proxyBuffer.data[r].index,l=n[a];if(e.lowerBound.x<l.x&&l.x<e.upperBound.x&&e.lowerBound.y<l.y&&l.y<e.upperBound.y&&!t.ReportParticle(this,a))break}},et.prototype.QueryShapeAABB=function(t,e,i,s){void 0===s&&(s=0);var o=et.QueryShapeAABB_s_aabb;e.ComputeAABB(o,i,s),this.QueryAABB(t,o)},et.prototype.QueryPointAABB=function(t,e,i){void 0===i&&(i=tt.linearSlop);var s=et.QueryPointAABB_s_aabb;s.lowerBound.Set(e.x-i,e.y-i),s.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,s)},et.prototype.RayCast=function(t,e,i){var s=et.RayCast_s_aabb,o=et.RayCast_s_p,n=et.RayCast_s_v,r=et.RayCast_s_n,a=et.RayCast_s_point;if(0!==this.proxyBuffer.count){var l=this.positionBuffer.data,c=s;tt.Vec2.MinV(e,i,c.lowerBound),tt.Vec2.MaxV(e,i,c.upperBound);for(var h,u=1,p=tt.Vec2.SubVV(i,e,n),f=tt.Vec2.DotVV(p,p),d=this.GetInsideBoundsEnumerator(c);0<=(h=d.GetNext());){var y=tt.Vec2.SubVV(e,l[h],o),V=tt.Vec2.DotVV(y,p),v=V*V-f*(tt.Vec2.DotVV(y,y)-this.squaredDiameter);if(0<=v){var x=tt.Sqrt(v),S=(-V-x)/f;if(u<S)continue;if(S<0&&((S=(-V+x)/f)<0||u<S))continue;var B=tt.Vec2.AddVMulSV(y,S,p,r);B.Normalize();var A=t.ReportParticle(this,h,tt.Vec2.AddVMulSV(e,S,p,a),B,S);if((u=tt.Min(u,A))<=0)break}}}},et.prototype.ComputeAABB=function(t){var e=this.GetParticleCount();t.lowerBound.x=+tt.maxFloat,t.lowerBound.y=+tt.maxFloat,t.upperBound.x=-tt.maxFloat,t.upperBound.y=-tt.maxFloat;for(var i=this.positionBuffer.data,s=0;s<e;s++){var o=i[s];tt.Vec2.MinV(t.lowerBound,o,t.lowerBound),tt.Vec2.MaxV(t.upperBound,o,t.upperBound)}t.lowerBound.x-=this.particleDiameter,t.lowerBound.y-=this.particleDiameter,t.upperBound.x+=this.particleDiameter,t.upperBound.y+=this.particleDiameter},et.prototype.FreeBuffer=function(t,e){null!==t&&(t.length=0)},et.prototype.FreeUserOverridableBuffer=function(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.internalAllocatedCapacity)},et.prototype.ReallocateBuffer3=function(t,e,i){if(i<=e)throw new Error;var s=t?t.slice():[];return s.length=i,s},et.prototype.ReallocateBuffer5=function(t,e,i,s,o){if(s<=i)throw new Error;if(e&&!(s<=e))throw new Error;return o&&!t||e||(t=this.ReallocateBuffer3(t,i,s)),t},et.prototype.ReallocateBuffer4=function(t,e,i,s){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,s)},et.prototype.RequestBuffer=function(t){return t||(0===this.internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(tt.minParticleSystemBufferCapacity),(t=[]).length=this.internalAllocatedCapacity),t},et.prototype.ReallocateHandleBuffers=function(t){this.handleIndexBuffer.data=this.ReallocateBuffer4(this.handleIndexBuffer,this.internalAllocatedCapacity,t,!0)},et.prototype.ReallocateInternalAllocatedBuffers=function(t){function e(t,e){return e&&e<t?e:t}var i;t=e(t,this.def.maxCount),t=e(t,this.flagsBuffer.userSuppliedCapacity),t=e(t,this.positionBuffer.userSuppliedCapacity),t=e(t,this.velocityBuffer.userSuppliedCapacity),t=e(t,this.colorBuffer.userSuppliedCapacity),t=e(t,this.userDataBuffer.userSuppliedCapacity),this.internalAllocatedCapacity<t&&(this.ReallocateHandleBuffers(t),this.flagsBuffer.data=this.ReallocateBuffer4(this.flagsBuffer,this.internalAllocatedCapacity,t,!1),i=0<this.stuckThreshold,this.lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.lastBodyContactStepBuffer,this.internalAllocatedCapacity,t,i),this.bodyContactCountBuffer.data=this.ReallocateBuffer4(this.bodyContactCountBuffer,this.internalAllocatedCapacity,t,i),this.consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.consecutiveContactStepsBuffer,this.internalAllocatedCapacity,t,i),this.positionBuffer.data=this.ReallocateBuffer4(this.positionBuffer,this.internalAllocatedCapacity,t,!1),this.velocityBuffer.data=this.ReallocateBuffer4(this.velocityBuffer,this.internalAllocatedCapacity,t,!1),this.forceBuffer=this.ReallocateBuffer5(this.forceBuffer,0,this.internalAllocatedCapacity,t,!1),this.weightBuffer=this.ReallocateBuffer5(this.weightBuffer,0,this.internalAllocatedCapacity,t,!1),this.staticPressureBuffer=this.ReallocateBuffer5(this.staticPressureBuffer,0,this.internalAllocatedCapacity,t,!0),this.accumulationBuffer=this.ReallocateBuffer5(this.accumulationBuffer,0,this.internalAllocatedCapacity,t,!1),this.accumulation2Buffer=this.ReallocateBuffer5(this.accumulation2Buffer,0,this.internalAllocatedCapacity,t,!0),this.depthBuffer=this.ReallocateBuffer5(this.depthBuffer,0,this.internalAllocatedCapacity,t,!0),this.colorBuffer.data=this.ReallocateBuffer4(this.colorBuffer,this.internalAllocatedCapacity,t,!0),this.groupBuffer=this.ReallocateBuffer5(this.groupBuffer,0,this.internalAllocatedCapacity,t,!1),this.userDataBuffer.data=this.ReallocateBuffer4(this.userDataBuffer,this.internalAllocatedCapacity,t,!0),this.expirationTimeBuffer.data=this.ReallocateBuffer4(this.expirationTimeBuffer,this.internalAllocatedCapacity,t,!0),this.indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.indexByExpirationTimeBuffer,this.internalAllocatedCapacity,t,!1),this.internalAllocatedCapacity=t)},et.prototype.CreateParticleForGroup=function(t,e,i){var s=new tt.ParticleDef;s.flags=tt.Maybe(t.flags,0),tt.Transform.MulXV(e,i,s.position),tt.Vec2.AddVV(tt.Maybe(t.linearVelocity,tt.Vec2.ZERO),tt.Vec2.CrossSV(tt.Maybe(t.angularVelocity,0),tt.Vec2.SubVV(s.position,tt.Maybe(t.position,tt.Vec2.ZERO),tt.Vec2.s_t0),tt.Vec2.s_t0),s.velocity),s.color.Copy(tt.Maybe(t.color,tt.Color.ZERO)),s.lifetime=tt.Maybe(t.lifetime,0),s.userData=t.userData,this.CreateParticle(s)},et.prototype.CreateParticlesStrokeShapeForGroup=function(t,e,i){var s=et.CreateParticlesStrokeShapeForGroup_s_edge,o=et.CreateParticlesStrokeShapeForGroup_s_d,n=et.CreateParticlesStrokeShapeForGroup_s_p,r=tt.Maybe(e.stride,0);0===r&&(r=this.GetParticleStride());for(var a=0,l=t.GetChildCount(),c=0;c<l;c++){var h=null;t.GetType()===tt.ShapeType.e_edgeShape?h=t:(h=s,t.GetChildEdge(h,c));for(var u=tt.Vec2.SubVV(h.vertex2,h.vertex1,o),p=u.Length();a<p;){var f=tt.Vec2.AddVMulSV(h.vertex1,a/p,u,n);this.CreateParticleForGroup(e,i,f),a+=r}a-=p}},et.prototype.CreateParticlesFillShapeForGroup=function(t,e,i){var s=et.CreateParticlesFillShapeForGroup_s_aabb,o=et.CreateParticlesFillShapeForGroup_s_p,n=tt.Maybe(e.stride,0);0===n&&(n=this.GetParticleStride());var r=tt.Transform.IDENTITY,a=s;t.ComputeAABB(a,r,0);for(var l=Math.floor(a.lowerBound.y/n)*n;l<a.upperBound.y;l+=n)for(var c=Math.floor(a.lowerBound.x/n)*n;c<a.upperBound.x;c+=n){var h=o.Set(c,l);t.TestPoint(r,h)&&this.CreateParticleForGroup(e,i,h)}},et.prototype.CreateParticlesWithShapeForGroup=function(t,e,i){switch(t.GetType()){case tt.ShapeType.e_edgeShape:case tt.ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(t,e,i);break;case tt.ShapeType.e_polygonShape:case tt.ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(t,e,i)}},et.prototype.CreateParticlesWithShapesForGroup=function(t,e,i,s){var o=new U(t,e);this.CreateParticlesFillShapeForGroup(o,i,s)},et.prototype.CloneParticle=function(t,e){var i=new tt.ParticleDef;i.flags=this.flagsBuffer.data[t],i.position.Copy(this.positionBuffer.data[t]),i.velocity.Copy(this.velocityBuffer.data[t]),this.colorBuffer.data&&i.color.Copy(this.colorBuffer.data[t]),this.userDataBuffer.data&&(i.userData=this.userDataBuffer.data[t]),i.group=e;var s,o=this.CreateParticle(i);return this.handleIndexBuffer.data&&((s=this.handleIndexBuffer.data[t])&&s.SetIndex(o),this.handleIndexBuffer.data[o]=s,this.handleIndexBuffer.data[t]=null),this.lastBodyContactStepBuffer.data&&(this.lastBodyContactStepBuffer.data[o]=this.lastBodyContactStepBuffer.data[t]),this.bodyContactCountBuffer.data&&(this.bodyContactCountBuffer.data[o]=this.bodyContactCountBuffer.data[t]),this.consecutiveContactStepsBuffer.data&&(this.consecutiveContactStepsBuffer.data[o]=this.consecutiveContactStepsBuffer.data[t]),this.hasForce&&this.forceBuffer[o].Copy(this.forceBuffer[t]),this.staticPressureBuffer&&(this.staticPressureBuffer[o]=this.staticPressureBuffer[t]),this.depthBuffer&&(this.depthBuffer[o]=this.depthBuffer[t]),this.expirationTimeBuffer.data&&(this.expirationTimeBuffer.data[o]=this.expirationTimeBuffer.data[t]),o},et.prototype.DestroyParticlesInGroup=function(t,e){void 0===e&&(e=!1);for(var i=t.firstIndex;i<t.lastIndex;i++)this.DestroyParticle(i,e)},et.prototype.DestroyParticleGroup=function(t){this.world.destructionListener&&this.world.destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(var e=t.firstIndex;e<t.lastIndex;e++)this.groupBuffer[e]=null;t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.groupList&&(this.groupList=t.next),--this.groupCount},et.ParticleCanBeConnected=function(t,e){return 0!=(t&(tt.ParticleFlag.wallParticle|tt.ParticleFlag.springParticle|tt.ParticleFlag.elasticParticle))||null!==e&&0!=(e.GetGroupFlags()&tt.ParticleGroupFlag.rigidParticleGroup)},et.prototype.UpdatePairsAndTriads=function(t,e,S){for(var B=et.UpdatePairsAndTriads_s_dab,A=et.UpdatePairsAndTriads_s_dbc,C=et.UpdatePairsAndTriads_s_dca,m=this.positionBuffer.data,i=0,s=t;s<e;s++)i|=this.flagsBuffer.data[s];if(i&et.k_pairFlags)for(var o=0;o<this.contactBuffer.count;o++){var n,r=this.contactBuffer.data[o],a=r.indexA,l=r.indexB,c=this.flagsBuffer.data[a],h=this.flagsBuffer.data[l],u=this.groupBuffer[a],p=this.groupBuffer[l];t<=a&&a<e&&t<=l&&l<e&&!((c|h)&tt.ParticleFlag.zombieParticle)&&(c|h)&et.k_pairFlags&&(S.IsNecessary(a)||S.IsNecessary(l))&&et.ParticleCanBeConnected(c,u)&&et.ParticleCanBeConnected(h,p)&&S.ShouldCreatePair(a,l)&&((n=this.pairBuffer.data[this.pairBuffer.Append()]).indexA=a,n.indexB=l,n.flags=r.flags,n.strength=tt.Min(u?u.strength:1,p?p.strength:1),n.distance=tt.Vec2.DistanceVV(m[a],m[l])),v(this.pairBuffer.data,0,this.pairBuffer.count,et.ComparePairIndices),this.pairBuffer.Unique(et.MatchPairIndices)}if(i&et.k_triadFlags){for(var f=new tt.VoronoiDiagram(e-t),s=t;s<e;s++){var d=this.flagsBuffer.data[s],y=this.groupBuffer[s];d&tt.ParticleFlag.zombieParticle||!et.ParticleCanBeConnected(d,y)||f.AddGenerator(m[s],s,S.IsNecessary(s))}var V=this.GetParticleStride();f.Generate(V/2,2*V);var g=this;f.GetNodes(function(t,e,i){var s=g.flagsBuffer.data[t],o=g.flagsBuffer.data[e],n=g.flagsBuffer.data[i];if((s|o|n)&et.k_triadFlags&&S.ShouldCreateTriad(t,e,i)){var r=m[t],a=m[e],l=m[i],c=tt.Vec2.SubVV(r,a,B),h=tt.Vec2.SubVV(a,l,A),u=tt.Vec2.SubVV(l,r,C),p=tt.maxTriadDistanceSquared*g.squaredDiameter;if(tt.Vec2.DotVV(c,c)>p||tt.Vec2.DotVV(h,h)>p||tt.Vec2.DotVV(u,u)>p)return;var f=g.groupBuffer[t],d=g.groupBuffer[e],y=g.groupBuffer[i],V=g.triadBuffer.data[g.triadBuffer.Append()];V.indexA=t,V.indexB=e,V.indexC=i,V.flags=s|o|n,V.strength=tt.Min(tt.Min(f?f.strength:1,d?d.strength:1),y?y.strength:1);var v=(r.x+a.x+l.x)/3,x=(r.y+a.y+l.y)/3;V.pa.x=r.x-v,V.pa.y=r.y-x,V.pb.x=a.x-v,V.pb.y=a.y-x,V.pc.x=l.x-v,V.pc.y=l.y-x,V.ka=-tt.Vec2.DotVV(u,c),V.kb=-tt.Vec2.DotVV(c,h),V.kc=-tt.Vec2.DotVV(h,u),V.s=tt.Vec2.CrossVV(r,a)+tt.Vec2.CrossVV(a,l)+tt.Vec2.CrossVV(l,r)}}),v(this.triadBuffer.data,0,this.triadBuffer.count,et.CompareTriadIndices),this.triadBuffer.Unique(et.MatchTriadIndices)}},et.prototype.UpdatePairsAndTriadsWithReactiveParticles=function(){var t=new Y(this.flagsBuffer);this.UpdatePairsAndTriads(0,this.count,t);for(var e=0;e<this.count;e++)this.flagsBuffer.data[e]&=~tt.ParticleFlag.reactiveParticle;this.allParticleFlags&=~tt.ParticleFlag.reactiveParticle},et.ComparePairIndices=function(t,e){var i=t.indexA-e.indexA;return 0!=i?i<0:t.indexB<e.indexB},et.MatchPairIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB},et.CompareTriadIndices=function(t,e){var i=t.indexA-e.indexA;if(0!=i)return i<0;var s=t.indexB-e.indexB;return 0!=s?s<0:t.indexC<e.indexC},et.MatchTriadIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC},et.InitializeParticleLists=function(t,e){for(var i=t.GetBufferIndex(),s=t.GetParticleCount(),o=0;o<s;o++){var n=e[o];(n.list=n).next=null,n.count=1,n.index=o+i}},et.prototype.MergeParticleListsInContact=function(t,e){for(var i=t.GetBufferIndex(),s=0;s<this.contactBuffer.count;s++){var o,n,r,a=this.contactBuffer.data[s],l=a.indexA,c=a.indexB;t.ContainsParticle(l)&&t.ContainsParticle(c)&&((n=e[l-i].list)!==(r=e[c-i].list)&&(n.count<r.count&&(o=n,n=r,r=o),et.MergeParticleLists(n,r)))}},et.MergeParticleLists=function(t,e){for(var i=e;;){i.list=t;var s=i.next;if(!s){i.next=t.next;break}i=s}t.next=e,t.count+=e.count,e.count=0},et.FindLongestParticleList=function(t,e){for(var i=t.GetParticleCount(),s=e[0],o=0;o<i;o++){var n=e[o];s.count<n.count&&(s=n)}return s},et.prototype.MergeZombieParticleListNodes=function(t,e,i){for(var s=t.GetParticleCount(),o=0;o<s;o++){var n=e[o];n!==i&&this.flagsBuffer.data[n.index]&tt.ParticleFlag.zombieParticle&&et.MergeParticleListAndNode(i,n)}},et.MergeParticleListAndNode=function(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0},et.prototype.CreateParticleGroupsFromParticleList=function(t,e,i){var s=t.GetParticleCount(),o=new tt.ParticleGroupDef;o.groupFlags=t.GetGroupFlags(),o.userData=t.GetUserData();for(var n=0;n<s;n++){var r=e[n];if(r.count&&r!==i)for(var a=this.CreateParticleGroup(o),l=r;l;l=l.next){var c=l.index,h=this.CloneParticle(c,a);this.flagsBuffer.data[c]|=tt.ParticleFlag.zombieParticle,l.index=h}}},et.prototype.UpdatePairsAndTriadsWithParticleList=function(t,e){for(var i=t.GetBufferIndex(),s=0;s<this.pairBuffer.count;s++){var o=this.pairBuffer.data[s],n=o.indexA,r=o.indexB;t.ContainsParticle(n)&&(o.indexA=e[n-i].index),t.ContainsParticle(r)&&(o.indexB=e[r-i].index)}for(s=0;s<this.triadBuffer.count;s++){var a=this.triadBuffer.data[s],n=a.indexA,r=a.indexB,l=a.indexC;t.ContainsParticle(n)&&(a.indexA=e[n-i].index),t.ContainsParticle(r)&&(a.indexB=e[r-i].index),t.ContainsParticle(l)&&(a.indexC=e[l-i].index)}},et.prototype.ComputeDepth=function(){for(var t=[],e=0,i=0;i<this.contactBuffer.count;i++){var s=(V=this.contactBuffer.data[i]).indexA,o=V.indexB,n=this.groupBuffer[s],r=this.groupBuffer[o];n&&n===r&&n.groupFlags&tt.ParticleGroupFlag.particleGroupNeedsUpdateDepth&&(t[e++]=V)}for(var a=[],l=0,c=this.groupList;c;c=c.GetNext())if(c.groupFlags&tt.ParticleGroupFlag.particleGroupNeedsUpdateDepth){a[l++]=c,this.SetGroupFlags(c,c.groupFlags&~tt.ParticleGroupFlag.particleGroupNeedsUpdateDepth);for(var h=c.firstIndex;h<c.lastIndex;h++)this.accumulationBuffer[h]=0}for(i=0;i<e;i++){var s=(V=t[i]).indexA,o=V.indexB,u=V.weight;this.accumulationBuffer[s]+=u,this.accumulationBuffer[o]+=u}for(h=0;h<l;h++)for(var p=(c=a[h]).firstIndex;p<c.lastIndex;p++){u=this.accumulationBuffer[p];this.depthBuffer[p]=u<.8?0:tt.maxFloat}for(var f=tt.Sqrt(this.count)>>0,d=0;d<f;d++){for(var y=!1,i=0;i<e;i++){var V,s=(V=t[i]).indexA,o=V.indexB,v=1-V.weight,x=this.depthBuffer[s],S=this.depthBuffer[o],B=S+v,A=x+v;B<x&&(this.depthBuffer[s]=B,y=!0),A<S&&(this.depthBuffer[o]=A,y=!0)}if(!y)break}for(h=0;h<l;h++)for(var C=(c=a[h]).firstIndex;C<c.lastIndex;C++)this.depthBuffer[C]<tt.maxFloat?this.depthBuffer[C]*=this.particleDiameter:this.depthBuffer[C]=0},et.prototype.GetInsideBoundsEnumerator=function(t){var e=et.computeTag(this.inverseDiameter*t.lowerBound.x-1,this.inverseDiameter*t.lowerBound.y-1),i=et.computeTag(this.inverseDiameter*t.upperBound.x+1,this.inverseDiameter*t.upperBound.y+1),s=this.proxyBuffer.count,o=p(this.proxyBuffer.data,0,s,e,m.CompareProxyTag),n=f(this.proxyBuffer.data,0,s,i,m.CompareTagProxy);return new w(this,e,i,o,n)},et.prototype.UpdateAllParticleFlags=function(){for(var t=this.allParticleFlags=0;t<this.count;t++)this.allParticleFlags|=this.flagsBuffer.data[t];this.needsUpdateAllParticleFlags=!1},et.prototype.UpdateAllGroupFlags=function(){this.allGroupFlags=0;for(var t=this.groupList;t;t=t.GetNext())this.allGroupFlags|=t.groupFlags;this.needsUpdateAllGroupFlags=!1},et.prototype.AddContact=function(t,e,i){var s,o,n=this.flagsBuffer.data,r=this.positionBuffer.data,a=tt.Vec2.SubVV(r[e],r[t],et.AddContact_s_d),l=tt.Vec2.DotVV(a,a);0<l&&l<this.squaredDiameter&&(s=tt.InvSqrt(l),(o=this.contactBuffer.data[this.contactBuffer.Append()]).indexA=t,o.indexB=e,o.flags=n[t]|n[e],o.weight=1-l*s*this.inverseDiameter,o.normal.x=s*a.x,o.normal.y=s*a.y)},et.prototype.FindContacts_Reference=function(t){for(var e=this.proxyBuffer.count,i=this.contactBuffer.count=0,s=0;i<e;i++){for(var o=et.computeRelativeTag(this.proxyBuffer.data[i].tag,1,0),n=i+1;n<e&&!(o<this.proxyBuffer.data[n].tag);n++)this.AddContact(this.proxyBuffer.data[i].index,this.proxyBuffer.data[n].index,this.contactBuffer);for(var r=et.computeRelativeTag(this.proxyBuffer.data[i].tag,-1,1);s<e&&!(r<=this.proxyBuffer.data[s].tag);s++);for(var a=et.computeRelativeTag(this.proxyBuffer.data[i].tag,1,1),n=s;n<e&&!(a<this.proxyBuffer.data[n].tag);n++)this.AddContact(this.proxyBuffer.data[i].index,this.proxyBuffer.data[n].index,this.contactBuffer)}},et.prototype.FindContacts=function(t){this.FindContacts_Reference(t)},et.prototype.UpdateProxies_Reference=function(t){for(var e=this.positionBuffer.data,i=this.inverseDiameter,s=0;s<this.proxyBuffer.count;++s){var o=this.proxyBuffer.data[s],n=e[o.index];o.tag=et.computeTag(i*n.x,i*n.y)}},et.prototype.UpdateProxies=function(t){this.UpdateProxies_Reference(t)},et.prototype.SortProxies=function(t){u(this.proxyBuffer.data,0,this.proxyBuffer.count,m.CompareProxyProxy)},et.prototype.FilterContacts=function(t){var e,i=this.GetParticleContactFilter();null!==i&&(e=this).contactBuffer.RemoveIf(function(t){return 0!=(t.flags&tt.ParticleFlag.particleContactFilterParticle)&&!i.ShouldCollideParticleParticle(e,t.indexA,t.indexB)})},et.prototype.NotifyContactListenerPreContact=function(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.contactBuffer,this.flagsBuffer),new Error},et.prototype.NotifyContactListenerPostContact=function(t){var e=this.GetParticleContactListener();if(null!==e){for(var i=0;i<this.contactBuffer.count;++i){var s=this.contactBuffer.data[i];e.BeginContactParticleParticle(this,s)}throw new Error}},et.ParticleContactIsZombie=function(t){return(t.flags&tt.ParticleFlag.zombieParticle)===tt.ParticleFlag.zombieParticle},et.prototype.UpdateContacts=function(t){this.UpdateProxies(this.proxyBuffer),this.SortProxies(this.proxyBuffer);var e=new L;this.NotifyContactListenerPreContact(e),this.FindContacts(this.contactBuffer),this.FilterContacts(this.contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.contactBuffer.RemoveIf(et.ParticleContactIsZombie)},et.prototype.NotifyBodyContactListenerPreContact=function(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.bodyContactBuffer,this.flagsBuffer),new Error},et.prototype.NotifyBodyContactListenerPostContact=function(t){var e=this.GetFixtureContactListener();if(null!==e){for(var i=0;i<this.bodyContactBuffer.count;i++){var s=this.bodyContactBuffer.data[i];e.BeginContactFixtureParticle(this,s)}throw new Error}},et.prototype.UpdateBodyContacts=function(){var t=et.UpdateBodyContacts_s_aabb,e=new G;if(this.NotifyBodyContactListenerPreContact(e),0<this.stuckThreshold)for(var i=this.GetParticleCount(),s=0;s<i;s++)this.bodyContactCountBuffer.data[s]=0,this.timestamp>this.lastBodyContactStepBuffer.data[s]+1&&(this.consecutiveContactStepsBuffer.data[s]=0);this.bodyContactBuffer.SetCount(0),this.stuckParticleBuffer.SetCount(0);var o=t;this.ComputeAABB(o),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new $(this));var n=this.UpdateBodyContacts_callback;n.contactFilter=this.GetFixtureContactFilter(),this.world.QueryAABB(n,o),this.def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)},et.prototype.Solve=function(t){var e=et.Solve_s_subStep;if(0!==this.count&&(this.expirationTimeBuffer.data&&this.SolveLifetimes(t),this.allParticleFlags&tt.ParticleFlag.zombieParticle&&this.SolveZombie(),this.needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.paused))for(this.iterationIndex=0;this.iterationIndex<t.particleIterations;this.iterationIndex++){++this.timestamp;var i=e.Copy(t);i.dt/=t.particleIterations,i.inv_dt*=t.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.allGroupFlags&tt.ParticleGroupFlag.particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.allParticleFlags&tt.ParticleFlag.reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.hasForce&&this.SolveForce(i),this.allParticleFlags&tt.ParticleFlag.viscousParticle&&this.SolveViscous(),this.allParticleFlags&tt.ParticleFlag.repulsiveParticle&&this.SolveRepulsive(i),this.allParticleFlags&tt.ParticleFlag.powderParticle&&this.SolvePowder(i),this.allParticleFlags&tt.ParticleFlag.tensileParticle&&this.SolveTensile(i),this.allGroupFlags&tt.ParticleGroupFlag.solidParticleGroup&&this.SolveSolid(i),this.allParticleFlags&tt.ParticleFlag.colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(i),this.allParticleFlags&tt.ParticleFlag.staticPressureParticle&&this.SolveStaticPressure(i),this.SolvePressure(i),this.SolveDamping(i),this.allParticleFlags&et.k_extraDampingFlags&&this.SolveExtraDamping(),this.allParticleFlags&tt.ParticleFlag.elasticParticle&&this.SolveElastic(i),this.allParticleFlags&tt.ParticleFlag.springParticle&&this.SolveSpring(i),this.LimitVelocity(i),this.allGroupFlags&tt.ParticleGroupFlag.rigidParticleGroup&&this.SolveRigidDamping(),this.allParticleFlags&tt.ParticleFlag.barrierParticle&&this.SolveBarrier(i),this.SolveCollision(i),this.allGroupFlags&tt.ParticleGroupFlag.rigidParticleGroup&&this.SolveRigid(i),this.allParticleFlags&tt.ParticleFlag.wallParticle&&this.SolveWall();for(var s=0;s<this.count;s++)this.positionBuffer.data[s].SelfMulAdd(i.dt,this.velocityBuffer.data[s])}},et.prototype.SolveCollision=function(t){var e=et.SolveCollision_s_aabb,i=this.positionBuffer.data,s=this.velocityBuffer.data,o=e;o.lowerBound.x=+tt.maxFloat,o.lowerBound.y=+tt.maxFloat,o.upperBound.x=-tt.maxFloat,o.upperBound.y=-tt.maxFloat;for(var n=0;n<this.count;n++){var r=s[n],a=i[n],l=a.x+t.dt*r.x,c=a.y+t.dt*r.y;o.lowerBound.x=tt.Min(o.lowerBound.x,tt.Min(a.x,l)),o.lowerBound.y=tt.Min(o.lowerBound.y,tt.Min(a.y,c)),o.upperBound.x=tt.Max(o.upperBound.x,tt.Max(a.x,l)),o.upperBound.y=tt.Max(o.upperBound.y,tt.Max(a.y,c))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new ot(this,t));var h=this.SolveCollision_callback;h.step=t,this.world.QueryAABB(h,o)},et.prototype.LimitVelocity=function(t){for(var e=this.velocityBuffer.data,i=this.GetCriticalVelocitySquared(t),s=0;s<this.count;s++){var o=e[s],n=tt.Vec2.DotVV(o,o);i<n&&o.SelfMul(tt.Sqrt(i/n))}},et.prototype.SolveGravity=function(t){for(var e=et.SolveGravity_s_gravity,i=this.velocityBuffer.data,s=tt.Vec2.MulSV(t.dt*this.def.gravityScale,this.world.GetGravity(),e),o=0;o<this.count;o++)i[o].SelfAdd(s)},et.prototype.SolveBarrier=function(t){for(var e=et.SolveBarrier_s_aabb,i=et.SolveBarrier_s_va,s=et.SolveBarrier_s_vb,o=et.SolveBarrier_s_pba,n=et.SolveBarrier_s_vba,r=et.SolveBarrier_s_vc,a=et.SolveBarrier_s_pca,l=et.SolveBarrier_s_vca,c=et.SolveBarrier_s_qba,h=et.SolveBarrier_s_qca,u=et.SolveBarrier_s_dv,p=et.SolveBarrier_s_f,f=this.positionBuffer.data,d=this.velocityBuffer.data,y=0;y<this.count;y++){0!=(this.flagsBuffer.data[y]&et.k_barrierWallFlags)&&d[y].SetZero()}for(var V=tt.barrierCollisionTime*t.dt,v=this.GetParticleMass(),x=0;x<this.pairBuffer.count;x++){var S=this.pairBuffer.data[x];if(S.flags&tt.ParticleFlag.barrierParticle){var B=S.indexA,A=S.indexB,C=f[B],m=f[A],g=e;tt.Vec2.MinV(C,m,g.lowerBound),tt.Vec2.MaxV(C,m,g.upperBound);for(var w,_=this.groupBuffer[B],b=this.groupBuffer[A],M=this.GetLinearVelocity(_,B,C,i),P=this.GetLinearVelocity(b,A,m,s),I=tt.Vec2.SubVV(m,C,o),D=tt.Vec2.SubVV(P,M,n),G=this.GetInsideBoundsEnumerator(g);0<=(w=G.GetNext());){var T=f[w],F=this.groupBuffer[w];if(_!==F&&b!==F){var R=this.GetLinearVelocity(F,w,T,r),L=tt.Vec2.SubVV(T,C,a),k=tt.Vec2.SubVV(R,M,l),q=tt.Vec2.CrossVV(D,k),J=tt.Vec2.CrossVV(I,k)-tt.Vec2.CrossVV(L,D),E=tt.Vec2.CrossVV(I,L),z=void 0,j=void 0,N=c,O=h;if(0===q){if(0==J)continue;if(!(0<=(j=-E/J)&&j<V))continue;if(tt.Vec2.AddVMulSV(I,j,D,N),tt.Vec2.AddVMulSV(L,j,k,O),!(0<=(z=tt.Vec2.DotVV(N,O)/tt.Vec2.DotVV(N,N))&&z<=1))continue}else{var X=J*J-4*E*q;if(X<0)continue;var Z,U=tt.Sqrt(X),W=(-J-U)/(2*q),Q=(-J+U)/(2*q);if(Q<W&&(Z=W,W=Q,Q=Z),j=W,tt.Vec2.AddVMulSV(I,j,D,N),tt.Vec2.AddVMulSV(L,j,k,O),z=tt.Vec2.DotVV(N,O)/tt.Vec2.DotVV(N,N),!(0<=j&&j<V&&0<=z&&z<=1)){if(!(0<=(j=Q)&&j<V))continue;if(tt.Vec2.AddVMulSV(I,j,D,N),tt.Vec2.AddVMulSV(L,j,k,O),!(0<=(z=tt.Vec2.DotVV(N,O)/tt.Vec2.DotVV(N,N))&&z<=1))continue}}var Y=u;Y.x=M.x+z*D.x-R.x,Y.y=M.y+z*D.y-R.y;var K,H,$=tt.Vec2.MulSV(v,Y,p);F&&this.IsRigidGroup(F)?(K=F.GetMass(),H=F.GetInertia(),0<K&&F.linearVelocity.SelfMulAdd(1/K,$),0<H&&(F.angularVelocity+=tt.Vec2.CrossVV(tt.Vec2.SubVV(T,F.GetCenter(),tt.Vec2.s_t0),$)/H)):d[w].SelfAdd(Y),this.ParticleApplyForce(w,$.SelfMul(-t.inv_dt))}}}}},et.prototype.SolveStaticPressure=function(t){this.staticPressureBuffer=this.RequestBuffer(this.staticPressureBuffer);for(var e=this.GetCriticalPressure(t),i=this.def.staticPressureStrength*e,s=tt.maxParticlePressure*e,o=this.def.staticPressureRelaxation,n=0;n<this.def.staticPressureIterations;n++){for(var r=0;r<this.count;r++)this.accumulationBuffer[r]=0;for(var a=0;a<this.contactBuffer.count;a++){var l,c,h=this.contactBuffer.data[a];h.flags&tt.ParticleFlag.staticPressureParticle&&(l=h.indexA,c=h.indexB,p=h.weight,this.accumulationBuffer[l]+=p*this.staticPressureBuffer[c],this.accumulationBuffer[c]+=p*this.staticPressureBuffer[l])}for(r=0;r<this.count;r++){var u,p=this.weightBuffer[r];this.flagsBuffer.data[r]&tt.ParticleFlag.staticPressureParticle?(u=(this.accumulationBuffer[r]+i*(p-tt.minParticleWeight))/(p+o),this.staticPressureBuffer[r]=tt.Clamp(u,0,s)):this.staticPressureBuffer[r]=0}}},et.prototype.ComputeWeight=function(){for(var t=0;t<this.count;t++)this.weightBuffer[t]=0;for(t=0;t<this.bodyContactBuffer.count;t++){var e=(s=this.bodyContactBuffer.data[t]).index,i=s.weight;this.weightBuffer[e]+=i}for(t=0;t<this.contactBuffer.count;t++){var s,e=(s=this.contactBuffer.data[t]).indexA,o=s.indexB,i=s.weight;this.weightBuffer[e]+=i,this.weightBuffer[o]+=i}},et.prototype.SolvePressure=function(t){for(var e=et.SolvePressure_s_f,i=this.positionBuffer.data,s=this.velocityBuffer.data,o=this.GetCriticalPressure(t),n=this.def.pressureStrength*o,r=tt.maxParticlePressure*o,a=0;a<this.count;a++){var l=this.weightBuffer[a],c=n*tt.Max(0,l-tt.minParticleWeight);this.accumulationBuffer[a]=tt.Min(c,r)}if(this.allParticleFlags&et.k_noPressureFlags)for(a=0;a<this.count;a++)this.flagsBuffer.data[a]&et.k_noPressureFlags&&(this.accumulationBuffer[a]=0);if(this.allParticleFlags&tt.ParticleFlag.staticPressureParticle)for(a=0;a<this.count;a++)this.flagsBuffer.data[a]&tt.ParticleFlag.staticPressureParticle&&(this.accumulationBuffer[a]+=this.staticPressureBuffer[a]);for(var h=t.dt/(this.def.density*this.particleDiameter),u=this.GetParticleInvMass(),p=0;p<this.bodyContactBuffer.count;p++){var f=(S=this.bodyContactBuffer.data[p]).index,d=S.body,l=S.weight,y=S.mass,V=S.normal,v=i[f],c=this.accumulationBuffer[f]+n*l,x=tt.Vec2.MulSV(h*l*y*c,V,e);s[f].SelfMulSub(u,x),d.ApplyLinearImpulse(x,v,!0)}for(p=0;p<this.contactBuffer.count;p++){var S,f=(S=this.contactBuffer.data[p]).indexA,d=S.indexB,l=S.weight,V=S.normal,c=this.accumulationBuffer[f]+this.accumulationBuffer[d],x=tt.Vec2.MulSV(h*l*c,V,e);s[f].SelfSub(x),s[d].SelfAdd(x)}},et.prototype.SolveDamping=function(t){for(var e=et.SolveDamping_s_v,i=et.SolveDamping_s_f,s=this.positionBuffer.data,o=this.velocityBuffer.data,n=this.def.dampingStrength,r=1/this.GetCriticalVelocity(t),a=this.GetParticleInvMass(),l=0;l<this.bodyContactBuffer.count;l++){var c=(V=this.bodyContactBuffer.data[l]).index,h=V.body,u=V.weight,p=V.mass,f=V.normal,d=s[c],y=tt.Vec2.SubVV(h.GetLinearVelocityFromWorldPoint(d,tt.Vec2.s_t0),o[c],e);(v=tt.Vec2.DotVV(y,f))<0&&(x=tt.Max(n*u,tt.Min(-r*v,.5)),S=tt.Vec2.MulSV(x*p*v,f,i),o[c].SelfMulAdd(a,S),h.ApplyLinearImpulse(S.SelfNeg(),d,!0))}for(l=0;l<this.contactBuffer.count;l++){var V,v,x,S,c=(V=this.contactBuffer.data[l]).indexA,h=V.indexB,u=V.weight,f=V.normal,y=tt.Vec2.SubVV(o[h],o[c],e);(v=tt.Vec2.DotVV(y,f))<0&&(x=tt.Max(n*u,tt.Min(-r*v,.5)),S=tt.Vec2.MulSV(x*v,f,i),o[c].SelfAdd(S),o[h].SelfSub(S))}},et.prototype.SolveRigidDamping=function(){for(var t=et.SolveRigidDamping_s_t0,e=et.SolveRigidDamping_s_t1,i=et.SolveRigidDamping_s_p,s=et.SolveRigidDamping_s_v,o=[0],n=[0],r=[0],a=[0],l=[0],c=[0],h=this.positionBuffer.data,u=this.def.dampingStrength,p=0;p<this.bodyContactBuffer.count;p++){var f=(d=this.bodyContactBuffer.data[p]).index;(C=this.groupBuffer[f])&&this.IsRigidGroup(C)&&(S=d.body,B=d.normal,A=d.weight,y=h[f],V=tt.Vec2.SubVV(S.GetLinearVelocityFromWorldPoint(y,t),C.GetLinearVelocityFromWorldPoint(y,e),s),(v=tt.Vec2.DotVV(V,B))<0&&(this.InitDampingParameterWithRigidGroupOrParticle(o,n,r,!0,C,f,y,B),this.InitDampingParameter(a,l,c,S.GetMass(),S.GetInertia()-S.GetMass()*S.GetLocalCenter().LengthSquared(),S.GetWorldCenter(),y,B),x=u*tt.Min(A,1)*this.ComputeDampingImpulse(o[0],n[0],r[0],a[0],l[0],c[0],v),this.ApplyDamping(o[0],n[0],r[0],!0,C,f,x,B),S.ApplyLinearImpulse(tt.Vec2.MulSV(-x,B,tt.Vec2.s_t0),y,!0)))}for(p=0;p<this.contactBuffer.count;p++){var d,y,V,v,x,f=(d=this.contactBuffer.data[p]).indexA,S=d.indexB,B=d.normal,A=d.weight,C=this.groupBuffer[f],m=this.groupBuffer[S],g=this.IsRigidGroup(C),w=this.IsRigidGroup(m);C!==m&&(g||w)&&(y=tt.Vec2.MidVV(h[f],h[S],i),V=tt.Vec2.SubVV(this.GetLinearVelocity(m,S,y,t),this.GetLinearVelocity(C,f,y,e),s),(v=tt.Vec2.DotVV(V,B))<0&&(this.InitDampingParameterWithRigidGroupOrParticle(o,n,r,g,C,f,y,B),this.InitDampingParameterWithRigidGroupOrParticle(a,l,c,w,m,S,y,B),x=u*A*this.ComputeDampingImpulse(o[0],n[0],r[0],a[0],l[0],c[0],v),this.ApplyDamping(o[0],n[0],r[0],g,C,f,x,B),this.ApplyDamping(a[0],l[0],c[0],w,m,S,-x,B)))}},et.prototype.SolveExtraDamping=function(){for(var t=et.SolveExtraDamping_s_v,e=et.SolveExtraDamping_s_f,i=this.velocityBuffer.data,s=this.positionBuffer.data,o=this.GetParticleInvMass(),n=0;n<this.bodyContactBuffer.count;n++){var r,a,l,c,h,u,p,f=this.bodyContactBuffer.data[n],d=f.index;this.flagsBuffer.data[d]&et.k_extraDampingFlags&&(r=f.body,a=f.mass,l=f.normal,c=s[d],h=tt.Vec2.SubVV(r.GetLinearVelocityFromWorldPoint(c,tt.Vec2.s_t0),i[d],t),(u=tt.Vec2.DotVV(h,l))<0&&(p=tt.Vec2.MulSV(.5*a*u,l,e),i[d].SelfMulAdd(o,p),r.ApplyLinearImpulse(p.SelfNeg(),c,!0)))}},et.prototype.SolveWall=function(){for(var t=this.velocityBuffer.data,e=0;e<this.count;e++)this.flagsBuffer.data[e]&tt.ParticleFlag.wallParticle&&t[e].SetZero()},et.prototype.SolveRigid=function(t){for(var e=et.SolveRigid_s_position,i=et.SolveRigid_s_rotation,s=et.SolveRigid_s_transform,o=et.SolveRigid_s_velocityTransform,n=this.positionBuffer.data,r=this.velocityBuffer.data,a=this.groupList;a;a=a.GetNext())if(a.groupFlags&tt.ParticleGroupFlag.rigidParticleGroup){a.UpdateStatistics();var l=i;l.SetAngle(t.dt*a.angularVelocity);var c=tt.Vec2.AddVV(a.center,tt.Vec2.SubVV(tt.Vec2.MulSV(t.dt,a.linearVelocity,tt.Vec2.s_t0),tt.Rot.MulRV(l,a.center,tt.Vec2.s_t1),tt.Vec2.s_t0),e),h=s;h.SetPositionRotation(c,l),tt.Transform.MulXX(h,a.transform,a.transform);var u=o;u.p.x=t.inv_dt*h.p.x,u.p.y=t.inv_dt*h.p.y,u.q.s=t.inv_dt*h.q.s,u.q.c=t.inv_dt*(h.q.c-1);for(var p=a.firstIndex;p<a.lastIndex;p++)tt.Transform.MulXV(u,n[p],r[p])}},et.prototype.SolveElastic=function(t){for(var e=et.SolveElastic_s_pa,i=et.SolveElastic_s_pb,s=et.SolveElastic_s_pc,o=et.SolveElastic_s_r,n=et.SolveElastic_s_t0,r=this.positionBuffer.data,a=this.velocityBuffer.data,l=t.inv_dt*this.def.elasticStrength,c=0;c<this.triadBuffer.count;c++){var h,u,p,f,d,y,V,v,x,S,B,A,C,m,g,w,_,b,M=this.triadBuffer.data[c];M.flags&tt.ParticleFlag.elasticParticle&&(h=M.indexA,u=M.indexB,p=M.indexC,f=M.pa,d=M.pb,y=M.pc,V=e.Copy(r[h]),v=i.Copy(r[u]),x=s.Copy(r[p]),S=a[h],B=a[u],A=a[p],V.SelfMulAdd(t.dt,S),v.SelfMulAdd(t.dt,B),x.SelfMulAdd(t.dt,A),C=(V.x+v.x+x.x)/3,m=(V.y+v.y+x.y)/3,V.x-=C,V.y-=m,v.x-=C,v.y-=m,x.x-=C,x.y-=m,(g=o).s=tt.Vec2.CrossVV(f,V)+tt.Vec2.CrossVV(d,v)+tt.Vec2.CrossVV(y,x),g.c=tt.Vec2.DotVV(f,V)+tt.Vec2.DotVV(d,v)+tt.Vec2.DotVV(y,x),w=g.s*g.s+g.c*g.c,_=tt.InvSqrt(w),isFinite(_)||(_=198177537e11),g.s*=_,g.c*=_,b=l*M.strength,tt.Rot.MulRV(g,f,n),tt.Vec2.SubVV(n,V,n),tt.Vec2.MulSV(b,n,n),S.SelfAdd(n),tt.Rot.MulRV(g,d,n),tt.Vec2.SubVV(n,v,n),tt.Vec2.MulSV(b,n,n),B.SelfAdd(n),tt.Rot.MulRV(g,y,n),tt.Vec2.SubVV(n,x,n),tt.Vec2.MulSV(b,n,n),A.SelfAdd(n))}},et.prototype.SolveSpring=function(t){for(var e=et.SolveSpring_s_pa,i=et.SolveSpring_s_pb,s=et.SolveSpring_s_d,o=et.SolveSpring_s_f,n=this.positionBuffer.data,r=this.velocityBuffer.data,a=t.inv_dt*this.def.springStrength,l=0;l<this.pairBuffer.count;l++){var c,h,u,p,f,d,y,V,v,x,S,B=this.pairBuffer.data[l];B.flags&tt.ParticleFlag.springParticle&&(c=B.indexA,h=B.indexB,u=e.Copy(n[c]),p=i.Copy(n[h]),f=r[c],d=r[h],u.SelfMulAdd(t.dt,f),p.SelfMulAdd(t.dt,d),y=tt.Vec2.SubVV(p,u,s),V=B.distance,v=y.Length(),x=a*B.strength,S=tt.Vec2.MulSV(x*(V-v)/v,y,o),f.SelfSub(S),d.SelfAdd(S))}},et.prototype.SolveTensile=function(t){for(var e=et.SolveTensile_s_weightedNormal,i=et.SolveTensile_s_s,s=et.SolveTensile_s_f,o=this.velocityBuffer.data,n=0;n<this.count;n++)this.accumulation2Buffer[n]=new tt.Vec2,this.accumulation2Buffer[n].SetZero();for(var r,a=0;a<this.contactBuffer.count;a++){(l=this.contactBuffer.data[a]).flags&tt.ParticleFlag.tensileParticle&&(c=l.indexA,h=l.indexB,u=l.weight,p=l.normal,r=tt.Vec2.MulSV((1-u)*u,p,e),this.accumulation2Buffer[c].SelfSub(r),this.accumulation2Buffer[h].SelfAdd(r))}for(var l,c,h,u,p,f,d,y,V,v=this.GetCriticalVelocity(t),x=this.def.surfaceTensionPressureStrength*v,S=this.def.surfaceTensionNormalStrength*v,B=tt.maxParticleForce*v,a=0;a<this.contactBuffer.count;a++){(l=this.contactBuffer.data[a]).flags&tt.ParticleFlag.tensileParticle&&(c=l.indexA,h=l.indexB,u=l.weight,p=l.normal,f=this.weightBuffer[c]+this.weightBuffer[h],d=tt.Vec2.SubVV(this.accumulation2Buffer[h],this.accumulation2Buffer[c],i),y=tt.Min(x*(f-2)+S*tt.Vec2.DotVV(d,p),B)*u,V=tt.Vec2.MulSV(y,p,s),o[c].SelfSub(V),o[h].SelfAdd(V))}},et.prototype.SolveViscous=function(){for(var t=et.SolveViscous_s_v,e=et.SolveViscous_s_f,i=this.positionBuffer.data,s=this.velocityBuffer.data,o=this.def.viscousStrength,n=this.GetParticleInvMass(),r=0;r<this.bodyContactBuffer.count;r++){var a,l,c=(h=this.bodyContactBuffer.data[r]).index;this.flagsBuffer.data[c]&tt.ParticleFlag.viscousParticle&&(u=h.body,p=h.weight,a=h.mass,l=i[c],f=tt.Vec2.SubVV(u.GetLinearVelocityFromWorldPoint(l,tt.Vec2.s_t0),s[c],t),d=tt.Vec2.MulSV(o*a*p,f,e),s[c].SelfMulAdd(n,d),u.ApplyLinearImpulse(d.SelfNeg(),l,!0))}for(var h,u,p,f,d,r=0;r<this.contactBuffer.count;r++){(h=this.contactBuffer.data[r]).flags&tt.ParticleFlag.viscousParticle&&(c=h.indexA,u=h.indexB,p=h.weight,f=tt.Vec2.SubVV(s[u],s[c],t),d=tt.Vec2.MulSV(o*p,f,e),s[c].SelfAdd(d),s[u].SelfSub(d))}},et.prototype.SolveRepulsive=function(t){for(var e=et.SolveRepulsive_s_f,i=this.velocityBuffer.data,s=this.def.repulsiveStrength*this.GetCriticalVelocity(t),o=0;o<this.contactBuffer.count;o++){var n,r,a,l,c,h=this.contactBuffer.data[o];h.flags&tt.ParticleFlag.repulsiveParticle&&(n=h.indexA,r=h.indexB,this.groupBuffer[n]!==this.groupBuffer[r]&&(a=h.weight,l=h.normal,c=tt.Vec2.MulSV(s*a,l,e),i[n].SelfSub(c),i[r].SelfAdd(c)))}},et.prototype.SolvePowder=function(t){for(var e=et.SolvePowder_s_f,i=this.positionBuffer.data,s=this.velocityBuffer.data,o=this.def.powderStrength*this.GetCriticalVelocity(t),n=1-tt.particleStride,r=this.GetParticleInvMass(),a=0;a<this.bodyContactBuffer.count;a++){var l,c,h=(u=this.bodyContactBuffer.data[a]).index;this.flagsBuffer.data[h]&tt.ParticleFlag.powderParticle&&n<(p=u.weight)&&(f=u.body,l=u.mass,c=i[h],d=u.normal,y=tt.Vec2.MulSV(o*l*(p-n),d,e),s[h].SelfMulSub(r,y),f.ApplyLinearImpulse(y,c,!0))}for(var u,p,f,d,y,a=0;a<this.contactBuffer.count;a++){(u=this.contactBuffer.data[a]).flags&tt.ParticleFlag.powderParticle&&n<(p=u.weight)&&(h=u.indexA,f=u.indexB,d=u.normal,y=tt.Vec2.MulSV(o*(p-n),d,e),s[h].SelfSub(y),s[f].SelfAdd(y))}},et.prototype.SolveSolid=function(t){var e=et.SolveSolid_s_f,i=this.velocityBuffer.data;this.depthBuffer=this.RequestBuffer(this.depthBuffer);for(var s=t.inv_dt*this.def.ejectionStrength,o=0;o<this.contactBuffer.count;o++){var n,r,a,l,c=this.contactBuffer.data[o],h=c.indexA,u=c.indexB;this.groupBuffer[h]!==this.groupBuffer[u]&&(n=c.weight,r=c.normal,a=this.depthBuffer[h]+this.depthBuffer[u],l=tt.Vec2.MulSV(s*a*n,r,e),i[h].SelfSub(l),i[u].SelfAdd(l))}},et.prototype.SolveForce=function(t){for(var e=this.velocityBuffer.data,i=t.dt*this.GetParticleInvMass(),s=0;s<this.count;s++)e[s].SelfMulAdd(i,this.forceBuffer[s]);this.hasForce=!1},et.prototype.SolveColorMixing=function(){var t=.5*this.def.colorMixingStrength;if(t)for(var e=0;e<this.contactBuffer.count;e++){var i,s,o=this.contactBuffer.data[e],n=o.indexA,r=o.indexB;this.flagsBuffer.data[n]&this.flagsBuffer.data[r]&tt.ParticleFlag.colorMixingParticle&&(i=this.colorBuffer.data[n],s=this.colorBuffer.data[r],tt.Color.MixColors(i,s,t))}},et.prototype.SolveZombie=function(){for(var t=0,e=[],i=0;i<this.count;i++)e[i]=tt.invalidParticleIndex;for(var s=0,i=0;i<this.count;i++){var o,n,r=this.flagsBuffer.data[i];r&tt.ParticleFlag.zombieParticle?(o=this.world.destructionListener,r&tt.ParticleFlag.destructionListenerParticle&&o&&o.SayGoodbyeParticle(this,i),this.handleIndexBuffer.data&&(n=this.handleIndexBuffer.data[i])&&(n.SetIndex(tt.invalidParticleIndex),this.handleIndexBuffer.data[i]=null),e[i]=tt.invalidParticleIndex):(i!==(e[i]=t)&&(this.handleIndexBuffer.data&&((n=this.handleIndexBuffer.data[i])&&n.SetIndex(t),this.handleIndexBuffer.data[t]=n),this.flagsBuffer.data[t]=this.flagsBuffer.data[i],this.lastBodyContactStepBuffer.data&&(this.lastBodyContactStepBuffer.data[t]=this.lastBodyContactStepBuffer.data[i]),this.bodyContactCountBuffer.data&&(this.bodyContactCountBuffer.data[t]=this.bodyContactCountBuffer.data[i]),this.consecutiveContactStepsBuffer.data&&(this.consecutiveContactStepsBuffer.data[t]=this.consecutiveContactStepsBuffer.data[i]),this.positionBuffer.data[t].Copy(this.positionBuffer.data[i]),this.velocityBuffer.data[t].Copy(this.velocityBuffer.data[i]),this.groupBuffer[t]=this.groupBuffer[i],this.hasForce&&this.forceBuffer[t].Copy(this.forceBuffer[i]),this.staticPressureBuffer&&(this.staticPressureBuffer[t]=this.staticPressureBuffer[i]),this.depthBuffer&&(this.depthBuffer[t]=this.depthBuffer[i]),this.colorBuffer.data&&this.colorBuffer.data[t].Copy(this.colorBuffer.data[i]),this.userDataBuffer.data&&(this.userDataBuffer.data[t]=this.userDataBuffer.data[i]),this.expirationTimeBuffer.data&&(this.expirationTimeBuffer.data[t]=this.expirationTimeBuffer.data[i])),t++,s|=r)}for(var a=function(t){return t.index<0},l=function(t){return t.indexA<0||t.indexB<0},c=function(t){return t.index<0},h=function(t){return t.indexA<0||t.indexB<0},u=function(t){return t.indexA<0||t.indexB<0||t.indexC<0},p=0;p<this.proxyBuffer.count;p++){var f=this.proxyBuffer.data[p];f.index=e[f.index]}this.proxyBuffer.RemoveIf(a);for(p=0;p<this.contactBuffer.count;p++){(d=this.contactBuffer.data[p]).indexA=e[d.indexA],d.indexB=e[d.indexB]}this.contactBuffer.RemoveIf(l);for(var d,p=0;p<this.bodyContactBuffer.count;p++){(d=this.bodyContactBuffer.data[p]).index=e[d.index]}this.bodyContactBuffer.RemoveIf(c);for(p=0;p<this.pairBuffer.count;p++){var y=this.pairBuffer.data[p];y.indexA=e[y.indexA],y.indexB=e[y.indexB]}this.pairBuffer.RemoveIf(h);for(p=0;p<this.triadBuffer.count;p++){var V=this.triadBuffer.data[p];V.indexA=e[V.indexA],V.indexB=e[V.indexB],V.indexC=e[V.indexC]}if(this.triadBuffer.RemoveIf(u),this.indexByExpirationTimeBuffer.data)for(var v=0,x=0;x<this.count;x++){var S=e[this.indexByExpirationTimeBuffer.data[x]];S!==tt.invalidParticleIndex&&(this.indexByExpirationTimeBuffer.data[v++]=S)}for(var B=this.groupList;B;B=B.GetNext()){for(var A=t,C=0,m=!1,i=B.firstIndex;i<B.lastIndex;i++){var g=e[i];0<=g?(A=tt.Min(A,g),C=tt.Max(C,g+1)):m=!0}A<C?(B.firstIndex=A,B.lastIndex=C,m&&B.groupFlags&tt.ParticleGroupFlag.solidParticleGroup&&this.SetGroupFlags(B,B.groupFlags|tt.ParticleGroupFlag.particleGroupNeedsUpdateDepth)):(B.firstIndex=0,B.lastIndex=0,B.groupFlags&tt.ParticleGroupFlag.particleGroupCanBeEmpty||this.SetGroupFlags(B,B.groupFlags|tt.ParticleGroupFlag.particleGroupWillBeDestroyed))}this.count=t,this.allParticleFlags=s,this.needsUpdateAllParticleFlags=!1;for(B=this.groupList;B;){var w=B.GetNext();B.groupFlags&tt.ParticleGroupFlag.particleGroupWillBeDestroyed&&this.DestroyParticleGroup(B),B=w}},et.prototype.SolveLifetimes=function(t){this.timeElapsed=this.LifetimeToExpirationTime(t.dt);var e=this.GetQuantizedTimeElapsed(),n=this.expirationTimeBuffer.data,i=this.indexByExpirationTimeBuffer.data,s=this.GetParticleCount();this.expirationTimeBufferRequiresSorting&&(u(i,0,s,function(t,e){var i=n[t],s=n[e],o=i<=0;return o==s<=0?s<i:o}),this.expirationTimeBufferRequiresSorting=!1);for(var o=s-1;0<=o;--o){var r=i[o],a=n[r];if(e<a||a<=0)break;this.DestroyParticle(r)}},et.prototype.RotateBuffer=function(e,i,s){if(e!==i&&i!==s){if(d(this.flagsBuffer.data,e,i,s),this.lastBodyContactStepBuffer.data&&d(this.lastBodyContactStepBuffer.data,e,i,s),this.bodyContactCountBuffer.data&&d(this.bodyContactCountBuffer.data,e,i,s),this.consecutiveContactStepsBuffer.data&&d(this.consecutiveContactStepsBuffer.data,e,i,s),d(this.positionBuffer.data,e,i,s),d(this.velocityBuffer.data,e,i,s),d(this.groupBuffer,e,i,s),this.hasForce&&d(this.forceBuffer,e,i,s),this.staticPressureBuffer&&d(this.staticPressureBuffer,e,i,s),this.depthBuffer&&d(this.depthBuffer,e,i,s),this.colorBuffer.data&&d(this.colorBuffer.data,e,i,s),this.userDataBuffer.data&&d(this.userDataBuffer.data,e,i,s),this.handleIndexBuffer.data){d(this.handleIndexBuffer.data,e,i,s);for(var t=e;t<s;++t){var o=this.handleIndexBuffer.data[t];o&&o.SetIndex(f(o.GetIndex()))}}if(this.expirationTimeBuffer.data){d(this.expirationTimeBuffer.data,e,i,s);for(var n=this.GetParticleCount(),r=this.indexByExpirationTimeBuffer.data,t=0;t<n;++t)r[t]=f(r[t])}for(var a=0;a<this.proxyBuffer.count;a++){var l=this.proxyBuffer.data[a];l.index=f(l.index)}for(a=0;a<this.contactBuffer.count;a++){(c=this.contactBuffer.data[a]).indexA=f(c.indexA),c.indexB=f(c.indexB)}for(var c,a=0;a<this.bodyContactBuffer.count;a++){(c=this.bodyContactBuffer.data[a]).index=f(c.index)}for(a=0;a<this.pairBuffer.count;a++){var h=this.pairBuffer.data[a];h.indexA=f(h.indexA),h.indexB=f(h.indexB)}for(a=0;a<this.triadBuffer.count;a++){var u=this.triadBuffer.data[a];u.indexA=f(u.indexA),u.indexB=f(u.indexB),u.indexC=f(u.indexC)}for(var p=this.groupList;p;p=p.GetNext())p.firstIndex=f(p.firstIndex),p.lastIndex=f(p.lastIndex-1)+1}function f(t){return t<e?t:t<i?t+s-i:t<s?t+e-i:t}},et.prototype.GetCriticalVelocity=function(t){return this.particleDiameter*t.inv_dt},et.prototype.GetCriticalVelocitySquared=function(t){var e=this.GetCriticalVelocity(t);return e*e},et.prototype.GetCriticalPressure=function(t){return this.def.density*this.GetCriticalVelocitySquared(t)},et.prototype.GetParticleStride=function(){return tt.particleStride*this.particleDiameter},et.prototype.GetParticleMass=function(){var t=this.GetParticleStride();return this.def.density*t*t},et.prototype.GetParticleInvMass=function(){var t=this.inverseDiameter*(1/tt.particleStride);return this.inverseDensity*t*t},et.prototype.GetFixtureContactFilter=function(){return this.allParticleFlags&tt.ParticleFlag.fixtureContactFilterParticle?this.world.contactManager.contactFilter:null},et.prototype.GetParticleContactFilter=function(){return this.allParticleFlags&tt.ParticleFlag.particleContactFilterParticle?this.world.contactManager.contactFilter:null},et.prototype.GetFixtureContactListener=function(){return this.allParticleFlags&tt.ParticleFlag.fixtureContactListenerParticle?this.world.contactManager.contactListener:null},et.prototype.GetParticleContactListener=function(){return this.allParticleFlags&tt.ParticleFlag.particleContactListenerParticle?this.world.contactManager.contactListener:null},et.prototype.SetUserOverridableBuffer=function(t,e){t.data=e,t.userSuppliedCapacity=e.length},et.prototype.SetGroupFlags=function(t,e){var i=t.groupFlags;(i^e)&tt.ParticleGroupFlag.solidParticleGroup&&(e|=tt.ParticleGroupFlag.particleGroupNeedsUpdateDepth),i&~e&&(this.needsUpdateAllGroupFlags=!0),~this.allGroupFlags&e&&(e&tt.ParticleGroupFlag.solidParticleGroup&&(this.depthBuffer=this.RequestBuffer(this.depthBuffer)),this.allGroupFlags|=e),t.groupFlags=e},et.BodyContactCompare=function(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index},et.prototype.RemoveSpuriousBodyContacts=function(){u(this.bodyContactBuffer.data,0,this.bodyContactBuffer.count,et.BodyContactCompare);var n=et.RemoveSpuriousBodyContacts_s_n,r=et.RemoveSpuriousBodyContacts_s_pos,a=et.RemoveSpuriousBodyContacts_s_normal,l=this,c=-1,h=0;this.bodyContactBuffer.count=e(this.bodyContactBuffer.data,function(t){if(t.index!==c&&(h=0,c=t.index),3<h++)return!0;var e=n.Copy(t.normal);e.SelfMul(l.particleDiameter*(1-t.weight));var i=tt.Vec2.AddVV(l.positionBuffer.data[t.index],e,r);if(t.fixture.TestPoint(i))return!1;for(var s=t.fixture.GetShape().GetChildCount(),o=0;o<s;o++){if(t.fixture.ComputeDistance(i,a,o)<tt.linearSlop)return!1}return!0},this.bodyContactBuffer.count)},et.prototype.DetectStuckParticle=function(t){this.stuckThreshold<=0||(++this.bodyContactCountBuffer.data[t],2===this.bodyContactCountBuffer.data[t]&&(++this.consecutiveContactStepsBuffer.data[t],this.consecutiveContactStepsBuffer.data[t]>this.stuckThreshold&&(this.stuckParticleBuffer.data[this.stuckParticleBuffer.Append()]=t)),this.lastBodyContactStepBuffer.data[t]=this.timestamp)},et.prototype.ValidateParticleIndex=function(t){return 0<=t&&t<this.GetParticleCount()&&t!==tt.invalidParticleIndex},et.prototype.GetQuantizedTimeElapsed=function(){return Math.floor(this.timeElapsed/4294967296)},et.prototype.LifetimeToExpirationTime=function(t){return this.timeElapsed+Math.floor(t/this.def.lifetimeGranularity*4294967296)},et.prototype.ForceCanBeApplied=function(t){return!(t&tt.ParticleFlag.wallParticle)},et.prototype.PrepareForceBuffer=function(){if(!this.hasForce){for(var t=0;t<this.count;t++)this.forceBuffer[t].SetZero();this.hasForce=!0}},et.prototype.IsRigidGroup=function(t){return null!==t&&0!=(t.groupFlags&tt.ParticleGroupFlag.rigidParticleGroup)},et.prototype.GetLinearVelocity=function(t,e,i,s){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,s):s.Copy(this.velocityBuffer.data[e])},et.prototype.InitDampingParameter=function(t,e,i,s,o,n,r,a){t[0]=0<s?1/s:0,e[0]=0<o?1/o:0,i[0]=tt.Vec2.CrossVV(tt.Vec2.SubVV(r,n,tt.Vec2.s_t0),a)},et.prototype.InitDampingParameterWithRigidGroupOrParticle=function(t,e,i,s,o,n,r,a){var l;o&&s?this.InitDampingParameter(t,e,i,o.GetMass(),o.GetInertia(),o.GetCenter(),r,a):(l=this.flagsBuffer.data[n],this.InitDampingParameter(t,e,i,l&tt.ParticleFlag.wallParticle?0:this.GetParticleMass(),0,r,r,a))},et.prototype.ComputeDampingImpulse=function(t,e,i,s,o,n,r){var a=t+e*i*i+s+o*n*n;return 0<a?r/a:0},et.prototype.ApplyDamping=function(t,e,i,s,o,n,r,a){o&&s?(o.linearVelocity.SelfMulAdd(r*t,a),o.angularVelocity+=r*i*e):this.velocityBuffer.data[n].SelfMulAdd(r*t,a)},et.xTruncBits=12,et.yTruncBits=12,et.tagBits=32,et.yOffset=1<<et.yTruncBits-1,et.yShift=et.tagBits-et.yTruncBits,et.xOffset=(et.xScale=1<<(et.xShift=et.tagBits-et.yTruncBits-et.xTruncBits))*(1<<et.xTruncBits-1),et.xMask=~(et.yMask=(1<<et.yTruncBits)-1<<et.yShift),et.DestroyParticlesInShape_s_aabb=new tt.AABB,et.CreateParticleGroup_s_transform=new tt.Transform,et.ComputeCollisionEnergy_s_v=new tt.Vec2,et.QueryShapeAABB_s_aabb=new tt.AABB,et.QueryPointAABB_s_aabb=new tt.AABB,et.RayCast_s_aabb=new tt.AABB,et.RayCast_s_p=new tt.Vec2,et.RayCast_s_v=new tt.Vec2,et.RayCast_s_n=new tt.Vec2,et.RayCast_s_point=new tt.Vec2,et.k_pairFlags=tt.ParticleFlag.springParticle,et.k_triadFlags=tt.ParticleFlag.elasticParticle,et.k_noPressureFlags=tt.ParticleFlag.powderParticle|tt.ParticleFlag.tensileParticle,et.k_extraDampingFlags=tt.ParticleFlag.staticPressureParticle,et.k_barrierWallFlags=tt.ParticleFlag.barrierParticle|tt.ParticleFlag.wallParticle,et.CreateParticlesStrokeShapeForGroup_s_edge=new tt.EdgeShape,et.CreateParticlesStrokeShapeForGroup_s_d=new tt.Vec2,et.CreateParticlesStrokeShapeForGroup_s_p=new tt.Vec2,et.CreateParticlesFillShapeForGroup_s_aabb=new tt.AABB,et.CreateParticlesFillShapeForGroup_s_p=new tt.Vec2,et.UpdatePairsAndTriads_s_dab=new tt.Vec2,et.UpdatePairsAndTriads_s_dbc=new tt.Vec2,et.UpdatePairsAndTriads_s_dca=new tt.Vec2,et.AddContact_s_d=new tt.Vec2,et.UpdateBodyContacts_s_aabb=new tt.AABB,et.Solve_s_subStep=new tt.TimeStep,et.SolveCollision_s_aabb=new tt.AABB,et.SolveGravity_s_gravity=new tt.Vec2,et.SolveBarrier_s_aabb=new tt.AABB,et.SolveBarrier_s_va=new tt.Vec2,et.SolveBarrier_s_vb=new tt.Vec2,et.SolveBarrier_s_pba=new tt.Vec2,et.SolveBarrier_s_vba=new tt.Vec2,et.SolveBarrier_s_vc=new tt.Vec2,et.SolveBarrier_s_pca=new tt.Vec2,et.SolveBarrier_s_vca=new tt.Vec2,et.SolveBarrier_s_qba=new tt.Vec2,et.SolveBarrier_s_qca=new tt.Vec2,et.SolveBarrier_s_dv=new tt.Vec2,et.SolveBarrier_s_f=new tt.Vec2,et.SolvePressure_s_f=new tt.Vec2,et.SolveDamping_s_v=new tt.Vec2,et.SolveDamping_s_f=new tt.Vec2,et.SolveRigidDamping_s_t0=new tt.Vec2,et.SolveRigidDamping_s_t1=new tt.Vec2,et.SolveRigidDamping_s_p=new tt.Vec2,et.SolveRigidDamping_s_v=new tt.Vec2,et.SolveExtraDamping_s_v=new tt.Vec2,et.SolveExtraDamping_s_f=new tt.Vec2,et.SolveRigid_s_position=new tt.Vec2,et.SolveRigid_s_rotation=new tt.Rot,et.SolveRigid_s_transform=new tt.Transform,et.SolveRigid_s_velocityTransform=new tt.Transform,et.SolveElastic_s_pa=new tt.Vec2,et.SolveElastic_s_pb=new tt.Vec2,et.SolveElastic_s_pc=new tt.Vec2,et.SolveElastic_s_r=new tt.Rot,et.SolveElastic_s_t0=new tt.Vec2,et.SolveSpring_s_pa=new tt.Vec2,et.SolveSpring_s_pb=new tt.Vec2,et.SolveSpring_s_d=new tt.Vec2,et.SolveSpring_s_f=new tt.Vec2,et.SolveTensile_s_weightedNormal=new tt.Vec2,et.SolveTensile_s_s=new tt.Vec2,et.SolveTensile_s_f=new tt.Vec2,et.SolveViscous_s_v=new tt.Vec2,et.SolveViscous_s_f=new tt.Vec2,et.SolveRepulsive_s_f=new tt.Vec2,et.SolvePowder_s_f=new tt.Vec2,et.SolveSolid_s_f=new tt.Vec2,et.RemoveSpuriousBodyContacts_s_n=new tt.Vec2,et.RemoveSpuriousBodyContacts_s_pos=new tt.Vec2,et.RemoveSpuriousBodyContacts_s_normal=new tt.Vec2,et);function et(t,e){this.paused=!1,this.timestamp=0,this.allParticleFlags=0,this.needsUpdateAllParticleFlags=!1,this.allGroupFlags=0,this.needsUpdateAllGroupFlags=!1,this.hasForce=!1,this.iterationIndex=0,this.inverseDensity=0,this.particleDiameter=0,this.inverseDiameter=0,this.squaredDiameter=0,this.count=0,this.internalAllocatedCapacity=0,this.handleIndexBuffer=new A,this.flagsBuffer=new A,this.positionBuffer=new A,this.velocityBuffer=new A,this.forceBuffer=[],this.weightBuffer=[],this.staticPressureBuffer=[],this.accumulationBuffer=[],this.accumulation2Buffer=[],this.depthBuffer=[],this.colorBuffer=new A,this.groupBuffer=[],this.userDataBuffer=new A,this.stuckThreshold=0,this.lastBodyContactStepBuffer=new A,this.bodyContactCountBuffer=new A,this.consecutiveContactStepsBuffer=new A,this.stuckParticleBuffer=new i(function(){return 0}),this.proxyBuffer=new i(function(){return new m}),this.contactBuffer=new i(function(){return new r}),this.bodyContactBuffer=new i(function(){return new l}),this.pairBuffer=new i(function(){return new y}),this.triadBuffer=new i(function(){return new V}),this.expirationTimeBuffer=new A,this.indexByExpirationTimeBuffer=new A,this.timeElapsed=0,this.expirationTimeBufferRequiresSorting=!1,this.groupCount=0,this.groupList=null,this.def=new x,this.prev=null,this.next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.def=t.Clone(),this.world=e,this.SetDestructionByAge(this.def.destroyByAge)}tt.ParticleSystem=B;var A=(Object.defineProperty(C.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t},enumerable:!0,configurable:!0}),C);function C(){this._data=null,this.userSuppliedCapacity=0}tt.ParticleSysteUserOverridableBuffer=A;var m=(g.CompareProxyProxy=function(t,e){return t.tag<e.tag},g.CompareTagProxy=function(t,e){return t<e.tag},g.CompareProxyTag=function(t,e){return t.tag<e},g);function g(){this.index=tt.invalidParticleIndex,this.tag=0}tt.ParticleSysteProxy=m;var w=(_.prototype.GetNext=function(){for(;this.first<this.last;){var t=(this.system.proxyBuffer.data[this.first].tag&B.xMask)>>>0;if(t>=this.xLower&&t<=this.xUpper)return this.system.proxyBuffer.data[this.first++].index;this.first++}return tt.invalidParticleIndex},_);function _(t,e,i,s,o){this.system=t,this.xLower=(e&B.xMask)>>>0,this.xUpper=(i&B.xMask)>>>0,this.yLower=(e&B.yMask)>>>0,this.yUpper=(i&B.yMask)>>>0,this.first=s,this.last=o}tt.ParticleSysteInsideBoundsEnumerator=w;var b=function(){this.next=null,this.count=0,this.index=0};tt.ParticleSysteParticleListNode=b;var M=(P.prototype.Allocate=function(t,e){return e},P.prototype.Clear=function(){},P.prototype.GetCount=function(){return 0},P.prototype.Invalidate=function(t){},P.prototype.GetValidBuffer=function(){return[]},P.prototype.GetBuffer=function(){return[]},P.prototype.SetCount=function(t){},P);function P(){}tt.ParticleSysteFixedSetAllocator=M;function I(t,e){this.second=tt.invalidParticleIndex,this.first=t,this.second=e}tt.ParticleSysteFixtureParticle=I;var D,G=(__extends(T,D=M),T.prototype.Initialize=function(t,e){},T.prototype.Find=function(t){return tt.invalidParticleIndex},T);function T(){return null!==D&&D.apply(this,arguments)||this}tt.ParticleSysteFixtureParticleSet=G;function F(t,e){this.first=tt.invalidParticleIndex,this.second=tt.invalidParticleIndex,this.first=t,this.second=e}tt.ParticleSysteParticlePair=F;var R,L=(__extends(k,R=M),k.prototype.Initialize=function(t,e){},k.prototype.Find=function(t){return tt.invalidParticleIndex},k);function k(){return null!==R&&R.apply(this,arguments)||this}tt.ParticlePairSet=L;var q=(J.prototype.IsNecessary=function(t){return!0},J.prototype.ShouldCreatePair=function(t,e){return!0},J.prototype.ShouldCreateTriad=function(t,e,i){return!0},J);function J(){}tt.ParticleSysteConnectionFilter=q;var E,z=(E=tt.QueryCallback,__extends(j,E),j.prototype.ReportFixture=function(t){return!1},j.prototype.ReportParticle=function(t,e){return t===this.system&&(this.shape.TestPoint(this.xf,this.system.positionBuffer.data[e])&&(this.system.DestroyParticle(e,this.callDestructionListener),this.destroyed++),!0)},j.prototype.Destroyed=function(){return this.destroyed},j);function j(t,e,i,s){var o=E.call(this)||this;return o.callDestructionListener=!1,o.destroyed=0,o.system=t,o.shape=e,o.xf=i,o.callDestructionListener=s,o.destroyed=0,o}tt.ParticleSysteDestroyParticlesInShapeCallback=z;var N,O=(__extends(X,N=q),X.prototype.ShouldCreatePair=function(t,e){return t<this.threshold&&this.threshold<=e||e<this.threshold&&this.threshold<=t},X.prototype.ShouldCreateTriad=function(t,e,i){return(t<this.threshold||e<this.threshold||i<this.threshold)&&(this.threshold<=t||this.threshold<=e||this.threshold<=i)},X);function X(t){var e=N.call(this)||this;return e.threshold=0,e.threshold=t,e}tt.ParticleSysteJoinParticleGroupsFilter=O;var Z,U=(Z=tt.Shape,__extends(W,Z),W.prototype.Clone=function(){throw new Error},W.prototype.GetChildCount=function(){return 1},W.prototype.TestPoint=function(t,e){for(var i=0;i<this.shapeCount;i++)if(this.shapes[i].TestPoint(t,e))return!0;return!1},W.prototype.ComputeDistance=function(t,e,i,s){return 0},W.prototype.RayCast=function(t,e,i,s){return!1},W.prototype.ComputeAABB=function(t,e,i){var s=new tt.AABB;t.lowerBound.x=+tt.maxFloat,t.lowerBound.y=+tt.maxFloat,t.upperBound.x=-tt.maxFloat,t.upperBound.y=-tt.maxFloat;for(var o=0;o<this.shapeCount;o++)for(var n=this.shapes[o].GetChildCount(),r=0;r<n;r++){var a=s;this.shapes[o].ComputeAABB(a,e,r),t.Combine1(a)}},W.prototype.ComputeMass=function(t,e){},W.prototype.SetupDistanceProxy=function(t,e){},W.prototype.ComputeSubmergedArea=function(t,e,i,s){return 0},W.prototype.Dump=function(t){},W);function W(t,e){void 0===e&&(e=t.length);var i=Z.call(this,tt.ShapeType.e_unknown,0)||this;return i.shapeCount=0,i.shapes=t,i.shapeCount=e,i}tt.ParticleSysteCompositeShape=U;var Q,Y=(__extends(K,Q=q),K.prototype.IsNecessary=function(t){return 0!=(this.flagsBuffer.data[t]&tt.ParticleFlag.reactiveParticle)},K);function K(t){var e=Q.call(this)||this;return e.flagsBuffer=t,e}tt.ParticleSysteReactiveFilter=Y;var H,$=(__extends(it,H=o),it.prototype.ShouldCollideFixtureParticle=function(t,e,i){if(this.contactFilter&&this.system.GetFlagsBuffer()[i]&tt.ParticleFlag.fixtureContactFilterParticle)return this.contactFilter.ShouldCollideFixtureParticle(t,this.system,i);return!0},it.prototype.ReportFixtureAndParticle=function(t,e,i){var s,o,n,r,a,l,c,h,u,p,f,d=it.ReportFixtureAndParticle_s_n,y=it.ReportFixtureAndParticle_s_rp,V=this.system.positionBuffer.data[i],v=d,x=t.ComputeDistance(V,v,e);x<this.system.particleDiameter&&this.ShouldCollideFixtureParticle(t,this.system,i)&&(o=(s=t.GetBody()).GetWorldCenter(),a=0<(n=s.GetMass())?1/n:0,l=0<(r=s.GetInertia()-n*s.GetLocalCenter().LengthSquared())?1/r:0,c=this.system.flagsBuffer.data[i]&tt.ParticleFlag.wallParticle?0:this.system.GetParticleInvMass(),h=tt.Vec2.SubVV(V,o,y),p=c+a+l*(u=tt.Vec2.CrossVV(h,v))*u,(f=this.system.bodyContactBuffer.data[this.system.bodyContactBuffer.Append()]).index=i,f.body=s,f.fixture=t,f.weight=1-x*this.system.inverseDiameter,f.normal.Copy(v.SelfNeg()),f.mass=0<p?1/p:0,this.system.DetectStuckParticle(i))},it.ReportFixtureAndParticle_s_n=new tt.Vec2,it.ReportFixtureAndParticle_s_rp=new tt.Vec2,it);function it(t,e){void 0===e&&(e=null);var i=H.call(this,t)||this;return i.contactFilter=null,i.contactFilter=e,i}tt.ParticleSysteUpdateBodyContactsCallback=$;var st,ot=(__extends(nt,st=o),nt.prototype.ReportFixtureAndParticle=function(t,e,i){var s,o,n,r,a,l=nt.ReportFixtureAndParticle_s_p1,c=nt.ReportFixtureAndParticle_s_output,h=nt.ReportFixtureAndParticle_s_input,u=nt.ReportFixtureAndParticle_s_p,p=nt.ReportFixtureAndParticle_s_v,f=nt.ReportFixtureAndParticle_s_f,d=t.GetBody(),y=this.system.positionBuffer.data[i],V=this.system.velocityBuffer.data[i],v=c,x=h;0===this.system.iterationIndex?(s=tt.Transform.MulTXV(d.xf0,y,l),t.GetShape().GetType()===tt.ShapeType.e_circleShape&&(s.SelfSub(d.GetLocalCenter()),tt.Rot.MulRV(d.xf0.q,s,s),tt.Rot.MulTRV(d.xf.q,s,s),s.SelfAdd(d.GetLocalCenter())),tt.Transform.MulXV(d.xf,s,x.p1)):x.p1.Copy(y),tt.Vec2.AddVMulSV(y,this.step.dt,V,x.p2),x.maxFraction=1,t.RayCast(v,x,e)&&(o=v.normal,(n=u).x=(1-v.fraction)*x.p1.x+v.fraction*x.p2.x+tt.linearSlop*o.x,n.y=(1-v.fraction)*x.p1.y+v.fraction*x.p2.y+tt.linearSlop*o.y,(r=p).x=this.step.inv_dt*(n.x-y.x),r.y=this.step.inv_dt*(n.y-y.y),this.system.velocityBuffer.data[i].Copy(r),(a=f).x=this.step.inv_dt*this.system.GetParticleMass()*(V.x-r.x),a.y=this.step.inv_dt*this.system.GetParticleMass()*(V.y-r.y),this.system.ParticleApplyForce(i,a))},nt.prototype.ReportParticle=function(t,e){return!1},nt.ReportFixtureAndParticle_s_p1=new tt.Vec2,nt.ReportFixtureAndParticle_s_output=new tt.RayCastOutput,nt.ReportFixtureAndParticle_s_input=new tt.RayCastInput,nt.ReportFixtureAndParticle_s_p=new tt.Vec2,nt.ReportFixtureAndParticle_s_v=new tt.Vec2,nt.ReportFixtureAndParticle_s_f=new tt.Vec2,nt);function nt(t,e){var i=st.call(this,t)||this;return i.step=e,i}tt.ParticleSysteSolveCollisionCallback=ot}(b2=b2||{}),function(t){var e=(Object.defineProperty(i.prototype,"capacity",{get:function(){return this.buffer.length},enumerable:!0,configurable:!0}),i.prototype.Push=function(t){if(this.back>=this.capacity){for(var e=this.front;e<this.back;e++)this.buffer[e-this.front]=this.buffer[e];this.back-=this.front,this.front=0}this.buffer[this.back]=t,this.back++},i.prototype.Pop=function(){this.buffer[this.front]=null,this.front++},i.prototype.Empty=function(){return this.front===this.back},i.prototype.Front=function(){var t=this.buffer[this.front];if(!t)throw new Error;return t},i);function i(t){this.buffer=[],this.front=0;for(var e=this.back=0;e<t;e++)this.buffer[e]=null}t.StackQueue=e}(b2=b2||{}),function(S){var t=(e.prototype.AddGenerator=function(t,e,i){var s=this.generatorBuffer[this.generatorCount++];s.center.Copy(t),s.tag=e,s.necessary=i},e.prototype.Generate=function(t,e){for(var i=1/t,s=new S.Vec2(+S.maxFloat,+S.maxFloat),o=new S.Vec2(-S.maxFloat,-S.maxFloat),n=0,r=0;r<this.generatorCount;r++){(u=this.generatorBuffer[r]).necessary&&(S.Vec2.MinV(s,u.center,s),S.Vec2.MaxV(o,u.center,o),++n)}if(0===n)return this.countX=0,void(this.countY=0);s.x-=e,s.y-=e,o.x+=e,o.y+=e,this.countX=1+Math.floor(i*(o.x-s.x)),this.countY=1+Math.floor(i*(o.y-s.y)),this.diagram=[];for(var a=new S.StackQueue(4*this.countX*this.countY),r=0;r<this.generatorCount;r++){(u=this.generatorBuffer[r]).center.SelfSub(s).SelfMul(i);var l=Math.floor(u.center.x),c=Math.floor(u.center.y);0<=l&&0<=c&&l<this.countX&&c<this.countY&&a.Push(new B(l,c,l+c*this.countX,u))}for(;!a.Empty();){var l=(p=a.Front()).x,c=p.y,h=p.i,u=p.generator;a.Pop(),this.diagram[h]||(this.diagram[h]=u,0<l&&a.Push(new B(l-1,c,h-1,u)),0<c&&a.Push(new B(l,c-1,h-this.countX,u)),l<this.countX-1&&a.Push(new B(l+1,c,h+1,u)),c<this.countY-1&&a.Push(new B(l,c+1,h+this.countX,u)))}for(c=0;c<this.countY;c++)for(l=0;l<this.countX-1;l++){h=l+c*this.countX;(f=this.diagram[h])!==(d=this.diagram[h+1])&&(a.Push(new B(l,c,h,d)),a.Push(new B(l+1,c,h+1,f)))}for(c=0;c<this.countY-1;c++)for(l=0;l<this.countX;l++){h=l+c*this.countX;(f=this.diagram[h])!==(d=this.diagram[h+this.countX])&&(a.Push(new B(l,c,h,d)),a.Push(new B(l,c+1,h+this.countX,f)))}for(;!a.Empty();){var p,f,d,y,V,v,x,l=(p=a.Front()).x,c=p.y,h=p.i,r=p.generator;a.Pop(),(f=this.diagram[h])!==(d=r)&&(y=f.center.x-l,V=f.center.y-c,(v=d.center.x-l)*v+(x=d.center.y-c)*x<y*y+V*V&&(this.diagram[h]=d,0<l&&a.Push(new B(l-1,c,h-1,d)),0<c&&a.Push(new B(l,c-1,h-this.countX,d)),l<this.countX-1&&a.Push(new B(l+1,c,h+1,d)),c<this.countY-1&&a.Push(new B(l,c+1,h+this.countX,d))))}},e.prototype.GetNodes=function(t){for(var e=0;e<this.countY-1;e++)for(var i=0;i<this.countX-1;i++){var s=i+e*this.countX,o=this.diagram[s],n=this.diagram[s+1],r=this.diagram[s+this.countX],a=this.diagram[s+1+this.countX];n!==r&&(o!==n&&o!==r&&(o.necessary||n.necessary||r.necessary)&&t(o.tag,n.tag,r.tag),a!==n&&a!==r&&(o.necessary||n.necessary||r.necessary)&&t(n.tag,a.tag,r.tag))}},e);function e(t){this.generatorCapacity=0,this.generatorCount=0,this.countX=0,this.countY=0,this.diagram=[],this.generatorBuffer=S.MakeArray(t,function(t){return new i}),this.generatorCapacity=t}S.VoronoiDiagram=t;var i=function(){this.center=new S.Vec2,this.tag=0,this.necessary=!1};S.VoronoiDiagraGenerator=i;var B=function(t,e,i,s){this.x=t,this.y=e,this.i=i,this.generator=s};S.VoronoiDiagraTask=B}(b2=b2||{}),function(b){var r,t,a,e;(t=r=b.StretchingModel||(b.StretchingModel={}))[t.pbdStretchingModel=0]="pbdStretchingModel",t[t.xpbdStretchingModel=1]="xpbdStretchingModel",(e=a=b.BendingModel||(b.BendingModel={}))[e.springAngleBendingModel=0]="springAngleBendingModel",e[e.pbdAngleBendingModel=1]="pbdAngleBendingModel",e[e.xpbdAngleBendingModel=2]="xpbdAngleBendingModel",e[e.pbdDistanceBendingModel=3]="pbdDistanceBendingModel",e[e.pbdHeightBendingModel=4]="pbdHeightBendingModel",e[e.pbdTriangleBendingModel=5]="pbdTriangleBendingModel";var i=(s.prototype.Copy=function(t){return this.stretchingModel=t.stretchingModel,this.bendingModel=t.bendingModel,this.damping=t.damping,this.stretchStiffness=t.stretchStiffness,this.stretchHertz=t.stretchHertz,this.stretchDamping=t.stretchDamping,this.bendStiffness=t.bendStiffness,this.bendHertz=t.bendHertz,this.bendDamping=t.bendDamping,this.isometric=t.isometric,this.fixedEffectiveMass=t.fixedEffectiveMass,this.warmStart=t.warmStart,this},s);function s(){this.stretchingModel=r.pbdStretchingModel,this.bendingModel=a.pbdAngleBendingModel,this.damping=0,this.stretchStiffness=1,this.stretchHertz=0,this.stretchDamping=0,this.bendStiffness=.5,this.bendHertz=1,this.bendDamping=0,this.isometric=!1,this.fixedEffectiveMass=!1,this.warmStart=!1}b.RopeTuning=i;function o(){this.position=new b.Vec2,this.vertices=[],this.count=0,this.masses=[],this.gravity=new b.Vec2,this.tuning=new i}b.RopeDef=o;var S=function(){this.i1=0,this.i2=0,this.invMass1=0,this.invMass2=0,this.L=0,this.lambda=0,this.spring=0,this.damper=0},B=function(){this.i1=0,this.i2=0,this.i3=0,this.invMass1=0,this.invMass2=0,this.invMass3=0,this.invEffectiveMass=0,this.lambda=0,this.L1=0,this.L2=0,this.alpha1=0,this.alpha2=0,this.spring=0,this.damper=0},n=(l.prototype.Create=function(t){function e(t,e,i){for(var s=0;s<e;++s)t[s]=i(s)}this.position.Copy(t.position),this.count=t.count,e(this.bindPositions,this.count,function(){return new b.Vec2}),e(this.ps,this.count,function(){return new b.Vec2}),e(this.p0s,this.count,function(){return new b.Vec2}),e(this.vs,this.count,function(){return new b.Vec2}),e(this.invMasses,this.count,function(){return 0});for(var i=0;i<this.count;++i){this.bindPositions[i].Copy(t.vertices[i]),this.ps[i].Copy(t.vertices[i]).SelfAdd(this.position),this.p0s[i].Copy(t.vertices[i]).SelfAdd(this.position),this.vs[i].SetZero();var s=t.masses[i];this.invMasses[i]=0<s?1/s:0}this.stretchCount=this.count-1,this.bendCount=this.count-2,e(this.stretchConstraints,this.stretchCount,function(){return new S}),e(this.bendConstraints,this.bendCount,function(){return new B});for(i=0;i<this.stretchCount;++i){var o=this.stretchConstraints[i],n=this.ps[i],r=this.ps[i+1];o.i1=i,o.i2=i+1,o.L=b.Vec2.DistanceVV(n,r),o.invMass1=this.invMasses[i],o.invMass2=this.invMasses[i+1],o.lambda=0,o.damper=0,o.spring=0}for(i=0;i<this.bendCount;++i){var o=this.bendConstraints[i],n=this.ps[i],r=this.ps[i+1],a=this.ps[i+2];o.i1=i,o.i2=i+1,o.i3=i+2,o.invMass1=this.invMasses[i],o.invMass2=this.invMasses[i+1],o.invMass3=this.invMasses[i+2],o.invEffectiveMass=0,o.L1=b.Vec2.DistanceVV(n,r),o.L2=b.Vec2.DistanceVV(r,a),o.lambda=0;var l,c,h,u,p,f,d,y=b.Vec2.SubVV(r,n,new b.Vec2),V=b.Vec2.SubVV(a,r,new b.Vec2),v=y.LengthSquared(),x=V.LengthSquared();v*x!=0&&(l=(new b.Vec2).Copy(y).SelfSkew().SelfMul(-1/v),c=(new b.Vec2).Copy(V).SelfSkew().SelfMul(1/x),h=l.Clone().SelfNeg(),u=l.Clone().SelfSub(c),p=c.Clone(),o.invEffectiveMass=o.invMass1*b.Vec2.DotVV(h,h)+o.invMass2*b.Vec2.DotVV(u,u)+o.invMass3*b.Vec2.DotVV(p,p),0!==(d=(f=b.Vec2.SubVV(a,n,new b.Vec2)).LengthSquared())&&(o.alpha1=b.Vec2.DotVV(V,f)/d,o.alpha2=b.Vec2.DotVV(y,f)/d))}this.gravity.Copy(t.gravity),this.SetTuning(t.tuning)},l.prototype.SetTuning=function(t){this.tuning.Copy(t);for(var e=2*b.pi*this.tuning.bendHertz,i=0;i<this.bendCount;++i){var s,o=(r=this.bendConstraints[i]).L1*r.L1,n=r.L2*r.L2;o*n!=0?(s=1/r.L1+1/r.L2,0!==(a=r.invMass1/o+r.invMass2*s*s+r.invMass3/n)?(l=1/a,r.spring=l*e*e,r.damper=2*l*this.tuning.bendDamping*e):(r.spring=0,r.damper=0)):(r.spring=0,r.damper=0)}for(var r,a,l,c=2*b.pi*this.tuning.stretchHertz,i=0;i<this.stretchCount;++i){0!==(a=(r=this.stretchConstraints[i]).invMass1+r.invMass2)&&(l=1/a,r.spring=l*c*c,r.damper=2*l*this.tuning.stretchDamping*c)}},l.prototype.Step=function(t,e,i){if(0!==t){for(var s=1/t,o=Math.exp(-t*this.tuning.damping),n=0;n<this.count;++n)0<this.invMasses[n]?(this.vs[n].x*=o,this.vs[n].y*=o,this.vs[n].x+=t*this.gravity.x,this.vs[n].y+=t*this.gravity.y):(this.vs[n].x=s*(this.bindPositions[n].x+i.x-this.p0s[n].x),this.vs[n].y=s*(this.bindPositions[n].y+i.y-this.p0s[n].y));this.tuning.bendingModel===a.springAngleBendingModel&&this.ApplyBendForces(t);for(n=0;n<this.bendCount;++n)this.bendConstraints[n].lambda=0;for(n=0;n<this.stretchCount;++n)this.stretchConstraints[n].lambda=0;for(n=0;n<this.count;++n)this.ps[n].x+=t*this.vs[n].x,this.ps[n].y+=t*this.vs[n].y;for(n=0;n<e;++n)this.tuning.bendingModel===a.pbdAngleBendingModel?this.SolveBend_PBD_Angle():this.tuning.bendingModel===a.xpbdAngleBendingModel?this.SolveBend_XPBD_Angle(t):this.tuning.bendingModel===a.pbdDistanceBendingModel?this.SolveBend_PBD_Distance():this.tuning.bendingModel===a.pbdHeightBendingModel?this.SolveBend_PBD_Height():this.tuning.bendingModel===a.pbdTriangleBendingModel&&this.SolveBend_PBD_Triangle(),this.tuning.stretchingModel===r.pbdStretchingModel?this.SolveStretch_PBD():this.tuning.stretchingModel===r.xpbdStretchingModel&&this.SolveStretch_XPBD(t);for(n=0;n<this.count;++n)this.vs[n].x=s*(this.ps[n].x-this.p0s[n].x),this.vs[n].y=s*(this.ps[n].y-this.p0s[n].y),this.p0s[n].Copy(this.ps[n])}},l.prototype.Reset=function(t){this.position.Copy(t);for(var e=0;e<this.count;++e)this.ps[e].x=this.bindPositions[e].x+this.position.x,this.ps[e].y=this.bindPositions[e].y+this.position.y,this.p0s[e].x=this.bindPositions[e].x+this.position.x,this.p0s[e].y=this.bindPositions[e].y+this.position.y,this.vs[e].SetZero();for(e=0;e<this.bendCount;++e)this.bendConstraints[e].lambda=0;for(e=0;e<this.stretchCount;++e)this.stretchConstraints[e].lambda=0},l.prototype.Draw=function(t){for(var e=new b.Color(.4,.5,.7),i=new b.Color(.1,.8,.1),s=new b.Color(.7,.2,.4),o=0;o<this.count-1;++o){t.DrawSegment(this.ps[o],this.ps[o+1],e);var n=0<this.invMasses[o]?s:i;t.DrawPoint(this.ps[o],5,n)}var r=0<this.invMasses[this.count-1]?s:i;t.DrawPoint(this.ps[this.count-1],5,r)},l.prototype.SolveStretch_PBD=function(){for(var t=this.tuning.stretchStiffness,e=0;e<this.stretchCount;++e){var i,s,o=this.stretchConstraints[e],n=this.ps[o.i1].Clone(),r=this.ps[o.i2].Clone(),a=r.Clone().SelfSub(n),l=a.Normalize(),c=o.invMass1+o.invMass2;0!==c&&(i=o.invMass1/c,s=o.invMass2/c,n.x-=t*i*(o.L-l)*a.x,n.y-=t*i*(o.L-l)*a.y,r.x+=t*s*(o.L-l)*a.x,r.y+=t*s*(o.L-l)*a.y,this.ps[o.i1].Copy(n),this.ps[o.i2].Copy(r))}},l.prototype.SolveStretch_XPBD=function(t){for(var e=0;e<this.stretchCount;++e){var i,s,o,n,r,a=this.stretchConstraints[e],l=this.ps[a.i1].Clone(),c=this.ps[a.i2].Clone(),h=l.Clone().SelfSub(this.p0s[a.i1]),u=c.Clone().SelfSub(this.p0s[a.i2]),p=c.Clone().SelfSub(l),f=p.Normalize(),d=p.Clone().SelfNeg(),y=p,V=a.invMass1+a.invMass2;0!==V&&(s=(i=1/(a.spring*t*t))*(t*t*a.damper)/t,o=f-a.L,n=b.Vec2.DotVV(d,h)+b.Vec2.DotVV(y,u),r=-(o+i*a.lambda+s*n)/((1+s)*V+i),l.x+=a.invMass1*r*d.x,l.y+=a.invMass1*r*d.y,c.x+=a.invMass2*r*y.x,c.y+=a.invMass2*r*y.y,this.ps[a.i1].Copy(l),this.ps[a.i2].Copy(c),a.lambda+=r)}},l.prototype.SolveBend_PBD_Angle=function(){for(var t=this.tuning.bendStiffness,e=0;e<this.bendCount;++e){var i,s,o,n,r,a,l,c=this.bendConstraints[e],h=this.ps[c.i1],u=this.ps[c.i2],p=this.ps[c.i3],f=u.Clone().SelfSub(h),d=p.Clone().SelfSub(u),y=b.Vec2.CrossVV(f,d),V=b.Vec2.DotVV(f,d),v=b.Atan2(y,V),x=0,S=0,S=this.tuning.isometric?(x=c.L1*c.L1,c.L2*c.L2):(x=f.LengthSquared(),d.LengthSquared());x*S!=0&&(i=(new b.Vec2).Copy(f).SelfSkew().SelfMul(-1/x),s=(new b.Vec2).Copy(d).SelfSkew().SelfMul(1/S),o=i.Clone().SelfNeg(),n=i.Clone().SelfSub(s),r=s,(a=0)===(a=this.tuning.fixedEffectiveMass?c.invEffectiveMass:c.invMass1*b.Vec2.DotVV(o,o)+c.invMass2*b.Vec2.DotVV(n,n)+c.invMass3*b.Vec2.DotVV(r,r))&&(a=c.invEffectiveMass),l=-t*v/a,h.x+=c.invMass1*l*o.x,h.y+=c.invMass1*l*o.y,u.x+=c.invMass2*l*n.x,u.y+=c.invMass2*l*n.y,p.x+=c.invMass3*l*r.x,p.y+=c.invMass3*l*r.y,this.ps[c.i1].Copy(h),this.ps[c.i2].Copy(u),this.ps[c.i3].Copy(p))}},l.prototype.SolveBend_XPBD_Angle=function(t){for(var e=0;e<this.bendCount;++e){var i,s,o,n,r,a,l,c,h,u,p,f,d,y,V=this.bendConstraints[e],v=this.ps[V.i1],x=this.ps[V.i2],S=this.ps[V.i3],B=v.Clone().SelfSub(this.p0s[V.i1]),A=x.Clone().SelfSub(this.p0s[V.i2]),C=S.Clone().SelfSub(this.p0s[V.i3]),m=x.Clone().SelfSub(v),g=S.Clone().SelfSub(x),w=void 0,_=void 0,_=this.tuning.isometric?(w=V.L1*V.L1,V.L2*V.L2):(w=m.LengthSquared(),g.LengthSquared());w*_!=0&&(i=b.Vec2.CrossVV(m,g),s=b.Vec2.DotVV(m,g),o=b.Atan2(i,s),n=(new b.Vec2).Copy(m).SelfSkew().SelfMul(-1/w),r=(new b.Vec2).Copy(g).SelfSkew().SelfMul(1/_),a=n.Clone().SelfNeg(),l=n.Clone().SelfSub(r),c=r,y=void 0,0!==(y=this.tuning.fixedEffectiveMass?V.invEffectiveMass:V.invMass1*b.Vec2.DotVV(a,a)+V.invMass2*b.Vec2.DotVV(l,l)+V.invMass3*b.Vec2.DotVV(c,c))&&(u=(h=1/(V.spring*t*t))*(t*t*V.damper)/t,p=o,f=b.Vec2.DotVV(a,B)+b.Vec2.DotVV(l,A)+b.Vec2.DotVV(c,C),d=-(p+h*V.lambda+u*f)/((1+u)*y+h),v.x+=V.invMass1*d*a.x,v.y+=V.invMass1*d*a.y,x.x+=V.invMass2*d*l.x,x.y+=V.invMass2*d*l.y,S.x+=V.invMass3*d*c.x,S.y+=V.invMass3*d*c.y,this.ps[V.i1].Copy(v),this.ps[V.i2].Copy(x),this.ps[V.i3].Copy(S),V.lambda+=d))}},l.prototype.SolveBend_PBD_Distance=function(){for(var t=this.tuning.bendStiffness,e=0;e<this.bendCount;++e){var i,s,o=this.bendConstraints[e],n=o.i1,r=o.i3,a=this.ps[n].Clone(),l=this.ps[r].Clone(),c=l.Clone().SelfSub(a),h=c.Normalize(),u=o.invMass1+o.invMass3;0!==u&&(i=o.invMass1/u,s=o.invMass3/u,a.x-=t*i*(o.L1+o.L2-h)*c.x,a.y-=t*i*(o.L1+o.L2-h)*c.y,l.x+=t*s*(o.L1+o.L2-h)*c.x,l.y+=t*s*(o.L1+o.L2-h)*c.y,this.ps[n].Copy(a),this.ps[r].Copy(l))}},l.prototype.SolveBend_PBD_Height=function(){for(var t=this.tuning.bendStiffness,e=0;e<this.bendCount;++e){var i=this.bendConstraints[e],s=this.ps[i.i1].Clone(),o=this.ps[i.i2].Clone(),n=this.ps[i.i3].Clone(),r=new b.Vec2;r.x=i.alpha1*s.x+i.alpha2*n.x-o.x,r.y=i.alpha1*s.y+i.alpha2*n.y-o.y;var a,l,c,h,u,p,f=r.Length();0!==f&&(l=(a=r.Clone().SelfMul(1/f)).Clone().SelfMul(i.alpha1),c=a.Clone().SelfNeg(),h=a.Clone().SelfMul(i.alpha2),0!==(u=i.invMass1*i.alpha1*i.alpha1+i.invMass2+i.invMass3*i.alpha2*i.alpha2)&&(p=-t*(1/u)*f,s.x+=i.invMass1*p*l.x,s.y+=i.invMass1*p*l.y,o.x+=i.invMass2*p*c.x,o.y+=i.invMass2*p*c.y,n.x+=i.invMass3*p*h.x,n.y+=i.invMass3*p*h.y,this.ps[i.i1].Copy(s),this.ps[i.i2].Copy(o),this.ps[i.i3].Copy(n)))}},l.prototype.SolveBend_PBD_Triangle=function(){for(var t=this.tuning.bendStiffness,e=0;e<this.bendCount;++e){var i=this.bendConstraints[e],s=this.ps[i.i1].Clone(),o=this.ps[i.i2].Clone(),n=this.ps[i.i3].Clone(),r=i.invMass1,a=i.invMass2,l=i.invMass3,c=t/(r+l+2*a),h=new b.Vec2;h.x=o.x-1/3*(s.x+o.x+n.x),h.y=o.y-1/3*(s.y+o.y+n.y);var u=new b.Vec2;u.x=2*r*c*h.x,u.y=2*r*c*h.y;var p=new b.Vec2;p.x=-4*a*c*h.x,p.y=-4*a*c*h.y;var f=new b.Vec2;f.x=2*l*c*h.x,f.y=2*l*c*h.y,s.SelfAdd(u),o.SelfAdd(p),n.SelfAdd(f),this.ps[i.i1].Copy(s),this.ps[i.i2].Copy(o),this.ps[i.i3].Copy(n)}},l.prototype.ApplyBendForces=function(t){for(var e=2*b.pi*this.tuning.bendHertz,i=0;i<this.bendCount;++i){var s,o,n,r,a,l,c,h,u,p,f,d=this.bendConstraints[i],y=this.ps[d.i1].Clone(),V=this.ps[d.i2].Clone(),v=this.ps[d.i3].Clone(),x=this.vs[d.i1],S=this.vs[d.i2],B=this.vs[d.i3],A=y.Clone().SelfSub(y),C=v.Clone().SelfSub(V),m=void 0,g=void 0,g=this.tuning.isometric?(m=d.L1*d.L1,d.L2*d.L2):(m=A.LengthSquared(),C.LengthSquared());m*g!=0&&(s=b.Vec2.CrossVV(A,C),o=b.Vec2.DotVV(A,C),n=b.Atan2(s,o),r=(new b.Vec2).Copy(A).SelfSkew().SelfMul(-1/m),a=(new b.Vec2).Copy(C).SelfSkew().SelfMul(1/g),l=r.Clone().SelfNeg(),c=r.Clone().SelfSub(a),h=a,(f=0)!==(f=this.tuning.fixedEffectiveMass?d.invEffectiveMass:d.invMass1*b.Vec2.DotVV(l,l)+d.invMass2*b.Vec2.DotVV(c,c)+d.invMass3*b.Vec2.DotVV(h,h))&&(p=-t*((u=1/f)*e*e*n+2*u*this.tuning.bendDamping*e*(b.Vec2.DotVV(l,x)+b.Vec2.DotVV(c,S)+b.Vec2.DotVV(h,B))),this.vs[d.i1].x+=d.invMass1*p*l.x,this.vs[d.i1].y+=d.invMass1*p*l.y,this.vs[d.i2].x+=d.invMass2*p*c.x,this.vs[d.i2].y+=d.invMass2*p*c.y,this.vs[d.i3].x+=d.invMass3*p*h.x,this.vs[d.i3].y+=d.invMass3*p*h.y))}},l);function l(){this.position=new b.Vec2,this.count=0,this.stretchCount=0,this.bendCount=0,this.stretchConstraints=[],this.bendConstraints=[],this.bindPositions=[],this.ps=[],this.p0s=[],this.vs=[],this.invMasses=[],this.gravity=new b.Vec2,this.tuning=new i}b.Rope=n}(b2=b2||{});